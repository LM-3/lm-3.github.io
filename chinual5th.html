<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- Created by GNU Texinfo 6.5, http://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Lisp Machine Manual</title>

<meta name="description" content="Lisp Machine Manual">
<meta name="keywords" content="Lisp Machine Manual">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<link href="#Top" rel="start" title="Top">
<link href="#SEC_Contents" rel="contents" title="Table of Contents">
<link href="dir.html#Top" rel="up" title="(dir)">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
blockquote.smallindentedblock {margin-right: 0em; font-size: smaller}
blockquote.smallquotation {font-size: smaller}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
div.smalldisplay {margin-left: 3.2em}
div.smallexample {margin-left: 3.2em}
div.smalllisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
pre.smalldisplay {font-family: inherit; font-size: smaller}
pre.smallexample {font-size: smaller}
pre.smallformat {font-family: inherit; font-size: smaller}
pre.smalllisp {font-size: smaller}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
-->
</style>
<link rel="stylesheet" type="text/css" href="https://lm-3.github.io/static/texinfo.css">


</head>

<body lang="en">
<h1 class="settitle" align="center">Lisp Machine Manual</h1>





































<a name="Top"></a>
<a name="Lisp-Machine-Manual"></a>
<h1 class="top">Lisp Machine Manual</h1>

<a name="SEC_Contents"></a>
<h2 class="contents-heading">Table of Contents</h2>

<div class="contents">

<ul class="no-bullet">
  <li><a name="toc-_0022Introduction_0022" href="#g_t_0022Introduction_0022">1 &quot;Introduction&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022General-Information_0022" href="#g_t_0022General-Information_0022">1.1 &quot;General Information&quot;</a></li>
    <li><a name="toc-_0022Structure-of-the-Manual_0022" href="#g_t_0022Structure-of-the-Manual_0022">1.2 &quot;Structure of the Manual&quot;</a></li>
    <li><a name="toc-_0022Notational-Conventions-and-Helpful-Notes_0022" href="#g_t_0022Notational-Conventions-and-Helpful-Notes_0022">1.3 &quot;Notational Conventions and Helpful Notes&quot;</a></li>
  </ul></li>
  <li><a name="toc-Primitive-Object-Types" href="#Primitive-Object-Types">2 Primitive Object Types</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022Data-Types_0022" href="#g_t_0022Data-Types_0022">2.1 &quot;Data Types&quot;</a></li>
    <li><a name="toc-Predicates" href="#Predicates">2.2 Predicates</a></li>
  </ul></li>
  <li><a name="toc-_0022Evaluation_0022" href="#g_t_0022Evaluation_0022">3 &quot;Evaluation&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-Variables" href="#Variables">3.1 Variables</a></li>
    <li><a name="toc-Functions" href="#Functions">3.2 Functions</a></li>
    <li><a name="toc-_0022Some-Functions-and-Special-Forms_0022" href="#g_t_0022Some-Functions-and-Special-Forms_0022">3.3 &quot;Some Functions and Special Forms&quot;</a></li>
    <li><a name="toc-Tail-Recursion" href="#Tail-Recursion">3.4 Tail Recursion</a></li>
    <li><a name="toc-Multiple-Values" href="#Multiple-Values">3.5 Multiple Values</a></li>
    <li><a name="toc-Evaluator-Errors" href="#Evaluator-Errors">3.6 Evaluator Errors</a></li>
  </ul></li>
  <li><a name="toc-Flow-of-Control" href="#Flow-of-Control">4 Flow of Control</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022Conditionals_0022" href="#g_t_0022Conditionals_0022">4.1 &quot;Conditionals&quot;</a></li>
    <li><a name="toc-_0022Iteration_0022" href="#g_t_0022Iteration_0022">4.2 &quot;Iteration&quot;</a></li>
    <li><a name="toc-_0022Non_002dLocal-Exits_0022" href="#g_t_0022Non_002dLocal-Exits_0022">4.3 &quot;Non-Local Exits&quot;</a></li>
    <li><a name="toc-_0022Mapping_0022" href="#g_t_0022Mapping_0022">4.4 &quot;Mapping&quot;</a></li>
  </ul></li>
  <li><a name="toc-_0022Manipulating-List-Structure_0022" href="#g_t_0022Manipulating-List-Structure_0022">5 &quot;Manipulating List Structure&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022Conses_0022" href="#g_t_0022Conses_0022">5.1 &quot;Conses&quot;</a></li>
    <li><a name="toc-_0022Lists_0022" href="#g_t_0022Lists_0022">5.2 &quot;Lists&quot;</a></li>
    <li><a name="toc-_0022Alteration-of-List-Structure_0022" href="#g_t_0022Alteration-of-List-Structure_0022">5.3 &quot;Alteration of List Structure&quot;</a></li>
    <li><a name="toc-_0022Cdr_002dCoding_0022" href="#g_t_0022Cdr_002dCoding_0022">5.4 &quot;Cdr-Coding&quot;</a></li>
    <li><a name="toc-_0022Tables_0022" href="#g_t_0022Tables_0022">5.5 &quot;Tables&quot;</a></li>
    <li><a name="toc-Lists-as-Tables" href="#Lists-as-Tables">5.6 Lists as Tables</a></li>
    <li><a name="toc-Association-Lists" href="#Association-Lists">5.7 Association Lists</a></li>
    <li><a name="toc-Stack-Lists" href="#Stack-Lists">5.8 Stack Lists</a></li>
    <li><a name="toc-Property-Lists" href="#Property-Lists">5.9 Property Lists</a></li>
    <li><a name="toc-Hash-Tables" href="#Hash-Tables">5.10 Hash Tables</a>
    <ul class="no-bullet">
      <li><a name="toc-Hash-Table-Functions" href="#Hash-Table-Functions">5.10.1 Hash Table Functions</a></li>
      <li><a name="toc-Hash-Tables-and-the-Garbage-Collector" href="#Hash-Tables-and-the-Garbage-Collector">5.10.2 Hash Tables and the Garbage Collector</a></li>
      <li><a name="toc-Hash-Primitive" href="#Hash-Primitive">5.10.3 Hash Primitive</a></li>
    </ul></li>
    <li><a name="toc-_0022Sorting_0022" href="#g_t_0022Sorting_0022">5.11 &quot;Sorting&quot;</a></li>
    <li><a name="toc-Resources" href="#Resources">5.12 Resources</a>
    <ul class="no-bullet">
      <li><a name="toc-_0022Defining-Resources_0022" href="#g_t_0022Defining-Resources_0022">5.12.1 &quot;Defining Resources&quot;</a></li>
      <li><a name="toc-_0022Allocating-Resource-Objects_0022" href="#g_t_0022Allocating-Resource-Objects_0022">5.12.2 &quot;Allocating Resource Objects&quot;</a></li>
      <li><a name="toc-_0022Accessing-the-Resource-Data-Structure_0022" href="#g_t_0022Accessing-the-Resource-Data-Structure_0022">5.12.3 &quot;Accessing the Resource Data Structure&quot;</a></li>
    </ul></li>
  </ul></li>
  <li><a name="toc-_0022Symbols_0022" href="#g_t_0022Symbols_0022">6 &quot;Symbols&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022The-Value-Cell_0022" href="#g_t_0022The-Value-Cell_0022">6.1 &quot;The Value Cell&quot;</a></li>
    <li><a name="toc-_0022The-Function-Cell_0022" href="#g_t_0022The-Function-Cell_0022">6.2 &quot;The Function Cell&quot;</a></li>
    <li><a name="toc-_0022The-Property-List_0022" href="#g_t_0022The-Property-List_0022">6.3 &quot;The Property List&quot;</a></li>
    <li><a name="toc-_0022The-Print-Name_0022" href="#g_t_0022The-Print-Name_0022">6.4 &quot;The Print Name&quot;</a></li>
    <li><a name="toc-The-Package-Cell" href="#The-Package-Cell">6.5 The Package Cell</a></li>
    <li><a name="toc-Creating-Symbols" href="#Creating-Symbols">6.6 Creating Symbols</a></li>
  </ul></li>
  <li><a name="toc-_0022Numbers_0022" href="#g_t_0022Numbers_0022">7 &quot;Numbers&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022Numeric-Predicates_0022" href="#g_t_0022Numeric-Predicates_0022">7.1 &quot;Numeric Predicates&quot;</a></li>
    <li><a name="toc-Numeric-Comparisons" href="#Numeric-Comparisons">7.2 Numeric Comparisons</a></li>
    <li><a name="toc-_0022Arithmetic_0022" href="#g_t_0022Arithmetic_0022">7.3 &quot;Arithmetic&quot;</a></li>
    <li><a name="toc-Complex-Number-Functions" href="#Complex-Number-Functions">7.4 Complex Number Functions</a></li>
    <li><a name="toc-Transcendental-Functions" href="#Transcendental-Functions">7.5 Transcendental Functions</a></li>
    <li><a name="toc-Numeric-Type-Conversions" href="#Numeric-Type-Conversions">7.6 Numeric Type Conversions</a></li>
    <li><a name="toc-_0022Logical-Operations-on-Numbers_0022" href="#g_t_0022Logical-Operations-on-Numbers_0022">7.7 &quot;Logical Operations on Numbers&quot;</a></li>
    <li><a name="toc-_0022Byte-Manipulation-Functions_0022" href="#g_t_0022Byte-Manipulation-Functions_0022">7.8 &quot;Byte Manipulation Functions&quot;</a></li>
    <li><a name="toc-_0022Random-Numbers_0022" href="#g_t_0022Random-Numbers_0022">7.9 &quot;Random Numbers&quot;</a></li>
    <li><a name="toc-_002224_002dBit-Numbers_0022" href="#g_t_002224_002dBit-Numbers_0022">7.10 &quot;24-Bit Numbers&quot;</a></li>
    <li><a name="toc-_0022Double_002dPrecision-Arithmetic_0022" href="#g_t_0022Double_002dPrecision-Arithmetic_0022">7.11 &quot;Double-Precision Arithmetic&quot;</a></li>
  </ul></li>
  <li><a name="toc-_0022Arrays_0022" href="#g_t_0022Arrays_0022">8 &quot;Arrays&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022Extra-Features-of-Arrays_0022" href="#g_t_0022Extra-Features-of-Arrays_0022">8.1 &quot;Extra Features of Arrays&quot;</a>
    <ul class="no-bullet">
      <li><a name="toc-Displaced-Arrays" href="#Displaced-Arrays">8.1.1 Displaced Arrays</a></li>
    </ul></li>
    <li><a name="toc-_0022Basic-Array-Functions_0022" href="#g_t_0022Basic-Array-Functions_0022">8.2 &quot;Basic Array Functions&quot;</a></li>
    <li><a name="toc-Getting-Information-About-an-Array" href="#Getting-Information-About-an-Array">8.3 Getting Information About an Array</a></li>
    <li><a name="toc-Changing-the-Size-of-an-Array" href="#Changing-the-Size-of-an-Array">8.4 Changing the Size of an Array</a></li>
    <li><a name="toc-Arrays-Overlaid-With-Lists" href="#Arrays-Overlaid-With-Lists">8.5 Arrays Overlaid With Lists</a></li>
    <li><a name="toc-Adding-to-the-End-of-an-Array" href="#Adding-to-the-End-of-an-Array">8.6 Adding to the End of an Array</a></li>
    <li><a name="toc-Copying-an-Array" href="#Copying-an-Array">8.7 Copying an Array</a></li>
    <li><a name="toc-Order-of-Array-Elements" href="#Order-of-Array-Elements">8.8 Order of Array Elements</a></li>
    <li><a name="toc-Matrices-and-Systems-of-Linear-Equations" href="#Matrices-and-Systems-of-Linear-Equations">8.9 Matrices and Systems of Linear Equations</a></li>
    <li><a name="toc-Planes" href="#Planes">8.10 Planes</a></li>
    <li><a name="toc-_0022Maclisp-Array-Compatibility_0022" href="#g_t_0022Maclisp-Array-Compatibility_0022">8.11 &quot;Maclisp Array Compatibility&quot;</a></li>
  </ul></li>
  <li><a name="toc-_0022Strings_0022" href="#g_t_0022Strings_0022">9 &quot;Strings&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022Characters_0022" href="#g_t_0022Characters_0022">9.1 &quot;Characters&quot;</a></li>
    <li><a name="toc-Upper-and-Lower-Case-Letters" href="#Upper-and-Lower-Case-Letters">9.2 Upper and Lower Case Letters</a></li>
    <li><a name="toc-Basic-String-Operations" href="#Basic-String-Operations">9.3 Basic String Operations</a></li>
    <li><a name="toc-_0022String-Searching_0022" href="#g_t_0022String-Searching_0022">9.4 &quot;String Searching&quot;</a></li>
    <li><a name="toc-I_002fO-to-Strings" href="#I_002fO-to-Strings">9.5 I/O to Strings</a></li>
    <li><a name="toc-_0022Maclisp_002dCompatible-Functions_0022" href="#g_t_0022Maclisp_002dCompatible-Functions_0022">9.6 &quot;Maclisp-Compatible Functions&quot;</a></li>
  </ul></li>
  <li><a name="toc-Functions-1" href="#Functions-1">10 Functions</a>
  <ul class="no-bullet">
    <li><a name="toc-What-Is-a-Function_003f" href="#What-Is-a-Function_003f">10.1 What Is a Function?</a></li>
    <li><a name="toc-Function-Specs" href="#Function-Specs">10.2 Function Specs</a></li>
    <li><a name="toc-Simple-Function-Definitions" href="#Simple-Function-Definitions">10.3 Simple Function Definitions</a></li>
    <li><a name="toc-User-Operations-on-Functions" href="#User-Operations-on-Functions">10.4 User Operations on Functions</a></li>
    <li><a name="toc-Kinds-of-Functions" href="#Kinds-of-Functions">10.5 Kinds of Functions</a>
    <ul class="no-bullet">
      <li><a name="toc-_0022Interpreted-Functions_0022" href="#g_t_0022Interpreted-Functions_0022">10.5.1 &quot;Interpreted Functions&quot;</a></li>
      <li><a name="toc-_0022Lambda-Macros_0022" href="#g_t_0022Lambda-Macros_0022">10.5.2 &quot;Lambda Macros&quot;</a></li>
      <li><a name="toc-_0022Compiled-Functions_0022" href="#g_t_0022Compiled-Functions_0022">10.5.3 &quot;Compiled Functions&quot;</a></li>
      <li><a name="toc-_0022Other-Kinds-of-Functions_0022" href="#g_t_0022Other-Kinds-of-Functions_0022">10.5.4 &quot;Other Kinds of Functions&quot;</a></li>
      <li><a name="toc-_0022Special-Forms-and-Functions_0022" href="#g_t_0022Special-Forms-and-Functions_0022">10.5.5 &quot;Special Forms and Functions&quot;</a></li>
    </ul></li>
    <li><a name="toc-Function_002dDefining-Special-Forms" href="#Function_002dDefining-Special-Forms">10.6 Function-Defining Special Forms</a></li>
    <li><a name="toc-Lambda_002dList-Keywords" href="#Lambda_002dList-Keywords">10.7 Lambda-List Keywords</a></li>
    <li><a name="toc-How-Programs-Manipulate-Function-Specs" href="#How-Programs-Manipulate-Function-Specs">10.8 How Programs Manipulate Function Specs</a></li>
    <li><a name="toc-How-Programs-Examine-Functions" href="#How-Programs-Examine-Functions">10.9 How Programs Examine Functions</a></li>
    <li><a name="toc-_0022Encapsulations_0022" href="#g_t_0022Encapsulations_0022">10.10 &quot;Encapsulations&quot;</a>
    <ul class="no-bullet">
      <li><a name="toc-_0022Rename_002dWithin-Encapsulations_0022" href="#g_t_0022Rename_002dWithin-Encapsulations_0022">10.10.1 &quot;Rename-Within Encapsulations&quot;</a></li>
    </ul></li>
  </ul></li>
  <li><a name="toc-_0022Closures_0022" href="#g_t_0022Closures_0022">11 &quot;Closures&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022What-a-Closure-Is_0022" href="#g_t_0022What-a-Closure-Is_0022">11.1 &quot;What a Closure Is&quot;</a></li>
    <li><a name="toc-_0022Examples-of-the-Use-of-Closures_0022" href="#g_t_0022Examples-of-the-Use-of-Closures_0022">11.2 &quot;Examples of the Use of Closures&quot;</a></li>
    <li><a name="toc-Closure_002dManipulating-Functions" href="#Closure_002dManipulating-Functions">11.3 Closure-Manipulating Functions</a></li>
    <li><a name="toc-_0022Entities_0022" href="#g_t_0022Entities_0022">11.4 &quot;Entities&quot;</a></li>
  </ul></li>
  <li><a name="toc-_0022Stack-Groups_0022" href="#g_t_0022Stack-Groups_0022">12 &quot;Stack Groups&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-Resuming-of-Stack-Groups" href="#Resuming-of-Stack-Groups">12.1 Resuming of Stack Groups</a></li>
    <li><a name="toc-Stack-Group-States" href="#Stack-Group-States">12.2 Stack Group States</a></li>
    <li><a name="toc-Stack-Group-Functions" href="#Stack-Group-Functions">12.3 Stack Group Functions</a></li>
    <li><a name="toc-Analyzing-Stack-Frames" href="#Analyzing-Stack-Frames">12.4 Analyzing Stack Frames</a></li>
    <li><a name="toc-Input_002fOutput-in-Stack-Groups" href="#Input_002fOutput-in-Stack-Groups">12.5 Input/Output in Stack Groups</a></li>
    <li><a name="toc-An-Example-of-Stack-Groups" href="#An-Example-of-Stack-Groups">12.6 An Example of Stack Groups</a></li>
  </ul></li>
  <li><a name="toc-_0022Locatives_0022" href="#g_t_0022Locatives_0022">13 &quot;Locatives&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022Cells-and-Locatives_0022" href="#g_t_0022Cells-and-Locatives_0022">13.1 &quot;Cells and Locatives&quot;</a></li>
    <li><a name="toc-_0022Functions-That-Operate-on-Locatives_0022" href="#g_t_0022Functions-That-Operate-on-Locatives_0022">13.2 &quot;Functions That Operate on Locatives&quot;</a></li>
    <li><a name="toc-Mixing-Locatives-with-Lists" href="#Mixing-Locatives-with-Lists">13.3 Mixing Locatives with Lists</a></li>
  </ul></li>
  <li><a name="toc-_0022Subprimitives_0022" href="#g_t_0022Subprimitives_0022">14 &quot;Subprimitives&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-Data-Types" href="#Data-Types">14.1 Data Types</a></li>
    <li><a name="toc-Forwarding" href="#Forwarding">14.2 Forwarding</a></li>
    <li><a name="toc-Pointer-Manipulation" href="#Pointer-Manipulation">14.3 Pointer Manipulation</a></li>
    <li><a name="toc-Analyzing-Structures" href="#Analyzing-Structures">14.4 Analyzing Structures</a></li>
    <li><a name="toc-Creating-Objects" href="#Creating-Objects">14.5 Creating Objects</a></li>
    <li><a name="toc-Copying-Data" href="#Copying-Data">14.6 Copying Data</a></li>
    <li><a name="toc-Returning-Storage" href="#Returning-Storage">14.7 Returning Storage</a></li>
    <li><a name="toc-Locking-Subprimitive" href="#Locking-Subprimitive">14.8 Locking Subprimitive</a></li>
    <li><a name="toc-I_002fO-Device-Subprimitives" href="#I_002fO-Device-Subprimitives">14.9 I/O Device Subprimitives</a></li>
    <li><a name="toc-Special-Memory-Referencing" href="#Special-Memory-Referencing">14.10 Special Memory Referencing</a></li>
    <li><a name="toc-Storage-Layout-Definitions" href="#Storage-Layout-Definitions">14.11 Storage Layout Definitions</a></li>
    <li><a name="toc-Function_002dCalling-Subprimitives" href="#Function_002dCalling-Subprimitives">14.12 Function-Calling Subprimitives</a></li>
    <li><a name="toc-Special_002dBinding-Subprimitive" href="#Special_002dBinding-Subprimitive">14.13 Special-Binding Subprimitive</a></li>
    <li><a name="toc-The-Paging-System" href="#The-Paging-System">14.14 The Paging System</a></li>
    <li><a name="toc-Closure-Subprimitives" href="#Closure-Subprimitives">14.15 Closure Subprimitives</a></li>
    <li><a name="toc-Microcode-Variables" href="#Microcode-Variables">14.16 Microcode Variables</a></li>
    <li><a name="toc-Meters" href="#Meters">14.17 Meters</a></li>
  </ul></li>
  <li><a name="toc-_0022Areas_0022" href="#g_t_0022Areas_0022">15 &quot;Areas&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-Area-Functions-and-Variables" href="#Area-Functions-and-Variables">15.1 Area Functions and Variables</a></li>
    <li><a name="toc-Interesting-Areas" href="#Interesting-Areas">15.2 Interesting Areas</a></li>
    <li><a name="toc-Errors-Pertaining-to-Areas" href="#Errors-Pertaining-to-Areas">15.3 Errors Pertaining to Areas</a></li>
  </ul></li>
  <li><a name="toc-_0022The-Compiler_0022" href="#g_t_0022The-Compiler_0022">16 &quot;The Compiler&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022The-Basic-Operations-of-the-Compiler_0022" href="#g_t_0022The-Basic-Operations-of-the-Compiler_0022">16.1 &quot;The Basic Operations of the Compiler&quot;</a></li>
    <li><a name="toc-_0022How-to-Invoke-the-Compiler_0022" href="#g_t_0022How-to-Invoke-the-Compiler_0022">16.2 &quot;How to Invoke the Compiler&quot;</a></li>
    <li><a name="toc-_0022Input-to-the-Compiler_0022" href="#g_t_0022Input-to-the-Compiler_0022">16.3 &quot;Input to the Compiler&quot;</a></li>
    <li><a name="toc-_0022Compiler-Declarations_0022" href="#g_t_0022Compiler-Declarations_0022">16.4 &quot;Compiler Declarations&quot;</a></li>
    <li><a name="toc-Using-Compiler-Warnings" href="#Using-Compiler-Warnings">16.5 Using Compiler Warnings</a>
    <ul class="no-bullet">
      <li><a name="toc-Controlling-Compiler-Warnings" href="#Controlling-Compiler-Warnings">16.5.1 Controlling Compiler Warnings</a></li>
      <li><a name="toc-Recording-Warnings" href="#Recording-Warnings">16.5.2 Recording Warnings</a></li>
    </ul></li>
    <li><a name="toc-_0022Compiler-Source_002dLevel-Optimizers_0022" href="#g_t_0022Compiler-Source_002dLevel-Optimizers_0022">16.6 &quot;Compiler Source-Level Optimizers&quot;</a></li>
    <li><a name="toc-_0022Files-that-Maclisp-Must-Compile_0022" href="#g_t_0022Files-that-Maclisp-Must-Compile_0022">16.7 &quot;Files that Maclisp Must Compile&quot;</a></li>
    <li><a name="toc-Putting-Data-in-QFASL-Files" href="#Putting-Data-in-QFASL-Files">16.8 Putting Data in QFASL Files</a></li>
    <li><a name="toc-Analyzing-QFASL-Files" href="#Analyzing-QFASL-Files">16.9 Analyzing QFASL Files</a></li>
    <li><a name="toc-_0022Compiler-Interlocking_0022" href="#g_t_0022Compiler-Interlocking_0022">16.10 &quot;Compiler Interlocking&quot;</a></li>
  </ul></li>
  <li><a name="toc-_0022Macros_0022" href="#g_t_0022Macros_0022">17 &quot;Macros&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022Introduction-to-Macros_0022" href="#g_t_0022Introduction-to-Macros_0022">17.1 &quot;Introduction to Macros&quot;</a></li>
    <li><a name="toc-_0022Aids-for-Defining-Macros_0022" href="#g_t_0022Aids-for-Defining-Macros_0022">17.2 &quot;Aids for Defining Macros&quot;</a>
    <ul class="no-bullet">
      <li><a name="toc-_0022Defmacro_0022" href="#g_t_0022Defmacro_0022">17.2.1 &quot;Defmacro&quot;</a></li>
      <li><a name="toc-_0022Backquote_0022" href="#g_t_0022Backquote_0022">17.2.2 &quot;Backquote&quot;</a></li>
    </ul></li>
    <li><a name="toc-Substitutable-Functions" href="#Substitutable-Functions">17.3 Substitutable Functions</a></li>
    <li><a name="toc-Hints-to-Macro-Writers" href="#Hints-to-Macro-Writers">17.4 Hints to Macro Writers</a>
    <ul class="no-bullet">
      <li><a name="toc-Name-Conflicts" href="#Name-Conflicts">17.4.1 Name Conflicts</a></li>
      <li><a name="toc-prog_002dcontext-Conflicts" href="#prog_002dcontext-Conflicts">17.4.2 prog-context Conflicts</a></li>
      <li><a name="toc-Macros-Expanding-into-Many-Forms" href="#Macros-Expanding-into-Many-Forms">17.4.3 Macros Expanding into Many Forms</a></li>
      <li><a name="toc-Macros-that-Surround-Code" href="#Macros-that-Surround-Code">17.4.4 Macros that Surround Code</a></li>
      <li><a name="toc-Multiple-and-Out_002dof_002dorder-Evaluation" href="#Multiple-and-Out_002dof_002dorder-Evaluation">17.4.5 Multiple and Out-of-order Evaluation</a></li>
      <li><a name="toc-Nesting-Macros" href="#Nesting-Macros">17.4.6 Nesting Macros</a></li>
      <li><a name="toc-Functions-Used-During-Expansion" href="#Functions-Used-During-Expansion">17.4.7 Functions Used During Expansion</a></li>
    </ul></li>
    <li><a name="toc-_0022Aids-for-Debugging-Macros_0022" href="#g_t_0022Aids-for-Debugging-Macros_0022">17.5 &quot;Aids for Debugging Macros&quot;</a></li>
    <li><a name="toc-_0022Displacing-Macros_0022" href="#g_t_0022Displacing-Macros_0022">17.6 &quot;Displacing Macros&quot;</a></li>
    <li><a name="toc-_0022Advanced-Features-of-Defmacro_0022" href="#g_t_0022Advanced-Features-of-Defmacro_0022">17.7 &quot;Advanced Features of Defmacro&quot;</a></li>
    <li><a name="toc-_0022Functions-to-Expand-Macros_0022" href="#g_t_0022Functions-to-Expand-Macros_0022">17.8 &quot;Functions to Expand Macros&quot;</a></li>
    <li><a name="toc-Generalized-Variables" href="#Generalized-Variables">17.9 Generalized Variables</a></li>
  </ul></li>
  <li><a name="toc-The-LOOP-Iteration-Macro" href="#The-LOOP-Iteration-Macro">18 The LOOP Iteration Macro</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022Introduction_0022-1" href="#g_t_0022Introduction_0022-1">18.1 &quot;Introduction&quot;</a></li>
    <li><a name="toc-_0022Clauses_0022" href="#g_t_0022Clauses_0022">18.2 &quot;Clauses&quot;</a>
    <ul class="no-bullet">
      <li><a name="toc-_0022Iteration_002dDriving-Clauses_0022" href="#g_t_0022Iteration_002dDriving-Clauses_0022">18.2.1 &quot;Iteration-Driving Clauses&quot;</a></li>
      <li><a name="toc-_0022Bindings_0022" href="#g_t_0022Bindings_0022">18.2.2 &quot;Bindings&quot;</a></li>
      <li><a name="toc-_0022Entrance-and-Exit_0022" href="#g_t_0022Entrance-and-Exit_0022">18.2.3 &quot;Entrance and Exit&quot;</a></li>
      <li><a name="toc-_0022Side-Effects_0022" href="#g_t_0022Side-Effects_0022">18.2.4 &quot;Side Effects&quot;</a></li>
      <li><a name="toc-_0022Values_0022" href="#g_t_0022Values_0022">18.2.5 &quot;Values&quot;</a></li>
      <li><a name="toc-_0022Endtests_0022" href="#g_t_0022Endtests_0022">18.2.6 &quot;Endtests&quot;</a></li>
      <li><a name="toc-_0022Aggregated-Boolean-Tests_0022" href="#g_t_0022Aggregated-Boolean-Tests_0022">18.2.7 &quot;Aggregated Boolean Tests&quot;</a></li>
      <li><a name="toc-_0022Conditionalization_0022" href="#g_t_0022Conditionalization_0022">18.2.8 &quot;Conditionalization&quot;</a></li>
      <li><a name="toc-_0022Miscellaneous-Other-Clauses_0022" href="#g_t_0022Miscellaneous-Other-Clauses_0022">18.2.9 &quot;Miscellaneous Other Clauses&quot;</a></li>
    </ul></li>
    <li><a name="toc-_0022Loop-Synonyms_0022" href="#g_t_0022Loop-Synonyms_0022">18.3 &quot;Loop Synonyms&quot;</a></li>
    <li><a name="toc-_0022Data-Types_0022-1" href="#g_t_0022Data-Types_0022-1">18.4 &quot;Data Types&quot;</a></li>
    <li><a name="toc-_0022Destructuring_0022" href="#g_t_0022Destructuring_0022">18.5 &quot;Destructuring&quot;</a></li>
    <li><a name="toc-_0022The-Iteration-Framework_0022" href="#g_t_0022The-Iteration-Framework_0022">18.6 &quot;The Iteration Framework&quot;</a></li>
    <li><a name="toc-_0022Iteration-Paths_0022" href="#g_t_0022Iteration-Paths_0022">18.7 &quot;Iteration Paths&quot;</a>
    <ul class="no-bullet">
      <li><a name="toc-_0022Pre_002dDefined-Paths_0022" href="#g_t_0022Pre_002dDefined-Paths_0022">18.7.1 &quot;Pre-Defined Paths&quot;</a>
      <ul class="no-bullet">
        <li><a name="toc-_0022The-Interned_002dSymbols-Path_0022" href="#g_t_0022The-Interned_002dSymbols-Path_0022">18.7.1.1 &quot;The Interned-Symbols Path&quot;</a></li>
        <li><a name="toc-_0022Sequence-Iteration_0022" href="#g_t_0022Sequence-Iteration_0022">18.7.1.2 &quot;Sequence Iteration&quot;</a></li>
      </ul></li>
      <li><a name="toc-_0022Defining-Paths_0022" href="#g_t_0022Defining-Paths_0022">18.7.2 &quot;Defining Paths&quot;</a>
      <ul class="no-bullet">
        <li><a name="toc-_0022An-Example-Path-Definition_0022" href="#g_t_0022An-Example-Path-Definition_0022">18.7.2.1 &quot;An Example Path Definition&quot;</a></li>
      </ul></li>
    </ul></li>
  </ul></li>
  <li><a name="toc-_0022Defstruct_0022" href="#g_t_0022Defstruct_0022">19 &quot;Defstruct&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022Introduction-to-Structure-Macros_0022" href="#g_t_0022Introduction-to-Structure-Macros_0022">19.1 &quot;Introduction to Structure Macros&quot;</a></li>
    <li><a name="toc-_0022How-to-Use-Defstruct_0022" href="#g_t_0022How-to-Use-Defstruct_0022">19.2 &quot;How to Use Defstruct&quot;</a></li>
    <li><a name="toc-_0022Options-to-Defstruct_0022" href="#g_t_0022Options-to-Defstruct_0022">19.3 &quot;Options to Defstruct&quot;</a></li>
    <li><a name="toc-_0022Using-the-Constructor-and-Alterant-Macros_0022" href="#g_t_0022Using-the-Constructor-and-Alterant-Macros_0022">19.4 &quot;Using the Constructor and Alterant Macros&quot;</a>
    <ul class="no-bullet">
      <li><a name="toc-Constructor-Macros" href="#Constructor-Macros">19.4.1 Constructor Macros</a></li>
      <li><a name="toc-By_002dposition-Constructor-Macros" href="#By_002dposition-Constructor-Macros">19.4.2 By-position Constructor Macros</a></li>
      <li><a name="toc-Alterant-Macros" href="#Alterant-Macros">19.4.3 Alterant Macros</a></li>
    </ul></li>
    <li><a name="toc-_0022Byte-Fields_0022" href="#g_t_0022Byte-Fields_0022">19.5 &quot;Byte Fields&quot;</a></li>
    <li><a name="toc-_0022Grouped-Arrays_0022" href="#g_t_0022Grouped-Arrays_0022">19.6 &quot;Grouped Arrays&quot;</a></li>
    <li><a name="toc-Named-Structures" href="#Named-Structures">19.7 Named Structures</a></li>
    <li><a name="toc-The-si_003adefstruct_002ddescription-Structure" href="#The-si_003adefstruct_002ddescription-Structure">19.8 The si:defstruct-description Structure</a></li>
    <li><a name="toc-Extensions-to-Defstruct" href="#Extensions-to-Defstruct">19.9 Extensions to Defstruct</a>
    <ul class="no-bullet">
      <li><a name="toc-An-Example" href="#An-Example">19.9.1 An Example</a></li>
      <li><a name="toc-Syntax-of-defstruct_002ddefine_002dtype" href="#Syntax-of-defstruct_002ddefine_002dtype">19.9.2 Syntax of defstruct-define-type</a></li>
      <li><a name="toc-Options-to-defstruct_002ddefine_002dtype" href="#Options-to-defstruct_002ddefine_002dtype">19.9.3 Options to defstruct-define-type</a></li>
    </ul></li>
  </ul></li>
  <li><a name="toc-Objects_002c-Message-Passing_002c-and-Flavors" href="#Objects_002c-Message-Passing_002c-and-Flavors">20 Objects, Message Passing, and Flavors</a>
  <ul class="no-bullet">
    <li><a name="toc-Objects" href="#Objects">20.1 Objects</a></li>
    <li><a name="toc-Modularity" href="#Modularity">20.2 Modularity</a></li>
    <li><a name="toc-Generic-Operations" href="#Generic-Operations">20.3 Generic Operations</a></li>
    <li><a name="toc-Generic-Operations-in-Lisp" href="#Generic-Operations-in-Lisp">20.4 Generic Operations in Lisp</a></li>
    <li><a name="toc-Simple-Use-of-Flavors" href="#Simple-Use-of-Flavors">20.5 Simple Use of Flavors</a></li>
    <li><a name="toc-Mixing-Flavors" href="#Mixing-Flavors">20.6 Mixing Flavors</a></li>
    <li><a name="toc-Flavor-Functions" href="#Flavor-Functions">20.7 Flavor Functions</a></li>
    <li><a name="toc-Defflavor-Options" href="#Defflavor-Options">20.8 Defflavor Options</a></li>
    <li><a name="toc-Flavor-Families" href="#Flavor-Families">20.9 Flavor Families</a></li>
    <li><a name="toc-Vanilla-Flavor" href="#Vanilla-Flavor">20.10 Vanilla Flavor</a></li>
    <li><a name="toc-Method-Combination" href="#Method-Combination">20.11 Method Combination</a></li>
    <li><a name="toc-Implementation-of-Flavors" href="#Implementation-of-Flavors">20.12 Implementation of Flavors</a>
    <ul class="no-bullet">
      <li><a name="toc-Order-of-Definition" href="#Order-of-Definition">20.12.1 Order of Definition</a></li>
      <li><a name="toc-Changing-a-Flavor" href="#Changing-a-Flavor">20.12.2 Changing a Flavor</a></li>
      <li><a name="toc-Restrictions" href="#Restrictions">20.12.3 Restrictions</a></li>
    </ul></li>
    <li><a name="toc-Entities" href="#Entities">20.13 Entities</a></li>
    <li><a name="toc-Useful-Editor-Commands" href="#Useful-Editor-Commands">20.14 Useful Editor Commands</a></li>
    <li><a name="toc-Property-List-Operations" href="#Property-List-Operations">20.15 Property List Operations</a></li>
    <li><a name="toc-Printing-Flavor-Instances-Readably" href="#Printing-Flavor-Instances-Readably">20.16 Printing Flavor Instances Readably</a></li>
  </ul></li>
  <li><a name="toc-_0022The-I_002fO-System_0022" href="#g_t_0022The-I_002fO-System_0022">21 &quot;The I/O System&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022The-Character-Set_0022" href="#g_t_0022The-Character-Set_0022">21.1 &quot;The Character Set&quot;</a></li>
    <li><a name="toc-_0022Printed-Representation_0022" href="#g_t_0022Printed-Representation_0022">21.2 &quot;Printed Representation&quot;</a>
    <ul class="no-bullet">
      <li><a name="toc-_0022What-the-Printer-Produces_0022" href="#g_t_0022What-the-Printer-Produces_0022">21.2.1 &quot;What the Printer Produces&quot;</a></li>
      <li><a name="toc-_0022What-The-Reader-Accepts_0022" href="#g_t_0022What-The-Reader-Accepts_0022">21.2.2 &quot;What The Reader Accepts&quot;</a></li>
      <li><a name="toc-_0022Macro-Characters_0022" href="#g_t_0022Macro-Characters_0022">21.2.3 &quot;Macro Characters&quot;</a></li>
      <li><a name="toc-_0022Sharp_002dsign-Constructs_0022" href="#g_t_0022Sharp_002dsign-Constructs_0022">21.2.4 &quot;Sharp-sign Constructs&quot;</a></li>
      <li><a name="toc-Special-Character-Names" href="#Special-Character-Names">21.2.5 Special Character Names</a></li>
      <li><a name="toc-_0022The-Readtable_0022" href="#g_t_0022The-Readtable_0022">21.2.6 &quot;The Readtable&quot;</a></li>
    </ul></li>
    <li><a name="toc-_0022Input-Functions_0022" href="#g_t_0022Input-Functions_0022">21.3 &quot;Input Functions&quot;</a></li>
    <li><a name="toc-_0022Output-Functions_0022" href="#g_t_0022Output-Functions_0022">21.4 &quot;Output Functions&quot;</a></li>
    <li><a name="toc-_0022I_002fO-Streams_0022" href="#g_t_0022I_002fO-Streams_0022">21.5 &quot;I/O Streams&quot;</a>
    <ul class="no-bullet">
      <li><a name="toc-_0022Standard-Input-Stream-Operations_0022" href="#g_t_0022Standard-Input-Stream-Operations_0022">21.5.1 &quot;Standard Input Stream Operations&quot;</a></li>
      <li><a name="toc-_0022Standard-Output-Stream-Operations_0022" href="#g_t_0022Standard-Output-Stream-Operations_0022">21.5.2 &quot;Standard Output Stream Operations&quot;</a></li>
      <li><a name="toc-_0022Asking-Streams-What-They-Can-Do_0022" href="#g_t_0022Asking-Streams-What-They-Can-Do_0022">21.5.3 &quot;Asking Streams What They Can Do&quot;</a></li>
      <li><a name="toc-_0022Operations-for-Interactive-Streams_0022" href="#g_t_0022Operations-for-Interactive-Streams_0022">21.5.4 &quot;Operations for Interactive Streams&quot;</a></li>
      <li><a name="toc-_0022Cursor-Positioning-Stream-Operations_0022" href="#g_t_0022Cursor-Positioning-Stream-Operations_0022">21.5.5 &quot;Cursor Positioning Stream Operations&quot;</a></li>
      <li><a name="toc-_0022Operations-for-Efficient-Grinding_0022" href="#g_t_0022Operations-for-Efficient-Grinding_0022">21.5.6 &quot;Operations for Efficient Grinding&quot;</a></li>
      <li><a name="toc-_0022Random-Access-File-Operations_0022" href="#g_t_0022Random-Access-File-Operations_0022">21.5.7 &quot;Random Access File Operations&quot;</a></li>
      <li><a name="toc-_0022Buffered-Stream-Operations_0022" href="#g_t_0022Buffered-Stream-Operations_0022">21.5.8 &quot;Buffered Stream Operations&quot;</a></li>
      <li><a name="toc-_0022Standard-Streams_0022" href="#g_t_0022Standard-Streams_0022">21.5.9 &quot;Standard Streams&quot;</a></li>
      <li><a name="toc-_0022Obtaining-Streams-to-Use_0022" href="#g_t_0022Obtaining-Streams-to-Use_0022">21.5.10 &quot;Obtaining Streams to Use&quot;</a></li>
      <li><a name="toc-_0022Implementing-Streams_0022" href="#g_t_0022Implementing-Streams_0022">21.5.11 &quot;Implementing Streams&quot;</a></li>
      <li><a name="toc-_0022Implementing-Streams-with-Flavors_0022" href="#g_t_0022Implementing-Streams-with-Flavors_0022">21.5.12 &quot;Implementing Streams with Flavors&quot;</a></li>
      <li><a name="toc-_0022Implementing-Streams-Without-Flavors_0022" href="#g_t_0022Implementing-Streams-Without-Flavors_0022">21.5.13 &quot;Implementing Streams Without Flavors&quot;</a></li>
    </ul></li>
    <li><a name="toc-_0022Formatted-Output_0022" href="#g_t_0022Formatted-Output_0022">21.6 &quot;Formatted Output&quot;</a>
    <ul class="no-bullet">
      <li><a name="toc-The-Format-Function" href="#The-Format-Function">21.6.1 The Format Function</a></li>
      <li><a name="toc-The-Output-Subsystem" href="#The-Output-Subsystem">21.6.2 The Output Subsystem</a></li>
      <li><a name="toc-Formatting-Lisp-Code" href="#Formatting-Lisp-Code">21.6.3 Formatting Lisp Code</a></li>
    </ul></li>
    <li><a name="toc-_0022Rubout-Handling_0022" href="#g_t_0022Rubout-Handling_0022">21.7 &quot;Rubout Handling&quot;</a></li>
    <li><a name="toc-The-_003aread-and-_003aprint-Stream-Operations" href="#The-_003aread-and-_003aprint-Stream-Operations">21.8 The :read and :print Stream Operations</a></li>
    <li><a name="toc-_0022Accessing-Files_0022" href="#g_t_0022Accessing-Files_0022">21.9 &quot;Accessing Files&quot;</a>
    <ul class="no-bullet">
      <li><a name="toc-Loading-Files" href="#Loading-Files">21.9.1 Loading Files</a></li>
      <li><a name="toc-File-Attribute-Lists" href="#File-Attribute-Lists">21.9.2 File Attribute Lists</a></li>
      <li><a name="toc-File-Stream-Operations" href="#File-Stream-Operations">21.9.3 File Stream Operations</a></li>
    </ul></li>
    <li><a name="toc-Accessing-Directories" href="#Accessing-Directories">21.10 Accessing Directories</a></li>
    <li><a name="toc-Errors-in-Accessing-Files" href="#Errors-in-Accessing-Files">21.11 Errors in Accessing Files</a></li>
    <li><a name="toc-_0022File-Servers_0022" href="#g_t_0022File-Servers_0022">21.12 &quot;File Servers&quot;</a>
    <ul class="no-bullet">
      <li><a name="toc-Errors-in-Communication-with-File-Servers" href="#Errors-in-Communication-with-File-Servers">21.12.1 Errors in Communication with File Servers</a></li>
    </ul></li>
  </ul></li>
  <li><a name="toc-Naming-of-Files" href="#Naming-of-Files">22 Naming of Files</a>
  <ul class="no-bullet">
    <li><a name="toc-Pathnames" href="#Pathnames">22.1 Pathnames</a></li>
    <li><a name="toc-Pathname-Components" href="#Pathname-Components">22.2 Pathname Components</a>
    <ul class="no-bullet">
      <li><a name="toc-Raw-Components-and-Interchange-Components" href="#Raw-Components-and-Interchange-Components">22.2.1 Raw Components and Interchange Components</a></li>
      <li><a name="toc-Pathname-Component-Operations" href="#Pathname-Component-Operations">22.2.2 Pathname Component Operations</a></li>
      <li><a name="toc-Canonical-Types" href="#Canonical-Types">22.2.3 Canonical Types</a></li>
    </ul></li>
    <li><a name="toc-Defaults-and-Merging" href="#Defaults-and-Merging">22.3 Defaults and Merging</a></li>
    <li><a name="toc-Pathname-Functions" href="#Pathname-Functions">22.4 Pathname Functions</a></li>
    <li><a name="toc-Generic-Pathnames" href="#Generic-Pathnames">22.5 Generic Pathnames</a></li>
    <li><a name="toc-Pathname-Operations" href="#Pathname-Operations">22.6 Pathname Operations</a></li>
    <li><a name="toc-Host-File-Systems-Supported" href="#Host-File-Systems-Supported">22.7 Host File Systems Supported</a>
    <ul class="no-bullet">
      <li><a name="toc-ITS" href="#ITS">22.7.1 ITS</a></li>
      <li><a name="toc-TOPS_002d20-_0028Twenex_0029_002c-Tenex_002c-and-VMS_002e" href="#TOPS_002d20-_0028Twenex_0029_002c-Tenex_002c-and-VMS_002e">22.7.2 TOPS-20 (Twenex), Tenex, and VMS.</a></li>
      <li><a name="toc-Unix-pathnames" href="#Unix-pathnames">22.7.3 Unix pathnames</a></li>
      <li><a name="toc-Lisp-Machine-File-Systems" href="#Lisp-Machine-File-Systems">22.7.4 Lisp Machine File Systems</a></li>
      <li><a name="toc-Logical-Pathnames" href="#Logical-Pathnames">22.7.5 Logical Pathnames</a></li>
      <li><a name="toc-Editor-Buffer-Pathnames" href="#Editor-Buffer-Pathnames">22.7.6 Editor Buffer Pathnames</a></li>
    </ul></li>
    <li><a name="toc-Hosts" href="#Hosts">22.8 Hosts</a>
    <ul class="no-bullet">
      <li><a name="toc-Parsing-Hostnames" href="#Parsing-Hostnames">22.8.1 Parsing Hostnames</a></li>
      <li><a name="toc-Host-Object-Operations" href="#Host-Object-Operations">22.8.2 Host Object Operations</a></li>
    </ul></li>
    <li><a name="toc-Maclisp-Conversion" href="#Maclisp-Conversion">22.9 Maclisp Conversion</a></li>
  </ul></li>
  <li><a name="toc-The-Chaosnet" href="#The-Chaosnet">23 The Chaosnet</a>
  <ul class="no-bullet">
    <li><a name="toc-Chaosnet-Overview" href="#Chaosnet-Overview">23.1 Chaosnet Overview</a></li>
    <li><a name="toc-Conns" href="#Conns">23.2 Conns</a></li>
    <li><a name="toc-Opening-and-Closing-Connections" href="#Opening-and-Closing-Connections">23.3 Opening and Closing Connections</a>
    <ul class="no-bullet">
      <li><a name="toc-User_002dSide" href="#User_002dSide">23.3.1 User-Side</a></li>
      <li><a name="toc-Server_002dSide" href="#Server_002dSide">23.3.2 Server-Side</a></li>
    </ul></li>
    <li><a name="toc-Stream-Input-and-Output" href="#Stream-Input-and-Output">23.4 Stream Input and Output</a></li>
    <li><a name="toc-Packet-Input-and-Output" href="#Packet-Input-and-Output">23.5 Packet Input and Output</a></li>
    <li><a name="toc-Connection-Interrupts" href="#Connection-Interrupts">23.6 Connection Interrupts</a></li>
    <li><a name="toc-Chaosnet-Errors" href="#Chaosnet-Errors">23.7 Chaosnet Errors</a>
    <ul class="no-bullet">
      <li><a name="toc-Local-Problems" href="#Local-Problems">23.7.1 Local Problems</a></li>
      <li><a name="toc-Problems-Involving-Other-Machines_0027-Actions" href="#Problems-Involving-Other-Machines_0027-Actions">23.7.2 Problems Involving Other Machines&rsquo; Actions</a></li>
    </ul></li>
    <li><a name="toc-Information-and-Control" href="#Information-and-Control">23.8 Information and Control</a></li>
    <li><a name="toc-Higher_002dLevel-Protocols" href="#Higher_002dLevel-Protocols">23.9 Higher-Level Protocols</a>
    <ul class="no-bullet">
      <li><a name="toc-Status" href="#Status">23.9.1 Status</a></li>
      <li><a name="toc-Telnet-and-Supdup" href="#Telnet-and-Supdup">23.9.2 Telnet and Supdup</a></li>
      <li><a name="toc-File-Access" href="#File-Access">23.9.3 File Access</a></li>
      <li><a name="toc-Mail" href="#Mail">23.9.4 Mail</a></li>
      <li><a name="toc-Send" href="#Send">23.9.5 Send</a></li>
      <li><a name="toc-Name" href="#Name">23.9.6 Name</a></li>
      <li><a name="toc-Time" href="#Time">23.9.7 Time</a></li>
      <li><a name="toc-Arpanet-Gateway" href="#Arpanet-Gateway">23.9.8 Arpanet Gateway</a></li>
      <li><a name="toc-Host-Table" href="#Host-Table">23.9.9 Host Table</a></li>
      <li><a name="toc-Dover" href="#Dover">23.9.10 Dover</a></li>
      <li><a name="toc-Remote-Disk" href="#Remote-Disk">23.9.11 Remote Disk</a></li>
      <li><a name="toc-The-Eval-Server" href="#The-Eval-Server">23.9.12 The Eval Server</a></li>
    </ul></li>
    <li><a name="toc-Using-Higher-Level-Protocols" href="#Using-Higher-Level-Protocols">23.10 Using Higher Level Protocols</a></li>
  </ul></li>
  <li><a name="toc-_0022Packages_0022" href="#g_t_0022Packages_0022">24 &quot;Packages&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-_0022The-Organization-of-Name-Spaces_0022" href="#g_t_0022The-Organization-of-Name-Spaces_0022">24.1 &quot;The Organization of Name Spaces&quot;</a></li>
    <li><a name="toc-_0022Shared-Programs_0022" href="#g_t_0022Shared-Programs_0022">24.2 &quot;Shared Programs&quot;</a></li>
    <li><a name="toc-_0022Declaring-Packages_0022" href="#g_t_0022Declaring-Packages_0022">24.3 &quot;Declaring Packages&quot;</a></li>
    <li><a name="toc-_0022Packages-and-Writing-Code_0022" href="#g_t_0022Packages-and-Writing-Code_0022">24.4 &quot;Packages and Writing Code&quot;</a></li>
    <li><a name="toc-_0022Shadowing_0022" href="#g_t_0022Shadowing_0022">24.5 &quot;Shadowing&quot;</a></li>
    <li><a name="toc-_0022Packages-and-Interning_0022" href="#g_t_0022Packages-and-Interning_0022">24.6 &quot;Packages and Interning&quot;</a></li>
    <li><a name="toc-_0022Status-Information_0022" href="#g_t_0022Status-Information_0022">24.7 &quot;Status Information&quot;</a></li>
    <li><a name="toc-_0022Packages_002c-Loading_002c-and-Compilation_0022" href="#g_t_0022Packages_002c-Loading_002c-and-Compilation_0022">24.8 &quot;Packages, Loading, and Compilation&quot;</a></li>
    <li><a name="toc-_0022Subpackages_0022" href="#g_t_0022Subpackages_0022">24.9 &quot;Subpackages&quot;</a></li>
    <li><a name="toc-_0022Initialization-of-the-Package-System_0022" href="#g_t_0022Initialization-of-the-Package-System_0022">24.10 &quot;Initialization of the Package System&quot;</a></li>
    <li><a name="toc-_0022Initial-Packages_0022" href="#g_t_0022Initial-Packages_0022">24.11 &quot;Initial Packages&quot;</a></li>
    <li><a name="toc-_0022Multiple-Instantiations-of-a-Program_0022" href="#g_t_0022Multiple-Instantiations-of-a-Program_0022">24.12 &quot;Multiple Instantiations of a Program&quot;</a></li>
  </ul></li>
  <li><a name="toc-Maintaining-Large-Systems" href="#Maintaining-Large-Systems">25 Maintaining Large Systems</a>
  <ul class="no-bullet">
    <li><a name="toc-Defining-a-System" href="#Defining-a-System">25.1 Defining a System</a></li>
    <li><a name="toc-Transformations" href="#Transformations">25.2 Transformations</a></li>
    <li><a name="toc-Making-a-System" href="#Making-a-System">25.3 Making a System</a></li>
    <li><a name="toc-Adding-New-Keywords-to-make_002dsystem" href="#Adding-New-Keywords-to-make_002dsystem">25.4 Adding New Keywords to make-system</a></li>
    <li><a name="toc-Adding-New-Options-for-defsystem" href="#Adding-New-Options-for-defsystem">25.5 Adding New Options for defsystem</a></li>
    <li><a name="toc-More-Esoteric-Transformations" href="#More-Esoteric-Transformations">25.6 More Esoteric Transformations</a></li>
    <li><a name="toc-The-Patch-Facility" href="#The-Patch-Facility">25.7 The Patch Facility</a>
    <ul class="no-bullet">
      <li><a name="toc-Defining-a-System-1" href="#Defining-a-System-1">25.7.1 Defining a System</a></li>
      <li><a name="toc-Patch-files" href="#Patch-files">25.7.2 Patch files</a></li>
      <li><a name="toc-Loading-Patches" href="#Loading-Patches">25.7.3 Loading Patches</a></li>
      <li><a name="toc-Making-Patches" href="#Making-Patches">25.7.4 Making Patches</a></li>
      <li><a name="toc-System-Status" href="#System-Status">25.7.5 System Status</a></li>
    </ul></li>
  </ul></li>
  <li><a name="toc-Processes" href="#Processes">26 Processes</a>
  <ul class="no-bullet">
    <li><a name="toc-The-Scheduler" href="#The-Scheduler">26.1 The Scheduler</a></li>
    <li><a name="toc-Locks" href="#Locks">26.2 Locks</a></li>
    <li><a name="toc-Creating-a-Process" href="#Creating-a-Process">26.3 Creating a Process</a></li>
    <li><a name="toc-Process-Generic-Operations" href="#Process-Generic-Operations">26.4 Process Generic Operations</a>
    <ul class="no-bullet">
      <li><a name="toc-Process-Attributes" href="#Process-Attributes">26.4.1 Process Attributes</a></li>
      <li><a name="toc-Run-and-Arrest-Reasons" href="#Run-and-Arrest-Reasons">26.4.2 Run and Arrest Reasons</a></li>
      <li><a name="toc-Bashing-the-Process" href="#Bashing-the-Process">26.4.3 Bashing the Process</a></li>
    </ul></li>
    <li><a name="toc-Process-Flavors" href="#Process-Flavors">26.5 Process Flavors</a></li>
    <li><a name="toc-Other-Process-Functions" href="#Other-Process-Functions">26.6 Other Process Functions</a></li>
  </ul></li>
  <li><a name="toc-Errors-and-Debugging" href="#Errors-and-Debugging">27 Errors and Debugging</a>
  <ul class="no-bullet">
    <li><a name="toc-Conditions" href="#Conditions">27.1 Conditions</a></li>
    <li><a name="toc-Handling-Conditions" href="#Handling-Conditions">27.2 Handling Conditions</a></li>
    <li><a name="toc-Standard-Condition-Flavors" href="#Standard-Condition-Flavors">27.3 Standard Condition Flavors</a></li>
    <li><a name="toc-Condition-Operations" href="#Condition-Operations">27.4 Condition Operations</a>
    <ul class="no-bullet">
      <li><a name="toc-Condition-Operations-for-the-Debugger" href="#Condition-Operations-for-the-Debugger">27.4.1 Condition Operations for the Debugger</a></li>
    </ul></li>
    <li><a name="toc-Signaling-Conditions" href="#Signaling-Conditions">27.5 Signaling Conditions</a>
    <ul class="no-bullet">
      <li><a name="toc-Convenience-Functions-for-Signaling" href="#Convenience-Functions-for-Signaling">27.5.1 Convenience Functions for Signaling</a></li>
      <li><a name="toc-Creating-Condition-Instances" href="#Creating-Condition-Instances">27.5.2 Creating Condition Instances</a></li>
      <li><a name="toc-Signaling-a-Condition-Instance" href="#Signaling-a-Condition-Instance">27.5.3 Signaling a Condition Instance</a></li>
    </ul></li>
    <li><a name="toc-Proceeding" href="#Proceeding">27.6 Proceeding</a>
    <ul class="no-bullet">
      <li><a name="toc-Proceeding-and-the-Debugger" href="#Proceeding-and-the-Debugger">27.6.1 Proceeding and the Debugger</a></li>
      <li><a name="toc-How-Signalers-Provide-Proceed-Types" href="#How-Signalers-Provide-Proceed-Types">27.6.2 How Signalers Provide Proceed Types</a></li>
      <li><a name="toc-Nonlocal-Proceed-Types" href="#Nonlocal-Proceed-Types">27.6.3 Nonlocal Proceed Types</a></li>
    </ul></li>
    <li><a name="toc-The-Debugger" href="#The-Debugger">27.7 The Debugger</a>
    <ul class="no-bullet">
      <li><a name="toc-Entering-the-Debugger" href="#Entering-the-Debugger">27.7.1 Entering the Debugger</a></li>
      <li><a name="toc-How-to-Use-the-Debugger" href="#How-to-Use-the-Debugger">27.7.2 How to Use the Debugger</a></li>
      <li><a name="toc-_0022Debugger-Commands_0022" href="#g_t_0022Debugger-Commands_0022">27.7.3 &quot;Debugger Commands&quot;</a></li>
      <li><a name="toc-_0022Summary-of-Commands_0022" href="#g_t_0022Summary-of-Commands_0022">27.7.4 &quot;Summary of Commands&quot;</a></li>
      <li><a name="toc-Deexposed-Windows-and-Background-Processes" href="#Deexposed-Windows-and-Background-Processes">27.7.5 Deexposed Windows and Background Processes</a></li>
    </ul></li>
    <li><a name="toc-Tracing-Function-Execution" href="#Tracing-Function-Execution">27.8 Tracing Function Execution</a></li>
    <li><a name="toc-Breakon" href="#Breakon">27.9 Breakon</a></li>
    <li><a name="toc-Advising-a-Function" href="#Advising-a-Function">27.10 Advising a Function</a>
    <ul class="no-bullet">
      <li><a name="toc-Designing-the-Advice" href="#Designing-the-Advice">27.10.1 Designing the Advice</a></li>
      <li><a name="toc-_003aaround-Advice" href="#g_t_003aaround-Advice">27.10.2 :around Advice</a></li>
      <li><a name="toc-Advising-One-Function-Within-Another" href="#Advising-One-Function-Within-Another">27.10.3 Advising One Function Within Another</a></li>
    </ul></li>
    <li><a name="toc-Stepping-Through-an-Evaluation" href="#Stepping-Through-an-Evaluation">27.11 Stepping Through an Evaluation</a></li>
    <li><a name="toc-_0022Evalhook_0022" href="#g_t_0022Evalhook_0022">27.12 &quot;Evalhook&quot;</a></li>
    <li><a name="toc-_0022The-MAR_0022" href="#g_t_0022The-MAR_0022">27.13 &quot;The MAR&quot;</a></li>
    <li><a name="toc-Variable-Monitoring" href="#Variable-Monitoring">27.14 Variable Monitoring</a></li>
  </ul></li>
  <li><a name="toc-How-to-Read-Assembly-Language" href="#How-to-Read-Assembly-Language">28 How to Read Assembly Language</a>
  <ul class="no-bullet">
    <li><a name="toc-Introduction" href="#Introduction">28.1 Introduction</a></li>
    <li><a name="toc-A-More-Advanced-Example" href="#A-More-Advanced-Example">28.2 A More Advanced Example</a></li>
    <li><a name="toc-The-Rest-of-the-Instructions" href="#The-Rest-of-the-Instructions">28.3 The Rest of the Instructions</a></li>
    <li><a name="toc-Function-Entry" href="#Function-Entry">28.4 Function Entry</a></li>
    <li><a name="toc-Special-Class-IV-Instructions" href="#Special-Class-IV-Instructions">28.5 Special Class IV Instructions</a></li>
    <li><a name="toc-Estimating-Run-Time" href="#Estimating-Run-Time">28.6 Estimating Run Time</a></li>
  </ul></li>
  <li><a name="toc-_0022Querying-the-User_0022" href="#g_t_0022Querying-the-User_0022">29 &quot;Querying the User&quot;</a></li>
  <li><a name="toc-Initializations" href="#Initializations">30 Initializations</a>
  <ul class="no-bullet">
    <li><a name="toc-System-Initialization-Lists" href="#System-Initialization-Lists">30.1 System Initialization Lists</a></li>
  </ul></li>
  <li><a name="toc-Dates-and-Times" href="#Dates-and-Times">31 Dates and Times</a>
  <ul class="no-bullet">
    <li><a name="toc-Getting-and-Setting-the-Time" href="#Getting-and-Setting-the-Time">31.1 Getting and Setting the Time</a>
    <ul class="no-bullet">
      <li><a name="toc-Elapsed-Time-in-60ths-of-a-Second" href="#Elapsed-Time-in-60ths-of-a-Second">31.1.1 Elapsed Time in 60ths of a Second</a></li>
      <li><a name="toc-Elapsed-Time-in-Microseconds" href="#Elapsed-Time-in-Microseconds">31.1.2 Elapsed Time in Microseconds</a></li>
    </ul></li>
    <li><a name="toc-Printing-Dates-and-Times" href="#Printing-Dates-and-Times">31.2 Printing Dates and Times</a></li>
    <li><a name="toc-Reading-Dates-and-Times" href="#Reading-Dates-and-Times">31.3 Reading Dates and Times</a></li>
    <li><a name="toc-Reading-and-Printing-Time-Intervals" href="#Reading-and-Printing-Time-Intervals">31.4 Reading and Printing Time Intervals</a></li>
    <li><a name="toc-Time-Conversions" href="#Time-Conversions">31.5 Time Conversions</a></li>
    <li><a name="toc-Internal-Functions" href="#Internal-Functions">31.6 Internal Functions</a></li>
  </ul></li>
  <li><a name="toc-_0022Miscellaneous-Useful-Functions_0022" href="#g_t_0022Miscellaneous-Useful-Functions_0022">32 &quot;Miscellaneous Useful Functions&quot;</a>
  <ul class="no-bullet">
    <li><a name="toc-Hardcopy" href="#Hardcopy">32.1 Hardcopy</a></li>
    <li><a name="toc-Metering" href="#Metering">32.2 Metering</a></li>
    <li><a name="toc-Poking-Around-in-the-Lisp-World" href="#Poking-Around-in-the-Lisp-World">32.3 Poking Around in the Lisp World</a></li>
    <li><a name="toc-Utility-Programs" href="#Utility-Programs">32.4 Utility Programs</a></li>
    <li><a name="toc-_0022The-Lisp-Top-Level_0022" href="#g_t_0022The-Lisp-Top-Level_0022">32.5 &quot;The Lisp Top Level&quot;</a></li>
    <li><a name="toc-The-Garbage-Collector" href="#The-Garbage-Collector">32.6 The Garbage Collector</a></li>
    <li><a name="toc-_0022Logging-In_0022" href="#g_t_0022Logging-In_0022">32.7 &quot;Logging In&quot;</a></li>
    <li><a name="toc-Dribble-Files" href="#Dribble-Files">32.8 Dribble Files</a></li>
    <li><a name="toc-Status-and-SStatus" href="#Status-and-SStatus">32.9 Status and SStatus</a></li>
    <li><a name="toc-Booting-and-Disk-Partitions" href="#Booting-and-Disk-Partitions">32.10 Booting and Disk Partitions</a>
    <ul class="no-bullet">
      <li><a name="toc-Manipulating-the-Label" href="#Manipulating-the-Label">32.10.1 Manipulating the Label</a></li>
      <li><a name="toc-Updating-Software" href="#Updating-Software">32.10.2 Updating Software</a></li>
      <li><a name="toc-Garbage-Collecting-to-Compress-Bands" href="#Garbage-Collecting-to-Compress-Bands">32.10.3 Garbage Collecting to Compress Bands</a></li>
      <li><a name="toc-Installing-New-Software" href="#Installing-New-Software">32.10.4 Installing New Software</a></li>
      <li><a name="toc-Installing-New-Microcode" href="#Installing-New-Microcode">32.10.5 Installing New Microcode</a></li>
    </ul></li>
    <li><a name="toc-Site-Options-and-Host-Table" href="#Site-Options-and-Host-Table">32.11 Site Options and Host Table</a>
    <ul class="no-bullet">
      <li><a name="toc-Updating-Site-Information" href="#Updating-Site-Information">32.11.1 Updating Site Information</a></li>
      <li><a name="toc-Accessing-Site-Options" href="#Accessing-Site-Options">32.11.2 Accessing Site Options</a></li>
      <li><a name="toc-The-LMLOCS-File" href="#The-LMLOCS-File">32.11.3 The LMLOCS File</a></li>
      <li><a name="toc-Initializing-a-Band-at-a-New-Site" href="#Initializing-a-Band-at-a-New-Site">32.11.4 Initializing a Band at a New Site</a></li>
    </ul></li>
  </ul></li>
</ul>
</div>




<div align="center"><h1 class="titlefont">Lisp Machine Manual</h1>
</div><div align="center">Fifth Edition, System Version 92
</div><div align="center">January 1983
</div><div align="center">Daniel Weinreb
</div><div align="center">David Moon
</div><div align="center">Richard Stallman
</div><p>This report describes research done at the Artificial Intelligence
Laboratory of the Massachusetts Institute of Technology.  Support for the
laboratory&rsquo;s artificial intelligence research is provided in part by the
Advanced Research Projects Agency of the Department of Defense under Office
of Naval Research Contract number N00014-80-C-0505.
</p><div align="center"><h1 class="titlefont">Preface</h1>
</div>
<p>The Lisp Machine manual describes both the language and the &quot;operating system&quot;
of the Lisp Machine.  The language, a dialect of Lisp called Zetalisp,
is completely documented
by this manual.  The software environment and operating-system-like parts of
the system contain many things which are still in a state of flux.
This manual confines itself primarily to the stabler parts of the
system, and does not address the window system and user interface at all.
That documentation will be released as a separate volume at a later time.
</p>
<p>Any comments, suggestions, or criticisms will be welcomed.  Please send
Arpa network mail to BUG-LMMAN@MIT-OZ.
</p>
<p>Those not on the Arpanet may send U.S. mail to
</p><div class="lisp">
<pre class="lisp"><span class="roman">Richard M. Stallman
545 Technology Square, Room 793
Cambridge, Mass. 02139</span>
</pre></div>
<div align="center"><h1 class="titlefont">Note</h1>
</div>
<p>The Lisp Machine is a product of the efforts of many people too numerous to list here
and of the unique environment of the M.I.T. Artificial Intelligence Laboratory.
</p>
<p>Portions of this manual were written by Mike McMahon and Alan Bawden.
The chapter on the LOOP iteration macro is a reprint of Laboratory for
Computer Science memo TM-169, by Glenn Burke.
</p>
<a name="g_t_0022Introduction_0022"></a>
<h2 class="chapter">1 &quot;Introduction&quot;</h2>

<a name="g_t_0022General-Information_0022"></a>
<h3 class="section">1.1 &quot;General Information&quot;</h3>

<p>The Lisp Machine is a new computer system designed to provide a
high-performance and economical implementation of the Lisp language.  It
is a personal computation system, which means that processors and main
memories are not time-multiplexed: when using a Lisp Machine, you get
your own processor and memory system for the duration of the session.
It is designed this way to relieve the problems of the running of large
Lisp programs on time-sharing systems.  Everything on the Lisp Machine
is written in Lisp, including all system programs; there is never any
need to program in machine language.  The system is highly interactive.
</p>
<p>The Lisp Machine executes a new dialect of Lisp called
Zetalisp, developed at the M.I.T Artificial Intelligence
Laboratory for use in artificial intelligence research and related
fields.  It is closely related to the Maclisp dialect, and attempts to
maintain a good degree of compatibility with Maclisp, while also
providing many improvements and new features.  Maclisp, in turn, is
based on Lisp 1.5. 
</p>
<p>This document is the reference manual for the Zetalisp
language.  This document is not a tutorial, and it sometimes refers to
functions and concepts that are not explained until later in the manual.
It is assumed that you have a basic working knowledge of some Lisp
dialect; you will be able to figure out the rest of the language from
this manual.
</p>
<p>There are also facilities explained in this manual that are not
really part of the Lisp language.  Some of these are subroutine packages
of general use, and others are tools used in writing programs.  
The Lisp Machine window system and the major utility programs are not
documented here.
</p>
<a name="g_t_0022Structure-of-the-Manual_0022"></a>
<h3 class="section">1.2 &quot;Structure of the Manual&quot;</h3>

<p>The manual starts out with an explanation of the language.  Chapter
<a href="#object_002dchapter">object-chapter</a> explains the different primitive types of Lisp object
and presents some basic <em>predicate</em> functions for testing types.
Chapter <a href="#evaluator_002dchapter">evaluator-chapter</a> explains the process of evaluation, which
is the heart of the Lisp language.  Chapter <a href="#flow_002dchapter">flow-chapter</a> introduces
the basic Lisp control structures.
</p>
<p>The next several chapters explain the details of the various
primitive data-types of the language and the functions that deal with
them.  Chapter <a href="#cons_002dchapter">cons-chapter</a> deals with conses and the higher-level
structures that can be built out of them, such as trees, lists,
association lists, and property lists.  Chapter <a href="#symbol_002dchapter">symbol-chapter</a> deals
with symbols, chapter <a href="#number_002dchapter">number-chapter</a> with the various kinds of
numbers, and chapter <a href="#array_002dchapter">array-chapter</a> with arrays.  Chapter
<a href="#string_002dchapter">string-chapter</a> explains character strings, which are a special kind
of array.
</p>
<p>After this there are some chapters that explain more about functions,
function-calling, and related matters.  Chapter <a href="#function_002dchapter">function-chapter</a> presents
all the kinds of functions in the language, explains function-specs, and
tells how to manipulate definitions of functions.  Chapters <a href="#closure_002dchapter">closure-chapter</a>
and <a href="#stack_002dgroup_002dchapter">stack-group-chapter</a> discuss closures and stack-groups, two facilities
useful for creating coroutines and other advanced control and access structures.
</p>
<p>Next, a few lower-level issues are dealt with.  Chapter
<a href="#locative_002dchapter">locative-chapter</a> explains locatives, which are a kind of pointer to
memory cells.  Chapter <a href="#subprimitive_002dchapter">subprimitive-chapter</a> explains the &quot;subprimitive&quot;
functions, which are primarily useful for implementation of the Lisp
language itself and the Lisp Machine&rsquo;s &quot;operating system&quot;.  Chapter
<a href="#area_002dchapter">area-chapter</a> discusses areas, which give you control over storage
allocation and locality of reference.
</p>
<p>Chapter <a href="#compiler_002dchapter">compiler-chapter</a> discusses the Lisp compiler, which
converts Lisp programs into &quot;machine language&quot;.  Chapter
<a href="#macros_002dchapter">macros-chapter</a> explains the Lisp macro facility, which allows users
to write their own extensions to Lisp, extending both the interpreter
and the compiler.  The next two chapters go into detail about two such
extensions, one that provides a powerful iteration control structure
(chapter <a href="#loop_002dchapter">loop-chapter</a>), and one that provides a powerful data
structure facility (chapter <a href="#defstruct_002dchapter">defstruct-chapter</a>).
</p>
<p>Chapter <a href="#flavor_002dchapter">flavor-chapter</a> documents flavors, a language facility
to provide generic functions using the paradigm used in Smalltalk and the
Actor families of languages, called &quot;object-oriented programming&quot; or
&quot;message passing&quot;.  Flavors are widely used by the system programs of
the Lisp Machine, as well as being available to the user as a language
feature.
</p>
<p>Chapter <a href="#io_002dchapter">io-chapter</a> explains the Lisp Machine&rsquo;s Input/Output system, including
<em>streams</em> and the <em>printed representation</em> of Lisp objects.  Chapter
<a href="#pathname_002dchapter">pathname-chapter</a> documents how to deal with pathnames (the names of
files).  Chapter <a href="#chaos_002dchapter">chaos-chapter</a> describes the use of the chaosnet.
</p>
<p>Chapter <a href="#package_002dchapter">package-chapter</a>
describes the <em>package</em> system, which allows many name spaces within
a single Lisp environment.  Chapter <a href="#system_002dchapter">system-chapter</a> documents the
&quot;system&quot; facility, which helps you create and maintain programs
that reside in many files.
</p>
<p>Chapter <a href="#process_002dchapter">process-chapter</a> discusses the facilities for
multiple processes and how to write programs that use concurrent
computation.  Chapter <a href="#error_002dchapter">error-chapter</a> explains how exceptional
conditions (errors) can be handled by programs, handled by users, and
debugged.  Chapter <a href="#code_002dchapter">code-chapter</a> explains the instruction set of the
Lisp Machine and tells you how to examine the output of the compiler.
Chapter <a href="#query_002dchapter">query-chapter</a> documents some functions for querying the
user, chapter <a href="#time_002dchapter">time-chapter</a> explains some functions for manipulating
dates and times, and chapter <a href="#misc_002dchapter">misc-chapter</a> contains other
miscellaneous functions and facilities.
</p>

<a name="g_t_0022Notational-Conventions-and-Helpful-Notes_0022"></a>
<h3 class="section">1.3 &quot;Notational Conventions and Helpful Notes&quot;</h3>

<p>There are several conventions of notation and various points
that should be understood before reading the manual.  This section
explains those conventions.
</p>
<p>The symbol &quot;=&gt;&quot; will be used to indicate evaluation in
examples.  Thus, when you see &quot;<code>foo</code> =&gt; <code>nil</code>&quot;, this means the
same thing as &quot;the result of evaluating <code>foo</code> is (or would have
been) <code>nil</code>&quot;. 
</p>
<p>The symbol &quot;==&gt;&quot; will be used to indicate macro expansion
in examples.  This, when you see &quot;<code>(foo bar)</code> ==&gt; <code>(aref bar 0)</code>&quot;,
this means the same thing as &quot;the result of macro-expanding <code>(foo bar)</code>
is (or would have been) <code>(aref bar 0)</code>&quot;.
</p>
<p>A typical description of a Lisp function looks like this:
</p>
<dl>
<dt><a name="index-function_002dname"></a>Function: <strong>function-name</strong> <em>arg1 arg2 &amp;optional arg3 (arg4 <code>(foo 3)</code>)</em></dt>
<dd><p>The <code>function-name</code> function adds together <em>arg1</em> and <em>arg2</em>,
and then multiplies the result by <em>arg3</em>.  If <em>arg3</em> is not provided,
the multiplication isn&rsquo;t done.  <code>function-name</code> then returns a list
whose first element is this result and whose second element is <em>arg4</em>.
Examples:
</p><div class="lisp">
<pre class="lisp">(function-name 3 4) =&gt; (7 4)
(function-name 1 2 2 'bar) =&gt; (6 bar)
</pre></div>
</dd></dl>

<p>Note the use of fonts (typefaces).  The name of the function is
in bold-face in the first line of the description, and the arguments are
in italics.  Within the text, printed representations of Lisp objects
are in a different bold-face font, such as <code>(+ foo 56)</code>, and argument
references are italicized, such as <em>arg1</em> and <em>arg2</em>.  A different,
fixed-width font, such as <code>function-name</code>, is used for Lisp examples
that are set off from the text.  Other font conventions are that
filenames are in bold-face, all upper case (as in <code>SYS: SYS; SYSDCL
LISP</code>) while keys on the keyboard are in bold-face and capitalized
(as in <code>Help</code>, <code>Return</code> and <code>Meta</code>).
</p>
<p>&quot;Car&quot;, &quot;cdr&quot; and &quot;cons&quot; are in bold-face when the actual Lisp objects
are being mentioned, but in the normal text font when used as words.
</p>
<p>The word &quot;<code>&amp;optional</code>&quot; in the list of arguments tells you that all
of the arguments past this point are optional.  The default value can be
specified explicitly, as with <em>arg4</em> whose default value is the result
of evaluating the form <code>(foo 3)</code>.  If no default value is specified,
it is the symbol <code>nil</code>.  This syntax is used in lambda-lists in the
language, which are explained in <a href="#lambda_002dlist">lambda-list</a>.  Argument lists may
also contain &quot;<code>&amp;rest</code>&quot;, which is part of the same syntax.
</p>
<p>The descriptions of special forms and macros look like this:
</p>
<dl>
<dt><a name="index-do_002dthree_002dtimes"></a>Special Form: <strong>do-three-times</strong> <em>form</em></dt>
<dd><p>This evaluates <em>form</em> three times and returns the result of the third
evaluation.
</p></dd></dl>

<dl>
<dt><a name="index-with_002dfoo_002dbound_002dto_002dnil"></a>Macro: <strong>with-foo-bound-to-nil</strong> <em>form...</em></dt>
<dd><p>This evaluates the <em>forms</em> with the symbol <code>foo</code> bound to <code>nil</code>.
It expands as follows:
</p><div class="lisp">
<pre class="lisp">(with-foo-bound-to-nil
    <em>form1</em>
    <em>form2</em> ...) ==&gt;
(let ((foo nil))
    <em>form1</em>
    <em>form2</em> ...)
</pre></div>
</dd></dl>

<p>Since special forms and macros are the mechanism by which the syntax of Lisp
is extended, their descriptions must describe both their syntax and their
semantics; functions follow a simple consistent set of rules, but each
special form is idiosyncratic.  The syntax is displayed on the first line
of the description using the following conventions.  Italicized words are
names of parts of the form which are referred to in the descriptive text.
They are not arguments, even though they resemble the italicized words in
the first line of a function description.  Parentheses (&quot;<code>( )</code>&quot;) stand for themselves.
Square brackets (&quot;<code>[ ]</code>&quot;) indicate that what they enclose is optional.  
Ellipses (&quot;<code>...</code>&quot;) indicate that the subform (italicized word or parenthesized
list) which precedes them may be repeated any number of times (possibly no times at all).
Curly brackets followed by ellipses (&quot;<code>{ }...</code>&quot;) indicate that what they
enclose may be repeated any number of times.  Thus the first line of the
description of a special form is a &quot;template&quot; for what an instance of that
special form would look like, with the surrounding parentheses removed.
The syntax of some special forms is sufficiently complicated
that it does not fit comfortably into this style; the first line of the
description of such a special form contains only the name, and the syntax is
given by example in the body of the description.
</p>
<p>The semantics of a special form includes not only what it &quot;does for a living&quot;,
but also which subforms are evaluated and what the returned value is.  Usually
this will be clarified with one or more examples.
</p>
<p>A convention used by many special forms is that all of their subforms after
the first few are described as &quot;<em>body</em><code>...</code>&quot;.  This means that the remaining
subforms constitute the &quot;body&quot; of this special form; they are Lisp forms which
are evaluated one after another in some environment established by the special
form.
</p>
<p>This ridiculous special form exhibits all of the syntactic features:
</p>
<dl>
<dt><a name="index-twiddle_002dfrob"></a>Special Form: <strong>twiddle-frob</strong> <em>[(frob option...)] parameter value...</em></dt>
<dd><p>This twiddles the parameters of <em>frob</em>, which defaults to <code>default-frob</code>
if not specified.  Each <em>parameter</em> is the name of one of the adjustable parameters of
a frob; each <em>value</em> is what value to set that parameter to.  Any number
of <em>parameter/value</em> pairs may be specified.  If any <em>options</em> are specified,
they are keywords which select which safety checks to override while twiddling
the parameters.  If neither <em>frob</em> nor any <em>options</em> are specified, the
list of them may be omitted and the form may begin directly with the first
<em>parameter</em> name.
</p>
<p><em>frob</em> and the <em>values</em> are evaluated; the <em>parameters</em> and <em>options</em>
are syntactic keywords and not evaluated.  The returned value is the frob
whose parameters were adjusted.  An error is signalled if any safety checks
are violated.
</p></dd></dl>

<p>Operations, the message-passing equivalent of ordinary Lisp&rsquo;s functions,
are described in this style:
</p>
<dl>
<dt><a name="index-_003aoperation_002dname-on-flavor_002dname"></a>Method on flavor-name: <strong>:operation-name</strong> <em>arg1 arg2 &amp;optional arg3</em></dt>
<dd><p>This is the documentation of the effect of performing operation
<code>:operation-name</code> (or, sending a message named <code>:operation-name</code>),
with arguments <em>arg1</em>, <em>arg2</em>, and <em>arg3</em>, on an instance of
flavor <code>flavor-name</code>.
</p></dd></dl>

<p>Descriptions of variables (&quot;special&quot; or &quot;global&quot; variables) look like this:
</p>
<dl>
<dt><a name="index-typical_002dvariable"></a>Variable: <strong>typical-variable</strong></dt>
<dd><p>The variable <code>typical-variable</code> has a typical value....
</p></dd></dl>

<p>Most numbers shown are in octal radix (base eight).  Spelled out
numbers and numbers followed by a decimal point are in decimal.  This is
because, by default, Zetalisp types out numbers in base 8; don&rsquo;t
be surprised by this.  If you wish to change it, see the documentation on the variables
<code>ibase</code> and <code>base</code> (<a href="#ibase_002dvar">ibase-var</a>).
</p>
<p>All uses of the phrase &quot;Lisp reader&quot;, unless further qualified,
refer to the part of Lisp which reads characters from I/O streams
(the <code>read</code> function), and not the person reading this manual.
</p>
<p>There are several terms which are used widely in other
references on Lisp, but are not used much in this document since they have become
largely obsolete and misleading.  For the benefit of those who may
have seen them before, they are: &quot;s-expression&quot;, which means a Lisp
object;  &quot;dotted pair&quot;, which means a cons; and &quot;atom&quot;, which means,
roughly, symbols and numbers and sometimes other things, but not
conses.   The terms &quot;list&quot; and &quot;tree&quot; are defined in <a href="#list_002dand_002dtree">list-and-tree</a>.
<a name="index-_0022S_002dexpression_0022"></a>
<a name="index-_0022dotted-pair_0022"></a>
<a name="index-_0022atom_0022"></a>
</p>
<p>The characters acute accent (<code>'</code>) (also called &quot;single quote&quot;) and
semicolon (<code>;</code>) have special meanings when typed to Lisp; they are
examples of what are called <em>macro characters</em>.  Though the
mechanism of macro characters is not of immediate interest to the new
user, it is important to understand the effect of these two, which are
used in the examples.
	When the Lisp reader encounters a &quot;<code>'</code>&quot;, it reads in the next
Lisp object and encloses it in a <code>quote</code> special form.  That
is, <code>'foo-symbol</code> turns into <code>(quote foo-symbol)</code>, and <code>'(cons 'a 'b)</code>
turns into <code>(quote (cons (quote a) (quote b)))</code>.  The reason
for this is that &quot;<code>quote</code>&quot; would otherwise have to be typed in very
frequently, and would look ugly.
	The semicolon is used as a commenting character.  When the
Lisp reader sees one, the remainder of the line is
discarded.
	The character &quot;<code>/</code>&quot; is used for quoting strange characters so
that they are not interpreted in their usual way by the Lisp reader,
but rather are treated the way normal alphabetic characters are treated.
So, for example, in order to give a &quot;<code>/</code>&quot; to the reader, you must type &quot;<code>//</code>&quot;,
the first &quot;<code>/</code>&quot; quoting the second one.  When a character
is preceded by a &quot;<code>/</code>&quot; it is said to be <em>slashified</em>.  Slashifying
also turns off the effects of macro characters such as &quot;<code>'</code>&quot; and &quot;<code>;</code>&quot;.
	The following characters also have special meanings
and may not be used in symbols without slashification.  These characters
are explained in detail in the section on printed representation
(<a href="#reader">reader</a>).
</p><dl compact="compact">
<dt><code>&quot;</code></dt>
<dd><p>Double-quote delimits character strings.
</p></dd>
<dt><code>#</code></dt>
<dd><p>Number-sign introduces miscellaneous reader macros.
</p></dd>
<dt><code>`</code></dt>
<dd><p>Backquote is used to construct list structure.
</p></dd>
<dt><code>,</code></dt>
<dd><p>Comma is used in conjunction with backquote.
</p></dd>
<dt><code>:</code></dt>
<dd><p>Colon is the package prefix.
</p></dd>
<dt><code>|</code></dt>
<dd><p>Characters between pairs of vertical-bars are quoted.
</p></dd>
<dt><code>circleX</code></dt>
<dd><p>Circle-cross lets you type in characters using their octal codes.
</p></dd>
</dl>

<p>All Lisp code in this manual is written in lower case.
In fact, the reader turns all symbols into upper-case, and consequently
everything prints out in upper case.  You may write programs in whichever
case you prefer.
</p>
<p>You will see various symbols that have the colon (<code>:</code>)
character in their names.  By convention, all &quot;keyword&quot; symbols in the
Lisp Machine system have names starting with a colon.  The colon
character is not actually part of the print name, but is a package
prefix indicating that the symbol belongs to the package with a null
name, which means the <code>user</code> package.  So, when you print such a
symbol, you won&rsquo;t see the colon if the current package is <code>user</code>.
However, you should always type in the colons where the manual tells you
to.  This is all explained in chapter <a href="#package_002dchapter">package-chapter</a>; until you read
that, just make believe that the colons are part of the names of the
symbols, and don&rsquo;t worry that they sometimes don&rsquo;t get printed out for keyword
symbols.
</p>
<p>This manual documents a number of internal functions and variables,
which can be identified by the &quot;<code>si:</code>&quot; prefix in their names.  The &quot;si&quot;
stands for &quot;system internals&quot;.  These functions and variables are documented
here because they are things you sometimes need to know about.  However,
they are considered internal to the system and their behavior is not as
guaranteed as that of everything else.  They may be changed in the future.
</p>
<p>Zetalisp is descended from Maclisp, and a good deal
of effort was expended to try to allow Maclisp programs to run
in Zetalisp.  Throughout the manual, there are notes about
differences between the dialects.  For the new user, it is important
to note that many functions herein exist solely for Maclisp compatibility;
they should <em>not</em> be used in new programs.  Such functions are
clearly marked in the text.
</p>
<p>The Lisp Machine character set is not quite the same as that used
on I.T.S nor on Multics; it is described in full detail elsewhere
in the manual.  The important thing to note for now is that the
character &quot;newline&quot; is the same as <code>Return</code>, and is represented by
the number 215 octal.  (This number should <em>not</em> be built into any programs.)
</p>
<p>When the text speaks of &quot;typing <code>Control-Q</code>&quot; (for example),
this means to hold down the <code>Control</code> key on the keyboard (either of
the two keys labeled &quot;CTRL&quot;), and, while holding it down, to strike the
<code>Q</code> key.  Similarly, to type <code>Meta-P</code>, hold down either of the
<code>Meta</code> keys and strike <code>P</code>.  To type <code>Control-Meta-T</code> hold down
both <code>Control</code> and <code>Meta</code>.  Unlike ASCII, the Lisp machine character
set has no &quot;control characters&quot;; <code>Control</code> and <code>Meta</code> (and <code>Super</code>
and <code>Hyper</code>) are modifiers that can be added to a character of
keyboard input.  These modifier bits are not present in characters in
strings or files.
</p>
<p>Many of the functions refer to &quot;areas&quot;.  The <em>area</em> feature
is only of interest to writers of large systems and can be safely
disregarded by the casual user.  It is described in chapter <a href="#area_002dchapter">area-chapter</a>.
</p>
<a name="Primitive-Object-Types"></a>
<h2 class="chapter">2 Primitive Object Types</h2>
<a name="predicate_002dchapter"></a><a name="object_002dchapter"></a>
<a name="g_t_0022Data-Types_0022"></a>
<h3 class="section">2.1 &quot;Data Types&quot;</h3>

<p>This section enumerates some of the various different primitive types of
objects in Zetalisp.  The types explained below include
symbols, conses, various types of numbers, two kinds of compiled code
objects, locatives, arrays, stack groups, and closures.  With each is
given the associated symbolic name, which is returned by the function
<code>data-type</code> (<a href="#data_002dtype_002dfun">data-type-fun</a>).
<a name="index-_0022symbol_0022"></a>
<a name="index-_0022print-name_0022"></a>
<a name="index-_0022binding_0022"></a>
<a name="index-_0022definition_0022"></a>
<a name="index-_0022property-list_0022"></a>
</p>
<p>A <em>symbol</em> (these are sometimes called &quot;atoms&quot; or &quot;atomic
symbols&quot; by other texts) has a <em>print name</em>, a <em>binding</em>, a
<em>definition</em>, a <em>property list</em>, and a <em>package</em>.
</p>
<p>The print name is a string, which may be obtained by the
function <code>get-pname</code> (<a href="#get_002dpname_002dfun">get-pname-fun</a>).  This string serves as the
<em>printed representation</em> (see <a href="#printer">printer</a>) of the symbol.  Each symbol
has a <em>binding</em> (sometimes also called the &quot;value&quot;), which may be any
Lisp object.  It is also referred to sometimes as the &quot;contents of the
value cell&quot;, since internally every symbol has a cell called the <em>value
cell</em> which holds the binding.  It is accessed by the <code>symeval</code>
function (<a href="#symeval_002dfun">symeval-fun</a>), and updated by the <code>set</code> function
(<a href="#set_002dfun">set-fun</a>).  (That is, given a symbol, you use <code>symeval</code> to find out
what its binding is, and use <code>set</code> to change its binding.)  Each
symbol has a <em>definition</em>, which may also be any Lisp object.  It is
also referred to as the &quot;contents of the function cell&quot;, since
internally every symbol has a cell called the <em>function cell</em> which
holds the definition.  The definition can be accessed by the
<code>fsymeval</code> function (<a href="#fsymeval_002dfun">fsymeval-fun</a>), and updated with <code>fset</code>
(<a href="#fset_002dfun">fset-fun</a>), although usually the functions <code>fdefinition</code> and
<code>fdefine</code> are employed (<a href="#fdefine_002dfun">fdefine-fun</a>).
The property list is a list of an even number of
elements; it can be accessed directly by <code>plist</code> (<a href="#plist_002dfun">plist-fun</a>), and
updated directly by <code>setplist</code> (<a href="#setplist_002dfun">setplist-fun</a>), although usually the
functions <code>get</code>, <code>putprop</code>, and <code>remprop</code> (<a href="#get_002dfun">get-fun</a>) are used.
The property list is used to associate any number of additional
attributes with a symbol&ndash;attributes not used frequently enough to
deserve their own cells as the value and definition do.  Symbols also have a
package cell, which indicates which &quot;package&quot; of names the symbol
belongs to.  This is explained further in the section on packages
(chapter <a href="#package_002dchapter">package-chapter</a>) and can be disregarded by the casual user.
</p>
<p>The primitive function for creating symbols is
<code>make-symbol</code> (<a href="#make_002dsymbol_002dfun">make-symbol-fun</a>), although most symbols
are created by <code>read</code>, <code>intern</code>, or
<code>fasload</code> (which call <code>make-symbol</code> themselves.)
</p>
<p>A <em>cons</em> is an object that cares about two
other objects, arbitrarily named the <em>car</em> and the <em>cdr</em>.
These objects can be accessed with <code>car</code> and <code>cdr</code> (<a href="#car_002dfun">car-fun</a>), and updated
with <code>rplaca</code> and <code>rplacd</code> (<a href="#rplaca_002dfun">rplaca-fun</a>).  The primitive function for creating
conses is <code>cons</code> (<a href="#cons_002dfun">cons-fun</a>).
</p>
<p>There are several kinds of numbers in Zetalisp.  <em>Fixnums</em>
represent integers in the range of -2^23 to 2^23-1.  <em>Bignums</em> represent
integers of arbitrary size, but they are more expensive to use than fixnums
because they occupy storage and are slower.  The system automatically
converts between fixnums and bignums as required.  <em>Flonums</em> are
floating-point numbers.  <em>Small-flonums</em> are another kind of
floating-point numbers, with less range and precision, but less
computational overhead.  <em>Rationalnums</em> are exact rational numbers which
are represented with a numerator and a denominator which are integers.
<em>Complexnums</em> are numbers which have explicitly represented real and
imaginary parts, which can be any real numbers.  See <a href="#number">number</a> for full
details of these types and the conversions between them.
</p>
<a name="index-_0022FEF_0022"></a>
<p>The usual form of compiled, executable code is a Lisp object
called a &quot;Function Entry Frame&quot; or &quot;FEF&quot;.  A FEF contains the code
for one function.  This is analogous to what Maclisp calls a &quot;subr pointer&quot;.
FEFs are produced by the Lisp Compiler (<a href="#compiler">compiler</a>), and are usually found
as the definitions of symbols.  The printed representation of a FEF
includes its name so that it can be identified.
	Another Lisp object which represents executable code is
a &quot;microcode entry&quot;.
These are the microcoded primitive functions of the Lisp system,
and any user functions compiled into microcode.
</p>
<p>About the only useful thing to do with any of these compiled code objects
is to <em>apply</em> it to arguments.  However, some functions are
provided for examining such objects, for user convenience.  See
<code>arglist</code> (<a href="#arglist_002dfun">arglist-fun</a>),
<code>args-info</code> (<a href="#args_002dinfo_002dfun">args-info-fun</a>),
<code>describe</code> (<a href="#describe_002dfun">describe-fun</a>),
and <code>disassemble</code> (<a href="#disassemble_002dfun">disassemble-fun</a>).
</p>
<p>A <em>locative</em> (see <a href="#locative">locative</a>) is a kind of a pointer to a single memory cell
anywhere in the system.  The contents of this cell can be accessed by <code>cdr</code>
(see <a href="#cdr_002dfun">cdr-fun</a>) and updated by <code>rplacd</code> (see <a href="#rplacd_002dfun">rplacd-fun</a>).
</p>
<p>An <em>array</em> (see <a href="#array">array</a>)
is a set of cells indexed by a tuple of integer subscripts.
The contents of the cells may be accessed and changed individually.  There are several
types of arrays.  Some have cells which may contain any object, while others (numeric
arrays) may only contain small positive numbers.  Strings are a type of array;
the elements are 8-bit unsigned numbers which encode characters.
</p>
<p>A <em>list</em> is not a primitive data type, but rather a data structure
made up out of conses and the symbol <code>nil</code>.  See <a href="#list_002dand_002dtree">list-and-tree</a>.
</p>
<a name="Predicates"></a>
<h3 class="section">2.2 Predicates</h3>
<a name="index-_0022predicate_0022"></a>
<p>A <em>predicate</em> is a function which tests for some condition involving
its arguments and returns the symbol <code>t</code> if the condition is true, or
the symbol <code>nil</code> if it is not true.  Most of the following predicates are for
testing what data type an object has; some other general-purpose predicates
are also explained.
</p>
<p>By convention, the names of predicates usually end in the letter &quot;p&quot; (which
stands for &quot;predicate&quot;).
<a name="index-_0022naming-convention_0022"></a>
</p>
<p>The following predicates are for testing data types.  These predicates
return <code>t</code> if the argument is of the type indicated by the name of the function,
<code>nil</code> if it is of some other type.
<a name="index-_0022data-type_0022"></a>
</p>
<a name="symbolp_002dfun"></a><dl>
<dt><a name="index-symbolp"></a>Function: <strong>symbolp</strong> <em>arg</em></dt>
<dd><a name="index-_0022symbol_0022-1"></a>
<p><code>symbolp</code> returns <code>t</code> if its argument is a symbol, otherwise <code>nil</code>.
</p></dd></dl>

<a name="nsymbolp_002dfun"></a><dl>
<dt><a name="index-nsymbolp"></a>Function: <strong>nsymbolp</strong> <em>arg</em></dt>
<dd><p><code>nsymbolp</code> returns <code>nil</code> if its argument is a symbol, otherwise <code>t</code>.
</p></dd></dl>

<a name="listp_002dfun"></a><dl>
<dt><a name="index-listp"></a>Function: <strong>listp</strong> <em>arg</em></dt>
<dd><a name="index-_0022cons_0022"></a>
<p><code>listp</code> returns <code>t</code> if its argument is a cons, otherwise <code>nil</code>.
Note that this means <code>(listp nil)</code> is <code>nil</code> even though <code>nil</code> is the empty list.
[This may be changed in the future.]
</p></dd></dl>

<a name="nlistp_002dfun"></a><dl>
<dt><a name="index-nlistp"></a>Function: <strong>nlistp</strong> <em>arg</em></dt>
<dd><p><code>nlistp</code> returns <code>t</code> if its argument is anything besides a cons,
otherwise <code>nil</code>.
<code>nlistp</code> is identical to <code>atom</code>, and so <code>(nlistp nil)</code>
returns <code>t</code>.
[This may be changed in the future, if and when <code>listp</code> is changed.]
</p></dd></dl>

<a name="atom_002dfun"></a><dl>
<dt><a name="index-atom"></a>Function: <strong>atom</strong> <em>arg</em></dt>
<dd><a name="index-_0022atom_0022-1"></a>
<p>The predicate <code>atom</code> returns <code>t</code> if its argument is not a cons,
otherwise <code>nil</code>.
</p></dd></dl>

<a name="consp_002dfun"></a><dl>
<dt><a name="index-consp"></a>Function: <strong>consp</strong> <em>arg</em></dt>
<dd><p>This returns <code>t</code> if <em>arg</em> is a cons, otherwise <code>nil</code>.  At the
moment, this is the same as <code>listp</code>; but while <code>listp</code> may be
changed, <code>consp</code> will <em>never</em> be true of <code>nil</code>.
</p></dd></dl>

<a name="numberp_002dfun"></a><dl>
<dt><a name="index-numberp"></a>Function: <strong>numberp</strong> <em>arg</em></dt>
<dd><a name="index-_0022number_0022"></a>
<p><code>numberp</code> returns <code>t</code> if its argument is any kind of number,
otherwise <code>nil</code>.
</p></dd></dl>

<a name="fixp_002dfun"></a><dl>
<dt><a name="index-fixp"></a>Function: <strong>fixp</strong> <em>arg</em></dt>
<dd><a name="integerp_002dfun"></a></dd><dt><a name="index-integerp"></a>Function: <strong>integerp</strong> <em>arg</em></dt>
<dd><p>This returns <code>t</code> if its argument is a representation of an integer, i.e a
fixnum or a bignum, otherwise <code>nil</code>.
</p></dd></dl>

<a name="floatp_002dfun"></a><dl>
<dt><a name="index-floatp"></a>Function: <strong>floatp</strong> <em>arg</em></dt>
<dd><p><code>floatp</code> returns <code>t</code> if its argument is a floating-point number,
i.e a flonum or a small flonum, otherwise <code>nil</code>.
</p></dd></dl>

<a name="fixnump_002dfun"></a><dl>
<dt><a name="index-fixnump"></a>Function: <strong>fixnump</strong> <em>arg</em></dt>
<dd><p><code>fixnump</code> returns <code>t</code> if its argument is a fixnum, otherwise <code>nil</code>.
</p></dd></dl>

<a name="bigp_002dfun"></a><dl>
<dt><a name="index-bigp"></a>Function: <strong>bigp</strong> <em>arg</em></dt>
<dd><p><code>bigp</code> returns <code>t</code> if <em>arg</em> is a bignum, otherwise <code>nil</code>.
</p></dd></dl>

<a name="flonump_002dfun"></a><dl>
<dt><a name="index-flonump"></a>Function: <strong>flonump</strong> <em>arg</em></dt>
<dd><p><code>flonump</code> returns <code>t</code> if <em>arg</em> is a (large) flonum, otherwise <code>nil</code>.
</p></dd></dl>

<a name="small_002dfloatp_002dfun"></a><dl>
<dt><a name="index-small_002dfloatp"></a>Function: <strong>small-floatp</strong> <em>arg</em></dt>
<dd><p><code>small-floatp</code> returns <code>t</code> if <em>arg</em> is a small flonum, otherwise <code>nil</code>.
</p></dd></dl>

<a name="rationalp_002dfun"></a><dl>
<dt><a name="index-rationalp"></a>Function: <strong>rationalp</strong> <em>arg</em></dt>
<dd><p>Returns <code>t</code> if <em>arg</em> is an exact representation of a rational number;
that is, if it is a fixnum, a bignum or a rationalnum.  Otherwise it returns <code>nil</code>.
</p></dd></dl>

<a name="complexp_002dfun"></a><dl>
<dt><a name="index-complexp"></a>Function: <strong>complexp</strong> <em>arg</em></dt>
<dd><p>Returns <code>t</code> if <em>arg</em> is a complexnum, a number which is explicitly
represented as complex.  Otherwise it returns <code>nil</code>.
</p>
<p>Since the system will not in normal operation produce complexnums have a
zero imaginary part, you can use this as a test for a number which is
mathematically not a real number.
</p></dd></dl>

<a name="realp_002dfun"></a><dl>
<dt><a name="index-realp"></a>Function: <strong>realp</strong> <em>arg</em></dt>
<dd><p>Returns <code>t</code> if <em>arg</em> is a number whose imaginary part is zero.
Any fixnum, bignum, flonum (of any size) or rationalnum satisfies this predicate.
Otherwise it returns <code>nil</code>.
</p>
<p>Since a complexnum never normally has a zero imaginary part, you can use
this as a test for numbers that are mathematically real.
</p></dd></dl>

<a name="stringp_002dfun"></a><dl>
<dt><a name="index-stringp"></a>Function: <strong>stringp</strong> <em>arg</em></dt>
<dd><a name="index-_0022string_0022"></a>
<p><code>stringp</code> returns <code>t</code> if its argument is a string, otherwise <code>nil</code>.
</p></dd></dl>

<a name="arrayp_002dfun"></a><dl>
<dt><a name="index-arrayp"></a>Function: <strong>arrayp</strong> <em>arg</em></dt>
<dd><a name="index-_0022array_0022"></a>
<p><code>arrayp</code> returns <code>t</code> if its argument is an array, otherwise <code>nil</code>.
Note that strings are arrays.
</p></dd></dl>

<a name="functionp_002dfun"></a><dl>
<dt><a name="index-functionp"></a>Function: <strong>functionp</strong> <em>arg &amp;optional allow-special-forms</em></dt>
<dd><a name="index-_0022function_0022"></a>
<a name="index-_0022applicable-function_0022"></a>
<p><code>functionp</code> returns <code>t</code> if its argument is a function (essentially, something
that is acceptable as the first argument to <code>apply</code>), otherwise it returns <code>nil</code>.
In addition to interpreted, compiled, and microcoded functions, <code>functionp</code>
is true of closures, select-methods (see <a href="#select_002dmethod">select-method</a>), and symbols whose function
definition is <code>functionp</code>.  <code>functionp</code> is not true of objects which can be called
as functions but are not normally thought of as functions: arrays, stack groups, entities,
and instances.  If <em>allow-special-forms</em> is specified and non-<code>nil</code>, then <code>functionp</code>
will be true of macros and special-form functions (those with quoted arguments).  Normally
<code>functionp</code> returns <code>nil</code> for these since they do not behave like functions.
As a special case, <code>functionp</code> of a symbol whose function definition is an array
returns <code>t</code>, because in this case the array is being used as a function rather than
as an object.
</p></dd></dl>

<a name="subrp_002dfun"></a><dl>
<dt><a name="index-subrp"></a>Function: <strong>subrp</strong> <em>arg</em></dt>
<dd><p><code>subrp</code> returns <code>t</code> if its argument is any compiled code object,
otherwise <code>nil</code>.  The Lisp Machine system doesn&rsquo;t use the term &quot;subr&quot;,
but the name of this function comes from Maclisp.
</p></dd></dl>

<a name="closurep_002dfun"></a><dl>
<dt><a name="index-closurep"></a>Function: <strong>closurep</strong> <em>arg</em></dt>
<dd><a name="index-_0022closure_0022"></a>
<p><code>closurep</code> returns <code>t</code> if its argument is a closure, otherwise <code>nil</code>.
</p></dd></dl>

<a name="entityp_002dfun"></a><dl>
<dt><a name="index-entityp"></a>Function: <strong>entityp</strong> <em>arg</em></dt>
<dd><a name="index-_0022entity_0022"></a>
<p><code>entityp</code> returns <code>t</code> if its argument is an entity, otherwise <code>nil</code>.
See <a href="#entity">entity</a> for information about entities.
</p></dd></dl>

<a name="locativep_002dfun"></a><dl>
<dt><a name="index-locativep"></a>Function: <strong>locativep</strong> <em>arg</em></dt>
<dd><a name="index-_0022locative_0022"></a>
<p><code>locativep</code> returns <code>t</code> if its argument is a locative, otherwise <code>nil</code>.
</p></dd></dl>

<a name="typep_002dfun"></a><dl>
<dt><a name="index-typep"></a>Function: <strong>typep</strong> <em>arg &amp;optional type</em></dt>
<dd><p><code>typep</code> is really two different functions.  With one argument,
<code>typep</code> is not really a predicate; it returns a symbol describing the
type of its argument.  With two arguments, <code>typep</code> is a predicate which
returns <code>t</code> if <em>arg</em> is of type <em>type</em>, and <code>nil</code> otherwise.
Note that an object can be &quot;of&quot; more than one type, since one type can
be a subset of another.
</p>
<p>The symbols that can be returned by <code>typep</code> of one argument are:
</p><dl compact="compact">
<dt><code>:symbol</code></dt>
<dd><p><em>arg</em> is a symbol.
</p></dd>
<dt><code>:fixnum</code></dt>
<dd><p><em>arg</em> is a fixnum (not a bignum).
</p></dd>
<dt><code>:bignum</code></dt>
<dd><p><em>arg</em> is a bignum.
</p></dd>
<dt><code>:flonum</code></dt>
<dd><p><em>arg</em> is a flonum (not a small-flonum).
</p></dd>
<dt><code>:small-flonum</code></dt>
<dd><p><em>arg</em> is a small flonum.
</p></dd>
<dt><code>:rational</code></dt>
<dd><p><em>arg</em> is a rationalnum.
</p></dd>
<dt><code>:complex</code></dt>
<dd><p><em>arg</em> is a complexnum.
</p></dd>
<dt><code>:list</code></dt>
<dd><p><em>arg</em> is a cons.
</p></dd>
<dt><code>:locative</code></dt>
<dd><p><em>arg</em> is a locative pointer (see <a href="#locative">locative</a>).
</p></dd>
<dt><code>:compiled-function</code></dt>
<dd><p><em>arg</em> is the machine code for a compiled function (sometimes called a FEF).
</p></dd>
<dt><code>:microcode-function</code></dt>
<dd><p><em>arg</em> is a function written in microcode.
</p></dd>
<dt><code>:closure</code></dt>
<dd><p><em>arg</em> is a closure (see <a href="#closure">closure</a>).
</p></dd>
<dt><code>:select-method</code></dt>
<dd><p><em>arg</em> is a select-method table (see <a href="#select_002dmethod">select-method</a>).
</p></dd>
<dt><code>:stack-group</code></dt>
<dd><p><em>arg</em> is a stack-group (see <a href="#stack_002dgroup">stack-group</a>).
</p></dd>
<dt><code>:string</code></dt>
<dd><p><em>arg</em> is a string.
</p></dd>
<dt><code>:array</code></dt>
<dd><p><em>arg</em> is an array that is not a string.
</p></dd>
<dt><code>:random</code></dt>
<dd><p>Returned for any built-in data type that does not fit into one of the above categories.
</p></dd>
<dt><code><em>foo</em></code></dt>
<dd><p>An object of user-defined data type <em>foo</em> (any symbol).  The primitive type
of the object could be array, instance, or entity.
See Named Structures, <a href="#named_002dstructure">named-structure</a>, Flavors, <a href="#flavor">flavor</a>, and Entities
<a href="#entity">entity</a>.
</p></dd>
</dl>

<p>The <em>type</em> argument to <code>typep</code> of two arguments can be any of the above
keyword symbols (except for <code>:random</code>), the name of a user-defined data type
(either a named structure or a flavor), or one of the following additional
symbols:
</p><dl compact="compact">
<dt><code>:atom</code></dt>
<dd><p>Any atom (as determined by the <code>atom</code> predicate).
</p></dd>
<dt><code>:integer</code></dt>
<dd><p>Any kind of fixed-point number (fixnum or bignum).
</p></dd>
<dt><code>:fix</code></dt>
<dd><p>The same as <code>:integer</code>.
</p></dd>
<dt><code>:rational</code></dt>
<dd><p>When <code>:rational</code> is used as the second argument to <code>typep</code>, integers
are considered rational, even though <code>typep</code> of a single integer argument will return
<code>:fixnum</code> or <code>:bignum</code> rather than <code>:rational</code>.
</p></dd>
<dt><code>:float</code></dt>
<dd><p>Any kind of floating-point number (flonum or small-flonum).
</p></dd>
<dt><code>:real</code></dt>
<dd><p><em>arg</em> is a number but not a complexnum.
</p></dd>
<dt><code>:number</code></dt>
<dd><p>Any kind of number.
</p></dd>
<dt><code>:named-structure</code></dt>
<dd><p><em>arg</em> is a named structure.  <code>typep</code> of one argument returns
the named structure type symbol.
</p></dd>
<dt><code>:instance</code></dt>
<dd><p>An instance of any flavor.  See <a href="#flavor">flavor</a>.
</p></dd>
<dt><code>:entity</code></dt>
<dd><p>An entity.  <code>typep</code> of one argument returns the name of the particular
user-defined type of the entity, rather than <code>:entity</code>.
</p></dd>
</dl>

<p>See also <code>data-type</code>, <a href="#data_002dtype_002dfun">data-type-fun</a>.
</p>
<p>Note that <code>(typep nil) =&gt; :symbol</code>, and <code>(typep nil ':list) =&gt; nil</code>; the
latter may be changed.
</p></dd></dl>



<p>The following functions are some other general purpose predicates.
</p>
<a name="eq_002dfun"></a><dl>
<dt><a name="index-eq"></a>Function: <strong>eq</strong> <em>x y</em></dt>
<dd><p><code>(eq <em>x y</em>) =&gt; t</code> if and only if <em>x</em> and <em>y</em> are the same object.
It should be noted that things that print the same are not necessarily <code>eq</code> to each other.
In particular, numbers with the same value
need not be <code>eq</code>, and two similar lists are usually not <code>eq</code>.
<a name="index-_0022eq-versus-equal_0022"></a>
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(eq 'a 'b) =&gt; nil
(eq 'a 'a) =&gt; t
(eq (cons 'a 'b) (cons 'a 'b)) =&gt; nil
(setq x (cons 'a 'b)) (eq x x) =&gt; t
</pre></div>
<p>Note that in Zetalisp equal fixnums are <code>eq</code>; this is not true in Maclisp.
Equality does not imply <code>eq</code>-ness for other types of numbers.  To compare numbers,
use <code>=</code>; see <a href="#g_t_003d_002dfun">=-fun</a>.
</p></dd></dl>

<a name="neq_002dfun"></a><dl>
<dt><a name="index-neq"></a>Function: <strong>neq</strong> <em>x y</em></dt>
<dd><p><code>(neq <em>x y</em>)</code> = <code>(not (eq <em>x y</em>))</code>.  This is provided
simply as an abbreviation for typing convenience.
</p></dd></dl>

<a name="eql_002dfun"></a><dl>
<dt><a name="index-eql"></a>Function: <strong>eql</strong> <em>x y</em></dt>
<dd><p><code>eql</code> is the same as <code>eq</code> unless both arguments are numbers;
in that case, it is the same as <code>=</code>.
</p></dd></dl>

<a name="equal_002dfun"></a><dl>
<dt><a name="index-equal"></a>Function: <strong>equal</strong> <em>x y</em></dt>
<dd><p>The <code>equal</code> predicate returns <code>t</code> if its arguments are similar
(isomorphic) objects. (cf <code>eq</code>)
<a name="index-_0022eq-versus-equal_0022-1"></a>
<a name="index-_0022equal-versus-_003d_0022"></a>
Two numbers are <code>equal</code> if they have the same value and type (for
example, a flonum is never <code>equal</code> to a fixnum, even if <code>=</code> is true of them).
For conses, <code>equal</code> is defined
recursively as the two cars being <code>equal</code> and the two cdrs
being equal.  Two strings are <code>equal</code> if they have the same length,
and the characters composing them are the same; see <code>string-equal</code>,
<a href="#string_002dequal_002dfun">string-equal-fun</a>.  Alphabetic case is ignored (but see
<code>alphabetic-case-affects-string-comparison</code>,
<a href="#alphabetic_002dcase_002daffects_002dstring_002dcomparison_002dvar">alphabetic-case-affects-string-comparison-var</a>).  All other objects
are <code>equal</code> if and only if they are <code>eq</code>.  Thus <code>equal</code> could have
been defined by:
</p><div class="lisp">
<pre class="lisp">(defun equal (x y)
  (cond ((eq x y) t)
	((neq (typep x) (typep y)) nil)
	((numberp x) (= x y))
	((stringp x) (string-equal x y))
	((listp x) (and (equal (car x) (car y))
			(equal (cdr x) (cdr y))))))
</pre></div>

<p>As a consequence of the above definition, it can be seen that
<code>equal</code> may compute forever when applied to looped list structure. 
In addition, <code>eq</code> always implies <code>equal</code>; that is, if <code>(eq a b)</code>
then <code>(equal a b)</code>.  An intuitive definition of <code>equal</code> (which is
not quite correct) is that two objects are <code>equal</code> if they look the
same when printed out.  For example:
</p><div class="lisp">
<pre class="lisp">(setq a '(1 2 3))
(setq b '(1 2 3))
(eq a b) =&gt; nil
(equal a b) =&gt; t
(equal &quot;Foo&quot; &quot;foo&quot;) =&gt; t
</pre></div>
</dd></dl>

<a name="not_002dfun"></a><dl>
<dt><a name="index-not"></a>Function: <strong>not</strong> <em>x</em></dt>
<dd><a name="null_002dfun"></a></dd><dt><a name="index-null"></a>Function: <strong>null</strong> <em>x</em></dt>
<dd><p><code>not</code> returns <code>t</code> if <em>x</em> is <code>nil</code>, else <code>nil</code>.
<code>null</code> is the same as <code>not</code>; both functions are included for the sake
of clarity.  Use <code>null</code> to check whether something is <code>nil</code>; use <code>not</code>
to invert the sense of a logical value.  Even though Lisp uses the symbol
<code>nil</code> to represent falseness, you shouldn&rsquo;t make understanding of your program
depend on this fortuitously.  For example, one often writes:
</p><div class="lisp">
<pre class="lisp">(cond ((not (null lst)) ... )
      ( ... ))
<span class="roman">rather than</span>
(cond (lst ... )
      ( ... ))
</pre></div>
<p>There is no loss of efficiency, since these will compile into exactly
the same instructions.
</p></dd></dl>
<a name="g_t_0022Evaluation_0022"></a>
<h2 class="chapter">3 &quot;Evaluation&quot;</h2>
<a name="evaluator_002dchapter"></a><a name="index-_0022evaluation_0022"></a>
<a name="description_002dof_002devaluation"></a>

<p>The following is a complete description of the actions taken by the
evaluator, given a <em>form</em> to evaluate.
</p>
<p>If <em>form</em> is a number, the result is <em>form</em>.
</p>
<p>If <em>form</em> is a string, the result is <em>form</em>.
</p>
<p>If <em>form</em> is a symbol, the result is the value of <em>form</em>,
considered as a variable.  If <em>form</em> is unbound, an error is
signalled.  The way symbols are bound to values is explained in
<a href="#variable_002dsection">variable-section</a> below.
</p>
<p>If <em>form</em> is not any of the above types, and is not a list,
an error is signalled.
</p>
<p>In all remaining cases, <em>form</em> is a list.  The evaluator
examines the car of the list to figure out what to do next.  There
are three possibilities: this form may be a <em>special form</em>, a <em>macro
form</em>, or a plain old <em>function form</em>.  Conceptually, the evaluator
knows specially about all the symbols whose appearance in the car of a
form make that form a special form, but the way the evaluator actually
works is as follows.  If the car of the form is a symbol, the evaluator
finds the object in the function cell of the symbol (see <a href="#symbol">symbol</a>) and
starts all over as if that object had been the car of the list.  If the
car isn&rsquo;t a symbol, then if it&rsquo;s a cons whose car is the symbol
<code>macro</code>, then this is a macro form; if it is a &quot;special function&quot; (see
<a href="#special_002dfunction">special-function</a>) then this is a special form; otherwise, it should
be a regular function, and this is a function form.
</p>
<p>If <em>form</em> is a special form, then it is handled accordingly;
each special form works differently.  All of them are documented in this
manual.  The internal workings of special forms are explained in more
detail on <a href="#special_002dfunction">special-function</a>, but this hardly ever affects you.
</p>
<p>If <em>form</em> is a macro form, then the macro is expanded as
explained in chapter <a href="#macros_002dchapter">macros-chapter</a>.
</p>
<p>If <em>form</em> is a function form, it calls for the <em>application</em>
of a function to <em>arguments</em>.  The car of the form is a function
or the name of a function.  The cdr of the form is a list of
subforms.  Each subform is evaluated, sequentially.  The values produced
by evaluating the subforms are called the &quot;arguments&quot; to the function.
The function is then applied to those arguments.  Whatever results the
function <em>returns</em> are the values of the original <em>form</em>.
</p>
<p>There is a lot more to be said about evaluation.  The way variables
work and the ways in which they are manipulated, including the binding of
arguments, is explained in <a href="#variable_002dsection">variable-section</a>.  A basic explanation of
functions is in <a href="#function_002dsection">function-section</a>.  The way functions can return more
than one value is explained in <a href="#multiple_002dvalue">multiple-value</a>.  The description of all
of the kinds of functions, and the means by which they are manipulated, is
in chapter <a href="#function_002dchapter">function-chapter</a>.  Macros are explained in chapter
<a href="#macros_002dchapter">macros-chapter</a>.  The <code>evalhook</code> facility, which lets you do something
arbitrary whenever the evaluator is invoked, is explained in
<a href="#evalhook_002dsection">evalhook-section</a>.  Special forms are described all over the manual; each
special form is in the section on the facility it is part of.
</p>

<a name="Variables"></a>
<h3 class="section">3.1 Variables</h3>
<a name="variable_002dsection"></a>
<p>In Zetalisp, variables are implemented using symbols.  Symbols
are used for many things in the language, such as naming functions,
naming special forms, and being keywords; they are also useful to
programs written in Lisp, as parts of data structures.  But when the
evaluator is given a symbol, it treats it as a variable, using the value
cell to hold the value of the variable.  If you evaluate a symbol, you
get back the contents of the symbol&rsquo;s value cell.
</p>
<p>There are two different ways of changing the value of a variable.  One
is to <em>set</em> the variable.  Setting a variable changes its value to a
new Lisp object, and the previous value of the variable is forgotten.
Setting of variables is usually done with the <code>setq</code> special form.
</p>
<p>The other way to change the value of a variable is with <em>binding</em>
(also called &quot;lambda-binding&quot;).  When a variable is bound, its old value
is first saved away, and then the value of the variable is made to be
the new Lisp object.  When the binding is undone, the saved value is
restored to be the value of the variable.  Bindings are always followed
by unbindings.  The way this is enforced is that binding is only done by
special forms that are defined to bind some variables, then evaluate some
subforms, and then unbind those variables.  So the variables are all
unbound when the form is finished.  This means that the evaluation of
the form doesn&rsquo;t disturb the values of the variables that are bound;
whatever their old value was, before the evaluation of the form, gets
restored when the evaluation of the form is completed.  If such a form
is exited by a non-local exit of any kind, such as <code>*throw</code> (see
<a href="#g_t_002athrow_002dfun">*throw-fun</a>) or <code>return</code> (see <a href="#return_002dfun">return-fun</a>), the bindings are
undone whenever the form is exited.
</p>
<p>The simplest construct for binding variables is the <code>let</code> special
form.  The <code>do</code> and <code>prog</code> special forms can also bind variables, in
the same way <code>let</code> does, but they also control the flow of the program
and so are explained elsewhere (see <a href="#do_002dfun">do-fun</a>).  <code>let*</code> is just a
sequential version of <code>let</code>; the other special forms below are only
used for esoteric purposes.
</p>
<p>Binding is an important part of the process of applying interpreted
functions to arguments.  This is explained in the next section.
</p>
<a name="index-local-variable"></a>
<p>When a Lisp function is compiled, the compiler understands the use of
symbols as variables.  However, the compiled code generated by the
compiler does not actually use symbols to represent variables.  Rather,
the compiler converts the references to variables within the program
into more efficient references, that do not involve symbols at all.  A
variable that has been changed by the compiler so that it is not
implemented as a symbol is called a &quot;local&quot; variable.  When a local
variable is bound, a memory cell is allocated in a hidden, internal
place (the Lisp control stack) and the value of the variable is
stored in this cell.  You cannot use a local variable without first
binding it; you can only use a local variable inside of a special form
that binds that variable.  Local variables do not have any &quot;top level&quot;
value; they do not even exist outside of the form that binds them.
</p>
<a name="index-special-variable"></a>
<p>The variables which are associated with symbols (the kind which
are used by non-compiled programs) are called &quot;special&quot; variables.
</p>
<p>Local variables and special variables do not behave quite the same way,
because &quot;binding&quot; means different things for the two of them.  Binding a
special variable saves the old value away and then uses the value
cell of the symbol to hold the new value, as explained above.  Binding
a local variable, however, does not do anything to the symbol.  In fact,
it creates a new memory cell to hold the value, i.e a new local variable.
</p>
<p>Thus, if you compile a function, it may do different things after it has
been compiled.  Here is an example:
</p>
<div class="lisp">
<pre class="lisp">(setq a 2)	      ;<span class="roman">Set the variable <code>a</code> to the value <code>2</code>.</span>

(defun foo ()	      ;<span class="roman">Define a function named <code>foo</code>.</span>
  (let ((a 5))	      ;<span class="roman">Bind the symbol <code>a</code> to the value <code>5</code>.</span>
    (bar)))	      ;<span class="roman">Call the function <code>bar</code>.</span>

(defun bar ()	      ;<span class="roman">Define a function named <code>bar</code>.</span>
  a)		      ;<span class="roman">It just returns the value of the variable <code>a</code>.</span>

(foo) =&gt; 5	      ;<span class="roman">Calling <code>foo</code> returns <code>5</code>.</span>

(compile 'foo)	      ;<span class="roman">Now compile <code>foo</code>.</span>

(foo) =&gt; 2	      ;<span class="roman">This time, calling <code>foo</code> returns <code>2</code>.</span>
</pre></div>

<p>This is a very bad thing, because the compiler is only supposed to speed
things up, without changing what the function does.  Why did the function
<code>foo</code> do something different when it was compiled?  Because <code>a</code> was
converted from a special variable into a local variable.  After <code>foo</code> was
compiled, it no longer had any effect on the value cell of the symbol <code>a</code>,
and so the symbol retained its old contents, namely <code>2</code>.
</p>
<p>In most uses of variables in Lisp programs, this problem doesn&rsquo;t come
up.  The reason it happened here is because the function <code>bar</code> refers
to the symbol <code>a</code> without first binding <code>a</code> to anything.  A
reference to a variable that you didn&rsquo;t bind yourself is called a <em>free
reference</em>; in this example, <code>bar</code> makes a free reference to <code>a</code>.
</p>
<p>We mentioned above that you can&rsquo;t use a local variable without first
binding it.  Another way to say this is that you can&rsquo;t ever have a free
reference to a local variable.  If you try to do so, the compiler will
complain.  In order for our functions to work, the compiler must be told
<em>not</em> to convert <code>a</code> into a local variable; <code>a</code> must remain a
special variable.  Normally, when a function is compiled, all variables
in it are made to be &quot;local&quot;.  You can stop the compiler from making a
variable local by &quot;declaring&quot; to the compiler that the variable is
&quot;special&quot;.  When the compiler sees references to a variable that has
been declared special, it uses the symbol itself as the variable instead
of making a local variable.
</p>
<p>Variables can be declared by the special forms <code>defvar</code> and
<code>defconst</code> (see below), or by explicit compiler declarations (see
<a href="#special_002dfun">special-fun</a>).  The most common use of special variables is as
&quot;global&quot; variables: variables used by many different functions
throughout a program, that have top-level values.
</p>
<p>Had <code>bar</code> been compiled, the compiler would have seen the free
reference and printed a warning message: <code>Warning: a declared
special.</code>  It would have automatically declared <code>a</code> to be special and
proceeded with the compilation.  It knows that free references mean that
special declarations are needed.  But when a function is compiled that
binds a variable that you want to be treated as a special variable but
that you have not explicitly declared, there is, in general, no way for
the compiler to automatically detect what has happened, and it will
produce incorrect output.  So you must always provide declarations for
all variables that you want to be treated as special variables.
</p>
<p>When you make a variable special with <code>defvar</code> or <code>defconst</code>, or
with a global special declaration, the variable becomes special in all
functions that use it.  You can also declare a variable special in one
function or expression only, using <code>local-declare</code> (see
<a href="#local_002ddeclare_002dfun">local-declare-fun</a>) or a <code>declare</code> at the front of a function (see
<a href="#declare_002dfun">declare-fun</a>).  These techniques are useful when the special variable
is needed only for communication between a handful of functions defined
near each other, or between one function and its internal functions.
</p>
<p>Here are the special forms used for setting variables.
</p>
<a name="setq_002dfun"></a><dl>
<dt><a name="index-setq"></a>Special Form: <strong>setq</strong> <em>variable value...</em></dt>
<dd><p>The <code>setq</code> special form is used to set the value of a variable or of
many variables.  The first <em>value</em> is evaluated, and the first
<em>variable</em> is set to the result.  Then the second <em>value</em> is
evaluated, the second <em>variable</em> is set to the result, and so on for
all the variable/value pairs.  <code>setq</code> returns the last value, i.e
the result of the evaluation of its last subform.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq x (+ 3 2 1) y (cons x nil))
</pre></div>
<p><code>x</code> is set to <code>6</code>, <code>y</code> is set to <code>(6)</code>, and the <code>setq</code> form
returns <code>(6)</code>.  Note that the first variable was set before
the second value form was evaluated, allowing that form to use the new value of <code>x</code>.
</p></dd></dl>

<a name="psetq_002dfun"></a><dl>
<dt><a name="index-psetq"></a>Special Form: <strong>psetq</strong> <em>variable value...</em></dt>
<dd><p>A <code>psetq</code> form is just like a <code>setq</code> form, except
that the variables are set &quot;in parallel&quot;; first all of the <em>value</em> forms
are evaluated, and then the <em>variables</em> are set to the resulting
values.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq a 1)
(setq b 2)
(psetq a b b a)
a =&gt; 2
b =&gt; 1
</pre></div>
</dd></dl>

<p>Here are the special forms used for binding variables.
</p>
<a name="let_002dfun"></a><dl>
<dt><a name="index-let"></a>Special Form: <strong>let</strong> <em>((var value)...) body...</em></dt>
<dd><p><code>let</code> is used to bind some variables to some objects, and evaluate some forms
(the &quot;body&quot;) in the context of those bindings.
A <code>let</code> form looks like
</p><div class="lisp">
<pre class="lisp">(let ((<em>var1</em> <em>vform1</em>)
      (<em>var2</em> <em>vform2</em>)
      ...)
  <em>bform1</em>
  <em>bform2</em>
  ...)
</pre></div>
<p>When this form is evaluated, first the <em>vforms</em> (the values) are evaluated.
Then the <em>vars</em> are bound to the values returned by the
corresponding <em>vforms</em>.  Thus the bindings happen in parallel;
all the <em>vforms</em> are evaluated before any of the <em>vars</em> are bound.
Finally, the <em>bforms</em> (the body) are evaluated sequentially, the old values
of the variables are restored, and the result of the last <em>bform</em> is returned.
</p>
<p>You may omit the <em>vform</em> from a <code>let</code> clause, in which case it is as
if the <em>vform</em> were <code>nil</code>: the variable is bound to <code>nil</code>.
Furthermore, you may replace the entire clause (the list of the variable
and form) with just the variable, which also means that the variable
gets bound to <code>nil</code>.  Example:
</p><div class="lisp">
<pre class="lisp">(let ((a (+ 3 3))
      (b 'foo)
      (c)
      d)
  ...)
</pre></div>
<p>Within the body, <code>a</code> is bound to <code>6</code>, <code>b</code> is bound to <code>foo</code>, <code>c</code> is
bound to <code>nil</code>, and <code>d</code> is bound to <code>nil</code>.
</p></dd></dl>

<a name="let_002a_002dfun"></a><dl>
<dt><a name="index-let_002a"></a>Special Form: <strong>let*</strong> <em>((var value)...) body...</em></dt>
<dd><p><code>let*</code> is the same as <code>let</code> except that the binding is sequential.  Each
<em>var</em> is bound to the value of its <em>vform</em> before the next <em>vform</em>
is evaluated.  This is useful when the computation of a <em>vform</em> depends on
the value of a variable bound in an earlier <em>vform</em>.  Example:
</p><div class="lisp">
<pre class="lisp">(let* ((a (+ 1 2))
       (b (+ a a)))
 ...)
</pre></div>
<p>Within the body, <code>a</code> is bound to <code>3</code> and <code>b</code> is bound to <code>6</code>.
</p></dd></dl>

<a name="let_002dif_002dfun"></a><dl>
<dt><a name="index-let_002dif"></a>Special Form: <strong>let-if</strong> <em>condition ((var value)...) body...</em></dt>
<dd><p><code>let-if</code> is a variant of <code>let</code> in which the binding of variables is conditional.
The variables must all be special variables.
The <code>let-if</code> special form, typically written as
</p><div class="lisp">
<pre class="lisp">(let-if <em>cond</em>
	((<em>var-1</em> <em>val-1</em>) (<em>var-2</em> <em>val-2</em>)...)
  <em>body-form1</em> <em>body-form2</em>...)
</pre></div>
<p>first evaluates the predicate form <em>cond</em>.  If the result is non-<code>nil</code>, the value forms
<em>val-1</em>, <em>val-2</em>, etc are evaluated and then the variables <em>var-1</em>, <em>var-2</em>,
etc are bound to them.  If the result is <code>nil</code>, the
<em>vars</em> and <em>vals</em> are ignored.  Finally the body forms are evaluated.
</p></dd></dl>

<a name="let_002dglobally_002dfun"></a><dl>
<dt><a name="index-let_002dglobally"></a>Special Form: <strong>let-globally</strong> <em>((var value)...) body...</em></dt>
<dd><p><code>let-globally</code> is similar in form to <code>let</code> (see <a href="#let_002dfun">let-fun</a>).
The difference is that <code>let-globally</code> does not <em>bind</em> the
variables; instead, it saves the old values and <em>sets</em> the variables,
and sets up an <code>unwind-protect</code>
(see <a href="#unwind_002dprotect_002dfun">unwind-protect-fun</a>) to set them back.  The important
difference between <code>let-globally</code> and <code>let</code> is that when
the current stack group (see <a href="#stack_002dgroup">stack-group</a>) co-calls some other stack
group, the old values of the variables are <em>not</em> restored.  Thus
<code>let-globally</code> makes the new values visible in all stack groups and
processes that don&rsquo;t bind the variables themselves, not just the current stack group.
</p></dd></dl>

<a name="progv_002dfun"></a><dl>
<dt><a name="index-progv"></a>Special Form: <strong>progv</strong> <em>symbol-list value-list body...</em></dt>
<dd><p><code>progv</code> is a special form to provide the user with extra control
over binding.  It binds a list of special variables to a list of values,
and then evaluates some forms.  The lists of special variables and values
are computed quantities; this is what makes <code>progv</code> different from
<code>let</code>, <code>prog</code>, and <code>do</code>.
</p>
<p><code>progv</code> first evaluates <em>symbol-list</em> and <em>value-list</em>, and then binds each
symbol to the corresponding value.  If too few values are supplied, the
remaining symbols are bound to <code>nil</code>.  If too many values are
supplied, the excess values are ignored.
</p>
<p>After the symbols have been bound to the values, the <em>body</em> forms are
evaluated, and finally the symbols&rsquo; bindings are undone.
The result returned is the value of the last form in the body.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq a 'foo b 'bar)

(progv (list a b 'b) (list b)
  (list a b foo bar))
    =&gt; (foo nil bar nil)
</pre></div>
<p>During the evaluation of the body of this <code>progv</code>, <code>foo</code>
is bound to <code>bar</code>, <code>bar</code> is bound to <code>nil</code>, <code>b</code> is
bound to <code>nil</code>, and <code>a</code> retains its top-level value <code>foo</code>.
</p></dd></dl>

<a name="progw_002dfun"></a><dl>
<dt><a name="index-progw"></a>Special Form: <strong>progw</strong> <em>vars-and-vals-form body...</em></dt>
<dd><p><code>progw</code> is a somewhat modified kind of <code>progv</code>.  Like <code>progv</code>, it
only works for special variables.
First, <em>vars-and-val-forms-form</em> is evaluated.  Its value should be a list
that looks like the first subform of a <code>let</code>:
</p><div class="lisp">
<pre class="lisp">  ((<em>var1</em> <em>val-form-1</em>)
   (<em>var2</em> <em>val-form-2</em>)
   ...)
</pre></div>
<p>Each element of this list is processed in turn, by evaluating the <em>val-form</em>,
and binding the <em>var</em> to the resulting value.  Finally, the <em>body</em> forms are
evaluated sequentially, the bindings are undone, and the result of the last
form is returned.  Note that the bindings are sequential, not parallel.
</p>
<p>This is a very unusual special form because of the way the evaluator is
called on the result of an evaluation.  Thus <code>progw</code> is mainly
useful for implementing special forms and for functions part of whose
contract is that they call the interpreter.  For an example of the latter,
see <code>sys:*break-bindings*</code> (<a href="#sys_003a_002abreak_002dbindings_002a_002dvar">sys:*break-bindings*-var</a>); <code>break</code> implements
this by using <code>progw</code>.
</p></dd></dl>

<p>Here are the special forms for defining special variables.
</p>
<a name="defvar_002dfun"></a><dl>
<dt><a name="index-defvar"></a>Special Form: <strong>defvar</strong> <em>variable [initial-value] [documentation]</em></dt>
<dd><p><code>defvar</code> is the recommended way to declare the use of a global variable in a
program.  Placed at top level in a file,
</p><div class="lisp">
<pre class="lisp">(defvar <em>variable</em> <em>initial-value</em> 
  &quot;<em>documentation</em>&quot;)
</pre></div>
<p>declares <em>variable</em> special for the sake of compilation, and records
its location in the file for the sake of the editor so that you can ask
to see where the variable is defined.  The documentation string is
remembered and returned if you do <code>(documentation '<em>variable</em>)</code>.
</p>
<p><em>variable</em> is initialized to the result of evaluating the form
<em>initial-value</em> unless it already has a value, in which case it
keeps that value.  <em>initial-value</em>
is not evaluated unless it is used; this is useful if it does something
expensive like creating a large data structure.
</p>
<p>If you do not wish to give <em>variable</em> any initial value, use the
symbol <code>:unbound</code> as the <em>initial-value</em> form.  This is treated
specially; no attempt is made to evaluate <code>:unbound</code>.
</p>
<p>Using a documentation string is better than using a comment to describe
the use of the variable, because the documentation string is accessible
to system programs that can show the documentation to you while you are
using the machine.  While it is still permissible to omit
<em>initial-value</em> and the documentation string, it is recommended that
you put a documentation string in every <code>defvar</code>.
</p>
<p><code>defvar</code> should be used only at top level, never in function
definitions, and only for global variables (those used by more than one
function).  <code>(defvar foo 'bar)</code> is roughly equivalent to
</p><div class="lisp">
<pre class="lisp">(declare (special foo))
(if (not (boundp 'foo))
    (setq foo 'bar))
</pre></div>

<p>If <code>defvar</code> is used in a patch file (see <a href="#patch_002dfacility">patch-facility</a>)
or is a single form (not a region) evaluated with the editor&rsquo;s
compile/evaluate from buffer commands,
if there is an initial-value the variable is always set to it
regardless of whether it is already bound.
</p></dd></dl>

<a name="defconst_002dfun"></a><dl>
<dt><a name="index-defconst"></a>Special Form: <strong>defconst</strong> <em>variable initial-value [documentation]</em></dt>
<dd><p><code>defconst</code> is the same as <code>defvar</code> except that if an initial value
is given the variable is always set to it regardless of whether it is
already bound.  The rationale for this is that <code>defvar</code> declares a
global variable, whose value is initialized to something but will then
be changed by the functions that use it to maintain some state.  On the
other hand, <code>defconst</code> declares a constant, whose value will be
changed only by changes <em>to</em> the program, never by the operation of
the program as written.  <code>defconst</code> always sets the variable to the
specified value so that if, while developing or debugging the program,
you change your mind about what the constant value should be, and then
you evaluate the <code>defconst</code> form again, the variable will get the new
value.  It is <em>not</em> the intent of <code>defconst</code> to declare that the
value of <em>variable</em> will never change; for example, <code>defconst</code> is
<em>not</em> license to the compiler to build assumptions about the value of
<em>variable</em> into programs being compiled.
</p>
<p>As with <code>defvar</code>, you should include a documentation string in every <code>defconst</code>.
</p></dd></dl>

<a name="Functions"></a>
<h3 class="section">3.2 Functions</h3>
<a name="function_002dsection"></a><a name="lambda_002dlist"></a><a name="index-lambda-list"></a>

<p>In the description of evaluation on <a href="#description_002dof_002devaluation">description-of-evaluation</a>, we
said that evaluation of a function form works by applying the function
to the results of evaluating the argument subforms.  What is a function,
and what does it mean to apply it?  In Zetalisp there are many
kinds of functions, and applying them may do many different kinds of
things.  For full details, see <a href="#function_002dfunctions">function-functions</a>.  Here we will
explain the most basic kinds of functions and how they work.  In
particular, this section explains <em>lambda lists</em> and all their
important features.
</p>
<p>The simplest kind of user-defined function is the <em>lambda-expression</em>,
which is a list that looks like:
</p><div class="lisp">
<pre class="lisp">(lambda <em>lambda-list</em> <em>body1</em> <em>body2</em>...)
</pre></div>
<p>The first element of the lambda-expression is the symbol <code>lambda</code>; the
second element is a list called the <em>lambda list</em>, and the rest of the
elements are called the <em>body</em>.  The lambda list, in its simplest
form, is just a list of variables.  Assuming that this simple form
is being used, here is what happens when a lambda expression is applied
to some arguments.  First, the number of arguments and the number of
variables in the lambda list must be the same, or else an error is signalled.
Each variable is bound to the corresponding argument value.  Then
the forms of the body are evaluated sequentially.  After this, the
bindings are all undone, and the value of the last form in the body is
returned.
</p>
<p>This may sound something like the description of <code>let</code>, above.  The
most important difference is that the lambda-expression is not a form at
all; if you try to evaluate a lambda-expression, you will get told that
<code>lambda</code> is not a defined function.  The lambda-expression is a
<em>function</em>, not a form.   A <code>let</code> form gets evaluated, and the
values to which the variables are bound come from the evaluation of some
subforms inside the <code>let</code> form; a lambda-expression gets applied, and
the values are the arguments to which it is applied.
</p>
<a name="index-parameters"></a>

<p>The variables in the lambda list are sometimes called <em>parameters</em>,
by analogy with other languages.  Some other terminologies would refer
to these as <em>formal parameters</em>, and to arguments as <em>actual parameters</em>.
</p>
<p>Lambda lists can have more complex structure than simply being a list of
variables.  There are additional features accessible by using certain
keywords (which start with <code>&amp;</code>) and/or lists as elements of the
lambda list.
</p>
<p>The principal weakness of the simple lambda lists is that any
function written with one must only take a certain, fixed number of
arguments.  As we know, many very useful functions, such as <code>list</code>,
<code>append</code>, <code>+</code>, and so on, accept a varying number of arguments.
Maclisp solved this problem by the use of <em>lexprs</em> and <em>lsubrs</em>,
which were somewhat inelegant since the parameters had to be referred to
by numbers instead of names (e.g <code>(arg 3)</code>).  (For compatibility
reasons, Zetalisp supports <em>lexpr</em>s, but they should not be
used in new programs.)  Simple lambda lists also require that
arguments be matched with parameters by their position in the
sequence.  This makes calls hard to read when there are a great many
arguments.  Keyword parameters enable the use of other styles of call
which are more readable.
</p>
<a name="index-_0022keyword-parameters_0022"></a>
<a name="index-_0022positional-parameters_0022"></a>
<a name="index-_0022optional-parameters_0022"></a>
<a name="index-_0022required-parameters_0022"></a>
<a name="index-_0022rest-parameters_0022"></a>

<p>In general, a function in Zetalisp has zero or more
<em>positional</em> parameters, followed if desired by a single <em>rest</em>
parameter, followed by zero or more <em>keyword</em> parameters.  The
positional and keyword parameters may be <em>required</em> or <em>optional</em>,
but all the optional parameters must follow all the required ones.
The required/optional distinction does not apply to the rest
parameter.
</p>
<p>The caller must provide enough arguments so that each of the required
parameters gets bound, but he may provide extra arguments for some of
the optional parameters.  Also, if there is a rest parameter, he can
provide as many extra arguments as he wants, and the rest parameter
will be bound to a list of all these extras.  Optional parameters may
have a <em>default-form</em>, which is a form to be evaluated to produce
the default value for the parameter if no argument is supplied.
</p>
<p>Positional parameters are matched with arguments by the position of
the arguments in the argument list.  Keyword parameters are matched
with their arguments by matching the keyword name; the arguments need
not appear in the same order as the parameters.  If an optional
positional argument is omitted, then no further arguments can be
present.  Keyword parameters allow the caller to decide independently
for each one whether to specify it.
	Here is the exact explanation of how this all works.  When
<code>apply</code> (the primitive function that applies functions
to arguments) matches up the arguments with the parameters, it follows the
following algorithm: 
</p><dl compact="compact">
<dt><span class="roman">Required positional parameters:</span></dt>
<dd><p>The first required positional parameter is bound to the first
argument.  <code>apply</code> continues to bind successive required
positional parameters
to the successive arguments.  If, during this process, there are no
arguments left but there are still some required parameters
(positional or keyword) which have
not been bound yet, it is an error (&quot;too few arguments&quot;).
</p></dd>
<dt><span class="roman">Optional positional parameters:</span></dt>
<dd><p>After all required parameters are handled, <code>apply</code>
continues with the optional positional parameters, if any.  It binds
successive parameter to the next argument.  If, during this process, there are no arguments
left, each remaining optional parameter&rsquo;s default-form is evaluated,
and the parameter is bound to it.  This is done one parameter at a time;
that is, first one default-form is evaluated, and then the parameter is
bound to it, then the next default-form is evaluated, and so on.
This allows the default for an argument to depend on the previous argument.
</p></dd>
<dt><span class="roman">After the positional parameters:</span></dt>
<dd><p>Now, if there are no remaining parameters (rest or keyword), and there are no
remaining arguments, we are finished.  If there are no more parameters
but there are still some arguments remaining, an error is signaled (&quot;too
many arguments&quot;).  If parameters remain, all the remaining arguments
are used for <em>both</em> the rest parameter, if any, and the keyword
parameters.
</p></dd>
<dt><span class="roman">Rest parameter:</span></dt>
<dd><p>If there is a rest parameter, it is bound to a list of all
the remaining arguments.  If there are no
remaining arguments, it gets bound to <code>nil</code>.
</p></dd>
<dt><span class="roman">Keyword parameters:</span></dt>
<dd><p>If there are keyword parameters, the same remaining arguments are
used to bind them, as follows.
	The arguments for the keyword parameters are treated as a list
of alternating keyword symbols and associated values.  Each symbol is
matched with the keyword parameter names, and the matching keyword
paramater is bound to the value which follows the symbol.  All the
remaining arguments are treated in this way.  Since the arguments are
usually obtained by evaluation, those arguments which are keyword
symbols are typically quoted in the call; but they do not have to be.
The keyword symbols are compared by means of <code>eq</code>, which means they
must be specified in the correct package.  The keyword symbol for a
parameter has the same print name as the parameter, but resides in the
keyword package regardless of what package the parameter name itself
resides in.  (You can specify the keyword symbol explicitly in the
lambda list if you must; see below.)
	If any keyword parameter has not received a value when all the
arguments have been processed, this is an error if the parameter is
required.  If it is optional, the default-form for the parameter is
evaluated and the parameter is bound to its value.
	There may be a keyword symbol among the arguments which does not match any
keyword parameter name.  The function itself specifies whether this is
an error.  If it is not an error, then the non-matching symbols and
their associated values are ignored.  The function can access these
symbols and values through the rest parameter, if there is one.
It is common for a function to check only for certain keywords, and
pass its rest parameter to another function using <code>lexpr-funcall</code>;
that function will check for the keywords that concern it.
</p></dd>
</dl>

<p>The way you express which parameters are required, optional,
and rest is by means of specially recognized symbols, which are called
<code>&amp;-<em>keywords</em></code>, in the lambda list.  All such symbols&rsquo; print names
begin with the character &quot;<code>&amp;</code>&quot;.  A list of all such symbols is the value of
the symbol <code>lambda-list-keywords</code>. 
<a name="g_t_0026rest"></a><a name="g_t_0026key"></a>	The keywords used here are <code>&amp;key</code>, <code>&amp;optional</code> and <code>&amp;rest</code>.
The way they are used is best explained by means of examples;
the following are typical lambda lists, followed by descriptions
of which parameters are positional, rest or keyword; and required or optional.
</p><dl compact="compact">
<dt><tt>(a b c)</tt></dt>
<dd><p><code>a</code>, <code>b</code>, and <code>c</code> are all required and positional.  The function must be
passed three arguments.
</p></dd>
<dt><tt>(a b &amp;optional c)</tt></dt>
<dd><p><code>a</code> and <code>b</code> are required, <code>c</code> is optional.  All three are
positional.  The function may be passed either two or three arguments.
</p></dd>
<dt><tt>(&amp;optional a b c)</tt></dt>
<dd><p><code>a</code>, <code>b</code>, and <code>c</code> are all optional and positional.  The function may
be passed any number of arguments between zero and three, inclusive.
</p></dd>
<dt><tt>(&amp;rest a)</tt></dt>
<dd><p><code>a</code> is a rest parameter.  The function may be passed any number of arguments.
</p></dd>
<dt><tt>(a b &amp;optional c d &amp;rest e)</tt></dt>
<dd><p><code>a</code> and <code>b</code> are required positional, <code>c</code> and <code>d</code> are optional
positional, and <code>e</code> is rest.  The function may be passed two or more
arguments.
</p></dd>
<dt><tt>(&amp;key a b)</tt></dt>
<dd><p><code>a</code> and <code>b</code> are both required keyword parameters.  A typical
call would look like
</p><div class="lisp">
<pre class="lisp">(foo ':b 69 ':a '(some elements))
</pre></div>
<p>This illustrates that the parameters can be matched in either order.
If a keyword is specified twice, the first value is used.
</p></dd>
<dt><tt>(&amp;key a &amp;optional b)</tt></dt>
<dd><p><code>a</code> is required keyword, and <code>b</code> is optional keyword.
The sample call above would be legal for this function also; so would
</p><div class="lisp">
<pre class="lisp">(foo ':a '(some elements))
</pre></div>
<p>which doesn&rsquo;t specify <code>b</code>.
</p></dd>
<dt><tt>(x &amp;optional y &amp;rest z &amp;key a b)</tt></dt>
<dd><p><code>x</code> is required positional, <code>y</code> is optional positional,
<code>z</code> is rest, and <code>a</code> and <code>b</code> are optional keyword.
One or more arguments are allowed.  One or two arguments specify only
the positional parameters.  Arguments beyond the second specify both
the rest parameter and the keyword parameters, so that
</p><div class="lisp">
<pre class="lisp">(foo 1 2 ':b '(a list))
</pre></div>
<p>specifies <code>1</code> for <code>x</code>, <code>2</code> for <code>y</code>, <code>(:b (a
list))</code> for <code>z</code>, and <code>(a list)</code> for <code>b</code>.  It does not
specify <code>a</code>.
</p></dd>
<dt><tt>(&amp;rest z &amp;key &amp;optional a b c &amp;allow-other-keys)</tt></dt>
<dd><p><code>z</code> is rest, and <code>a</code>, <code>b</code> and <code>c</code> are optional keyword
parameters.  <code>&amp;allow-other-keys</code> says that absolutely any keyword
symbols may appear among the arguments; these symbols and the values
that follow them have no effect on the keyword parameters, but do
become part of the value of <code>z</code>.
</p></dd>
<dt><tt>(&amp;rest z &amp;key &amp;allow-other-keys)</tt></dt>
<dd><p>This is equivalent to <code>(&amp;rest z)</code>.  So, for that matter, is the
previous example, if the function does not use the values of <code>a</code>,
<code>b</code> and <code>c</code>.
</p></dd>
</dl>
<p>In all of the cases above, the <em>default-form</em> for each
optional parameter is <code>nil</code>.  To specify your own default forms,
instead of putting a symbol as the element of a lambda list, put in a
list whose first element is the symbol (the parameter itself) and whose
second element is the default-form.  Only optional parameters may have
default forms; required parameters are never defaulted, and rest
parameters always default to <code>nil</code>.  For example:
</p><dl compact="compact">
<dt><tt>(a &amp;optional (b 3))</tt></dt>
<dd><p>The default-form for <code>b</code> is <code>3</code>.  <code>a</code> is a required parameter, and
so it doesn&rsquo;t have a default form.
</p></dd>
<dt><tt>(&amp;optional (a 'foo) &amp;rest d &amp;key b (c (symeval a)))</tt></dt>
<dd><p><code>a</code>&rsquo;s default-form is <code>'foo</code>, <code>b</code>&rsquo;s is <code>nil</code>, and <code>c</code>&rsquo;s is
<code>(symeval a)</code>.  Note that if
the function whose lambda list this is were called on no arguments,
<code>a</code> would be bound to the symbol <code>foo</code>, and <code>c</code> would be bound
to the value of the symbol <code>foo</code>; this illustrates the fact
that each variable is bound immediately after its default-form is evaluated,
and so later default-forms may take advantage of earlier parameters
in the lambda list.  <code>b</code> and <code>d</code> would be bound to <code>nil</code>.
</p></dd>
</dl>

<a name="index-supplied_002dp-variable"></a>

<p>Occasionally it is important to know whether a certain optional
parameter was defaulted or not.  You can&rsquo;t tell from just examining its
value, since if the value is the default value, there&rsquo;s no way to tell
whether the caller passed that value explicitly, or whether the caller
didn&rsquo;t pass any value and the parameter was defaulted.  The way to tell
for sure is to put a third element into the list: the third element
should be a variable (a symbol), and that variable is bound to <code>nil</code>
if the parameter was not passed by the caller (and so was defaulted), or
<code>t</code> if the parameter was passed.  The new variable is called a &quot;supplied-p&quot;
variable; it is bound to <code>t</code> if the parameter is supplied.
For example:
</p><dl compact="compact">
<dt><tt>(a &amp;optional (b 3 c))</tt></dt>
<dd><p>The default-form for <code>b</code> is <code>3</code>, and the &quot;supplied-p&quot; variable for <code>b</code>
is <code>c</code>.  If the function is called with one argument, <code>b</code> will be bound
to <code>3</code> and <code>c</code> will be bound to <code>nil</code>.  If the function is called
with two arguments, <code>b</code> will be bound to the value that was passed
by the caller (which might be <code>3</code>), and <code>c</code> will be bound to <code>t</code>.
</p></dd>
</dl>

<p>It is possible to specify a keyword parameter&rsquo;s symbol independently
of its parameter name.  To do this, use <em>two</em> nested lists to
specify the parameter.  The outer list is the one which can contain
the default-form and supplied-p variable, if the parameter is
optional.  The first element of this list, instead of a symbol, is
again a list, whose elements are the keyword symbol and the parameter
variable name.
For example:
</p><dl compact="compact">
<dt><tt>(&amp;key ((:a a)) &amp;optional ((:b b) t))</tt></dt>
<dd><p>This is equivalent to <code>(&amp;key a &amp;optional (b t))</code>.
</p></dd>
<dt><tt>(&amp;key ((:base base-value)))</tt></dt>
<dd><p>This allows a keyword which the user will know under the name
<code>:base</code>, without making the parameter shadow the value of
<code>base</code>, which is used for printing numbers.
</p></dd>
</dl>

<p>It is also possible to include, in the lambda list, some other
symbols, which are bound to the values of their default-forms upon
entry to the function.  These are <em>not</em> parameters, and they are
never bound to arguments; they just get bound, as if they appeared
in a <code>let</code> form.  (Whether you use these aux-variables or bind the
variables with <code>let</code> is a stylistic decision.)
	To include such symbols, put them after any parameters, preceeded
by the <code>&amp;</code>-keyword <code>&amp;aux</code>.  Examples:
</p><dl compact="compact">
<dt><tt>(a &amp;optional b &amp;rest c &amp;aux d (e 5) (f (cons a e)))</tt></dt>
<dd><p><code>d</code>, <code>e</code>, and <code>f</code> are bound, when the function is
called, to <code>nil</code>, <code>5</code>, and a cons of the first argument and 5.
</p></dd>
</dl>

<p>Note that aux-variables are bound sequentially rather than
in parallel.
</p>
<p>It is important to realize that the list of arguments to which a
rest-parameter is bound is set up in whatever way is most efficiently
implemented, rather than in the way that is most convenient for the
function receiving the arguments.  It is not guaranteed to be a &quot;real&quot;
list.  Sometimes the rest-args list is a stack list (see <a href="#stack_002dlist">stack-list</a>)
stored in the function-calling stack, and loses its validity when the
function returns.  If a rest-argument is to be returned or made part of
permanent list-structure, it must first be copied (see <code>copylist</code>,
<a href="#copylist_002dfun">copylist-fun</a>), as you must always assume that it is one of these
special lists.  The system will not detect the error of omitting to copy
a rest-argument; you will simply find that you have a value which seems
to change behind your back.
</p>
<p>At other times the rest-args list will be an argument that was given to
<code>apply</code>; therefore it is not safe to <code>rplaca</code> this list as you may
modify permanent data structure.  An attempt to <code>rplacd</code> a rest-args
list will be unsafe in this case, while in the first case it would cause
an error, since lists in the stack are impossible to <code>rplacd</code>.
</p>
<p>There are some other keywords in addition to those mentioned
here.  See <a href="#lambda_002dlist_002dkeywords">lambda-list-keywords</a> for a complete list.  You need to
know only about <code>&amp;optional</code>, <code>&amp;key</code>, and <code>&amp;rest</code> in order to
understand this manual.
</p>
<a name="g_t_0022Some-Functions-and-Special-Forms_0022"></a>
<h3 class="section">3.3 &quot;Some Functions and Special Forms&quot;</h3>

<p>This section describes some functions and special forms.  Some are parts
of the evaluator, or closely related to it.  Some have to do
specifically with issues discussed above such as keyword arguments.
Some are just fundamental Lisp forms that are very important.
</p>
<a name="eval_002dfun"></a><dl>
<dt><a name="index-eval"></a>Function: <strong>eval</strong> <em>x</em></dt>
<dd><p><code>(eval <em>x</em>)</code> evaluates <em>x</em>, and returns the result.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq x 43 foo 'bar)
(eval (list 'cons x 'foo))
    =&gt; (43 . bar)
</pre></div>
<p>It is unusual to explicitly call <code>eval</code>, since usually
evaluation is done implicitly.  If you are writing a simple Lisp program and
explicitly calling <code>eval</code>, you are probably doing something wrong.
<code>eval</code> is primarily useful in programs which deal with Lisp itself,
rather than programs about knowledge or mathematics or games.
	Also, if you are only interested in getting at the value of a
symbol (that is, the contents of the symbol&rsquo;s value cell), then you
should use the primitive function <code>symeval</code> (see <a href="#symeval_002dfun">symeval-fun</a>).
	Note: the actual name of the compiled code for <code>eval</code> is &quot;<code>si:*eval</code>&quot;;
this is because use of the <em>evalhook</em> feature binds the function cell of <code>eval</code>.
If you don&rsquo;t understand this, you can safely ignore it.
<a name="index-_0022evalhook_0022"></a>
	Note: unlike Maclisp, <code>eval</code> never takes a second argument; there
are no &quot;binding context pointers&quot; in Zetalisp.
They are replaced by Closures (see <a href="#closure">closure</a>).
</p></dd></dl>

<a name="apply_002dfun"></a><dl>
<dt><a name="index-apply"></a>Function: <strong>apply</strong> <em>f arglist</em></dt>
<dd><p><code>(apply <em>f</em> <em>arglist</em>)</code> applies the function <em>f</em> to the list of
arguments <em>arglist</em>.  <em>arglist</em> should be a list; <em>f</em> can be any function.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(setq fred '+) (apply fred '(1 2)) =&gt; 3
(setq fred '-) (apply fred '(1 2)) =&gt; -1
(apply 'cons '((+ 2 3) 4)) =&gt;
	((+ 2 3) . 4)	<em>not</em> (5 . 4)
</pre></div>
<p>Of course, <em>arglist</em> may be <code>nil</code>.
	Note: unlike Maclisp, <code>apply</code> never takes a third argument; there
are no &quot;binding context pointers&quot; in Zetalisp.
</p>
<p>Compare <code>apply</code> with <code>funcall</code> and <code>eval</code>.
</p></dd></dl>

<a name="funcall_002dfun"></a><dl>
<dt><a name="index-funcall"></a>Function: <strong>funcall</strong> <em>f &amp;rest args</em></dt>
<dd><p><code>(funcall <em>f</em> <em>a1</em> <em>a2</em> ... <em>an</em>)</code> applies the
function <em>f</em> to the arguments <em>a1</em>, <em>a2</em>, ..., <em>an</em>.
<em>f</em> may not
be a special form nor a macro; this would not be meaningful.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(cons 1 2) =&gt; (1 . 2)
(setq cons 'plus)
(funcall cons 1 2) =&gt; 3
</pre></div>
<p>This shows that the use of the symbol <code>cons</code> as the name of a function
and the use of that symbol as the name of a variable do not interact.
The <code>cons</code> form invokes the function named <code>cons</code>.
The <code>funcall</code> form evaluates the variable and gets the symbol <code>plus</code>,
which is the name of a different function.
</p></dd></dl>

<a name="lexpr_002dfuncall_002dfun"></a><dl>
<dt><a name="index-lexpr_002dfuncall"></a>Function: <strong>lexpr-funcall</strong> <em>f &amp;rest args</em></dt>
<dd><p><code>lexpr-funcall</code> is like a cross between <code>apply</code> and <code>funcall</code>.
<code>(lexpr-funcall <em>f</em> <em>a1</em> <em>a2</em> ... <em>an</em> <em>l</em>)</code> applies the
function <em>f</em>
to the arguments <em>a1</em> through <em>an</em> followed by the elements of
the list <em>l</em>.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(lexpr-funcall 'plus 1 1 1 '(1 1 1)) =&gt; 6

(lexpr-funcall 'plus '(1 2)) =&gt; 3

(lexpr-funcall '(car (a))) =&gt; a
      <span class="roman">;Not the same as <code>(eval '(car (a)))</code></span>

(defun report-error (&amp;rest args)
   (lexpr-funcall (function format) error-output args))
</pre></div>

<p><code>lexpr-funcall</code> with two arguments does the same thing as <code>apply</code>.
<code>lexpr-funcall</code> with only one argument treats it as a list of
a function and some arguments.
</p></dd></dl>

<p>Note:  the Maclisp functions <code>subrcall</code>, <code>lsubrcall</code>, and <code>arraycall</code>
are not needed on the Lisp Machine; <code>funcall</code> is just as efficient.
<code>arraycall</code> is provided for compatibility; it ignores its first
subform (the Maclisp array type) and is otherwise identical to <code>aref</code>.
<code>subrcall</code> and <code>lsubrcall</code> are not provided.
<a name="index-_0022subrcall_0022"></a>
<a name="index-_0022lsubrcall_0022"></a>
</p>
<a name="call_002dfun"></a><dl>
<dt><a name="index-call"></a>Function: <strong>call</strong> <em>function &amp;rest argument-specifications</em></dt>
<dd><p><code>call</code> offers a very general way of controlling what arguments you
pass to a function.  You can provide either individual arguments a la
<code>funcall</code> or lists of arguments a la <code>apply</code>, in any order.  In
addition, you can make some of the arguments <em>optional</em>.  If the
function is not prepared to accept all the arguments you specify, no
error occurs if the excess arguments are optional ones.  Instead, the
excess arguments are simply not passed to the function.
</p>
<p>The <em>argument-specs</em> are alternating keywords (or lists of keywords)
and values.  Each keyword or list of keywords says what to do with the
value that follows.  If a value happens to require no keywords,
provide <code>()</code> as a list of keywords for it.
</p>
<p>Two keywords are presently defined: <code>:optional</code> and <code>:spread</code>.
<code>:spread</code> says that the following value is a list of arguments.
Otherwise it is a single argument.  <code>:optional</code> says that all the
following arguments are optional.  It is not necessary to specify
<code>:optional</code> with all the following <em>argument-specs</em>, because it is
sticky.
</p>
<p>Example:
</p><div class="lisp">
<pre class="lisp">(call #'foo () x ':spread y '(:optional :spread) z () w)
</pre></div>
<p>The arguments passed to <code>foo</code> are the value of <code>x</code>, the
elements of the value of <code>y</code>, the elements of the value of
<code>z</code>, and the value of <code>w</code>.  The function <code>foo</code> must be
prepared to accept all the arguments which come from <code>x</code> and
<code>y</code>, but if it does not want the rest, they are ignored.
</p></dd></dl>

<a name="quote_002dfun"></a><dl>
<dt><a name="index-quote"></a>Special Form: <strong>quote</strong> <em>object</em></dt>
<dd><a name="index-_0022quote_0022"></a>
<p><code>(quote <em>x</em>)</code> simply returns <em>x</em>.  It is useful specifically
because <em>x</em> is not evaluated; the <code>quote</code> is how you make a form
that returns an arbitrary Lisp object.  <code>quote</code> is used to include
constants in a form.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(quote x) =&gt; x
(setq x (quote (some list)))   x =&gt; (some list)
</pre></div>
<p>Since <code>quote</code> is so useful but somewhat cumbersome to type, the reader normally
converts any form preceded by a single quote (<code>'</code>) character into a <code>quote</code> form.
</p><div class="lisp">
<pre class="lisp">For example,
</pre><pre class="lisp">(setq x '(some list))
</pre><pre class="lisp">is converted by <code>read</code> into
</pre><pre class="lisp">(setq x (quote (some list)))
</pre></div>
</dd></dl>

<a name="function_002dfun"></a><dl>
<dt><a name="index-function-1"></a>Special Form: <strong>function</strong> <em>f</em></dt>
<dd><p>This means different things depending on whether <em>f</em> is a function
or the name of a function.  (Note that in neither case is <em>f</em> evaluated.)
The name of a function is a symbol or a function-spec list
(see <a href="#function_002dspec">function-spec</a>).  A function is typically a list whose car
is the symbol <code>lambda</code>; however, there are several other kinds
of functions available (see <a href="#kinds_002dof_002dfunctions">kinds-of-functions</a>).
</p>
<p>If you want to pass an anonymous function as an argument to a function,
you could just use <code>quote</code>; for example:
</p><div class="lisp">
<pre class="lisp">(mapc (quote (lambda (x) (car x))) some-list)
</pre></div>
<p>This works fine as far as the evaluator is concerned.  However, the
compiler cannot tell that the first argument is going to be used as a
function; for all it knows, <code>mapc</code> will treat its first argument as a
piece of list structure, asking for its car and cdr and so forth.  So
the compiler cannot compile the function; it must pass the
lambda-expression unmodified.  This means that the function will not get
compiled, which will make it execute more slowly than it might
otherwise.
</p>
<p>The <code>function</code> special form is one way to tell the compiler that
it can go ahead and compile the lambda-expression.  You just use
the symbol <code>function</code> instead of <code>quote</code>:
</p><div class="lisp">
<pre class="lisp">(mapc (function (lambda (x) (car x))) some-list)
</pre></div>
<p>This will cause the compiler to generate code such that <code>mapc</code> will be
passed a compiled-code object as its first argument.
</p>
<p>That&rsquo;s what the compiler does with a <code>function</code> special form whose
subform <em>f</em> is a function.  The evaluator, when given such a form,
just returns <em>f</em>; that is, it treats <code>function</code> just like <code>quote</code>.
</p>
<p>To ease typing, the reader converts <code>#'<em>thing</em></code> into <code>(function <em>thing</em>)</code>.
So <code>#'</code> is similar to <code>'</code> except that it produces a
<code>function</code> form instead of a <code>quote</code> form.  So the above form
could be written as 
</p><div class="lisp">
<pre class="lisp">(mapc #'(lambda (x) (car x)) some-list)
</pre></div>

<p>If <em>f</em> is not a function but the name of a function
(typically a symbol, but in general any kind of function spec), then
<code>function</code> returns the function definition of <em>f</em>; it is like <code>fdefinition</code>
except that it is a special form instead of a function, and so
</p><div class="lisp">
<pre class="lisp">(function fred)  <span class="roman">is like</span>  (fdefinition 'fred)
                 <span class="roman">which is like</span> (fsymeval 'fred)
</pre></div>
<p>since <code>fred</code> is a symbol.
<code>function</code> is the same for the compiler and the interpreter when
<em>f</em> is the name of a function.
</p>
<p>Another way of explaining <code>function</code> is that it causes <em>f</em> to be
treated the same way as it would as the car of a form.  Evaluating
the form <code>(<em>f</em> <em>arg1</em> <em>arg2</em>...)</code> uses the function definition
of <em>f</em> if it is a symbol, and otherwise expects <em>f</em> to be a list
which is a lambda-expression.  Note that the car of a form may not be
a non-symbol function spec, to avoid difficult-to-read code.  This can be
written as
</p><div class="lisp">
<pre class="lisp">(funcall (function <em>spec</em>) <em>args</em>...)
</pre></div>

<p>You should be careful about whether you use <code>#'</code> or <code>'</code>.  Suppose
you have a program with a variable <code>x</code> whose value is assumed to
contain a function that gets called on some arguments.  If you want that
variable to be the <code>car</code> function, there are two things you could say:
</p><div class="lisp">
<pre class="lisp">(setq x 'car)
</pre><pre class="lisp">or
</pre><pre class="lisp">(setq x #'car)
</pre></div>
<p>The former causes the value of <code>x</code> to be the symbol <code>car</code>, whereas
the latter causes the value of <code>x</code> to be the function object found in
the function cell of <code>car</code>.  When the time comes to call the function
(the program does <code>(funcall x ...)</code>), either of these two will work
(because if you use a symbol as a function, the contents of the symbol&rsquo;s
function cell is used as the function, as explained in the beginning of
this chapter).  Using <code>'car</code> is insignificantly slower, because the function
call has to indirect through the symbol, but it allows the function
to be redefined, traced (see <a href="#trace_002dfun">trace-fun</a>), or advised (see <a href="#advise_002dfun">advise-fun</a>).
The latter case, while faster, picks up the function definition out of
the symbol <code>car</code> and does not see any later changes to it.
</p>
<p>The other way to tell the compiler that an argument that is a lambda
expression should be compiled is for the function that takes the
function as an argument to use the <code>&amp;functional</code> keyword in its
lambda list; see <a href="#lambda_002dlist_002dkeywords">lambda-list-keywords</a>.  The basic system functions that
take functions as arguments, such as <code>map</code> and <code>sort</code>, have
this <code>&amp;functional</code> keyword and hence quoted lambda-expressions
given to them will be recognized as functions by the compiler.
</p>
<p>In fact, <code>mapc</code> uses <code>&amp;functional</code> and so the example given above
is bogus; in the particular case of the first argument to the function <code>mapc</code>,
<code>quote</code> and <code>function</code> are synonymous.  It is good style to use <code>function</code>
(or <code>#'</code>) anyway, to make the intent of the program completely clear.
</p></dd></dl>

<a name="false_002dfun"></a><dl>
<dt><a name="index-false"></a>Function: <strong>false</strong></dt>
<dd><p>Takes no arguments and returns <code>nil</code>.
</p></dd></dl>

<a name="true_002dfun"></a><dl>
<dt><a name="index-true"></a>Function: <strong>true</strong></dt>
<dd><p>Takes no arguments and returns <code>t</code>.
</p></dd></dl>

<a name="ignore_002dfun"></a><dl>
<dt><a name="index-ignore"></a>Function: <strong>ignore</strong> <em>&amp;rest ignore</em></dt>
<dd><p>Takes any number of arguments and returns <code>nil</code>.  This is often useful
as a &quot;dummy&quot; function; if you are calling a function that takes a function
as an argument, and you want to pass one that doesn&rsquo;t do anything and
won&rsquo;t mind being called with any argument pattern, use this.
</p></dd></dl>

<a name="comment_002dfun"></a><dl>
<dt><a name="index-comment"></a>Special Form: <strong>comment</strong></dt>
<dd><p><code>comment</code> ignores its form and returns the symbol <code>comment</code>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(defun foo (x)
    (cond ((null x) 0)
          (t (comment x has something in it)
             (1+ (foo (cdr x))))))
</pre></div>
<p>Usually it is preferable to comment code using the
semicolon-macro feature of the standard input syntax.  This allows the
user to add comments to his code which are ignored by the Lisp reader. 
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(defun foo (x)
    (cond ((null x) 0)
          (t (1+ (foo (cdr x))))     ;x has something in it
      ))
</pre></div>

<p>A problem with such comments is that they are discarded when the form
is read into Lisp.  If the function is read into Lisp, modified, and printed
out again, the comment will be lost.  However, this style of operation is hardly
ever used; usually the source of a function is kept in an editor buffer and
any changes are made to the buffer, rather than the actual list structure
of the function.  Thus, this is not a real problem.
</p></dd></dl>

<a name="progn_002dfun"></a><dl>
<dt><a name="index-progn"></a>Special Form: <strong>progn</strong> <em>body...</em></dt>
<dd><p>The <em>body</em> forms are evaluated in order from left to right and the value
of the last one is returned.
<code>progn</code> is the primitive control structure construct for &quot;compound
statements&quot;.  Although lambda-expressions, <code>cond</code> forms, <code>do</code> forms, and
many other control structure forms use <code>progn</code> implicitly, that is,
they allow multiple forms in their bodies, there are occasions when
one needs to evaluate a number of forms for their side-effects and
make them appear to be a single form.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(foo (cdr a)
     (progn (setq b (extract frob))
	    (car b))
     (cadr b))
</pre></div>

<p>(When <em>form1</em> is <code>'compile</code>, the <code>progn</code> form has a special meaning
to the compiler.  This is discussed in <a href="#progn_002dquote_002dcompile_002ddiscussion">progn-quote-compile-discussion</a>.)
</p></dd></dl>

<a name="prog1_002dfun"></a><dl>
<dt><a name="index-prog1"></a>Special Form: <strong>prog1</strong> <em>first-form body...</em></dt>
<dd><p><code>prog1</code> is similar to <code>progn</code>, but it returns the value of its <em>first</em> form rather
than its last.
It is most commonly used to evaluate an expression with side effects, and return
a value which must be computed <em>before</em> the side effects happen.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq x (prog1 y (setq y x)))
</pre></div>
<p>interchanges the values of the variables <em>x</em> and <em>y</em>.  <code>prog1</code> never
returns multiple values.
</p></dd></dl>

<a name="prog2_002dfun"></a><dl>
<dt><a name="index-prog2"></a>Special Form: <strong>prog2</strong> <em>first-form second-form body...</em></dt>
<dd><p><code>prog2</code> is similar to <code>progn</code> and <code>prog1</code>, but it returns its
<em>second</em> form.  It is included largely for compatibility with old programs.
</p></dd></dl>

<p>See also <code>bind</code> (<a href="#bind_002dfun">bind-fun</a>), which is a
subprimitive that gives you maximal control over binding.
</p>
<p>The following three functions (<code>arg</code>, <code>setarg</code>, and <code>listify</code>)
exist only for compatibility with Maclisp <em>lexprs</em>.  To write functions
that can accept variable numbers of arguments, use the <code>&amp;optional</code> and
<code>&amp;rest</code> keywords (see <a href="#function_002dsection">function-section</a>).
<a name="index-_0022lexpr_0022"></a>
</p>
<a name="arg_002dfun"></a><dl>
<dt><a name="index-arg"></a>Function: <strong>arg</strong> <em>x</em></dt>
<dd><p><code>(arg nil)</code>, when evaluated during the application of
a lexpr, gives the number of arguments supplied to that
lexpr.
This is primarily a debugging aid, since lexprs also receive their number of arguments
as the value of their <code>lambda</code>-variable.
</p>
<p><code>(arg <em>i</em>)</code>, when evaluated during the application of a lexpr, gives the value of the
<em>i</em>&rsquo;th argument to the lexpr.  <em>i</em> must be a fixnum in this case. It is an error if <em>i</em> is less than 1 or greater than the number
of arguments supplied to the lexpr.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(defun foo nargs            ;<span class="roman">define a lexpr </span>foo.
    (print (arg 2))         ;<span class="roman">print the second argument.</span>
    (+ (arg 1)              ;<span class="roman">return the sum of the first</span>
       (arg (- nargs 1))))  ;<span class="roman">and next to last arguments.</span>
</pre></div>
</dd></dl>

<a name="setarg_002dfun"></a><dl>
<dt><a name="index-setarg"></a>Function: <strong>setarg</strong> <em>i x</em></dt>
<dd><p><code>setarg</code> is used only during the application of a lexpr.
<code>(setarg <em>i x</em>)</code> sets the
lexpr&rsquo;s <em>i</em>&rsquo;th argument to <em>x</em>.
<em>i</em> must be greater than zero
and not greater than the number of arguments passed to the lexpr.
After <code>(setarg <em>i x</em>)</code> has been done, <code>(arg <em>i</em>)</code> will return <em>x</em>.
</p></dd></dl>

<a name="listify_002dfun"></a><dl>
<dt><a name="index-listify"></a>Function: <strong>listify</strong> <em>n</em></dt>
<dd><p><code>(listify <em>n</em>)</code> manufactures a list of <em>n</em> of the
arguments of a lexpr.  With a positive argument <em>n</em>, it returns a
list of the first <em>n</em> arguments of the lexpr.  With a negative
argument <em>n</em>, it returns a list of the last <code>(abs <em>n</em>)</code>
arguments of the lexpr.  Basically, it works as if defined as follows: 
</p><div class="lisp">
<pre class="lisp">(defun listify (n)
     (cond ((minusp n)
	    (listify1 (arg nil) (+ (arg nil) n 1)))
	   (t
	    (listify1 n 1)) ))

(defun listify1 (n m)      ;<span class="roman"> auxiliary function.</span>
     (do ((i n (1- i))
	  (result nil (cons (arg i) result)))
	 ((&lt; i m) result) ))
</pre></div>
</dd></dl>

<a name="Tail-Recursion"></a>
<h3 class="section">3.4 Tail Recursion</h3>
<a name="tail_002drecursion"></a><a name="index-tail-recursion"></a>

<p>When one function ends by calling another function (possibly itself), as in
</p>
<div class="lisp">
<pre class="lisp">(defun last (x)
  (cond ((atom x) x)
	((atom (cdr x)) x)
	(t (last (cdr x)))))
</pre></div>

<p>it is called <em>tail recursion</em>.  In general, if <em>X</em> is a form, and
<em>Y</em> is a sub-form of <em>X</em>, then if the value of <em>Y</em> is
unconditionally returned as the value of <em>X</em>, with no intervening
computation, then we say that <em>X</em> tail-recursively evaluates <em>Y</em>.
</p>
<p>In a tail-recursive situation,
it is not strictly necessary to remember anything about the first call
to <code>last</code> when the second one is activated.  The stack frame for the
first call can be discarded completely, allowing <code>last</code> to use a
bounded amount of stack space independent of the length of its argument.
A system which does this is called <em>tail-recursive</em>.
</p>
<p>The Lisp machine system works tail recursively if the variable
<code>tail-recursion-flag</code> is non-<code>nil</code>.  This is often faster, because
it reduces the amount of time spent in refilling the hardware&rsquo;s pdl
buffer.  Also, it may cause a program to run in an ordinary-size stack
instead of periodically exhausting its stack.  However, you forfeit a
certain amount of useful debugging information: once the outer call to
<code>last</code> has been removed from the stack, you can no longer see its
frame in the debugger.
</p>
<a name="tail_002drecursion_002dflag_002dvar"></a><dl>
<dt><a name="index-tail_002drecursion_002dflag"></a>Variable: <strong>tail-recursion-flag</strong></dt>
<dd><p>If this variable is non-<code>nil</code>, the calling stack frame is
discarded when a tail-recursive call is made in compiled code.
</p></dd></dl>

<p>There are many things which can make it dangerous to discard the outer
stack frame.  For example, it may have done a <code>*catch</code>; it may have
bound special variables; it may have a <code>&amp;rest</code> argument on the stack;
it may have asked for the location of an argument or local variable.
The system detects all of these conditions automatically and retains the
outer stack frame to bring about proper execution.  Some of these
conditions occur in <code>eval</code>; as a result,
interpreted code is never completely tail recursive.
</p>
<a name="Multiple-Values"></a>
<h3 class="section">3.5 Multiple Values</h3>
<a name="index-multiple-values"></a>
<a name="index-returning-multiple-values"></a>
<a name="multiple_002dvalue"></a>
<p>The Lisp Machine includes a facility by which the evaluation of a form
can produce more than one value.  When a function needs to return more
than one result to its caller, multiple values are a cleaner way of
doing this than returning a list of the values or <code>setq</code>&rsquo;ing special
variables to the extra values.  In most Lisp function calls, multiple
values are not used.  Special syntax is required both to <em>produce</em>
multiple values and to <em>receive</em> them.
</p>
<p>The primitive for producing multiple values is <code>values</code>, which takes
any number of arguments and returns that many values.  If the last form
in the body of a function is a <code>values</code> with three arguments, then
a call to that function will return three values.
The other primitive for producing multiple values is <code>return</code>, which when
given more than one argument returns all its arguments as the values of
the <code>prog</code> or <code>do</code> from which it is returning.  The variant
<code>return-from</code> also can produce multiple values.  Many system functions
produce multiple values, but they all do it via the <code>values</code>
and <code>return</code> primitives.
</p>
<p>The special forms for receiving multiple values are <code>multiple-value</code>,
<code>multiple-value-bind</code>, and <code>multiple-value-list</code>.  These consist of
a form and an indication of where to put the values returned by that form.
With the first two of these, the caller requests a certain number of
returned values.  If fewer values are returned than the number requested,
then it is exactly as if the rest of the values were present and had the
value <code>nil</code>.  If too many values are returned, the rest of the values
are ignored.  This has the advantage that you don&rsquo;t have to pay attention
to extra values if you don&rsquo;t care about them, but it does no error checking
on the number of values actually returned.
</p>
<a name="values_002dfun"></a><dl>
<dt><a name="index-values"></a>Function: <strong>values</strong> <em>&amp;rest args</em></dt>
<dd><p>Returns multiple values, its arguments.  This is the primitive
function for producing multiple values.  It is legal to call <code>values</code> with
no arguments; it returns no values in that case.
</p></dd></dl>

<a name="values_002dlist_002dfun"></a><dl>
<dt><a name="index-values_002dlist"></a>Function: <strong>values-list</strong> <em>list</em></dt>
<dd><p>Returns multiple values, the elements of the <em>list</em>.  <code>(values-list '(a b c))</code>
is the same as <code>(values 'a 'b 'c)</code>.
<em>list</em> may be <code>nil</code>, the empty list, which causes no values to be returned.
</p></dd></dl>

<p><code>return</code> and its variants can only be used within the <code>do</code> and
<code>prog</code> special forms and their variants, and so they are explained on
<a href="#return_002dfun">return-fun</a>.
</p>
<a name="multiple_002dvalue_002dfun"></a><dl>
<dt><a name="index-multiple_002dvalue"></a>Special Form: <strong>multiple-value</strong> <em>(variable...) form</em></dt>
<dd><p><code>multiple-value</code> is a special
form used for calling a function which
is expected to return more than one value.
<em>form</em> is evaluated, and the <em>variables</em>
are <em>set</em> (not lambda-bound) to the values returned by <em>form</em>.  If more values
are returned than there are variables, the extra values
are ignored.  If there are more variables than values returned,
extra values of <code>nil</code> are supplied.  If <code>nil</code> appears in the <em>var-list</em>,
then the corresponding value is ignored (you can&rsquo;t use <code>nil</code> as a variable).
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(multiple-value (symbol already-there-p)
	(intern &quot;goo&quot;))
</pre></div>
<p>In addition to its first value (the symbol), <code>intern</code> returns a second
value, which is <code>t</code> if the symbol returned as the first value was
already interned, or else <code>nil</code> if <code>intern</code> had to create it.  So if
the symbol <code>goo</code> was already known, the variable <code>already-there-p</code>
will be set to <code>t</code>, otherwise it will be set to <code>nil</code>.  The third value
returned by <code>intern</code> will be ignored.
</p>
<p><code>multiple-value</code> is usually used for effect rather than for value; however,
its value is defined to be the first of the values returned by <em>form</em>.
</p></dd></dl>

<a name="multiple_002dvalue_002dbind_002dfun"></a><dl>
<dt><a name="index-multiple_002dvalue_002dbind"></a>Special Form: <strong>multiple-value-bind</strong> <em>(variable...) form body...</em></dt>
<dd><p>This is similar to <code>multiple-value</code>, but locally binds the variables which
receive the values, rather than setting them, and has a body&ndash;a set of forms
which are evaluated with these local bindings in effect.
First <em>form</em> is evaluated.  Then the <em>variables</em> are
bound to the values returned by <em>form</em>.  Then the <em>body</em> forms
are evaluated sequentially, the bindings are undone, and the result
of the last <em>body</em> form is returned.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(multiple-value-bind (sym already-there)
    (intern string)
  ;; If an existing symbol was found, deallocate the string.
  (if already-there
      (return-storage (prog1 string (setq string nil))))
  sym)
</pre></div>
</dd></dl>

<a name="multiple_002dvalue_002dlist_002dfun"></a><dl>
<dt><a name="index-multiple_002dvalue_002dlist"></a>Special Form: <strong>multiple-value-list</strong> <em>form</em></dt>
<dd><p><code>multiple-value-list</code> evaluates <em>form</em>, and returns a list of
the values it returned.  This is useful for when you don&rsquo;t know how many values
to expect.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq a (multiple-value-list (intern &quot;goo&quot;)))
a =&gt; (goo nil #&lt;Package USER 10112147&gt;)
</pre></div>
<p>This is similar to the example of <code>multiple-value</code> above; <code>a</code> will be set
to a list of three elements, the three values returned by <code>intern</code>.
</p></dd></dl>

<p>When one form finished by tail recursively evaluating a subform (see
<a href="#tail_002drecursion">tail-recursion</a>), all of the subform&rsquo;s multiple values are passed back
by the outer form.  For example, the value of a <code>cond</code> is the value of
the last form in the selected clause.  If the last form in that clause
produces multiple values, so does the <code>cond</code>.  This <em>passing-back</em>
of multiple values of course has no effect unless eventually one of the
special forms for receiving multiple values is reached.
</p>
<p>If the outer form returns a value computed by a subform, but not in a
tail recursive fashion (for example, if the value of the subform is
examined first), multiple values or only single values may be returned
at the discretion of the implementation; users should not depend on
whatever way it happens to work, as it may change in the future or in
other implementations.  The reason we don&rsquo;t guarantee non-transmission
of multiple values is because such a guarantee would not be very useful
and the efficiency cost of enforcing it would be high.  Even
<code>setq</code>&rsquo;ing a variable to the result of a form, then returning the
value of that variable, might pass multiple values if an
optimizing compiler realized that the <code>setq</code>ing of the variable
was unnecessary.  Since extra returned values are generally ignored,
it is not vital to eliminate them.
</p>
<p>Note that use of a form as an argument to a function never receives
multiple values from that form.  That is, if the form <code>(foo (bar))</code>
is evaluated and the call to <code>bar</code> returns many values, <code>foo</code> will
still only be called on one argument (namely, the first value returned),
rather than being called on all the values returned.  We choose not to
generate several separate arguments from the several values, because
this would make the source code obscure; it would not be syntactically
obvious that a single form does not correspond to a single argument.
Instead, the first value of a form is used as the argument and the
remaining values are discarded.  Receiving of multiple values is done
only with the above-mentioned special forms.
</p>
<p>For clarity, descriptions of the interaction of several common special
forms with multiple values follow.  This can all be deduced from the
rule given above.  Note well that when it says that multiple values
are not returned, it really means that they may or may not be returned,
and you should not write any programs that depend on which way it works.
</p>
<p>The body of a <code>defun</code> or a <code>lambda</code>, and variations such as the
body of a function, the body of a <code>let</code>, etc., pass back multiple
values from the last form in the body.
</p>
<p><code>eval</code>, <code>apply</code>, <code>funcall</code>, and <code>lexpr-funcall</code>
pass back multiple values from the function called.
</p>
<p><code>progn</code> passes back multiple values from its last form.  <code>progv</code> and
<code>progw</code> do so also.  <code>prog1</code> and <code>prog2</code>, however, do not pass
back multiple values.
</p>
<p>Multiple values are passed back from the last subform of an <code>and</code> or <code>or</code> form,
but not from previous forms since the return is conditional.  Remember
that multiple values are only passed back when the value of a sub-form
is unconditionally returned from the containing form.  For example,
consider the form <code>(or (foo) (bar))</code>.  If <code>foo</code> returns a non-<code>nil</code>
first value, then only that value will be returned as the value of the
form.  But if it returns <code>nil</code> (as its first value), then <code>or</code>
returns whatever values the call to <code>bar</code> returns.
</p>
<p><code>cond</code> passes back multiple values from the last form in the selected
clause, provided that that last form&rsquo;s value will be returned
unconditionally.  This is true if the clause has two or more forms in
it, and is always true for the last clause.
</p>
<p>The variants of <code>cond</code> such as <code>if</code>, <code>select</code>, <code>selectq</code>, and
<code>dispatch</code> pass back multiple values from the last form in the
selected clause.
</p>
<p>The number of values returned by <code>prog</code> depends on the <code>return</code> form
used to return from the <code>prog</code>.  (If a <code>prog</code> drops off the end it
just returns a single <code>nil</code>.)  If <code>return</code> is given two or more
subforms, then <code>prog</code> will return as many values as the <code>return</code> has
subforms.  However, if the <code>return</code> has only one subform, then the
<code>prog</code> will return all of the values returned by that one subform.
</p>
<p><code>do</code> behaves like <code>prog</code> with respect to <code>return</code>.
All the values of the last <em>exit-form</em> are returned.
</p>
<p><code>unwind-protect</code> passes back multiple values from its protected form.
In a sense, this is an exception to the rule; but it is useful, and it
makes sense to consider the execution of the unwind forms as a byproduct of
unwinding the stack and not as part of sequential execution.
</p>
<p><code>*catch</code> does not pass back multiple values from the last form in its
body, because it is defined to return its own second value (see
<a href="#g_t_002acatch_002dfun">*catch-fun</a>) to tell you whether the <code>*catch</code> form was exited
normally or abnormally.  To do a catch and propagate multiple values,
use <code>catch-continuation</code>.
</p>
<a name="Evaluator-Errors"></a>
<h3 class="section">3.6 Evaluator Errors</h3>

<p>Here is a description of the error conditions that the evaluator can
signal.  This is for use by those who are writing condition handlers
(<a href="#condition_002dhandlers">condition-handlers</a>).  The novice should skip this section.
</p>
<dl>
<dt><a name="index-_0028error_0029-on-sys_003ainvalid_002dform"></a>Condition on sys:invalid-form: <strong>(<code>error</code>)</strong></dt>
<dd><p>This is signaled when <code>eval</code>&rsquo;s argument is not a recognizable kind of
form; the wrong data type, perhaps.  The condition instance supports the
operation <code>:form</code>, which returns the supposed form to be evaluated.
</p></dd></dl>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003ainvalid_002dfunction"></a>Condition on sys:invalid-function: <strong>(<code>error</code>)</strong></dt>
<dd><p>This is signaled when <code>eval</code> or <code>apply</code> finds an object that is
supposed to be applied to arguments, but it is not a valid Lisp function.
The condition instance supports the
operation <code>:function</code>, which returns the supposed function to be called.
</p>
<p>The <code>:new-function</code> proceed type is provided; it expects one argument,
a function to call instead.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003ainvalid_002dfunction-error_0029-on-sys_003ainvalid_002dlambda_002dlist"></a>Condition on sys:invalid-lambda-list: <strong>(<code>sys:invalid-function</code> <code>error</code>)</strong></dt>
<dd><p>This condition name is present in addition to <code>sys:invalid-function</code>
when the function to be called looks like an interpreted function, and
the only problem is the syntax of its lambda list.
</p></dd></dl>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003atoo_002dfew_002darguments"></a>Condition on sys:too-few-arguments: <strong>(<code>error</code>)</strong></dt>
<dd><p>This condition is signaled when a function is applied to too few arguments.
The condition instance supports the operations <code>:function</code> and
<code>:arguments</code> which return the function and the list of the arguments
provided.
</p>
<p>The proceed types <code>:additional-arguments</code> and <code>:new-argument-list</code>
are provided.  Both take one argument.  In the first case, the argument
is a list of arguments to pass in addition to the ones supplied.  In the
second, it is a list of arguments to replace the ones actually supplied.
</p></dd></dl>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003atoo_002dmany_002darguments"></a>Condition on sys:too-many-arguments: <strong>(<code>error</code>)</strong></dt>
<dd><p>This is similar to <code>sys:too-few-arguments</code>.  Instead of the
<code>:additional-arguments</code> proceed type, <code>:fewer-arguments</code> is
provided.  Its argument is a number, which is how many of the originally
supplied arguments to use in calling the function again.
</p></dd></dl>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003amissing_002dkeyword_002dargument"></a>Condition on sys:missing-keyword-argument: <strong>(<code>error</code>)</strong></dt>
<dd><p>This is signaled when a required keyword argument is missing.
The <code>:keyword</code> operation on the condition instance returns the missing keyword.
</p>
<p>The proceed type <code>:argument-value</code> is provided.  It expects one
argument, which is a value to use for the keyword argument.
</p></dd></dl>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003aundefined_002dkeyword_002dargument"></a>Condition on sys:undefined-keyword-argument: <strong>(<code>error</code>)</strong></dt>
<dd><p>This is signaled when a function that takes keyword arguments is given a
keyword that it does not accept and <code>&amp;allow-other-keys</code> was not
used.  The <code>:keyword</code> operation on the condition instance returns the
extraneous keyword, and the <code>:value</code> operation returns the value
supplied with it.
</p>
<p>The proceed type <code>:new-keyword</code> is provided.  It expects one
argument, which is a keyword to use instead of the one supplied.
</p></dd></dl>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003acell_002dcontents_002derror"></a>Flavor Condition on sys:cell-contents-error: <strong>(<code>error</code>)</strong></dt>
<dd><p>This condition name categorizes all the errors signaled because of
&quot;undefined&quot; objects found in memory.  It includes &quot;unbound&quot; variables,
&quot;undefined&quot; functions, and other things.
</p>
<dl compact="compact">
<dt><code>:address</code></dt>
<dd><p>A locative pointer to the referenced cell.
</p></dd>
<dt><code>:current-address</code></dt>
<dd><p>A locative pointer to the cell which currently contains the contents
that are found in the referenced cell when the erring stack group is
running.  This can be different from the original address in the case of
special variable bindings, which move between special PDLs and symbol
value cells.
</p></dd>
<dt><code>:cell-type</code></dt>
<dd><p>A keyword saying what type of cell was referred to: <code>:function</code>,
<code>:value</code>, <code>:closure</code>, or <code>nil</code> for a cell that is not one of
those.
</p></dd>
<dt><code>:containing-structure</code></dt>
<dd><p>The object (list, array, symbol) inside which the referenced memory cell is found.
</p></dd>
<dt><code>:data-type</code></dt>
<dt><code>:pointer</code></dt>
<dd><p>The data type and pointer fields of the contents of the memory cell, at
the time of the error.  Both are fixnums.
</p></dd>
</dl>

<p>The proceed type <code>:no-action</code> takes no argument.  If the cell&rsquo;s
contents are now valid, the program proceeds, using them.  Otherwise
the error happens again.
</p>
<p>The proceed type <code>:package-dwim</code> looks for symbols with the same name
in other packages; but only if the containing structure is a symbol.
</p>
<p>Two other proceed types take one argument: <code>:new-value</code> and <code>:store-new-value</code>.
The argument is used as the contents of the memory cell.
<code>:store-new-value</code> also permanently stores the argument into the cell.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003acell_002dcontents_002derror-error_0029-on-sys_003aunbound_002dvariable"></a>Condition on sys:unbound-variable: <strong>(<code>sys:cell-contents-error</code> <code>error</code>)</strong></dt>
<dd><p>This condition name categorizes all errors of variables which are unbound.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003aunbound_002dspecial_002dvariable-on-"></a>Condition on : <strong>sys:unbound-special-variable</strong></dt>
<dt><a name="index-sys_003aunbound_002dclosure_002dvariable-on-"></a>Condition on : <strong>sys:unbound-closure-variable</strong></dt>
<dt><a name="index-sys_003aunbound_002dinstance_002dvariable-on-"></a>Condition on : <strong>sys:unbound-instance-variable</strong></dt>
<dd><p>These condition names appear in addition to <code>sys:unbound-variable</code> to subcategorize
the kind of variable reference that the error happened in.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003acell_002dcontents_002derror-error_0029-on-sys_003aundefined_002dfunction"></a>Condition on sys:undefined-function: <strong>(<code>sys:cell-contents-error</code> <code>error</code>)</strong></dt>
<dd><p>This condition name categorizes errors of function specs that are undefined.
</p></dd></dl>

<a name="sys_003awrong_002dtype_002dargument_002dcondition"></a><dl>
<dt><a name="index-_0028error_0029-on-sys_003awrong_002dtype_002dargument"></a>Condition on sys:wrong-type-argument: <strong>(<code>error</code>)</strong></dt>
<dd><p>This is signaled when a function checks the type of its argument and
rejects it; for example, if you do <code>(car 1)</code>.
</p>
<p>The condition instance supports these extra operations:
</p><dl compact="compact">
<dt><code>:arg-name</code></dt>
<dd><p>The name of the argument that was erroneous.  This may be <code>nil</code> if
there is no name, or if the system no longer remembers which argument it
was.
</p></dd>
<dt><code>:old-value</code></dt>
<dd><p>The value that was supplied for the argument.
</p></dd>
<dt><code>:function</code></dt>
<dd><p>The function which received and rejected the argument.
</p></dd>
<dt><code>:description</code></dt>
<dd><p>A symbol which says what sort of object was expected for this argument.
</p></dd>
</dl>

<p>The proceed type <code>:argument-value</code> is provided; it expects one argument,
which is a value to use instead of the erroneous value.
</p></dd></dl>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003athrow_002dtag_002dnot_002dseen"></a>Condition on sys:throw-tag-not-seen: <strong>(<code>error</code>)</strong></dt>
<dd><p>This is signaled when <code>*throw</code> (or <code>*unwind-stack</code>) is used and
there is no <code>*catch</code> for the specified tag.  The condition instance
supports these extra operations:
</p><dl compact="compact">
<dt><code>:tag</code></dt>
<dd><p>The tag being thrown to.
</p></dd>
<dt><code>:value</code></dt>
<dd><p>The value being thrown (the second argument to <code>*throw</code>).
</p></dd>
<dt><code>:count</code></dt>
<dt><code>:action</code></dt>
<dd><p>The additional two arguments given to <code>*unwind-stack</code>, if that was used.
</p></dd>
</dl>

<p>The error occurs in the environment of the <code>*throw</code>; no unwinding has yet taken place.
</p>
<p>The proceed type <code>:new-tag</code> expects one argument, a tag to throw to instead.
</p></dd></dl>

<a name="Flow-of-Control"></a>
<h2 class="chapter">4 Flow of Control</h2>
<a name="flow_002dchapter"></a><a name="index-control-structure"></a>
<a name="index-flow-of-control"></a>
<p>Lisp provides a variety of structures for flow of control.
</p>
<p>Function application is the basic method for construction of
programs.  Operations are written as the application of a function
to its arguments.  Usually, Lisp programs are written as a large collection
of small functions, each of which implements a simple operation.
These functions operate by calling one another, and so larger
operations are defined in terms of smaller ones.
</p>
<a name="index-_0022recursion_0022"></a>
<p>A function may always call itself in Lisp.  The calling of
a function by itself is known as <em>recursion</em>; it is analogous
to mathematical induction.
</p>
<a name="index-_0022iteration_0022"></a>
<p>The performing of an action repeatedly (usually with some
changes between repetitions) is called <em>iteration</em>, and is provided as
a basic control structure in most languages.  The <em>do</em> statement of
PL/I, the <em>for</em> statement of ALGOL/60, and so on are examples of
iteration primitives.  Lisp provides two general iteration facilities:
<code>do</code> and <code>loop</code>, as well as a variety of special-purpose iteration
facilities.  (<code>loop</code> is sufficiently complex that it is explained
in its own chapter later in the manual; see <a href="#loop_002dfun">loop-fun</a>.)  There is also
a very general construct to allow the traditional &quot;goto&quot; control structure,
called <code>prog</code>.
</p>
<a name="index-_0022conditional_0022"></a>
<p>A <em>conditional</em> construct is one which allows a program
to make a decision, and do one thing or another based on some logical
condition.  Lisp provides the simple one-way conditionals <code>and</code> and <code>or</code>,
the simple two-way conditional <code>if</code>, and more general multi-way
conditionals such as <code>cond</code> and <code>selectq</code>.
The choice of which form to use in any particular situation is a matter
of personal taste and style.
</p>
<a name="index-_0022non_002dlocal-exit_0022"></a>
<a name="index-_0022exit_0022"></a>
<p>There are some <em>non-local exit</em> control structures, analogous
to the <em>leave</em>, <em>exit</em>, and <em>escape</em> constructs in many modern
languages.
The general ones are <code>*catch</code> and <code>*throw</code>; there is also <code>return</code>
and its variants, used for exiting the iteration constructs <code>do</code>, <code>loop</code>,
and <code>prog</code>.
</p>
<p>Zetalisp also provides a coroutine capability,
explained in the section on <em>stack-groups</em> (<a href="#stack_002dgroup">stack-group</a>), and
a multiple-process facility (see <a href="#process">process</a>).  There is also a facility
for generic function calling using message passing; see <a href="#flavor">flavor</a>.
</p>
<a name="g_t_0022Conditionals_0022"></a>
<h3 class="section">4.1 &quot;Conditionals&quot;</h3>

<a name="if_002dfun"></a><dl>
<dt><a name="index-if"></a>Special Form: <strong>if</strong></dt>
<dd><p><code>if</code> is the simplest conditional form.  The &quot;if-then&quot; form looks like:
</p><div class="lisp">
<pre class="lisp">(if <em>predicate-form</em> <em>then-form</em>)
</pre></div>
<p><em>predicate-form</em> is evaluated, and if the result is non-<code>nil</code>, the
<em>then-form</em> is evaluated and its result is returned.  Otherwise, <code>nil</code>
is returned.
</p>
<p>In the &quot;if-then-else&quot; form, it looks like
</p><div class="lisp">
<pre class="lisp">(if <em>predicate-form</em> <em>then-form</em> <em>else-form</em>)
</pre></div>
<p><em>predicate-form</em> is evaluated, and if the result is non-<code>nil</code>, the
<em>then-form</em> is evaluated and its result is returned.  Otherwise, the
<em>else-form</em> is evaluated and its result is returned.
</p>
<p>If there are more than three subforms, <code>if</code> assumes you want more than
one <em>else-form</em>; if the predicate returns <code>nil</code>, they are evaluated
sequentially and the result of the last one is returned.
</p></dd></dl>

<a name="when_002dfun"></a><dl>
<dt><a name="index-when"></a>Special Form: <strong>when</strong> <em>condition body...</em></dt>
<dd><p>If <em>condition</em> evaluates to something non-<code>nil</code>, the <em>body</em> is
executed and its value(s) returned.  Otherwise, the value of the <code>when</code>
is <code>nil</code> and the <em>body</em> is not executed.
</p></dd></dl>

<a name="unless_002dfun"></a><dl>
<dt><a name="index-unless"></a>Special Form: <strong>unless</strong> <em>condition body...</em></dt>
<dd><p>If <em>condition</em> evaluates to <code>nil</code>, the <em>body</em> is
executed and its value(s) returned.  Otherwise, the value of the <code>unless</code>
is <code>nil</code> and the <em>body</em> is not executed.
</p></dd></dl>

<a name="cond_002dfun"></a><dl>
<dt><a name="index-cond"></a>Special Form: <strong>cond</strong></dt>
<dd><p>The <code>cond</code> special form consists of the symbol <code>cond</code> followed by
several <em>clauses</em>.  Each clause consists of a predicate form, called
the <em>antecedent</em>, followed by zero or more <em>consequent</em> forms.
</p>
<div class="lisp">
<pre class="lisp">(cond (<em>antecedent consequent consequent</em>...)
      (<em>antecedent</em>)
      (<em>antecedent consequent</em> ...)
      ... )
</pre></div>

<p>The idea is that each clause represents a case which
is selected if its antecedent is satisfied and the antecedents
of all preceding clauses were not satisfied.  When a clause
is selected, its consequent forms are evaluated.
</p>
<p><code>cond</code> processes its clauses in order from left to right.  First,
the antecedent of the current clause is evaluated.  If the result is
<code>nil</code>, <code>cond</code> advances to the next clause.  Otherwise, the cdr of
the clause is treated as a list of consequent forms which are
evaluated in order from left to right.  After evaluating the
consequents, <code>cond</code> returns without inspecting any remaining
clauses.  The value of the <code>cond</code> special form is the value of the
last consequent evaluated, or the value of the antecedent if there
were no consequents in the clause.  If <code>cond</code> runs out of clauses,
that is, if every antecedent evaluates to <code>nil</code>, and thus no case is
selected, the value of the <code>cond</code> is <code>nil</code>. 
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">    (cond ((zerop x)    ;<span class="roman">First clause:</span>
           (+ y 3))     ; (zerop x)<span class="roman"> is the antecedent.</span>
                        ; (+ y 3)<span class="roman"> is the consequent.</span>
          ((null y)     ;<span class="roman">A clause with 2 consequents:</span>
           (setq y 4)   ;<span class="roman"> this</span>
           (cons x z))  ;<span class="roman"> and this.</span>
          (z)           ;<span class="roman">A clause with no consequents: the antecedent is </span>
			;<span class="roman"> just <code>z</code>.  If <code>z</code> is non-<code>nil</code>, it will be returned.</span>
	  (t		;<span class="roman">An antecedent of </span>t
	   105)		;<span class="roman"> is always satisfied.</span>
       )		;<span class="roman">This is the end of the cond.</span>
</pre></div>
</dd></dl>

<a name="cond_002devery_002dfun"></a><dl>
<dt><a name="index-cond_002devery"></a>Special Form: <strong>cond-every</strong></dt>
<dd><p><code>cond-every</code> has the same syntax as <code>cond</code>, but executes every clause whose
predicate is satisfied, not just the first.  If a predicate is the symbol
<code>otherwise</code>, it is satisfied if and only if no preceding predicate is
satisfied.  The value returned
is the value of the last consequent form in the last clause whose predicate
is satisfied.  Multiple values are not returned.
</p></dd></dl>


<a name="and_002dfun"></a><dl>
<dt><a name="index-and"></a>Special Form: <strong>and</strong> <em>form...</em></dt>
<dd><p><code>and</code> evaluates the <em>form</em>s one at a time,
from left to right.  If any <em>form</em> evaluates to <code>nil</code>, <code>and</code>
immediately returns <code>nil</code> without evaluating the remaining
<em>forms</em>.  If all the <em>forms</em> evaluate to non-<code>nil</code> values, <code>and</code> returns
the value of the last <em>form</em>.
</p>
<p><code>and</code> can be used in two different ways.  You can use it as a logical
<code>and</code> function, because it returns a true value only if all of its
arguments are true.  So you can use it as a predicate:
</p><div class="lisp">
<pre class="lisp">(if (and socrates-is-a-person
         all-people-are-mortal)
    (setq socrates-is-mortal t))
</pre></div>

<p>Because the order of evaluation is well-defined, you can do
</p><div class="lisp">
<pre class="lisp">(if (and (boundp 'x)
         (eq x 'foo))
    (setq y 'bar))
</pre></div>
<p>knowing that the <code>x</code> in the <code>eq</code> form will not be evaluated if <code>x</code>
is found to be unbound.
</p>
<p>You can also use <code>and</code> as a simple conditional form:
</p><div class="lisp">
<pre class="lisp">(and (setq temp (assq x y))
     (rplacd temp z))
</pre></div>
<div class="lisp">
<pre class="lisp">(and bright-day
     glorious-day
     (princ &quot;It is a bright and glorious day.&quot;))
</pre></div>

<p>Note: <code>(and) =&gt; t</code>, which is the identity for the <code>and</code> operation.
</p></dd></dl>

<a name="or_002dfun"></a><dl>
<dt><a name="index-or"></a>Special Form: <strong>or</strong> <em>form...</em></dt>
<dd><p><code>or</code> evaluates the <em>form</em>s one by one from left to right.
If a <em>form</em> evaluates to <code>nil</code>, <code>or</code> proceeds to evaluate the
next <em>form</em>.  If there are no more <em>form</em>s, <code>or</code> returns <code>nil</code>.
But if a <em>form</em> evaluates to a non-<code>nil</code> value, <code>or</code> immediately returns
that value without evaluating any remaining <em>form</em>s.
</p>
<p>As with <code>and</code>, <code>or</code> can be used either as a logical <code>or</code> function,
or as a conditional.
</p><div class="lisp">
<pre class="lisp">(or it-is-fish
    it-is-fowl
    (print &quot;It is neither fish nor fowl.&quot;))
</pre></div>
<a name="index-fish"></a>

<p>Note:  <code>(or) =&gt; nil</code>, the identity for this operation.
</p></dd></dl>

<a name="selectq_002dfun"></a><dl>
<dt><a name="index-selectq"></a>Special Form: <strong>selectq</strong></dt>
<dd><p><code>selectq</code> is a conditional which chooses one of its clauses to execute
by comparing the value of a form against various constants, which are
typically keyword symbols.
Its form is as follows:
</p><div class="lisp">
<pre class="lisp">(selectq <em>key-form</em>
  (<em>test consequent consequent</em> ...)
  (<em>test consequent consequent</em> ...)
  (<em>test consequent consequent</em> ...)
  ...)
</pre></div>
<p>The first thing <code>selectq</code> does is to evaluate <em>key-form</em>; call the resulting
value <em>key</em>.  Then <code>selectq</code> considers
each of the clauses in turn.  If <em>key</em> matches the clause&rsquo;s
<em>test</em>, the consequents of this
clause are evaluated, and <code>selectq</code> returns the value of the last
consequent.  If there are no matches, <code>selectq</code> returns <code>nil</code>.
</p>
<p>A <em>test</em> may be any of:
</p><dl compact="compact">
<dt><span class="roman">1) A symbol</span></dt>
<dd><p>If the <em>key</em> is <code>eq</code> to the symbol, it matches.
</p></dd>
<dt><span class="roman">2) A number</span></dt>
<dd><p>If the <em>key</em> is <code>eq</code> to the number, it matches.
Only small numbers (<em>fixnums</em>) will work.
</p></dd>
<dt><span class="roman">3) A list</span></dt>
<dd><p>If the <em>key</em> is <code>eq</code> to one of the elements of the list,
then it matches.  The elements of the list should be symbols
or fixnums.
</p></dd>
<dt><span class="roman">4) <code>t</code> or <code>otherwise</code></span></dt>
<dd><p>The symbols <code>t</code> and <code>otherwise</code> are special keywords which match anything.  
Either symbol may be used, it makes no difference;
<code>t</code> is mainly for compatibility with Maclisp&rsquo;s <code>caseq</code> construct.
To be useful, this should be the last clause in the <code>selectq</code>.
</p></dd>
</dl>

<p>Note that the <em>tests</em> are <em>not</em> evaluated; if you want them to
be evaluated use <code>select</code> rather than <code>selectq</code>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(selectq x
  (foo (do-this))
  (bar (do-that))
  ((baz quux mum) (do-the-other-thing))
  (otherwise (ferror nil &quot;Never heard of ~S&quot; x)))
</pre></div>
<p>is equivalent to
</p><div class="lisp">
<pre class="lisp">(cond ((eq x 'foo) (do-this))
      ((eq x 'bar) (do-that))
      ((memq x '(baz quux mum)) (do-the-other-thing))
      (t (ferror nil &quot;Never heard of ~S&quot; x)))
</pre></div>
</dd></dl>

<p>Also see <code>defselect</code> (<a href="#defselect_002dfun">defselect-fun</a>), a special form for defining a function
whose body is like a <code>selectq</code>.
</p>
<a name="select_002dfun"></a><dl>
<dt><a name="index-select"></a>Special Form: <strong>select</strong></dt>
<dd><p><code>select</code> is the same as <code>selectq</code>, except that the elements of the
<em>tests</em> are evaluated before they are used.
</p>
<p>This creates a syntactic ambiguity: if <code>(bar baz)</code> is seen the
first element of a clause, is it a list of two forms, or is it one
form?  <code>select</code> interprets it as a list of two forms.  If you
want to have a clause whose test is a single form, and that form
is a list, you have to write it as a list of one form.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(select (frob x)
   (foo 1)
   ((bar baz) 2)
   (((current-frob)) 4)
   (otherwise 3))
</pre></div>
<p>is equivalent to
</p><div class="lisp">
<pre class="lisp">(let ((var (frob x)))
  (cond ((eq var foo) 1)
	((or (eq var bar) (eq var baz)) 2)
	((eq var (current-frob)) 4)
	(t 3)))
</pre></div>
</dd></dl>

<a name="selector_002dfun"></a><dl>
<dt><a name="index-selector"></a>Special Form: <strong>selector</strong></dt>
<dd><p><code>selector</code> is the same as <code>select</code>, except that you get to specify the function
used for the comparison instead of <code>eq</code>.  For example,
</p><div class="lisp">
<pre class="lisp">(selector (frob x) equal
   (('(one . two)) (frob-one x))
   (('(three . four)) (frob-three x))
   (otherwise (frob-any x)))
</pre></div>
<p>is equivalent to
</p><div class="lisp">
<pre class="lisp">(let ((var (frob x)))
  (cond ((equal var '(one . two)) (frob-one x))
	((equal var '(three . four)) (frob-three x))
	(t (frob-any x))))
</pre></div>
</dd></dl>

<a name="select_002dmatch_002dfun"></a><dl>
<dt><a name="index-select_002dmatch"></a>Special Form: <strong>select-match</strong></dt>
<dd><p><code>select-match</code> is like <code>select</code> but each clause can specify a pattern
to match the key against.  The general form of use looks like
</p><div class="lisp">
<pre class="lisp">(select-match <em>key-form</em>
  (<em>pattern</em> <em>condition</em> <em>body</em>...)
  (<em>pattern</em> <em>condition</em> <em>body</em>...)
  ...
  (otherwise <em>body</em>...))
</pre></div>

<p>The value of <em>key-form</em> is matched against the <em>pattern</em>s one at a time
until a match succeeds and the accompanying <em>condition</em> evaluates to
something non-<code>nil</code>.  At this point the <em>body</em> of that clause is
executed and its value(s) returned.
</p>
<p>The <em>pattern</em>s can be arbitrary s-expressions, with variables signified
by <code>#?</code><em>variable</em>.  When the <em>pattern</em> is matched against the object, the
variables are to bound to their matched values.  Different occurrences of
the same variable in a given pattern must match to the same thing, so that
</p><div class="lisp">
<pre class="lisp">(select-match '(a b c) 
  ((#?x b #?x) t 'lose)
  ((#?x b #?y) t 'win)
  (otherwise 'lose-big))
</pre></div>
<p>returns <code>win</code>.  The variables mentioned in the <em>pattern</em>s need not be bound by
the user; they are bound by the expression resulting from the expansion of the
<code>select-match</code>.
</p>
<p>The expression <code>#?ignore</code> or <code>#?nil</code> matches everything and binds no variable.
<code>#?nil</code> is preferred.
</p></dd></dl>

<a name="dispatch_002dfun"></a><dl>
<dt><a name="index-dispatch"></a>Special Form: <strong>dispatch</strong></dt>
<dd><p><code>(dispatch <em>byte-specifier</em> <em>number</em> <em>clauses...</em>)</code> is the same
as <code>select</code> (not <code>selectq</code>), but the key is obtained by evaluating
<code>(ldb <em>byte-specifier number</em>)</code>.
<em>byte-specifier</em> and <em>number</em> are both evaluated.  Byte specifiers
and <code>ldb</code> are explained on <a href="#ldb_002dfun">ldb-fun</a>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(princ (dispatch 0202 cat-type
	   (0 &quot;Siamese.&quot;)
	   (1 &quot;Persian.&quot;)
	   (2 &quot;Alley.&quot;)
	   (3 (ferror nil
		      &quot;~S is not a known cat type.&quot;
		      cat-type))))
</pre></div>
<a name="index-kitty"></a>

<p>It is not necessary to include all possible values of the byte which
will be dispatched on.
</p></dd></dl>

<a name="selectq_002devery_002dfun"></a><dl>
<dt><a name="index-selectq_002devery"></a>Special Form: <strong>selectq-every</strong></dt>
<dd><p><code>selectq-every</code> has the same syntax as <code>selectq</code>, but, like
<code>cond-every</code>, executes every selected clause instead of just the first
one.  If an <code>otherwise</code> clause is present, it is selected if and only
if no preceding clause is selected.  The value returned is the value of
the last form in the last selected clause.  Multiple values are not
returned.  Example:
</p><div class="lisp">
<pre class="lisp">(selectq-every animal
  ((cat dog) (setq legs 4))
  ((bird man) (setq legs 2))
  ((cat bird) (put-in-oven animal))
  ((cat dog man) (beware-of animal)))
</pre></div>
</dd></dl>

<a name="caseq_002dfun"></a><dl>
<dt><a name="index-caseq"></a>Special Form: <strong>caseq</strong></dt>
<dd><p>The <code>caseq</code> special form is provided for Maclisp compatibility.  It
is exactly the same as <code>selectq</code>.  This is not perfectly compatible
with Maclisp, because <code>selectq</code> accepts <code>otherwise</code> as well as <code>t</code>
where <code>caseq</code> would not accept <code>otherwise</code>, and because Maclisp
does some error-checking that <code>selectq</code> does not.  Maclisp programs
that use <code>caseq</code> will work correctly so long as they don&rsquo;t use the
symbol <code>otherwise</code> as the key.
</p></dd></dl>

<a name="g_t_0022Iteration_0022"></a>
<h3 class="section">4.2 &quot;Iteration&quot;</h3>
<a name="index-_0022iteration_0022-1"></a>

<a name="do_002dfun"></a><dl>
<dt><a name="index-do"></a>Special Form: <strong>do</strong></dt>
<dd><p>The <code>do</code> special form provides a simple generalized iteration facility,
with an arbitrary number of &quot;index variables&quot; whose values are saved
when the <code>do</code> is entered and restored when it is left, ie they are
bound by the <code>do</code>.  The index variables are used in the iteration
performed by <code>do</code>.  At the beginning, they are initialized to
specified values, and then at the end of each trip around the loop the
values of the index variables are changed according to specified
rules.  <code>do</code> allows the programmer to specify a predicate which
determines when the iteration will terminate.  The value to be
returned as the result of the form may, optionally, be specified. 
</p>
<p><code>do</code> comes in two varieties.
</p>
<p>The more general, so-called &quot;new-style&quot; <code>do</code> looks like:
</p><div class="lisp">
<pre class="lisp">(do ((<em>var init repeat</em>) ...)
  (<em>end-test exit-form</em> ...)
  <em>body</em>...)
</pre></div>

<p>The first item in the form is a list of zero or more index variable
specifiers.  Each index variable specifier is a list of the name of a
variable <em>var</em>, an initial value form <em>init</em>, which defaults to <code>nil</code>
if it is omitted, and a repeat value form <em>repeat</em>.  If <em>repeat</em> is
omitted, the <em>var</em> is not changed between repetitions.  If <em>init</em> is
omitted, the <em>var</em> is initialized to <code>nil</code>.
</p>
<p>An index variable specifier can also be just the name of a variable,
rather than a list.  In this case, the variable has an initial value of
<code>nil</code>, and is not changed between repetitions.
</p>
<p>All assignment to the index variables is done in parallel.  At the
beginning of the first iteration, all the <em>init</em> forms are evaluated,
then the <em>vars</em> are bound to the values of the <em>init</em> forms, their
old values being saved in the usual way.  Note that the <em>init</em> forms
are evaluated <em>before</em> the <em>vars</em> are bound, ie  lexically
<em>outside</em> of the <code>do</code>.  At the beginning of each succeeding
iteration those <em>vars</em> that have <em>repeat</em> forms get set to the
values of their respective <em>repeat</em> forms.  Note that all the
<em>repeat</em> forms are evaluated before any of the <em>vars</em> is set.
</p>
<p>The second element of the <code>do</code>-form is a list of an end-testing
predicate form <em>end-test</em>, and zero or more forms, called the
<em>exit-forms</em>.  This resembles a <code>cond</code> clause.  At the beginning of
each iteration, after processing of the variable specifiers, the
<em>end-test</em> is evaluated.  If the result is <code>nil</code>, execution proceeds
with the body of the <code>do</code>.  If the result is not <code>nil</code>, the
<em>exit-forms</em> are evaluated from left to right and then <code>do</code> returns.
The value of the <code>do</code> is the value of the last <em>exit-form</em>, or
<code>nil</code> if there were no <em>exit-forms</em> (<em>not</em> the value of the
<em>end-test</em>, as you might expect by analogy with <code>cond</code>).
</p>
<p>Note that the <em>end-test</em> gets evaluated before the first time the body
is evaluated.  <code>do</code> first initializes the variables from the <em>init</em>
forms, then it checks the <em>end-test</em>, then it processes the body, then
it deals with the <em>repeat</em> forms, then it tests the <em>end-test</em>
again, and so on.  If the <code>end-test</code> returns a non-<code>nil</code> value the
first time, then the body will never be processed.
</p>
<p>If the second element of the form is <code>nil</code>, there is no <em>end-test</em>
nor <em>exit-forms</em>, and the <em>body</em> of the <code>do</code> is executed only
once.  In this type of <code>do</code> it is an error to have <em>repeats</em>.  This
type of <code>do</code> is no more powerful than <code>let</code>; it is obsolete
and provided only for Maclisp compatibility.
</p>
<p>If the second element of the form is <code>(nil)</code>, the <em>end-test</em> is
never true and there are no <em>exit-forms</em>.  The <em>body</em> of the <code>do</code>
is executed over and over.  The infinite loop can be terminated by use
of <code>return</code> or <code>*throw</code>.
</p>
<p>If a <code>return</code> special form is evaluated inside the body of a <code>do</code>,
then the <code>do</code> immediately stops, unbinds its variables, and returns
the values given to <code>return</code>.  See <a href="#return_002dfun">return-fun</a> for more details
about <code>return</code> and its variants.  <code>go</code> special forms (see <a href="#go_002dfun">go-fun</a>)
and <code>prog</code>-tags can also be used inside the body of a <code>do</code> and they mean the same
thing that they do inside <code>prog</code> forms, but we
discourage their use since they complicate the control structure in
a hard-to-understand way.
</p>
<p>The other, so-called &quot;old-style&quot; <code>do</code> looks like:
</p><div class="lisp">
<pre class="lisp">(do <em>var</em> <em>init</em> <em>repeat</em> <em>end-test</em> <em>body</em>...)
</pre></div>
<p>The first time through the loop <em>var</em> gets the value of the <em>init</em> form; 
the remaining times through the loop it gets the value of the <em>repeat</em> form,
which is re-evaluated each time.  Note that the <em>init</em> form is evaluated
before <em>var</em> is bound, ie lexically <em>outside</em> of the <code>do</code>.
Each time around the loop, after <em>var</em> is set,
<em>end-test</em> is evaluated.  If it is non-<code>nil</code>, the <code>do</code> finishes
and returns <code>nil</code>.  If the <em>end-test</em> evaluated to <code>nil</code>, the <em>body</em> of
the loop is executed. As with the new-style do, <code>return</code> and <code>go</code>
may be used in the body, and they have the same meaning.
</p>
<div class="lisp">
<pre class="lisp">Examples of the older variety of <code>do</code>:
</pre><pre class="lisp">(setq n (array-length foo-array))
(do i 0 (1+ i) (= i n)
  (aset 0 foo-array i))		<span class="roman">;zeroes out the array foo-array</span>

(do zz x (cdr zz) (or (null zz)
		      (zerop (f (car zz)))))<span class="roman">
                   ; this applies f to each element of x
                   ; continuously until f returns zero.
		   ; Note that the <code>do</code> has no body.</span>

<span class="roman"><code>return</code> forms are often useful to do simple searches:</span>
</pre></div>
<div class="lisp">
<pre class="lisp">(do i 0 (1+ i) (= i n)	<span class="roman">; Iterate over the length of <code>foo-array</code>.</span>
  (and (= (aref foo-array i) 5)	<span class="roman">; If we find an element which</span>
				<span class="roman">; equals <code>5</code>,</span>
       (return i)))             <span class="roman">;  then return its index.</span>

</pre></div>
<div class="lisp">
<pre class="lisp">Examples of the new form of <code>do</code>:
</pre><pre class="lisp">(do ((i 0 (1+ i))	<span class="roman">; This is just the same as the above example,</span>
     (n (array-length foo-array)))
    ((= i n))		<span class="roman">; but written as a new-style <code>do</code>.</span>
  (aset 0 foo-array i))	<span class="roman">; Note how the <code>setq</code> is avoided.</span>
</pre></div>
<div class="lisp">
<pre class="lisp">

(do ((z list (cdr z)) <span class="roman">; z starts as <code>list</code> and is cdr&rsquo;d each time.</span>
     (y other-list)   <span class="roman">; y starts as <code>other-list</code>, and is unchanged by the do.</span>
     (x)	      <span class="roman">; x starts as <code>nil</code> and is not changed by the <code>do</code>.</span>
     w) 	      <span class="roman">; w starts as <code>nil</code> and is not changed by the <code>do</code>.</span>
    (nil)	      <span class="roman">; The end-test is <code>nil</code>, so this is an infinite loop.</span>
  <em>body</em>)           <span class="roman">; Presumably the <em>body</em> uses <code>return</code> somewhere.</span>
</pre></div>

<p>The construction
</p><div class="lisp">
<pre class="lisp">(do ((x e (cdr x))
     (oldx x x))
    ((null x))
  <em>body</em>)
</pre></div>
<p>exploits parallel assignment to index variables.  On the first
iteration, the value of <code>oldx</code> is whatever value <code>x</code> had before
the <code>do</code> was entered.  On succeeding iterations, <code>oldx</code> contains
the value that <code>x</code> had on the previous iteration. 
</p>
<p>In either form of <code>do</code>, the <em>body</em> may contain no forms at all.
Very often an iterative algorithm can be most clearly expressed entirely
in the <em>repeats</em> and <em>exit-forms</em> of a new-style <code>do</code>,
and the <em>body</em> is empty.
</p>
<div class="lisp">
<pre class="lisp">(do ((x x (cdr x))
     (y y (cdr y))
     (z nil (cons (f x y) z))) ;<span class="roman">exploits parallel assignment.</span>
    ((or (null x) (null y))
     (nreverse z))             ;<span class="roman">typical use of </span>nreverse.
    )                          ;<span class="roman">no <code>do</code>-body required.</span>

<span class="roman">is like</span> (maplist 'f x y) <span class="roman">(see <a href="#maplist_002dfun">maplist-fun</a>)</span>.
</pre></div>
</dd></dl>

<p>Also see <code>loop</code> (<a href="#loop_002dfun">loop-fun</a>), a general iteration facility based on a keyword
syntax rather than a list-structure syntax.
</p>
<a name="do_002a_002dfun"></a><dl>
<dt><a name="index-do_002a"></a>Special Form: <strong>do*</strong></dt>
<dd><p>In a word, <code>do*</code> is to <code>do</code> as <code>prog*</code> is to <code>prog</code>.
</p>
<p><code>do*</code> works like <code>do</code> but binds and steps the variables sequentially
instead of in parallel.  This means that the <em>init</em> form for one
variable can use the values of previous variables.  The <em>repeat</em> forms
refer to the new values of previous variables instead of their old
values.  Here is an example:
</p><div class="lisp">
<pre class="lisp">(do* ((x xlist (cdr x))
      (y (car x) (car x)))
  (print (list x y)))
</pre></div>
<p>On each iteration, <em>y</em>&rsquo;s value will be the car of <em>x</em>.  The same
construction with <code>do</code> would get an error on entry since <em>x</em>
would not have an old value yet.
</p></dd></dl>

<a name="do_002dnamed_002dfun"></a><dl>
<dt><a name="index-do_002dnamed"></a>Special Form: <strong>do-named</strong></dt>
<dd><p>Sometimes one <code>do</code> is contained inside the body of an outer <code>do</code>.
The <code>return</code> function always returns from the innermost surrounding
<code>do</code>, but sometimes you want to return from an outer <code>do</code> while
within an inner <code>do</code>.  You can do this by giving the outer <code>do</code> a
name.  You use <code>do-named</code> instead of <code>do</code> for the outer <code>do</code>, and
use <code>return-from</code> (see <a href="#return_002dfrom_002dfun">return-from-fun</a>), specifying that name, to
return from the <code>do-named</code>.
</p>
<p>The syntax of <code>do-named</code> is like <code>do</code> except that the symbol <code>do</code> is
immediately followed by the name, which should be a symbol.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(do-named george ((a 1 (1+ a))
		  (d 'foo))
		 ((&gt; a 4) 7)
  (do ((c b (cdr c)))
      ((null c))
    ...
    (return-from george (cons b d))
    ...))
</pre></div>

<p>If the symbol <code>t</code> is used as the name, then it will be made
&quot;invisible&quot; to <code>return</code>s; that is, <code>return</code>s inside that <code>do-named</code>
will return to the next outermost level whose name is not <code>t</code>.
<code>(return-from t ...)</code> will return from a <code>do-named</code> named <code>t</code>.  This
feature is not intended to be used by user-written code; it is for
macros to expand into.
</p>
<p>If the symbol <code>nil</code> is used as the name, it is as if this were a
regular <code>do</code>.  Not having a name is the same as being named <code>nil</code>.
</p>
<p><code>prog</code>s and <code>loop</code>s can have names just as <code>do</code>s can.  Since the
same functions are used to return from all of these forms, all of these
names are in the same name-space; a <code>return</code> returns from the
innermost enclosing iteration form, no matter which of these it is, and
so you need to use names if you nest any of them within any other and
want to return to an outer one from inside an inner one.
</p></dd></dl>

<a name="do_002a_002dnamed_002dfun"></a><dl>
<dt><a name="index-do_002a_002dnamed"></a>Special Form: <strong>do*-named</strong></dt>
<dd><p>This special form offers a combination of the features of <code>do*</code> and
those of <code>do-named</code>.
</p></dd></dl>

<a name="dotimes_002dfun"></a><dl>
<dt><a name="index-dotimes"></a>Special Form: <strong>dotimes</strong> <em>(index count [value-expression]) body...</em></dt>
<dd><p><code>dotimes</code> is a convenient abbreviation for the most common integer
iteration.  <code>dotimes</code> performs <em>body</em> the number of times given by
the value of <em>count</em>, with <em>index</em> bound to <code>0</code>, <code>1</code>, etc. on
successive iterations.  When the <em>count</em> is exhausted, the value of
<em>value-expression</em> is returned; or <code>nil</code>, if <em>value-expression</em>
is missing.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(dotimes (i (// m n))
  (frob i))
</pre></div>
<p>is equivalent to:
</p><div class="lisp">
<pre class="lisp">(do ((i 0 (1+ i))
     (count (// m n)))
    (( i count))
  (frob i))
</pre></div>
<p>except that the name <code>count</code> is not used.  Note that <code>i</code> takes on
values starting at zero rather than one, and that it stops before
taking the value <code>(// m n)</code> rather than after.  You can use
<code>return</code> and <code>go</code> and <code>prog</code>-tags inside the body, as with
<code>do</code>.  <code>dotimes</code> forms return <code>nil</code> or the value of
<em>value-expression</em> unless returned from explicitly with <code>return</code>.
For example:
</p><div class="lisp">
<pre class="lisp">(dotimes (i 5)
  (if (eq (aref a i) 'foo)
      (return i)))
</pre></div>
<p>This form searches the array that is the value of <code>a</code>, looking for
the symbol <code>foo</code>.  It returns the fixnum index of the first element
of <code>a</code> that is <code>foo</code>, or else <code>nil</code> if none of the elements
are <code>foo</code>.
</p></dd></dl>

<a name="dolist_002dfun"></a><dl>
<dt><a name="index-dolist"></a>Special Form: <strong>dolist</strong> <em>(item list [value-expression]) body...</em></dt>
<dd><p><code>dolist</code> is a convenient abbreviation for the most common list
iteration.  <code>dolist</code> performs <em>body</em> once for each element in the
list which is the value of <em>list</em>, with <em>item</em> bound to the
successive elements.  If the list is exhausted, the value of
<em>value-expression</em> is returned; or <code>nil</code>, if
<em>value-expression</em> is missing.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(dolist (item (frobs foo))
  (mung item))
</pre></div>
<p>is equivalent to:
</p><div class="lisp">
<pre class="lisp">(do ((lst (frobs foo) (cdr lst))
     (item))
    ((null lst))
  (setq item (car lst))
  (mung item))
</pre></div>
<p>except that the name <code>lst</code> is not used.
You can use <code>return</code> and <code>go</code> and <code>prog</code>-tags inside the body, as with <code>do</code>.
</p></dd></dl>

<a name="do_002dforever_002dfun"></a><dl>
<dt><a name="index-do_002dforever"></a>Special Form: <strong>do-forever</strong> <em>body...</em></dt>
<dd><p>Executes the forms in the body over and over, or until one exits with
<code>return</code>.
</p></dd></dl>

<a name="index-keywords-in-argument-lists"></a>

<a name="keyword_002dextract_002dfun"></a><dl>
<dt><a name="index-keyword_002dextract"></a>Special Form: <strong>keyword-extract</strong></dt>
<dd><p><code>keyword-extract</code> is a semi-obsolete method of decoding keyword
arguments, used before <code>&amp;key</code> (see <a href="#g_t_0026key">&amp;key</a>) was implemented.  The form
</p><div class="lisp">
<pre class="lisp">(keyword-extract <em>key-list</em> <em>iteration-var</em>
	<em>keywords</em> <em>flags</em> <em>other-clauses</em>...)
</pre></div>
<p>will parse the keywords out into local variables of the function.  <em>key-list</em>
is a form which evaluates to the list of keyword arguments; it is generally the
function&rsquo;s <code>&amp;rest</code> argument.  <em>iteration-var</em> is a variable used to iterate
over the list; sometimes <em>other-clauses</em> will use the form
</p><div class="lisp">
<pre class="lisp">(car (setq <em>iteration-var</em> (cdr <em>iteration-var</em>)))
</pre></div>
<p>to extract the next element of the list.  (Note that this is not the same as <code>pop</code>,
because it does the car after the cdr, not before.)
</p>
<p><em>keywords</em> defines the symbols which are keywords to be followed by an argument.
Each element of <em>keywords</em> is either the name of a local variable which receives
the argument and is also the keyword, or a list of the keyword and the variable, for
use when they are different or the keyword is not to go in the keyword package.
Thus if <em>keywords</em> is <code>(foo (ugh bletch) bar)</code> then the keywords recognized
will be <code>:foo</code>, <code>ugh</code>, and <code>:bar</code>.  If <code>:foo</code> is specified its argument
will be stored into <code>foo</code>.  If <code>:bar</code> is specified its argument will be stored
into <code>bar</code>.  If <code>ugh</code> is specified its argument will be stored into <code>bletch</code>.
</p>
<p>Note that <code>keyword-extract</code> does not bind these local variables; it assumes you
will have done that somewhere else in the code that contains the <code>keyword-extract</code> form.
</p>
<p><em>flags</em> defines the symbols which are keywords not followed by an argument.
If a flag is seen its corresponding variable is set to <code>t</code>.  (You are assumed to
have initialized it to <code>nil</code> when you bound it with <code>let</code> or <code>&amp;aux</code>.)
As in <em>keywords</em>, an element of <em>flags</em> may be either a variable from
which the keyword is deduced, or a list of the keyword and the variable.
Note: this style of calling convention is now considered undesirable.
The gain in uniformity from requiring an explicit value with each keyword
greatly outweighs the convenience of not having to say <code>t</code>.
</p>
<p>If there are any <em>other-clauses</em>, they are <code>selectq</code> clauses selecting on the
keyword being processed.  These clauses are for handling any keywords that
are not handled by the <em>keywords</em> and <em>flags</em> elements.
These can be used to do special processing of certain keywords
for which simply storing the argument into a variable is not good enough.  After the
<em>other-clauses</em> there will be an <code>otherwise</code> clause to complain about any
undefined keywords found in <em>key-list</em>.
</p></dd></dl>

<a name="prog_002dfun"></a><dl>
<dt><a name="index-prog"></a>Special Form: <strong>prog</strong></dt>
<dd><p><code>prog</code> is a special form which provides temporary variables,
sequential evaluation of forms, and a &quot;goto&quot; facility.  A typical <code>prog</code>
looks like:
</p><div class="lisp">
<pre class="lisp">(prog (<em>var1 var2</em> (<em>var3 init3</em>) <em>var4</em> (<em>var5 init5</em>))
 <em>tag1</em>
     <em>statement1</em>
     <em>statement2</em>
 <em>tag2</em>
     <em>statement3</em>
     . . .
    )
</pre></div>
<p>The first subform of a <code>prog</code> is a list of variables, each of which
may optionally have an initialization form.  The first thing evaluation
of a <code>prog</code> form does is to evaluate all of the <em>init</em> forms.  Then
each variable that had an <em>init</em> form is bound to its value, and the
variables that did not have an <em>init</em> form are bound to <code>nil</code>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(prog ((a t)  b  (c 5)  (d (car '(zz . pp))))
  <em>body</em>...
  )
</pre></div>
<p>The initial value of <code>a</code> is <code>t</code>, that of <code>b</code> is <code>nil</code>, that of
<code>c</code> is the fixnum 5, and that of <code>d</code> is the symbol <code>zz</code>.  The
binding and initialization of the variables is done in <em>parallel</em>;
that is, all the initial values are computed before any of the variables
are changed.  <code>prog*</code> (see <a href="#prog_002a_002dfun">prog*-fun</a>) is the same as <code>prog</code>
except that this initialization is sequential rather than parallel.
</p>
<p>The part of a <code>prog</code> after the variable list is called the
<em>body</em>.  Each element of the body is either a symbol, in which case it
is called a <em>tag</em>, or anything else (almost always a list), in which
case it is called a <em>statement</em>.
</p>
<p>After <code>prog</code> binds the  variables, it processes each form in
its body sequentially.  <em>tags</em> are skipped over.  <em>statements</em> are
evaluated, and their returned values discarded.  If the end of the body
is reached, the <code>prog</code> returns <code>nil</code>.  However, two special forms
may be used in <code>prog</code> bodies to alter the flow of control.  If
<code>(return <em>x</em>)</code> is evaluated, <code>prog</code> stops processing its body,
evaluates <em>x</em>, and returns the result.  If <code>(go <em>tag</em>)</code> is
evaluated, <code>prog</code> jumps to the part of the body labeled with the
<em>tag</em>, where processing of the body is continued.  <em>tag</em> is not
evaluated.  <code>return</code> and <code>go</code> and their variants are explained
fully below.
</p>
<p>The compiler requires that <code>go</code> and <code>return</code> forms be
<em>lexically</em> within the scope of the <code>prog</code>; it is not possible for a
function called from inside a <code>prog</code> body to <code>return</code> to the
<code>prog</code>.  That is, the <code>return</code> or <code>go</code> must be inside the <code>prog</code>
itself, not inside a function called by the <code>prog</code>.  (This restriction
happens not to be enforced in the interpreter, but since all programs
are eventually compiled, the convention should be adhered to.  The
restriction will be imposed in future implementations of the
interpreter.)
</p>
<p>See also the <code>do</code> special form, which uses a body similar to
<code>prog</code>. The <code>do</code>, <code>*catch</code>, and <code>*throw</code> special forms are
included in Zetalisp as an attempt to encourage goto-less programming
style, which often leads to more readable, more easily maintained code.  The
programmer is recommended to use these forms instead of <code>prog</code>
wherever reasonable. 
</p>
<p>If the first subform of a <code>prog</code> is a non-<code>nil</code> symbol (rather than
a variable list), it is the name of the <code>prog</code>, and <code>return-from</code>
(see <a href="#return_002dfrom_002dfun">return-from-fun</a>) can be used to return from it.  See
<code>do-named</code>, <a href="#do_002dnamed_002dfun">do-named-fun</a>.
</p>
<div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(prog (x y z)  ;x, y, z<span class="roman"> are prog variables  - temporaries.</span>
   (setq y (car w) z (cdr w))     ;w<span class="roman"> is a free variable.</span>
loop
   (cond ((null y) (return x))
         ((null z) (go err)))
rejoin
   (setq x (cons (cons (car y) (car z))
                 x))
   (setq y (cdr y)
         z (cdr z))
   (go loop)
err
   (break are-you-sure? t)
   (setq z y)
   (go rejoin))
</pre></div>
</dd></dl>

<a name="prog_002a_002dfun"></a><dl>
<dt><a name="index-prog_002a"></a>Special Form: <strong>prog*</strong></dt>
<dd><p>The <code>prog*</code> special form is almost the same as <code>prog</code>.  The only
difference is that the binding and initialization of the temporary
variables is done <em>sequentially</em>, so each one can depend on the
previous ones.  For example,
</p><div class="lisp">
<pre class="lisp">(prog* ((y z) (x (car y)))
  (return x))
</pre></div>
<p>returns the car of the value of <code>z</code>.
</p></dd></dl>

<a name="go_002dfun"></a><dl>
<dt><a name="index-go"></a>Special Form: <strong>go</strong> <em>tag</em></dt>
<dd><p>The <code>go</code> special form is used to do a &quot;go-to&quot; within the
body of a <code>do</code> or a <code>prog</code>.  The <em>tag</em> must be a symbol.
It is not evaluated. <code>go</code> transfers control to the point in the body labelled by a
tag <code>eq</code> to the one given.  If there is no such tag in the body, the
bodies of lexically containing <code>prog</code>s and <code>do</code>s (if any) are examined as well.
If no tag is found, an error is signalled.
</p>
<div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(prog (x y z)
  (setq x <em>some frob</em>)
loop
  <em>do something</em>
  (if <em>some predicate</em> (go endtag))
  <em>do something more</em>
  (if (minusp x) (go loop))
endtag
  (return z))
</pre></div>
</dd></dl>

<a name="return_002dfun"></a><dl>
<dt><a name="index-return"></a>Special Form: <strong>return</strong> <em>value...</em></dt>
<dd><p><code>return</code> is used to exit from a <code>prog</code>-like special form (<code>prog</code>,
<code>prog*</code>, <code>do</code>, <code>do-named</code>, <code>dotimes</code>, <code>dolist</code>, <code>loop</code>,
etc.) The <em>value</em> forms are evaluated, and the resulting values are
returned by the <code>prog</code> as its values.
</p>
<p>In addition, <code>break</code> (see <a href="#break_002dfun">break-fun</a>) recognizes the typed-in form
<code>(return <em>value</em>)</code> specially.  If this form is typed at a
<code>break</code>, <em>value</em> will be evaluated and returned as the value of
<code>break</code>.  If not specially recognized by <code>break</code>,
and not inside a <code>prog</code>-like form, <code>return</code> will cause an
error. 
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(do ((x x (cdr x))
     (n 0 (* n 2)))
    ((null x) n)
 (cond ((atom (car x))
        (setq n (1+ n)))
       ((memq (caar x) '(sys boom bleah))
        (return n))))
</pre></div>
<p>Note that the <code>return</code> form is very unusual: it does not ever
return a value itself, in the conventional sense.  It isn&rsquo;t useful to
write <code>(setq a (return 3))</code>, because when the <code>return</code> form is
evaluated, the containing <code>do</code> or <code>prog</code> is immediately exited,
and the <code>setq</code> never happens.
</p>
<p>A <code>return</code> form may appear as or inside an argument to a regular
function, but if the <code>return</code> is executed then the function will never
actually be called.  The same is true of <code>go</code>.  For example,
</p><div class="lisp">
<pre class="lisp">(prog ()
      (foo (if a (return t) nil)))
</pre></div>
<p><code>foo</code> will actually be called only if <code>a</code>&rsquo;s value is <code>nil</code>.
However, this style of coding is not recommended.
</p>
<p><code>return</code> can also be used with multiple arguments, to return multiple values
from a <code>prog</code> or <code>do</code>.  For example,
</p><div class="lisp">
<pre class="lisp">(defun assqn (x table)
  (do ((l table (cdr l))
       (n 0 (1+ n)))
      ((null l) nil)
    (if (eq (caar l) x)
	(return (car l) n))))
</pre></div>
<p>This function is like <code>assq</code>, but it returns an additional value
which is the index in the table of the entry it found.
</p>
<p>However, if you use <code>return</code> with only one subform, then the <code>prog</code>
or <code>do</code> will return all of the values returned by that subform.  That
is, if you do
</p><div class="lisp">
<pre class="lisp">(prog ()
   ...
   (return (foo 2)))
</pre></div>
<p>and the function <code>foo</code> returns many values, then the <code>prog</code> will return
all of those values.  In fact, this means that
</p><div class="lisp">
<pre class="lisp">(return (values <em>form1 form2 form3</em>))
<span class="roman">is the same as</span>
(return <em>form1 form2 form3</em>)
</pre></div>

<p>To return precisely one value, use <code>(return (values <em>form</em>))</code>.
</p>
<p>It is legal to write simply <code>(return)</code>, which will return from the <code>prog</code>
without returning any values.
</p>
<p>See <a href="#multiple_002dvalue">multiple-value</a> for more information.
</p></dd></dl>

<a name="return_002dfrom_002dfun"></a><dl>
<dt><a name="index-return_002dfrom"></a>Special Form: <strong>return-from</strong> <em>name value...</em></dt>
<dd><p>The <em>value</em> forms are evaluated, and then are
returned from the innermost containing <code>prog</code>-like special form whose
name is <em>name</em>.  See the description of <code>do-named</code> (<a href="#do_002dnamed_002dfun">do-named-fun</a>)
in which named <code>do</code>s and <code>prog</code>s are explained.
</p></dd></dl>

<a name="return_002dlist_002dfun"></a><dl>
<dt><a name="index-return_002dlist"></a>Function: <strong>return-list</strong> <em>list</em></dt>
<dd><p>This function is like <code>return</code> except
that the <code>prog</code> returns all of the elements of <em>list</em>; if
<em>list</em> has more than one element, the <code>prog</code> does a multiple-value
return.
</p>
<p>This is semi-obsolete now, since <code>(return (values-list <em>list</em>))</code> does the same thing.
</p>
<p>To direct the returned values to a <code>prog</code> or <code>do-named</code> of a specific
name, use
</p><div class="lisp">
<pre class="lisp"><code>(return-from <em>name</em> (values-list <em>list</em>))</code>.
</pre></div>
</dd></dl>

<p>Also see <code>defunp</code> (<a href="#defunp_002dfun">defunp-fun</a>), a variant of <code>defun</code> that incorporates a <code>prog</code>
into the function body.
</p>
<a name="g_t_0022Non_002dLocal-Exits_0022"></a>
<h3 class="section">4.3 &quot;Non-Local Exits&quot;</h3>
<a name="index-_0022non_002dlocal-exit_0022-1"></a>
<a name="index-catch"></a>
<a name="index-throw"></a>

<a name="g_t_002acatch_002dfun"></a><dl>
<dt><a name="index-_002acatch"></a>Special Form: <strong>*catch</strong> <em>tag body...</em></dt>
<dd><p><code>*catch</code> is a special form used with the <code>*throw</code> function to do
non-local exits.  First <em>tag</em> is evaluated; the result is called the &quot;tag&quot;
of the <code>*catch</code>.  Then the <em>body</em> forms are evaluated sequentially,
and the value of the last form is returned.  However, if,
during the evaluation of the body, the
function <code>*throw</code> is called with the same tag as the tag of the
<code>*catch</code>, then the evaluation of the body is aborted, and the
<code>*catch</code> form immediately returns the value that was the second
argument to <code>*throw</code> without further evaluating the current <em>body</em> form or
the rest of the body.
</p>
<p>The <em>tag</em>&rsquo;s are used to match up <code>*throw</code>&rsquo;s with <code>*catch</code>&rsquo;s. 
<code>(*catch 'foo <em>form</em>)</code> will catch a <code>(*throw 'foo <em>form</em>)</code> but
not a <code>(*throw 'bar <em>form</em>)</code>.  It is an error if <code>*throw</code> is done
when there is no suitable <code>*catch</code> (or <code>catch-all</code>; see below).
</p>
<p>The values <code>t</code> and <code>nil</code> for <em>tag</em> are special: a <code>*catch</code> whose
tag is one of these values will catch throws to any tag.  These are only
for internal use by <code>unwind-protect</code> and <code>catch-all</code> respectively.
The only difference between <code>t</code> and <code>nil</code> is in the error checking;
<code>t</code> implies that after a &quot;cleanup handler&quot; is executed control will be
thrown again to the same tag, therefore it is an error if a specific
catch for this tag does not exist higher up in the stack.  With <code>nil</code>,
the error check isn&rsquo;t done.
</p>
<p><code>*catch</code> returns up to four values; trailing null values are not
returned for reasons of microcode simplicity, but the values not
returned will default to <code>nil</code> if they are received with the
<code>multiple-value</code> or <code>multiple-value-bind</code> special forms.
If the catch completes normally,
the first value is the value of <em>form</em> and the second is <code>nil</code>.
If a <code>*throw</code> occurs, the first value is the second argument to
<code>*throw</code>, and the second value is the first argument to <code>*throw</code>,
the tag thrown to.  The third and fourth values are the third and fourth
arguments to <code>*unwind-stack</code> (see <a href="#g_t_002aunwind_002dstack_002dfun">*unwind-stack-fun</a>)
if that was used in place of <code>*throw</code>; otherwise these values are <code>nil</code>.
To summarize, the four values returned by <code>*catch</code> are the value,
the tag, the active-frame-count, and the action.
</p><div class="lisp">
<pre class="lisp">Example
</pre><pre class="lisp">(*catch 'negative
	(mapcar (function (lambda (x) 
                            (cond ((minusp x)
				   (*throw 'negative x))
				  (t (f x)) )))
               y))
</pre></div>
<p>which returns a list of <code>f</code> of each element of <code>y</code> if they are all
positive, otherwise the first negative member of <code>y</code>. 
</p>
<p>Note that <code>*catch</code> returns its own extra values, and so it does <em>not</em>
propagate multiple values back from the last form.
</p></dd></dl>

<a name="catch_002dcontinuation_002dfun"></a><dl>
<dt><a name="index-catch_002dcontinuation"></a>Special Form: <strong>catch-continuation</strong> <em>tag throw-cont non-throw-cont body...</em></dt>
<dd><a name="catch_002dcontinuation_002dif_002dfun"></a></dd><dt><a name="index-catch_002dcontinuation_002dif"></a>Special Form: <strong>catch-continuation-if</strong> <em>cond-form tag throw-cont non-throw-cont body...</em></dt>
<dd><p>The <code>catch-continuation</code> special form makes it convenient to pass back
multiple values from the body, but still discriminate based on whether
exit is normal or due to a throw.
</p>
<p>The <em>body</em> is executed inside a <code>*catch</code> on <em>tag</em> (which is
evaluated).  If <em>body</em> returns normally, the function
<em>non-throw-cont</em> is called, passing all the values returned by the
last form in <em>body</em> as arguments.  This function&rsquo;s values are returned
from the <code>catch-continuation</code>.
</p>
<p>If on the other hand a throw to <em>tag</em> occurs, the values returned by
<code>*catch</code> are passed to the function <em>throw-cont</em>, and its values are
returned.
</p>
<p>If either of the continuations is explicitly written as <code>nil</code>, it is
not called at all.  The arguments that would have been passed to it are
returned instead.  This is equivalent to using <code>values</code> as the
function; but explicit <code>nil</code> is optimized, so use that.
</p>
<p><code>catch-continuation-if</code> differs only in that the catch is not done if
the value of the <em>cond-form</em> is <code>nil</code>.  In this case, the non-throw
continuation if any will be always be called.
</p>
<p>In the general case, consing is necessary to record the multiple values,
but if either continuation is an explicit <code>#'(lambda ...)</code> with a
fixed number of arguments, it is open coded and the consing is avoided.
</p></dd></dl>

<a name="g_t_002athrow_002dfun"></a><dl>
<dt><a name="index-_002athrow"></a>Function: <strong>*throw</strong> <em>tag value</em></dt>
<dd><p><code>*throw</code> is used with <code>*catch</code> as a structured non-local exit mechanism.
</p>
<p><code>(*throw <em>tag x</em>)</code> throws the value of <em>x</em> back to the most recent <code>*catch</code>
labelled with <em>tag</em> or <code>t</code> or <code>nil</code>.  Other <code>*catches</code> are skipped over.
Both <em>x</em> and <em>tag</em> are evaluated, unlike the Maclisp <code>throw</code> function.
</p>
<p>The values <code>t</code>, <code>nil</code>, and <code>0</code> for <em>tag</em> are reserved and used
for internal purposes.  <code>nil</code> may not be used, because it would cause
an ambiguity in the returned values of <code>*catch</code>.  <code>t</code> may only be
used with <code>*unwind-stack</code>.  <code>0</code> and <code>nil</code> are used internally when
returning out of an <code>unwind-protect</code>.
</p>
<p>See the description of <code>*catch</code> for further details.
</p></dd></dl>

<a name="catch_002dfun"></a><dl>
<dt><a name="index-catch-1"></a>Macro: <strong>catch</strong> <em>form tag</em></dt>
<dd><a name="throw_002dfun"></a></dd><dt><a name="index-throw-1"></a>Macro: <strong>throw</strong> <em>form tag</em></dt>
<dd><p><code>catch</code> and <code>throw</code> are provided only for Maclisp compatibility.
<code>(catch <em>form</em> tag)</code> is the same as <code>(*catch 'tag <em>form</em>)</code>,
and <code>(throw <em>form</em> tag)</code> is the same as <code>(*throw 'tag <em>form</em>)</code>.
The forms of <code>catch</code> and <code>throw</code> without tags are not supported.
</p></dd></dl>

<a name="index-unwinding-a-stack"></a>
<a name="g_t_002aunwind_002dstack_002dfun"></a><dl>
<dt><a name="index-_002aunwind_002dstack"></a>Function: <strong>*unwind-stack</strong> <em>tag value active-frame-count action</em></dt>
<dd><p>This is a generalization of <code>*throw</code> provided for program-manipulating
programs such as the error handler.
</p>
<p><em>tag</em> and <em>value</em> are the same as the corresponding arguments to
<code>*throw</code>.
</p>
<p>A <em>tag</em> of <code>t</code> invokes a special feature whereby the entire stack is
unwound, and then the function <em>action</em> is called (see below).  During
this process <code>unwind-protect</code>s receive control, but <code>catch-all</code>s do
not.  This feature is provided for the benefit of system programs which
want to unwind a stack completely.
</p>
<p><em>active-frame-count</em>, if non-<code>nil</code>, is the number of frames
to be unwound.  The definition of a &quot;frame&quot; is implementation-dependent.
If this counts down to zero before a suitable <code>*catch</code>
is found, the <code>*unwind-stack</code> terminates and
<em>that frame</em> returns <em>value</em> to whoever called it.
This is similar to Maclisp&rsquo;s <code>freturn</code> function.
<a name="index-_0022freturn_0022"></a>
</p>
<p>If <em>action</em> is non-<code>nil</code>, whenever the <code>*unwind-stack</code> would be
ready to terminate (either due to <em>active-frame-count</em> or due to
<em>tag</em> being caught as in <code>*throw</code>), instead <em>action</em> is called
with one argument, <em>value</em>.  If <em>tag</em> is <code>t</code>, meaning throw out
the whole way, then the function <em>action</em> is not allowed to return.
Otherwise the function <em>action</em> may return and its value will be
returned instead of <em>value</em> from the <code>*catch</code>&ndash;or from an arbitrary
function if <em>active-frame-count</em> is in use.  In this case the
<code>*catch</code> does not return multiple values as it normally does when
thrown to.  Note that it is often useful for <em>action</em> to be a
stack-group.
</p>
<p>Note that if both <em>active-frame-count</em> and <em>action</em> are <code>nil</code>,
<code>*unwind-stack</code> is identical to <code>*throw</code>.
</p></dd></dl>

<a name="index-unwind-protection"></a>
<a name="index-cleanup-handler"></a>
<a name="unwind_002dprotect_002dfun"></a><dl>
<dt><a name="index-unwind_002dprotect"></a>Special Form: <strong>unwind-protect</strong> <em>protected-form cleanup-form...</em></dt>
<dd><p>Sometimes it is necessary to evaluate a form and make sure that
certain side-effects take place after the form is evaluated;
a typical example is:
</p><div class="lisp">
<pre class="lisp">(progn
   (turn-on-water-faucet)
   (hairy-function 3 nil 'foo)
   (turn-off-water-faucet))
</pre></div>
<p>The non-local exit facility of Lisp creates a situation in which
the above code won&rsquo;t work, however: if <code>hairy-function</code> should
do a <code>*throw</code> to a <code>*catch</code> which is outside of the <code>progn</code>
form, then <code>(turn-off-water-faucet)</code> will never be evaluated
(and the faucet will presumably be left running).
This is particularly likely if <code>hairy-function</code> gets an error
and the user tells the error-handler to give up and flush the computation.
</p>
<p>In order to allow the above program to work, it can
be rewritten using <code>unwind-protect</code> as follows:
</p><div class="lisp">
<pre class="lisp">(unwind-protect
  (progn (turn-on-water-faucet)
	 (hairy-function 3 nil 'foo))
  (turn-off-water-faucet))
</pre></div>
<p>If <code>hairy-function</code> does a <code>*throw</code> which attempts to quit
out of the evaluation of the <code>unwind-protect</code>, the
<code>(turn-off-water-faucet)</code> form will be evaluated in between
the time of the <code>*throw</code> and the time at which the <code>*catch</code> returns.
If the <code>progn</code> returns normally, then the <code>(turn-off-water-faucet)</code>
is evaluated, and the <code>unwind-protect</code> returns the result of the <code>progn</code>.
</p>

<p>The general form of <code>unwind-protect</code> looks like
</p><div class="lisp">
<pre class="lisp">(unwind-protect <em>protected-form</em>
    <em>cleanup-form1</em>
    <em>cleanup-form2</em>
    ...)
</pre></div>
<p><em>protected-form</em> is evaluated, and when it returns or when it
attempts to quit out of the <code>unwind-protect</code>, the <em>cleanup-forms</em>
are evaluated.  The value of the <code>unwind-protect</code> is the value of
<em>protected-form</em>.
Multiple values returned by the <em>protected-form</em> are propagated back
through the <code>unwind-protect</code>.
</p>
<p>The cleanup forms are run in the variable-binding environment that you
would expect: that is, variables bound outside the scope of the
<code>unwind-protect</code> special form can be accessed, but variables bound
inside the <em>protected-form</em> can&rsquo;t be.  In other words, the stack is
unwound to the point just outside the <em>protected-form</em>, then the
cleanup handler is run, and then the stack is unwound some more.
</p></dd></dl>

<a name="catch_002dall_002dfun"></a><dl>
<dt><a name="index-catch_002dall"></a>Macro: <strong>catch-all</strong> <em>body...</em></dt>
<dd><p><code>(catch-all <em>form</em>)</code> is like <code>(*catch <em>some-tag form</em>)</code>
except that it will catch a
<code>*throw</code> to any tag at all.  Since the tag thrown to
is the second returned value, the caller of <code>catch-all</code> may continue 
throwing to that tag if he wants.  The one thing that <code>catch-all</code>
will not catch is a <code>*unwind-stack</code> with a tag of <code>t</code>.
<code>catch-all</code> is a macro which expands into <code>*catch</code> with a <em>tag</em> of <code>nil</code>.
</p>
<p>If you think you want this, most likely you are mistaken and you really
want <code>unwind-protect</code>.
</p></dd></dl>

<a name="g_t_0022Mapping_0022"></a>
<h3 class="section">4.4 &quot;Mapping&quot;</h3>
<a name="index-_0022mapping_0022"></a>

<a name="map_002dfun"></a><dl>
<dt><a name="index-map"></a>Function: <strong>map</strong> <em>fcn &amp;rest lists</em></dt>
<dd><a name="mapc_002dfun"></a></dd><dt><a name="index-mapc"></a>Function: <strong>mapc</strong> <em>fcn &amp;rest lists</em></dt>
<dd><a name="maplist_002dfun"></a></dd><dt><a name="index-maplist"></a>Function: <strong>maplist</strong> <em>fcn &amp;rest lists</em></dt>
<dd><a name="mapcar_002dfun"></a></dd><dt><a name="index-mapcar"></a>Function: <strong>mapcar</strong> <em>fcn &amp;rest lists</em></dt>
<dd><a name="mapcon_002dfun"></a></dd><dt><a name="index-mapcon"></a>Function: <strong>mapcon</strong> <em>fcn &amp;rest lists</em></dt>
<dd><a name="mapcan_002dfun"></a></dd><dt><a name="index-mapcan"></a>Function: <strong>mapcan</strong> <em>fcn &amp;rest lists</em></dt>
<dd>
<p>Mapping is a type of iteration in which a function is 
successively applied to pieces of a list.
There are several options for the way in which the pieces of the list are
chosen and for what is done with the results returned by the applications of
the function.
</p>
<p>For example, <code>mapcar</code> operates on successive <em>elements</em> of the list. 
As it goes down the list, it calls the function giving it an element
of the list as its one argument:  first the car, then the
cadr, then the caddr, etc., continuing until the end of the
list is reached.  The value returned by <code>mapcar</code> is a list of the
results of the successive calls to the function.  An example of the
use of <code>mapcar</code> would be <code>mapcar</code>&rsquo;ing the function <code>abs</code> over
the list <code>(1 -2 -4.5 6.0e15 -4.2)</code>, which would be written as
<code>(mapcar (function abs) '(1 -2 -4.5 6.0e15 -4.2))</code>.
The result is <code>(1 2 4.5 6.0e15
4.2)</code>.  
</p>
<p>In general, the mapping functions take any number of arguments.  For example,
</p><div class="lisp">
<pre class="lisp">(mapcar <em>f</em> <em>x1</em> <em>x2</em> ... <em>xn</em>)
</pre></div>
<p>In this case <em>f</em> must be a function of <em>n</em> arguments.
<code>mapcar</code> will proceed
down the lists <em>x1, x2, ..., xn</em> in parallel.
The first argument to <em>f</em> will
come from <em>x1</em>, the second from <em>x2</em>, etc.
The iteration stops as soon as any of the lists is exhausted.
(If there are no lists at all, then there are no lists to be exhausted,
so the function will be called repeatedly over and over.  This is an
obscure way to write an infinite loop.  It is supported for
consistency.)  If you want to call a function of many arguments
where one of the arguments successively takes on the values of the elements
of a list and the other arguments are constant, you can use a circular
list for the other arguments to <code>mapcar</code>.  The function <code>circular-list</code>
is useful for creating such lists; see <a href="#circular_002dlist_002dfun">circular-list-fun</a>.
</p>
<p>There are five other mapping functions besides <code>mapcar</code>.  <code>maplist</code>
is like <code>mapcar</code> except that the function is applied to the list and
successive cdr&rsquo;s of that list rather than to successive elements of the
list.  <code>map</code> and <code>mapc</code> are like <code>maplist</code> and <code>mapcar</code>
respectively, except that they don&rsquo;t return any useful value.  These
functions are used when the function is being called merely for its
side-effects, rather than its returned values.  <code>mapcan</code> and
<code>mapcon</code> are like <code>mapcar</code> and <code>maplist</code> respectively, except
that they combine the results of the function using <code>nconc</code> instead
of <code>list</code>.  That is, <code>mapcon</code> could have been defined by
</p><div class="lisp">
<pre class="lisp">(defun mapcon (f x y)
    (apply 'nconc (maplist f x y)))
</pre></div>
<p>Of course, this definition is less general than the real one.
</p>
<p>Sometimes a <code>do</code> or a straightforward recursion is preferable to a
map;  however, the mapping functions should be used wherever they
naturally apply because this increases the clarity of the code. 
</p>
<p>Often <em>f</em> will be a lambda-expression, rather than a symbol;
for example,
</p><div class="lisp">
<pre class="lisp">(mapcar (function (lambda (x) (cons x something)))
	some-list)
</pre></div>

<p>The functional argument to a mapping function must be a function, acceptable
to <code>apply</code>&ndash;it cannot be a macro or the name of a special form.
</p>
<p>Here is a table showing the relations between
the six map functions.
</p><pre class="verbatim">                              applies function to

                         |  successive  |   successive  |
                         |   sublists   |    elements   |
          ---------------+--------------+---------------+
              its own    |              |               | 
              second     |     map      |     mapc      |
             argument    |              |               |
          ---------------+--------------+---------------+
            list of the  |              |               |
returns      function    |    maplist   |    mapcar     |
              results    |              |               |
          ---------------+--------------+---------------+
            nconc of the |              |               |
              function   |    mapcon    |    mapcan     |
              results    |              |               |
          ---------------+--------------+---------------+
</pre><p>There are also functions (<code>mapatoms</code> and <code>mapatoms-all</code>)
for mapping over all symbols in certain
packages.  See the explanation of packages (<a href="#package">package</a>).
</p>
<p>You can also do what the mapping functions do in a different way by using
<code>loop</code>.  See <a href="#loop_002dfun">loop-fun</a>.
</p></dd></dl>


<a name="g_t_0022Manipulating-List-Structure_0022"></a>
<h2 class="chapter">5 &quot;Manipulating List Structure&quot;</h2>
<a name="cons_002dchapter"></a><a name="index-_0022cons_0022-1"></a>
<a name="index-car"></a>
<a name="index-cdr"></a>
<a name="index-_0022list_0022"></a>
<a name="index-_0022tree_0022"></a>
<a name="index-_0022circular-list_0022"></a>
<a name="index-_0022elements-_0028of-a-list_0029_0022"></a>
<a name="index-_0022dotted-list_0022"></a>
<a name="list_002dand_002dtree"></a>
<p>This chapter discusses functions that manipulate conses, and
higher-level structures made up of conses such as lists and trees.
It also discusses hash tables and resources, which are related
facilities.
</p>
<p>A cons is a primitive Lisp data object that is extremely simple: it
knows about two other objects, called its <em>car</em> and its <em>cdr</em>.
</p>
<p>A list is recursively defined to be the symbol <code>nil</code>, or a cons whose
cdr is a list.  A typical list is a chain of conses: the cdr of each is
the next cons in the chain, and the cdr of the last one is the symbol
<code>nil</code>.  The cars of each of these conses are called the <em>elements</em>
of the list.  A list has one element for each cons; the empty list,
<code>nil</code>, has no elements at all.  Here are the printed representations
of some typical lists:
</p><div class="lisp">
<pre class="lisp">(foo bar)		  ;This list has two elements.
(a (b c d) e)		  ;This list has three elements.
</pre></div>
<p>Note that the second list has three elements: <code>a</code>, <code>(b c d)</code>, and <code>e</code>.
The symbols <code>b</code>, <code>c</code>, and <code>d</code> are <em>not</em> elements of the list itself.
(They are elements of the list which is the second element of the original
list.)
</p>
<p>A &quot;dotted list&quot; is like a list except that the cdr of the last cons does
not have to be <code>nil</code>.  This name comes from the printed
representation, which includes a &quot;dot&quot; character.  Here is an example:
</p><div class="lisp">
<pre class="lisp">(a b . c)
</pre></div>
<p>This &quot;dotted list&quot; is made of two conses.  The car of the first cons is the
symbol <code>a</code>, and the cdr of the first cons is the second cons.  The car of
the second cons is the symbol <code>b</code>, and the cdr of the second cons is
the symbol <code>c</code>.
</p>
<p>A tree is any data structure made up of conses whose cars and cdrs are
other conses.  The following are all printed representations of trees:
</p><div class="lisp">
<pre class="lisp">(foo . bar)
((a . b) (c . d))
((a . b) (c d e f (g . 5) s) (7 . 4))
</pre></div>

<p>These definitions are not mutually exclusive.  Consider a cons whose
car is <code>a</code> and whose cdr is <code>(b (c d) e)</code>.  Its printed
representation is
</p><div class="lisp">
<pre class="lisp">(a b (c d) e)
</pre></div>
<p>It can be thought of and treated as a cons, or as a list of four
elements, or as a tree containing six conses.  You can even think of it
as a &quot;dotted list&quot; whose last cons just happens to have <code>nil</code> as a
cdr.  Thus, lists and &quot;dotted lists&quot; and trees are not fundamental data
types; they are just ways of thinking about structures of conses.
</p>
<p>A circular list is like a list except that the cdr of the last cons,
instead of being <code>nil</code>, is the first cons of the list.  This means that
the conses are all hooked together in a ring, with the cdr of each cons
being the next cons in the ring.  While these are perfectly good Lisp
objects, and there are functions to deal with them, many other functions
will have trouble with them.  Functions that expect lists as their
arguments often iterate down the chain of conses waiting to see a
<code>nil</code>, and when handed a circular list this can cause them to compute
forever.  The printer (see <a href="#print_002dfun">print-fun</a>) is one of these functions; if
you try to print a circular list the printer will never stop producing
text.  You have to be careful what you do with circular lists.
</p>
<p>The Lisp Machine internally uses a storage scheme called &quot;cdr coding&quot; to
represent conses.  This scheme is intended to reduce the amount of storage
used in lists.  The use of cdr-coding is invisible to programs except in
terms of storage efficiency; programs will work the same way whether or not
lists are cdr-coded or not.  Several of the functions below mention how
they deal with cdr-coding.  You can completely ignore all this if you want.
However, if you are writing a program that allocates a lot of conses and
you are concerned with storage efficiency, you may want to learn about the
cdr-coded representation and how to control it.  The cdr-coding scheme is
discussed in <a href="#cdr_002dcode">cdr-code</a>.
</p>
<a name="g_t_0022Conses_0022"></a>
<h3 class="section">5.1 &quot;Conses&quot;</h3>

<a name="car_002dfun"></a><dl>
<dt><a name="index-car-1"></a>Function: <strong>car</strong> <em>x</em></dt>
<dd><p>Returns the car of <em>x</em>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(car '(a b c)) =&gt; a
</pre></div>
</dd></dl>

<a name="cdr_002dfun"></a><dl>
<dt><a name="index-cdr-1"></a>Function: <strong>cdr</strong> <em>x</em></dt>
<dd><p>Returns the cdr of <em>x</em>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(cdr '(a b c)) =&gt; (b c)
</pre></div>
</dd></dl>

<p>Officially <code>car</code> and <code>cdr</code> are only applicable to conses and locatives.
However, as a matter of convenience, <code>car</code> and <code>cdr</code> of <code>nil</code> return <code>nil</code>.
<code>car</code> or <code>cdr</code> of anything else is an error.
</p>
<a name="c_002e_002e_002er_002dfun"></a><dl>
<dt><a name="index-c_002e_002e_002er"></a>Function: <strong>c...r</strong> <em>x</em></dt>
<dd><a name="index-caaaar"></a>
<a name="index-caaadr"></a>
<a name="index-caaar"></a>
<a name="index-caadar"></a>
<a name="index-caaddr"></a>
<a name="index-caadr"></a>
<a name="index-caar"></a>
<a name="index-cadaar"></a>
<a name="index-cadadr"></a>
<a name="index-cadar"></a>
<a name="index-caddar"></a>
<a name="index-cadddr"></a>
<a name="index-caddr"></a>
<a name="index-cadr"></a>
<a name="index-cdaaar"></a>
<a name="index-cdaadr"></a>
<a name="index-cdaar"></a>
<a name="index-cdadar"></a>
<a name="index-cdaddr"></a>
<a name="index-cdadr"></a>
<a name="index-cdar"></a>
<a name="index-cddaar"></a>
<a name="index-cddadr"></a>
<a name="index-cddar"></a>
<a name="index-cdddar"></a>
<a name="index-cddddr"></a>
<a name="index-cdddr"></a>
<a name="index-cddr"></a>
<p>All of the compositions of up to four car&rsquo;s and cdr&rsquo;s are defined as
functions in their own right.  The names of these functions begin with &quot;<code>c</code>&quot; and end
with &quot;<code>r</code>&quot;, and in between is a sequence of &quot;<code>a</code>&quot;&rsquo;s and &quot;<code>d</code>&quot;&rsquo;s corresponding to
the composition performed by the function. 
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(cddadr x) <span class="roman">is the same as</span> (cdr (cdr (car (cdr x))))
</pre></div>
<p>The error checking for these functions is exactly the same as for <code>car</code> and <code>cdr</code>
above.
</p></dd></dl>
	
<a name="cons_002dfun"></a><dl>
<dt><a name="index-cons"></a>Function: <strong>cons</strong> <em>x y</em></dt>
<dd><p><code>cons</code> is the primitive function to create a new cons, whose
car is <em>x</em> and whose cdr is <em>y</em>.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(cons 'a 'b) =&gt; (a . b)
(cons 'a (cons 'b (cons 'c nil))) =&gt; (a b c)
(cons 'a '(b c d)) =&gt; (a b c d)
</pre></div>
</dd></dl>

<a name="ncons_002dfun"></a><dl>
<dt><a name="index-ncons"></a>Function: <strong>ncons</strong> <em>x</em></dt>
<dd><p><code>(ncons <em>x</em>)</code> is the same as <code>(cons <em>x</em> nil)</code>.
The name of the function is from &quot;nil-cons&quot;.
</p></dd></dl>

<a name="xcons_002dfun"></a><dl>
<dt><a name="index-xcons"></a>Function: <strong>xcons</strong> <em>x y</em></dt>
<dd><p><code>xcons</code> (&quot;exchanged cons&quot;) is like <code>cons</code> except that the order of
the arguments is reversed.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(xcons 'a 'b) =&gt; (b . a)
</pre></div>
</dd></dl>

<a name="cons_002din_002darea_002dfun"></a><dl>
<dt><a name="index-cons_002din_002darea"></a>Function: <strong>cons-in-area</strong> <em>x y area-number</em></dt>
<dd><a name="index-_0022area_0022"></a>
<p>This function creates a cons in a specific <em>area</em>.  (Areas are
an advanced feature of storage management, explained in chapter
<a href="#area_002dchapter">area-chapter</a>; if you aren&rsquo;t interested in them, you can safely skip
all this stuff).  The first two arguments are the same as the two
arguments to <code>cons</code>,  and the third is the number of the area in which
to create the cons.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(cons-in-area 'a 'b my-area) =&gt; (a . b)
</pre></div>
</dd></dl>

<a name="ncons_002din_002darea_002dfun"></a><dl>
<dt><a name="index-ncons_002din_002darea"></a>Function: <strong>ncons-in-area</strong> <em>x area-number</em></dt>
<dd><p><code>(ncons-in-area <em>x area-number</em>)</code> = <code>(cons-in-area <em>x</em> nil <em>area-number</em>)</code>
</p></dd></dl>

<a name="xcons_002din_002darea_002dfun"></a><dl>
<dt><a name="index-xcons_002din_002darea"></a>Function: <strong>xcons-in-area</strong> <em>x y area-number</em></dt>
<dd><p><code>(xcons-in-area <em>x y area-number</em>) = (cons-in-area <em>y x area-number</em>)</code>
</p></dd></dl>

<p>The backquote reader macro facility is also generally useful
for creating list structure, especially mostly-constant list structure,
or forms constructed by plugging variables into a template.
It is documented in the chapter on macros; see <a href="#macro">macro</a>.
</p>
<a name="car_002dlocation_002dfun"></a><dl>
<dt><a name="index-car_002dlocation"></a>Function: <strong>car-location</strong> <em>cons</em></dt>
<dd><p><code>car-location</code> returns a locative pointer to the cell containing
the car of <em>cons</em>.
</p></dd></dl>

<p>Note: there is no <code>cdr-location</code> function; it is difficult because of
the cdr-coding scheme (see <a href="#cdr_002dcode">cdr-code</a>).  Instead, the cons itself
serves as a &quot;locative&quot; to its cdr (see <a href="#contents_002dfun">contents-fun</a>).
</p>
<a name="g_t_0022Lists_0022"></a>
<h3 class="section">5.2 &quot;Lists&quot;</h3>

<a name="length_002dfun"></a><dl>
<dt><a name="index-length"></a>Function: <strong>length</strong> <em>list-or-array</em></dt>
<dd><p><code>length</code> returns the length of <em>list-or-array</em>.  The length of a
list is the number of elements in it; the number of times you can cdr it
before you get a non-cons.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(length nil) =&gt; 0
(length '(a b c d)) =&gt; 4
(length '(a (b c) d)) =&gt; 3
(length &quot;foobar&quot;) =&gt; 6
</pre></div>
<p><code>length</code> could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun length (x)
  (if (arrayp x) (array-active-length x)
    (do ((n 0 (1+ n))
         (y x (cdr y)))
        ((null y) n))))
</pre></div>
<p>or by
</p><div class="lisp">
<pre class="lisp">(defun length (x)
    (cond ((arrayp x) (array-active-length x))
	  ((null x) 0)
          ((1+ (length (cdr x)))) ))
</pre></div>
</dd></dl>

<a name="first_002dfun"></a><dl>
<dt><a name="index-first"></a>Function: <strong>first</strong> <em>list</em></dt>
<dd><a name="second_002dfun"></a></dd><dt><a name="index-second"></a>Function: <strong>second</strong> <em>list</em></dt>
<dd><a name="third_002dfun"></a></dd><dt><a name="index-third"></a>Function: <strong>third</strong> <em>list</em></dt>
<dd><a name="fourth_002dfun"></a></dd><dt><a name="index-fourth"></a>Function: <strong>fourth</strong> <em>list</em></dt>
<dd><a name="fifth_002dfun"></a></dd><dt><a name="index-fifth"></a>Function: <strong>fifth</strong> <em>list</em></dt>
<dd><a name="sixth_002dfun"></a></dd><dt><a name="index-sixth"></a>Function: <strong>sixth</strong> <em>list</em></dt>
<dd><a name="seventh_002dfun"></a></dd><dt><a name="index-seventh"></a>Function: <strong>seventh</strong> <em>list</em></dt>
<dd><p>These functions take a list as an argument, and return the first,
second, etc. element of the list.  <code>first</code> is identical to <code>car</code>,
<code>second</code> is identical to <code>cadr</code>, and so on.  The reason these names
are provided is that they make more sense when you are thinking of the
argument as a list rather than just as a cons.
</p></dd></dl>

<a name="rest1_002dfun"></a><dl>
<dt><a name="index-rest1"></a>Function: <strong>rest1</strong> <em>list</em></dt>
<dd><a name="rest2_002dfun"></a></dd><dt><a name="index-rest2"></a>Function: <strong>rest2</strong> <em>list</em></dt>
<dd><a name="rest3_002dfun"></a></dd><dt><a name="index-rest3"></a>Function: <strong>rest3</strong> <em>list</em></dt>
<dd><a name="rest4_002dfun"></a></dd><dt><a name="index-rest4"></a>Function: <strong>rest4</strong> <em>list</em></dt>
<dd><p><code>rest<em>n</em></code> returns the rest of the elements of a list, starting with
element <em>n</em> (counting the first element as the zeroth).  Thus
<code>rest1</code> is identical to <code>cdr</code>, <code>rest2</code> is identical to <code>cddr</code>,
and so on.  The reason these names are provided is that they make more
sense when you are thinking of the argument as a list rather than just
as a cons.
</p></dd></dl>

<a name="nth_002dfun"></a><dl>
<dt><a name="index-nth"></a>Function: <strong>nth</strong> <em>n list</em></dt>
<dd><p><code>(nth <em>n</em> <em>list</em>)</code> returns the <em>n</em>&rsquo;th element of <em>list</em>, where
the zeroth element is the car of the list.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(nth 1 '(foo bar gack)) =&gt; bar
(nth 3 '(foo bar gack)) =&gt; nil
</pre></div>
<p>If <em>n</em> is greater than the length of the list, <code>nil</code> is returned.
</p>
<p>Note: this is not the same as the InterLisp function called <code>nth</code>,
which is similar to but not exactly the same as the Lisp Machine function
<code>nthcdr</code>.
Also, some people have used macros and functions called <code>nth</code> of their own in
their Maclisp programs, which may not work the same way; be careful.
</p>
<div class="lisp">
<pre class="lisp"><code>nth</code> could have been defined by:
</pre><pre class="lisp">(defun nth (n list)
  (do ((i n (1- i))
       (l list (cdr l)))
      ((zerop i) (car l))))
</pre></div>
</dd></dl>

<a name="nthcdr_002dfun"></a><dl>
<dt><a name="index-nthcdr"></a>Function: <strong>nthcdr</strong> <em>n list</em></dt>
<dd><p><code>(nthcdr <em>n</em> <em>list</em>)</code> cdrs <em>list</em> <em>n</em> times,
and returns the result.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(nthcdr 0 '(a b c)) =&gt; (a b c)
(nthcdr 2 '(a b c)) =&gt; (c)
</pre></div>
<p>In other words, it returns the <em>n</em>&rsquo;th cdr of the list.
If <em>n</em> is greater than the length of the list, <code>nil</code> is returned.
</p>
<p>This is similar to InterLisp&rsquo;s function <code>nth</code>, except that the
InterLisp function is one-based instead of zero-based; see the
InterLisp manual for details.
<code>nthcdr</code> could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun nthcdr (n list)
    (do ((i 0 (1+ i))
	 (list list (cdr list)))
	((= i n) list)))
</pre></div>
</dd></dl>

<a name="last_002dfun"></a><dl>
<dt><a name="index-last"></a>Function: <strong>last</strong> <em>list</em></dt>
<dd><p><code>last</code> returns the last cons of <em>list</em>.  If <em>list</em> is <code>nil</code>, it
returns <code>nil</code>.  Note that <code>last</code> is unfortunately <em>not</em> analogous
to <code>first</code> (<code>first</code> returns the first element of a list, but
<code>last</code> doesn&rsquo;t return the last element of a list); this is a
historical artifact.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq x '(a b c d))
(last x) =&gt; (d)
(rplacd (last x) '(e f))
x =&gt; '(a b c d e f)
</pre></div>
<p><code>last</code> could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun last (x)
    (cond ((atom x) x)
          ((atom (cdr x)) x)
          ((last (cdr x))) ))
</pre></div>
</dd></dl>

<a name="list_002dfun"></a><dl>
<dt><a name="index-list"></a>Function: <strong>list</strong> <em>&amp;rest args</em></dt>
<dd><p><code>list</code> constructs and returns a list of its arguments.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(list 3 4 'a (car '(b . c)) (+ 6 -2)) =&gt; (3 4 a b 4)
</pre></div>

<div class="lisp">
<pre class="lisp"><code>list</code> could have been defined by:
</pre><pre class="lisp">(defun list (&amp;rest args)
    (let ((list (make-list (length args))))
      (do ((l list (cdr l))
	   (a args (cdr a)))
	  ((null a) list)
	(rplaca l (car a)))))
</pre></div>
</dd></dl>

<a name="list_002a_002dfun"></a><dl>
<dt><a name="index-list_002a"></a>Function: <strong>list*</strong> <em>&amp;rest args</em></dt>
<dd><p><code>list*</code> is like <code>list</code> except that the last cons
of the constructed list is &quot;dotted&quot;.  It must be given at least
one argument.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(list* 'a 'b 'c 'd) =&gt; (a b c . d)
</pre></div>
<p>This is like
</p><div class="lisp">
<pre class="lisp">(cons 'a (cons 'b (cons 'c 'd)))
</pre></div>

<div class="lisp">
<pre class="lisp">More examples:
</pre><pre class="lisp">(list* 'a 'b) =&gt; (a . b)
(list* 'a) =&gt; a
</pre></div>
</dd></dl>

<a name="list_002din_002darea_002dfun"></a><dl>
<dt><a name="index-list_002din_002darea"></a>Function: <strong>list-in-area</strong> <em>area-number &amp;rest args</em></dt>
<dd><p><code>list-in-area</code> is exactly the same as <code>list</code> except that it takes
an extra argument, an area number, and creates the list in that area.
</p></dd></dl>

<a name="list_002a_002din_002darea_002dfun"></a><dl>
<dt><a name="index-list_002a_002din_002darea"></a>Function: <strong>list*-in-area</strong> <em>area-number &amp;rest args</em></dt>
<dd><p><code>list*-in-area</code> is exactly the same as <code>list*</code> except that it takes
an extra argument, an area number, and creates the list in that area.
</p></dd></dl>

<a name="make_002dlist_002dfun"></a><dl>
<dt><a name="index-make_002dlist"></a>Function: <strong>make-list</strong> <em>length &amp;rest options</em></dt>
<dd><p>This creates and returns a list containing <em>length</em> elements.
<em>length</em> should be a fixnum.  <em>options</em> are alternating
keywords and values.  The keywords may be either of the following:
</p><dl compact="compact">
<dt><code>:area</code></dt>
<dd><p>The value specifies in which area (see <a href="#area">area</a>) the list should be created.
It should be either an area number (a fixnum), or <code>nil</code> to mean the
default area.
</p></dd>
<dt><code>:initial-value</code></dt>
<dd><p>The elements of the list will all be this value.  It defaults to <code>nil</code>.
</p></dd>
</dl>

<p><code>make-list</code> always creates a cdr-coded list (see <a href="#cdr_002dcode">cdr-code</a>).
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(make-list 3) =&gt; (nil nil nil)
(make-list 4 ':initial-value 7) =&gt; (7 7 7 7)
</pre></div>

<p>When <code>make-list</code> was originally implemented, it took exactly two
arguments: the area and the length.  This obsolete form is still
supported so that old programs will continue to work, but the new
keyword-argument form is preferred.
</p></dd></dl>

<a name="circular_002dlist_002dfun"></a><dl>
<dt><a name="index-circular_002dlist"></a>Function: <strong>circular-list</strong> <em>&amp;rest args</em></dt>
<dd><p><code>circular-list</code> constructs a circular list whose elements are <code>args</code>, repeated
infinitely.  <code>circular-list</code> is the same as <code>list</code> except that the list itself
is used as the last cdr, instead of <code>nil</code>.
<code>circular-list</code> is especially useful with <code>mapcar</code>, as in the expression
</p><div class="lisp">
<pre class="lisp">(mapcar (function +) foo (circular-list 5))
</pre></div>
<p>which adds each element of <code>foo</code> to 5.
</p>
<div class="lisp">
<pre class="lisp"><code>circular-list</code> could have been defined by:
</pre><pre class="lisp">(defun circular-list (&amp;rest elements)
  (setq elements (copylist* elements))
  (rplacd (last elements) elements)
  elements)
</pre></div>
</dd></dl>

<a name="copylist_002dfun"></a><dl>
<dt><a name="index-copylist"></a>Function: <strong>copylist</strong> <em>list &amp;optional area</em></dt>
<dd><p>Returns a list which is <code>equal</code> to <em>list</em>, but not <code>eq</code>.
<code>copylist</code> does not copy any elements of the list: only the conses of the list itself.
The returned list is fully cdr-coded (see <a href="#cdr_002dcode">cdr-code</a>) to minimize storage.
If the list is &quot;dotted&quot;, that is, if <code>(cdr (last <em>list</em>))</code>
is a non-<code>nil</code> atom, this will be true of the returned list also.
You may optionally specify the area in which to create the new copy.
</p></dd></dl>

<a name="copylist_002a_002dfun"></a><dl>
<dt><a name="index-copylist_002a"></a>Function: <strong>copylist*</strong> <em>list &amp;optional area</em></dt>
<dd><p>This is the same as <code>copylist</code> except that the last cons of the
resulting list is never cdr-coded (see <a href="#cdr_002dcode">cdr-code</a>).  This makes for
increased efficiency if you <code>nconc</code> something onto the list later.
</p></dd></dl>

<a name="copyalist_002dfun"></a><dl>
<dt><a name="index-copyalist"></a>Function: <strong>copyalist</strong> <em>list &amp;optional area</em></dt>
<dd><p><code>copyalist</code> is for copying association lists (see
<a href="#assoc_002dlists_002dsection">assoc-lists-section</a>).  The <em>list</em> is copied, as in <code>copylist</code>.
In addition, each element of <em>list</em> which is a cons is replaced in the
copy by a new cons with the same car and cdr.  You may optionally
specify the area in which to create the new copy.
</p></dd></dl>

<a name="copytree_002dfun"></a><dl>
<dt><a name="index-copytree"></a>Function: <strong>copytree</strong> <em>tree &amp;optional area</em></dt>
<dd><p><code>copytree</code> copies all the conses of a tree and makes a new maximally
cdr-coded tree with the same fringe.  If <em>area</em> is specified, the new
tree is constructed in that area.
</p></dd></dl>

<a name="reverse_002dfun"></a><dl>
<dt><a name="index-reverse"></a>Function: <strong>reverse</strong> <em>list</em></dt>
<dd><p><code>reverse</code> creates a new list whose elements
are the elements of <em>list</em> taken in reverse order.
<code>reverse</code> does not modify its argument, unlike <code>nreverse</code> which is faster
but does modify its argument.  The list created by <code>reverse</code> is not cdr-coded.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(reverse '(a b (c d) e)) =&gt; (e (c d) b a)
</pre></div>
<p><code>reverse</code> could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun reverse (x)
    (do ((l x (cdr l))         ;<span class="roman"> scan down argument,</span>
         (r nil                ;<span class="roman"> putting each element</span>
            (cons (car l) r))) ;<span class="roman"> into list, until</span>
        ((null l) r)))         ;<span class="roman"> no more elements.</span>
</pre></div>
</dd></dl>

<a name="nreverse_002dfun"></a><dl>
<dt><a name="index-nreverse"></a>Function: <strong>nreverse</strong> <em>list</em></dt>
<dd><p><code>nreverse</code> reverses its argument, which should be a list.  The argument
is destroyed by <code>rplacd</code>&rsquo;s all through the list (cf <code>reverse</code>).
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(nreverse '(a b c)) =&gt; (c b a)
</pre></div>
<p><code>nreverse</code> could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun nreverse  (x)
    (cond ((null x) nil)
          ((nreverse1 x nil))))

(defun nreverse1 (x y)		;<span class="roman">auxiliary function</span>
    (cond ((null (cdr x)) (rplacd x y))
          ((nreverse1 (cdr x) (rplacd x y)))))
          ;;<span class="roman"> this last call depends on order of argument evaluation.</span>
</pre></div>

<p>Currently, <code>nreverse</code> does something inefficient with cdr-coded lists (see
<a href="#cdr_002dcode">cdr-code</a>), because it just uses <code>rplacd</code> in the
straightforward way.  This may be fixed someday.  In the meantime
<code>reverse</code> might be preferable in some cases.
</p></dd></dl>

<a name="append_002dfun"></a><dl>
<dt><a name="index-append"></a>Function: <strong>append</strong> <em>&amp;rest lists</em></dt>
<dd><p>The arguments to <code>append</code> are lists.  The result is a list which is the
concatenation of the arguments.
The arguments are not changed (cf <code>nconc</code>).
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(append '(a b c) '(d e f) nil '(g)) =&gt; (a b c d e f g)
</pre></div>
<p><code>append</code> makes copies of the conses of all the lists it is given,
except for the last one.  So the new list will share the conses
of the last argument to append, but all of the other conses will be newly
created.  Only the lists are copied, not the elements of the lists.
</p>
<p>A version of <code>append</code> which only accepts two arguments could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun append2 (x y)
    (cond ((null x) y)
          ((cons (car x) (append2 (cdr x) y)) )))
</pre></div>

<p>The generalization to any number of arguments could then be made (relying on
car of <code>nil</code> being <code>nil</code>):
</p><div class="lisp">
<pre class="lisp">(defun append (&amp;rest args)
  (if (&lt; (length args) 2) (car args)
      (append2 (car args)
	       (apply (function append) (cdr args)))))
</pre></div>

<p>These definitions do not express the full functionality of <code>append</code>;
the real definition minimizes storage utilization by turning all the
arguments that are copied into one cdr-coded list.
</p>
<p>To copy a list, use <code>copylist</code> (see <a href="#copylist_002dfun">copylist-fun</a>); the old practice
of using <code>append</code> to copy lists is unclear and obsolete.
</p></dd></dl>

<a name="nconc_002dfun"></a><dl>
<dt><a name="index-nconc"></a>Function: <strong>nconc</strong> <em>&amp;rest lists</em></dt>
<dd><p><code>nconc</code> takes lists as arguments.  It returns a list which is the arguments
concatenated together.  The arguments are changed, rather than copied
(cf <code>append</code>, <a href="#append_002dfun">append-fun</a>).
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq x '(a b c))
(setq y '(d e f))
(nconc x y) =&gt; (a b c d e f)
x =&gt; (a b c d e f)
</pre></div>
<p>Note that the value of <code>x</code> is now different, since its last cons has been <code>rplacd</code>&rsquo;d to
the value of <code>y</code>.
If the nconc form is evaluated again, it would yield a piece of &quot;circular&quot; list
structure, whose printed representation would be
<code>(a b c d e f d e f d e f ...)</code>, repeating forever.
</p>
<p><code>nconc</code> could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun nconc (x y)		 ;<span class="roman">for simplicity, this definition</span>
    (cond ((null x) y)		 ;<span class="roman">only works for 2 arguments.</span>
          (t (rplacd (last x) y) ;<span class="roman">hook <code>y</code> onto </span>x
	     x)))		 ;<span class="roman">and return the modified <code>x</code>.</span>
</pre></div>
</dd></dl>

<a name="nreconc_002dfun"></a><dl>
<dt><a name="index-nreconc"></a>Function: <strong>nreconc</strong> <em>x y</em></dt>
<dd><p><code>(nreconc <em>x y</em>)</code> is exactly the same as 
<code>(nconc (nreverse <em>x</em>) <em>y</em>)</code> except that it is more 
efficient.  Both <em>x</em> and <em>y</em> should be lists.
</p>
<p><code>nreconc</code> could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun nreconc (x y)
    (cond ((null x) y)
          ((nreverse1 x y)) ))
</pre></div>
<p>using the same <code>nreverse1</code> as above.
</p></dd></dl>

<a name="butlast_002dfun"></a><dl>
<dt><a name="index-butlast"></a>Function: <strong>butlast</strong> <em>list</em></dt>
<dd><p>This creates and returns a list with the same elements as <em>list</em>,
excepting the last element.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(butlast '(a b c d)) =&gt; (a b c)
(butlast '((a b) (c d))) =&gt; ((a b))
(butlast '(a)) =&gt; nil
(butlast nil) =&gt; nil
</pre></div>
<p>The name is from the phrase &quot;all elements but the last&quot;.
</p></dd></dl>

<a name="nbutlast_002dfun"></a><dl>
<dt><a name="index-nbutlast"></a>Function: <strong>nbutlast</strong> <em>list</em></dt>
<dd><p>This is the destructive version of <code>butlast</code>; it changes the cdr of
the second-to-last cons of the list to nil.  If there is no
second-to-last cons (that is, if the list has fewer than two elements)
it returns <code>nil</code>. 
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(setq foo '(a b c d))
(nbutlast foo) =&gt; (a b c)
foo =&gt; (a b c)
(nbutlast '(a)) =&gt; nil
</pre></div>
</dd></dl>

<a name="firstn_002dfun"></a><dl>
<dt><a name="index-firstn"></a>Function: <strong>firstn</strong> <em>n list</em></dt>
<dd><p><code>firstn</code> returns a list of length <em>n</em>, whose elements are the
first <em>n</em> elements of <code>list</code>.  If <em>list</em> is fewer than
<em>n</em> elements long, the remaining elements of the returned list
will be <code>nil</code>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(firstn 2 '(a b c d)) =&gt; (a b)
(firstn 0 '(a b c d)) =&gt; nil
(firstn 6 '(a b c d)) =&gt; (a b c d nil nil)
</pre></div>
</dd></dl>

<a name="nleft_002dfun"></a><dl>
<dt><a name="index-nleft"></a>Function: <strong>nleft</strong> <em>n list &amp;optional tail</em></dt>
<dd><p>Returns a &quot;tail&quot; of <em>list</em>, i.e one of the conses that makes up <em>list</em>, or <code>nil</code>.
<code>(nleft <em>n</em> <em>list</em>)</code> returns the last <em>n</em> elements of <em>list</em>.
If <em>n</em> is too large, <code>nleft</code> will return <em>list</em>.
</p>
<p><code>(nleft <em>n</em> <em>list</em> <em>tail</em>)</code> takes cdr of <em>list</em> enough times
that taking <em>n</em> more cdrs would yield <em>tail</em>, and returns that.
You can see that when <em>tail</em> is <code>nil</code> this is the same as the two-argument case.
If <em>tail</em> is not <code>eq</code> to any tail of <em>list</em>, <code>nleft</code> will return <code>nil</code>.
</p></dd></dl>

<a name="ldiff_002dfun"></a><dl>
<dt><a name="index-ldiff"></a>Function: <strong>ldiff</strong> <em>list tail</em></dt>
<dd><p><em>list</em> should be a list, and <em>tail</em> should be one of the conses
that make up <em>list</em>.  <code>ldiff</code> (meaning &quot;list difference&quot;) will return
a new list, whose elements are those elements of <em>list</em> that appear
before <em>tail</em>.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(setq x '(a b c d e))
(setq y (cdddr x)) =&gt; (d e)
(ldiff x y) =&gt; (a b c)
(ldiff x nil) =&gt; (a b c d e)
(ldiff x x) =&gt; nil
</pre><pre class="lisp">but
</pre><pre class="lisp">(ldiff '(a b c d) '(c d)) =&gt; (a b c d)
</pre><pre class="lisp">since the <em>tail</em> was not <code>eq</code> to any part of the <em>list</em>.
</pre></div>
</dd></dl>

<a name="union_002dfun"></a><dl>
<dt><a name="index-union"></a>Function: <strong>union</strong> <em>list &amp;rest more-lists</em></dt>
<dd><p>If lists are regarded as sets of their elements, <code>union</code> returns a
list which is the union of the lists which are supplied as arguments.
If none of the arguments contains any duplicate elements, neither does
the value returned by <code>union</code>.  Elements are compared using <code>eq</code>.
</p></dd></dl>

<a name="intersection_002dfun"></a><dl>
<dt><a name="index-intersection"></a>Function: <strong>intersection</strong> <em>list &amp;rest more-lists</em></dt>
<dd><p>If lists are regarded as sets of their elements, <code>intersection</code> returns a
list which is the intersection of the lists which are supplied as arguments.
If <em>list</em> contains no duplicate elements, neither does
the value returned by <code>intersection</code>.  Elements are compared using <code>eq</code>.
</p></dd></dl>

<a name="nunion_002dfun"></a><dl>
<dt><a name="index-nunion"></a>Function: <strong>nunion</strong> <em>list &amp;rest more-lists</em></dt>
<dd><p>If lists are regarded as sets of their elements, <code>nunion</code> modifies
<em>list</em> to become the union of the lists which are supplied as
arguments.  This is done by adding on, at the end, any elements of the
other lists that were not already in <em>list</em>.  If none of the arguments
contains any duplicate elements, neither does the value returned by
<code>nunion</code>.  Elements are compared using <code>eq</code>.
</p>
<p>As with <code>delq</code>, <code>nunion</code>&rsquo;s value should be stored in place of the
first argument if you want to be sure that the argument is changed.
Consider what happens if the argument&rsquo;s initial value is <code>nil</code>.
</p></dd></dl>

<a name="nintersection_002dfun"></a><dl>
<dt><a name="index-nintersection"></a>Function: <strong>nintersection</strong> <em>list &amp;rest more-lists</em></dt>
<dd><p>If lists are regarded as sets of their elements, <code>intersection</code>
modifies <em>list</em> to be the intersection of the lists which are
supplied as arguments.  This is done by deleting any elements which do
not belong to the intersection.
If <em>list</em> initially contains no duplicate elements, neither does
the value returned by <code>nintersection</code>.  Elements are compared using <code>eq</code>.
</p>
<p>As with <code>delq</code>, <code>nunion</code>&rsquo;s value should be stored in place of the
first argument if you want to be sure that the argument is changed.
Consider what happens if the argument&rsquo;s first element is removed.
</p></dd></dl>

<a name="g_t_0022Alteration-of-List-Structure_0022"></a>
<h3 class="section">5.3 &quot;Alteration of List Structure&quot;</h3>

<p>The functions <code>rplaca</code> and <code>rplacd</code>
are used to make alterations in already-existing
list structure; that is, to change the cars and cdrs of existing conses.
</p>
<p>The structure is not copied but is physically altered; hence caution
should be exercised when using these functions, as strange side-effects
can occur if portions of list structure become shared unbeknownst to the
programmer.  The <code>nconc</code>, <code>nreverse</code>, <code>nreconc</code>, and <code>nbutlast</code>
functions already described, and the <code>delq</code> family described later,
have the same property.
</p>
<a name="rplaca_002dfun"></a><dl>
<dt><a name="index-rplaca"></a>Function: <strong>rplaca</strong> <em>x y</em></dt>
<dd><p><code>(rplaca <em>x y</em>)</code> changes the car of <em>x</em> to <em>y</em> and returns
(the modified) <em>x</em>.  <em>x</em> must be a cons or a locative.  <em>y</em> may be any Lisp object.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq g '(a b c))
(rplaca (cdr g) 'd) =&gt; (d c)
<span class="roman">Now</span> g =&gt; (a d c)
</pre></div>
</dd></dl>

<a name="rplacd_002dfun"></a><dl>
<dt><a name="index-rplacd"></a>Function: <strong>rplacd</strong> <em>x y</em></dt>
<dd><p><code>(rplacd <em>x y</em>)</code> changes the cdr of <em>x</em> to <em>y</em> and returns
(the modified) <em>x</em>.  <em>x</em> must be a cons or a locative.  <em>y</em> may be any Lisp object.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq x '(a b c))
(rplacd x 'd) =&gt; (a . d)
<span class="roman">Now</span> x =&gt; (a . d)
</pre></div>
</dd></dl>

<a name="index-_0022substitution_0022"></a>
<a name="subst_002dfun"></a><dl>
<dt><a name="index-subst-2"></a>Function: <strong>subst</strong> <em>new old tree</em></dt>
<dd><p><code>(subst <em>new old tree</em>)</code> substitutes <em>new</em> for all occurrences of <em>old</em>
in <em>tree</em>, and returns the modified copy of <em>tree</em>.  The original <em>tree</em>
is unchanged, as <code>subst</code> recursively copies all of <em>tree</em> replacing
elements <code>equal</code> to <em>old</em> as it goes.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(subst 'Tempest 'Hurricane
       '(Shakespeare wrote (The Hurricane)))
    =&gt; (Shakespeare wrote (The Tempest))
</pre></div>

<p><code>subst</code> could have been defined by:
</p>
<div class="lisp">
<pre class="lisp">(defun subst (new old tree)
    (cond ((equal tree old) new) ;<span class="roman">if item equal to old, replace.</span>
          ((atom tree) tree)     ;<span class="roman">if no substructure, return arg.</span>
          ((cons (subst new old (car tree))  ;<span class="roman">otherwise recurse.</span>
                 (subst new old (cdr tree))))))
</pre></div>
<p>Note that this function is not &quot;destructive&quot;; that is, it does not change
the car or cdr of any already-existing list structure.
</p>
<p>To copy a tree, use <code>copytree</code> (see <a href="#copytree_002dfun">copytree-fun</a>); the old practice
of using <code>subst</code> to copy trees is unclear and obsolete.
</p>
<p>Note: certain details of <code>subst</code> may be changed in the future.  It may
possibly be changed to use <code>eq</code> rather than <code>equal</code> for the comparison,
and possibly may substitute only in cars, not in cdrs.  This is still being
discussed.
</p></dd></dl>

<a name="nsubst_002dfun"></a><dl>
<dt><a name="index-nsubst"></a>Function: <strong>nsubst</strong> <em>new old tree</em></dt>
<dd><p><code>nsubst</code> is a destructive version of <code>subst</code>.  The list structure of
<em>tree</em> is altered by replacing each occurrence of <em>old</em> with
<em>new</em>.  <code>nsubst</code> could have been defined as
</p><div class="lisp">
<pre class="lisp">(defun nsubst (new old tree)
    (cond ((eq tree old) new)	  ;<span class="roman">If item eq to old, replace.</span>
          ((atom tree) tree)      ;<span class="roman">If no substructure, return arg.</span>
	  (t                      ;<span class="roman">Otherwise, recurse.</span>
	     (rplaca tree (nsubst new old (car tree)))
	     (rplacd tree (nsubst new old (cdr tree)))
	     tree)))
</pre></div>
</dd></dl>

<a name="sublis_002dfun"></a><dl>
<dt><a name="index-sublis"></a>Function: <strong>sublis</strong> <em>alist tree</em></dt>
<dd><p><code>sublis</code> makes substitutions for symbols in a tree.  The first
argument to <code>sublis</code> is an association list (see
<a href="#assoc_002dlists_002dsection">assoc-lists-section</a>).  The second argument is the tree in which
substitutions are to be made.  <code>sublis</code> looks at all symbols in the
fringe of the tree; if a symbol appears in the association list
occurrences of it are replaced by the object it is associated with.  The
argument is not modified; new conses are created where necessary and
only where necessary, so the newly created tree shares as much of its
substructure as possible with the old.  For example, if no substitutions
are made, the result is just the old tree.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(sublis '((x . 100) (z . zprime))
        '(plus x (minus g z x p) 4))
   =&gt; (plus 100 (minus g zprime 100 p) 4)
</pre></div>

<div class="lisp">
<pre class="lisp"><code>sublis</code> could have been defined by:
</pre><pre class="lisp">(defun sublis (alist sexp)
  (cond ((atom sexp)
	 (let ((tem (assq sexp alist)))
	   (if tem (cdr tem) sexp)))
	((let ((car (sublis alist (car sexp)))
	       (cdr (sublis alist (cdr sexp))))
	   (if (and (eq (car sexp) car) (eq (cdr sexp) cdr))
	       sexp
	       (cons car cdr))))))
</pre></div>
</dd></dl>

<a name="nsublis_002dfun"></a><dl>
<dt><a name="index-nsublis"></a>Function: <strong>nsublis</strong> <em>alist tree</em></dt>
<dd><p><code>nsublis</code> is like <code>sublis</code> but changes the original tree
instead of creating new.
</p>
<div class="lisp">
<pre class="lisp"><code>nsublis</code> could have been defined by:
</pre><pre class="lisp">(defun nsublis (alist tree)
  (cond ((atom tree)
	 (let ((tem (assq tree alist)))
	   (if tem (cdr tem) tree)))
	(t (rplaca tree (nsublis alist (car tree)))
	   (rplacd tree (nsublis alist (cdr tree)))
	   tree)))
</pre></div>
</dd></dl>

<a name="g_t_0022Cdr_002dCoding_0022"></a>
<h3 class="section">5.4 &quot;Cdr-Coding&quot;</h3>
<a name="cdr_002dcode"></a>
<p>This section explains the internal data format used to store conses
inside the Lisp Machine.  Casual users don&rsquo;t have to worry about this;
you can skip this section if you want.  It is only important to read
this section if you require extra storage efficiency in your program.
</p>
<p>The usual and obvious internal representation of conses in any
implementation of Lisp is as a pair of pointers, contiguous in memory.
If we call the amount of storage that it takes to store a Lisp pointer a
&quot;word&quot;, then conses normally occupy two words.  One word (say it&rsquo;s the
first) holds the car, and the other word (say it&rsquo;s the second) holds the
cdr.  To get the car or cdr of a list, you just reference this memory
location, and to change the car or cdr, you just store into this memory
location.
</p>
<p>Very often, conses are used to store lists.  If the above representation
is used, a list of <em>n</em> elements requires two times <em>n</em> words of
memory: <em>n</em> to hold the pointers to the elements of the list, and
<em>n</em> to point to the next cons or to <code>nil</code>.  To optimize this
particular case of using conses, the Lisp Machine uses a storage
representation called &quot;cdr coding&quot; to store lists.  The basic goal is to
allow a list of <em>n</em> elements to be stored in only <em>n</em> locations,
while allowing conses that are not parts of lists to be stored in the
usual way.
</p>
<p>The way it works is that there is an extra two-bit field in every word
of memory, called the &quot;cdr-code&quot; field.  There are three meaningful
values that this field can have, which are called cdr-normal, cdr-next,
and cdr-nil.  The regular, non-compact way to store a cons is by two
contiguous words, the first of which holds the car and the second of
which holds the cdr.  In this case, the cdr code of the first word is
cdr-normal.  (The cdr code of the second word doesn&rsquo;t matter; as we will
see, it is never looked at.)  The cons is represented by a pointer to
the first of the two words.  When a list of <em>n</em> elements is stored in
the most compact way, pointers to the <em>n</em> elements occupy <em>n</em>
contiguous memory locations.  The cdr codes of all these locations are
cdr-next, except the last location whose cdr code is cdr-nil.  The
list is represented as a pointer to the first of the <em>n</em> words.
</p>
<p>Now, how are the basic operations on conses defined to work based on
this data structure?  Finding the car is easy: you just read the
contents of the location addressed by the pointer.  Finding the cdr is
more complex.  First you must read the contents of the location
addressed by the pointer, and inspect the cdr-code you find there.  If
the code is cdr-normal, then you add one to the pointer, read the
location it addresses, and return the contents of that location; that
is, you read the second of the two words.  If the code is cdr-next, you
add one to the pointer, and simply return that pointer without doing any
more reading; that is, you return a pointer to the next word in the
<em>n</em>-word block.  If the code is cdr-nil, you simply return <code>nil</code>.
</p>
<p>If you examine these rules, you will find that they work fine even if
you mix the two kinds of storage representation within the same list.
There&rsquo;s no problem with doing that.
</p>
<p>How about changing the structure?  Like <code>car</code>, <code>rplaca</code> is very easy; you
just store into the location addressed by the pointer.  To do <code>rplacd</code>
you must read the location addressed by the pointer and examine the cdr
code.  If the code is cdr-normal, you just store into the location one
greater than that addressed by the pointer; that is, you store into the
second word of the two words.  But if the cdr-code is cdr-next or
cdr-nil, there is a problem: there is no memory cell that is storing the
cdr of the cons.  That is the cell that has been optimized out; it just
doesn&rsquo;t exist.
</p>
<p>This problem is dealt with by the use of &quot;invisible pointers&quot;.  An
invisible pointer is a special kind of pointer, recognized by its data
type (Lisp Machine pointers include a data type field as well as an
address field).  The way they work is that when the Lisp Machine reads a
word from memory, if that word is an invisible pointer then it proceeds
to read the word pointed to by the invisible pointer and use that word
instead of the invisible pointer itself.  Similarly, when it writes to a
location, it first reads the location, and if it contains an invisible
pointer then it writes to the location addressed by the invisible
pointer instead.  (This is a somewhat simplified explanation; actually
there are several kinds of invisible pointer that are interpreted in
different ways at different times, used for things other than the cdr coding
scheme.)
</p>
<p>Here&rsquo;s how to do <code>rplacd</code> when the cdr code is cdr-next or cdr-nil.  Call
the location addressed by the first argument to <code>rplacd</code> <em>l</em>.  First,
you allocate two contiguous words in the same area that <em>l</em> points to.
Then you store the old contents of <em>l</em> (the car of the cons) and
the second argument to <code>rplacd</code> (the new cdr of the cons) into these two
words.  You set the cdr-code of the first of the two words to cdr-normal.
Then you write an invisible pointer, pointing at the first of the two
words, into location <em>l</em>.  (It doesn&rsquo;t matter what the cdr-code of
this word is, since the invisible pointer data type is checked first,
as we will see.)
</p>
<p>Now, whenever any operation is done to the cons (<code>car</code>, <code>cdr</code>, <code>rplaca</code>, or
<code>rplacd</code>), the initial reading of the word pointed to by the Lisp pointer
that represents the cons will find an invisible pointer in the addressed
cell.  When the invisible pointer is seen, the address it contains is
used in place of the original address.  So the newly-allocated two-word
cons will be used for any operation done on the original object.
</p>
<p>Why is any of this important to users?  In fact, it is all invisible to
you; everything works the same way whether or not compact representation
is used, from the point of view of the semantics of the language.  That
is, the only difference that any of this makes is a difference in
efficiency.  The compact representation is more efficient in most cases.
However, if the conses are going to get <code>rplacd</code>&rsquo;ed, then invisible
pointers will be created, extra memory will be allocated, and the
compact representation will be seen to degrade storage efficiency rather
than improve it.  Also, accesses that go through invisible pointers are
somewhat slower, since more memory references are needed.  So if you
care a lot about storage efficiency, you should be careful about which
lists get stored in which representations.
</p>
<p>You should try to use the normal representation for those data
structures that will be subject to <code>rplacd</code> operations, including
<code>nconc</code> and <code>nreverse</code>, and the compact representation for other
structures.  The functions <code>cons</code>, <code>xcons</code>, <code>ncons</code>, and their
area variants make conses in the normal representation.  The functions
<code>list</code>, <code>list*</code>, <code>list-in-area</code>, <code>make-list</code>, and <code>append</code> use
the compact representation.  The other list-creating functions,
including <code>read</code>, currently make normal lists, although this might get
changed.  Some functions, such as <code>sort</code>, take special care to operate
efficiently on compact lists (<code>sort</code> effectively treats them as
arrays).  <code>nreverse</code> is rather slow on compact lists, currently, since
it simple-mindedly uses <code>rplacd</code>, but this will be changed.
</p>
<p><code>(copylist <em>x</em>)</code> is a suitable way to copy a
list, converting it into compact form (see <a href="#copylist_002dfun">copylist-fun</a>).
</p>
<a name="g_t_0022Tables_0022"></a>
<h3 class="section">5.5 &quot;Tables&quot;</h3>

<p>Zetalisp includes functions which simplify the maintenance
of tabular data structures of several varieties.  The simplest is
a plain list of items, which models (approximately) the concept of a <em>set</em>.
<a name="index-_0022set_0022"></a>
There are functions to add (<code>cons</code>), remove (<code>delete</code>, <code>delq</code>,
<code>del</code>, <code>del-if</code>, <code>del-if-not</code>, <code>remove</code>, <code>remq</code>, <code>rem</code>,
<code>rem-if</code>, <code>rem-if-not</code>),
and search for (<code>member</code>, <code>memq</code>, <code>mem</code>) items in a list.
Set union, intersection, and difference functions can be easily written using these.
</p>
<a name="assoc_002dlists_002dsection"></a><a name="index-_0022association-list_0022"></a>
<a name="index-alist"></a>
<p><em>Association lists</em> are very commonly used.  An association list
is a list of conses.  The car of each cons is a &quot;key&quot; and the cdr
is a &quot;datum&quot;, or a list of associated data.  The functions
<code>assoc</code>, <code>assq</code>, <code>ass</code>, <code>memass</code>, and <code>rassoc</code>
may be used to retrieve the data, given the key.  For example,
</p><div class="lisp">
<pre class="lisp">((tweety . bird) (sylvester . cat))
</pre></div>
<p>is an association list with two elements.  Given a symbol representing
the name of an animal, it can retrieve what kind of animal this is.
</p>
<p><em>Structured records</em> can be stored as association lists or as
stereotyped cons-structures where each element of the structure has a certain
car-cdr path associated with it.  However, these are better implemented
using structure macros (see <a href="#defstruct">defstruct</a>) or as flavors (<a href="#flavor">flavor</a>).
</p>
<p>Simple list-structure is very convenient, but may not be efficient enough
for large data bases because it takes a long time to search a long list.
Zetalisp includes hash table facilities for more efficient
but more complex tables (see <a href="#hash_002dtable">hash-table</a>), and
a hashing function (<code>sxhash</code>) to aid users in constructing their own facilities.
</p>
<a name="Lists-as-Tables"></a>
<h3 class="section">5.6 Lists as Tables</h3>

<a name="memq_002dfun"></a><dl>
<dt><a name="index-memq"></a>Function: <strong>memq</strong> <em>item list</em></dt>
<dd><p><code>(memq <em>item list</em>)</code> returns <code>nil</code> if <em>item</em> is not one of the
elements of <em>list</em>.  Otherwise, it returns the sublist of <em>list</em>
beginning with the first occurrence of <em>item</em>; that is, it returns the
first cons of the list whose car is <em>item</em>.  The comparison is made by
<code>eq</code>.  Because <code>memq</code> returns <code>nil</code> if it doesn&rsquo;t find anything,
and something non-<code>nil</code> if it finds something, it is often used as a
predicate.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(memq 'a '(1 2 3 4)) =&gt; nil
(memq 'a '(g (x a y) c a d e a f)) =&gt; (a d e a f)
</pre></div>
<p>Note that the value returned by <code>memq</code> is <code>eq</code> to the portion of the list
beginning with <code>a</code>.
Thus <code>rplaca</code> on the result of <code>memq</code> may be used,
if you first check to make sure <code>memq</code> did not return <code>nil</code>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(let ((sublist (memq x z)))	;<span class="roman">Search for <code>x</code> in the list <code>z</code>.</span>
  (if (not (null sublist))      ;<span class="roman">If it is found,</span>
      (rplaca sublist y)))	;<span class="roman">Replace it with <code>y</code>.</span>
</pre></div>

<div class="lisp">
<pre class="lisp"><code>memq</code> could have been defined by:
</pre><pre class="lisp">(defun memq (item list)
    (cond ((null list) nil)
          ((eq item (car list)) list)
          (t (memq item (cdr list))) ))
</pre></div>

<p><code>memq</code> is hand-coded in microcode and therefore especially fast.
</p></dd></dl>

<a name="member_002dfun"></a><dl>
<dt><a name="index-member"></a>Function: <strong>member</strong> <em>item list</em></dt>
<dd><p><code>member</code> is like <code>memq</code>, except <code>equal</code> is used for the comparison,
instead of <code>eq</code>.
</p>
<p><code>member</code> could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun member (item list)
    (cond ((null list) nil)
          ((equal item (car list)) list)
          (t (member item (cdr list))) ))
</pre></div>
</dd></dl>


<a name="mem_002dfun"></a><dl>
<dt><a name="index-mem"></a>Function: <strong>mem</strong> <em>predicate item list</em></dt>
<dd><p><code>mem</code> is the same as <code>memq</code> except that it takes an extra argument
which should be a predicate of two arguments, which is used for the
comparison instead of <code>eq</code>.  <code>(mem 'eq a b)</code> is the same as
<code>(memq a b)</code>.  <code>(mem 'equal a b)</code> is the same as <code>(member a b)</code>.
	<code>mem</code> is usually used with equality predicates other than
<code>eq</code> and <code>equal</code>, such as <code>=</code>, <code>char-equal</code> or <code>string-equal</code>.
It can also be used with non-commutative predicates.  The predicate
is called with <em>item</em> as its first argument and the element of <em>list</em>
as its second argument, so
</p><div class="lisp">
<pre class="lisp">(mem #'&lt; 4 list)
</pre></div>
<p>finds the first element in <em>list</em> for which <code>(&lt; 4 <em>x</em>)</code> is true;
that is, it finds the first element greater than <code>4</code>.
</p></dd></dl>

<a name="find_002dposition_002din_002dlist_002dfun"></a><dl>
<dt><a name="index-find_002dposition_002din_002dlist"></a>Function: <strong>find-position-in-list</strong> <em>item list</em></dt>
<dd><p><code>find-position-in-list</code> looks down <em>list</em> for an element which
is <code>eq</code> to <em>item</em>, like <code>memq.</code>  However, it returns the numeric index
in the list at which it found the first occurence of <em>item</em>, or
<code>nil</code> if it did not find it at all.  This function is sort of
the complement of <code>nth</code> (see <a href="#nth_002dfun">nth-fun</a>); like <code>nth</code>, it is zero-based.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(find-position-in-list 'a '(a b c)) =&gt; 0
(find-position-in-list 'c '(a b c)) =&gt; 2
(find-position-in-list 'e '(a b c)) =&gt; nil
</pre></div>
</dd></dl>

<a name="find_002dposition_002din_002dlist_002dequal_002dfun"></a><dl>
<dt><a name="index-find_002dposition_002din_002dlist_002dequal"></a>Function: <strong>find-position-in-list-equal</strong> <em>item list</em></dt>
<dd><p><code>find-position-in-list-equal</code> is exactly the same as
<code>find-position-in-list</code>, except that the comparison is done
with <code>equal</code> instead of <code>eq</code>.
</p></dd></dl>

<a name="tailp_002dfun"></a><dl>
<dt><a name="index-tailp"></a>Function: <strong>tailp</strong> <em>sublist list</em></dt>
<dd><p>Returns <code>t</code> if <em>sublist</em> is a sublist of <em>list</em> (i.e
one of the conses that makes up <em>list</em>).  Otherwise returns <code>nil</code>.
Another way to look at this is that <code>tailp</code> returns <code>t</code> if
<code>(nthcdr <em>n</em> <em>list</em>)</code> is <em>sublist</em>, for some value of <em>n</em>.
<code>tailp</code> could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun tailp (sublist list)
    (do list list (cdr list) (null list)
      (if (eq sublist list)
	  (return t))))
</pre></div>
</dd></dl>

<a name="delq_002dfun"></a><dl>
<dt><a name="index-delq"></a>Function: <strong>delq</strong> <em>item list &amp;optional n</em></dt>
<dd><p><code>(delq <em>item list</em>)</code> returns the <em>list</em> with all
occurrences of <em>item</em> removed.  <code>eq</code> is used for the comparison. 
The argument <em>list</em> is actually modified (<code>rplacd</code>&rsquo;ed) when instances
of <em>item</em> are spliced out.  <code>delq</code> should be used for value, not
for effect.  That is, use
</p><div class="lisp">
<pre class="lisp">(setq a (delq 'b a))
</pre></div>
<p>rather than
</p><div class="lisp">
<pre class="lisp">(delq 'b a)
</pre></div>
<p>These two are <em>not</em> equivalent when the first element
of the value of <code>a</code> is <code>b</code>.
</p>
<p><code>(delq <em>item list n</em>)</code> is like <code>(delq <em>item list</em>)</code> except only the first
<em>n</em> instances of <em>item</em> are deleted.  <em>n</em> is allowed to be zero. 
If <em>n</em> is greater than or equal to the number of occurrences of <em>item</em> in the
list, all occurrences of <em>item</em> in the list will be deleted. 
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(delq 'a '(b a c (a b) d a e)) =&gt; (b c (a b) d e)
</pre></div>

<p><code>delq</code> could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun delq (item list &amp;optional (n -1))
    (cond ((or (atom list) (zerop n)) list)
          ((eq item (car list))
	   (delq item (cdr list) (1- n)))
          (t (rplacd list (delq item (cdr list) n)))))
</pre></div>
<p>If the third argument (<em>n</em>) is not supplied, it defaults to <code>-1</code> which
is effectively infinity since it can be decremented any number of times without
reaching zero.
</p></dd></dl>

<a name="delete_002dfun"></a><dl>
<dt><a name="index-delete"></a>Function: <strong>delete</strong> <em>item list &amp;optional n</em></dt>
<dd><p><code>delete</code> is the same as <code>delq</code> except that <code>equal</code> is used for the comparison
instead of <code>eq</code>.
</p></dd></dl>

<a name="del_002dfun"></a><dl>
<dt><a name="index-del"></a>Function: <strong>del</strong> <em>predicate item list &amp;optional n</em></dt>
<dd><p><code>del</code> is the same as <code>delq</code> except that it takes an extra argument
which should be a predicate of two arguments, which is used for the
comparison instead of <code>eq</code>.  <code>(del 'eq a b)</code> is the same as
<code>(delq a b)</code>. (cf <code>mem</code>, <a href="#mem_002dfun">mem-fun</a>)
</p></dd></dl>

<a name="remq_002dfun"></a><dl>
<dt><a name="index-remq"></a>Function: <strong>remq</strong> <em>item list &amp;optional n</em></dt>
<dd><p><code>remq</code> is similar to <code>delq</code>, except that the list is not altered;
rather, a new list is returned.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(setq x '(a b c d e f))
(remq 'b x) =&gt; (a c d e f)
x =&gt; (a b c d e f)
(remq 'b '(a b c b a b) 2) =&gt; (a c a b)
</pre></div>
</dd></dl>

<a name="remove_002dfun"></a><dl>
<dt><a name="index-remove"></a>Function: <strong>remove</strong> <em>item list &amp;optional n</em></dt>
<dd><p><code>remove</code> is the same as <code>remq</code> except that <code>equal</code> is used for the
comparison instead of <code>eq</code>.
</p></dd></dl>

<a name="rem_002dfun"></a><dl>
<dt><a name="index-rem"></a>Function: <strong>rem</strong> <em>predicate item list &amp;optional n</em></dt>
<dd><p><code>rem</code> is the same as <code>remq</code> except that it takes an extra argument
which should be a predicate of two arguments, which is used for the
comparison instead of <code>eq</code>.  <code>(rem 'eq a b)</code> is the same as
<code>(remq a b)</code>. (cf <code>mem</code>, <a href="#mem_002dfun">mem-fun</a>)
</p></dd></dl>

<a name="subset_002dfun"></a><dl>
<dt><a name="index-subset"></a>Function: <strong>subset</strong> <em>predicate list</em></dt>
<dd><a name="rem_002dif_002dnot_002dfun"></a></dd><dt><a name="index-rem_002dif_002dnot"></a>Function: <strong>rem-if-not</strong> <em>predicate list</em></dt>
<dd><p><em>predicate</em> should be a function of one argument.
A new list is made by applying <em>predicate</em> to
all of the elements of <em>list</em> and removing the ones for which the predicate 
returns <code>nil</code>.  One of this function&rsquo;s names (<code>rem-if-not</code>)
means &quot;remove if this condition is not true&quot;; i.e it keeps the elements
for which <em>predicate</em> is true.  The other name (<code>subset</code>) refers to
the function&rsquo;s action if <em>list</em> is considered to represent a mathematical set.
</p></dd></dl>

<a name="subset_002dnot_002dfun"></a><dl>
<dt><a name="index-subset_002dnot"></a>Function: <strong>subset-not</strong> <em>predicate list</em></dt>
<dd><a name="rem_002dif_002dfun"></a></dd><dt><a name="index-rem_002dif"></a>Function: <strong>rem-if</strong> <em>predicate list</em></dt>
<dd><p><em>predicate</em> should be a function of one argument.
A new list is made by applying <em>predicate</em> to
all of the elements of <em>list</em> and removing the ones for which the predicate 
returns non-<code>nil</code>.  One of this function&rsquo;s names (<code>rem-if</code>)
means &quot;remove if this condition is true&quot;.  The other name (<code>subset-not</code>)
refers to the function&rsquo;s action if <em>list</em> is considered to represent
a mathematical set.
</p></dd></dl>

<a name="del_002dif_002dfun"></a><dl>
<dt><a name="index-del_002dif"></a>Function: <strong>del-if</strong> <em>predicate list</em></dt>
<dd><p><code>del-if</code> is just like <code>rem-if</code> except that it modifies <em>list</em>
rather than creating a new list.
</p></dd></dl>

<a name="del_002dif_002dnot_002dfun"></a><dl>
<dt><a name="index-del_002dif_002dnot"></a>Function: <strong>del-if-not</strong> <em>predicate list</em></dt>
<dd><p><code>del-if-not</code> is just like <code>rem-if-not</code> except that it modifies <em>list</em>
rather than creating a new list.
</p></dd></dl>

<a name="every_002dfun"></a><dl>
<dt><a name="index-every"></a>Function: <strong>every</strong> <em>list predicate &amp;optional step-function</em></dt>
<dd><p><code>every</code> returns <code>t</code> if <em>predicate</em> returns
non-<code>nil</code> when applied to every element of <em>list</em>,
or <code>nil</code> if <em>predicate</em> returns <code>nil</code> for some element.
If <em>step-function</em> is present, it replaces <code>cdr</code>
as the function used to get to the next element of the list;
<code>cddr</code> is a typical function to use here.
</p></dd></dl>

<a name="some_002dfun"></a><dl>
<dt><a name="index-some"></a>Function: <strong>some</strong> <em>list predicate &amp;optional step-function</em></dt>
<dd><p><code>some</code> returns a tail of <em>list</em> such that the car
of the tail is the first element that the <em>predicate</em> returns
non-<code>nil</code> when applied to,
or <code>nil</code> if <em>predicate</em> returns <code>nil</code> for every element.
If <em>step-function</em> is present, it replaces <code>cdr</code>
as the function used to get to the next element of the list;
<code>cddr</code> is a typical function to use here.
</p></dd></dl>

<a name="Association-Lists"></a>
<h3 class="section">5.7 Association Lists</h3>

<a name="assq_002dfun"></a><dl>
<dt><a name="index-assq"></a>Function: <strong>assq</strong> <em>item alist</em></dt>
<dd><a name="index-_0022association-list_0022-1"></a>
<a name="alist"></a><p><code>(assq <em>item alist</em>)</code> looks up <em>item</em> in the association list
(list of conses) <em>alist</em>.  The value is the first cons whose car
is <code>eq</code> to <em>x</em>, or <code>nil</code> if there is none such. 
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(assq 'r '((a . b) (c . d) (r . x) (s . y) (r . z)))
	=&gt;  (r . x)

(assq 'fooo '((foo . bar) (zoo . goo))) =&gt; nil

(assq 'b '((a b c) (b c d) (x y z))) =&gt; (b c d)
</pre></div>

<p>It is okay to <code>rplacd</code> the result of <code>assq</code> as long as it is not <code>nil</code>,
if your intention is to &quot;update&quot; the &quot;table&quot; that was <code>assq</code>&rsquo;s second argument.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq values '((x . 100) (y . 200) (z . 50)))
(assq 'y values) =&gt; (y . 200)
(rplacd (assq 'y values) 201)
(assq 'y values) =&gt; (y . 201) <span class="roman">now</span>
</pre></div>

<p>A typical trick is to say
<code>(cdr (assq x y))</code>.
Since the cdr of <code>nil</code> is guaranteed to be <code>nil</code>,
this yields <code>nil</code> if no pair is found (or if a pair is
found whose cdr is <code>nil</code>.)
</p>
<p><code>assq</code> could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun assq (item list)
    (cond ((null list) nil)
          ((eq item (caar list)) (car list))
          ((assq item (cdr list))) ))
</pre></div>
</dd></dl>

<a name="assoc_002dfun"></a><dl>
<dt><a name="index-assoc"></a>Function: <strong>assoc</strong> <em>item alist</em></dt>
<dd><p><code>assoc</code> is like <code>assq</code> except that the comparison uses <code>equal</code> instead of <code>eq</code>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(assoc '(a b) '((x . y) ((a b) . 7) ((c . d) .e)))
	=&gt; ((a b) . 7)
</pre></div>
<p><code>assoc</code> could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun assoc (item list)
    (cond ((null list) nil)
          ((equal item (caar list)) (car list))
          ((assoc item (cdr list))) ))
</pre></div>
</dd></dl>

<a name="ass_002dfun"></a><dl>
<dt><a name="index-ass"></a>Function: <strong>ass</strong> <em>predicate item alist</em></dt>
<dd><p><code>ass</code> is the same as <code>assq</code> except that it takes an extra argument
which should be a predicate of two arguments, which is used for the
comparison instead of <code>eq</code>.  <code>(ass 'eq a b)</code> is the same as
<code>(assq a b)</code>. (cf <code>mem</code>, <a href="#mem_002dfun">mem-fun</a>)  As with <code>mem</code>, you may
use non-commutative predicates; the first argument to the predicate
is <em>item</em> and the second is the key of the element of <em>alist</em>.
</p></dd></dl>

<a name="memass_002dfun"></a><dl>
<dt><a name="index-memass"></a>Function: <strong>memass</strong> <em>predicate item alist</em></dt>
<dd><p><code>memass</code> searches <em>alist</em> just like <code>ass</code>, but returns
the portion of the list beginning with the pair containing <em>item</em>,
rather than the pair itself.  <code>(car (memass <em>x y z</em>)) =
(ass <em>x y z</em>)</code>.  (cf <code>mem</code>, <a href="#mem_002dfun">mem-fun</a>)  As with <code>mem</code>, you may
use non-commutative predicates; the first argument to the predicate
is <em>item</em> and the second is the key of the element of <em>alist</em>.
</p></dd></dl>

<a name="rassq_002dfun"></a><dl>
<dt><a name="index-rassq"></a>Function: <strong>rassq</strong> <em>item alist</em></dt>
<dd><p><code>rassq</code> means &quot;reverse assq&quot;.  It is like <code>assq</code>, but
it tries to find an element of <em>alist</em> whose <em>cdr</em> (not car)
is <code>eq</code> to <em>item</em>.  <code>rassq</code> could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun rassq (item in-list) 
    (do l in-list (cdr l) (null l) 
      (and (eq item (cdar l)) 
	   (return (car l)))))
</pre></div>
</dd></dl>

<a name="rassoc_002dfun"></a><dl>
<dt><a name="index-rassoc"></a>Function: <strong>rassoc</strong> <em>item alist</em></dt>
<dd><p><code>rassoc</code> is to <code>rassq</code> as <code>assoc</code> is to <code>assq</code>.  That is, it
finds an element whose cdr is <code>equal</code> to <em>item</em>.
</p></dd></dl>

<a name="rass_002dfun"></a><dl>
<dt><a name="index-rass"></a>Function: <strong>rass</strong> <em>predicate item alist</em></dt>
<dd><p><code>rass</code> is to <code>rassq</code> as <code>ass</code> is to <code>assq</code>.  That is, it takes
a predicate to be used instead of <code>eq</code>
(cf <code>mem</code>, <a href="#mem_002dfun">mem-fun</a>).  As with <code>mem</code>, you may
use non-commutative predicates; the first argument to the predicate
is <em>item</em> and the second is the cdr of the element of <em>alist</em>.
</p></dd></dl>

<a name="sassq_002dfun"></a><dl>
<dt><a name="index-sassq"></a>Function: <strong>sassq</strong> <em>item alist fcn</em></dt>
<dd><p><code>(sassq <em>item alist fcn</em>)</code> is like <code>(assq <em>item alist</em>)</code> except
that if <em>item</em> is not found in <em>alist</em>, instead of returning <code>nil</code>,
<code>sassq</code> calls the function <em>fcn</em> with no arguments.  <code>sassq</code> could
have been defined by: 
</p><div class="lisp">
<pre class="lisp">(defun sassq (item alist fcn)
    (or (assq item alist)
        (apply fcn nil)))
</pre></div>

<p><code>sassq</code> and <code>sassoc</code> (see below) are of limited use.
These are primarily leftovers from Lisp 1.5.
</p></dd></dl>

<a name="sassoc_002dfun"></a><dl>
<dt><a name="index-sassoc"></a>Function: <strong>sassoc</strong> <em>item alist fcn</em></dt>
<dd><p><code>(sassoc <em>item alist fcn</em>)</code> is like <code>(assoc <em>item alist</em>)</code> except that if
<em>item</em> is not found in <em>alist</em>, instead of returning <code>nil</code>, <code>sassoc</code> calls
the function <em>fcn</em> with no arguments.  <code>sassoc</code> could have been
defined by: 
</p><div class="lisp">
<pre class="lisp">(defun sassoc (item alist fcn)
    (or (assoc item alist)
        (apply fcn nil)))
</pre></div>
</dd></dl>

<a name="pairlis_002dfun"></a><dl>
<dt><a name="index-pairlis"></a>Function: <strong>pairlis</strong> <em>cars cdrs</em></dt>
<dd><p><code>pairlis</code> takes two lists and makes an association list which associates
elements of the first list with corresponding elements of the second
list.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(pairlis '(beef clams kitty) '(roast fried yu-shiang))
   =&gt; ((beef . roast) (clams . fried) (kitty . yu-shiang))
</pre></div>
<a name="index-kitty_002c-yu_002dshiang"></a>
</dd></dl>

<a name="Stack-Lists"></a>
<h3 class="section">5.8 Stack Lists</h3>
<a name="index-stack-lists"></a>
<a name="stack_002dlist"></a>
<p>When you are creating a list that will not be needed any more once the function
that creates it is finished, it is possible to create the list on the
stack instead of by consing it.  This avoids any permanent storage
allocation, as the space is reclaimed as part of exiting the function.
By the same token, it is a little risky; if any pointers to the list
remain after the function exits, they will become meaningless.
</p>
<p>These lists are called <em>temporary lists</em> or <em>stack lists</em>.
You can create them explicitly using the special forms
<code>with-stack-list</code> and <code>with-stack-list*</code>.  <code>&amp;rest</code> arguments also
sometimes create stack lists.
</p>
<p>If a stack list, or a list which might be a stack list, is to be
returned or made part of permanent list-structure, it must first be
copied (see <code>copylist</code>, <a href="#copylist_002dfun">copylist-fun</a>).  The system will not
detect the error of omitting to copy a stack list; you will simply find
that you have a value that seems to change behind your back.
</p>
<a name="with_002dstack_002dlist_002dfun"></a><dl>
<dt><a name="index-with_002dstack_002dlist"></a>Special Form: <strong>with-stack-list</strong> <em>(variable element...) body...</em></dt>
<dd><a name="with_002dstack_002dlist_002a_002dfun"></a></dd><dt><a name="index-with_002dstack_002dlist_002a"></a>Special Form: <strong>with-stack-list*</strong> <em>(variable element... tail) body...</em></dt>
<dd><p>These special forms create stack lists that live
inside the stack frame of the function that they are used in.
You should assume that the stack lists are only valid until the special
form is exited.
</p>
<div class="lisp">
<pre class="lisp">(with-stack-list (foo x y)
  (mumblify foo))
</pre><pre class="lisp">is equivalent to
</pre><pre class="lisp">(let ((foo (list x y)))
  (mumblify foo))
</pre></div>
<p>except for the fact that <code>foo</code>&rsquo;s value in the first example is a stack
list.
</p>
<p>The list created by <code>with-stack-list*</code> looks like the one created by
<code>list*</code>.  <em>tail</em>&rsquo;s value becomes the ultimate cdr rather than an
element of the list.
</p></dd></dl>

<p>It is an error to do <code>rplacd</code> on a stack list (except for the
tail of one made using <code>with-stack-list*</code>).  <code>rplaca</code> works
normally.
</p>
<dl>
<dt><a name="index-_0028error_0029-on-sys_003arplacd_002dwrong_002drepresentation_002dtype"></a>Condition on sys:rplacd-wrong-representation-type: <strong>(<code>error</code>)</strong></dt>
<dd><p>This is signaled if you <code>rplacd</code> a stack list (or a list overlayed
with an array, or any other sort of structure).
</p></dd></dl>

<a name="Property-Lists"></a>
<h3 class="section">5.9 Property Lists</h3>
<a name="plist"></a><a name="index-_0022property-list_0022-1"></a>
<a name="index-_0022plist_0022"></a>
<a name="index-_0022indicator_0022"></a>
<a name="index-_0022attribute_0022"></a>

<p>From time immemorial, Lisp has had a kind of tabular data structure
called a <em>property list</em> (plist for short).  A property list contains
zero or more entries; each entry associates from a keyword symbol
(called the <em>property name</em>, or sometimes the <em>indicator</em>) to a Lisp
object (called the <em>value</em> or, sometimes, the <em>property</em>).  There
are no duplications among the property names; a property-list can have only
one property at a time with a given name.
</p>
<p>This is very similar to an association list.  The important difference is that a
property list is an object with a unique identity; the operations for
adding and removing property-list entries are side-effecting operations
which alter the property-list rather than making a new one.  An
association list with no entries would be the empty list <code>()</code>, i.e
the symbol <code>nil</code>.  There is only one empty list, so all empty
association lists are the same object.  Each empty property-list is a
separate and distinct object.
</p>
<p>The implementation of a property list is a memory cell containing a list
with an even number (possibly zero) of elements.  Each pair of elements
constitutes a <em>property</em>; the first of the pair is the name and the
second is the value.  (It would have been possible to use an alist to
hold the pairs; this format was chosen when Lisp was young.)  The memory cell
is there to give the property list a unique identity and to provide for
side-effecting operations.
</p>
<p>The term &quot;property list&quot; is sometimes incorrectly used to refer to the
list of entries inside the property list, rather than the property list
itself.  This is regrettable and confusing.
</p>
<p>How do we deal with &quot;memory cells&quot; in Lisp?  That is, what kind of Lisp object
is a property list?  Rather than being a distinct primitive data type,
a property list can exist in one of three forms:
</p>
<p>1. Any cons can be used as a property list.  The cdr of the cons holds
the list of entries (property names and values).  Using the cons as a
property list does not use the car of the cons; you can use that for
anything else.
</p>
<p>2. The system associates a property list with every symbol (see <a href="#symbol_002dplist_002dsection">symbol-plist-section</a>).
A symbol can be used where a property list is expected; the property-list
primitives will automatically find the symbol&rsquo;s property list and use it.
</p>
<p>3. A flavor instance may have a property list.  The property list
functions operate on instances by sending messages to them, so the
flavor can store the property list any way it likes.
See <a href="#si_003aproperty_002dlist_002dmixin_002dflavor">si:property-list-mixin-flavor</a>).
</p>
<p>4. A property list can be a memory cell in the middle of some data structure,
such as a list, an array, an instance, or a defstruct.  An arbitrary memory
cell of this kind is named by a locative (see <a href="#locative">locative</a>).  Such locatives
are typically created with the <code>locf</code> special form (see <a href="#locf_002dfun">locf-fun</a>).
</p>
<a name="index-_0022disembodied-property-list_0022"></a>
<a name="disembodied_002dproperty_002dlist"></a><p>Property lists of the first kind
are called &quot;disembodied&quot; property lists because they are not associated with
a symbol or other data structure.
The way to create a disembodied property list is <code>(ncons nil)</code>,
or <code>(ncons <em>data</em>)</code> to store <em>data</em> in the car of the property list.
</p>
<p>Here is an example of the list of entries inside the property list of a
symbol named <code>b1</code> which is being used by a program which deals with
blocks:
<a name="index-_0022blocks_0022"></a>
</p><div class="lisp">
<pre class="lisp">	(color blue on b6 associated-with (b2 b3 b4))
</pre></div>
<p>There are three properties, and so the list has six elements.
The first property&rsquo;s name is the symbol <code>color</code>, and its value
is the symbol <code>blue</code>.  One says that &quot;the value of <code>b1</code>&rsquo;s <code>color</code>
property is <code>blue</code>&quot;, or, informally, that &quot;<code>b1</code>&rsquo;s <code>color</code> property
is <code>blue</code>.&quot;  The program is probably representing the information that
the block represented by <code>b1</code> is painted blue.  Similarly, it is probably
representing in the rest of the property list that block <code>b1</code> is on
top of block <code>b6</code>, and that <code>b1</code> is associated with blocks
<code>b2</code>, <code>b3</code>, and <code>b4</code>.
</p>
<a name="get_002dfun"></a><dl>
<dt><a name="index-get"></a>Function: <strong>get</strong> <em>plist property-name</em></dt>
<dd><p><code>get</code> looks up <em>plist</em>&rsquo;s <em>property-name</em> property.  If it finds such a property,
it returns the value; otherwise, it returns <code>nil</code>.  If <em>plist</em> is a symbol,
the symbol&rsquo;s associated property list is used.  For example, if the property
list of <code>foo</code> is <code>(baz 3)</code>, then
</p><div class="lisp">
<pre class="lisp">(get 'foo 'baz) =&gt; 3
(get 'foo 'zoo) =&gt; nil
</pre></div>
</dd></dl>

<a name="getl_002dfun"></a><dl>
<dt><a name="index-getl"></a>Function: <strong>getl</strong> <em>plist property-name-list</em></dt>
<dd><p><code>getl</code> is like <code>get</code>, except that the second argument is a list
of property names.  <code>getl</code> searches down <em>plist</em> for any
of the names in <em>property-name-list</em>, until it finds a property whose
name is one of them.
If <em>plist</em> is a symbol, the symbol&rsquo;s associated property list is used.
	<code>getl</code> returns the portion of the list inside <em>plist</em> beginning
with the first such property that it found.  So the car of the returned
list is a property name, and the <code>cadr</code> is the property value.  If none
of the property names on <em>property-name-list</em> are on the property list, <code>getl</code>
returns <code>nil</code>.  For example, if the property list of <code>foo</code> were
</p><div class="lisp">
<pre class="lisp">(bar (1 2 3) baz (3 2 1) color blue height six-two)
</pre></div>
<p>then
</p><div class="lisp">
<pre class="lisp">(getl 'foo '(baz height))
  =&gt; (baz (3 2 1) color blue height six-two)
</pre></div>

<p>When more than one of the names in <em>property-name-list</em> is present in
<em>plist</em>, which one <code>getl</code> returns depends on the order of the properties.
This is the only thing that depends on that order.  The order maintained
by <code>putprop</code> and <code>defprop</code> is not defined (their behavior with respect
to order is not guaranteed and may be changed without notice).
</p></dd></dl>

<a name="putprop_002dfun"></a><dl>
<dt><a name="index-putprop"></a>Function: <strong>putprop</strong> <em>plist x property-name</em></dt>
<dd><p>This gives <em>plist</em> an <em>property-name</em>-property of <em>x</em>.
After this is done, <code>(get <em>plist property-name</em>)</code> will return <em>x</em>.
If <em>plist</em> is a symbol, the symbol&rsquo;s associated property list is used.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(putprop 'Nixon t 'crook)
</pre></div>
</dd></dl>

<a name="defprop_002dfun"></a><dl>
<dt><a name="index-defprop"></a>Special Form: <strong>defprop</strong> <em>symbol x property-name</em></dt>
<dd><p><code>defprop</code> is a form of <code>putprop</code> with &quot;unevaluated arguments&quot;,
which is sometimes more convenient for typing.  Normally it doesn&rsquo;t
make sense to use a property list rather than a symbol as the first (or <em>plist</em>) argument.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(defprop foo bar next-to)
</pre></div>
<p>is the same as
</p><div class="lisp">
<pre class="lisp">(putprop 'foo 'bar 'next-to)
</pre></div>
</dd></dl>

<a name="remprop_002dfun"></a><dl>
<dt><a name="index-remprop"></a>Function: <strong>remprop</strong> <em>plist property-name</em></dt>
<dd><p>This removes <em>plist</em>&rsquo;s <em>property-name</em> property, by splicing it out of the property
list.  It returns that portion of the list inside <em>plist</em> of which the
former <em>property-name</em>-property was the car.  <code>car</code> of what <code>remprop</code>
returns is what <code>get</code> would have returned with the same arguments.
If <em>plist</em> is a symbol, the symbol&rsquo;s associated property list is used.
For example, if the property list of <code>foo</code> was
</p><div class="lisp">
<pre class="lisp">(color blue height six-three near-to bar)
</pre></div>
<p>then
</p><div class="lisp">
<pre class="lisp">(remprop 'foo 'height) =&gt; (six-three near-to bar)
</pre></div>
<p>and <code>foo</code>&rsquo;s property list would be
</p><div class="lisp">
<pre class="lisp">(color blue near-to bar)
</pre></div>
<p>If <em>plist</em> has no <em>property-name</em>-property, then <code>remprop</code> has no side-effect
and returns <code>nil</code>.
</p></dd></dl>

<a name="Hash-Tables"></a>
<h3 class="section">5.10 Hash Tables</h3>
<a name="index-hash-table"></a>
<a name="hash_002dtable"></a>
<p>A hash table is a Lisp object that works something like a property
list.  Each hash table has a set of <em>entries</em>, each of which
associates a particular <em>key</em> with a particular <em>value</em> (or
sequence of values).  The basic functions that deal with hash tables
can create entries, delete entries, and find the value that is
associated with a given key.  Finding the value is very fast even if
there are many entries, because hashing is used; this is an important
advantage of hash tables over property lists.  Hashing is explained in
<a href="#hash_002dsection">hash-section</a>.
</p>
<p>A given hash table stores a fixed number of values for each key;
by default, there is only one value.  Each time you specify a new
value or sequence of values, the old one(s) are lost.
</p>
<p>Hash tables come in two kinds, the difference being whether the keys
are compared using <code>eq</code> or using <code>equal</code>.  In other words, there
are hash tables which hash on Lisp <em>objects</em> (using <code>eq</code>) and there 
are hash tables which hash on trees (using <code>equal</code>).  The following
discussion refers to the <code>eq</code> kind of hash table; the other kind
is described later, and works analogously.
</p>
<p><code>eq</code> hash tables are created with the function <code>make-hash-table</code>, which
takes various options.  New entries are added to hash tables with the
<code>puthash</code> function.  To look up a key and find the associated value(s),
the <code>gethash</code> function is used.  To remove an entry, use <code>remhash</code>.
Here is a simple example.
</p>
<div class="lisp">
<pre class="lisp">(setq a (make-hash-table))

(puthash 'color 'brown a)

(puthash 'name 'fred a)

(gethash 'color a) =&gt; brown

(gethash 'name a) =&gt; fred
</pre></div>

<p>In this example, the symbols <code>color</code> and <code>name</code> are being used as
keys, and the symbols <code>brown</code> and <code>fred</code> are being used as the
associated values.  The hash table remembers one value for each key,
since we did not specify otherwise, and has two items in it, one of
which associates from <code>color</code> to <code>brown</code>, and the other of which
associates from <code>name</code> to <code>fred</code>.
</p>
<p>Keys do not have to be symbols; they can be any Lisp object.  Likewise
values can be any Lisp object.  Since <code>eq</code> does not work reliably on
numbers (except for fixnums), they should not be used as keys in an
<code>eq</code> hash table.
</p>
<p>When a hash table is first created, it has a <em>size</em>, which how many
entries it contains.  But hash tables which are nearly full become
slow to search, so if more than a certain fraction of the entries
become in use, the hash table will grow automatically, and the entries
will be <em>rehashed</em> (new hash values will be recomputed, and
everything will be rearranged so that the fast hash lookup still
works).  This is transparent to the caller; it all happens
automatically.
</p>
<p>The <code>describe</code> function (see <a href="#describe_002dfun">describe-fun</a>) prints a variety of
useful information when applied to a hash table.
</p>
<p>This hash table facility is similar to the hasharray facility of Interlisp,
and some of the function names are the same.  However, it is <em>not</em> compatible.
The exact details and the order of arguments are designed to be consistent
with the rest of Zetalisp rather than with Interlisp.  For instance,
the order of arguments to <code>maphash</code> is different, we do not have the Interlisp
&quot;system hash table&quot;, and we do not have the
Interlisp restriction that keys and values may not be <code>nil</code>.  
Note, however, that the order of arguments to <code>gethash</code>, <code>puthash</code>, and <code>remhash</code>
is not consistent with the Zetalisp&rsquo;s <code>get</code>, <code>putprop</code>, and <code>remprop</code>,
either.  This is an unfortunate result of the haphazard historical development of Lisp.
</p>
<p>Hash tables are implemented with a special kind of array.  <code>arrayp</code>
of a hash table will return <code>t</code>.  However, it is not recommended to
use ordinary array operations on a hash table, because the way the
array elements are used to represent the entries is internal and
subject to change.
Hash tables should be manipulated only with the functions described below.
</p>
<a name="Hash-Table-Functions"></a>
<h4 class="subsection">5.10.1 Hash Table Functions</h4>


<a name="make_002dhash_002dtable_002dfun"></a><dl>
<dt><a name="index-make_002dhash_002dtable"></a>Function: <strong>make-hash-table</strong> <em>&amp;rest options</em></dt>
<dd><a name="make_002dequal_002dhash_002dtable_002dfun"></a></dd><dt><a name="index-make_002dequal_002dhash_002dtable"></a>Function: <strong>make-equal-hash-table</strong> <em>&amp;rest options</em></dt>
<dd><p>These functions create new hash tables.  <code>make-equal-hash-table</code>
creates an <code>equal</code> hash table.  <code>make-hash-table</code> normally creates
an <code>eq</code> hash table, but this can be overridden by keywords as
described below.  Valid option keywords are:
</p><dl compact="compact">
<dt><code>:size</code></dt>
<dd><p>Sets the initial size of the hash table, in entries, as a fixnum.  The
default is 100 (octal).  The actual size is rounded up from the size you
specify to the next size that is &quot;good&quot; for the hashing algorithm.  The
number of entries you can actually store in the hash table before it is
rehashed is at least the actual size times the rehash threshold (see below).
</p>
</dd>
<dt><code>:number-of-values</code></dt>
<dd><p>Specifies how many values to associate with each key.
The default is one.
</p>
</dd>
<dt><code>:area</code></dt>
<dd><p>Specifies the area in which the hash table should be created.  This is
just like the <code>:area</code> option to <code>make-array</code> (see <a href="#make_002darray_002dfun">make-array-fun</a>).
Defaults to <code>nil</code> (i.e <code>default-cons-area</code>).
</p>
</dd>
<dt><code>:rehash-function</code></dt>
<dd><p>Specifies the function to be used for rehashing when the table becomes
full.  Defaults to the internal rehashing function that does the usual
thing.  If you want to write your own rehashing function, you will
have to understand all the internals of how hash tables work.  These
internals are not documented here, as the best way to learn them is
to read the source code.
</p>
</dd>
<dt><code>:rehash-size</code></dt>
<dd><p>Specifies how much to increase the size of the hash table when it becomes
full.  This can be a fixnum which is the number of entries to add, or
it can be a flonum which is the ratio of the new size to the old size.
The default is <code>1.3</code>, which causes the table to be made 30% bigger
each time it has to grow.
</p>
</dd>
<dt><code>:rehash-threshold</code></dt>
<dd><p>Sets a maximum fraction of the entries which can be in use before the
hash table is made larger and rehashed.  The default is <code>0.7s0</code>.
</p>
</dd>
<dt><code>:actual-size</code></dt>
<dd><p>Specifies exactly the size for the hash table.  Hash tables used by
the microcode for flavor method lookup must be a power of two in size.
This differs from <code>:size</code> in that <code>:size</code> is rounded up to a
nearly prime number, but <code>:actual-size</code> is used exactly as
specified.  <code>:actual-size</code> overrides <code>:size.</code>
</p>
</dd>
<dt><code>:hash-function</code></dt>
<dd><p>Specifies a function which, given a key, computes its hash code.
For an <code>eq</code> hash table, the key is the code, and this option&rsquo;s
value should be <code>nil</code> (which is the default for
<code>make-hash-table</code>).  <code>make-equal-hash-table</code> specifies an
appropriate function which uses <code>sxhash</code>.
</p>
</dd>
<dt><code>:compare-function</code></dt>
<dd><p>Specifies a function which compares two keys to see if they count as
the same for retrieval from this table.  The default is <code>eq</code>, or
<code>equal</code> for <code>make-equal-hash-table</code>.
</p>
</dd>
<dt><code>:funcallable-p</code></dt>
<dd><p>Specifies whether the hash table should attempt to handle messages if
applied as a function.  If this option is non-<code>nil</code>, when the hash
table is called as a function it uses the first argument as a hash key
to find a function to call.  The function is given the same arguments
that the hash table received.  Funcallable hash tables are somewhat
analogous to select-method objects (see <a href="#select_002dmethod">select-method</a>).
</p>
<p>Specifying a funcallable hash table automatically forces certain
other options to have values that the microcode expects to deal with.
</p></dd>
</dl>
</dd></dl>

<p><code>eq</code> and <code>equal</code> hash tables are not the only possible kinds.
You can create a hash table with any comparison function you like,
as long as you also provide a suitable hash function.  Any two objects
which would be regarded as the same by the comparison function should
produce the same hash code under the hash function.
</p>
<a name="gethash_002dfun"></a><dl>
<dt><a name="index-gethash"></a>Function: <strong>gethash</strong> <em>key hash-table</em></dt>
<dd><p>Finds the entry in <em>hash-table</em> whose key is <em>key</em>, and return the
associated value.  If there is no such entry, return <code>nil</code>.
Returns a second value, which is <code>t</code> if an entry was found or <code>nil</code> if there
is no entry for <em>key</em> in this table.
</p>
<p>Returns also a third value, a list which overlays the hash table
entry.  Its car is the key; the remaining elements are the values in
the entry.  This is how you can access values other than the first, if
the hash table contains more than one value per entry.
</p></dd></dl>

<a name="puthash_002dfun"></a><dl>
<dt><a name="index-puthash"></a>Function: <strong>puthash</strong> <em>key value hash-table &amp;rest extra-values</em></dt>
<dd><p>Creates an entry associating <em>key</em> to <em>value</em>; if there is already an
entry for <em>key</em>, then replace the value of that entry with <em>value</em>.
Returns <em>value</em>.  The hash table automatically grows if necessary.
</p>
<p>If the hash table associates more than one value with each key, the
remaining values in the entry are taken from <em>extra-values</em>.
</p></dd></dl>

<a name="remhash_002dfun"></a><dl>
<dt><a name="index-remhash"></a>Function: <strong>remhash</strong> <em>key hash-table</em></dt>
<dd><p>Removes any entry for <em>key</em> in <em>hash-table</em>.  Returns <code>t</code> if there was an
entry or <code>nil</code> if there was not.
</p></dd></dl>

<a name="swaphash_002dfun"></a><dl>
<dt><a name="index-swaphash"></a>Function: <strong>swaphash</strong> <em>key value hash-table &amp;rest extra-values</em></dt>
<dd><p>This specifies new value(s) for <em>key</em> like <code>puthash</code>, but returns
values describing the previous state of the entry, just like
<code>gethash</code>.  In particular, it returns the previous (replaced)
associated value as the first value, and returns <code>t</code> as the second value
if the entry existed previously.
</p></dd></dl>

<a name="maphash_002dfun"></a><dl>
<dt><a name="index-maphash"></a>Function: <strong>maphash</strong> <em>function hash-table</em></dt>
<dd><p>For each entry in <em>hash-table</em>, call <em>function</em> on two arguments:
the key of the entry and the value of the entry.
</p>
<p>If the hash table has more than one value per key, all the values, in
order, are supplied as arguments, with the corresponding key.
</p></dd></dl>

<a name="maphash_002dreturn_002dfun"></a><dl>
<dt><a name="index-maphash_002dreturn"></a>Function: <strong>maphash-return</strong> <em>function hash-table</em></dt>
<dd><p>Like <code>maphash</code>, but accumulates and returns a list of all the
values returned by <em>function</em> when it is applied to the items in
the hash table.
</p></dd></dl>

<a name="clrhash_002dfun"></a><dl>
<dt><a name="index-clrhash"></a>Function: <strong>clrhash</strong> <em>hash-table</em></dt>
<dd><p>Removes all the entries from <em>hash-table</em>.  Returns the hash table itself.
</p></dd></dl>

<a name="Hash-Tables-and-the-Garbage-Collector"></a>
<h4 class="subsection">5.10.2 Hash Tables and the Garbage Collector</h4>

<p>The <code>eq</code> type hash tables actually hash on the address of the representation
of the object.  When the copying garbage collector changes the addresses of
objects, it lets the hash facility know so that <code>gethash</code> will rehash
the table based on the new object addresses.
</p>
<p>There will eventually be an option to <code>make-hash-table</code> which tells it
to make a &quot;non-GC-protecting&quot; hash table.  This is a special kind of hash table
with the property that if one of its keys becomes &quot;garbage&quot;, i.e is an object
not known about by anything other than the hash table, then the entry for that
key will be silently removed from the table.  When this option exists it will be
documented in this section.
</p>
<a name="Hash-Primitive"></a>
<h4 class="subsection">5.10.3 Hash Primitive</h4>
<a name="hash_002dsection"></a>
<p><em>Hashing</em> is a technique used in algorithms to provide fast retrieval
of data in large tables.  A function, known as the &quot;hash function&quot;,
takes an object that might be used as a key, and produces
a number associated with that key.  This number, or some function of it,
can be used to specify where in a table to look for the datum associated
with the key.  It is always possible for two different objects to &quot;hash
to the same value&quot;; that is, for the hash function to return the same
number for two distinct objects.  Good hash functions are designed to minimize
this by evenly distributing their results over the range of possible numbers.
However, hash table algorithms must still deal with
this problem by providing a secondary search, sometimes known as a
<em>rehash</em>.  For more information, consult a
textbook on computer algorithms.
</p>
<a name="sxhash_002dfun"></a><dl>
<dt><a name="index-sxhash"></a>Function: <strong>sxhash</strong> <em>tree &amp;optional ok-to-use-address</em></dt>
<dd><a name="index-_0022hash-table_0022"></a>
<p><code>sxhash</code> computes a hash code of a tree, and returns it as a fixnum.
A property of <code>sxhash</code> is that <code>(equal <em>x y</em>)</code> always implies
<code>(= (sxhash <em>x</em>) (sxhash <em>y</em>))</code>.  The number returned by <code>sxhash</code> is
always a non-negative fixnum, possibly a large one.  <code>sxhash</code> tries to
compute its hash code in such a way that common permutations of an object,
such as interchanging two elements of a list or changing one character in
a string, will always change the hash code.
</p>
<p>Here is an example of how to use <code>sxhash</code> in maintaining
hash tables of trees:
</p><div class="lisp">
<pre class="lisp">(defun knownp (x &amp;aux i bkt)    ;<span class="roman">look up <code>x</code> in the table</span>
    (setq i (abs (remainder (sxhash x) 176)))
      ;The remainder should be reasonably randomized.
    (setq bkt (aref table i))
      ;bkt is thus a list of all those expressions that
      ;hash into the same number as does x.
    (memq x bkt))
</pre></div>

<p>To write an &quot;intern&quot; for trees, one could
</p><div class="lisp">
<pre class="lisp">(defun sintern (x &amp;aux bkt i tem)
    (setq i (abs (remainder (sxhash x) 2n-1)))
	;2n-1 stands for a power of 2 minus one.
	;This is a good choice to randomize the
	;result of the remainder operation.
    (setq bkt (aref table i))
    (cond ((setq tem (memq x bkt))
	   (car tem))
	  (t (aset (cons x bkt) table i)
	     x)))
</pre></div>
</dd></dl>

<p>If <code>sxhash</code> is given a named structure or a flavor instance, or if one
is part of a tree that is <code>sxhash</code>ed, it will ask the object to supply
its own hash code by performing the <code>:sxhash</code> operation if the object
supports it.  This should return a suitable nonnegative hash code.  The
easiest way to compute one is usually by applying <code>sxhash</code> to one or
more of the components of the structure or the instance variables of the
instance.
</p>
<p>For named structures and flavor instances that do not handle the
<code>:sxhash</code> operation, and other unusual kinds of objects,
<code>sxhash</code> can optionally use the object&rsquo;s address as its hash code,
if you specify a non-<code>nil</code> second argument.  If you use this
option, you must be prepared to deal with hash codes changing due to
garbage collection.
</p>
<p><code>sxhash</code> provides what is called &quot;hashing on <code>equal</code>&quot;; that is, two
objects that are <code>equal</code> are considered to be &quot;the same&quot; by
<code>sxhash</code>.  In particular, if two strings differ only in alphabetic case,
<code>sxhash</code> will return the same thing for both of them because
they are <code>equal</code>.  The value returned by <code>sxhash</code> does not depend
on the value of <code>alphabetic-case-affects-string-comparison</code>
(see <a href="#alphabetic_002dcase_002daffects_002dstring_002dcomparison_002dvar">alphabetic-case-affects-string-comparison-var</a>).
</p>
<p>Therefore, <code>sxhash</code> is useful for retrieving data when
two keys that are not the same object but are <code>equal</code> are considered
the same.  If you consider two such keys to be different, then you need
&quot;hashing on <code>eq</code>&quot;, where two different objects are always considered
different.  In some Lisp implementations, there is an easy way to create
a hash function that hashes on <code>eq</code>, namely, by returning the virtual
address of the storage associated with the object.  But in other
implementations, of which Zetalisp is one, this doesn&rsquo;t work,
because the address associated with an object can be changed by the
relocating garbage collector.  The hash tables created by <code>make-hash-table</code>
deal with this problem by using the appropriate subprimitives so that they
interface correctly with the garbage collector.  If you need a hash table
that hashes on <code>eq</code>, it is already provided; if you need an
<code>eq</code> hash function for some other reason, you must build it yourself,
either using the provided <code>eq</code> hash table facility or carefully using
subprimitives.
</p>
<a name="g_t_0022Sorting_0022"></a>
<h3 class="section">5.11 &quot;Sorting&quot;</h3>
<a name="index-_0022sorting_0022"></a>

<p>Several functions are provided for sorting arrays and lists.  These
functions use algorithms which always terminate no matter what sorting
predicate is used, provided only that the predicate always terminates. 
The main sorting functions are not <em>stable</em>; that is, equal items may
not stay in their original order.  If you want a stable sort, use the
stable versions.  But if you don&rsquo;t care about stability, don&rsquo;t use them
since stable algorithms are significantly slower.
</p>
<p>After sorting, the argument (be it list or array) has been rearranged
internally so as to be completely ordered.  In the case of an array
argument, this is accomplished by permuting the elements of the array,
while in the list case, the list is reordered by <code>rplacd</code>&rsquo;s in the
same manner as <code>nreverse</code>.  Thus if the argument should not be
clobbered, the user must sort a copy of the argument, obtainable by
<code>fillarray</code> or <code>copylist</code>, as appropriate.  Furthermore, <code>sort</code>
of a list is like <code>delq</code> in that it should not be used for effect;
the result is conceptually the same as the argument but in fact is a
different Lisp object.
</p>
<p>Should the comparison predicate cause an error, such as a wrong type
argument error, the state of the list or array being sorted is
undefined.  However, if the error is corrected the sort will, of
course, proceed correctly. 
</p>
<p>The sorting package is smart about compact lists; it sorts compact
sublists as if they were arrays.  See <a href="#cdr_002dcode">cdr-code</a> for an explanation of
compact lists, and A. I. Memo 587 by Guy L. Steele Jr. for an
explanation of the sorting algorithm.
</p>
<a name="sort_002dfun"></a><dl>
<dt><a name="index-sort"></a>Function: <strong>sort</strong> <em>table predicate</em></dt>
<dd><p>The first argument to <code>sort</code> is an array or a list.  The second
is a predicate, which must be applicable to
all the objects in the array or list.  The predicate should take two
arguments, and return non-<code>nil</code> if and only if the first argument is
strictly less than the second (in some appropriate sense). 
</p>
<p>The <code>sort</code> function proceeds to sort the contents of the array or list
under the ordering imposed by the predicate, and returns the array or
list modified into sorted order.  Note that since sorting requires many
comparisons, and thus many calls to the predicate, sorting will be much
faster if the predicate is a compiled function rather than interpreted. 
Example: Sort a list alphabetically by the first atom found at any level
in each element.
</p><div class="lisp">
<pre class="lisp">(defun mostcar (x)
    (cond ((symbolp x) x)
          ((mostcar (car x)))))

(sort 'fooarray
      (function (lambda (x y)
	  (alphalessp (mostcar x) (mostcar y)))))
</pre></div>
<p>If <code>fooarray</code> contained these items before the sort:
</p><div class="lisp">
<pre class="lisp">(Tokens (The lion sleeps tonight))
(Carpenters (Close to you))
((Rolling Stones) (Brown sugar))
((Beach Boys) (I get around))
(Beatles (I want to hold your hand))
</pre></div>
<p>then after the sort <code>fooarray</code> would contain:
</p><div class="lisp">
<pre class="lisp">((Beach Boys) (I get around))
(Beatles (I want to hold your hand))
(Carpenters (Close to you))
((Rolling Stones) (Brown sugar))
(Tokens (The lion sleeps tonight))
</pre></div>

<p>When <code>sort</code> is given a list, it may change the order of the
conses of the list (using <code>rplacd</code>), and so it cannot be used merely
for side-effect; only the <em>returned value</em> of <code>sort</code> will be the
sorted list.  This will mess up the original list; if you need both
the original list and the sorted list, you must copy the original
and sort the copy (see <code>copylist</code>, <a href="#copylist_002dfun">copylist-fun</a>).
</p>
<p>Sorting an array just moves the elements of the array into different
places, and so sorting an array for side-effect only is all right.
</p>
<p>If the argument to <code>sort</code> is an array with a fill pointer, note that,
like most functions, <code>sort</code> considers the active length of the array
to be the length, and so only the active part of the array will be
sorted (see <code>array-active-length</code>, <a href="#array_002dactive_002dlength_002dfun">array-active-length-fun</a>).
</p></dd></dl>

<a name="sortcar_002dfun"></a><dl>
<dt><a name="index-sortcar"></a>Function: <strong>sortcar</strong> <em>x predicate</em></dt>
<dd><p><code>sortcar</code> is the same as <code>sort</code> except that the predicate is applied
to the cars of the elements of <em>x</em>, instead of directly to the
elements of <em>x</em>.  Example:
</p><div class="lisp">
<pre class="lisp">(sortcar '((3 . dog) (1 . cat) (2 . bird)) #'&lt;)
                   =&gt;   ((1 . cat) (2 . bird) (3 . dog))
</pre></div>

<p>Remember that <code>sortcar</code>, when given a list, may change the order of the
conses of the list (using <code>rplacd</code>), and so it cannot be used merely
for side-effect; only the <em>returned value</em> of <code>sortcar</code> will be the
sorted list.
</p></dd></dl>

<a name="stable_002dsort_002dfun"></a><dl>
<dt><a name="index-stable_002dsort"></a>Function: <strong>stable-sort</strong> <em>x predicate</em></dt>
<dd><p><code>stable-sort</code> is like <code>sort</code>, but if two elements of <em>x</em> are equal,
i.e <em>predicate</em> returns <code>nil</code> when applied to them in either order,
then those two elements will remain in their original order.
</p></dd></dl>

<a name="stable_002dsortcar_002dfun"></a><dl>
<dt><a name="index-stable_002dsortcar"></a>Function: <strong>stable-sortcar</strong> <em>x predicate</em></dt>
<dd><p><code>stable-sortcar</code> is like <code>sortcar</code>, but if two elements of <em>x</em> are equal,
i.e <em>predicate</em> returns <code>nil</code> when applied to their cars in either order,
then those two elements will remain in their original order.
</p></dd></dl>

<a name="sort_002dgrouped_002darray_002dfun"></a><dl>
<dt><a name="index-sort_002dgrouped_002darray"></a>Function: <strong>sort-grouped-array</strong> <em>array group-size predicate</em></dt>
<dd><p><code>sort-grouped-array</code> considers its array argument to
be composed of records of <em>group-size</em> elements each.
These records are considered as units, and are sorted with respect
to one another.  The <em>predicate</em> is applied to the first element
of each record; so the first elements act as the keys on which
the records are sorted.
</p></dd></dl>

<a name="sort_002dgrouped_002darray_002dgroup_002dkey_002dfun"></a><dl>
<dt><a name="index-sort_002dgrouped_002darray_002dgroup_002dkey"></a>Function: <strong>sort-grouped-array-group-key</strong> <em>array group-size predicate</em></dt>
<dd><p>This is like <code>sort-grouped-array</code> except that the
<em>predicate</em> is applied to four arguments:  an array,
an index into that array, a second array, and an index into
the second array.  <em>predicate</em> should consider each index
as the subscript of the first element of a record in the corresponding
array, and compare the two records.  This is more general
than <code>sort-grouped-array</code> since the function can get at
all of the elements of the relevant records, instead of only the first element.
</p></dd></dl>

<a name="Resources"></a>
<h3 class="section">5.12 Resources</h3>
<a name="index-resource"></a>
<a name="index-allocation-of-storage"></a>
<a name="index-storage-allocation"></a>

<p>Storage allocation is handled differently by different computer systems.
In many languages, the programmer must spend a lot of time thinking
about when variables and storage units are allocated and deallocated.
In Lisp, freeing of allocated storage is normally done automatically by
the Lisp system; when an object is no longer accessible to the Lisp
environment, it is garbage collected.  This relieves the programmer of a
great burden, and makes writing programs much easier.
</p>
<p>However, automatic freeing of storage incurs an expense: more computer
resources must be devoted to the garbage collector.  If a program is
designed to allocate temporary storage, which is then left as garbage,
more of the computer must be devoted to the collection of garbage; this
expense can be high.  In some cases, the programmer may decide that it
is worth putting up with the inconvenience of having to free storage
under program control, rather than letting the system do it
automatically, in order to prevent a great deal of overhead from the
garbage collector.
</p>
<p>It usually is not worth worrying about freeing of storage when the units
of storage are very small things such as conses or small arrays.
Numbers are not a problem, either; fixnums and small flonums do not occupy
storage, and the system has a special way of garbage-collecting the
other kinds of numbers with low overhead.  But when a program allocates and
then gives up very large objects at a high rate (or large objects at a
very high rate), it can be very worthwhile to keep track of that one
kind of object manually.  Within the Lisp Machine system, there
are several programs that are in this position.  The Chaosnet software
allocates and frees &quot;packets&quot;, which are moderately large, at a very
high rate.  The window system allocates and frees certain kinds of
windows, which are very large, moderately often.  Both of these programs
manage their objects manually, keeping track of when they are no longer
used.
</p>
<p>When we say that a program &quot;manually frees&quot; storage, it does not really
mean that the storage is freed in the same sense that the garbage
collector frees storage.  Instead, a list of unused objects is kept.
When a new object is desired, the program first looks on the list to see
if there is one around already, and if there is it uses it.  Only if the
list is empty does it actually allocate a new one.  When the program is
finished with the object, it returns it to this list.
</p>
<p>The functions and special forms in this section perform the above
function.  The set of objects forming each such list is called a
&quot;resource&quot;; for example, there might be a Chaosnet packet resource.
<code>defresource</code> defines a new resource; <code>allocate-resource</code> allocates
one of the objects; <code>deallocate-resource</code> frees one of the objects
(putting it back on the list); and <code>using-resource</code> temporarily
allocates an object and then frees it.
</p>
<a name="g_t_0022Defining-Resources_0022"></a>
<h4 class="subsection">5.12.1 &quot;Defining Resources&quot;</h4>

<a name="defresource_002dfun"></a><dl>
<dt><a name="index-defresource"></a>Special Form: <strong>defresource</strong></dt>
<dd><p>The <code>defresource</code> special form is used to define a new resource.  The
form looks like this:
</p><div class="lisp">
<pre class="lisp">(defresource <em>name</em> <em>parameters</em>
   <em>keyword</em> <em>value</em>
   <em>keyword</em> <em>value</em>
   ...)
</pre></div>

<p><em>name</em> should be a symbol; it is the name of the resource and gets a
<code>defresource</code> property of the internal data structure representing the resource.
</p>
<p><em>parameters</em> is a lambda-list giving names and default values (if <code>&amp;optional</code>
is used) of parameters to an object of this type.  For example, if one had a resource
of two-dimensional arrays to be used as temporary storage in a calculation, the
resource would typically have two parameters, the number of rows and the number of
columns.  In the simplest case <em>parameters</em> is <code>()</code>.
</p>
<p>The keyword options control how the objects of the resource are made and kept
track of.  The following keywords are allowed:
</p><dl compact="compact">
<dt><code>:constructor</code></dt>
<dd><p>The <em>value</em> is either a form or the name of a function.  It is
responsible for making an object, and will be used when someone tries to
allocate an object from the resource and no suitable free objects exist.
If the <em>value</em> is a form, it may access the parameters as variables.
If it is a function, it is given the internal data structure for the resource
and any supplied parameters as its arguments; it will need to default any
unsupplied optional parameters.  This keyword is required.
</p>
</dd>
<dt><code>:free-list-size</code></dt>
<dd><p>The <em>value</em> is the number of objects which the resource data
structure should have room, initially, to remember.  This is not a
hard limit, since the data structure will be made bigger if necessary.
</p>
</dd>
<dt><code>:initial-copies</code></dt>
<dd><p>The <em>value</em> is a number (or <code>nil</code> which means 0).  This many objects will
be made as part of the evaluation of the <code>defresource</code>; thus is useful to
set up a pool of free objects during loading of a program.  The default is
to make no initial copies.
</p>
<p>If initial copies are made and there are <em>parameters</em>, all the parameters must
be <code>&amp;optional</code> and the initial copies will have the default values of the
parameters.
</p>
</dd>
<dt><code>:initializer</code></dt>
<dd><p>The <em>value</em> is a form or a function as with <code>:constructor</code>.  In
addition to the parameters, a form here may access the variable
<code>object</code> (in the current package).  A function gets the object as
its second argument, after the data structure and before the
parameters.  The purpose of the initializer function or form is to
clean up the contents of the object before each use.  It is called or
evaluated each time an object is allocated, whether just constructed
or being reused.
</p>
</dd>
<dt><code>:finder</code></dt>
<dd><p>The <em>value</em> is a form or a function as with <code>:constructor</code> and sees the
same arguments.  If this option is specified, the resource system does not keep
track of the objects.  Instead, the finder must do so.  It will be called
inside a <code>without-interrupts</code> and must find a usable object somehow and return it.
</p>
</dd>
<dt><code>:matcher</code></dt>
<dd><p>The <em>value</em> is a form or a function as with <code>:constructor</code>.  In addition to
the parameters, a form here may access the variable <code>object</code> (in the current package).
A function gets the object as its second argument, after the data structure and
before the parameters.  The job of the matcher is to make sure that the object
matches the specified parameters.  If no matcher is supplied, the system will remember
the values of the parameters (including optional ones that defaulted) that were used
to construct the object, and will assume that it matches those particular values for
all time.  The comparison is done with <code>equal</code> (not <code>eq</code>).  The matcher is
called inside a <code>without-interrupts</code>.
</p>
</dd>
<dt><code>:checker</code></dt>
<dd><p>The <em>value</em> is a form or a function, as above.  In addition to the parameters,
a form here may access the variables <code>object</code> and <code>in-use-p</code> (in the current
package).  A function receives these as its second and third arguments, after the
data structure and before the parameters.  The job of the checker is to determine
whether the object is safe to allocate.  If no checker is supplied, the default
checker looks only at <code>in-use-p</code>; if the object has been allocated and not freed
it is not safe to allocate, otherwise it is.  The checker is
called inside a <code>without-interrupts</code>.
</p>
</dd>
</dl>
<p>If these options are used with forms (rather than functions), the forms
get compiled into functions as part of the expansion of <code>defresource</code>.
The functions, whether user-provided or generated from forms, are given
names like <code>(:property <em>resource-name</em> si:resource-constructor)</code>;
these names are not guaranteed not to change in the future.
</p>
<p>Most of the options are not used in typical cases.  Here is an example:
</p><div class="lisp">
<pre class="lisp">(defresource two-dimensional-array (rows columns)
	:constructor (make-array (list rows columns)))
</pre></div>

<p>Suppose the array was usually going to be 100 by 100, and you wanted to preallocate
one during loading of the program so that the first time you needed an array you
wouldn&rsquo;t have to spend the time to create one.  You might simply put
</p><div class="lisp">
<pre class="lisp">(using-resource (foo two-dimensional-array 100 100)
	)
</pre></div>
<p>after your <code>defresource</code>, which would allocate a 100 by 100 array and then
immediately free it.  Alternatively you could write:
</p><div class="lisp">
<pre class="lisp">(defresource two-dimensional-array
			(&amp;optional (rows 100) (columns 100))
	:constructor (make-array (list rows columns))
	:initial-copies 1)
</pre></div>

<p>Here is an example of how you might use the <code>:matcher</code> option.  Suppose you wanted
to have a resource of two-dimensional arrays, as above, except that when you allocate
one you don&rsquo;t care about the exact size, as long as it is big enough.  Furthermore
you realize that you are going to have a lot of different sizes and if you always
allocated one of exactly the right size, you would allocate a lot of different arrays
and would not reuse a pre-existing array very often.  So you might write:
</p><div class="lisp">
<pre class="lisp">(defresource sloppy-two-dimensional-array (rows columns)
    :constructor (make-array (list rows columns))
    :matcher (and ( (array-dimension-n 1 object) rows)
		  ( (array-dimension-n 2 object) columns)))
</pre></div>
</dd></dl>

<a name="g_t_0022Allocating-Resource-Objects_0022"></a>
<h4 class="subsection">5.12.2 &quot;Allocating Resource Objects&quot;</h4>

<a name="allocate_002dresource_002dfun"></a><dl>
<dt><a name="index-allocate_002dresource"></a>Function: <strong>allocate-resource</strong> <em>name &amp;rest parameters</em></dt>
<dd><p>Allocate an object from the resource specified by <em>name</em>.  The various forms
and/or functions given as options to <code>defresource</code>, together with any
<em>parameters</em> given to <code>allocate-resource</code>, control how a suitable object
is found and whether a new one has to be constructed or an old one can be reused.
</p>
<p>Note that the <code>using-resource</code> special form is usually what you want to
use, rather than <code>allocate-resource</code> itself; see below.
</p></dd></dl>

<a name="deallocate_002dresource_002dfun"></a><dl>
<dt><a name="index-deallocate_002dresource"></a>Function: <strong>deallocate-resource</strong> <em>name resource</em></dt>
<dd><p>Free the object <em>resource</em>, returning it to the free-object list of the resource
specified by <em>name</em>.
</p></dd></dl>

<a name="clear_002dresource_002dfun"></a><dl>
<dt><a name="index-clear_002dresource"></a>Function: <strong>clear-resource</strong> <em>name</em></dt>
<dd><p>Forget all of the objects being remembered by the resource specified by <em>name</em>.
Future calls to <code>allocate-resource</code> will create new objects.  This function is
useful if something about the resource has been changed incompatibly, such that the
old objects are no longer usable.  If an object of the resource is in use when
<code>clear-resource</code> is called, an error will be signalled when that object is
deallocated.
</p></dd></dl>

<a name="using_002dresource_002dfun"></a><dl>
<dt><a name="index-using_002dresource"></a>Special Form: <strong>using-resource</strong> <em>(variable resource parameters...) body...</em></dt>
<dd><p>The <em>body</em> forms are evaluated sequentially with <em>variable</em> bound to an
object allocated from the resource named <em>resource</em>, using the given <em>parameters</em>.
The <em>parameters</em> (if any) are evaluated, but <em>resource</em> is not.
</p>
<p><code>using-resource</code> is often more convenient than calling
<code>allocate-resource</code> and <code>deallocate-resource</code>.
Furthermore it is careful to free the object when the body is exited,
whether it returns normally or via <code>*throw</code>.  This is done by using
<code>unwind-protect</code>; see <a href="#unwind_002dprotect_002dfun">unwind-protect-fun</a>.
</p></dd></dl>

<div class="lisp">
<pre class="lisp">Here is an example of the use of resources:
</pre><pre class="lisp">(defresource huge-16b-array (&amp;optional (size 1000))
  :constructor (make-array size ':type 'art-16b))

(defun do-complex-computation (x y)
  (using-resource (temp-array huge-16b-array)
    ...                               ;<span class="roman">Within the body, the array can be used.</span>
    (aset 5 temp-array i)
    ...))                             ;<span class="roman">The array is returned at the end.</span>
</pre></div>

<a name="g_t_0022Accessing-the-Resource-Data-Structure_0022"></a>
<h4 class="subsection">5.12.3 &quot;Accessing the Resource Data Structure&quot;</h4>

<p>The constructor, initializer, matcher and checker functions receive
the internal resource data structure as an argument.  This is a named
structure array whose elements record the objects both free and
allocated, and whose array leader contains sundry other information.
This structure should be accessed using the following primitives:
</p>
<a name="si_003aresource_002dobject_002dfun"></a><dl>
<dt><a name="index-si_003aresource_002dobject"></a>Function: <strong>si:resource-object</strong> <em>resource-structure index</em></dt>
<dd><p>Returns the <em>index</em>&rsquo;th object remembered by the resource.
Both free and allocated objects are remembered.
</p></dd></dl>

<a name="si_003aresource_002din_002duse_002dp_002dfun"></a><dl>
<dt><a name="index-si_003aresource_002din_002duse_002dp"></a>Function: <strong>si:resource-in-use-p</strong> <em>resource-structure index</em></dt>
<dd><p>Returns <code>t</code> if the <em>index</em>&rsquo;th object remembered by the
resource has been allocated and not deallocated.
Simply defined resources will not reallocate an object in this state.
</p></dd></dl>

<a name="si_003aresource_002dparameters_002dfun"></a><dl>
<dt><a name="index-si_003aresource_002dparameters"></a>Function: <strong>si:resource-parameters</strong> <em>resource-structure index</em></dt>
<dd><p>Returns the list of parameters from which the <em>index</em>&rsquo;th object
was originally created.
</p></dd></dl>

<a name="si_003aresource_002dn_002dobjects_002dfun"></a><dl>
<dt><a name="index-si_003aresource_002dn_002dobjects"></a>Function: <strong>si:resource-n-objects</strong> <em>resource-structure</em></dt>
<dd><p>Returns the number of objects currently remembered by the resource.
This will include all objects ever constructed, unless
<code>clear-resource</code> has been used.
</p></dd></dl>

<a name="si_003aresource_002dparametizer_002dfun"></a><dl>
<dt><a name="index-si_003aresource_002dparametizer"></a>Function: <strong>si:resource-parametizer</strong> <em>resource-structure</em></dt>
<dd><p>Returns a function, created by <code>defresource</code>, which accepts the
supplied parameters as arguments, and returns a complete list of
parameter values, including defaults for the optional ones.
</p></dd></dl>


<a name="g_t_0022Symbols_0022"></a>
<h2 class="chapter">6 &quot;Symbols&quot;</h2>
<a name="index-_0022symbol_0022-2"></a>
<a name="symbol"></a><a name="symbol_002dchapter"></a><a name="g_t_0022The-Value-Cell_0022"></a>
<h3 class="section">6.1 &quot;The Value Cell&quot;</h3>
<a name="index-_0022value-cell_0022"></a>
<p>Each symbol has associated with it a <em>value cell</em>, which refers
to one Lisp object.  This object is called the symbol&rsquo;s <em>binding</em> or <em>value</em>,
since it is what you get when you evaluate the symbol.  The binding of symbols to values
allows symbols to be used as the implementation of <em>variables</em> in programs.
</p>
<p>The value cell can also be <em>empty</em>, referring to <em>no</em> Lisp
object, in which case the symbol is said to be <em>unbound</em>.  This is the initial
state of a symbol when it is created.  An attempt to evaluate an unbound symbol
causes an error.
</p>
<p>Symbols are often used as special variables.  Variables and how
they work are described in <a href="#variable_002dsection">variable-section</a>.	The symbols <code>nil</code> and
<code>t</code> are always bound to themselves; they may not be assigned, bound,
or otherwise used as variables.  Attempting to change the value of
<code>nil</code> or <code>t</code> usually causes an error.
</p>
<p>The functions described here work on <em>symbols</em>, not <em>variables</em>
in general.  This means that the functions below won&rsquo;t work if you try to
use them on local variables.
</p>
<a name="set_002dfun"></a><dl>
<dt><a name="index-set"></a>Function: <strong>set</strong> <em>symbol value</em></dt>
<dd><p><code>set</code> is the primitive for assignment of symbols.  The <em>symbol</em>&rsquo;s value
is changed to <em>value</em>; <em>value</em> may be any Lisp object.  <code>set</code> returns
<em>value</em>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(set (cond ((eq a b) 'c)
           (t 'd))
     'foo)
</pre></div>
<p>will either set <code>c</code> to <code>foo</code> or set <code>d</code> to <code>foo</code>.
</p></dd></dl>

<a name="symeval_002dfun"></a><dl>
<dt><a name="index-symeval"></a>Function: <strong>symeval</strong> <em>symbol</em></dt>
<dd><p><code>symeval</code> is the basic primitive for retrieving a symbol&rsquo;s value.
<code>(symeval <em>symbol</em>)</code> returns <em>symbol</em>&rsquo;s current binding.
This is the function called by <code>eval</code> when it is given a symbol
to evaluate.  If the symbol is unbound, then <code>symeval</code> causes 
an error.
</p></dd></dl>

<a name="boundp_002dfun"></a><dl>
<dt><a name="index-boundp"></a>Function: <strong>boundp</strong> <em>symbol</em></dt>
<dd><p><code>boundp</code> returns <code>t</code> if <em>symbol</em> is bound; otherwise, it returns <code>nil</code>.
</p></dd></dl>

<a name="makunbound_002dfun"></a><dl>
<dt><a name="index-makunbound"></a>Function: <strong>makunbound</strong> <em>symbol</em></dt>
<dd><p><code>makunbound</code> causes <em>symbol</em> to become unbound.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq a 1)
a =&gt; 1
(makunbound 'a)
a =&gt; <span class="roman">causes an error.</span>
</pre></div>
<p><code>makunbound</code> returns its argument.
</p></dd></dl>

<a name="value_002dcell_002dlocation_002dfun"></a><dl>
<dt><a name="index-value_002dcell_002dlocation"></a>Function: <strong>value-cell-location</strong> <em>symbol</em></dt>
<dd><p><code>value-cell-location</code> returns a locative pointer to <em>symbol</em>&rsquo;s value cell.
See the section on locatives (<a href="#locative">locative</a>).  It is preferable to write
</p><div class="lisp">
<pre class="lisp">(locf (symeval <em>symbol</em>))
</pre></div>
<p>instead of calling this function explicitly.
</p>
<p>This is actually the internal value cell; there can also be an external
value cell.  For details, see the section on closures (<a href="#closure">closure</a>).
</p>
<p>For historical compatibility, <code>value-cell-location</code> of a quoted symbol
is recognized specially by the compiler and treated like
<code>variable-location</code>.  However, such usage will result in a compiler
warning, and eventually this compatibility feature will be removed.
</p></dd></dl>

<a name="variable_002dlocation_002dfun"></a><dl>
<dt><a name="index-variable_002dlocation"></a>Special Form: <strong>variable-location</strong> <em>symbol</em></dt>
<dd><p>Returns a locative to the cell in which the value of <em>symbol</em> is
stored.  <em>symbol</em> is an unevaluated argument, so the name of the
symbol must appear explicitly in the code.
</p>
<p>With ordinary special variables, this is equivalent to
</p><div class="lisp">
<pre class="lisp">(value-cell-location '<em>symbol</em>)
</pre></div>
<p>However, the compiler does not always store the values of variables in
the value cells of symbols.  The compiler handles <code>variable-location</code>
by producing code that returns a locative to the cell where the value is
actually being kept.  For a local variable, this will be a pointer into
the function&rsquo;s stack frame.  For a flavor instance variable, this will
be a pointer into the instance which is <code>self</code>&rsquo;s value.
</p>
<p>In addition, if <em>symbol</em> is a special variable which is closed over,
the value returned will be an external value cell, the same as the value of
<code>locate-in-closure</code> applied to the proper closure and <em>symbol</em>.  This cell
<em>always</em> contains the value which is <em>current</em> only while inside the closure.
See <a href="#external_002dvalue_002dcell">external-value-cell</a>.
</p></dd></dl>

<a name="variable_002dboundp_002dfun"></a><dl>
<dt><a name="index-variable_002dboundp"></a>Special Form: <strong>variable-boundp</strong> <em>symbol</em></dt>
<dd><p>This is non-<code>nil</code> if <em>symbol</em> has a value.
All symbols are initially <em>unbound</em> (their value cells are &quot;empty&quot;)
until they are set or bound to a value.  While this is the case,
<code>variable-boundp</code> returns <code>nil</code>.
</p>
<p>It is equivalent to 
</p><div class="lisp">
<pre class="lisp">(location-boundp (variable-location <em>symbol</em>))
</pre></div>
<p><em>symbol</em> is not evaluated.
</p></dd></dl>

<a name="variable_002dmakunbound_002dfun"></a><dl>
<dt><a name="index-variable_002dmakunbound"></a>Special Form: <strong>variable-makunbound</strong> <em>symbol</em></dt>
<dd><p>This makes <em>symbol</em>&rsquo;s value cell &quot;empty&quot; again, making <em>symbol</em> unbound.
Evaluating <em>symbol</em> henceforth will be an error unless <em>symbol</em> is
later set or bound.
</p>
<p>This is equivalent to 
</p><div class="lisp">
<pre class="lisp">(location-makunbound (variable-location <em>symbol</em>))
</pre></div>
<p><em>symbol</em> is not evaluated.
</p></dd></dl>

<a name="g_t_0022The-Function-Cell_0022"></a>
<h3 class="section">6.2 &quot;The Function Cell&quot;</h3>
<a name="index-_0022function-cell_0022"></a>
<p>Every symbol also has associated with it a <em>function cell</em>.  The <em>function</em>
cell is similar to the <em>value</em> cell; it refers to a Lisp object.
When a function is referred to by name, that is, when a symbol is passed to <code>apply</code>
or appears as the car of a form to be evaluated, that symbol&rsquo;s function cell
is used to find its <em>definition</em>, the functional object which is to be applied.
For example, when evaluating <code>(+ 5 6)</code>, 
the evaluator looks in <code>+</code>&rsquo;s function cell to find the definition of <code>+</code>,
in this case a compiled function object, to apply to 5 and 6.
	Maclisp does not have function cells; instead, it looks for special
properties on the property list.  This is one of the major incompatibilities
between the two dialects.
	Like the value cell, a function cell can be empty, and it can be bound
or assigned.  (However, to bind a function cell you must use the
<code>bind</code> subprimitive; see <a href="#bind_002dfun">bind-fun</a>.)
The following functions are analogous to the value-cell-related
functions in the previous section.
</p>
<a name="fsymeval_002dfun"></a><dl>
<dt><a name="index-fsymeval"></a>Function: <strong>fsymeval</strong> <em>symbol</em></dt>
<dd><p><code>fsymeval</code> returns <em>symbol</em>&rsquo;s definition, the contents of its function cell.
If the function cell is empty, <code>fsymeval</code> causes an error.
</p></dd></dl>

<a name="fset_002dfun"></a><dl>
<dt><a name="index-fset"></a>Function: <strong>fset</strong> <em>symbol definition</em></dt>
<dd><p><code>fset</code> stores <em>definition</em>, which may be any Lisp object, into <em>symbol</em>&rsquo;s
function cell.  It returns <em>definition</em>.
</p></dd></dl>

<a name="fboundp_002dfun"></a><dl>
<dt><a name="index-fboundp"></a>Function: <strong>fboundp</strong> <em>symbol</em></dt>
<dd><p><code>fboundp</code> returns <code>nil</code> if <em>symbol</em>&rsquo;s function cell is empty,
i.e if <em>symbol</em> is undefined.
Otherwise it returns <code>t</code>.
</p></dd></dl>

<a name="fmakunbound_002dfun"></a><dl>
<dt><a name="index-fmakunbound"></a>Function: <strong>fmakunbound</strong> <em>symbol</em></dt>
<dd><p><code>fmakunbound</code> causes <em>symbol</em> to be undefined, i.e its
function cell to be empty.
It returns <em>symbol</em>.
</p></dd></dl>

<a name="function_002dcell_002dlocation_002dfun"></a><dl>
<dt><a name="index-function_002dcell_002dlocation"></a>Function: <strong>function-cell-location</strong> <em>symbol</em></dt>
<dd><p><code>function-cell-location</code> returns a locative pointer to <em>symbol</em>&rsquo;s
function cell.  See the section on locatives (<a href="#locative">locative</a>).  It is
preferable to write
</p><div class="lisp">
<pre class="lisp">(locf (fsymeval <em>symbol</em>))
</pre></div>
<p>rather than calling this function explicitly.
</p></dd></dl>

<p>Since functions are the basic building block of Lisp programs,
the system provides a variety of facilities for dealing with functions.
Refer to chapter <a href="#function_002dchapter">function-chapter</a> for details.
</p>
<a name="g_t_0022The-Property-List_0022"></a>
<h3 class="section">6.3 &quot;The Property List&quot;</h3>
<a name="symbol_002dplist_002dsection"></a>
<p>Every symbol has an associated property list.  See <a href="#plist">plist</a> for
documentation of property lists.  When a symbol is created, its property
list is initially empty.
</p>
<p>The Lisp language itself does not use a symbol&rsquo;s property list for
anything.  (This was not true in older Lisp implementations, where the
print-name, value-cell, and function-cell of a symbol were kept on its
property list.)  However, various system programs use the property list to
associate information with the symbol.  For instance, the editor uses
the property list of a symbol which is the name of a function to
remember where it has the source code for that function, and the
compiler uses the property list of a symbol which is the name of a
special form to remember how to compile that special form.
</p>
<p>Because of the existence of print-name, value, function, and package cells,
none of the Maclisp system property names (<code>expr</code>, <code>fexpr</code>, <code>macro</code>, <code>array</code>,
<code>subr</code>, <code>lsubr</code>, <code>fsubr</code>, and in former times <code>value</code> and
<code>pname</code>) exist in Zetalisp.
</p>
<a name="plist_002dfun"></a><dl>
<dt><a name="index-plist"></a>Function: <strong>plist</strong> <em>symbol</em></dt>
<dd><p>This returns the list which represents the property list of <em>symbol</em>.  Note that
this is not the property list itself; you cannot do <code>get</code> on it.
</p></dd></dl>

<a name="setplist_002dfun"></a><dl>
<dt><a name="index-setplist"></a>Function: <strong>setplist</strong> <em>symbol list</em></dt>
<dd><p>This sets the list which represents the property list of <em>symbol</em> to <em>list</em>.
<code>setplist</code> is to be used with caution (or not at all),
since property lists sometimes contain internal system properties, which
are used by many useful system functions.  Also it is inadvisable to have the property
lists of two different symbols be <code>eq</code>, since the shared list structure will
cause unexpected effects on one symbol if <code>putprop</code> or <code>remprop</code> is done to the other.
</p></dd></dl>

<a name="property_002dcell_002dlocation_002dfun"></a><dl>
<dt><a name="index-property_002dcell_002dlocation"></a>Function: <strong>property-cell-location</strong> <em>symbol</em></dt>
<dd><p>This returns a locative pointer to the location of <em>symbol</em>&rsquo;s property-list
cell.  This locative pointer may be passed to <code>get</code> or <code>putprop</code> with the same results as if as <em>symbol</em> itself had been passed.  It is preferable to write
</p><div class="lisp">
<pre class="lisp">(locf (plist <em>symbol</em>))
</pre></div>
<p>rather than using this function.
</p></dd></dl>

<a name="g_t_0022The-Print-Name_0022"></a>
<h3 class="section">6.4 &quot;The Print Name&quot;</h3>
<a name="index-_0022print-name_0022-1"></a>
<p>Every symbol has an associated string called the <em>print-name</em>, or <em>pname</em>
for short.  This string is used as the external representation of the symbol:
if the string is typed in to <code>read</code>, it is read as a reference to that symbol
(if it is interned), and if the symbol is printed, <code>print</code> types out the
print-name.
For more information, see the sections on the <em>reader</em>
(see <a href="#reader">reader</a>) and <em>printer</em> (see <a href="#printer">printer</a>).
</p>
<a name="get_002dpname_002dfun"></a><dl>
<dt><a name="index-get_002dpname"></a>Function: <strong>get-pname</strong> <em>symbol</em></dt>
<dd><p>This returns the print-name of the symbol <em>symbol</em>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(get-pname 'xyz) =&gt; &quot;XYZ&quot;
</pre></div>
</dd></dl>

<a name="samepnamep_002dfun"></a><dl>
<dt><a name="index-samepnamep"></a>Function: <strong>samepnamep</strong> <em>sym1 sym2</em></dt>
<dd><p>This predicate returns <code>t</code> if the two symbols <em>sym1</em> and <em>sym2</em> have
<code>equal</code> print-names; that is, if their printed representations are the same.
Upper and lower case letters are normally considered the same.
Strings are also accepted as arguments; their contents are used in the comparison.
<code>samepnamep</code> is useful for determining if two symbols would be the same
except that they are in different packages (see <a href="#package">package</a>).
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(samepnamep 'xyz (maknam '(x y z)) =&gt; t

(samepnamep 'xyz (maknam '(w x y)) =&gt; nil

(samepnamep 'xyz &quot;XYZ&quot;) =&gt; t
</pre></div>

<p>This is the same function as <code>string-equal</code> (see <a href="#string_002dequal_002dfun">string-equal-fun</a>).
<code>samepnamep</code> is provided mainly so that you can write programs that
will work in Maclisp as well as Zetalisp; in new programs,
you should just use <code>string-equal</code>.
</p></dd></dl>

<a name="The-Package-Cell"></a>
<h3 class="section">6.5 The Package Cell</h3>

<p>Every symbol has a <em>package cell</em> which, for interned
symbols, is used to point to the package which the symbol belongs to.  For an
uninterned symbol, the package cell contains <code>nil</code>.  For
information about packages in general, see the chapter on packages, <a href="#package">package</a>.
For information about package cells, see <a href="#symbol_002dpackage_002dcell_002ddiscussion">symbol-package-cell-discussion</a>.
</p>
<a name="Creating-Symbols"></a>
<h3 class="section">6.6 Creating Symbols</h3>

<p>The functions in this section are primitives for creating symbols.
However, before discussing them, it is important to point out that most
symbols are created by a higher-level mechanism, namely the reader and
the <code>intern</code> function.  Nearly all symbols in Lisp are created
by virtue of the reader&rsquo;s having seen a sequence of input characters that
looked like the printed representation (p.r) of a symbol.  When the
reader sees such a p.r, it calls <code>intern</code> (see <a href="#intern_002dfun">intern-fun</a>),
which looks up the sequence of characters in a big table and sees whether any symbol
with this print-name already exists.  If it does, <code>read</code> uses the
already-existing symbol.  If it does not, then <code>intern</code> creates a new
symbol and puts it into the table; <code>read</code> uses that new symbol.
</p>
<p>A symbol that has been put into such a table is called an <em>interned</em>
symbol.  Interned symbols are normally created automatically; the first
time that someone (such as the reader) asks for a symbol with a given
print-name, that symbol is automatically created.
</p>
<p>These tables are called <em>packages</em>.
In Zetalisp, interned symbols are the province of the
<em>package</em> system.  Although interned symbols are the most commonly
used, they will not be discussed further here.  For more information,
turn to the chapter on packages (<a href="#package">package</a>).
</p>
<p>An <em>uninterned</em> symbol is a symbol used simply as a data object,
with no special cataloging.  An uninterned symbol prints the same
as an interned symbol with the same print-name, but cannot be read back in.
</p>
<p>The following functions can be used to create uninterned symbols
explicitly.
</p>
<a name="make_002dsymbol_002dfun"></a><dl>
<dt><a name="index-make_002dsymbol"></a>Function: <strong>make-symbol</strong> <em>pname &amp;optional permanent-p</em></dt>
<dd><p>This creates a new uninterned symbol, whose print-name is the string
<em>pname</em>.  The value and function bindings will be unbound and the
property list will be empty.  If <em>permanent-p</em> is specified, it is
assumed that the symbol is going to be interned and probably kept around
forever; in this case it and its pname will be put in the proper areas.
If <em>permanent-p</em> is <code>nil</code> (the default), the symbol goes in the
default area and the pname is not copied.  <em>permanent-p</em> is mostly
for the use of <code>intern</code> itself.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(setq a (make-symbol &quot;foo&quot;)) =&gt; foo
(symeval a) =&gt; ERROR!
</pre></div>
<p>Note that the symbol is <em>not</em> interned; it is simply created and returned.
</p></dd></dl>

<a name="copysymbol_002dfun"></a><dl>
<dt><a name="index-copysymbol"></a>Function: <strong>copysymbol</strong> <em>symbol copy-props</em></dt>
<dd><p>This returns a new uninterned symbol with the same print-name
as <em>symbol</em>.  If <em>copy-props</em> is non-<code>nil</code>, then the
value and function-definition of the new symbol will
be the same as those of <em>symbol</em>, and the property list of
the new symbol will be a copy of <em>symbol</em>&rsquo;s.  If <em>copy-props</em>
is <code>nil</code>, then the new symbol will be unbound and undefined, and
its property list will be empty.
</p></dd></dl>

<a name="gensym_002dfun"></a><dl>
<dt><a name="index-gensym"></a>Function: <strong>gensym</strong> <em>&amp;optional x</em></dt>
<dd><p><code>gensym</code> invents a print-name, and creates a new symbol with that print-name.
It returns the new, uninterned symbol.
</p>
<p>The invented print-name is a character prefix (the value of <code>si:*gensym-prefix</code>)
followed by the decimal representation of a number (the value of <code>si:*gensym-counter</code>),
e.g <code>g0001</code>.  The number is increased by one every time <code>gensym</code> is called.
</p>
<p>If the argument <em>x</em> is present and is a fixnum, then <code>si:*gensym-counter</code> is
set to <em>x</em>.  If <em>x</em> is a string or a symbol, then <code>si:*gensym-prefix</code> is set to
the first character of the string or of the symbol&rsquo;s print-name.
After handling the argument, <code>gensym</code> creates a symbol as it would with no argument.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp"><span class="roman">if</span>	(gensym) =&gt; g0007
<span class="roman">then</span>	(gensym 'foo) =&gt; f0008
	(gensym 32.) =&gt; f0032
	(gensym) =&gt; f0033
</pre></div>
<p>Note that the number is in decimal and always has four digits, and the prefix is
always one character.
</p>
<p><code>gensym</code> is usually used to create a symbol which should not normally
be seen by the user, and whose print-name is unimportant, except to
allow easy distinction by eye between two such symbols.
The optional argument is rarely supplied.
The name comes from &quot;generate symbol&quot;, and the symbols produced by it
are often called &quot;gensyms&quot;.
</p></dd></dl>
<a name="g_t_0022Numbers_0022"></a>
<h2 class="chapter">7 &quot;Numbers&quot;</h2>
<a name="number"></a><a name="number_002dchapter"></a><a name="index-number"></a>
<p>Zetalisp includes several types of numbers, with different
characteristics.  Most numeric functions will accept any type of numbers as
arguments and do the right thing.  That is to say, they are <em>generic</em>.
In Maclisp, there are generic numeric functions (like <code>plus</code>) and there
are specific numeric functions (like <code>+</code>) which only operate on a certain
type of number, but are much more efficient.
In Zetalisp, this distinction does not exist; both function
names exist for compatibility but they are identical.  The microprogrammed
structure of the machine makes it possible to have only the generic
functions without loss of efficiency. 
</p>
<a name="index-fixnum"></a>
<a name="index-bignum"></a>
<a name="index-rationalnum"></a>
<a name="index-flonum"></a>
<a name="index-small_002dflonum"></a>
<a name="index-complexnum"></a>

<p>The types of numbers in Zetalisp are:
</p><dl compact="compact">
<dt><span class="roman">fixnum</span></dt>
<dd><p>Fixnums are 24-bit 2&rsquo;s complement binary integers.  These are the &quot;preferred,
most efficient&quot; type of number.
</p></dd>
<dt><span class="roman">bignum</span></dt>
<dd><p>Bignums are arbitrary-precision binary integers.
</p></dd>
<dt><span class="roman">rationalnum</span></dt>
<dd><p>Rationalnums represent rational numbers exactly as the quotient of two
integers, each of which can be a fixnum or a bignum.  Rationalnums with
a denominator of one are not normally created, as an integer will be returned instead.
</p></dd>
<dt><span class="roman">flonum</span></dt>
<dd><p>Flonums are floating-point numbers.  They have a mantissa of 32 bits and an exponent
of 11 bits, providing a precision of about 9 digits and a range of about 10^300.
Stable rounding is employed.
</p></dd>
<dt><span class="roman">small-flonum</span></dt>
<dd><p>Small flonums are another form of floating-point number, with a mantissa of
18 bits and an exponent of 7 bits, providing a precision of about 5 digits
and a range of about 10^19.  Stable rounding is employed.
Small flonums are useful because, like fixnums,
and unlike flonums, they don&rsquo;t require any storage.  Computing with small flonums is
more efficient than with regular flonums because the operations are faster
and consing overhead is eliminated.
</p></dd>
<dt><span class="roman">complexnum</span></dt>
<dd><p>Complexnums represent complex numbers with a real part and an imaginary
part, each of which can be any type of number except a complexnum.
Complexnums whose imaginary part is zero are not normally generated,
as a real number will be returned instead.
</p></dd>
</dl>

<p>Generally, Lisp objects have a unique identity; each exists, independent
of any other, and you can use the <code>eq</code> predicate to determine whether
two references are to the same object or not.  Numbers are the exception
to this rule; they don&rsquo;t work this way.  The following function may return
either <code>t</code> or <code>nil</code>.  Its behavior is considered undefinedd;
as this manual is written, it returns <code>t</code> when interpreted but <code>nil</code> when compiled.
</p><div class="lisp">
<pre class="lisp">(defun foo ()
   (let ((x (float 5)))
     (eq x (car (cons x nil)))))
</pre></div>
<p>This is very strange from the point of view of Lisp&rsquo;s usual object
semantics, but the implementation works this way, in order to gain
efficiency, and on the grounds that identity testing of numbers is not
really an interesting thing to do.  So the rule is that the result
of applying <code>eq</code> to numbers is undefined, and may return either
<code>t</code> or <code>nil</code> at will.  If you want to compare the values of
two numbers, use <code>=</code> (see <a href="#g_t_003d_002dfun">=-fun</a>) or <code>eql</code> (<a href="#eql_002dfun">eql-fun</a>).
</p>
<p>Fixnums and small flonums are exceptions to this rule; some system code
knows that <code>eq</code> works on fixnums used to represent characters or small
integers, and uses <code>memq</code> or <code>assq</code> on them.  <code>eq</code> works as well
as <code>=</code> as an equality test for fixnums.  Small flonums that are <code>=</code>
tend to be <code>eq</code> also, but it is unwise to depend on this.
</p>
<p>The distinction between fixnums and bignums is largely transparent to
the user.  The user simply computes with integers, and the system
represents some as fixnums and the rest (less efficiently) as bignums.
The system automatically converts back and forth between fixnums and
bignums based solely on the size of the integer.  There are a few &quot;low
level&quot; functions which only work on fixnums; this fact is noted in
their documentation.  Also, when using <code>eq</code> on numbers the user
needs to be aware of the fixnum/bignum distinction.
</p>
<p>Integer computations cannot &quot;overflow&quot;, except for division by zero,
since bignums can be of arbitrary size.  Floating-point computations
can get exponent overflow or underflow, if the result is too large or small
to be represented.  Exponent overflow always signals an error.
Exponent underflow normally signals an error, and assumes <code>0.0</code> as the answer
if the user says to proceed from the error.  However, if the value of the
variable <code>zunderflow</code> is non-<code>nil</code>, the error is skipped
and computation proceeds with <code>0.0</code> in place of the result that was too small.
</p>
<p>When an arithmetic function of more than one argument is given arguments
of different numeric types, uniform <em>coercion rules</em> are followed to
convert the arguments to a common type, which is also the type of the
result (for functions which return a number).  When an integer meets a
rationalnum, the result is a rationalnum.  When an integer or
rationalnum meets a small flonum or a flonum, the result is a small
flonum or a flonum (respectively).  When a small flonum meets a regular
flonum, the result is a regular flonum.  When a real number meets a
complexnum, the result is a complexnum.
</p>
<p>Thus if the constants in a numerical algorithm are written as
small flonums (assuming this provides adequate precision), and if the input
is a small flonum, the computation will be done in small-flonum mode and
the result will be a small flonum, while if the input is a large flonum
the computations will be done in full precision and the result will
be a flonum.
</p>
<p>Zetalisp never automatically converts between flonums and small
flonums, the way it automatically converts between fixnums and
bignums, since this would lead either to inefficiency or to unexpected
numerical inaccuracies.  (When a small flonum meets a flonum, the result
is a flonum, but if you use only one type, all the results will be of
the same type too.)  This means that a small-flonum computation can get
an exponent overflow error even when the result could have been
represented as a large flonum.
</p>
<p>Floating-point numbers retain only a certain number of bits of precision;
therefore, the results of computations are only approximate.  Large flonums
have 31 bits and small flonums have 17 bits, not counting the sign.
The method of approximation is &quot;stable rounding&quot;.  The result of an
arithmetic operation will be the flonum which is closest to the exact
value.  If the exact result falls precisely halfway between two flonums,
the result will be rounded down if the least-significant bit is 0,
or up if the least-significant bit is 1.  This choice is arbitrary
but insures that no systematic bias is introduced.
</p>
<p>Unlike Maclisp, Zetalisp does not have number declarations in
the compiler.  Note that because fixnums and small flonums require no
associated storage they are as efficient as declared numbers in Maclisp.
Bignums and (large) flonums are less efficient; however, bignum and
flonum intermediate results are garbage-collected in a special way that
avoids the overhead of the full garbage collector.
</p>
<p>The different types of numbers can be distinguished by their printed
representations.  A leading or embedded (but <em>not</em> trailing) decimal
point, and/or an exponent separated by &quot;<code>e</code>&quot;, indicates a flonum.  If a
number has an exponent separated by &quot;<code>s</code>&quot;, it is a small flonum.  Small
flonums require a special indicator so that naive users will not
accidentally compute with the lesser precision.  Fixnums
and bignums have similar printed representations since there is no
numerical value that has a choice of whether to be a fixnum or a bignum;
an integer is a bignum if and only if its magnitude is too big for a
fixnum.  See the examples on <a href="#flonum_002dexamples">flonum-examples</a>, in the description
of what the reader understands.
</p>
<a name="zunderflow_002dvar"></a><dl>
<dt><a name="index-zunderflow"></a>Variable: <strong>zunderflow</strong></dt>
<dd><p>When this is <code>nil</code>, floating point exponent underflow is an error.
When this is <code>t</code>, exponent underflow proceeds, returning zero as the value.
The same thing could be accomplished with a condition handler.
However, <code>zunderflow</code> is useful for Maclisp compatibility, and is also faster.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003aarithmetic_002derror-error_0029-on-sys_003afloating_002dexponent_002doverflow"></a>Condition on sys:floating-exponent-overflow: <strong>(<code>sys:arithmetic-error</code> <code>error</code>)</strong></dt>
<dt><a name="index-_0028sys_003aarithmetic_002derror-on-sys_003afloating_002dexponent_002dunderflow"></a>Condition on sys:floating-exponent-underflow: <strong>(<code>sys:arithmetic-error</code></strong> <em><code>error</code>)</em></dt>
<dd><p><code>sys:floating-exponent-overflow</code> is signaled when the result of an
arithmetic operation should be a floating point number, but the exponent
is too large to be represented in the format to be used for the value.
<code>sys:floating-exponent-underflow</code> is signaled when the exponent is too
small.
</p>
<p>The condition instance provides two additional operations:
<code>:function</code>, which returns the arithmetic function that was called,
and <code>:small-float-p</code>, which is <code>t</code> if the result was supposed to be
a small flonum.
</p>
<p><code>sys:floating-exponent-overflow</code> provides the <code>:new-value</code> proceed
type.  It expects one argument, a new value.
</p>
<p><code>sys:floating-exponent-underflow</code> provides the <code>:use-zero</code> proceed
type, which expects no argument.
</p>
<p>Unfortunately, it is not possible to make the arguments to the operation
available.  Perhaps someday they will be.
</p></dd></dl>

<a name="g_t_0022Numeric-Predicates_0022"></a>
<h3 class="section">7.1 &quot;Numeric Predicates&quot;</h3>
<a name="zerop_002dfun"></a><dl>
<dt><a name="index-zerop"></a>Function: <strong>zerop</strong> <em>x</em></dt>
<dd><p>Returns <code>t</code> if <em>x</em> is zero.  Otherwise it returns <code>nil</code>.
If <em>x</em> is not a number, <code>zerop</code> causes an error.  For flonums,
this only returns <code>t</code> for exactly <code>0.0</code> or <code>0.0s0</code>; there
is no &quot;fuzz&quot;.
</p></dd></dl>

<a name="plusp_002dfun"></a><dl>
<dt><a name="index-plusp"></a>Function: <strong>plusp</strong> <em>x</em></dt>
<dd><p>Returns <code>t</code> if its argument is a positive number, strictly greater
than zero.  Otherwise it returns <code>nil</code>.
If <em>x</em> is not a number, <code>plusp</code> causes an error.
</p></dd></dl>

<a name="minusp_002dfun"></a><dl>
<dt><a name="index-minusp"></a>Function: <strong>minusp</strong> <em>x</em></dt>
<dd><p>Returns <code>t</code> if its argument is a negative number, strictly
less than zero.  Otherwise it returns <code>nil</code>.
If <em>x</em> is not a number, <code>minusp</code> causes an error.
</p></dd></dl>

<a name="oddp_002dfun"></a><dl>
<dt><a name="index-oddp"></a>Function: <strong>oddp</strong> <em>number</em></dt>
<dd><p>Returns <code>t</code> if <em>number</em> is odd, otherwise <code>nil</code>.
If <em>number</em> is not a fixnum or a bignum, <code>oddp</code> causes an error.
</p></dd></dl>

<a name="evenp_002dfun"></a><dl>
<dt><a name="index-evenp"></a>Function: <strong>evenp</strong> <em>number</em></dt>
<dd><p>Returns <code>t</code> if <em>number</em> is even, otherwise <code>nil</code>.
If <em>number</em> is not a fixnum or a bignum, <code>evenp</code> causes an error.
</p></dd></dl>

<a name="signp_002dfun"></a><dl>
<dt><a name="index-signp"></a>Special Form: <strong>signp</strong> <em>test x</em></dt>
<dd><p><em>signp</em> is used to test the sign of a number.  It is present only for
Maclisp compatibility and is not recommended for use in new programs.
<code>signp</code> returns <code>t</code> if <em>x</em> is a number which
satisfies the <em>test</em>, <code>nil</code> if it is not a number or does not meet
the test.  <em>test</em> is not evaluated, but <em>x</em> is.  <em>test</em> can be
one of the following:
</p><dl compact="compact">
<dt><code>l</code></dt>
<dd><p>x &lt; 0
</p></dd>
<dt><code>le</code></dt>
<dd><p>x <code>lessOrEqual</code> 0
</p></dd>
<dt><code>e</code></dt>
<dd><p>x = 0
</p></dd>
<dt><code>n</code></dt>
<dd><p>x <code>notEquals</code> 0
</p></dd>
<dt><code>ge</code></dt>
<dd><p>x <code>greaterOrEqual</code> 0
</p></dd>
<dt><code>g</code></dt>
<dd><p>x &gt; 0
</p></dd>
</dl>
<div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(signp ge 12) =&gt; t
(signp le 12) =&gt; nil
(signp n 0) =&gt; nil
(signp g 'foo) =&gt; nil
</pre></div>
</dd></dl>

<p>See also the data-type predicates <code>integerp</code>, <code>rationalp</code>,
<code>realp</code>, <code>complexp</code>,
<code>floatp</code>, <code>bigp</code>, <code>small-floatp</code>, and <code>numberp</code> (<a href="#fixp_002dfun">fixp-fun</a>).
</p>
<a name="Numeric-Comparisons"></a>
<h3 class="section">7.2 Numeric Comparisons</h3>

<p>All of these functions require that their arguments be numbers; they signal
an error if given a non-number.  Equality tests work on all types of numbers,
automatically performing any required coercions (as opposed to
Maclisp in which generally only the spelled-out names work for
all kinds of numbers).  Ordering comparisons work only on real numbers,
since they are meaningless on complex numbers.
</p>
<a name="g_t_003d_002dfun"></a><dl>
<dt><a name="index-_003d"></a>Function: <strong>=</strong> <em>x y</em></dt>
<dd><p>Returns <code>t</code> if <em>x</em> and <em>y</em> are numerically equal.  An integer can
be <code>=</code> to a flonum.
</p></dd></dl>

<a name="eql_002dfun_002d1"></a><dl>
<dt><a name="index-eql-1"></a>Function: <strong>eql</strong> <em>x y</em></dt>
<dd><p>Returns <code>t</code> if <em>x</em> and <em>y</em> are both numbers and numerically equal,
or if they are <code>eq</code>.
</p></dd></dl>

<a name="greaterp_002dfun"></a><dl>
<dt><a name="index-greaterp"></a>Function: <strong>greaterp</strong> <em>&amp;rest two-or-more-args</em></dt>
<dd><a name="g_t_003e_002dfun"></a></dd><dt><a name="index-_003e"></a>Function: <strong>&gt;</strong> <em>&amp;rest two-or-more-args</em></dt>
<dd><p><code>greaterp</code> compares its arguments from left to right.  If any argument
is not greater than the next, <code>greaterp</code> returns <code>nil</code>.  But if the
arguments are monotonically strictly decreasing, the result is <code>t</code>.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(greaterp 4 3) =&gt; t
(greaterp 4 3 2 1 0) =&gt; t
(greaterp 4 3 1 2 0) =&gt; nil
</pre></div>
</dd></dl>

<a name="g_t_003e_003d_002dfun"></a><dl>
<dt><a name="index-_003e_003d"></a>Function: <strong>&gt;=</strong> <em>&amp;rest two-or-more-args</em></dt>
<dd><a name="greaterOrEqual_002dfun"></a></dd><dt><a name="index-greaterOrEqual"></a>Function: <strong>greaterOrEqual</strong> <em>&amp;rest two-or-more-args</em></dt>
<dd><p><code>greaterOrEqual</code> compares its arguments from left to right.  If any argument
is less than the next, <code>greaterOrEqual</code> returns <code>nil</code>.  But if the
arguments are monotonically decreasing or equal, the result is <code>t</code>.
</p></dd></dl>

<a name="lessp_002dfun"></a><dl>
<dt><a name="index-lessp"></a>Function: <strong>lessp</strong> <em>&amp;rest two-or-more-args</em></dt>
<dd><a name="g_t_003c_002dfun"></a></dd><dt><a name="index-_003c"></a>Function: <strong>&lt;</strong> <em>&amp;rest two-or-more-args</em></dt>
<dd><p><code>lessp</code> compares its arguments from left to right.  If any argument
is not less than the next, <code>lessp</code> returns <code>nil</code>.  But if the
arguments are monotonically strictly increasing, the result is <code>t</code>.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(lessp 3 4) =&gt; t
(lessp 1 1) =&gt; nil
(lessp 0 1 2 3 4) =&gt; t
(lessp 0 1 3 2 4) =&gt; nil
</pre></div>
</dd></dl>

<a name="g_t_003c_003d_002dfun"></a><dl>
<dt><a name="index-_003c_003d"></a>Function: <strong>&lt;=</strong> <em>&amp;rest two-or-more-args</em></dt>
<dd><a name="lessOrEqual_002dfun"></a></dd><dt><a name="index-lessOrEqual"></a>Function: <strong>lessOrEqual</strong> <em>&amp;rest two-or-more-args</em></dt>
<dd><p><code>lessOrEqual</code> compares its arguments from left to right.  If any argument
is greater than the next, <code>lessOrEqual</code> returns <code>nil</code>.  But if the
arguments are monotonically increasing or equal, the result is <code>t</code>.
</p></dd></dl>

<a name="notEquals_002dfun"></a><dl>
<dt><a name="index-notEquals"></a>Function: <strong>notEquals</strong> <em>x y</em></dt>
<dd><p>Returns <code>t</code> if <em>x</em> is not numerically equal to <em>y</em>, and <code>nil</code> otherwise.
</p></dd></dl>

<a name="max_002dfun"></a><dl>
<dt><a name="index-max"></a>Function: <strong>max</strong> <em>&amp;rest one-or-more-args</em></dt>
<dd><p><code>max</code> returns the largest of its arguments, which must all be real.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(max 1 3 2) =&gt; 3
</pre></div>
<p><code>max</code> requires at least one argument.
</p></dd></dl>

<a name="min_002dfun"></a><dl>
<dt><a name="index-min"></a>Function: <strong>min</strong> <em>&amp;rest one-or-more-args</em></dt>
<dd><p><code>min</code> returns the smallest of its arguments, which must all be real.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(min 1 3 2) =&gt; 1
</pre></div>
<p><code>min</code> requires at least one argument.
</p></dd></dl>

<a name="g_t_0022Arithmetic_0022"></a>
<h3 class="section">7.3 &quot;Arithmetic&quot;</h3>

<p>All of these functions require that their arguments be numbers, and signal
an error if given a non-number.  They work on all types of numbers,
automatically performing any required coercions (as opposed to Maclisp,
in which generally only the spelled-out versions work for all kinds
of numbers, and the &quot;$&quot; versions are needed for flonums).
</p>
<a name="plus_002dfun"></a><dl>
<dt><a name="index-plus"></a>Function: <strong>plus</strong> <em>&amp;rest args</em></dt>
<dd><a name="g_t_002b_002dfun"></a></dd><dt><a name="index-_002b"></a>Function: <strong>+</strong> <em>&amp;rest args</em></dt>
<dd><a name="g_t_002b_0024_002dfun"></a></dd><dt><a name="index-_002b_0024"></a>Function: <strong>+$</strong> <em>&amp;rest args</em></dt>
<dd><p>Returns the sum of its arguments.  If there are no arguments, it returns
<code>0</code>, which is the identity for this operation.
</p></dd></dl>

<a name="difference_002dfun"></a><dl>
<dt><a name="index-difference"></a>Function: <strong>difference</strong> <em>arg &amp;rest args</em></dt>
<dd><p>Returns its first argument minus all of the rest of its arguments.
</p></dd></dl>

<a name="minus_002dfun"></a><dl>
<dt><a name="index-minus"></a>Function: <strong>minus</strong> <em>x</em></dt>
<dd><p>Returns the negative of <em>x</em>.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(minus 1) =&gt; -1
(minus -3.0) =&gt; 3.0
</pre></div>
</dd></dl>

<a name="g_t_002d_002dfun"></a><dl>
<dt><a name="index-_002d"></a>Function: <strong>-</strong> <em>arg &amp;rest args</em></dt>
<dd><a name="g_t_002d_0024_002dfun"></a></dd><dt><a name="index-_002d_0024"></a>Function: <strong>-$</strong> <em>arg &amp;rest args</em></dt>
<dd><p>With only one argument, <code>-</code> is the same as <code>minus</code>; it
returns the negative of its argument.
With more than one argument, <code>-</code> is the same as <code>difference</code>;
it returns its first argument minus all of the rest of its arguments.
</p></dd></dl>

<a name="abs_002dfun"></a><dl>
<dt><a name="index-abs"></a>Function: <strong>abs</strong> <em>x</em></dt>
<dd><p>Returns <code>|<em>x</em>|</code>, the absolute value of the number <em>x</em>.
<code>abs</code> for real numbers could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun abs (x)
    (cond ((minusp x) (minus x))
	  (t x)))
</pre></div>

<p><code>abs</code> of a complex number is
</p><div class="lisp">
<pre class="lisp">(sqrt (^ (realpart x) 2) (^ (imagpart x) 2))
</pre></div>
</dd></dl>

<a name="times_002dfun"></a><dl>
<dt><a name="index-times"></a>Function: <strong>times</strong> <em>&amp;rest args</em></dt>
<dd><a name="g_t_002a_002dfun"></a></dd><dt><a name="index-_002a"></a>Function: <strong>*</strong> <em>&amp;rest args</em></dt>
<dd><a name="g_t_002a_0024_002dfun"></a></dd><dt><a name="index-_002a_0024"></a>Function: <strong>*$</strong> <em>&amp;rest args</em></dt>
<dd><p>Returns the product of its arguments.  If there are no arguments, it
returns <code>1</code>, which is the identity for this operation.
</p></dd></dl>

<a name="quotient_002dfun"></a><dl>
<dt><a name="index-quotient"></a>Function: <strong>quotient</strong> <em>arg &amp;rest args</em></dt>
<dd><p>Returns the first argument divided by all of the rest of its arguments.
</p></dd></dl>

<a name="g_t_002f_002f_002dfun"></a><dl>
<dt><a name="index-_002f_002f"></a>Function: <strong>//</strong> <em>arg &amp;rest args</em></dt>
<dd><a name="g_t_002f_002f_0024_002dfun"></a></dd><dt><a name="index-_002f_002f_0024"></a>Function: <strong>//$</strong> <em>arg &amp;rest args</em></dt>
<dd><p>The name of this function is written <code>//</code> rather than <code>/</code> because
<code>/</code> is the quoting character in Lisp syntax and must be doubled.
With more than one argument, <code>//</code> is the same as <code>quotient</code>;
it returns the first argument divided by all of the rest of its arguments.
With only one argument, <code>(// <em>x</em>)</code> is the same as <code>(// 1 <em>x</em>)</code>.
</p>
<p><code>quotient</code> and <code>//</code> of two integers returns an integer even if
the mathematically correct value is not an integer.  More precisely, the
value is the same as the first value of <code>truncate</code> (see below).
This will eventually be changed, and then the value will be a
rationalnum if necessary so that the it is mathematically correct.
All code that relies on <code>quotient</code> or <code>//</code> to return an integer
value rather than a rationalnum should be converted to use <code>truncate</code>
(or <code>floor</code> or <code>ceiling</code>, which may simplify the code further).
In the mean time, use the function <code>%div</code> if you want a rational
result.
</p>
<div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(// 3 2) =&gt; 1       <span class="roman">;Fixnum division truncates.</span>
(// 3 -2) =&gt; -1
(// -3 2) =&gt; -1
(// -3 -2) =&gt; 1
(// 3 2.0) =&gt; 1.5
(// 3 2.0s0) =&gt; 1.5s0
(// 4 2) =&gt; 2
(// 12. 2. 3.) =&gt; 2
(// 4.0) =&gt; .25
</pre></div>
</dd></dl>

<a name="remainder_002dfun"></a><dl>
<dt><a name="index-remainder"></a>Function: <strong>remainder</strong> <em>x y</em></dt>
<dd><a name="g_t_005c_002dfun"></a></dd><dt><a name="index-_005c"></a>Function: <strong>\</strong> <em>x y</em></dt>
<dd><p>Returns the remainder of <em>x</em> divided by <em>y</em>.
<em>x</em> and <em>y</em> must be integers (fixnums or bignums).
This is the same as the second value of <code>(truncate <em>x</em> <em>y</em>)</code>.
</p><div class="lisp">
<pre class="lisp">(\ 3 2) =&gt; 1
(\ -3 2) =&gt; -1
(\ 3 -2) =&gt; 1
(\ -3 -2) =&gt; -1
</pre></div>
</dd></dl>

<a name="g_t_0025div_002dfun"></a><dl>
<dt><a name="index-_0025div"></a>Function: <strong>%div</strong> <em>dividend divisor</em></dt>
<dd><p>Divides, returning a mathematically correct quotient (a rationalnum if
necessary) when the arguments are integers.  If either argument is a
noninteger, the result is the same as that of using <code>//</code>.
</p><div class="lisp">
<pre class="lisp">(%div 1 2) =&gt; 1\2
</pre></div>
</dd></dl>

<p>There are four functions for &quot;integer division&quot;, the sort which
produces a quotient and a remainder.  They differ in how they round the
quotient to an integer, and therefore also in the sign of the remainder.
The arguments must be real, since ordering is needed to compute the
value.
</p>
<a name="floor_002dfun"></a><dl>
<dt><a name="index-floor"></a>Function: <strong>floor</strong> <em>x &amp;optional (y <code>1</code>)</em></dt>
<dd><p><code>floor</code>&rsquo;s first value is the largest integer less than or equal to the
quotient of <em>x</em> divided by <em>y</em>.
</p>
<p>The second value is the &quot;remainder&quot;, <em>x</em> minus <em>y</em> times the first
value.  This has the same sign as <em>y</em> (or may be zero), regardless of
the sign of <em>x</em>.
</p>
<p>With one argument, <code>floor</code>&rsquo;s first value is the largest integer less than
or equal to the argument.
</p></dd></dl>

<a name="ceiling_002dfun"></a><dl>
<dt><a name="index-ceiling"></a>Function: <strong>ceiling</strong> <em>x &amp;optional (y <code>1</code>)</em></dt>
<dd><p><code>ceiling</code>&rsquo;s first value is the smallest integer greater than or equal
to the quotient of <em>x</em> divided by <em>y</em>.
</p>
<p>The second value is the &quot;remainder&quot;, <em>x</em> minus <em>y</em> times the first
value.  This has the opposite sign from <em>y</em> (or may be zero),
regardless of the sign of <em>x</em>.
</p>
<p>With one argument, <code>ceiling</code>&rsquo;s first value is the smallest integer greater than
or equal to the argument.
</p></dd></dl>

<a name="truncate_002dfun"></a><dl>
<dt><a name="index-truncate"></a>Function: <strong>truncate</strong> <em>x &amp;optional (y <code>1</code>)</em></dt>
<dd><p><code>truncate</code> is the same as <code>floor</code> if the arguments have the same
sign, <code>ceiling</code> if they have opposite signs.  <code>truncate</code> is the
function that the divide instruction on most computers implements.
</p>
<p><code>truncate</code>&rsquo;s first value is the nearest integer, in the direction of
zero, to the quotient of <em>x</em> divided by <em>y</em>.
</p>
<p>The second value is the &quot;remainder&quot;, <em>x</em> minus <em>y</em> times the first
value.  This has the same sign as <em>x</em> (or may be zero).
</p></dd></dl>

<a name="round_002dfun"></a><dl>
<dt><a name="index-round"></a>Function: <strong>round</strong> <em>x &amp;optional (y <code>1</code>)</em></dt>
<dd><p><code>round</code>&rsquo;s first value is the nearest integer 
to the quotient of <em>x</em> divided by <em>y</em>.  If the quotient is midway
between two integers, the even integer of the two is used.
</p>
<p>The second value is the &quot;remainder&quot;, <em>x</em> minus <em>y</em> times the first
value.  The sign of this remainder cannot be predicted from the signs of
the arguments alone.
</p>
<p>With one argument, <code>round</code>&rsquo;s first value is the integer nearest to the
argument.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003aarithmetic_002derror-error_0029-on-sys_003adivide_002dby_002dzero"></a>Condition on sys:divide-by-zero: <strong>(<code>sys:arithmetic-error</code> <code>error</code>)</strong></dt>
<dd><p>Dividing by zero, using any of the above division functions, signals this
condition.  The <code>:function</code> operation on the condition instance
returns the name of the division function.  The <code>:dividend</code> operation
may be available to return the number that was divided.
</p></dd></dl>

<a name="add1_002dfun"></a><dl>
<dt><a name="index-add1"></a>Function: <strong>add1</strong> <em>x</em></dt>
<dd><a name="g_t1_002b_002dfun"></a></dd><dt><a name="index-1_002b"></a>Function: <strong>1+</strong> <em>x</em></dt>
<dd><a name="g_t1_002b_0024_002dfun"></a></dd><dt><a name="index-1_002b_0024"></a>Function: <strong>1+$</strong> <em>x</em></dt>
<dd><p><code>(add1 x)</code> is the same as <code>(plus x 1)</code>.
</p></dd></dl>

<a name="sub1_002dfun"></a><dl>
<dt><a name="index-sub1"></a>Function: <strong>sub1</strong> <em>x</em></dt>
<dd><a name="g_t1_002d_002dfun"></a></dd><dt><a name="index-1_002d"></a>Function: <strong>1-</strong> <em>x</em></dt>
<dd><a name="g_t1_002d_0024_002dfun"></a></dd><dt><a name="index-1_002d_0024"></a>Function: <strong>1-$</strong> <em>x</em></dt>
<dd><p><code>(sub1 x)</code> is the same as <code>(difference x 1)</code>.  Note that the
short name may be confusing: <code>(1- x)</code> does <em>not</em> mean 1-x;
rather, it means x-1.
</p></dd></dl>

<a name="gcd_002dfun"></a><dl>
<dt><a name="index-gcd"></a>Function: <strong>gcd</strong> <em>x y &amp;rest args</em></dt>
<dd><a name="g_t_005c_005c_002dfun"></a></dd><dt><a name="index-_005c_005c"></a>Function: <strong>\\</strong> <em>x y &amp;rest args</em></dt>
<dd><p>Returns the greatest common divisor of all its arguments.
The arguments must be integers (fixnums or bignums).
</p></dd></dl>

<a name="expt_002dfun"></a><dl>
<dt><a name="index-expt"></a>Function: <strong>expt</strong> <em>x y</em></dt>
<dd><a name="g_t_005e_002dfun"></a></dd><dt><a name="index-_005e"></a>Function: <strong>^</strong> <em>x y</em></dt>
<dd><a name="g_t_005e_0024_002dfun"></a></dd><dt><a name="index-_005e_0024"></a>Function: <strong>^$</strong> <em>x y</em></dt>
<dd><p>Returns <em>x</em> raised to the <em>y</em>&rsquo;th power.  The result is rational (and
possibly an integer) if both arguments are integers, and floating-point
if either <em>x</em> or <em>y</em> or both is floating-point.  If the exponent is
an integer a repeated-squaring algorithm is used; otherwise the result
is <code>(exp (* <em>y</em> (log <em>x</em>)))</code>.
</p>
<p>Currently complex exponents are not allowed, and complex
bases are allowed only with integer exponents.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003aarithmetic_002derror-error_0029-on-sys_003azero_002dto_002dnegative_002dpower"></a>Condition on sys:zero-to-negative-power: <strong>(<code>sys:arithmetic-error</code> <code>error</code>)</strong></dt>
<dd><p>This condition is signaled when <code>expt</code>&rsquo;s first argument is zero
and the second argument is negative.
</p></dd></dl>

<a name="sqrt_002dfun"></a><dl>
<dt><a name="index-sqrt"></a>Function: <strong>sqrt</strong> <em>x</em></dt>
<dd><p>Returns the square root of <em>x</em>.  It is currently implemented only for
nonnegative real <em>x</em>.
</p></dd></dl>

<a name="isqrt_002dfun"></a><dl>
<dt><a name="index-isqrt"></a>Function: <strong>isqrt</strong> <em>x</em></dt>
<dd><p>Integer square-root.  <em>x</em> must be an integer; the result is the greatest
integer less than or equal to the exact square root of <em>x</em>.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003aarithmetic_002derror-error_0029-on-sys_003anegative_002dsqrt"></a>Condition on sys:negative-sqrt: <strong>(<code>sys:arithmetic-error</code> <code>error</code>)</strong></dt>
<dd><p>This is signaled when <code>sqrt</code> or <code>isqrt's</code> argument is negative.
The <code>:number</code> operation on the condition instance will return the argument.
</p></dd></dl>

<a name="g_t_002adif_002dfun"></a><dl>
<dt><a name="index-_002adif"></a>Function: <strong>*dif</strong> <em>x y</em></dt>
<dd><a name="g_t_002aplus_002dfun"></a></dd><dt><a name="index-_002aplus"></a>Function: <strong>*plus</strong> <em>x y</em></dt>
<dd><a name="g_t_002aquo_002dfun"></a></dd><dt><a name="index-_002aquo"></a>Function: <strong>*quo</strong> <em>x y</em></dt>
<dd><a name="g_t_002atimes_002dfun"></a></dd><dt><a name="index-_002atimes"></a>Function: <strong>*times</strong> <em>x y</em></dt>
<dd><p>These are the internal microcoded arithmetic functions.  There is no
reason why anyone should need to write code with these explicitly, since the
compiler knows how to generate the appropriate code for <code>plus</code>,
<code>+</code>, etc.  These names are only here for Maclisp compatibility.
</p></dd></dl>

<a name="Complex-Number-Functions"></a>
<h3 class="section">7.4 Complex Number Functions</h3>

<p>See also the predicates <code>realp</code> and <code>complexp</code> (<a href="#complexp_002dfun">complexp-fun</a>).
</p>
<a name="complex_002dfun"></a><dl>
<dt><a name="index-complex"></a>Function: <strong>complex</strong> <em>x &amp;optional y</em></dt>
<dd><p>Returns the complex number whose real part is <em>x</em> and whose imaginary
part is <em>y</em>.
</p>
<p>If <em>y</em> is zero, a peculiar complexnum is created whose numeric
value is actually real.  If <em>y</em> is omitted, a number is used whose
value is zero and whose type is the same as that of <em>x</em>.
Note that <code>realp</code> of this peculiar complexnum will be <code>nil</code> even
though the mathematical value is indeed real.
</p></dd></dl>

<a name="realpart_002dfun"></a><dl>
<dt><a name="index-realpart"></a>Function: <strong>realpart</strong> <em>x</em></dt>
<dd><p>Returns the real part of the number <em>x</em>.  If <em>x</em> is real,
this is the same as <em>x</em>.
</p></dd></dl>

<a name="imagpart_002dfun"></a><dl>
<dt><a name="index-imagpart"></a>Function: <strong>imagpart</strong> <em>x</em></dt>
<dd><p>Returns the imaginary part of the number <em>x</em>.  If <em>x</em> is real, this
is zero.
</p></dd></dl>

<a name="conjugate_002dfun"></a><dl>
<dt><a name="index-conjugate"></a>Function: <strong>conjugate</strong> <em>x</em></dt>
<dd><p>Returns the complex conjugate of the number <em>x</em>.  If <em>x</em> is real,
this is the same as <em>x</em>.
</p></dd></dl>

<a name="phase_002dfun"></a><dl>
<dt><a name="index-phase"></a>Function: <strong>phase</strong> <em>x</em></dt>
<dd><p>Returns the phase angle of the complex number <em>x</em> in its polar form.
This is the angle from the positive x-axis to the ray from the
origin through <em>x</em>.  The value is always in the interval <code>[0, 2pi)</code>.
</p></dd></dl>

<a name="cis_002dfun"></a><dl>
<dt><a name="index-cis"></a>Function: <strong>cis</strong> <em>angle</em></dt>
<dd><p>Returns the complex number of unit magnitude whose phase is <em>angle</em>.
This is equal to <code>(complex (cos <em>angle</em>) (sin <em>angle</em>))</code>.
</p></dd></dl>

<a name="signum_002dfun"></a><dl>
<dt><a name="index-signum"></a>Function: <strong>signum</strong> <em>x</em></dt>
<dd><p>Returns a number with unit magnitude and the same phase as <em>x</em>.  If
<em>x</em> is zero, the value is zero.
</p>
<p>If <em>x</em> is real, the value is either <code>1</code> or <code>-1</code>.
</p></dd></dl>

<a name="Transcendental-Functions"></a>
<h3 class="section">7.5 Transcendental Functions</h3>

<p>These functions are only for floating-point arguments; if given an integer
they will convert it to a flonum.  If given a small-flonum, they will return a
small-flonum.
</p>
<p>Currently complex arguments are not allowed.  This will be changed some
day.
</p>
<a name="exp_002dfun"></a><dl>
<dt><a name="index-exp"></a>Function: <strong>exp</strong> <em>x</em></dt>
<dd><p>Returns <em>e</em> raised to the <em>x</em>&rsquo;th power, where <em>e</em> is the base of natural logarithms.
</p></dd></dl>

<a name="log_002dfun"></a><dl>
<dt><a name="index-log"></a>Function: <strong>log</strong> <em>x</em></dt>
<dd><p>Returns the natural logarithm of <em>x</em>.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003aarithmetic_002derror-error_0029-on-sys_003anon_002dpositive_002dlog"></a>Condition on sys:non-positive-log: <strong>(<code>sys:arithmetic-error</code> <code>error</code>)</strong></dt>
<dd><p>This is signaled when the argument to <code>log</code> is a negative number or zero.
The <code>:number</code> operation on the condition instance returns that number.
</p></dd></dl>

<a name="sin_002dfun"></a><dl>
<dt><a name="index-sin"></a>Function: <strong>sin</strong> <em>x</em></dt>
<dd><p>Returns the sine of <em>x</em>, where <em>x</em> is expressed in radians.
</p></dd></dl>

<a name="sind_002dfun"></a><dl>
<dt><a name="index-sind"></a>Function: <strong>sind</strong> <em>x</em></dt>
<dd><p>Returns the sine of <em>x</em>, where <em>x</em> is expressed in degrees.
</p></dd></dl>

<a name="cos_002dfun"></a><dl>
<dt><a name="index-cos"></a>Function: <strong>cos</strong> <em>x</em></dt>
<dd><p>Returns the cosine of <em>x</em>, where <em>x</em> is expressed in radians.
</p></dd></dl>

<a name="cosd_002dfun"></a><dl>
<dt><a name="index-cosd"></a>Function: <strong>cosd</strong> <em>x</em></dt>
<dd><p>Returns the cosine of <em>x</em>, where <em>x</em> is expressed in degrees.
</p></dd></dl>

<a name="atan_002dfun"></a><dl>
<dt><a name="index-atan"></a>Function: <strong>atan</strong> <em>y x</em></dt>
<dd><p>Returns the angle, in radians, whose tangent is <em>y/x</em>.  <code>atan</code> always returns a
non-negative number between zero and <code>2pi</code>.
</p></dd></dl>

<a name="atan2_002dfun"></a><dl>
<dt><a name="index-atan2"></a>Function: <strong>atan2</strong> <em>y x</em></dt>
<dd><p>Returns the angle, in radians, whose tangent is <em>y/x</em>.  <code>atan2</code> always returns a
number between <code>-pi</code> and <code>pi</code>.
</p></dd></dl>

<a name="Numeric-Type-Conversions"></a>
<h3 class="section">7.6 Numeric Type Conversions</h3>

<p>These functions are provided to allow specific conversions of data
types to be forced, when desired.
</p>
<a name="fix_002dfun"></a><dl>
<dt><a name="index-fix"></a>Function: <strong>fix</strong> <em>x</em></dt>
<dd><p>Converts <em>x</em> from a flonum (or small-flonum) or rationalnum to an integer,
truncating towards negative infinity.
The result is a fixnum or a bignum as appropriate.  If <em>x</em> is already
a fixnum or a bignum, it is returned unchanged.
</p>
<p><code>fix</code> is the same as <code>floor</code> except that <code>floor</code> returns an
additional value.  <code>fix</code> is semi-obsolete, since the functions <code>floor</code>,
<code>ceiling</code>, <code>truncate</code> and <code>round</code> provide four different ways of
converting numbers to integers with different kinds of rounding.
</p></dd></dl>

<a name="fixr_002dfun"></a><dl>
<dt><a name="index-fixr"></a>Function: <strong>fixr</strong> <em>x</em></dt>
<dd><p><code>fixr</code> is the same as <code>round</code> except that <code>round</code> returns an
additional value.  <code>fixr</code> is considered obsolete.
</p></dd></dl>

<a name="float_002dfun"></a><dl>
<dt><a name="index-float"></a>Function: <strong>float</strong> <em>x</em></dt>
<dd><p>Converts any kind of number to a flonum.
</p></dd></dl>

<a name="small_002dfloat_002dfun"></a><dl>
<dt><a name="index-small_002dfloat"></a>Function: <strong>small-float</strong> <em>x</em></dt>
<dd><p>Converts any kind of number to a small flonum.
</p></dd></dl>

<a name="numerator_002dfun"></a><dl>
<dt><a name="index-numerator"></a>Function: <strong>numerator</strong> <em>x</em></dt>
<dd><p>Returns the numerator of the rational number <em>x</em>.  If <em>x</em> is an
integer, the value equals <em>x</em>.  If <em>x</em> is not an integer or
rationalnum, an error is signaled.
</p></dd></dl>

<a name="denominator_002dfun"></a><dl>
<dt><a name="index-denominator"></a>Function: <strong>denominator</strong> <em>x</em></dt>
<dd><p>Returns the denominator of the rational number <em>x</em>.  If <em>x</em> is an
integer, the value is <code>1</code>.  If <em>x</em> is not an integer or
rationalnum, an error is signaled.
</p></dd></dl>

<a name="rational_002dfun"></a><dl>
<dt><a name="index-rational"></a>Function: <strong>rational</strong> <em>x</em></dt>
<dd><p>Converts <em>x</em> to a rational number.  If <em>x</em> is an integer or a
rationalnum, it is returned unchanged.  If it is a floating point
number, it is regarded as an exact fraction whose numerator is
the mantissa and whose denominator is a power of two.
For any other argument, an error is signaled.
</p></dd></dl>

<a name="rationalize_002dfun"></a><dl>
<dt><a name="index-rationalize"></a>Function: <strong>rationalize</strong> <em>x &amp;optional precision</em></dt>
<dd><p>Returns a rational approximation to <em>x</em>.
</p>
<p>If there is only one argument, and it is an integer or a rationalnum, it
is returned unchanged.  If the argument is a floating point number,
a rational number is returned which, if converted to a floating point
number, would produce the original argument.  Of all such rational
numbers, the one chosen has the smallest numerator and denominator.
</p>
<p>If there are two arguments, the second one specifies how much precision
of the first argument should be considered significant.  <em>precision</em>
can be a positive integer (the number of bits to use), a negative integer
(the number of bits to drop at the end), or a floating point number
(minus its exponent is the number of bits to use).
</p>
<p>If there are two arguments and the first is rational, the value is a
&quot;simpler&quot; rational which approximates it.
</p></dd></dl>

<a name="g_t_0022Logical-Operations-on-Numbers_0022"></a>
<h3 class="section">7.7 &quot;Logical Operations on Numbers&quot;</h3>

<p>Except for <code>lsh</code> and <code>rot</code>, these functions operate on both
fixnums and bignums.  <code>lsh</code> and <code>rot</code> have an inherent word-length
limitation and hence only operate on 24-bit fixnums.  Negative numbers
are operated on in their 2&rsquo;s-complement representation.
</p>
<a name="logior_002dfun"></a><dl>
<dt><a name="index-logior"></a>Function: <strong>logior</strong> <em>&amp;rest one-or-more-args</em></dt>
<dd><p>Returns the bit-wise logical <em>inclusive or</em> of its arguments.
At least one argument is required.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(logior 4002 67) =&gt; 4067
</pre></div>
</dd></dl>

<a name="logxor_002dfun"></a><dl>
<dt><a name="index-logxor"></a>Function: <strong>logxor</strong> <em>&amp;rest one-or-more-args</em></dt>
<dd><p>Returns the bit-wise logical <em>exclusive or</em> of its arguments.
At least one argument is required.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(logxor 2531 7777) =&gt; 5246
</pre></div>
</dd></dl>

<a name="logand_002dfun"></a><dl>
<dt><a name="index-logand"></a>Function: <strong>logand</strong> <em>&amp;rest one-or-more-args</em></dt>
<dd><p>Returns the bit-wise logical <em>and</em> of its arguments.
At least one argument is required.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(logand 3456 707) =&gt; 406
(logand 3456 -100) =&gt; 3400
</pre></div>
</dd></dl>

<a name="lognot_002dfun"></a><dl>
<dt><a name="index-lognot"></a>Function: <strong>lognot</strong> <em>number</em></dt>
<dd><p>Returns the logical complement of <em>number</em>.  This is the same as
<code>logxor</code>&rsquo;ing <em>number</em> with -1.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(lognot 3456) =&gt; -3457
</pre></div>
</dd></dl>

<a name="boole_002dfun"></a><dl>
<dt><a name="index-boole"></a>Function: <strong>boole</strong> <em>fn &amp;rest one-or-more-args</em></dt>
<dd><p><code>boole</code> is the generalization of <code>logand</code>, <code>logior</code>, and <code>logxor</code>.
<em>fn</em> should be a fixnum between 0 and 17 octal inclusive;
it controls the function which is computed.  If the binary representation
of <em>fn</em> is <em>abcd</em> (<em>a</em> is the most significant bit, <em>d</em> the least)
then the truth table for the Boolean operation is as follows:
</p><div class="lisp">
<pre class="lisp">       y
   | 0  1
---------
  0| a  c
x  |
  1| b  d
</pre></div>

<p>If <code>boole</code> has more than three arguments, it is associated left
to right; thus,
</p><div class="lisp">
<pre class="lisp">(boole fn x y z) = (boole fn (boole fn x y) z)
</pre></div>
<p>With two arguments, the result of <code>boole</code> is simply its second argument.
At least two arguments are required.
</p>
<div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(boole 1 x y) = (logand x y)
(boole 6 x y) = (logxor x y)
(boole 2 x y) = (logand (lognot x) y)
</pre></div>

<p><code>logand</code>, <code>logior</code>, and <code>logxor</code> are usually preferred over the equivalent
forms of <code>boole</code>, to avoid putting magic numbers in the program.
</p></dd></dl>

<a name="bit_002dtest_002dfun"></a><dl>
<dt><a name="index-bit_002dtest"></a>Function: <strong>bit-test</strong> <em>x y</em></dt>
<dd><p><code>bit-test</code> is a predicate which returns <code>t</code> if any of
the bits designated by the 1&rsquo;s in <em>x</em> are 1&rsquo;s in <em>y</em>.
<code>bit-test</code> is implemented as a macro which expands as follows:
</p><div class="lisp">
<pre class="lisp">(bit-test <em>x</em> <em>y</em>) ==&gt; (not (zerop (logand <em>x</em> <em>y</em>)))
</pre></div>
</dd></dl>

<a name="lsh_002dfun"></a><dl>
<dt><a name="index-lsh"></a>Function: <strong>lsh</strong> <em>x y</em></dt>
<dd><p>Returns <em>x</em> shifted left <em>y</em> bits if <em>y</em> is positive or zero,
or <em>x</em> shifted right <code>|<em>y</em>|</code> bits if <em>y</em> is negative.
Zero bits are shifted in (at either end) to fill unused positions.
<em>x</em> and <em>y</em> must be fixnums.  (In some applications you may
find <code>ash</code> useful for shifting bignums; see below.)
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(lsh 4 1) =&gt; 10    <span class="roman">;(octal)</span>
(lsh 14 -2) =&gt; 3
(lsh -1 1) =&gt; -2
</pre></div>
</dd></dl>

<a name="ash_002dfun"></a><dl>
<dt><a name="index-ash"></a>Function: <strong>ash</strong> <em>x y</em></dt>
<dd><p>Shifts <em>x</em> arithmetically left <em>y</em> bits if <em>y</em> is positive,
or right <em>-y</em> bits if <em>y</em> is negative.
Unused positions are filled by zeroes from the right, and
by copies of the sign bit from the left.  Thus, unlike <code>lsh</code>,
the sign of the result is always the same as the sign of <em>x</em>.
If <em>x</em> is a fixnum or a bignum, this is a shifting operation.
If <em>x</em> is a flonum, this does scaling (multiplication by a power of two),
rather than actually shifting any bits.
</p></dd></dl>

<a name="rot_002dfun"></a><dl>
<dt><a name="index-rot"></a>Function: <strong>rot</strong> <em>x y</em></dt>
<dd><p>Returns <em>x</em> rotated left <em>y</em> bits if <em>y</em> is positive or zero,
or <em>x</em> rotated right <code>|<em>y</em>|</code> bits if <em>y</em> is negative.
The rotation considers <em>x</em> as a 24-bit number (unlike Maclisp,
which considers <em>x</em> to be a 36-bit number in both the pdp-10
and Multics implementations).
<em>x</em> and <em>y</em> must be fixnums.  (There is no function for
rotating bignums.)
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(rot 1 2) =&gt; 4
(rot 1 -2) =&gt; 20000000
(rot -1 7) =&gt; -1
(rot 15 24.) =&gt; 15
</pre></div>
</dd></dl>

<a name="haulong_002dfun"></a><dl>
<dt><a name="index-haulong"></a>Function: <strong>haulong</strong> <em>x</em></dt>
<dd><p>This returns the number of significant bits in <code>|<em>x</em>|</code>.
<em>x</em> may be a fixnum or a bignum.  Its sign is ignored.
The result is the least integer strictly greater than the base-2
logarithm of <code>|<em>x</em>|</code>.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(haulong 0) =&gt; 0
(haulong 3) =&gt; 2
(haulong -7) =&gt; 3
</pre></div>
</dd></dl>

<a name="haipart_002dfun"></a><dl>
<dt><a name="index-haipart"></a>Function: <strong>haipart</strong> <em>x n</em></dt>
<dd><p>Returns the high <em>n</em> bits of the binary representation of <code>|<em>x</em>|</code>,
or the low <code>-<em>n</em></code> bits if <em>n</em> is negative.
<em>x</em> may be a fixnum or a bignum; its sign is ignored.
<code>haipart</code> could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun haipart (x n)
  (setq x (abs x))
  (if (minusp n)
      (logand x (1- (ash 1 (- n))))
      (ash x (min (- n (haulong x))
		  0))))
</pre></div>
</dd></dl>


<a name="g_t_0022Byte-Manipulation-Functions_0022"></a>
<h3 class="section">7.8 &quot;Byte Manipulation Functions&quot;</h3>
<a name="byte_002dmanipulation_002dfunctions"></a><a name="index-_0022byte_0022"></a>
<p>Several functions are provided for dealing with an arbitrary-width field of
contiguous bits appearing anywhere in an integer (a fixnum or a bignum).
Such a contiguous set of bits is called a <em>byte</em>.  Note that
we are not using the term <em>byte</em> to mean eight bits, but rather
any number of bits within a number.
These functions use numbers called <em>byte specifiers</em> to
<a name="index-_0022byte-specifiers_0022"></a>
designate a specific byte position within any word.  Byte specifiers are fixnums
whose two lowest octal digits represent the <em>size</em> of the
byte, and whose higher (usually two, but sometimes more)
octal digits represent the <em>position</em>
of the byte within a number, counting from the right in bits.  A position
of zero means that the byte is at the right end of the number.
For example, the byte-specifier 0010 (i.e 10 octal) refers to the lowest 
eight bits of a word, and the byte-specifier 1010 refers to the next eight
bits.  These byte-specifiers will be stylized below as <em>ppss</em>.
<a name="index-_0022ppss_0022"></a>
The maximum value of the <em>ss</em> digits is 27 (octal), since a byte must
fit in a fixnum although bytes can be loaded from and deposited into bignums.
(Bytes are always positive numbers.)
The format of byte-specifiers is taken from the pdp-10 byte instructions.
</p>
<a name="ldb_002dfun"></a><dl>
<dt><a name="index-ldb"></a>Function: <strong>ldb</strong> <em>ppss num </em></dt>
<dd><p><em>ppss</em> specifies a byte of <em>num</em> to be extracted.
The <em>ss</em> bits of the byte starting at bit <em>pp</em>
are the lowest <em>ss</em> bits in the returned value, and the rest of the
bits in the returned value are zero.  The name of the function,
<code>ldb</code>, means &quot;load byte&quot;.  <em>num</em> may be a fixnum or a bignum.
The returned value is always a fixnum.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(ldb 0306 4567) =&gt; 56
</pre></div>
</dd></dl>

<a name="load_002dbyte_002dfun"></a><dl>
<dt><a name="index-load_002dbyte"></a>Function: <strong>load-byte</strong> <em>num position size</em></dt>
<dd><p>This is like <code>ldb</code> except that instead of using a byte specifier,
the <em>position</em> and <em>size</em> are passed as separate arguments.
The argument order is not analogous to that of <code>ldb</code> so that
<code>load-byte</code> can be compatible with Maclisp.
</p></dd></dl>

<a name="ldb_002dtest_002dfun"></a><dl>
<dt><a name="index-ldb_002dtest"></a>Function: <strong>ldb-test</strong> <em>ppss y</em></dt>
<dd><p><code>ldb-test</code> is a predicate which returns <code>t</code> if any of
the bits designated by the byte specifier <em>ppss</em> are 1&rsquo;s in <em>y</em>.
That is, it returns <code>t</code> if the designated field is non-zero.
<code>ldb-test</code> is implemented as a macro which expands as follows:
</p><div class="lisp">
<pre class="lisp">(ldb-test <em>ppss</em> <em>y</em>) ==&gt; (not (zerop (ldb <em>ppss</em> <em>y</em>)))
</pre></div>
</dd></dl>

<a name="mask_002dfield_002dfun"></a><dl>
<dt><a name="index-mask_002dfield"></a>Function: <strong>mask-field</strong> <em>ppss num</em></dt>
<dd><p>This is similar to <code>ldb</code>; however, the specified byte
of <em>num</em> is returned as a number in position <em>pp</em> of
the returned word, instead of position 0 as with <code>ldb</code>.
<em>num</em> must be a fixnum.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(mask-field 0306 4567) =&gt; 560
</pre></div>
</dd></dl>

<a name="dpb_002dfun"></a><dl>
<dt><a name="index-dpb"></a>Function: <strong>dpb</strong> <em>byte ppss num</em></dt>
<dd><p>Returns a number which is the same as <em>num</em> except in the
bits specified by <em>ppss</em>.  The low
<em>ss</em> bits of <em>byte</em> are placed in those bits.  <em>byte</em> is interpreted as
being right-justified, as if it were the result of <code>ldb</code>.
<em>num</em> may be a fixnum or a bignum.  The name means &quot;deposit byte&quot;.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(dpb 23 0306 4567) =&gt; 4237
</pre></div>
</dd></dl>

<a name="deposit_002dbyte_002dfun"></a><dl>
<dt><a name="index-deposit_002dbyte"></a>Function: <strong>deposit-byte</strong> <em>num position size byte</em></dt>
<dd><p>This is like <code>dpb</code> except that instead of using a byte specifier,
the <em>position</em> and <em>size</em> are passed as separate arguments.
The argument order is not analogous to that of <code>dpb</code> so that
<code>deposit-byte</code> can be compatible with Maclisp.
</p></dd></dl>

<a name="deposit_002dfield_002dfun"></a><dl>
<dt><a name="index-deposit_002dfield"></a>Function: <strong>deposit-field</strong> <em>byte ppss num</em></dt>
<dd><p>This is like <code>dpb</code>, except that <em>byte</em> is not taken to
be left-justified; the <em>ppss</em> bits of <em>byte</em> are used
for the <em>ppss</em> bits of the result, with the rest of the
bits taken from <em>num</em>.  <em>num</em> must be a fixnum.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(deposit-field 230 0306 4567) =&gt; 4237
</pre></div>
</dd></dl>

<p>The behavior of the following two functions depends on the size of
fixnums, and so functions using them may not work the same way
on future implementations of Zetalisp.  Their names start
with &quot;%&quot; because they are more like machine-level subprimitives
than the previous functions.
</p>
<a name="g_t_0025logldb_002dfun"></a><dl>
<dt><a name="index-_0025logldb"></a>Function: <strong>%logldb</strong> <em>ppss fixnum</em></dt>
<dd><p><code>%logldb</code> is like <code>ldb</code> except that it only loads out of fixnums and
allows a byte size of 30 (octal), i.e all 24 bits of the fixnum
including the sign bit.
</p></dd></dl>

<a name="g_t_0025logdpb_002dfun"></a><dl>
<dt><a name="index-_0025logdpb"></a>Function: <strong>%logdpb</strong> <em>byte ppss fixnum</em></dt>
<dd><p><code>%logdpb</code> is like <code>dpb</code> except that it only deposits into fixnums.
Using this to change the sign-bit will leave the result as a fixnum,
while <code>dpb</code> would produce a bignum result for arithmetic correctness.
<code>%logdpb</code> is good for manipulating fixnum bit-masks such as are used
in some internal system tables and data-structures.
</p></dd></dl>

<a name="g_t_0022Random-Numbers_0022"></a>
<h3 class="section">7.9 &quot;Random Numbers&quot;</h3>

<p>The functions in this section provide a pseudo-random number generator
facility.  The basic function you use is <code>random</code>, which returns a new
pseudo-random number each time it is called.  Between calls, its state
is saved in a data object called a <em>random-array</em>.  Usually there is
only one random-array; however, if you want to create a reproducible
series of pseudo-random numbers, and be able to reset the state to
control when the series starts over, then you need some of the other
functions here.
</p>
<a name="random_002dfun"></a><dl>
<dt><a name="index-random"></a>Function: <strong>random</strong> <em>&amp;optional arg random-array</em></dt>
<dd><p><code>(random)</code> returns a random fixnum, positive or negative.  If <em>arg</em>
is present, a fixnum between 0 and <em>arg</em> minus 1 inclusive is
returned.  If <em>random-array</em> is present, the given array is used
instead of the default one (see below).  Otherwise, the default
random-array is used (and is created if it doesn&rsquo;t already exist).
The algorithm is executed inside a <code>without-interrupts</code>
(see <a href="#without_002dinterrupts_002dfun">without-interrupts-fun</a>) so two processes can use the
same random-array without colliding.
</p></dd></dl>

<a name="si_003arandom_002din_002drange_002dfun"></a><dl>
<dt><a name="index-si_003arandom_002din_002drange"></a>Function: <strong>si:random-in-range</strong> <em>low high</em></dt>
<dd><p>Returns a random flonum in the interval [<em>low</em>, <em>high</em>).
The default random-array is used.
</p></dd></dl>

<p>A random-array consists of an array of numbers and two pointers into
the array.  The pointers circulate around the array; each time a random
number is requested, both pointers are advanced by one, wrapping around
at the end of the array.  Thus, the distance forward from the first
pointer to the second pointer stays the same, allowing for wraparound.
Let the length of the array be <em>length</em> and the distance between the
pointers be <em>offset</em>.  To generate a new random number, each pointer is set
to its old value plus one, modulo <em>length</em>.  Then the two elements of the
array addressed by the pointers are added together; the sum is stored
back into the array at the location where the second pointer points, and
is returned as the random number after being normalized into the right
range.
</p>
<p>This algorithm produces well-distributed random numbers if <em>length</em>
and <em>offset</em> are chosen carefully, so that the polynomial <em>x^length+x^offset+1</em>
is irreducible over the mod-2 integers.  The system uses 71 and 35.
</p>
<p>The contents of the array of numbers should be initialized to anything
moderately random, to make the algorithm work.  The contents get
initialized by a simple random number generator, based on a
number called the <em>seed</em>.  The initial value of the seed is set when
the random-array is created, and it can be changed.  To have several
different controllable resettable sources of random numbers, you
can create your own random-arrays.  If you don&rsquo;t care about reproducibility
of sequences, just use <code>random</code> without the <em>random-array</em> argument.
</p>
<a name="si_003arandom_002dcreate_002darray_002dfun"></a><dl>
<dt><a name="index-si_003arandom_002dcreate_002darray"></a>Function: <strong>si:random-create-array</strong> <em>length offset seed &amp;optional (area <code>nil</code>)</em></dt>
<dd><p>Creates, initializes, and returns a random-array.  <em>length</em> is the
length of the array.  <em>offset</em> is the distance between the pointers
and should be an integer less than <em>length</em>.  <em>seed</em> is the initial
value of the seed, and should be a fixnum.  This calls
<code>si:random-initialize</code> on the random array before returning it.
</p></dd></dl>

<a name="si_003arandom_002dinitialize_002dfun"></a><dl>
<dt><a name="index-si_003arandom_002dinitialize"></a>Function: <strong>si:random-initialize</strong> <em>array &amp;optional new-seed</em></dt>
<dd><p><em>array</em> must be a random-array, such as is created by
<code>si:random-create-array</code>.  If <em>new-seed</em> is provided, it should be a
fixnum, and the seed is set to it.  <code>si:random-initialize</code> reinitializes the
contents of the array from the seed (calling <code>random</code> changes the
contents of the array and the pointers, but not the seed).
</p></dd></dl>

<a name="g_t_002224_002dBit-Numbers_0022"></a>
<h3 class="section">7.10 &quot;24-Bit Numbers&quot;</h3>
<p>Sometimes it is desirable to have a form of arithmetic which has no
overflow checking (that would produce bignums),
and truncates results to the word size of the machine.
In Zetalisp, this is provided by the following set of functions.
Their answers are correct only modulo 2^24.
	These functions should <em>not</em> be used for &quot;efficiency&quot;;
they are probably less efficient than the functions which <em>do</em> check for
overflow.  They are intended for algorithms which require this sort of
arithmetic, such as hash functions and pseudo-random number generation.
</p>
<a name="g_t_002524_002dbit_002dplus_002dfun"></a><dl>
<dt><a name="index-_002524_002dbit_002dplus"></a>Function: <strong>%24-bit-plus</strong> <em>x y</em></dt>
<dd><p>Returns the sum of <em>x</em> and <em>y</em> modulo 2^24.  Both arguments must
be fixnums.
</p></dd></dl>

<a name="g_t_002524_002dbit_002ddifference_002dfun"></a><dl>
<dt><a name="index-_002524_002dbit_002ddifference"></a>Function: <strong>%24-bit-difference</strong> <em>x y</em></dt>
<dd><p>Returns the difference of <em>x</em> and <em>y</em> modulo 2^24.  Both arguments must
be fixnums.
</p></dd></dl>

<a name="g_t_002524_002dbit_002dtimes_002dfun"></a><dl>
<dt><a name="index-_002524_002dbit_002dtimes"></a>Function: <strong>%24-bit-times</strong> <em>x y</em></dt>
<dd><p>Returns the product of <em>x</em> and <em>y</em> modulo 2^24.  Both arguments must
be fixnums.
</p></dd></dl>

<a name="g_t_0022Double_002dPrecision-Arithmetic_0022"></a>
<h3 class="section">7.11 &quot;Double-Precision Arithmetic&quot;</h3>

<p>These peculiar functions are useful in programs that don&rsquo;t want to use
bignums for one reason or another.  They should usually be avoided,
as they are difficult to use and understand, and they depend on special
numbers of bits and on the use of two&rsquo;s-complement notation.
</p>
<a name="g_t_0025multiply_002dfractions_002dfun"></a><dl>
<dt><a name="index-_0025multiply_002dfractions"></a>Function: <strong>%multiply-fractions</strong> <em>num1 num2</em></dt>
<dd><p>Returns bits 24 through 46 (the most significant half) of the product of
<em>num1</em> and <em>num2</em>.  If you call this and <code>%24-bit-times</code> on the
same arguments <em>num1</em> and <em>num2</em>, regarding them as integers, you
can combine the results into a double-precision product.  If <em>num1</em>
and <em>num2</em> are regarded as two&rsquo;s-complement fractions, <code>-1 <code></code>
<em>num</em> &lt; 1</code>, <code>%multiply-fractions</code> returns 1/2 of their correct
product as a fraction.  (The name of this function isn&rsquo;t too great.)
</p></dd></dl>

<a name="g_t_0025divide_002ddouble_002dfun"></a><dl>
<dt><a name="index-_0025divide_002ddouble"></a>Function: <strong>%divide-double</strong> <em>dividend[24:46] dividend[0:23] divisor</em></dt>
<dd><p>Divides the double-precision number given by the first two
arguments by the third argument, and returns the single-precision
quotient.  Causes an error if <em>divisor</em> is zero or if the quotient won&rsquo;t
fit in single precision.
</p></dd></dl>

<a name="g_t_0025remainder_002ddouble_002dfun"></a><dl>
<dt><a name="index-_0025remainder_002ddouble"></a>Function: <strong>%remainder-double</strong> <em>dividend[24:46] dividend[0:23] divisor</em></dt>
<dd><p>Divides the double-precision number given by the first two
arguments by the third argument, and returns the
remainder.  Causes an error if <em>divisor</em> is zero.
</p></dd></dl>

<a name="g_t_0025float_002ddouble_002dfun"></a><dl>
<dt><a name="index-_0025float_002ddouble"></a>Function: <strong>%float-double</strong> <em>high24 low24</em></dt>
<dd><p><em>high24</em> and <em>low24</em>, which must be fixnums, are concatenated
to produce a 48-bit unsigned positive integer.  A flonum containing the
same value is constructed and returned.  Note that only the 31 most significant
bits are retained (after removal of leading zeroes.)  This function is
mainly for the benefit of <code>read</code>.
</p></dd></dl>


<a name="g_t_0022Arrays_0022"></a>
<h2 class="chapter">8 &quot;Arrays&quot;</h2>
<a name="array"></a><a name="array_002dchapter"></a><a name="index-array"></a>

<p>An <em>array</em> is a Lisp object that consists of a group of cells,
each of which may contain an object.  The individual cells are
selected by numerical <em>subscripts</em>.
<a name="index-_0022subscript_0022"></a>
</p>
<p>The <em>rank</em> of an array (the number of dimensions
which the array has) is the number of subscripts used to
refer to one of the elements of the array.  The rank
may be any integer from zero to seven, inclusively.
</p>
<p>The lowest value for any subscript is zero; the highest value
is a property of the array.  Each dimension has a size, which is
the lowest number which is too great to be used as a subscript.
For example, in a one-dimensional array of five elements, the size
of the one and only dimension is five, and the acceptable
values of the subscript are zero, one, two, three, and four.
</p>
<p>The most basic primitive functions for handling arrays are:
<code>make-array</code>, which is used for the creation of arrays, <code>aref</code>,
which is used for examining the
contents of arrays, and <code>aset</code>, which
is used for storing into arrays.
</p>
<p>An array is a regular Lisp object, and it is common for an
array to be the binding of a symbol, or the car or cdr of a cons,
or, in fact, an element of an array.  There are many functions,
described in this chapter, which take arrays as arguments and
perform useful operations on them.
</p>
<p>Another way of handling arrays, inherited from Maclisp, is to treat them
as functions.  In this case each array has a name, which is a symbol
whose function definition is the array.  Zetalisp supports this
style by allowing an array to be <em>applied</em> to arguments, as if it were
a function.  The arguments are treated as subscripts and the array is
referenced appropriately.  The <code>store</code> special form (see <a href="#store_002dfun">store-fun</a>)
is also supported.  This kind of array referencing is considered to be
obsolete and is slower than the usual kind.  It should not be used in
new programs.
</p>
<a name="array_002dtype"></a><a name="index-types-of-arrays"></a>
<p>There are many types of arrays.  Some types of arrays can hold
Lisp objects of any type; the other types of arrays can only hold
fixnums or flonums.  The array types are known by a set of symbols whose names
begin with &quot;<code>art-</code>&quot; (for ARray Type).
</p>
<a name="index-art_002dq"></a>
<p>The most commonly used type is called <code>art-q</code>.  An <code>art-q</code>
array simply holds Lisp objects of any type.
</p>
<a name="index-art_002dq_002dlist"></a>
<a name="art_002dq_002dlist_002dvar"></a><p>Similar to the <code>art-q</code> type is the <code>art-q-list</code>.  Like the
<code>art-q</code>, its elements may be any Lisp object.  The difference is that
the <code>art-q-list</code> array &quot;doubles&quot; as a list; the function <code>g-l-p</code>
will take an <code>art-q-list</code> array and return a list whose elements are
those of the array, and whose actual substance is that of the array.  If
you <code>rplaca</code> elements of the list, the corresponding element of the
array will change, and if you store into the array, the corresponding
element of the list will change the same way.  An attempt to <code>rplacd</code>
the list will cause a <code>sys:rplacd-wrong-representation-type</code> error,
since arrays cannot implement that operation.
</p>
<a name="index-art_002d1b"></a>
<a name="index-art_002d2b"></a>
<a name="index-art_002d4b"></a>
<a name="index-art_002d8b"></a>
<a name="index-art_002d16b"></a>
<p>There is a set of types called <code>art-1b, art-2b, art-4b, art-8b</code>, 
and <code>art-16b</code>;
these names are short for &quot;1 bit&quot;, &quot;2 bits&quot;, and so on.  Each element
of an <code>art-<em>n</em>b</code> array is a non-negative fixnum, and only the
least significant <em>n</em> bits are remembered in the array; all of the others are discarded.  Thus <code>art-1b</code> arrays store only 0 and 1, and
if you store a 5 into an <code>art-2b</code> array and look at it
later, you will find a 1 rather than a 5.
	These arrays are used when it is known beforehand that the
fixnums which will be stored are non-negative and limited in size to a
certain number of bits.  Their advantage over the <code>art-q</code> array is
that they occupy less storage, because more than one element of the
array is kept in a single machine word.  (For example, 32 elements
of an <code>art-1b</code> array or 2 elements of an <code>art-16b</code> array
will fit into one word).
</p>
<a name="index-art_002d32b"></a>
<p>There are also <code>art-32b</code> arrays which have 32 bits per element.
Since fixnums only have 24 bits anyway, these are the same as <code>art-q</code>
arrays except that they only hold fixnums.  They are not compatible
with the other &quot;bit&quot; array types and generally should not be used.
</p>
<a name="index-art_002dstring"></a>
<p>Character strings are implemented by the <code>art-string</code> array
type.  This type acts similarly to the <code>art-8b</code>; its elements must be
fixnums, of which only the least significant eight bits are stored.
However, many important system functions, including <code>read</code>,
<code>print</code>, and <code>eval</code>, treat <code>art-string</code> arrays very differently
from the other kinds of arrays.  These arrays are usually called
<em>string</em>s, and chapter <a href="#string_002dchapter">string-chapter</a> of this manual deals with functions
that manipulate them.
</p>
<a name="index-art_002dfat_002dstring"></a>
<p>An <code>art-fat-string</code> array is a character string with wider characters, containing
16 bits rather than 8 bits.  The extra bits are ignored by string operations,
such as comparison, on these strings; typically they are used to hold font
information.
</p>
<a name="index-art_002dhalf_002dfix"></a>
<p>An <code>art-half-fix</code> array contains half-size fixnums.  Each element
of the array is a signed 16-bit integer; the range is from -32768 to 32767
inclusive.
</p>
<a name="index-art_002dfloat"></a>
<p>The <code>art-float</code> array type is a special-purpose type whose
elements are flonums.  When storing into such an array the value (any
kind of number) will be converted to a flonum, using the <code>float</code>
function (see <a href="#float_002dfun">float-fun</a>).  The advantage of
storing flonums in an <code>art-float</code> array rather than an <code>art-q</code>
array is that the numbers in an <code>art-float</code> array are not true Lisp
objects.  Instead the array remembers the numerical value, and when it
is <code>aref</code>&rsquo;ed creates a Lisp object (a flonum) to hold the value.
Because the system does special storage management for bignums and
flonums that are intermediate results, the use of <code>art-float</code> arrays
can save a lot of work for the garbage collector and hence greatly
increase performance.  An intermediate result is a Lisp object passed
as an argument, stored in a local variable, or returned as the value of
a function, but not stored into a special variable, a non-<code>art-float</code>
array, or list structure.  <code>art-float</code> arrays also provide a locality
of reference advantage over <code>art-q</code> arrays containing flonums, since
the flonums are contained in the array rather than being separate objects
probably on different pages of memory.
</p>
<a name="index-art_002dfps_002dfloat"></a>
<p>The <code>art-fps-float</code> array type is another special-purpose type
whose elements are flonums.  The internal format of this array is compatible
with the PDP-11/VAX single-precision floating-point format.  The primary purpose
of this array type is to interface with the FPS array processor, which can
transfer data directly in and out of such an array.
	Any type of number may be stored into an <code>art-fps-float</code>
array, but it will in effect be converted to a flonum, and then rounded
off to the 24-bit precision of the PDP-11.  If the magnitude of the
number is too large, the largest valid floating-point number will be
stored.  If the magnitude is too small, zero will be stored.
	When an element of an <code>art-fps-float</code> array is read, a new
flonum is created containing the value, just as with an <code>art-float</code>
array.
</p>
<a name="index-art_002dcomplex"></a>
<p>The <code>art-complex</code> array type is a special purpose type whose
elements are arbitrary numbers, which may be complex numbers.  (Most of
the numeric array types can only hold real numbers.)  As compared with
an ordinary <code>art-q</code> array, <code>art-complex</code> provides an advantage in
garbage collection similar to what <code>art-float</code> provides for floating
point numbers.
</p>
<a name="index-art_002dcomplex_002dfloat"></a>
<p>The <code>art-complex-float</code> array type is a special purpose type whose
elements are numbers (real or complex) whose real and imaginary parts
are both floating point numbers.  (If you store a non-floating-point
number into the array, its real and imaginary parts are converted to
floating point.)  This provides maximum advantage in garbage collection
if all the elements you wish to store in the array are numbers with
floating point real and imaginary parts.
</p>
<a name="index-art_002dcomplex_002dfps_002dfloat"></a>
<p>The <code>art-complex-fps-float</code> array type is similar to
<code>art-complex-float</code> but each real or imaginary part is stored in the
form used by the FPS array processor.  Each element occupies two words,
the first being the real part and the second being the imaginary part.
</p>
<a name="index-art_002dstack_002dgroup_002dhead"></a>
<a name="index-art_002dreg_002dpdl"></a>
<a name="index-art_002dspecial_002dpdl"></a>
<p>There are three types of arrays which exist only for the
implementation of <em>stack groups</em>; these types are called
<code>art-stack-group-head, art-special-pdl</code>, and <code>art-reg-pdl</code>.  Their elements
may be any Lisp object; their use is explained in the section on
stack groups (see <a href="#stack_002dgroup">stack-group</a>).
<a name="index-_0022stack-group_0022"></a>
</p>
<a name="array_002dtypes_002dvar"></a><dl>
<dt><a name="index-array_002dtypes-1"></a>Variable: <strong>array-types</strong></dt>
<dd><p>The value of <code>array-types</code> is a list of all of the array type symbols
such as <code>art-q</code>, <code>art-4b</code>, <code>art-string</code> and so on.  The values
of these symbols are internal array type code numbers for the corresponding
type.
</p></dd></dl>

<a name="array_002dtypes_002dfun"></a><dl>
<dt><a name="index-array_002dtypes"></a>Function: <strong>array-types</strong> <em>array-type-code</em></dt>
<dd><p>Given an internal numeric array-type code, returns the symbolic name
of that type.
</p></dd></dl>

<a name="array_002delements_002dper_002dq_002dvar"></a><dl>
<dt><a name="index-array_002delements_002dper_002dq-1"></a>Variable: <strong>array-elements-per-q</strong></dt>
<dd><p><code>array-elements-per-q</code> is an association list (see <a href="#alist">alist</a>) which
associates each array type symbol with the number of array elements
stored in one word, for an array of that type.  If the value is negative,
it is instead the number of words per array element, for arrays whose
elements are more than one word long.
</p></dd></dl>

<a name="array_002delements_002dper_002dq_002dfun"></a><dl>
<dt><a name="index-array_002delements_002dper_002dq"></a>Function: <strong>array-elements-per-q</strong> <em>array-type-code</em></dt>
<dd><p>Given the internal array-type code number, returns the number of array
elements stored in one word, for an array of that type.  If the value
is negative, it is instead the number of words per array element, for
arrays whose elements are more than one word long.
</p></dd></dl>

<a name="array_002dbits_002dper_002delement_002dvar"></a><dl>
<dt><a name="index-array_002dbits_002dper_002delement-1"></a>Variable: <strong>array-bits-per-element</strong></dt>
<dd><p>The value of <code>array-bits-per-element</code> is an association list (see <a href="#alist">alist</a>)
which associates each array type symbol with the number of
bits of unsigned number it can hold, or <code>nil</code> if it can
hold Lisp objects.  This can be used to tell whether an array
can hold Lisp objects or not.
</p></dd></dl>

<a name="array_002dbits_002dper_002delement_002dfun"></a><dl>
<dt><a name="index-array_002dbits_002dper_002delement"></a>Function: <strong>array-bits-per-element</strong> <em>array-type-code</em></dt>
<dd><p>Given the internal array-type code numbers, returns the number of bits
per cell for unsigned numeric arrays, or <code>nil</code> for a type of array
that can contain Lisp objects.
</p></dd></dl>

<a name="array_002delement_002dsize_002dfun"></a><dl>
<dt><a name="index-array_002delement_002dsize"></a>Function: <strong>array-element-size</strong> <em>array</em></dt>
<dd><p>Given an array, returns the number of bits that fit in an element of
that array.  For arrays that can hold general Lisp objects, the result is
24., assuming you will be storing unsigned fixnums in the array.
</p></dd></dl>

<a name="g_t_0022Extra-Features-of-Arrays_0022"></a>
<h3 class="section">8.1 &quot;Extra Features of Arrays&quot;</h3>
<a name="index-_0022array-leader_0022"></a>
<p>Any array may have an <em>array leader</em>.  An array leader is
like a one-dimensional <code>art-q</code> array which is attached to the main
array.  So an array which has a leader acts like two arrays joined
together.  The leader can be stored into and examined by a special set
of functions, different from those used for the main array:
<code>array-leader</code> and <code>store-array-leader</code>.  The leader is always
one-dimensional, and always can hold any kind of Lisp object,
regardless of the type or rank of the main part of the array.
</p>
<p>Very often the main part of an array will be a homogeneous set of objects,
while the leader will be used to remember a few associated non-homogeneous pieces of data.
In this case the leader is not used like an array; each slot is used
differently from the others.  Explicit numeric subscripts should not be
used for the leader elements of such an array; instead the leader should be described
by a <code>defstruct</code> (see <a href="#defstruct_002dfun">defstruct-fun</a>).
</p>
<p>By convention, element 0 of the array leader of
an array is used to hold the number of elements in the array
that are &quot;active&quot; in some sense.  When the zeroth element is used
this way, it is called a <em>fill pointer</em>.
<a name="index-_0022fill-pointer_0022"></a>
<a name="fill_002dpointer"></a>Many array-processing functions recognize the fill pointer.
For instance, if a string (an array of type <code>art-string</code>) has
seven elements, but its fill pointer contains the value five, then only elements
zero through four of the string are considered to be &quot;active&quot;; the string&rsquo;s
printed representation will be five characters long, string-searching
functions will stop after the fifth element, etc.
</p>
<a name="fill_002dpointer_002dfun"></a><dl>
<dt><a name="index-fill_002dpointer"></a>Function: <strong>fill-pointer</strong> <em>array</em></dt>
<dd><p>Returns the fill pointer of <em>array</em>, or <code>nil</code> if it does
not have one.  This function can be used with <code>setf</code> to set the
array&rsquo;s fill pointer.
</p></dd></dl>

<p>The system does not provide a way to turn off the fill-pointer
convention; any array that has a leader must reserve element 0 for the
fill pointer or avoid using many of the array functions.
</p>
<p>Leader element 1 is used in conjunction with the &quot;named
structure&quot; feature to associate a &quot;data type&quot; with the array; see
<a href="#named_002dstructure">named-structure</a>.  Element 1 is only treated specially if the array
is flagged as a named structure.
</p>
<a name="Displaced-Arrays"></a>
<h4 class="subsection">8.1.1 Displaced Arrays</h4>
<a name="index-_0022displaced-array_0022"></a>
<p>The following explanation of <em>displaced arrays</em>
is probably not of interest to a beginner; the section may
be passed over without losing the continuity of the manual.
</p>
<p>Normally, an array is represented as a small amount of header
information, followed by the contents of the array.  However, sometimes
it is desirable to have the header information removed from the actual
contents.  One such occasion is when the contents of the array must be
located in a special part of the Lisp Machine&rsquo;s address space, such as
the area used for the control of input/output devices, or the bitmap
memory which generates the TV image.  Displaced arrays are also used to
reference certain special system tables, which are at fixed addresses
so the microcode can access them easily.
</p>
<p>If you give <code>make-array</code> a fixnum or a locative
as the value of the <code>:displaced-to</code> option,
it will create a displaced array referring to that location of virtual memory
and its successors.
References to elements of the displaced array will access that part
of storage, and return the contents; the regular <code>aref</code> and
<code>aset</code> functions are used.  If the array is one whose elements
are Lisp objects, caution should be used: if the region of address
space does not contain typed Lisp objects, the integrity of the storage
system and the garbage collector could be damaged.  If the array is one
whose elements are bytes (such as an <code>art-4b</code> type), then there
is no problem.  It is important to know, in this case, that the elements
of such arrays are allocated from the right to the left within the 32-bit
words.
</p>
<a name="index-_0022indirect-array_0022"></a>
<a name="indirect_002darray"></a><p>It is also possible to have an array whose contents, instead
of being located at a fixed place in virtual memory, are defined
to be those of another array.  Such an array is called an <em>indirect array</em>,
and is created by giving <code>make-array</code> an array as
the value of the <code>:displaced-to</code> option.
The effects of this are simple if both arrays have the same type; the two
arrays share all elements.  An object stored in a certain element
of one can be retrieved from the corresponding element of the other.
This, by itself, is not very useful.  However, if the arrays have
different rank, the manner of accessing the elements differs.
Thus, creating a one-dimensional array of nine elements,
indirected to a second, two-dimensional array of three elements by three,
allows access to the elements in either a one-dimensional or
a two-dimensional manner.  Weird effects can be produced if
the new array is of a different type than the old array; this is not
generally recommended.  Indirecting an <code>art-<em>m</em>b</code> array to
an <code>art-<em>n</em>b</code> array will do the obvious thing.  For instance,
if <em>m</em> is 4 and <em>n</em> is 1, each element of the first array
will contain four bits from the second array, in right-to-left order.
</p>
<a name="index-_0022index-offset_0022"></a>
<a name="index_002doffset"></a><p>It is also possible to create an indirect array in such a way
that when an attempt is made to reference it or store into it, a
constant number is added to the subscript given.  This number is called
the <em>index-offset</em>.  It is specified at the time the indirect array
is created, by giving a fixnum to <code>make-array</code>
as the value of the <code>:displaced-index-offset</code> option.
The length of the indirect array need not be the full length of
the array it indirects to; it can be smaller.  Thus the indirect array can
cover just a subrange of the original array.
The <code>nsubstring</code> function (see <a href="#nsubstring_002dfun">nsubstring-fun</a>) creates such
arrays.  When using index offsets with multi-dimensional arrays, there
is only one index offset; it is added in to the &quot;linearized&quot; subscript
which is the result of multiplying each subscript by an appropriate
coefficient and adding them together.
</p>
<a name="g_t_0022Basic-Array-Functions_0022"></a>
<h3 class="section">8.2 &quot;Basic Array Functions&quot;</h3>

<a name="make_002darray_002dfun"></a><dl>
<dt><a name="index-make_002darray"></a>Function: <strong>make-array</strong> <em>dimensions &amp;rest options.</em></dt>
<dd><p>This is the primitive function for making arrays.  <em>dimensions</em>
should be a list of fixnums which are the dimensions of the array; the
length of the list will be the rank of the array.  For
convenience when making a one-dimensional array, the single dimension
may be provided as a fixnum rather than a list of one fixnum.
</p>
<p><em>options</em> are alternating keywords and values.  The keywords may be
any of the following:
</p><dl compact="compact">
<dt><code>:area</code></dt>
<dd><p>The value specifies in which area (see <a href="#area">area</a>) the array should be created.
It should be either an area number (a fixnum), or <code>nil</code> to mean the
default area.
</p>
</dd>
<dt><code>:type</code></dt>
<dd><p>The value should be a symbolic name of an array type; the most
common of these is <code>art-q</code>, which is the default.  The elements of the array are
initialized according to the type:  if the array is of a type whose
elements may only be fixnums or flonums, then every element of the array will
initially be <code>0</code> or <code>0.0</code>; otherwise, every element will initially be
<code>nil</code>.  See the description of array types on <a href="#array_002dtype">array-type</a>.
The value of the option may also be the value of a symbol which is an array type name
(that is, an internal numeric array type code).
<a name="index-_0022array-initialization_0022"></a>
</p>
</dd>
<dt><code>:initial-value</code></dt>
<dd><p>This specifies the value to be stored in each element of the new
array.  If it is not specified, it is <code>nil</code> for arrays that can
hold arbitrary objects, or <code>0</code> or <code>0.0</code> for numeric arrays.
</p>
</dd>
<dt><code>:displaced-to</code></dt>
<dd><p>If this is not <code>nil</code>, then the array will be a <em>displaced</em> array.
If the value is a fixnum or a locative, <code>make-array</code> will create a
regular displaced array which refers to the specified section of virtual
address space.
If the value is an array, <code>make-array</code> will create
an indirect array (see <a href="#indirect_002darray">indirect-array</a>).
<a name="index-_0022displaced-array_0022-1"></a>
<a name="index-_0022indirect-array_0022-1"></a>
</p>
</dd>
<dt><code>:leader-length</code></dt>
<dd><p>The value should be a fixnum.  The array will have a leader with that
many elements.  The elements of the leader will be initialized to <code>nil</code>
unless the <code>:leader-list</code> option is given (see below).
</p>
</dd>
<dt><code>:leader-list</code></dt>
<dd><p>The value should be a list.  Call the number of elements in the list <em>n</em>.
The first <em>n</em> elements of the leader will be initialized from successive
elements of this list.  If the <code>:leader-length</code> option is not specified,
then the length of the leader will be <em>n</em>.  If the <code>:leader-length</code>
option is given, and its value is greater than <em>n</em>, then the <em>n</em>th
and following leader elements will be initialized to <code>nil</code>.  If its value
is less than <em>n</em>, an error is signalled.  The leader elements are
filled in forward order; that is, the <code>car</code> of the list will be stored
in leader element <code>0</code>, the <code>cadr</code> in element <code>1</code>, and so on.
</p>
</dd>
<dt><code>:fill-pointer</code></dt>
<dd><p>The value should be a fixnum.  The array will have a leader with at
least one element, and this fixnum will go in that element.
</p>
<p>Using the <code>:fill-pointer</code> option is equivalent to using
<code>:leader-list</code> with a list one element long.  It avoids consing the list,
and is also compatible with Common Lisp.
</p>
</dd>
<dt><code>:displaced-index-offset</code></dt>
<dd><p>If this is present, the value of the <code>:displaced-to</code> option should be an
array, and the value should be a non-negative fixnum; it is made to be the
index-offset of the created indirect array. (See <a href="#index_002doffset">index-offset</a>.)
<a name="index-_0022index-offset_0022-1"></a>
</p>
</dd>
<dt><code>:named-structure-symbol</code></dt>
<dd><p>If this is not <code>nil</code>, it is a symbol to
be stored in the named-structure cell of the array.  The array
will be tagged as a named structure (see <a href="#named_002dstructure">named-structure</a>.)  If
the array has a leader, then this symbol will be stored in leader element
<code>1</code> regardless of the value of the <code>:leader-list</code> option.  If the array
does not have a leader, then this symbol will be stored in array element zero.
</p></dd>
</dl>

<div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp"><span class="roman">;; Create a one-dimensional array of five elements.</span>
(make-array 5)
<span class="roman">;; Create a two-dimensional array,</span>
<span class="roman">;; three by four, with four-bit elements.</span>
(make-array '(3 4) ':type 'art-4b)
<span class="roman">;; Create an array with a three-element leader.</span>
(make-array 5 ':leader-length 3)
<span class="roman">;; Create an array containing 5 <code>t</code>&rsquo;s,</span>
<span class="roman">;; and a fill pointer saying the array is full.</span>
(make-array 5 ':initial-value t ':fill-pointer 5)
<span class="roman">;; Create a named-structure with five leader</span>
<span class="roman">;; elements, initializing some of them.</span>
(setq b (make-array 20 ':leader-length 5 
		       ':leader-list '(0 nil foo)
		       ':named-structure-symbol 'bar))
(array-leader b 0) =&gt; 0
(array-leader b 1) =&gt; bar
(array-leader b 2) =&gt; foo
(array-leader b 3) =&gt; nil
(array-leader b 4) =&gt; nil
<a name="index-_0022array-leader_0022-1"></a></pre></div>

<p><code>make-array</code> returns the newly-created array, and also
returns, as a second value, the number of words allocated in the process
of creating the array, i.e the <code>%structure-total-size</code> of the array.
</p>
<p>When <code>make-array</code> was originally implemented, it took its arguments
in the following fixed pattern:
</p><div class="lisp">
<pre class="lisp">   (make-array <em>area</em> <em>type</em> <em>dimensions</em>
               &amp;optional <em>displaced-to</em> <em>leader</em>
			 <em>displaced-index-offset</em>
			 <em>named-structure-symbol</em>)
</pre></div>
<p><em>leader</em> was a combination of the <code>:leader-length</code> and <code>:leader-list</code>
options, and the list was in reverse order.
This obsolete form is still supported so that old programs will continue
to work, but the new keyword-argument form is preferred.
</p></dd></dl>

<a name="aref_002dfun"></a><dl>
<dt><a name="index-aref"></a>Function: <strong>aref</strong> <em>array &amp;rest subscripts</em></dt>
<dd><p>Returns the element of <em>array</em> selected by the <em>subscripts</em>.
The <em>subscripts</em> must be fixnums and their number must match the
rank of <em>array</em>.
</p></dd></dl>

<a name="ar_002d1_002dfun"></a><dl>
<dt><a name="index-ar_002d1"></a>Function: <strong>ar-1</strong> <em>array i</em></dt>
<dd><a name="ar_002d2_002dfun"></a></dd><dt><a name="index-ar_002d2"></a>Function: <strong>ar-2</strong> <em>array i j</em></dt>
<dd><a name="ar_002d3_002dfun"></a></dd><dt><a name="index-ar_002d3"></a>Function: <strong>ar-3</strong> <em>array i j k</em></dt>
<dd><p>These are obsolete versions of <code>aref</code> that only work for one-, two-,
or three-dimensional arrays, respectively.  There is no reason ever to
use them.
</p></dd></dl>

<a name="aset_002dfun"></a><dl>
<dt><a name="index-aset"></a>Function: <strong>aset</strong> <em>x array &amp;rest subscripts</em></dt>
<dd><p>Stores <em>x</em> into the element of <em>array</em> selected by the <em>subscripts</em>.
The <em>subscripts</em> must be fixnums and their number must match the
rank of <em>array</em>.  The returned value is <em>x</em>.
</p></dd></dl>

<a name="as_002d1_002dfun"></a><dl>
<dt><a name="index-as_002d1"></a>Function: <strong>as-1</strong> <em>x array i</em></dt>
<dd><a name="as_002d2_002dfun"></a></dd><dt><a name="index-as_002d2"></a>Function: <strong>as-2</strong> <em>x array i j</em></dt>
<dd><a name="as_002d3_002dfun"></a></dd><dt><a name="index-as_002d3"></a>Function: <strong>as-3</strong> <em>x array i j k</em></dt>
<dd><p>These are obsolete versions of <code>aset</code> that only work for one-, two-,
or three-dimensional arrays, respectively.  There is no reason ever to
use them.
</p></dd></dl>

<a name="aloc_002dfun"></a><dl>
<dt><a name="index-aloc"></a>Function: <strong>aloc</strong> <em>array &amp;rest subscripts</em></dt>
<dd><p>Returns a locative pointer to the element-cell of <em>array</em> selected by
the <em>subscripts</em>.  The <em>subscripts</em> must be fixnums and their
number must match the rank of <em>array</em>.
See the explanation of locatives in <a href="#locative">locative</a>.
</p></dd></dl>

<a name="ap_002d1_002dfun"></a><dl>
<dt><a name="index-ap_002d1"></a>Function: <strong>ap-1</strong> <em>array i</em></dt>
<dd><a name="ap_002d2_002dfun"></a></dd><dt><a name="index-ap_002d2"></a>Function: <strong>ap-2</strong> <em>array i j</em></dt>
<dd><a name="ap_002d3_002dfun"></a></dd><dt><a name="index-ap_002d3"></a>Function: <strong>ap-3</strong> <em>array i j k</em></dt>
<dd><p>These are obsolete versions of <code>aloc</code> that only work for one-, two-,
or three-dimensional arrays, respectively.  There is no reason ever to
use them.
</p></dd></dl>

<p>The compiler turns <code>aref</code> into <code>ar-1</code>, <code>ar-2</code>, etc according to
the number of subscripts specified, turns <code>aset</code> into <code>as-1</code>,
<code>as-2</code>, etc., and turns <code>aloc</code> into <code>ap-1</code>, <code>ap-2</code>, etc.  For
arrays with more than three dimensions the compiler uses the slightly
less efficient form since the special routines only exist for one, two
and three dimensions.  There is no reason for any program to call
<code>ar-1</code>, <code>as-1</code>, <code>ar-2</code>, etc  explicitly; they are documented
because there used to be such a reason, and many old programs use these
functions.  New programs should use <code>aref</code>, <code>aset</code>, and <code>aloc</code>.
</p>
<p>A related function, provided only for Maclisp compatibility, is
<code>arraycall</code> (<a href="#arraycall_002dfun">arraycall-fun</a>).
</p>
<a name="ar_002d1_002dforce_002dfun"></a><dl>
<dt><a name="index-ar_002d1_002dforce"></a>Function: <strong>ar-1-force</strong> <em>array i</em></dt>
<dd><a name="as_002d1_002dforce_002dfun"></a></dd><dt><a name="index-as_002d1_002dforce"></a>Function: <strong>as-1-force</strong> <em>value array i</em></dt>
<dd><a name="ap_002d1_002dforce_002dfun"></a></dd><dt><a name="index-ap_002d1_002dforce"></a>Function: <strong>ap-1-force</strong> <em>array i</em></dt>
<dd><p>These functions access an array with a single subscript regardless of
how many dimensions the array has.  They may be useful for manipulating
arrays of varying rank, as an alternative to maintaining and updating
lists of subscripts or to creating one-dimensional indirect arrays.
</p>
<p>In using these functions, you must pay attention to the order in which
the array elements are actually stored.  See
<a href="#array_002delement_002dorder_002dsection">array-element-order-section</a>.
</p></dd></dl>

<a name="array_002dleader_002dfun"></a><dl>
<dt><a name="index-array_002dleader"></a>Function: <strong>array-leader</strong> <em>array i</em></dt>
<dd><p><em>array</em> should be an array with a leader, and <em>i</em> should be a
fixnum.  This returns the <em>i</em>th element of <em>array</em>&rsquo;s leader.
This is analogous to <code>aref</code>.
</p></dd></dl>

<a name="store_002darray_002dleader_002dfun"></a><dl>
<dt><a name="index-store_002darray_002dleader"></a>Function: <strong>store-array-leader</strong> <em>x array i</em></dt>
<dd><p><em>array</em> should be an array with a leader, and <em>i</em> should be a
fixnum.  <em>x</em> may be any object.  <em>x</em> is stored in the <em>i</em>th element
of <em>array</em>&rsquo;s leader.  <code>store-array-leader</code> returns <em>x</em>.
This is analogous to <code>aset</code>.
</p></dd></dl>

<a name="ap_002dleader_002dfun"></a><dl>
<dt><a name="index-ap_002dleader"></a>Function: <strong>ap-leader</strong> <em>array i</em></dt>
<dd><p><em>array</em> should be an array with a leader, and <em>i</em> should be a
fixnum.  This returns a locative pointer to the <em>i</em>th element of
<em>array</em>&rsquo;s leader.  See the explanation of locatives, <a href="#locative">locative</a>.
This is analogous to <code>aloc</code>.
</p></dd></dl>

<p>Here are the conditions signaled for various errors in accessing arrays.
</p>
<dl>
<dt><a name="index-_0028sys_003abad_002darray_002dmixin-error_0029-on-sys_003aarray_002dhas_002dno_002dleader"></a>Condition on sys:array-has-no-leader: <strong>(<code>sys:bad-array-mixin</code> <code>error</code>)</strong></dt>
<dd><p>This is signaled on a reference to the leader of an array that doesn&rsquo;t
have one.  The condition instance supports the <code>:array</code> operation,
which returns the array that was used.
</p>
<p>The <code>:new-array</code> proceed-type is provided.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003abad_002darray_002dmixin-on-"></a>Flavor Condition on : <strong>sys:bad-array-mixin</strong></dt>
<dd><p>This mixin is used in the conditions signaled by several kinds of
problems pertaining to arrays.  It defines prompting for the
<code>:new-array</code> proceed type.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003abad_002darray_002dmixin-error_0029-on-sys_003aarray_002dwrong_002dnumber_002dof_002ddimensions"></a>Condition on sys:array-wrong-number-of-dimensions: <strong>(<code>sys:bad-array-mixin</code> <code>error</code>)</strong></dt>
<dd><p>This is signaled when an array is referenced (either reading or writing)
with the wrong number of subscripts; for example, <code>(aref &quot;foo&quot; 1 2)</code>.
</p>
<p>The <code>:array</code> operation on the condition instance returns the array
that was used.  The <code>:subscripts-used</code> operation returns the
list of subscripts used.
</p>
<p>The <code>:new-array</code> proceed type is provided.  It expects one argument,
an array to use instead of the original one.
</p></dd></dl>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003asubscript_002dout_002dof_002dbounds"></a>Condition on sys:subscript-out-of-bounds: <strong>(<code>error</code>)</strong></dt>
<dd><p>This is signaled when there are the right number of subscripts but their
values specify an element that falls outside the bounds of the array.
The same condition is used by <code>sys:%instance-ref</code>, etc., when the
index is out of bounds in the instance.
</p>
<p>The condition instance supports the operations <code>:object</code> and
<code>:subscripts-used</code>, which return the array or instance and the list of
subscripts.
</p>
<p>The <code>:new-subscript</code> proceed type is provided.  It takes an
appropriate number of subscripts as arguments.  You should provide as
many subscripts as there originally were.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003abad_002darray_002dmixin-error_0029-on-sys_003anumber_002darray_002dnot_002dallowed"></a>Condition on sys:number-array-not-allowed: <strong>(<code>sys:bad-array-mixin</code> <code>error</code>)</strong></dt>
<dd><p>This is signaled by an attempt to use <code>aloc</code> on a numeric array.
The <code>:array</code> operation and the <code>:new-array</code> proceed type are available.
</p></dd></dl>

<a name="Getting-Information-About-an-Array"></a>
<h3 class="section">8.3 Getting Information About an Array</h3>

<a name="array_002dtype_002dfun"></a><dl>
<dt><a name="index-array_002dtype"></a>Function: <strong>array-type</strong> <em>array</em></dt>
<dd><p>Returns the symbolic type of <em>array</em>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq a (make-array '(3 5)))
(array-type a) =&gt; art-q
</pre></div>
</dd></dl>

<a name="array_002dlength_002dfun"></a><dl>
<dt><a name="index-array_002dlength"></a>Function: <strong>array-length</strong> <em>array</em></dt>
<dd><p><em>array</em> may be any array.  This returns the total number
of elements in <em>array</em>.  For a one-dimensional array,
this is one greater than the maximum allowable subscript.
(But if fill pointers are being used, you may want to use
<code>array-active-length</code>.)
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(array-length (make-array 3)) =&gt; 3
(array-length (make-array '(3 5)))
		=&gt; 17  <span class="roman">;octal, which is 15. decimal</span>
</pre></div>
</dd></dl>

<a name="array_002dactive_002dlength_002dfun"></a><dl>
<dt><a name="index-array_002dactive_002dlength"></a>Function: <strong>array-active-length</strong> <em>array</em></dt>
<dd><p>If <em>array</em> does not have a fill pointer, then this returns whatever
<code>(array-length <em>array</em>)</code> would have.  If <em>array</em> does have a
fill pointer, <code>array-active-length</code> returns it.  See the general
explanation of the use of fill pointers on <a href="#fill_002dpointer">fill-pointer</a>.
</p></dd></dl>

<a name="array_002drank_002dfun"></a><dl>
<dt><a name="index-array_002drank"></a>Function: <strong>array-rank</strong> <em>array</em></dt>
<dd><p>Returns the number of dimensions of <em>array</em>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(array-rank (make-array '(3 5))) =&gt; 2
</pre></div>
</dd></dl>

<a name="array_002ddimension_002dfun"></a><dl>
<dt><a name="index-array_002ddimension"></a>Function: <strong>array-dimension</strong> <em>array n</em></dt>
<dd><p>Returns the length of dimension <em>n</em> of <em>array</em>, or <code>nil</code> if <em>n</em>
is negative or not less than the rank of <em>array</em>.
</p><div class="lisp">
<pre class="lisp">(setq a (make-array '(2 3)))
(array-dimension a 0) =&gt; 2
(array-dimension a 1) =&gt; 3
</pre></div>
</dd></dl>

<a name="array_002ddimension_002dn_002dfun"></a><dl>
<dt><a name="index-array_002ddimension_002dn"></a>Function: <strong>array-dimension-n</strong> <em>n array</em></dt>
<dd><p><em>array</em> may be any kind of array, and <em>n</em> should be a fixnum.
If <em>n</em> is between 1 and the rank of <em>array</em>,
this returns the <em>n</em>th dimension of <em>array</em>.  If <em>n</em> is <code>0</code>,
this returns the length of the leader of <em>array</em>; if <em>array</em> has no
leader it returns <code>nil</code>.  If <em>n</em> is any other value, this
returns <code>nil</code>.
</p>
<p>This function is obsolete.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(setq a (make-array '(3 5) ':leader-length 7))
(array-dimension-n 1 a) =&gt; 3
(array-dimension-n 2 a) =&gt; 5
(array-dimension-n 3 a) =&gt; nil
(array-dimension-n 0 a) =&gt; 7
</pre></div>
</dd></dl>

<a name="array_002ddimensions_002dfun"></a><dl>
<dt><a name="index-array_002ddimensions"></a>Function: <strong>array-dimensions</strong> <em>array</em></dt>
<dd><p><code>array-dimensions</code> returns a list whose elements are the dimensions
of <em>array</em>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq a (make-array '(3 5)))
(array-dimensions a) =&gt; (3 5)
</pre></div>
<p>Note: the list returned by <code>(array-dimensions <em>x</em>)</code> is
equal to the cdr of the list returned by <code>(arraydims <em>x</em>)</code>.
</p></dd></dl>

<a name="arraydims_002dfun"></a><dl>
<dt><a name="index-arraydims"></a>Function: <strong>arraydims</strong> <em>array</em></dt>
<dd><p><em>array</em> may be any array; it also may be a symbol whose
function cell contains an array, for Maclisp compatibility (see <a href="#maclisp_002darray">maclisp-array</a>).
<code>arraydims</code> returns a list whose first element is the symbolic name of
the type of <em>array</em>, and whose remaining elements are its dimensions.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq a (make-array '(3 5)))
(arraydims a) =&gt; (art-q 3 5)
</pre></div>
</dd></dl>

<a name="array_002din_002dbounds_002dp_002dfun"></a><dl>
<dt><a name="index-array_002din_002dbounds_002dp"></a>Function: <strong>array-in-bounds-p</strong> <em>array &amp;rest subscripts</em></dt>
<dd><p>This function checks whether <em>subscripts</em> is a legal
set of subscripts for <em>array</em>, and returns <code>t</code> if they
are; otherwise it returns <code>nil</code>.
</p></dd></dl>

<a name="array_002ddisplaced_002dp_002dfun"></a><dl>
<dt><a name="index-array_002ddisplaced_002dp"></a>Function: <strong>array-displaced-p</strong> <em>array</em></dt>
<dd><p><em>array</em> may be any kind of array.
This predicate returns <code>t</code> if <em>array</em> is any kind of displaced array
(including an indirect array).  Otherwise it returns <code>nil</code>.
</p></dd></dl>

<a name="array_002dindirect_002dp_002dfun"></a><dl>
<dt><a name="index-array_002dindirect_002dp"></a>Function: <strong>array-indirect-p</strong> <em>array</em></dt>
<dd><p><em>array</em> may be any kind of array.
This predicate returns <code>t</code> if <em>array</em> is an indirect array.
Otherwise it returns <code>nil</code>.
</p></dd></dl>

<a name="array_002dindexed_002dp_002dfun"></a><dl>
<dt><a name="index-array_002dindexed_002dp"></a>Function: <strong>array-indexed-p</strong> <em>array</em></dt>
<dd><p><em>array</em> may be any kind of array.
This predicate returns <code>t</code> if <em>array</em> is an indirect array with an index-offset.
Otherwise it returns <code>nil</code>.
</p></dd></dl>

<a name="array_002dindex_002doffset_002dfun"></a><dl>
<dt><a name="index-array_002dindex_002doffset"></a>Function: <strong>array-index-offset</strong> <em>array</em></dt>
<dd><p><em>array</em> may be any kind of array.
This returns the index offset of <em>array</em> if it is an indirect
array which has an index offset.  Otherwise it returns <code>nil</code>.
</p></dd></dl>

<a name="array_002dhas_002dleader_002dp_002dfun"></a><dl>
<dt><a name="index-array_002dhas_002dleader_002dp"></a>Function: <strong>array-has-leader-p</strong> <em>array</em></dt>
<dd><p><em>array</em> may be any array.  This predicate returns <code>t</code> if <em>array</em>
has a leader; otherwise it returns <code>nil</code>.
</p></dd></dl>

<a name="array_002dleader_002dlength_002dfun"></a><dl>
<dt><a name="index-array_002dleader_002dlength"></a>Function: <strong>array-leader-length</strong> <em>array</em></dt>
<dd><p><em>array</em> may be any array.  This returns the length of <em>array</em>&rsquo;s leader
if it has one, or <code>nil</code> if it does not.
</p></dd></dl>


<a name="Changing-the-Size-of-an-Array"></a>
<h3 class="section">8.4 Changing the Size of an Array</h3>

<a name="adjust_002darray_002dsize_002dfun"></a><dl>
<dt><a name="index-adjust_002darray_002dsize"></a>Function: <strong>adjust-array-size</strong> <em>array new-size</em></dt>
<dd><p>If <em>array</em> is a one-dimensional array, its size is
changed to be <em>new-size</em>.  If <em>array</em> has more than one
dimension, its size (<code>array-length</code>) is changed to <em>new-size</em>
by changing only the last dimension.
</p>
<p>If <em>array</em> is made smaller, the extra elements are lost; if <em>array</em>
is made bigger, the new elements are initialized in the same fashion as
<code>make-array</code> (see <a href="#make_002darray_002dfun">make-array-fun</a>) would initialize them: either to <code>nil</code> or <code>0</code>,
depending on the type of array.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq a (make-array 5))
(aset 'foo a 4)
(aref a 4) =&gt; foo
(adjust-array-size a 2)
(aref a 4) =&gt; <span class="roman">an error occurs</span>
</pre></div>
<p>If the size of the array is being increased,
<code>adjust-array-size</code> may have to allocate a new array somewhere.  In
that case, it alters <em>array</em> so that references to it will be made to
the new array instead, by means of &quot;invisible pointers&quot; (see
<code>structure-forward</code>, <a href="#structure_002dforward_002dfun">structure-forward-fun</a>).
<code>adjust-array-size</code> will return this new array if it creates one, and
otherwise it will return <em>array</em>.  Be careful to be consistent about
using the returned result of <code>adjust-array-size</code>, because you may end
up holding two arrays which are not the same (i.e not <code>eq</code>), but
which share the same contents.
</p></dd></dl>

<a name="array_002dgrow_002dfun"></a><dl>
<dt><a name="index-array_002dgrow"></a>Function: <strong>array-grow</strong> <em>array &amp;rest dimensions</em></dt>
<dd><p><code>array-grow</code> creates a new array of the same type as <em>array</em>,
with the specified dimensions.  Those elements of <em>array</em> that
are still in bounds are copied into the new array.  The elements of
the new array that are not in the bounds of <em>array</em> are initialized
to <code>nil</code> or <code>0</code> as appropriate.  If <em>array</em> has a leader, the new
array will have a copy of it.  <code>array-grow</code> returns the new array
and also forwards <em>array</em> to it, like <code>adjust-array-size</code>.
</p>
<p>Unlike <code>adjust-array-size</code>, <code>array-grow</code> always creates a new array
rather than growing or shrinking the array in place.  But <code>array-grow</code>
of a multi-dimensional array can change all the subscripts and move
the elements around in memory to keep each element at the same logical
place in the array.
</p></dd></dl>

<a name="si_003achange_002dindirect_002darray_002dfun"></a><dl>
<dt><a name="index-si_003achange_002dindirect_002darray"></a>Function: <strong>si:change-indirect-array</strong> <em>array type dimlist displaced-p index-offset</em></dt>
<dd><p>Change an indirect array <em>array</em>&rsquo;s type, size, or target pointed at.
<em>type</em> specifies the new array type, <em>dimlist</em> its new dimensions,
<em>displaced-p</em> the target it should point to (an array, locative or fixnum),
and <em>index-offset</em> the new offset in the new target.
</p>
<p><em>array</em> is returned.
</p></dd></dl>

<a name="Arrays-Overlaid-With-Lists"></a>
<h3 class="section">8.5 Arrays Overlaid With Lists</h3>

<p>These functions manipulate <code>art-q-list</code> arrays, which were
introduced on <a href="#art_002dq_002dlist_002dvar">art-q-list-var</a>.
</p>
<a name="g_002dl_002dp_002dfun"></a><dl>
<dt><a name="index-g_002dl_002dp"></a>Function: <strong>g-l-p</strong> <em>array</em></dt>
<dd><p><em>array</em> should be an <code>art-q-list</code> array.  This returns
a list which shares the storage of <em>array</em>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq a (make-array 4 ':type 'art-q-list))
(aref a 0) =&gt; nil
(setq b (g-l-p a)) =&gt; (nil nil nil nil)
(rplaca b t)
b =&gt; (t nil nil nil)
(aref a 0) =&gt; t
(aset 30 a 2)
b =&gt; (t nil 30 nil)
</pre></div>
</dd></dl>

<p>The following two functions work strangely, in the same way that <code>store</code>
does, and should not be used in new programs.
</p>
<a name="get_002dlist_002dpointer_002dinto_002darray_002dfun"></a><dl>
<dt><a name="index-get_002dlist_002dpointer_002dinto_002darray"></a>Function: <strong>get-list-pointer-into-array</strong> <em>array-ref</em></dt>
<dd><p>The argument <em>array-ref</em> is ignored, but should be a reference
to an <code>art-q-list</code> array by applying the array to subscripts (rather
than by <code>aref</code>).  This returns a list object which
is a portion of the &quot;list&quot; of the array, beginning with the last
element of the last array which has been called as a function.
</p></dd></dl>

<a name="get_002dlocative_002dpointer_002dinto_002darray_002dfun"></a><dl>
<dt><a name="index-get_002dlocative_002dpointer_002dinto_002darray"></a>Function: <strong>get-locative-pointer-into-array</strong> <em>array-ref</em></dt>
<dd><p><code>get-locative-pointer-into-array</code> is
similar to <code>get-list-pointer-into-array</code>, except that it returns a
locative, and doesn&rsquo;t require the array to be <code>art-q-list</code>.
Use <code>aloc</code> instead of this function in new programs.
</p></dd></dl>

<a name="Adding-to-the-End-of-an-Array"></a>
<h3 class="section">8.6 Adding to the End of an Array</h3>

<a name="array_002dpush_002dfun"></a><dl>
<dt><a name="index-array_002dpush"></a>Function: <strong>array-push</strong> <em>array x</em></dt>
<dd><p><em>array</em> must be a one-dimensional array which has a fill pointer and <em>x</em> may
be any object.  <code>array-push</code> attempts to store <em>x</em> in the element
of the array designated by the fill pointer, and increase the fill pointer
by one.  If the fill pointer does not designate an element of the array (specifically,
when it gets too big), it is unaffected and <code>array-push</code> returns <code>nil</code>;
otherwise, the two actions (storing and incrementing) happen uninterruptibly,
and <code>array-push</code> returns the <em>former</em> value of the fill pointer,
i.e the array index in which it stored <em>x</em>.  If the array is of type
<code>art-q-list</code>, an operation similar to <code>nconc</code> has taken place,
in that the element has been added to the list by changing the cdr of
the formerly last element.  The cdr coding is updated to ensure this.
</p></dd></dl>

<a name="array_002dpush_002dextend_002dfun"></a><dl>
<dt><a name="index-array_002dpush_002dextend"></a>Function: <strong>array-push-extend</strong> <em>array x &amp;optional extension</em></dt>
<dd><p><code>array-push-extend</code> is just like <code>array-push</code> except
that if the fill pointer gets too large, the array is grown
to fit the new element; i.e it never &quot;fails&quot; the way <code>array-push</code> does,
and so never returns <code>nil</code>.  <em>extension</em> is the number of
elements to be added to the array if it needs to be grown.  It defaults
to something reasonable, based on the size of the array.
</p></dd></dl>

<a name="array_002dpop_002dfun"></a><dl>
<dt><a name="index-array_002dpop"></a>Function: <strong>array-pop</strong> <em>array</em></dt>
<dd><p><em>array</em> must be a one-dimensional array which has a fill pointer.
The fill pointer is decreased by one and the array element
designated by the new value of the fill pointer is returned.
If the new value does not designate any element of the array
(specifically, if it had already reached zero), an error is caused.
The two operations (decrementing and array referencing) happen
uninterruptibly.  If the array is of type <code>art-q-list</code>, an operation
similar to <code>nbutlast</code> has taken place.  The cdr coding is
updated to ensure this.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003abad_002darray_002dmixin-error_0029-on-sys_003afill_002dpointer_002dnot_002dfixnum"></a>Condition on sys:fill-pointer-not-fixnum: <strong>(<code>sys:bad-array-mixin</code> <code>error</code>)</strong></dt>
<dd><p>This is signaled when one of the functions in this section is used with
an array whose leader element zero is not a fixnum.  Most other array
accessing operations will simply assume that the array has no fill
pointer in such a case, but these cannot be performed without a fill
pointer.
</p>
<p>The <code>:array</code> operation on the condition instance returns the array
that was used.  The <code>:new-array</code> proceed type is supported, with one
argument, an array.
</p></dd></dl>

<a name="Copying-an-Array"></a>
<h3 class="section">8.7 Copying an Array</h3>

<a name="array_002dinitialize_002dfun"></a><dl>
<dt><a name="index-array_002dinitialize"></a>Function: <strong>array-initialize</strong> <em>array value &amp;optional start end</em></dt>
<dd><p>Stores <em>value</em> into all or part of <em>array</em>.
<em>start</em> and <em>end</em> are optional indices which delimit the
part of <em>array</em> to be initialized.  They default to the beginning
and end of the array.
</p>
<p>This function is by far the fastest way to do the job.
</p></dd></dl>

<a name="fillarray_002dfun"></a><dl>
<dt><a name="index-fillarray"></a>Function: <strong>fillarray</strong> <em>array x</em></dt>
<dd><p><em>array</em> may be any type of array, or, for Maclisp
compatibility, a symbol whose function cell contains an array.  It can
also be <code>nil</code>, in which case an array of type <code>art-q</code> is created.
There are two forms of this function, depending on the type of <em>x</em>.
	If <em>x</em> is a list, then <code>fillarray</code> fills up <em>array</em> with
the elements of <em>list</em>.  If <em>x</em> is too short to fill up all of
<em>array</em>, then the last element of <em>x</em> is used to fill the
remaining elements of <em>array</em>.  If <em>x</em> is too long, the extra
elements are ignored.  If <em>x</em> is <code>nil</code> (the empty list), <em>array</em>
is filled with the default initial value for its array type (<code>nil</code> or <code>0</code>).
	If <em>x</em> is an array (or, for Maclisp compatibility, a symbol
whose function cell contains an array), then the elements of <em>array</em> are
filled up from the elements of <em>x</em>.  If <em>x</em> is too small, then
the extra elements of <em>array</em> are not affected.
	If <em>array</em> is multi-dimensional, the elements are accessed
in row-major order: the last subscript varies the most quickly.
The same is true of <em>x</em> if it is an array.
	<code>fillarray</code> returns <em>array</em>; or, if <em>array</em> was
<code>nil</code>, the newly created array.
</p></dd></dl>

<a name="listarray_002dfun"></a><dl>
<dt><a name="index-listarray"></a>Function: <strong>listarray</strong> <em>array &amp;optional limit</em></dt>
<dd><p><em>array</em> may be any type of array or, for Maclisp
compatibility, a symbol whose function cell contains an array.  
<code>listarray</code> creates and returns a list whose elements are those of
<em>array</em>.  If <em>limit</em> is present, it should be a fixnum, and only
the first <em>limit</em> (if there are more than that many) elements of
<em>array</em> are used, and so the maximum length of the returned list is
<em>limit</em>. 
	If <em>array</em> is multi-dimensional, the elements are accessed
in row-major order: the last subscript varies the most quickly.
</p></dd></dl>

<a name="list_002darray_002dleader_002dfun"></a><dl>
<dt><a name="index-list_002darray_002dleader"></a>Function: <strong>list-array-leader</strong> <em>array &amp;optional limit</em></dt>
<dd><p><em>array</em> may be any type of array, or, for Maclisp
compatibility, a symbol whose function cell contains an array.  
<code>list-array-leader</code> creates and returns a list whose elements are those of
<em>array</em>&rsquo;s leader.  If <em>limit</em> is present, it should be a fixnum, and only
the first <em>limit</em> (if there are more than that many) elements of
<em>array</em>&rsquo;s leader are used, and so the maximum length of the returned list is
<em>limit</em>. If <em>array</em> has no leader, <code>nil</code> is returned.
</p></dd></dl>

<a name="copy_002darray_002dcontents_002dfun"></a><dl>
<dt><a name="index-copy_002darray_002dcontents"></a>Function: <strong>copy-array-contents</strong> <em>from to</em></dt>
<dd><p><em>from</em> and <em>to</em> must be arrays.  The contents of <em>from</em>
is copied into the contents of <em>to</em>, element by element.
If <em>to</em> is shorter than <em>from</em>,
the rest of <em>from</em> is ignored.  If <em>from</em> is shorter than
<em>to</em>, the rest of <em>to</em> is filled with <code>nil</code> if it
is a q-type array, or 0 if it is a numeric array or a string,
or 0.0 if it is a flonum array.
This function always returns <code>t</code>.
</p>
<p>Note that even if <em>from</em> or <em>to</em> has a leader, the whole array
is used; the convention that leader element 0 is the &quot;active&quot; length
of the array is not used by this function.  The leader itself is not
copied.
</p>
<p><code>copy-array-contents</code> works on multi-dimensional arrays.  <em>from</em> and
<em>to</em> are &quot;linearized&quot; subscripts, and elements are taken in the order
they are stored in memory.  See <code>array-index-order</code>,
<a href="#array_002dindex_002dorder_002dvar">array-index-order-var</a>.
</p></dd></dl>

<a name="copy_002darray_002dcontents_002dand_002dleader_002dfun"></a><dl>
<dt><a name="index-copy_002darray_002dcontents_002dand_002dleader"></a>Function: <strong>copy-array-contents-and-leader</strong> <em>from to</em></dt>
<dd><p>This is just like <code>copy-array-contents</code>, but the leader of <em>from</em>
(if any) is also copied into <em>to</em>.  <code>copy-array-contents</code> copies only
the main part of the array.
</p></dd></dl>

<a name="copy_002darray_002dportion_002dfun"></a><dl>
<dt><a name="index-copy_002darray_002dportion"></a>Function: <strong>copy-array-portion</strong> <em>from-array from-start from-end to-array to-start to-end</em></dt>
<dd><p>The portion of the array <em>from-array</em> with indices greater than or
equal to <em>from-start</em> and less than <em>from-end</em> is copied into
the portion of the array <em>to-array</em> with indices greater than or
equal to <em>to-start</em> and less than <em>to-end</em>, element by element.
If there are more elements in the selected portion of <em>to-array</em>
than in the selected portion of <em>from-array</em>, the extra elements
are filled with the default value as by <code>copy-array-contents</code>.
If there are more elements in the selected portion of <em>from-array</em>,
the extra ones are ignored.  Multi-dimensional arrays are treated
the same way as <code>copy-array-contents</code> treats them.
This function always returns <code>t</code>.
</p></dd></dl>

<a name="bitblt_002dfun"></a><dl>
<dt><a name="index-bitblt"></a>Function: <strong>bitblt</strong> <em>alu width height from-array from-x from-y to-array to-x to-y</em></dt>
<dd><p><em>from-array</em> and <em>to-array</em> must be two-dimensional arrays
of bits or bytes (<code>art-1b</code>, <code>art-2b</code>, <code>art-4b</code>, <code>art-8b</code>,
<code>art-16b</code>, or <code>art-32b</code>).  <code>bitblt</code> copies a rectangular portion of <em>from-array</em>
into a rectangular portion of <em>to-array</em>.  The value stored
can be a Boolean function of the new value and the value already there,
under the control of <em>alu</em> (see below).  This function is most commonly used
in connection with raster images for TV displays.
</p>
<p>The top-left corner of the source rectangle is <code>(ar-2-reverse
<em>from-array</em> <em>from-x</em> <em>from-y</em>)</code>.  The top-left corner of the
destination rectangle is <code>(ar-2-reverse <em>to-array</em> <em>to-x</em>
<em>to-y</em>)</code>.  <em>width</em> and <em>height</em> are the dimensions of both
rectangles.  If <em>width</em> or <em>height</em> is zero, <code>bitblt</code> does
nothing.  The <em>x</em> coordinates and <em>width</em> may be used as the first
or the second dimension of the array, according to <code>array-index-order</code>.
The choice is made so that <em>x</em> will come out as horizontal on the TV screen.
See <a href="#array_002dindex_002dorder_002dvar">array-index-order-var</a>.
</p>
<p><em>from-array</em> and <em>to-array</em> are allowed to be the same array.
<code>bitblt</code> normally traverses the arrays in increasing order of <em>x</em>
and <em>y</em> subscripts.  If <em>width</em> is negative, then <code>(abs <em>width</em>)</code>
is used as the width, but the processing of the <em>x</em> direction is done
backwards, starting with the highest value of <em>x</em> and working down.
If <em>height</em> is negative it is treated analogously.  When
<code>bitblt</code>&rsquo;ing an array to itself, when the two rectangles overlap, it
may be necessary to work backwards to achieve effects such
as shifting the entire array downwards by a certain number of rows.  Note
that negativity of <em>width</em> or <em>height</em> does not affect the
<em>(x,y)</em> coordinates specified by the arguments, which are still the
top-left corner even if <code>bitblt</code> starts at some other corner.
</p>
<p>If the two arrays are of different types, <code>bitblt</code> works bit-wise
and not element-wise.  That is, if you <code>bitblt</code> from an <code>art-2b</code>
array into an <code>art-4b</code> array, then two elements of the <em>from-array</em>
will correspond to one element of the <em>to-array</em>.
</p>
<p>If <code>bitblt</code> goes outside the bounds of the source array, it wraps
around.  This allows such operations as the replication of a small
stipple pattern through a large array.  If <code>bitblt</code> goes outside
the bounds of the destination array, it signals an error.
</p>
<p>If <em>src</em> is an element of the source rectangle, and <em>dst</em>
is the corresponding element of the destination rectangle, then
<code>bitblt</code> changes the value of <em>dst</em> to
<code>(boole <em>alu</em> <em>src</em> <em>dst</em>)</code>.  See the <code>boole</code>
function (<a href="#boole_002dfun">boole-fun</a>).  There are symbolic names for some of the
most useful <em>alu</em> functions; they are <code>tv:alu-seta</code> (plain
copy), <code>tv:alu-ior</code> (inclusive or), <code>tv:alu-xor</code> (exclusive
or), and <code>tv:alu-andca</code> (and with complement of source).
</p>
<p><code>bitblt</code> is written in highly-optimized microcode and goes very much
faster than the same thing written with ordinary <code>aref</code> and <code>aset</code>
operations would.  Unfortunately this causes <code>bitblt</code> to have a couple
of strange restrictions.  Wrap-around does not work correctly if
<em>from-array</em> is an indirect array with an index-offset.  <code>bitblt</code>
will signal an error if the first dimensions of <em>from-array</em>
and <em>to-array</em> are not both integral multiples of the machine word
length.  For <code>art-1b</code> arrays, the first dimension must be a multiple
of 32., for <code>art-2b</code> arrays it must be a multiple of 16., etc.
</p></dd></dl>

<p><code>%blt</code> (<a href="#g_t_0025blt_002dfun">%blt-fun</a>) is often useful for copying parts of arrays.  It
can be used to shift a part of an array either up or down.
</p>
<a name="Order-of-Array-Elements"></a>
<h3 class="section">8.8 Order of Array Elements</h3>
<a name="array_002delement_002dorder_002dsection"></a><a name="column_002dmajor"></a><p>Currently, multi-dimensional arrays are stored in column-major order
rather than row-major order as in Maclisp.   Row-major order means that
successive memory locations differ in the last subscript, while
column-major order means that successive memory locations differ in the
first subscript.  However, as part of the adoption of Common Lisp, the
Lisp machine will switch to the more standard row-major order.
This change will take place a few months from now.
</p>
<a name="array_002dindex_002dorder_002dvar"></a><dl>
<dt><a name="index-array_002dindex_002dorder"></a>Variable: <strong>array-index-order</strong></dt>
<dd><p>If this variable is non-<code>nil</code>, arrays are stored in row-major order
(last subscript varies fastest).  Otherwise, they are stored in
column-major order.  The default value of this symbol is <code>nil</code>.
</p></dd></dl>

<p>Most user code has no need to know about which order array elements are
stored in.  There are three known reasons to care: use of
multidimensional indirect arrays; paging efficiency
(if you want to reference every element in a
multi-dimensional array and move linearly through memory to improve
locality of reference, you must vary the first subscript fastest rather
than the last, in column-major order);
and access to the tv screen or to arrays of pixels copied to or from the
screen with <code>bitblt</code>.  The latter is the most important one.
</p>
<p>The bits on the screen are actually stored in rows, which means that the
dimension that varies fastest has to be the horizontal position.
As a result, if arrays are stored in row-major order, the horizontal
position must be the second subscript, but if arrays are stored in
column-major order, the horizontal position must be the first subscript.
To ease the conversion of code that uses arrays of pixels, several
bridging functions are provided:
</p>
<a name="make_002dpixel_002darray_002dfun"></a><dl>
<dt><a name="index-make_002dpixel_002darray"></a>Function: <strong>make-pixel-array</strong> <em>width height &amp;rest options</em></dt>
<dd><p>This is like <code>make-array</code> except that the dimensions of the array are
<em>width</em> and <em>height</em>, in whichever order is correct.  <em>width</em> will
be the dimension in the subscript that varies fastest in memory, and
<em>height</em> will be the other dimension.  <em>options</em> are passed along to
<code>make-array</code> to specify everything but the size of the array.
</p></dd></dl>

<a name="pixel_002darray_002dwidth_002dfun"></a><dl>
<dt><a name="index-pixel_002darray_002dwidth"></a>Function: <strong>pixel-array-width</strong> <em>array</em></dt>
<dd><p>Returns the extent of <em>array</em>, a two-dimensional array,
in the dimension that varies faster through memory.
For a screen array, this will always be the width.
</p></dd></dl>

<a name="pixel_002darray_002dheight_002dfun"></a><dl>
<dt><a name="index-pixel_002darray_002dheight"></a>Function: <strong>pixel-array-height</strong> <em>array</em></dt>
<dd><p>Returns the extent of <em>array</em>, a two-dimensional array,
in the dimension that varies slower through memory.
For a screen array, this will always be the height.
</p></dd></dl>

<a name="ar_002d2_002dreverse_002dfun"></a><dl>
<dt><a name="index-ar_002d2_002dreverse"></a>Function: <strong>ar-2-reverse</strong> <em>array horizontal-index vertical-index</em></dt>
<dd><p>Returns the element of <em>array</em> at <em>horizontal-index</em> and
<em>vertical-index</em>.  <em>horizontal-index</em> will be used as the subscript
in whichever dimension varies faster through memory.
</p></dd></dl>

<a name="as_002d2_002dreverse_002dfun"></a><dl>
<dt><a name="index-as_002d2_002dreverse"></a>Function: <strong>as-2-reverse</strong> <em>newvalue array horizontal-index vertical-index</em></dt>
<dd><p>Stores <em>newvalue</em> into the element of <em>array</em> at <em>horizontal-index</em> and
<em>vertical-index</em>.  <em>horizontal-index</em> will be used as the subscript
in whichever dimension varies faster through memory.
</p></dd></dl>

<p>By replacing calls to <code>make-array</code>, <code>array-dimension-n</code>, <code>aref</code>
and <code>aset</code> with these functions, you can trivially change your code
(without changing the order of arguments) so that it will work no matter
what order array elements are stored in, and still display properly on
the screen.  When the Big Change happens, you will not even need to
recompile your program.
</p>
<a name="Matrices-and-Systems-of-Linear-Equations"></a>
<h3 class="section">8.9 Matrices and Systems of Linear Equations</h3>

<p>The functions in this section perform some useful matrix operations.
The matrices are represented as two-dimensional Lisp arrays.
These functions are part of the mathematics package rather than
the kernel array system, hence the &quot;<code>math:</code>&quot; in the names.
</p>
<a name="math_003amultiply_002dmatrices_002dfun"></a><dl>
<dt><a name="index-math_003amultiply_002dmatrices"></a>Function: <strong>math:multiply-matrices</strong> <em>matrix-1 matrix-2 &amp;optional matrix-3</em></dt>
<dd><p>Multiplies <em>matrix-1</em> by <em>matrix-2</em>.  If <em>matrix-3</em> is supplied,
<code>multiply-matrices</code> stores the results into <em>matrix-3</em> and returns
<em>matrix-3</em>; otherwise it creates an array to contain the answer and
returns that.  All matrices must be two-dimensional arrays, and the first
dimension of <em>matrix-2</em> must equal the second dimension of <em>matrix-1</em>.
</p></dd></dl>

<a name="math_003ainvert_002dmatrix_002dfun"></a><dl>
<dt><a name="index-math_003ainvert_002dmatrix"></a>Function: <strong>math:invert-matrix</strong> <em>matrix &amp;optional into-matrix</em></dt>
<dd><p>Computes the inverse of <em>matrix</em>.  If <em>into-matrix</em> is supplied,
stores the result into it and returns it; otherwise it creates an array
to hold the result and returns that.  <em>matrix</em> must be two-dimensional
and square.  The Gauss-Jordan algorithm with partial pivoting is used.
Note: if you want to solve a set of simultaneous equations, you should
not use this function; use <code>math:decompose</code> and <code>math:solve</code> (see below).
</p></dd></dl>

<a name="math_003atranspose_002dmatrix_002dfun"></a><dl>
<dt><a name="index-math_003atranspose_002dmatrix"></a>Function: <strong>math:transpose-matrix</strong> <em>matrix &amp;optional into-matrix</em></dt>
<dd><p>Transposes <em>matrix</em>.  If <em>into-matrix</em> is supplied, stores the
result into it and returns it; otherwise it creates an array to hold the
result and returns that.  <em>matrix</em> must be a two-dimensional array.
<em>into-matrix</em>, if provided, must be two-dimensional and have sufficient
dimensions to hold the transpose of <em>matrix</em>.
</p></dd></dl>

<a name="math_003adeterminant_002dfun"></a><dl>
<dt><a name="index-math_003adeterminant"></a>Function: <strong>math:determinant</strong> <em>matrix</em></dt>
<dd><p>Returns the determinant of <em>matrix</em>.  <em>matrix</em> must be a two-dimensional
square matrix.
</p></dd></dl>

<p>The next two functions are used to solve sets of simultaneous linear
equations.  <code>math:decompose</code> takes a matrix holding the coefficients of the
equations and produces the LU decomposition; this decomposition can then
be passed to <code>math:solve</code> along with a vector of right-hand sides
to get the values of the variables.  If you want to solve the same
equations for many different sets of right-hand side values, you only need to call
<code>math:decompose</code> once.  In terms of the argument names used below, these
two functions exist to solve the vector equation <em>A</em> <em>x</em> = <em>b</em>
for <em>x</em>.  <em>A</em> is a matrix.  <em>b</em> and <em>x</em> are vectors.
</p>
<a name="math_003adecompose_002dfun"></a><dl>
<dt><a name="index-math_003adecompose"></a>Function: <strong>math:decompose</strong> <em>a &amp;optional lu ps</em></dt>
<dd><p>Computes the LU decomposition of matrix <em>a</em>.  If <em>lu</em> is non-<code>nil</code>,
stores the result into it and returns it; otherwise it creates an array
to hold the result, and returns that.  The lower triangle of <em>lu</em>, with
ones added along the diagonal, is L, and the upper triangle of <em>lu</em> is
U, such that the product of L and U is <em>a</em>.  Gaussian elimination with
partial pivoting is used.  The <em>lu</em> array is permuted by rows according
to the permutation array <em>ps</em>, which is also produced by this function;
if the argument <em>ps</em> is supplied, the permutation array is stored into it;
otherwise, an array is created to hold it.  This function returns two values,
the LU decomposition and the permutation array.
</p></dd></dl>

<a name="math_003asolve_002dfun"></a><dl>
<dt><a name="index-math_003asolve"></a>Function: <strong>math:solve</strong> <em>lu ps b &amp;optional x</em></dt>
<dd><p>This function takes the LU decomposition and associated permutation
array produced by <code>math:decompose</code> and solves the set of simultaneous
equations defined by the original matrix <em>a</em> and the right-hand sides
in the vector <em>b</em>.  If <em>x</em> is supplied, the solutions
are stored into it and it is returned; otherwise an array is
created to hold the solutions and that is returned.  <em>b</em> must
be a one-dimensional array.
</p></dd></dl>

<a name="math_003alist_002d2d_002darray_002dfun"></a><dl>
<dt><a name="index-math_003alist_002d2d_002darray"></a>Function: <strong>math:list-2d-array</strong> <em>array</em></dt>
<dd><p>Returns a list of lists containing the values in <em>array</em>, which must
be a two-dimensional array.  There is one element for each row; each
element is a list of the values in that row.
</p></dd></dl>

<a name="math_003afill_002d2d_002darray_002dfun"></a><dl>
<dt><a name="index-math_003afill_002d2d_002darray"></a>Function: <strong>math:fill-2d-array</strong> <em>array list</em></dt>
<dd><p>This is the opposite of <code>math:list-2d-array</code>.  <em>list</em> should be a
list of lists, with each element being a list corresponding to a row.
<em>array</em>&rsquo;s elements are stored from the list.  Unlike <code>fillarray</code>
(see <a href="#fillarray_002dfun">fillarray-fun</a>), if <em>list</em> is not long enough,
<code>math:fill-2d-array</code> &quot;wraps around&quot;, starting over at the beginning.
The lists which are elements of <em>list</em> also work this way.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003aarithmetic_002derror-error_0029-on-math_003asingular_002dmatrix"></a>Condition on math:singular-matrix: <strong>(<code>sys:arithmetic-error</code> <code>error</code>)</strong></dt>
<dd><p>This is signaled when any of the matrix manipulation functions in this
section has trouble because of a singular matrix.  (In some functions,
such as <code>math:determinant</code>, a singular matrix is not a problem.)
</p>
<p>The <code>:matrix</code> operation on the condition instance returns the matrix
which is singular.
</p></dd></dl>

<a name="Planes"></a>
<h3 class="section">8.10 Planes</h3>
<a name="index-plane"></a>

<p>A <em>plane</em> is effectively an array whose bounds, in each dimension, are
plus-infinity and minus-infinity; all integers are legal as indices.
Planes may be of any rank.  When you create a plane, you do not need to
specify any size, just the rank.  You also specify a default value.  At
that moment, every component of the plane has that value.  As you can&rsquo;t
ever change more than a finite number of components, only a finite
region of the plane need actually be stored.  When you refer to an
element for which space has not actually been allocated, you just get
the default value.
</p>
<p>The regular array accessing functions don&rsquo;t work on planes.
You can use <code>make-plane</code> to create a plane,
<code>plane-aref</code> or <code>plane-ref</code> to get the value of a component, and
<code>plane-aset</code> or <code>plane-store</code> to store into a component.
<code>array-rank</code> will work on a plane.
</p>
<p>A plane is actually stored as an array with a leader.
The array corresponds to a rectangular, aligned region of the plane,
containing all the components in which a <code>plane-store</code> has been done
(and, usually, others which have never been altered).
The lowest-coordinate corner of that rectangular region is
given by the <code>plane-origin</code> in the array leader.
The highest-coordinate corner can be found by adding the <code>plane-origin</code>
to the <code>array-dimensions</code> of the array.
The <code>plane-default</code> is the contents of all the
elements of the plane that are not actually stored in the array.
The <code>plane-extension</code> is the amount to extend a plane by in any direction
when the plane needs to be extended.  The default is 32.
</p>
<p>If you never use any negative indices, then the <code>plane-origin</code> will
be all zeroes and you can use regular array functions, such as <code>aref</code> and <code>aset</code>,
to access the portion of the plane that is actually stored.  This can be
useful to speed up certain algorithms.  In this case you can even use the
<code>bitblt</code> function on a two-dimensional plane of bits or bytes,
provided you don&rsquo;t change the <code>plane-extension</code> to a number that is not
a multiple of 32.
</p>
<a name="make_002dplane_002dfun"></a><dl>
<dt><a name="index-make_002dplane"></a>Function: <strong>make-plane</strong> <em>rank &amp;rest options</em></dt>
<dd><p>Creates and returns a plane. <em>rank</em> is the number of dimensions.  <em>options</em>
is a list of alternating keyword symbols and values.  The allowed keywords are:
</p><dl compact="compact">
<dt><code>:type</code></dt>
<dd><p>The array type symbol (e.g <code>art-1b</code>) specifying the type of the array
out of which the plane is made.
</p></dd>
<dt><code>:default-value</code></dt>
<dd><p>The default component value as explained above.
</p></dd>
<dt><code>:extension</code></dt>
<dd><p>The amount by which to extend the plane, as explained above.
</p></dd>
</dl>
<p>Example:
</p><div class="lisp">
<pre class="lisp">(make-plane 2 ':type 'art-4b ':default-value 3)
</pre></div>
<p>creates a two-dimensional plane of type <code>art-4b</code>, with default value <code>3</code>.
</p></dd></dl>

<a name="plane_002dorigin_002dfun"></a><dl>
<dt><a name="index-plane_002dorigin"></a>Function: <strong>plane-origin</strong> <em>plane</em></dt>
<dd><p>A list of numbers, giving the lowest coordinate values actually stored.
</p></dd></dl>

<a name="plane_002ddefault_002dfun"></a><dl>
<dt><a name="index-plane_002ddefault"></a>Function: <strong>plane-default</strong> <em>plane</em></dt>
<dd><p>This is the contents of the infinite number of plane elements that are
not actually stored.
</p></dd></dl>

<a name="plane_002dextension_002dfun"></a><dl>
<dt><a name="index-plane_002dextension"></a>Function: <strong>plane-extension</strong> <em>plane</em></dt>
<dd><p>The amount to extend the plane by, in any direction, when <code>plane-store</code> is done
outside of the currently-stored portion.
</p></dd></dl>

<a name="plane_002daref_002dfun"></a><dl>
<dt><a name="index-plane_002daref"></a>Function: <strong>plane-aref</strong> <em>plane &amp;rest subscripts</em></dt>
<dd><a name="plane_002dref_002dfun"></a></dd><dt><a name="index-plane_002dref"></a>Function: <strong>plane-ref</strong> <em>plane subscripts</em></dt>
<dd><p>These two functions return the contents of a specified element of a plane.
They differ only in the way they take their arguments; <code>plane-aref</code> wants
the subscripts as arguments, while <code>plane-ref</code> wants a list of subscripts.
</p></dd></dl>

<a name="plane_002daset_002dfun"></a><dl>
<dt><a name="index-plane_002daset"></a>Function: <strong>plane-aset</strong> <em>datum plane &amp;rest subscripts</em></dt>
<dd><a name="plane_002dstore_002dfun"></a></dd><dt><a name="index-plane_002dstore"></a>Function: <strong>plane-store</strong> <em>datum plane subscripts</em></dt>
<dd><p>These two functions store <em>datum</em> into the specified element of a plane,
extending it if necessary, and return <em>datum</em>.
They differ only in the way they take their arguments; <code>plane-aset</code> wants
the subscripts as arguments, while <code>plane-store</code> wants a list of subscripts.
</p></dd></dl>


<a name="g_t_0022Maclisp-Array-Compatibility_0022"></a>
<h3 class="section">8.11 &quot;Maclisp Array Compatibility&quot;</h3>
<a name="maclisp_002darray"></a>
<p>The functions in this section are provided only for Maclisp compatibility
and should not be used in new programs.
</p>
<p>Fixnum arrays do not exist (however, see Zetalisp&rsquo;s
small-positive-integer arrays).  Flonum arrays exist but you do not use
them in the same way; no declarations are required or allowed.
&quot;Un-garbage-collected&quot; arrays do not exist.
Readtables and obarrays are represented as arrays, but Zetalisp does not
use special array types for them.  See the descriptions of <code>read</code>
(<a href="#read_002dfun">read-fun</a>) and <code>intern</code> (<a href="#intern_002dfun">intern-fun</a>) for information about
readtables and obarrays (packages).  There are no &quot;dead&quot; arrays, nor are
Multics &quot;external&quot; arrays provided.
</p>
<p>The <code>arraycall</code> function exists for compatibility
but should not be used (see <code>aref</code>, <a href="#aref_002dfun">aref-fun</a>.)
</p>
<p>Subscripts are always checked for validity, regardless of the value
of <code>*rset</code> and whether the code is compiled or not. 
However, in a multi-dimensional array, an error is caused only
if the subscripts would have resulted in a reference to storage
outside of the array. For example, if you have a 2 by 7 array and refer
to an element with subscripts 3 and 1, no error will
be caused despite the fact that the reference is invalid;
but if you refer to element 1 by 100, an error will be caused.
In other words, subscript errors will be caught if and only if
they refer to storage outside the array; some errors are undetected,
but they will only clobber (alter randomly) some other element of the same array,
not something completely unpredictable.
</p>
<p>Currently, multi-dimensional arrays are stored in column-major order
rather than row-major order as in Maclisp.  See <a href="#column_002dmajor">column-major</a>
for further discussion of this issue.
</p>
<p><code>loadarrays</code> and <code>dumparrays</code> are not provided.  However,
arrays can be put into QFASL files; see <a href="#fasdump">fasdump</a>.
</p>
<p>The <code>*rearray</code> function is not provided, since not all
of its functionality is available in Zetalisp.
Its most common uses are implemented by <code>adjust-array-size</code>.
</p>
<p>In Maclisp, arrays are usually kept on the <code>array</code> property
of symbols, and the symbols are used instead of the arrays.  In order
to provide some degree of compatibility for this manner of using
arrays, the <code>array</code>, <code>*array</code>, and <code>store</code> functions are
provided, and when arrays are applied to arguments, the arguments are
treated as subscripts and <code>apply</code> returns the corresponding element
of the array.
</p>
<a name="array_002dfun"></a><dl>
<dt><a name="index-array-1"></a>Function: <strong>array</strong> <em>&amp;quote symbol type &amp;eval &amp;rest dims</em></dt>
<dd><p>This creates an <code>art-q</code> type array in <code>default-array-area</code>
with the given dimensions.  (That is, <em>dims</em> is given
to <code>make-array</code> as its first argument.)  <em>type</em> is ignored.
If <em>symbol</em> is <code>nil</code>, the array is returned; otherwise,
the array is put in the function cell of <em>symbol</em>, and <em>symbol</em>
is returned.
</p></dd></dl>

<a name="g_t_002aarray_002dfun"></a><dl>
<dt><a name="index-_002aarray"></a>Function: <strong>*array</strong> <em>symbol type &amp;rest dims</em></dt>
<dd><p>This is just like <code>array</code>, except that all of the arguments
are evaluated.
</p></dd></dl>

<a name="store_002dfun"></a><dl>
<dt><a name="index-store"></a>Special Form: <strong>store</strong> <em>array-ref x</em></dt>
<dd><p><code>store</code> stores <em>x</em> into the
specified array element.  <em>array-ref</em> should be a form which
references an array by calling it as a function (<code>aref</code> forms are not
acceptable).  First <em>x</em> is evaluated, then <em>array-ref</em> is
evaluated, and then the value of <em>x</em> is stored into the array cell
last referenced by a function call, presumably the one in <em>array-ref</em>.
</p></dd></dl>

<a name="xstore_002dfun"></a><dl>
<dt><a name="index-xstore"></a>Function: <strong>xstore</strong> <em>x array-ref</em></dt>
<dd><p>This is just like <code>store</code>, but it is not
a special form; this is because the arguments are in the other
order.  This function only exists for the compiler to compile the
<code>store</code> special form into, and should never be used by programs.
</p></dd></dl>

<a name="arraycall_002dfun"></a><dl>
<dt><a name="index-arraycall"></a>Function: <strong>arraycall</strong> <em>ignored array &amp;rest subscripts</em></dt>
<dd><p><code>(arraycall t <em>array</em> <em>sub1</em> <em>sub2</em>...)</code> is the same
as <code>(aref <em>array</em> <em>sub1</em> <em>sub2</em>...)</code>.  It exists for
Maclisp compatibility.
</p></dd></dl>

<a name="g_t_0022Strings_0022"></a>
<h2 class="chapter">9 &quot;Strings&quot;</h2>
<a name="string_002dchapter"></a><a name="index-string"></a>
<p>Strings are a type of array representing a sequence of
characters.  The printed representation of a string is its characters
enclosed in quotation marks, for example <code>&quot;foo bar&quot;</code>.  Strings are
constants, that is, evaluating a string returns that string.  Strings
are the right data type to use for text-processing.
</p>
<p>Strings are arrays of type <code>art-string</code>, where each element
holds an eight-bit unsigned fixnum.  This is because characters are
represented as fixnums, and for fundamental characters only eight bits are
used.  A string can also be an array of type <code>art-fat-string</code>, where each
element holds a sixteen-bit unsigned fixnum; the extra bits allow for
multiple fonts or an expanded character set.
</p>
<p>Characters are actually fixnums, as explained
in <a href="#character_002dset">character-set</a>.  Note that you can type in the fixnums
that represent characters using &quot;<code>#/</code>&quot; and &quot;<code>#\</code>&quot;; for example,
<code>#/f</code> reads in as the fixnum that represents the character &quot;f&quot;,
and <code>#\return</code> reads in as the fixnum that represents the special <code>Return</code>
character.  See <a href="#sharp_002dslash">sharp-slash</a> for details of this syntax.
</p>
<p>The functions described in this section provide a variety of useful
operations on strings.  In place of a string, most of these functions will
accept a symbol or a fixnum as an argument, and will coerce it into a
string.  Given a symbol, its print name, which is a string, will be used.
Given a fixnum, a one-character string containing the character designated
by that fixnum will be used.  Several of the functions actually work on any
type of one-dimensional array and may be useful for other than string
processing; these are the functions such as <code>substring</code> and <code>string-length</code>
which do not depend on the elements of the string being characters.
</p>
<p>Since strings are arrays, the usual array-referencing function <code>aref</code>
is used to extract the characters of the string as fixnums.  For example,
</p><div class="lisp">
<pre class="lisp">(aref &quot;frob&quot; 1) =&gt; 162  <span class="roman">;lower-case r</span>
</pre></div>
<p>Note that the character at the beginning of the string is element zero
of the array (rather than one); as usual in Zetalisp, everything
is zero-based.
</p>
<p>It is also legal to store into strings (using <code>aset</code>).
As with <code>rplaca</code> on lists, this changes the actual object; one must be careful
to understand where side-effects will propagate.
When you are making strings that you intend to change later, you probably
want to create an array with a fill-pointer (see <a href="#fill_002dpointer">fill-pointer</a>) so that
you can change the length of the string as well as the contents.
The length of a string is always computed using <code>array-active-length</code>,
so that if a string has a fill-pointer, its value will be used
as the length.
</p>
<a name="g_t_0022Characters_0022"></a>
<h3 class="section">9.1 &quot;Characters&quot;</h3>

<a name="character_002dfun"></a><dl>
<dt><a name="index-character"></a>Function: <strong>character</strong> <em>x</em></dt>
<dd><p><code>character</code> coerces <em>x</em> to a single character,
represented as a fixnum.  If <em>x</em> is a number, it is returned.  If
<em>x</em> is a string or an array, its first element is returned.  If
<em>x</em> is a symbol, the first character of its pname is returned.
Otherwise an error occurs.  The way characters are represented
as fixnums is explained in <a href="#character_002dset">character-set</a>.
</p></dd></dl>

<a name="char_002dequal_002dfun"></a><dl>
<dt><a name="index-char_002dequal"></a>Function: <strong>char-equal</strong> <em>ch1 ch2</em></dt>
<dd><p>This is the primitive for comparing characters for equality;
many of the string functions call it.  <em>ch1</em> and <em>ch2</em>
must be fixnums.  The result is <code>t</code> if the characters are equal ignoring
case and font, otherwise <code>nil</code>.
<code>%%ch-char</code> is the byte-specifier for the portion of a character
that excludes the font information.
</p></dd></dl>

<a name="char_002dlessp_002dfun"></a><dl>
<dt><a name="index-char_002dlessp"></a>Function: <strong>char-lessp</strong> <em>ch1 ch2</em></dt>
<dd><p>This is the primitive for comparing characters for order;
many of the string functions call it.  <em>ch1</em> and <em>ch2</em>
must be fixnums.  The result is <code>t</code> if <em>ch1</em> comes before <em>ch2</em>
ignoring case and font, otherwise <code>nil</code>.  Details of the ordering
of characters are in <a href="#character_002dset">character-set</a>.
</p></dd></dl>

<a name="Upper-and-Lower-Case-Letters"></a>
<h3 class="section">9.2 Upper and Lower Case Letters</h3>
<a name="index-alphabetic-case"></a>
<a name="index-upper-case-letter"></a>
<a name="index-lower-case-letter"></a>

<a name="alphabetic_002dcase_002daffects_002dstring_002dcomparison_002dvar"></a><dl>
<dt><a name="index-alphabetic_002dcase_002daffects_002dstring_002dcomparison"></a>Variable: <strong>alphabetic-case-affects-string-comparison</strong></dt>
<dd><p>This variable is normally <code>nil</code>.  If it is <code>t</code>, <code>char-equal</code>,
<code>char-lessp</code>, and the string searching and comparison functions will
distinguish between upper-case and lower-case letters.  If it is <code>nil</code>,
lower-case characters behave as if they were the same character but
in upper-case.  It is all right
to bind this to <code>t</code> around a string operation, but changing its
global value to <code>t</code> will break many system functions and user
interfaces and so is not recommended.
</p></dd></dl>

<a name="char_002dupcase_002dfun"></a><dl>
<dt><a name="index-char_002dupcase"></a>Function: <strong>char-upcase</strong> <em>ch</em></dt>
<dd><p>If <em>ch</em>, which must be a fixnum, is a lower-case alphabetic
character its upper-case form is returned; otherwise, <em>ch</em> itself is
returned.  If font information is present it is preserved.
</p></dd></dl>

<a name="char_002ddowncase_002dfun"></a><dl>
<dt><a name="index-char_002ddowncase"></a>Function: <strong>char-downcase</strong> <em>ch</em></dt>
<dd><p>If <em>ch</em>, which must be a fixnum, is a upper-case alphabetic
character its lower-case form is returned; otherwise, <em>ch</em> itself is
returned.  If font information is present it is preserved.
</p></dd></dl>

<a name="string_002dupcase_002dfun"></a><dl>
<dt><a name="index-string_002dupcase"></a>Function: <strong>string-upcase</strong> <em>string</em></dt>
<dd><p>Returns a copy of <em>string</em>, with all lower-case alphabetic
characters replaced by the corresponding upper-case characters.
</p></dd></dl>

<a name="string_002ddowncase_002dfun"></a><dl>
<dt><a name="index-string_002ddowncase"></a>Function: <strong>string-downcase</strong> <em>string</em></dt>
<dd><p>Returns a copy of <em>string</em>, with all upper-case alphabetic
characters replaced by the corresponding lower-case characters.
</p></dd></dl>

<a name="string_002dcapitalize_002dwords_002dfun"></a><dl>
<dt><a name="index-string_002dcapitalize_002dwords"></a>Function: <strong>string-capitalize-words</strong> <em>string &amp;optional (copy-p <code>t</code>) (spaces <code>t</code>)</em></dt>
<dd><p>Puts each word in <em>string</em> into lower-case with an upper case initial,
and if <em>spaces</em> is non-<code>nil</code> replaces each hyphen character with a space.
</p>
<p>If <em>copy-p</em> is <code>t</code>, the value is a copy of <em>string</em>, and
<em>string</em> itself is unchanged.  Otherwise, <em>string</em> itself is
returned, with its contents changed.
</p></dd></dl>

<a name="Basic-String-Operations"></a>
<h3 class="section">9.3 Basic String Operations</h3>

<a name="string_002dfun"></a><dl>
<dt><a name="index-string-1"></a>Function: <strong>string</strong> <em>x</em></dt>
<dd><p><code>string</code> coerces <em>x</em> into a string.  Most of the string
functions apply this to their string arguments.
If <em>x</em> is a string (or any array), it is returned.  If <em>x</em> is
a symbol, its pname is returned.  If <em>x</em> is a non-negative
fixnum less than <code>400</code> octal, a one-character-long string containing
it is created and returned.  If <em>x</em> is a pathname (see <a href="#pathname">pathname</a>),
the &quot;string for printing&quot; is returned.  Otherwise, an error is signalled.
</p>
<p>If you want to get the printed representation of an object into the
form of a string, this function is <em>not</em> what you should use.
You can use <code>format</code>, passing a first argument of <code>nil</code> (see <a href="#format_002dfun">format-fun</a>).
You might also want to use <code>with-output-to-string</code> (see
<a href="#with_002doutput_002dto_002dstring_002dfun">with-output-to-string-fun</a>).
</p></dd></dl>

<a name="string_002dlength_002dfun"></a><dl>
<dt><a name="index-string_002dlength"></a>Function: <strong>string-length</strong> <em>string</em></dt>
<dd><p><code>string-length</code> returns the number of characters in <em>string</em>.  This is 1
if <em>string</em> is a number, the <code>array-active-length</code>
(see <a href="#array_002dactive_002dlength_002dfun">array-active-length-fun</a>)
if <em>string</em>
is an array, or the <code>array-active-length</code> of the pname if <em>string</em> is a symbol.
</p></dd></dl>

<a name="string_002dequal_002dfun"></a><dl>
<dt><a name="index-string_002dequal"></a>Function: <strong>string-equal</strong> <em>string1 string2 &amp;optional (idx1 0) (idx2 0) lim1 lim2</em></dt>
<dd><p><code>string-equal</code> compares two strings, returning <code>t</code> if
they are equal and <code>nil</code> if they are not.  The comparison ignores
the extra &quot;font&quot; bits in 16-bit strings
and ignores alphabetic case.  <code>equal</code> calls <code>string-equal</code> if
applied to two strings.
	The optional arguments <em>idx1</em> and <em>idx2</em> are the starting
indices into the strings.  The optional arguments <em>lim1</em> and <em>lim2</em>
are the final indices; the comparison stops just <em>before</em> the final index.
<em>lim1</em> and <em>lim2</em> default to the lengths of the strings.  These arguments are provided
so that you can efficiently compare substrings.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(string-equal &quot;Foo&quot; &quot;foo&quot;) =&gt; t
(string-equal &quot;foo&quot; &quot;bar&quot;) =&gt; nil
(string-equal &quot;element&quot; &quot;select&quot; 0 1 3 4) =&gt; t
</pre></div>
</dd></dl>

<a name="g_t_0025string_002dequal_002dfun"></a><dl>
<dt><a name="index-_0025string_002dequal"></a>Function: <strong>%string-equal</strong> <em>string1 idx1 string2 idx2 count</em></dt>
<dd><p><code>%string-equal</code> is the microcode primitive used by <code>string-equal</code>.
It returns <code>t</code> if the <em>count</em> characters of <em>string1</em> starting
at <em>idx1</em> are <code>char-equal</code> to the <em>count</em> characters of <em>string2</em>
starting at <em>idx2</em>, or <code>nil</code> if the characters are not equal or
if <em>count</em> runs off the length of either array.
</p>
<p>Instead of a fixnum, <em>count</em> may also be <code>nil</code>.  In this case,
<code>%string-equal</code> compares
the substring from <em>idx1</em> to <code>(string-length <em>string1</em>)</code>
against the substring from <em>idx2</em> to <code>(string-length <em>string2</em>)</code>.
If the lengths of these substrings differ, then they are not equal and
<code>nil</code> is returned.
</p>
<p>Note that <em>string1</em> and <em>string2</em> must really be strings; the
usual coercion of symbols and fixnums to strings is not performed.
This function is documented because certain programs which require
high efficiency and are willing to pay the price of less generality
may want to use <code>%string-equal</code> in place of <code>string-equal</code>.
</p>
<div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp"><span class="roman">To compare the two strings <em>foo</em> and <em>bar</em>:</span>
(%string-equal <em>foo</em> 0 <em>bar</em> 0 nil)
<span class="roman">To see if the string <em>foo</em> starts with the characters <code>&quot;bar&quot;</code>:</span>
(%string-equal <em>foo</em> 0 &quot;bar&quot; 0 3)
</pre></div>
</dd></dl>

<a name="string_002dlessp_002dfun"></a><dl>
<dt><a name="index-string_002dlessp"></a>Function: <strong>string-lessp</strong> <em>string1 string2</em></dt>
<dd><p><code>string-lessp</code> compares two strings using dictionary order
(as defined by <code>char-lessp</code>).
The result is <code>t</code> if <em>string1</em> is the lesser, or <code>nil</code>
if they are equal or <em>string2</em> is the lesser.
</p></dd></dl>

<a name="string_002dcompare_002dfun"></a><dl>
<dt><a name="index-string_002dcompare"></a>Function: <strong>string-compare</strong> <em>string1 string2 &amp;optional (idx1 0) (idx2 0) lim1 lim2</em></dt>
<dd><p><code>string-compare</code> compares two strings using dictionary order (as defined
by <code>char-lessp</code>).  The arguments are interpreted as in <code>string-equal</code>.
The result is <code>0</code> if the strings are equal, a negative number if <em>string1</em>
is less than <em>string2</em>, or a positive number if <em>string1</em> is greater than
<em>string2</em>.  If the strings are not equal, the absolute value of the
number returned is one greater than the index (in <em>string1</em>) where the first
difference occurred.
</p></dd></dl>

<a name="substring_002dfun"></a><dl>
<dt><a name="index-substring"></a>Function: <strong>substring</strong> <em>string start &amp;optional end area</em></dt>
<dd><p>This extracts a substring of <em>string</em>, starting at the
character specified by <em>start</em> and going up to but not including
the character specified by <em>end</em>.  <em>start</em> and <em>end</em> are
0-origin indices.  The length of the returned string is <em>end</em> minus
<em>start</em>.  If <em>end</em> is not specified it defaults to the length
of <em>string</em>.  The area in which the result is to be consed may be
optionally specified.
<a name="index-Paper-tape-punch"></a>
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(substring &quot;Nebuchadnezzar&quot; 4 8) =&gt; &quot;chad&quot;
</pre></div>
</dd></dl>

<a name="nsubstring_002dfun"></a><dl>
<dt><a name="index-nsubstring"></a>Function: <strong>nsubstring</strong> <em>string start &amp;optional end area</em></dt>
<dd><p><code>nsubstring</code> is the same as <code>substring</code> except that the substring
is not copied; instead an indirect array (see <a href="#indirect_002darray">indirect-array</a>) is created which shares part
of the argument <em>string</em>.  Modifying one string will modify the other.
</p>
<p>Note that <code>nsubstring</code> does not necessarily use less storage than
<code>substring</code>; an <code>nsubstring</code> of any length uses at least as much
storage as a <code>substring</code> 12 characters long.  So you shouldn&rsquo;t use
this just &quot;for efficiency&quot;; it is intended for uses in which it is important
to have a substring which, if modified, will cause the original string
to be modified too.
</p></dd></dl>

<a name="string_002dappend_002dfun"></a><dl>
<dt><a name="index-string_002dappend"></a>Function: <strong>string-append</strong> <em>&amp;rest strings</em></dt>
<dd><p>Any number of strings are copied and concatenated into a single string.
With a single argument, <code>string-append</code> simply copies it.
If there are no arguments, the value is an empty string.
In fact, arrays of any type may be used as arguments,
and the value will be of the same type as the first argument.
Thus <code>string-append</code> can be
used to copy and concatenate any type of 1-dimensional array.
If the first argument is not an array (for example, if it is a character),
the value is a string.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(string-append #/! &quot;foo&quot; #/!) =&gt; &quot;!foo!&quot;
</pre></div>
</dd></dl>

<a name="string_002dnconc_002dfun"></a><dl>
<dt><a name="index-string_002dnconc"></a>Function: <strong>string-nconc</strong> <em>modified-string &amp;rest strings</em></dt>
<dd><p><code>string-nconc</code> is like <code>string-append</code> except that instead
of making a new string containing the concatenation of its arguments,
<code>string-nconc</code> modifies its first argument.  <em>modified-string</em>
must have a fill-pointer so that additional characters can be tacked
onto it.  Compare this with <code>array-push-extend</code>
(<a href="#array_002dpush_002dextend_002dfun">array-push-extend-fun</a>).  The value of <code>string-nconc</code> is
<em>modified-string</em> or a new, longer copy of it; in the latter case
the original copy is forwarded to the new copy (see <code>adjust-array-size</code>,
<a href="#adjust_002darray_002dsize_002dfun">adjust-array-size-fun</a>).  Unlike <code>nconc</code>, <code>string-nconc</code>
with more than two arguments modifies only its first argument, not
every argument but the last.
</p></dd></dl>

<a name="string_002dtrim_002dfun"></a><dl>
<dt><a name="index-string_002dtrim"></a>Function: <strong>string-trim</strong> <em>char-set string</em></dt>
<dd><p>This returns a <code>substring</code> of <em>string</em>, with all characters
in <em>char-set</em> stripped off the beginning and end.
<em>char-set</em> is a set of characters, which can be represented as a list
of characters, a string of characters or a single character.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(string-trim '(#\sp) &quot;  Dr. No  &quot;) =&gt; &quot;Dr. No&quot;
(string-trim &quot;ab&quot; &quot;abbafooabb&quot;) =&gt; &quot;foo&quot;
</pre></div>
</dd></dl>

<a name="string_002dleft_002dtrim_002dfun"></a><dl>
<dt><a name="index-string_002dleft_002dtrim"></a>Function: <strong>string-left-trim</strong> <em>char-set string</em></dt>
<dd><p>This returns a <code>substring</code> of <em>string</em>, with all characters
in <em>char-set</em> stripped off the beginning.
<em>char-set</em> is a set of characters, which can be represented as a list
of characters, a string of characters or a single character.
</p></dd></dl>

<a name="string_002dright_002dtrim_002dfun"></a><dl>
<dt><a name="index-string_002dright_002dtrim"></a>Function: <strong>string-right-trim</strong> <em>char-set string</em></dt>
<dd><p>This returns a <code>substring</code> of <em>string</em>, with all characters
in <em>char-set</em> stripped off the end.
<em>char-set</em> is a set of characters, which can be represented as a list
of characters, a string of characters or a single character.
</p></dd></dl>

<a name="string_002dremove_002dfonts_002dfun"></a><dl>
<dt><a name="index-string_002dremove_002dfonts"></a>Function: <strong>string-remove-fonts</strong> <em>string</em></dt>
<dd><p>Returns a copy of <em>string</em> with each character truncated to 8
bits; that is, changed to font zero.
</p>
<p>If <em>string</em> is an ordinary string of array type <code>art-string</code>, this
does not change anything, but it makes a difference if <em>string</em> is an
<code>art-fat-string</code>.
</p></dd></dl>

<a name="string_002dreverse_002dfun"></a><dl>
<dt><a name="index-string_002dreverse"></a>Function: <strong>string-reverse</strong> <em>string</em></dt>
<dd><p>Returns a copy of <em>string</em> with the order of characters reversed.
This will reverse a one-dimensional array of any type.
</p></dd></dl>

<a name="string_002dnreverse_002dfun"></a><dl>
<dt><a name="index-string_002dnreverse"></a>Function: <strong>string-nreverse</strong> <em>string</em></dt>
<dd><p>Returns <em>string</em> with the order of characters reversed,
smashing the original string rather than creating a new one.
If <em>string</em> is a number, it is simply
returned without consing up a string.
This will reverse a one-dimensional array of any type.
</p></dd></dl>

<a name="string_002dpluralize_002dfun"></a><dl>
<dt><a name="index-string_002dpluralize"></a>Function: <strong>string-pluralize</strong> <em>string</em></dt>
<dd><p><code>string-pluralize</code> returns a string containing the plural of the
word in the argument <em>string</em>.  Any added characters go in the same
case as the last character of <em>string</em>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(string-pluralize &quot;event&quot;) =&gt; &quot;events&quot;
(string-pluralize &quot;Man&quot;) =&gt; &quot;Men&quot;
(string-pluralize &quot;Can&quot;) =&gt; &quot;Cans&quot;
(string-pluralize &quot;key&quot;) =&gt; &quot;keys&quot;
(string-pluralize &quot;TRY&quot;) =&gt; &quot;TRIES&quot;
</pre></div>
<p>For words with multiple plural forms depending on the
meaning, <code>string-pluralize</code> cannot always do the right thing.
</p></dd></dl>

<a name="g_t_0022String-Searching_0022"></a>
<h3 class="section">9.4 &quot;String Searching&quot;</h3>

<a name="string_002dsearch_002dchar_002dfun"></a><dl>
<dt><a name="index-string_002dsearch_002dchar"></a>Function: <strong>string-search-char</strong> <em>char string &amp;optional (from 0) to</em></dt>
<dd><p><code>string-search-char</code> searches through <em>string</em> starting at the index <em>from</em>,
which defaults to the beginning, and returns the index of the first
character that is <code>char-equal</code> to <em>char</em>, or <code>nil</code> if none is found.
If the <em>to</em> argument is supplied, it is used in place of <code>(string-length <em>string</em>)</code>
to limit the extent of the search.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(string-search-char #/a &quot;banana&quot;) =&gt; 1
</pre></div>
</dd></dl>

<a name="g_t_0025string_002dsearch_002dchar_002dfun"></a><dl>
<dt><a name="index-_0025string_002dsearch_002dchar"></a>Function: <strong>%string-search-char</strong> <em>char string from to</em></dt>
<dd><p><code>%string-search-char</code> is the microcode primitive called by <code>string-search-char</code>
and other functions.  <em>string</em> must be an array and <em>char</em>, <em>from</em>,
and <em>to</em> must be fixnums.  Except for this lack of type-coercion, and the fact
that none of the arguments is optional, <code>%string-search-char</code> is the same as
<code>string-search-char</code>.  This function is documented for the benefit of
those who require the maximum possible efficiency in string searching.
</p></dd></dl>

<a name="string_002dsearch_002dnot_002dchar_002dfun"></a><dl>
<dt><a name="index-string_002dsearch_002dnot_002dchar"></a>Function: <strong>string-search-not-char</strong> <em>char string &amp;optional (from 0) to</em></dt>
<dd><p><code>string-search-not-char</code> searches through <em>string</em> starting at the index <em>from</em>,
which defaults to the beginning, and returns the index of the first
character that is <em>not</em> <code>char-equal</code> to <em>char</em>, or <code>nil</code> if none is found.
If the <em>to</em> argument is supplied, it is used in place of <code>(string-length <em>string</em>)</code>
to limit the extent of the search.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(string-search-not-char #/b &quot;banana&quot;) =&gt; 1
</pre></div>
</dd></dl>

<a name="string_002dsearch_002dfun"></a><dl>
<dt><a name="index-string_002dsearch"></a>Function: <strong>string-search</strong> <em>key string &amp;optional (from 0) to</em></dt>
<dd><p><code>string-search</code> searches for the string <em>key</em> in the string
<em>string</em>.  The search begins at <em>from</em>, which defaults to the
beginning of <em>string</em>.  The value returned is the index of the first
character of the first instance of <em>key</em>, or <code>nil</code> if none is
found.
If the <em>to</em> argument is supplied, it is used in place of <code>(string-length <em>string</em>)</code>
to limit the extent of the search.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(string-search &quot;an&quot; &quot;banana&quot;) =&gt; 1
(string-search &quot;an&quot; &quot;banana&quot; 2) =&gt; 3
</pre></div>
</dd></dl>

<a name="string_002dsearch_002dset_002dfun"></a><dl>
<dt><a name="index-string_002dsearch_002dset"></a>Function: <strong>string-search-set</strong> <em>char-set string &amp;optional (from 0) to</em></dt>
<dd><p><code>string-search-set</code> searches through <em>string</em> looking for
a character that is in <em>char-set</em>.  The search begins at the index <em>from</em>,
which defaults to the beginning.  It returns the index of the first
character that is <code>char-equal</code> to some element of <em>char-set</em>,
or <code>nil</code> if none is found.
If the <em>to</em> argument is supplied, it is used in place of <code>(string-length <em>string</em>)</code>
to limit the extent of the search.
<em>char-set</em> is a set of characters, which can be represented as a list
of characters, a string of characters or a single character.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(string-search-set '(#/n #/o) &quot;banana&quot;) =&gt; 2
(string-search-set &quot;no&quot; &quot;banana&quot;) =&gt; 2
</pre></div>
</dd></dl>

<a name="string_002dsearch_002dnot_002dset_002dfun"></a><dl>
<dt><a name="index-string_002dsearch_002dnot_002dset"></a>Function: <strong>string-search-not-set</strong> <em>char-set string &amp;optional (from 0) to</em></dt>
<dd><p><code>string-search-not-set</code> searches through <em>string</em> looking for
a character which is not in <em>char-set</em>.  The search begins at the index <em>from</em>,
which defaults to the beginning.  It returns the index of the first
character which is not <code>char-equal</code> to any element of <em>char-set</em>,
or <code>nil</code> if none is found.
If the <em>to</em> argument is supplied, it is used in place of <code>(string-length <em>string</em>)</code>
to limit the extent of the search.
<em>char-set</em> is a set of characters, which can be represented as a list
of characters, a string of characters or a single character.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(string-search-not-set '(#/a #/b) &quot;banana&quot;) =&gt; 2
</pre></div>
</dd></dl>

<a name="string_002dreverse_002dsearch_002dchar_002dfun"></a><dl>
<dt><a name="index-string_002dreverse_002dsearch_002dchar"></a>Function: <strong>string-reverse-search-char</strong> <em>char string &amp;optional from (to 0)</em></dt>
<dd><p><code>string-reverse-search-char</code> searches through <em>string</em> in reverse order, starting
from the index one less than <em>from</em>, which defaults to the length of <em>string</em>,
and returns the index of the first character which is <code>char-equal</code>
to <em>char</em>, or <code>nil</code> if none is found.  Note that the index returned
is from the beginning of the string, although the search starts from the end.
If the <em>to</em> argument is supplied, it limits the extent of the search.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(string-reverse-search-char #/n &quot;banana&quot;) =&gt; 4
</pre></div>
</dd></dl>

<a name="string_002dreverse_002dsearch_002dnot_002dchar_002dfun"></a><dl>
<dt><a name="index-string_002dreverse_002dsearch_002dnot_002dchar"></a>Function: <strong>string-reverse-search-not-char</strong> <em>char string &amp;optional from (to 0)</em></dt>
<dd><p><code>string-reverse-search-not-char</code> searches through <em>string</em> in reverse order, starting
from the index one less than <em>from</em>, which defaults to the length of <em>string</em>,
and returns the index of the first character that is <em>not</em> <code>char-equal</code>
to <em>char</em>, or <code>nil</code> if none is found.  Note that the index returned
is from the beginning of the string, although the search starts from the end.
If the <em>to</em> argument is supplied, it limits the extent of the search.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(string-reverse-search-not-char #/a &quot;banana&quot;) =&gt; 4
</pre></div>
</dd></dl>

<a name="string_002dreverse_002dsearch_002dfun"></a><dl>
<dt><a name="index-string_002dreverse_002dsearch"></a>Function: <strong>string-reverse-search</strong> <em>key string &amp;optional from (to 0)</em></dt>
<dd><p><code>string-reverse-search</code> searches for the string <em>key</em> in the string <em>string</em>.
The search proceeds in reverse order, starting
from the index one less than <em>from</em>, which defaults to the length of <em>string</em>,
and returns the index of the first (leftmost) character of the first instance found,
or <code>nil</code> if none is found.  Note that the index returned
is from the beginning of the string, although the search starts from the end.
The <em>from</em> condition, restated, is that the instance of <em>key</em> found
is the rightmost one whose rightmost character is before the <em>from</em>th character
of <em>string</em>.
If the <em>to</em> argument is supplied, it limits the extent of the search.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(string-reverse-search &quot;na&quot; &quot;banana&quot;) =&gt; 4
</pre></div>
</dd></dl>

<a name="string_002dreverse_002dsearch_002dset_002dfun"></a><dl>
<dt><a name="index-string_002dreverse_002dsearch_002dset"></a>Function: <strong>string-reverse-search-set</strong> <em>char-set string &amp;optional from (to 0)</em></dt>
<dd><p><code>string-reverse-search-set</code> searches through <em>string</em> in reverse order, starting
from the index one less than <em>from</em>, which defaults to the length of <em>string</em>,
and returns the index of the first character which is <code>char-equal</code>
to some element of <em>char-set</em>, or <code>nil</code> if none is found.
Note that the index returned
is from the beginning of the string, although the search starts from the end.
If the <em>to</em> argument is supplied, it limits the extent of the search.
<em>char-set</em> is a set of characters, which can be represented as a list
of characters, a string of characters or a single character.
</p><div class="lisp">
<pre class="lisp">(string-reverse-search-set &quot;ab&quot; &quot;banana&quot;) =&gt; 5
</pre></div>
</dd></dl>

<a name="string_002dreverse_002dsearch_002dnot_002dset_002dfun"></a><dl>
<dt><a name="index-string_002dreverse_002dsearch_002dnot_002dset"></a>Function: <strong>string-reverse-search-not-set</strong> <em>char-set string &amp;optional from (to 0)</em></dt>
<dd><p><code>string-reverse-search-not-set</code> searches through <em>string</em> in reverse order, starting
from the index one less than <em>from</em>, which defaults to the length of <em>string</em>,
and returns the index of the first character which is not <code>char-equal</code>
to any element of <em>char-set</em>, or <code>nil</code> if none is found.
Note that the index returned
is from the beginning of the string, although the search starts from the end.
If the <em>to</em> argument is supplied, it limits the extent of the search.
<em>char-set</em> is a set of characters, which can be represented as a list
of characters, a string of characters or a single character.
</p><div class="lisp">
<pre class="lisp">(string-reverse-search-not-set '(#/a #/n) &quot;banana&quot;) =&gt; 0
</pre></div>
</dd></dl>

<a name="string_002dsubst_002dchar_002dfun"></a><dl>
<dt><a name="index-string_002dsubst_002dchar"></a>Function: <strong>string-subst-char</strong> <em>new-char old-char string</em></dt>
<dd><p>Returns a copy of <em>string</em> in which all occurrences of <em>old-char</em>
have been replaced by <em>new-char</em>.
</p></dd></dl>

<a name="substring_002dafter_002dchar_002dfun"></a><dl>
<dt><a name="index-substring_002dafter_002dchar"></a>Function: <strong>substring-after-char</strong> <em>char string &amp;optional start end area</em></dt>
<dd><p>Returns a copy of the portion of <em>string</em> that follows the next
occurrence of <em>char</em> after index <em>start</em>.  The portion copied ends
at index <em>end</em>.  If <em>char</em> is not found before <em>end</em>, a null
string is returned.
</p>
<p>The value is consed in area <em>area</em>, or in <code>default-cons-area</code>,
unless it is a null string.
<em>start</em> defaults to zero, and <em>end</em> to the length of <em>string</em>.
</p></dd></dl>

<p>See also <code>intern</code> (<a href="#intern_002dfun">intern-fun</a>), which given a string will return &quot;the&quot; symbol
with that print name.
</p>
<a name="I_002fO-to-Strings"></a>
<h3 class="section">9.5 I/O to Strings</h3>

<p>The special forms in this section allow you to create I/O streams that
input from or output to the contents of a string.
See <a href="#streams">streams</a> for documentation of I/O streams.
</p>
<a name="with_002dinput_002dfrom_002dstring_002dfun"></a><dl>
<dt><a name="index-with_002dinput_002dfrom_002dstring"></a>Special Form: <strong>with-input-from-string</strong> <em>(var string [index] [limit]) body...</em></dt>
<dd><p>The form
</p><div class="lisp">
<pre class="lisp">(with-input-from-string (<em>var</em> <em>string</em>)
    <em>body</em>)
</pre></div>
<p>evaluates the forms in <em>body</em> with the variable <em>var</em> bound to a stream
which reads characters from the string which is the value of the form
<em>string</em>.  The value of the special form is the value of the last
form in its body.
</p>
<p>The stream is a function that only works inside the <code>with-input-from-string</code>
special form, so be careful what you do with it.
You cannot use it after control leaves the body, and you cannot nest
two <code>with-input-from-string</code> special forms and use both streams
since the special-variable bindings associated with the streams will
conflict.
</p>
<p>After <em>string</em> you may optionally specify two additional arguments.
The first is <em>index</em>:
</p><div class="lisp">
<pre class="lisp">(with-input-from-string (<em>var</em> <em>string</em> <em>index</em>)
    <em>body</em>)
</pre></div>
<p>uses <em>index</em> as the starting index into the string, and sets <em>index</em>
to the index of the first character not read when <code>with-input-from-string</code>
returns.  If the whole string is read, <em>index</em> will be set to the
length of the string.  Since it is
updated, <em>index</em> may not be a general expression; it must be a variable
or a <code>setf</code>-able reference.  <em>index</em> is not updated
in the event of an abnormal exit from the body, such as a <code>*throw</code>.
The value of <em>index</em> is not updated until <code>with-input-from-string</code>
returns, so you can&rsquo;t use its value within the body to see how far
the reading has gotten.
</p>
<p>Currently, use of the <em>index</em> feature prevents multiple values from being
returned out of the body.
</p>
<div class="lisp">
<pre class="lisp">(with-input-from-string (<em>var</em> <em>string</em> <em>index</em> <em>limit</em>)
    <em>body</em>)
</pre></div>
<p>uses the value of the form <em>limit</em>, if the value is not <code>nil</code>, in
place of the length of the string.  If you want to specify a <em>limit</em>
but not an <em>index</em>, write <code>nil</code> for <em>index</em>.
</p></dd></dl>

<a name="with_002doutput_002dto_002dstring_002dfun"></a><dl>
<dt><a name="index-with_002doutput_002dto_002dstring"></a>Special Form: <strong>with-output-to-string</strong> <em>(var [string] [index]) body...</em></dt>
<dd><p>This special form provides a variety of ways to send output to a string
through an I/O stream.
</p>
<div class="lisp">
<pre class="lisp">(with-output-to-string (<em>var</em>)
  <em>body</em>)
</pre></div>
<p>evaluates the forms in <em>body</em> with <em>var</em> bound to a stream
which saves the characters output to it in a string.  The value of
the special form is the string.
</p>
<div class="lisp">
<pre class="lisp">(with-output-to-string (<em>var</em> <em>string</em>)
  <em>body</em>)
</pre></div>
<p>will append its output to the string which is the value of the form <em>string</em>.
(This is like the <code>string-nconc</code> function; see <a href="#string_002dnconc_002dfun">string-nconc-fun</a>.)
The value returned is the value of the last form in the body, rather than the string.
Multiple values are not returned.  <em>string</em> must have an array-leader;
element 0 of the array-leader will be used as the fill-pointer.
If <em>string</em>
is too small to contain all the output, <code>adjust-array-size</code> will be used to
make it bigger.
</p>
<div class="lisp">
<pre class="lisp">(with-output-to-string (<em>var</em> <em>string</em> <em>index</em>)
  <em>body</em>)
</pre></div>
<p>is similar to the above except that <em>index</em> is a variable or <code>setf</code>-able
reference which contains the index of the next character to be stored into.
It must be initialized outside the <code>with-output-to-string</code> and will be updated
upon normal exit.
The value of <em>index</em> is not updated until <code>with-output-to-string</code>
returns, so you can&rsquo;t use its value within the body to see how far
the writing has gotten.  The presence of <em>index</em> means that <em>string</em>
is not required to have a fill-pointer; if it does have one it will be updated.
</p>
<p>The stream is a &quot;downward closure&quot; simulated with special variables,
so be careful what you do with it.
You cannot use it after control leaves the body, and you cannot nest
two <code>with-output-to-string</code> special forms and use both streams
since the special-variable bindings associated with the streams will
conflict.
</p></dd></dl>

<p>It is OK to use a <code>with-input-from-string</code> and <code>with-output-to-string</code>
nested within one another, so long as there is only one of each.
</p>
<p>Another way of doing output to a string is to use the <code>format</code> facility
(see <a href="#format_002dfun">format-fun</a>).
</p>
<a name="g_t_0022Maclisp_002dCompatible-Functions_0022"></a>
<h3 class="section">9.6 &quot;Maclisp-Compatible Functions&quot;</h3>

<p>The following functions are provided primarily for Maclisp compatibility.
</p>
<a name="alphalessp_002dfun"></a><dl>
<dt><a name="index-alphalessp"></a>Function: <strong>alphalessp</strong> <em>string1 string2</em></dt>
<dd><p><code>(alphalessp <em>string1 string2</em>)</code> is equivalent to
<code>(string-lessp <em>string1 string2</em>)</code>.
</p></dd></dl>

<a name="getchar_002dfun"></a><dl>
<dt><a name="index-getchar"></a>Function: <strong>getchar</strong> <em>string index</em></dt>
<dd><p>Returns the <em>index</em>th character of <em>string</em>
as a symbol.  Note that 1-origin indexing is used.  This function
is mainly for Maclisp compatibility; <code>aref</code> should be used
to index into strings (but <code>aref</code> will not coerce symbols
or numbers into strings).
</p></dd></dl>

<a name="getcharn_002dfun"></a><dl>
<dt><a name="index-getcharn"></a>Function: <strong>getcharn</strong> <em>string index</em></dt>
<dd><p>Returns the <em>index</em>th character of <em>string</em>
as a fixnum.  Note that 1-origin indexing is used.  This function
is mainly for Maclisp compatibility; <code>aref</code> should be used
to index into strings (but <code>aref</code> will not coerce symbols
or numbers into strings).
</p></dd></dl>

<a name="ascii_002dfun"></a><dl>
<dt><a name="index-ascii"></a>Function: <strong>ascii</strong> <em>x</em></dt>
<dd><p><code>ascii</code> is like <code>character</code>, but returns a symbol
whose printname is the character instead of returning a fixnum.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(ascii 101) =&gt; A
(ascii 56) =&gt; /.
</pre></div>
<p>The symbol returned is interned in the current package (see <a href="#package">package</a>).
</p></dd></dl>

<a name="maknam_002dfun"></a><dl>
<dt><a name="index-maknam"></a>Function: <strong>maknam</strong> <em>char-list</em></dt>
<dd><p><code>maknam</code> returns
an uninterned symbol whose print-name is a string made up of the characters in <em>char-list</em>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(maknam '(a b #/0 d)) =&gt; ab0d
</pre></div>
</dd></dl>

<a name="implode_002dfun"></a><dl>
<dt><a name="index-implode"></a>Function: <strong>implode</strong> <em>char-list</em></dt>
<dd><p><code>implode</code> is like <code>maknam</code> except that the returned symbol
is interned in the current package.
</p></dd></dl>

<p>The <code>samepnamep</code> function is also provided; see <a href="#samepnamep_002dfun">samepnamep-fun</a>.
</p>
<a name="Functions-1"></a>
<h2 class="chapter">10 Functions</h2>
<a name="index-function"></a>
<a name="index-definition"></a>
<a name="function_002dfunctions"></a><a name="function_002dchapter"></a>
<p>Functions are the basic building blocks of Lisp programs.  This chapter
describes the functions in Zetalisp that are used to manipulate
functions.  It also explains how to manipulate special forms and macros.
</p>
<p>This chapter contains internal details intended for those writing programs
to manipulate programs as well as material suitable for the beginner.
Feel free to skip sections that look complicated or uninteresting
when reading this for the first time.
</p>
<a name="What-Is-a-Function_003f"></a>
<h3 class="section">10.1 What Is a Function?</h3>

<p>There are many different kinds of functions in Zetalisp.  Here
are the printed representations of examples of some of them:
</p><div class="lisp">
<pre class="lisp">foo
(lambda (x) (car (last x)))
(named-lambda foo (x) (car (last (x))))
(subst (x) (car (last x)))
#&lt;dtp-fef-pointer append 1424771&gt;
#&lt;dtp-u-entry last 270&gt;
#&lt;dtp-closure 1477464&gt;
</pre></div>
<p>We will examine these and other types of functions in detail later in this chapter.
There is one thing they all have in common:  a function is a Lisp object
that can be applied to arguments.  All of the above objects may be
applied to some arguments and will return a value.  Functions are Lisp
objects and so can be manipulated in all the usual ways; you can pass
them as arguments, return them as values, and make other Lisp objects
refer to them.
</p>
<a name="Function-Specs"></a>
<h3 class="section">10.2 Function Specs</h3>
<a name="function_002dspec"></a><a name="index-function-spec"></a>

<p>The name of a function does not have to be a symbol.  Various kinds of
lists describe other places where a function can be found.  A Lisp
object that describes a place to find a function is called a <em>function spec</em>.
(&quot;Spec&quot; is short for &quot;specification&quot;.)
Here are the printed representations of some typical function specs:
</p><div class="lisp">
<pre class="lisp">foo
(:property foo bar)
(:method tv:graphics-mixin :draw-line)
(:internal foo 1)
(:within foo bar)
(:location #&lt;dtp-locative 7435216&gt;)
</pre></div>

<p>Function specs have two purposes: they specify a place to <em>remember</em> a
function, and they serve to <em>name</em> functions.  The most common kind of
function spec is a symbol, which specifies that the function cell
of the symbol is the place to remember the function.  We will see all the
kinds of function spec, and what they mean, shortly.  Function specs are
not the same thing as functions.  You cannot, in general, apply a
function spec to arguments.  The time to use a function spec is when
you want to <em>do</em> something to the function, such as define it,
look at its definition, or compile it.
</p>
<p>Some kinds of functions remember their own names, and some don&rsquo;t.  The
&quot;name&quot; remembered by a function can be any kind of function spec,
although it is usually a symbol.  In the examples of functions in the
previous section, the one starting with the symbol <code>named-lambda</code>, the
one whose printed representation included <code>dtp-fef-pointer</code>, and the
<code>dtp-u-entry</code> remembered names (the function specs <code>foo</code>,
<code>append</code>, and <code>last</code> respectively).  The others didn&rsquo;t remember
their names.
</p>
<p>To <em>define a function spec</em> means to make that function spec remember
a given function.  This is done with the <code>fdefine</code> function; you give
<code>fdefine</code> a function spec and a function, and <code>fdefine</code> remembers
the function in the place specified by the function spec.  The function
associated with a function spec is called the <em>definition</em> of the
function spec.  A single function can be
the definition of more than one function spec at the same time, or of no
function specs.
</p>
<p>To <em>define a function</em> means to create a new function and define a
given function spec as that new function.  This is what the <code>defun</code>
special form does.  Several other special forms, such as <code>defmethod</code>
(<a href="#defmethod_002dfun">defmethod-fun</a>) and <code>defselect</code> (<a href="#defselect_002dfun">defselect-fun</a>), do this too.
</p>
<p>These special forms that define functions usually take a function spec,
create a function whose name is that function spec, and then define that
function spec to be the newly-created function.  Most function
definitions are done this way, and so usually if you go to a function
spec and see what function is there, the function&rsquo;s name will be the
same as the function spec.  However, if you define a function named
<code>foo</code> with <code>defun</code>, and then define the symbol <code>bar</code> to be this
same function, the name of the function is unaffected; both <code>foo</code> and
<code>bar</code> are defined to be the same function, and the name of that
function is <code>foo</code>, not <code>bar</code>.
</p>
<a name="index-basic-definition"></a>
<a name="index-encapsulation"></a>
<p>A function spec&rsquo;s definition in general consists of a <em>basic
definition</em> surrounded by <em>encapsulations</em>.  Both the basic
definition and the encapsulations are functions, but of recognizably
different kinds.  What <code>defun</code> creates is a basic definition, and
usually that is all there is.  Encapsulations are made by
function-altering functions such as <code>trace</code>, <code>breakon</code> and <code>advise</code>.  When the
function is called, the entire definition, which includes the tracing
and advice, is used.  If the function is &quot;redefined&quot; with <code>defun</code>,
only the basic definition is changed; the encapsulations are left in
place.  See the section on encapsulations, <a href="#encapsulate">encapsulate</a>.
</p>
<p>A function spec is a Lisp object of one of the following types:
</p><dl compact="compact">
<dt><code><em>a symbol</em></code></dt>
<dd><p>The function is remembered in the function cell of the symbol. See
<a href="#fsymeval_002dfun">fsymeval-fun</a> for an explanation of function cells and the primitive
functions to manipulate them. 
</p>
</dd>
<dt><code>(:property <em>symbol</em> <em>property</em>)</code></dt>
<dd><p>The function is remembered on the property list of the symbol; doing
<code>(get <em>symbol</em> <em>property</em>)</code> returns the function.  Storing
functions on property lists is a frequently-used technique for
dispatching (that is, deciding at run-time which function to call, on
the basis of input data).
</p>
<a name="method_002dfunction_002dspec"></a></dd>
<dt><code>(:method <em>flavor-name</em> <em>operation</em>)</code></dt>
<dt><code>(:method <em>flavor-name</em> <em>method-type</em> <em>operation</em>)</code></dt>
<dt><code>(:method <em>flavor-name</em> <em>method-type</em> <em>operation</em> <em>suboperation</em>)</code></dt>
<dd><p>The function is remembered inside internal data structures of the
flavor system and is called automatically as part of handling the
operation <em>operation</em> on instances of <em>flavor-name</em>.  See the
chapter on flavors (<a href="#flavor">flavor</a>) for details.
</p>
</dd>
<dt><code>(:handler <em>flavor-name</em> <em>operation</em>)</code></dt>
<dd><p>This is a name for the function actually called when an <em>operation</em> message
is sent to an instance of the flavor <em>flavor-name</em>.  The difference
between <code>:handler</code> and <code>:method</code> is that the handler may be a method
inherited from some other flavor or a <em>combined method</em> automatically
written by the flavor system.  Methods are what you define in source files;
handlers are not.  Note that redefining or encapsulating a handler affects
only the named flavor, not any other flavors built out of it.  Thus
<code>:handler</code> function specs are often used with <code>trace</code>
(see <a href="#trace_002dfun">trace-fun</a>), <code>breakon</code> (<a href="#breakon_002dfun">breakon-fun</a>), and <code>advise</code> (<a href="#advise_002dfun">advise-fun</a>).
</p>
<a name="select_002dmethod_002dfunction_002dspec"></a></dd>
<dt><code>(:select-method <em>function-spec</em> <em>operation</em>)</code></dt>
<dd><p>This function spec assumes that the definition of <em>function-spec</em> is
a select-method object (see <a href="#select_002dmethod">select-method</a>) containing an alist
of operation names and functions to handle them, and refers to one
particular element of that alist: the one for operation <em>operation</em>.
</p>
<p>The function is remembered in that alist element and is called when
<em>function-spec</em>&rsquo;s definition is called with first argument
<em>operation</em>.
</p>
<p><code>:select-method</code> function specs are most often used implicitly
through <code>defselect</code>.  One of the things done by
</p><div class="lisp">
<pre class="lisp">(defselect foo
  (:win (x) (cons 'win x))
  ...)
</pre></div>
<p>is to define the function spec <code>(:select-method foo :win)</code>.
</p>
</dd>
<dt><code>(:lambda-macro <em>name</em>)</code></dt>
<dd><p>This is a name for the function that expands the lambda macro <em>name</em>.
</p>
</dd>
<dt><code>(:location <em>pointer</em>)</code></dt>
<dd><p>The function is stored in the cdr of <em>pointer</em>, which may be a locative
or a list.  This is for pointing at an arbitrary place
that there is no other way to describe.  This form of function spec
isn&rsquo;t useful in <code>defun</code> (and related special forms) because the
reader has no printed representation for locative pointers and always
creates new lists; these function specs are intended for programs
that manipulate functions (see <a href="#programs_002dthat_002dmanipulate_002dfunctions">programs-that-manipulate-functions</a>).
</p>
</dd>
<dt><code>(:within <em>within-function</em> <em>function-to-affect</em>)</code></dt>
<dd><p>This refers to the meaning of the symbol <em>function-to-affect</em>, but
only where it occurs in the text of the definition of
<em>within-function</em>.  If you define this function spec as anything
but the symbol <em>function-to-affect</em> itself, then that symbol is
replaced throughout the definition of <em>within-function</em> by a new
symbol, which is then defined as you specify.  See the section on
<code>si:rename-within</code> encapsulations (<a href="#rename_002dwithin_002dsection">rename-within-section</a>) for more
information.
</p>
<p>It is rarely useful to define a <code>:within</code> function spec by hand, but
often useful to trace or advise one.  For example,
</p><div class="lisp">
<pre class="lisp">(breakon '(:within myfunction eval))
</pre></div>
<p>allows you to break when <code>eval</code> is called from <code>myfunction</code>.
Simply doing <code>(breakon 'eval)</code> will probably blow away your machine.
</p>
</dd>
<dt><code>(:internal <em>function-spec</em> <em>number</em>)</code></dt>
<dd><p>Some Lisp functions contain internal functions, created by
<code>(function (lambda ...))</code> forms.  These internal functions need names when
compiled, but they do not have symbols as names; instead they are named
by <code>:internal</code> function-specs.  <em>function-spec</em> is the name of the
containing function.  <em>number</em> is a sequence number; the first
internal function the compiler comes across in a given function will be
numbered 0, the next 1, etc.  Internal functions are remembered inside
the compiled function object of their containing function.
</p></dd>
</dl>

<p>Here is an example defining a function whose name is not a symbol:
</p><div class="lisp">
<pre class="lisp">(defun (:property foo bar-maker) (thing &amp;optional kind)
  (set-the 'bar thing (make-bar 'foo thing kind)))
</pre></div>
<p>This puts a function on <code>foo</code>&rsquo;s <code>bar-maker</code> property.  Now you can
say
</p><div class="lisp">
<pre class="lisp">(funcall (get 'foo 'bar-maker) 'baz)
</pre></div>

<p>Unlike the other kinds of function spec, a symbol <em>can</em> be used as a
function.  If you apply a symbol to arguments, the symbol&rsquo;s function
definition is used instead.  If the definition of the first symbol is
another symbol, the definition of the second symbol is used, and so on,
any number of times.  But this is an exception; in general, you can&rsquo;t
apply function specs to arguments.
</p>
<p>A keyword symbol that identifies function specs (i.e, that may appear
in the car of a list which is a function spec) is identified by a
<code>sys:function-spec-handler</code> property whose value is a function that
implements the various manipulations on function specs of that type.
The interface to this function is internal and not documented in this
manual.
</p>
<p>For compatibility with Maclisp, the function-defining special forms
<code>defun</code>, <code>macro</code>, and <code>defselect</code> (and other defining
forms built out of them, such as <code>defunp</code> and <code>defmacro</code>)
will also accept a list
</p><div class="lisp">
<pre class="lisp">(<em>symbol</em> <em>property</em>)
</pre></div>
<p>as a function name.  This is translated into
</p><div class="lisp">
<pre class="lisp">(:property <em>symbol</em> <em>property</em>)
</pre></div>

<p><em>symbol</em> must not be one of the keyword symbols that
identify a function spec, since that would be ambiguous.
</p>
<a name="Simple-Function-Definitions"></a>
<h3 class="section">10.3 Simple Function Definitions</h3>

<a name="defun_002dfun"></a><dl>
<dt><a name="index-defun"></a>Special Form: <strong>defun</strong></dt>
<dd><p><code>defun</code> is the usual way of defining a function that is part of a
program. A <code>defun</code> form looks like:
</p><div class="lisp">
<pre class="lisp">(defun <em>name</em> <em>lambda-list</em>
  <em>body</em>...)
</pre></div>

<p><em>name</em> is the function spec you wish to define as a function.
The <em>lambda-list</em> is a list of the names to give to the arguments of
the function.  Actually, it is a little more general than that; it can
contain <em>lambda-list keywords</em> such as <code>&amp;optional</code> and <code>&amp;rest</code>.
(These keywords are explained in <a href="#lambda_002dlist">lambda-list</a> and other
keywords are explained in <a href="#lambda_002dlist_002dkeywords">lambda-list-keywords</a>.)
See <a href="#additional_002ddefun_002dexplanation">additional-defun-explanation</a> for some additional syntactic features of <code>defun</code>.
</p>
<p><code>defun</code> creates a list that looks like
</p><div class="lisp">
<pre class="lisp">(named-lambda <em>name</em> <em>lambda-list body</em>...)
</pre></div>
<p>and puts it in the function cell of <em>name</em>.
<em>name</em> is now defined as a function and can be called by other forms.
</p>
<div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(defun addone (x)
  (1+ x))

(defun foo (a &amp;optional (b 5) c &amp;rest e &amp;aux j)
  (setq j (+ (addone a) b))
  (cond ((not (null c))
	 (cons j e))
	(t j))) 
</pre></div>

<p><code>addone</code> is a function which expects a number as an argument, and
returns a number one larger.  <code>foo</code> is a complicated function that
takes one required argument, two optional arguments, and any number of
additional arguments that are given to the function as a list named 
<code>e</code>.
</p>
<p>A declaration (a list starting with <code>declare</code>) can appear as the first
element of the body.  It is equivalent to a <code>local-declare</code> (see
<a href="#local_002ddeclare_002dfun">local-declare-fun</a>) surrounding the entire <code>defun</code> form.  For
example,
</p><div class="lisp">
<pre class="lisp">(defun foo (x)
  (declare (special x))
  (bar))             ;bar<span class="roman"> uses <code>x</code> free.</span>
</pre></div>
<p>is equivalent to and preferable to
</p><div class="lisp">
<pre class="lisp">(local-declare ((special x))
  (defun foo (x)
    (bar)))
</pre></div>
<p>(It is preferable because the editor expects the open parenthesis of a
top-level function definition to be the first character on a line, which
isn&rsquo;t possible in the second form without incorrect indentation.)
</p>
<p>A documentation string can also appear as the first element of the body
(following the declaration, if there is one).  (It shouldn&rsquo;t be the only
thing in the body; otherwise it is the value returned by the function
and so is not interpreted as documentation.  A string as an element of a
body other than the last element is only evaluated for side-effect, and
since evaluation of strings has no side effects, they aren&rsquo;t useful in
this position to do any computation, so they are interpreted as
documentation.)  This documentation string becomes part of the
function&rsquo;s debugging info and can be obtained with the function
<code>documentation</code> (see <a href="#documentation_002dfun">documentation-fun</a>).  The first line of the
string should be a complete sentence that makes sense read by itself,
since there are two editor commands to get at the documentation, one of
which is &quot;brief&quot; and prints only the first line.  Example:
</p><div class="lisp">
<pre class="lisp">(defun my-append (&amp;rest lists)
   &quot;Like append but copies all the lists.
This is like the Lisp function append, except that
append copies all lists except the last, whereas
this function copies all of its arguments
including the last one.&quot;
   ...)
</pre></div>
</dd></dl>

<a name="defunp_002dfun"></a><dl>
<dt><a name="index-defunp"></a>Macro: <strong>defunp</strong></dt>
<dd><p>Usually when a function uses <code>prog</code>, the <code>prog</code> form is
the entire body of the function; the definition of such a function
looks like <code>(defun <em>name</em> <em>arglist</em> (prog <em>varlist</em> ...))</code>.
Although the use of <code>prog</code> is generally discouraged, <code>prog</code> fans
may want to use this special form.
For convenience, the <code>defunp</code> macro can be used to produce such definitions.
A <code>defunp</code> form such as
</p><div class="lisp">
<pre class="lisp">(defunp fctn (args)
    form1
    form2
    ...
    formn)
</pre></div>
<p>expands into
</p><div class="lisp">
<pre class="lisp">(defun fctn (args)
  (prog ()
	form1
	form2
	...
	(return formn)))
</pre></div>

<p>You can think of <code>defunp</code> as being like <code>defun</code> except that you can
<code>return</code> out of the middle of the function&rsquo;s body.
</p></dd></dl>

<p>For more information on defining functions, and other ways of doing so,
see <a href="#function_002ddefining">function-defining</a>.
</p>
<a name="User-Operations-on-Functions"></a>
<h3 class="section">10.4 User Operations on Functions</h3>

<p>Here is a list of the various things a user (as opposed to a program) is
likely to want to do to a function.  In all cases, you specify a
function spec to say where to find the function.
</p>
<p>To print out the definition of the function spec with indentation to
make it legible, use <code>grindef</code> (see <a href="#grindef_002dfun">grindef-fun</a>).  This works only
for interpreted functions.  If the definition is a compiled function, it
can&rsquo;t be printed out as Lisp code, but its compiled code can be printed
by the <code>disassemble</code> function (see <a href="#disassemble_002dfun">disassemble-fun</a>).
</p>
<p>To find out about how to call the function, you can ask to see its
documentation or its argument names.  (The argument names are usually
chosen to have mnemonic significance for the caller).  Use <code>arglist</code>
(<a href="#arglist_002dfun">arglist-fun</a>) to see the argument names and <code>documentation</code>
(<a href="#documentation_002dfun">documentation-fun</a>) to see the documentation string.  There are also
editor commands for doing these things: the <code>Control-Shift-D</code> and
<code>Meta-Shift-D</code> commands are for looking at a function&rsquo;s documentation,
and <code>Control-Shift-A</code> is for looking at an argument list.
</p>
<p><code>Control-Shift-A</code> and <code>Control-Shift-D</code> do not ask for the function
name; they act on the function that is called by the innermost
expression which the cursor is inside.  Usually this is the function
that will be called by the form you are in the process of writing.
They are available in the rubout handler as well.
</p>
<p>You can see the function&rsquo;s debugging info alist by means of the function
<code>debugging-info</code> (see <a href="#debugging_002dinfo_002dfun">debugging-info-fun</a>).
</p>
<p>When you are debugging, you can use <code>trace</code> (see <a href="#trace_002dfun">trace-fun</a>) to
obtain a printout or a break loop whenever the function is called.  You
can use <code>breakon</code> (see <a href="#breakon_002dfun">breakon-fun</a>) to cause the error handler to
be entered whenever the function is called; from there, you can step
through further function calls and returns.  You can customize the
definition of the function, either temporarily or permanently, using
<code>advise</code> (see <a href="#advise_002dfun">advise-fun</a>).
</p>
<a name="Kinds-of-Functions"></a>
<h3 class="section">10.5 Kinds of Functions</h3>
<a name="kinds_002dof_002dfunctions"></a>
<p>There are many kinds of functions in Zetalisp.  This section
briefly describes each kind of function.  Note that a function is also a
piece of data and can be passed as an argument, returned, put in a list,
and so forth.
</p>
<p>There are four kinds of functions, classified by how they work.
</p>
<p>First, there are <em>interpreted</em> functions: you define them with
<code>defun</code>, they are represented as list structure, and they are
interpreted by the Lisp evaluator.
</p>
<p>Secondly, there are <em>compiled</em> functions: they are defined
by <code>compile</code> or by loading a QFASL file, they are represented by a
special Lisp data type, and they are executed directly by the microcode.
Similar to compiled functions are microcode functions, which are written
in microcode (either by hand or by the micro-compiler) and executed directly
by the hardware.
</p>
<p>Thirdly, there are various types of Lisp object that can be applied to
arguments, but when they are applied they dig up another function
somewhere and apply it instead.  These include <code>dtp-select-method</code>,
closures, instances, and entities.
</p>
<p>Finally, there are various types of Lisp object that, when used as
functions, do something special related to the specific data type.
These include arrays and stack-groups.
</p>
<a name="g_t_0022Interpreted-Functions_0022"></a>
<h4 class="subsection">10.5.1 &quot;Interpreted Functions&quot;</h4>

<p>An interpreted function is a piece of list structure that represents a
program according to the rules of the Lisp interpreter.  Unlike other
kinds of functions, interpreted functions can be printed out and read
back in (they have a printed representation that the reader understands),
can be pretty-printed (see <a href="#grindef_002dfun">grindef-fun</a>), and can be
examined with the usual functions for list-structure manipulation.
</p>
<p>There are four kinds of interpreted functions: <code>lambda</code>s,
<code>named-lambda</code>s, <code>subst</code>s, and <code>named-subst</code>s.  A <code>lambda</code> function is the
simplest kind.  It is a list that looks like this:
</p><div class="lisp">
<pre class="lisp">(lambda <em>lambda-list</em> <em>form1</em> <em>form2</em>...)
</pre></div>
<p>The symbol <code>lambda</code> identifies this list as a <code>lambda</code>
function.  <em>lambda-list</em> is a description of what arguments the
function takes; see <a href="#lambda_002dlist">lambda-list</a> for details.  The <em>forms</em>
make up the body of the function.  When the function is called,
the argument variables are bound to the values of the arguments
as described by <em>lambda-list</em>, and then the forms in the body are
evaluated, one by one.  The value of the function is the value of its
last form.
</p>
<p>A <code>named-lambda</code> is like a <code>lambda</code> but contains an extra element in
which the system remembers the function&rsquo;s name, documentation, and other
information.  Having the function&rsquo;s name there allows the error handler
and other tools to give the user more information.  You would not
normally write a <code>named-lambda</code> yourself; <code>named-lambda</code> exists so
that <code>defun</code> can use it.  A <code>named-lambda</code> function looks like this:
</p><div class="lisp">
<pre class="lisp">(named-lambda <em>name</em> <em>lambda-list</em> <em>body forms</em>...)
</pre></div>
<p>If the <em>name</em> slot contains a symbol, it is the function&rsquo;s name.
Otherwise it is a list whose car is the name and whose cdr is the
function&rsquo;s debugging information alist.  See <code>debugging-info</code>,
<a href="#debugging_002dinfo_002dfun">debugging-info-fun</a>.  Note that the name need not be a symbol;
it can be any function spec.  For example,
</p><div class="lisp">
<pre class="lisp">(defun (foo bar) (x)
  (car (reverse x)))
</pre></div>
<p>will give <code>foo</code> a <code>bar</code> property whose value is
</p><div class="lisp">
<pre class="lisp">(named-lambda ((:property foo bar)) (x) (car (reverse x)))
</pre></div>

<a name="subst"></a><a name="index-subst"></a>
<p>A <code>subst</code> is just like a <code>lambda</code> as far as the interpreter is concerned.
It is a list that looks like this:
</p><div class="lisp">
<pre class="lisp">(subst <em>lambda-list</em> <em>form1</em> <em>form2</em>...)
</pre></div>
<p>The difference between a <code>subst</code> and a <code>lambda</code> is the way they are
handled by the compiler.  A call to a normal function is compiled as a
<em>closed subroutine</em>; the compiler generates code to compute the
values of the arguments and then apply the function to those values.  A
call to a <code>subst</code> is compiled as an <em>open subroutine</em>; the compiler
incorporates the body forms of the <code>subst</code> into the function being
compiled, substituting the argument forms for references to the
variables in the <code>subst</code>&rsquo;s <em>lambda-list</em>.  This is a simple-minded
but useful facility for <em>open</em> or <em>in-line coded</em> functions.
It is simple-minded because the argument forms can be evaluated multiple
times or out of order, and so the semantics of a <code>subst</code> may not be the
same in the interpreter and the compiler.  <code>subst</code>s are described more fully on
<a href="#defsubst_002dfun">defsubst-fun</a>, with the explanation of <code>defsubst</code>.
</p>
<a name="index-named_002dsubst"></a>
<p>A <code>named-subst</code> is the same as a <code>subst</code> except that it has a name
just as a <code>named-lambda</code> does.  It looks like
</p><div class="lisp">
<pre class="lisp">(named-subst <em>name</em> <em>lambda-list</em> <em>form1</em> <em>form2</em> ...)
</pre></div>
<p>where <em>name</em> is interpreted the same way as in a <code>named-lambda</code>.
</p>
<a name="g_t_0022Lambda-Macros_0022"></a>
<h4 class="subsection">10.5.2 &quot;Lambda Macros&quot;</h4>
<a name="lambda_002dmacro_002dsection"></a>
<p>Lambda macros may appear in functions where <code>lambda</code> would have
previously appeared.  When the compiler or interpreter detects a
function whose car is a lambda macro, they &quot;expand&quot; the macro in much
the same way that ordinary Lisp macros are expanded&ndash;the lambda
macro is called with the function as its argument and is expected to
return another function as its value.  The definition of a lambda macro
(that is, the function which expands it) may be accessed with the
(<code>:lambda-macro</code> <em>name</em>) function spec.
</p>
<p>The value returned by the lambda macro expander function may be any
valid function.  Usually it is a list starting with <code>lambda</code>,
<code>subst</code>, <code>named-lambda</code> or <code>named-subst</code>, but it could
also be another use of a lambda macro, or even a compiled function.
</p>
<a name="lambda_002dmacro_002dfun"></a><dl>
<dt><a name="index-lambda_002dmacro"></a>Special Form: <strong>lambda-macro</strong> <em>name lambda-list &amp;body body</em></dt>
<dd><p>Analogously with <code>macro</code>, defines a lambda macro to be called
<em>name</em>. <em>lambda-list</em> should consist of one variable, which
will be the function that caused the lambda macro to be called.  The
lambda macro must return a function.  For example:
</p>
<div class="lisp">
<pre class="lisp">(lambda-macro ilisp (x)
  `(lambda (&amp;optional ,@(second x) &amp;rest ignore) . ,(cddr x)))
</pre></div>

<p>defines a lambda macro called <code>ilisp</code> which can be used to define functions
that accept arguments like a standard Interlisp function: all
arguments are optional and extra arguments are ignored.  A typical use
would be:
</p>
<div class="lisp">
<pre class="lisp">(fun-with-functional-arg #'(ilisp (x y z) (list x y z)))
</pre></div>

<p>This passes to <code>fun-with-functional-arg</code> a function which will ignore
extra arguments beyond the third, and will default <code>x</code>, <code>y</code> and
<code>z</code> to <code>nil</code>.
</p></dd></dl>

<a name="deflambda_002dmacro_002dfun"></a><dl>
<dt><a name="index-deflambda_002dmacro"></a>Special Form: <strong>deflambda-macro</strong></dt>
<dd><p><code>deflambda-macro</code> is like <code>defmacro</code>, but defines a lambda macro
instead of a normal macro.  Here is how <code>ilisp</code> could be defined
using <code>deflambda-macro</code>:
</p><div class="lisp">
<pre class="lisp">(deflambda-macro ilisp (argument-list &amp;body body)
  `(lambda (&amp;optional ,@argument-list &amp;rest ignore) . ,body))
</pre></div>
</dd></dl>

<a name="deflambda_002dmacro_002ddisplace_002dfun"></a><dl>
<dt><a name="index-deflambda_002dmacro_002ddisplace"></a>Special Form: <strong>deflambda-macro-displace</strong></dt>
<dd><p><code>deflambda-macro-displace</code> is like <code>defmacro-displace</code>, but defines
a lambda macro instead of a normal macro.
</p></dd></dl>

<a name="deffunction_002dfun"></a><dl>
<dt><a name="index-deffunction"></a>Special Form: <strong>deffunction</strong> <em>function-spec lambda-macro-name lambda-list &amp;body body </em></dt>
<dd><p><code>deffunction</code> defines a function with a definition that uses an
arbitrary lambda macro instead of <code>lambda</code>.  It takes arguments like
<code>defun</code>, expect that the argument immediatly following the function
specifier is the name of the lambda macro to be used.  <code>deffunction</code>
expands the lambda macro immediatly, so the lambda macro must have
been previously defined.
</p>
<p>For example:
</p>
<div class="lisp">
<pre class="lisp">(deffunction some-interlisp-like-function ilisp (x y z)
  (list x y z))
</pre></div>

<p>would define a function called <code>some-interlisp-like-function</code>
with the definition <code>(ilisp (x y z) (list x y z))</code>.
</p>
<p><code>(defun foo ...)</code> could be considered an abbreviation for
<code>(deffunction foo lambda ...)</code>
</p></dd></dl>

<a name="g_t_0022Compiled-Functions_0022"></a>
<h4 class="subsection">10.5.3 &quot;Compiled Functions&quot;</h4>
<a name="index-function-entry-frame"></a>
<a name="index-FEF"></a>

<p>There are two kinds of compiled functions: <em>macrocoded</em> functions
and <em>microcoded</em> functions.  The Lisp compiler converts <code>lambda</code>
and <code>named-lambda</code> functions into macrocoded functions.  A
macrocoded function&rsquo;s printed representation looks like:
</p><div class="lisp">
<pre class="lisp">#&lt;dtp-fef-pointer append 1424771&gt;
</pre></div>
<p>This type of Lisp object is also called a &quot;Function Entry Frame&quot;, or
&quot;FEF&quot; for short.  Like &quot;car&quot; and &quot;cdr&quot;, the name is historical in origin
and doesn&rsquo;t really mean anything.  The object contains Lisp Machine
machine code that does the computation expressed by the function; it
also contains a description of the arguments accepted, any constants
required, the name, documentation, and other things.  Unlike Maclisp
&quot;subr-objects&quot;, macrocoded functions are full-fledged objects and
can be passed as arguments, stored in data structure, and applied to arguments.
</p>
<p>The printed representation of a microcoded function looks like:
</p><div class="lisp">
<pre class="lisp">#&lt;dtp-u-entry last 270&gt;
</pre></div>
<p>Most microcompiled functions are basic Lisp primitives or subprimitives
written in Lisp Machine microcode.  You can also convert your own
macrocode functions into microcode functions in some circumstances,
using the micro-compiler.
</p>
<a name="g_t_0022Other-Kinds-of-Functions_0022"></a>
<h4 class="subsection">10.5.4 &quot;Other Kinds of Functions&quot;</h4>

<p>A closure is a kind of function that contains another function and a
set of special variable bindings.  When the closure is applied, it
puts the bindings into effect and then applies the other function.  When
that returns, the closure bindings are removed.  Closures are made with
the function <code>closure</code>.  See <a href="#closure">closure</a> for more information.
Entities are slightly different from closures; see <a href="#entity">entity</a>.
</p>
<a name="select_002dmethod"></a><p>A select-method (<code>dtp-select-method</code>) is an alist of symbols and
functions.  When one is called the first argument is looked up in the
alist to find the particular function to be called.  This function is
applied to the rest of the arguments.  The alist may have a list of
symbols in place of a symbol, in which case the associated function is
called if the first argument is any of the symbols on the list.  If
<code>cdr</code> of <code>last</code> of the alist is not <code>nil</code>, it is a <em>default
handler</em> function, which gets called if the message key is not found
in the alist.  Select-methods can be created with the <code>defselect</code>
special form (see <a href="#defselect_002dfun">defselect-fun</a>).  If the select-method is the
definition of a function-spec, the individual functions in the alist
can be referred to using <code>:select-method</code> function specs (see
<a href="#select_002dmethod_002dfunction_002dspec">select-method-function-spec</a>).
</p>
<p>An instance is a message-receiving object that has both a state and a table
of message-handling functions (called <em>methods</em>).  Refer to the chapter
on flavors (<a href="#flavor">flavor</a>) for further information.
</p>
<p>An array can be used as a function.  The arguments to the array are
the indices and the value is the contents of the element of the
array.  This works this way for Maclisp compatibility and is not recommended usage.
Use <code>aref</code> (<a href="#aref_002dfun">aref-fun</a>) instead.
</p>
<p>A stack group can be called as a function.  This is one way to pass control
to another stack group.  See <a href="#stack_002dgroup">stack-group</a>.
</p>
<a name="g_t_0022Special-Forms-and-Functions_0022"></a>
<h4 class="subsection">10.5.5 &quot;Special Forms and Functions&quot;</h4>
<a name="index-special-forms"></a>

<p>The special forms of Zetalisp, such as <code>quote</code>, <code>let</code> and
<code>cond</code>, are actually implemented with an unusual sort of function.
</p>
<p>First, let&rsquo;s restate the outline of how the evaluator works.  When the
evaluator is given a list whose first element is a symbol, the form may
be a function form, a special form, or a macro form (see
<a href="#description_002dof_002devaluation">description-of-evaluation</a>).  If the definition of the symbol is a
function, then the function is just applied to the result of evaluating
the rest of the subforms.  If the definition is a cons whose car is
<code>macro</code>, then it is a macro form; these are explained in <a href="#macro">macro</a>.
What about special forms?
</p>
<a name="special_002dfunction"></a><p>A special form is implemented by a function that is flagged to tell
the evaluator to refrain from evaluating some or all of the arguments
to the function.  Such functions make use of the lambda-list
keyword <code>&amp;quote</code>.
</p>
<p>The evaluator, on seeing the <code>&amp;quote</code> in the lambda list of an
interpreted function (or something equivalent in a compiled function)
skips the evaluation of the arguments to which the <code>&amp;quote</code>
applies.  Aside from that, it calls the function normally.
</p>
<p>For example, <code>quote</code> could be defined as
</p><div class="lisp">
<pre class="lisp">(defun quote (&amp;quote arg) arg)
</pre></div>
<p>Evaluation of <code>(quote x)</code> would see the <code>&amp;quote</code> in the
definition, applying to the first argument, so it would refrain from
evaluating that argument and would pass the function definition of
<code>quote</code> the object <code>x</code> rather than the value of <code>x</code>.
From then on, the definition of <code>quote</code> executed in the normal
fashion, so it returns <code>x</code>.
</p>
<p><code>&amp;quote</code> applies to all the following arguments, but it can be
cancelled with <code>&amp;eval</code>.  A simple <code>setq</code> that accepted only one
variable and one value could be defined as follows:
</p><div class="lisp">
<pre class="lisp">(defun setq (&amp;quote variable &amp;eval value)
  (set variable value))
</pre></div>
<p>The actual definition of <code>setq</code> is more complicated and uses
a lambda list <code>(&amp;quote &amp;rest variables-and-values)</code>.  Then it must
go through the rest-argument, evaluating every other element.
</p>
<p>The definitions of special forms are designed with the assumption that
they will be called by <code>eval</code>.  It does not usually make much sense to
call one with <code>funcall</code> or <code>apply</code>.  <code>apply</code> does not evaluate any
arguments; its second argument is composed of <em>values</em> of arguments
rather than expressions for them.  So there is no way for <code>apply</code> to
refrain from evaluating them.  Most special forms explicitly call
<code>eval</code> on some of their arguments, or parts of them, and if called
with <code>apply</code> or <code>funcall</code> they will <em>still</em> do so.  This is
usually useless, so calling special forms with <code>apply</code> or <code>funcall</code>
should be avoided.  Encapsulations can do this successfully, because
they can arrange that quoted arguments are quoted also on entry to the encapsulation.
</p>
<a name="special_002dform_002dcaveat"></a>
<p>It is possible to define your own special form using <code>&amp;quote</code>.  Macros
can also be used to accomplish the same thing.  It is preferable to
implement language extensions as macros rather than special forms,
because macros directly define a Lisp-to-Lisp translation and therefore
can be understood by both the interpreter and the compiler.  Special
forms, on the other hand, only extend the interpreter.  The compiler has
to be modified in an <em>ad hoc</em> way to understand each new special form
so that code using it can be compiled.  For example, it would not work
for a compiled function to call the interpreted definition of <code>setq</code>;
the <code>set</code> in that definition would not be able to act on local
variables of the compiled function.
</p>
<p>Since all real programs are eventually compiled,
writing your own special functions is strongly discouraged.
The purpose of <code>&amp;quote</code> is to be used in the system&rsquo;s own
standard special forms.
</p>
<p>(In fact, many of the special forms in Zetalisp are actually implemented
as macros, rather than as special functions.  They&rsquo;re implemented this
way because it&rsquo;s easier to write a macro than to write both a new
special function and a new <em>ad hoc</em> module in the compiler.  However,
they&rsquo;re sometimes documented in this manual as special forms, rather
than macros, because you should not in any way <em>depend</em> on the way
they are implemented; they might be reimplemented as special
functions at any time.)
</p>
<a name="Function_002dDefining-Special-Forms"></a>
<h3 class="section">10.6 Function-Defining Special Forms</h3>
<a name="function_002ddefining"></a>
<p><code>defun</code> is a special form that is put in a program to define a
function.  <code>defsubst</code> and <code>macro</code> are others.
This section explains how these special forms work, how
they relate to the different kinds of functions, and how they interface to the
rest of the function-manipulation system.
</p>
<p>Function-defining special forms typically take as arguments a function
spec and a description of the function to be made, usually in the form
of a list of argument names and some forms that constitute the body of
the function.  They construct a function, give it the function spec as
its name, and define the function spec to be the new function.
Different special forms make different kinds of functions.  <code>defun</code>
makes a <code>named-lambda</code> function, and <code>defsubst</code> makes a <code>named-subst</code>
function.  <code>macro</code> makes a macro; though the macro definition is not
really a function, it is like a function as far as definition handling
is concerned.
</p>
<p>These special forms are used in writing programs because the function
names and bodies are constants.  Programs that define functions usually
want to compute the functions and their names, so they use <code>fdefine</code>.
See <a href="#fdefine_002dfun">fdefine-fun</a>.
</p>
<p>All of these function-defining special forms alter only the basic
definition of the function spec.  Encapsulations are preserved.
See <a href="#encapsulate">encapsulate</a>.
</p>
<p>The special forms only create interpreted functions.  There is no
special way of defining a compiled function.  Compiled functions are
made by compiling interpreted ones.  The same special form that defines
the interpreted function, when processed by the compiler, yields the
compiled function.  See <a href="#compiler">compiler</a> for details.
</p>
<p>Note that the editor understands these and other &quot;defining&quot; special forms
(e.g <code>defmethod</code>, <code>defvar</code>, <code>defmacro</code>, <code>defstruct</code>, etc.)
to some extent, so that when you ask for the definition of something, the editor
can find it in its source file and show it to you.  The general convention
is that anything that is used at top level (not inside a function)
and starts with <code>def</code> should be a special form for defining things
and should be understood by the editor.  <code>defprop</code> is an exception.
</p>

<a name="additional_002ddefun_002dexplanation"></a><p>The <code>defun</code> special form (and the <code>defunp</code> macro which expands into a
<code>defun</code>) are used for creating ordinary interpreted functions (see <a href="#defun_002dfun">defun-fun</a>).
</p>
<p>For Maclisp compatibility, a <em>type</em> symbol may be inserted between
<em>name</em> and <em>lambda-list</em> in the <code>defun</code> form.  The following types
are understood:
</p><dl compact="compact">
<dt><code>expr</code></dt>
<dd><p>The same as no type.
</p></dd>
<dt><code>fexpr</code></dt>
<dd><p><code>&amp;quote</code> and <code>&amp;rest</code> are prefixed to the lambda list.
</p></dd>
<dt><code>macro</code></dt>
<dd><p>A macro is defined instead of a normal function.
</p></dd>
</dl>

<p>If <em>lambda-list</em> is a non-<code>nil</code> symbol instead of a list,
the function is recognized as a Maclisp <em>lexpr</em> and it is converted
in such a way that the <code>arg</code>, <code>setarg</code>, and <code>listify</code> functions
can be used to access its arguments (see <a href="#arg_002dfun">arg-fun</a>).
</p>
<p>The <code>defsubst</code> special form is used to create substitutible functions.  It
is used just like <code>defun</code> but produces a list starting with <code>named-subst</code>
instead of one starting with <code>named-lambda</code>.  The <code>named-subst</code> function
acts just like the corresponding <code>named-lambda</code> function when applied,
but it can also be open-coded (incorporated into its callers) by the compiler.
See <a href="#defsubst_002dfun">defsubst-fun</a> for full information.
</p>
<p>The <code>macro</code> special form is the primitive means of creating a macro.
It gives a function spec a definition that is a macro definition rather
than a actual function.  A macro is not a function because it cannot be
applied, but it <em>can</em> appear as the car of a form to be evaluated.
Most macros are created with the more powerful <code>defmacro</code> special form.
See <a href="#macro">macro</a>.
</p>
<p>The <code>defselect</code> special form defines a select-method function.  See <a href="#defselect_002dfun">defselect-fun</a>.
</p>
<p>Unlike the above special forms, the next two (<code>deff</code> and <code>def</code>)
do not create new functions.  They simply serve as hints to the editor
that a function is being stored into a function spec here, and therefore
if someone asks for the source code of the definition of that function spec,
this is the place to look for it.
</p>
<a name="def_002dfun"></a><dl>
<dt><a name="index-def"></a>Special Form: <strong>def</strong></dt>
<dd><p>If a function is created in some strange way, wrapping a <code>def</code> special
form around the code that creates it informs the editor of the connection.
The form
</p><div class="lisp">
<pre class="lisp">(def <em>function-spec</em>
  <em>form1</em> <em>form2</em>...)
</pre></div>
<p>simply evaluates the forms <em>form1</em>, <em>form2</em>, etc.  It is assumed
that these forms will create or obtain a function somehow, and make
it the definition of <em>function-spec</em>.
</p>
<p>Alternatively, you could put <code>(def <em>function-spec</em>)</code> in
front of or anywhere near the forms which define the function.  The
editor only uses it to tell which line to put the cursor on.
</p></dd></dl>

<a name="deff_002dfun"></a><dl>
<dt><a name="index-deff"></a>Special Form: <strong>deff</strong> <em>function-spec definition-creator</em></dt>
<dd><p><code>deff</code> is a simplified version of <code>def</code>.  It
evaluates the form <em>definition-creator</em>, which should produce a function,
and makes that function the definition of <em>function-spec</em>, which is not
evaluated.  <code>deff</code>
is used for giving a function spec a definition which is not obtainable
with the specific defining forms such as <code>defun</code> and <code>macro</code>.
For example,
</p><div class="lisp">
<pre class="lisp">(deff foo 'bar)
</pre></div>
<p>will make <code>foo</code> equivalent to <code>bar</code>, with an indirection so that if
<code>bar</code> changes <code>foo</code> will likewise change;
</p><div class="lisp">
<pre class="lisp">(deff foo (function bar))
</pre></div>
<p>copies the definition of <code>bar</code> into <code>foo</code> with no indirection, so that
further changes to <code>bar</code> will have no effect on <code>foo</code>.
</p></dd></dl>

<a name="g_t_0040define_002dfun"></a><dl>
<dt><a name="index-_0040define"></a>Macro: <strong>@define</strong></dt>
<dd><p>This macro turns into <code>nil</code>, doing nothing.  It exists for the sake of the
&nbsp;listing generation program, which uses it to declare names of special forms
that define objects (such as functions) that &nbsp;should cross-reference.
</p></dd></dl>

<a name="defun_002dcompatibility_002dfun"></a><dl>
<dt><a name="index-defun_002dcompatibility"></a>Function: <strong>defun-compatibility</strong> <em>x</em></dt>
<dd><p>This function is used by <code>defun</code> and the compiler to convert
Maclisp-style lexpr, fexpr, and macro <code>defun</code>s to Zetalisp
definitions.  <em>x</em> should be the cdr of a <code>(defun ...)</code> form.
<code>defun-compatibility</code> will return a corresponding <code>(defun ...)</code> or
<code>(macro ...)</code> form, in the usual Zetalisp format.  You shouldn&rsquo;t
ever need to call this yourself.
</p></dd></dl>

<a name="defselect_002dfun"></a><dl>
<dt><a name="index-defselect"></a>Special Form: <strong>defselect</strong></dt>
<dd><p><code>defselect</code> defines a function which is a select-method.  This
function contains a table of subfunctions; when it is called, the first
argument, a symbol on the keyword package called the <em>operation</em>,
is looked up in the table to determine which subfunction to call.  Each
subfunction can take a different number of arguments and have a
different pattern of <code>&amp;optional</code> and <code>&amp;rest</code> arguments.
<code>defselect</code> is useful for a variety of &quot;dispatching&quot; jobs.  By analogy
with the more general message-passing facilities described in <a href="#flavor">flavor</a>,
the subfunctions are called <em>methods</em> and the list of arguments
is sometimes called a <em>message</em>.
</p>
<p>The special form looks like
</p><div class="lisp">
<pre class="lisp">(defselect (<em>function-spec</em> <em>default-handler</em> <em>no-which-operations</em>)
  (<em>operation</em> (<em>args...</em>)
        <em>body...</em>)
  (<em>operation</em> (<em>args...</em>)
        <em>body...</em>)
  ...)
</pre></div>

<p><em>function-spec</em> is the name of the function to be defined.
<em>default-handler</em> is optional; it must be a symbol and is a function
which gets called if the select-method is called with an unknown
operation.  If <em>default-handler</em> is unsupplied or <code>nil</code>, then an
unknown operation causes an error with condition name
<code>sys:unclaimed-message</code> (see <a href="#sys_003aunclaimed_002dmessage_002dcondition">sys:unclaimed-message-condition</a>).
</p>
<p>Normally a method for the operation <code>:which-operations</code> is generated
automatically based on the set of existing methods.  The
<code>:which-operations</code> operation takes no arguments and returns a list of
all the operations in the <code>defselect</code>.  If <em>no-which-operations</em> is
non-<code>nil</code>, no <code>:which-operations</code> method is created; however, you
can supply one yourself.
</p>
<p>If <em>function-spec</em> is a symbol, and <em>default-handler</em> and <em>no-which-operations</em>
are not supplied, then the first subform of the <code>defselect</code> may be just <em>function-spec</em>
by itself, not enclosed in a list.
</p>
<p>The remaining subforms in a <code>defselect</code> are the clauses, each
defining one method.  <em>operation</em> is the operation to be handled by
this clause or a list of several operations to be handled by the same
clause.  <em>args</em> is a lambda-list; it should not include the first
argument, which is the operation.  <em>body</em> is the body of the
function.
</p>
<p>A clause can instead look like:
</p><div class="lisp">
<pre class="lisp">  (<em>operation</em> . <em>symbol</em>)
</pre></div>
<p>In this case, <em>symbol</em> is the name of a function that is to be
called when the <em>operation</em> operation is performed.  It will be
called with the same arguments as the select-method, including the
operation symbol itself.
</p>
<p>The individual methods of the <code>defselect</code> can be examined,
redefined, traced, etc using <code>:select-method</code> function specs
(see <a href="#select_002dmethod_002dfunction_002dspec">select-method-function-spec</a>).
</p></dd></dl>


<a name="Lambda_002dList-Keywords"></a>
<h3 class="section">10.7 Lambda-List Keywords</h3>
<a name="index-lambda_002dlist-keywords"></a>
<a name="index-_0022_0026_0022-keywords"></a>
<a name="lambda_002dlist_002dkeywords"></a>
<p>This section documents all the keywords that may appear in the
&quot;lambda-list&quot; (argument list) (see <a href="#lambda_002dlist">lambda-list</a>) of a function, a
macro, or a special form.  Some of them are allowed everywhere, while
others are only allowed in one of these contexts; those are so
indicated.
</p>
<a name="lambda_002dlist_002dkeywords_002dvar"></a><dl>
<dt><a name="index-lambda_002dlist_002dkeywords"></a>Variable: <strong>lambda-list-keywords</strong></dt>
<dd><p>The value of this variable is a list of all of the allowed &quot;&amp;&quot; keywords.
Some of these are obsolete and don&rsquo;t do anything; the remaining ones
are listed below.
</p></dd></dl>

<dl compact="compact">
<dt><code>&amp;optional</code></dt>
<dd><p>Separates the required arguments of a function from the optional arguments.
See <a href="#lambda_002dlist">lambda-list</a>.
</p>
</dd>
<dt><code>&amp;rest</code></dt>
<dd><p>Separates the required and optional arguments of a function from the rest argument.
There may be only one rest argument.  See <a href="#g_t_0026rest">&amp;rest</a> for full information about
rest arguments.  See <a href="#lambda_002dlist">lambda-list</a>.
</p>
</dd>
<dt><code>&amp;key</code></dt>
<dd><p>Separates the positional arguments and rest argument of a function from the keyword
arguments.  See <a href="#lambda_002dlist">lambda-list</a>.
</p>
</dd>
<dt><code>&amp;allow-other-keys</code></dt>
<dd><p>In a function that accepts keyword arguments, says that keywords
that are not recognized are allowed.  They and the corresponding values are
ignored, as far as keyword arguments are concerned, but they do become
part of the rest argument, if there is one.
</p>
</dd>
<dt><code>&amp;aux</code></dt>
<dd><p>Separates the arguments of a function from the auxiliary variables.
Following <code>&amp;aux</code> you can put entries of the form
</p><div class="lisp">
<pre class="lisp">(<em>variable</em> <em>initial-value-form</em>)
</pre></div>
<p>or just <em>variable</em> if you want it initialized to <code>nil</code> or don&rsquo;t care what the initial
value is.
</p>
</dd>
<dt><code>&amp;special</code></dt>
<dd><p>Declares the following arguments and/or auxiliary variables to be special within
the scope of this function.
</p>
</dd>
<dt><code>&amp;local</code></dt>
<dd><p>Turns off a preceding <code>&amp;special</code> for the variables that follow.
</p>
</dd>
<dt><code>&amp;functional</code></dt>
<dd><p>Preceding an argument, tells the compiler that the value of this argument will be
a function.  When a caller of this function is compiled, if it passes a quoted
constant argument that looks like a function (a list beginning with the symbol
<code>lambda</code>), the compiler will know that it is intended to be a function rather
than a list that happens to start with that symbol, and will compile it.
</p>
</dd>
<dt><code>&amp;quote</code></dt>
<dd><p>Declares that the following arguments are not to be evaluated.  This is how you create
a special function.  See the caveats about special forms on <a href="#special_002dform_002dcaveat">special-form-caveat</a>.
</p>
</dd>
<dt><code>&amp;eval</code></dt>
<dd><p>Turns off a preceding <code>&amp;quote</code> for the arguments which follow.
</p>
</dd>
<dt><code>&amp;list-of</code></dt>
<dd><p>This is for macros defined by <code>defmacro</code> only.  Refer to <a href="#g_t_0026list_002dof">&amp;list-of</a>.
</p>
</dd>
<dt><code>&amp;body</code></dt>
<dd><p>This is for macros defined by <code>defmacro</code> only.  It is similar to <code>&amp;rest</code>,
but declares to <code>grindef</code> and the code-formatting module of the editor that
the body forms of a special form follow and should be indented accordingly.
Refer to <a href="#g_t_0026body">&amp;body</a>.
</p></dd>
</dl>


<a name="How-Programs-Manipulate-Function-Specs"></a>
<h3 class="section">10.8 How Programs Manipulate Function Specs</h3>

<a name="programs_002dthat_002dmanipulate_002dfunctions"></a>
<a name="fdefine_002dfun"></a><dl>
<dt><a name="index-fdefine"></a>Function: <strong>fdefine</strong> <em>function-spec definition &amp;optional (carefully <code>nil</code>) (no-query <code>nil</code>)</em></dt>
<dd><p>This is the primitive used by <code>defun</code> and everything else in the system
to change the definition of a function spec.  If <em>carefully</em> is
non-<code>nil</code>, which it usually should be, then only the basic definition
is changed; the previous basic definition is saved if possible (see
<code>undefun</code>, <a href="#undefun_002dfun">undefun-fun</a>), and any encapsulations of the function such
as tracing and advice are carried over from the old definition to the
new definition.  <em>carefully</em> also causes the user to be queried if the
function spec is being redefined by a file different from the one that
defined it originally.  However, this warning is suppressed if either the
argument <em>no-query</em> is non-<code>nil</code>, or if the global variable
<code>inhibit-fdefine-warnings</code> is <code>t</code>.
</p>
<p>If <code>fdefine</code> is called while a file is being loaded, it records what
file the function definition came from so that the editor can find the
source code.
</p>
<p>If <em>function-spec</em> was already defined as a function, and
<em>carefully</em> is non-<code>nil</code>, the function-spec&rsquo;s
<code>:previous-definition</code> property is used to save the previous
definition.  This property is used by the <code>undefun</code> function
(<a href="#undefun_002dfun">undefun-fun</a>), which restores the previous definition.  The
properties for different kinds of function specs are stored in different
places; when a function spec is a symbol its properties are stored on
the symbol&rsquo;s property list.
</p>
<p><code>defun</code> and the other function-defining special forms all supply <code>t</code>
for <em>carefully</em> and <code>nil</code> or nothing for <em>no-query</em>.  Operations
that construct encapsulations, such as <code>trace</code>, are the only ones
which use <code>nil</code> for <em>carefully</em>.
</p></dd></dl>

<a name="si_003arecord_002dsource_002dfile_002dname_002dfun"></a><dl>
<dt><a name="index-si_003arecord_002dsource_002dfile_002dname"></a>Function: <strong>si:record-source-file-name</strong> <em>name &amp;optional (type <code>defun</code>) no-query</em></dt>
<dd><p>Record a definition of <em>name</em>, of type <em>type</em>.  <em>type</em> should be
<code>defun</code> to record a function definition; then <em>name</em> is a function
spec.  <em>type</em> can also be <code>defvar</code>, <code>defflavor</code>, <code>defresource</code>,
<code>defsignal</code> or anything else you want to use.
</p>
<p>The value of <code>sys:fdefine-file-pathname</code> is assumed to be the generic
pathname of the file the definition is coming from, or <code>nil</code> if the
definition is not from a file.  If a definition of the same <em>name</em> and
<em>type</em> has already been seen but not in the same file, and
<em>no-query</em> is <code>nil</code>, a condition is signaled and then the user is
queried.
</p>
<p>If <code>si:record-source-file-name</code> returns <code>nil</code>, it means that the
user or a condition handler said the redefinition should not be
performed.
</p></dd></dl>

<a name="sys_003afdefine_002dfile_002dpathname_002dvar"></a><dl>
<dt><a name="index-sys_003afdefine_002dfile_002dpathname"></a>Variable: <strong>sys:fdefine-file-pathname</strong></dt>
<dd><p>While the system is loading a file, this is the generic pathname for the file.
The rest of the time it is <code>nil</code>.  <code>fdefine</code> uses this to
remember what file defines each function.
</p></dd></dl>

<a name="si_003aget_002dsource_002dfile_002dname_002dfun"></a><dl>
<dt><a name="index-si_003aget_002dsource_002dfile_002dname"></a>Function: <strong>si:get-source-file-name</strong> <em>function-spec &amp;optional type</em></dt>
<dd><p>Returns the generic pathname for the file in which <em>function-spec</em>
received a definition of type <em>type</em>.  If <em>type</em> is <code>nil</code>, the most
recent definition is used, regardless of its type.
</p>
<p><em>function-spec</em> really is a function spec only if <em>type</em> is <code>defun</code>;
for example, if <em>type</em> is <code>defvar</code>, <em>function-spec</em> is a variable
name.  Other types that are used by the system are <code>defflavor</code> and
<code>defstruct</code>.
</p>
<p>This function returns the generic pathname of the source file.
To obtain the actual source file pathname, use the
<code>:source-pathname</code> operation (see <a href="#fs_003apathname_002dsource_002dpathname_002dmethod">fs:pathname-source-pathname-method</a>).
</p>
<p>A second value is returned, which is the type of the definition that was
reported.
</p></dd></dl>

<a name="si_003aget_002dall_002dsource_002dfile_002dnames_002dfun"></a><dl>
<dt><a name="index-si_003aget_002dall_002dsource_002dfile_002dnames"></a>Function: <strong>si:get-all-source-file-names</strong> <em>function-spec</em></dt>
<dd><p>Returns a list describing the generic pathnames of all the definitions this
function-spec has received, of all types.  The list is an alist whose
elements look like
</p><div class="lisp">
<pre class="lisp">(<em>type</em> <em>pathname</em>...)
</pre></div>
</dd></dl>

<dl>
<dt><a name="index-_0028sys_003awarning_0029-on-sys_003aredefinition"></a>Flavor Condition on sys:redefinition: <strong>(<code>sys:warning</code>)</strong></dt>
<dd><p>This condition, which is not an error, is signaled by
<code>si:record-source-file-name</code> when something is redefined by a different
file.  The handler for this condition can control what is done about the redefinition.
</p>
<p>The condition instance provides the operations <code>:name</code>,
<code>:definition-type</code>, <code>:old-pathname</code> and <code>:new-pathname</code>.
<code>:name</code> and <code>:definition-type</code> return the <em>name</em> and <em>type</em>
arguments to <code>si:record-source-file-name</code>.  <code>:old-pathname</code> and
<code>:new-pathname</code> return two generic pathnames saying where the old
definition was and where this one is.  The new pathname may be <code>nil</code>,
meaning that the redefinition is being done by the user, not in any
file.
</p>
<p>Two proceed types are available, <code>:proceed</code> and
<code>:inhibit-definition</code>.  The first tells <code>si:record-source-file-name</code>
to return <code>t</code>, the second tells it to return <code>nil</code>.  If the
condition is not handled at all, the user is queried or warned according
to the value of <code>inhibit-fdefine-warnings</code>.
</p></dd></dl>

<a name="inhibit_002dfdefine_002dwarnings_002dvar"></a><dl>
<dt><a name="index-inhibit_002dfdefine_002dwarnings"></a>Variable: <strong>inhibit-fdefine-warnings</strong></dt>
<dd><p>This variable is normally <code>nil</code>.  Setting it to <code>t</code> prevents
<code>si:record-source-file-name</code> from warning you and asking about
questionable redefinitions such as a function being redefined by a
different file than defined it originally, or a symbol that belongs to
one package being defined by a file that belongs to a different package.
Setting it to <code>:just-warn</code> allows the warnings to be printed out, but
prevents the queries from happening; it assumes that your answer is
&quot;yes&quot;, i.e that it is all right to redefine the function.
</p></dd></dl>

<a name="fset_002dcarefully_002dfun"></a><dl>
<dt><a name="index-fset_002dcarefully"></a>Function: <strong>fset-carefully</strong> <em>symbol definition &amp;optional force-flag</em></dt>
<dd><p>This function is obsolete.  It is equivalent to
</p><div class="lisp">
<pre class="lisp">(fdefine <em>symbol</em> <em>definition</em> t <em>force-flag</em>)
</pre></div>
</dd></dl>

<a name="fdefinedp_002dfun"></a><dl>
<dt><a name="index-fdefinedp"></a>Function: <strong>fdefinedp</strong> <em>function-spec</em></dt>
<dd><p>This returns <code>t</code> if <em>function-spec</em> has a definition, <code>nil</code> if
it does not.
</p></dd></dl>

<a name="fdefinition_002dfun"></a><dl>
<dt><a name="index-fdefinition"></a>Function: <strong>fdefinition</strong> <em>function-spec</em></dt>
<dd><p>This returns <em>function-spec</em>&rsquo;s definition.  If it has none, an error
occurs.
</p></dd></dl>

<a name="fdefinition_002dlocation_002dfun"></a><dl>
<dt><a name="index-fdefinition_002dlocation"></a>Function: <strong>fdefinition-location</strong> <em>function-spec</em></dt>
<dd><p>This returns a locative pointing at the cell which contains
<em>function-spec</em>&rsquo;s definition.  For some kinds of function specs,
though not for symbols, this can cause data structure to be created to
hold a definition.  For example, if <em>function-spec</em> is of the
<code>:property</code> kind, then an entry may have to be added to the property
list if it isn&rsquo;t already there.  In practice, you should write <code>(locf
(fdefinition <em>function-spec</em>))</code> instead of calling this function
explicitly.
</p></dd></dl>

<a name="fundefine_002dfun"></a><dl>
<dt><a name="index-fundefine"></a>Function: <strong>fundefine</strong> <em>function-spec</em></dt>
<dd><p>Removes the definition of <em>function-spec</em>.  For symbols this
is equivalent to <code>fmakunbound</code>.
If the function is encapsulated, <code>fundefine</code> removes both the
basic definition and the encapsulations.  Some types of function specs
(<code>:location</code> for example) do not implement <code>fundefine</code>.
<code>fundefine</code> on a <code>:within</code> function spec removes the replacement
of <em>function-to-affect</em>, putting the definition of <em>within-function</em>
back to its normal state.  <code>fundefine</code> on a <code>:method</code> function spec
removes the method completely, so that future messages will be handled
by some other method (see the flavor chapter).
</p></dd></dl>

<a name="undefun_002dfun"></a><dl>
<dt><a name="index-undefun"></a>Function: <strong>undefun</strong> <em>function-spec</em></dt>
<dd><p>If <em>function-spec</em> has a saved previous basic definition, this
interchanges the current and previous basic definitions, leaving the
encapsulations alone.  If <em>function-spec</em> has no saved previous
definition, <code>undefun</code> asks the user whether to make it undefined.
</p>
<p>This undoes the effect of redefining a function.
See also <code>uncompile</code> (<a href="#uncompile_002dfun">uncompile-fun</a>).
</p></dd></dl>

<a name="si_003afunction_002dspec_002dget_002dfun"></a><dl>
<dt><a name="index-si_003afunction_002dspec_002dget"></a>Function: <strong>si:function-spec-get</strong> <em>function-spec indicator</em></dt>
<dd><p>Returns the value of the <em>indicator</em> property of <em>function-spec</em>,
or <code>nil</code> if it doesn&rsquo;t have such a property.
</p></dd></dl>

<a name="si_003afunction_002dspec_002dputprop_002dfun"></a><dl>
<dt><a name="index-si_003afunction_002dspec_002dputprop"></a>Function: <strong>si:function-spec-putprop</strong> <em>function-spec value indicator</em></dt>
<dd><p>Gives <em>function-spec</em> an <em>indicator</em> property whose value is <em>value</em>.
</p></dd></dl>

<a name="si_003afunction_002dspec_002dlessp_002dfun"></a><dl>
<dt><a name="index-si_003afunction_002dspec_002dlessp"></a>Function: <strong>si:function-spec-lessp</strong> <em>function-spec1 function-spec2</em></dt>
<dd><p>Compares the two function specs with an ordering that is useful in sorting
lists of function specs for presentation to the user.
</p></dd></dl>

<a name="si_003afunction_002dparent_002dfun"></a><dl>
<dt><a name="index-si_003afunction_002dparent"></a>Function: <strong>si:function-parent</strong> <em>function-spec</em></dt>
<dd><p>If <em>function-spec</em> does not have its own definition, textually speaking,
but is defined as part of the definition of something else, this function
returns the function spec for that something else.  For example, if
<em>function-spec</em> is an accessor function for a <code>defstruct</code>, the value
returned is the name of the <code>defstruct</code>.
</p>
<p>The intent is that if the caller has not been able to find the definition
of <em>function-spec</em> in a more direct fashion, it can try looking for the
definition of the <code>function-parent</code> of <em>function-spec</em>.
This is used by the editor&rsquo;s <code>Meta-</code> command.
</p></dd></dl>

<a name="How-Programs-Examine-Functions"></a>
<h3 class="section">10.9 How Programs Examine Functions</h3>

<p>These functions take a function as argument and return information about
that function.  Some also accept a function spec and operate on its
definition.  The others do not accept function specs in general but do
accept a symbol as standing for its definition.  (Note that a symbol is
a function as well as a function spec).
</p>
<a name="documentation_002dfun"></a><dl>
<dt><a name="index-documentation"></a>Function: <strong>documentation</strong> <em>function</em></dt>
<dd><p>Given a function or a function spec, this finds its documentation
string, which is stored in various different places depending on the
kind of function.  If there is no documentation, <code>nil</code> is returned.
</p></dd></dl>

<a name="debugging_002dinfo_002dfun"></a><dl>
<dt><a name="index-debugging_002dinfo"></a>Function: <strong>debugging-info</strong> <em>function</em></dt>
<dd><p>This returns the debugging info alist of <em>function</em>, or <code>nil</code> if it has none.
</p></dd></dl>

<a name="arglist_002dfun"></a><dl>
<dt><a name="index-arglist"></a>Function: <strong>arglist</strong> <em>function &amp;optional real-flag</em></dt>
<dd><p><code>arglist</code> is given a function or a function spec, and returns its best
guess at the nature of the function&rsquo;s lambda-list.  It can also
return a second value which is a list of descriptive names for the
values returned by the function.
	If <em>function</em> is a symbol, <code>arglist</code>
of its function definition is used.
	If the <em>function</em> is an actual <code>lambda</code>-expression,
its cadr, the lambda-list, is returned.  But if <em>function</em>
is compiled, <code>arglist</code> attempts to reconstruct the lambda-list of the original
definition, using whatever debugging information was saved by the compiler.
Sometimes the actual names of the bound variables are not available, and
<code>arglist</code> uses the symbol <code>si:*unknown*</code> for these.  Also, sometimes
the initialization of an optional parameter is too complicated
for <code>arglist</code> to reconstruct; for these it returns the symbol
<code>si:*hairy*</code>.
	Some functions&rsquo; real argument lists are not what would be most
descriptive to a user.  A function may take a rest argument for
technical reasons even though there are standard meanings for the first
elements of that argument.  For such cases, the definition of the
function can specify, with a local declaration, a value to be returned
when the user asks about the argument list.  Example:
</p><div class="lisp">
<pre class="lisp">(defun foo (&amp;rest rest-arg)
  (declare (arglist x y &amp;rest z))
  .....)
</pre></div>
<p><em>real-flag</em> allows the caller of <code>arglist</code> to say that
the real argument list should be used even if a declared argument list exists.
Note that while normally <code>declare</code>s are only for the compiler&rsquo;s benefit,
this kind of <code>declare</code> affects all functions, including interpreted functions.
</p>
<p><code>arglist</code> cannot be relied upon to return the exactly
correct answer, since some of the information may have been lost.
Programs interested in how many and what kind of arguments there are
should use <code>args-info</code> instead.  In general <code>arglist</code>
is to be used for documentation purposes, not for reconstructing
the original source code of the function.
	When a function returns multiple values, it is useful to give
the values names so that the caller can be reminded which value is
which.  By means of a <code>return-list</code> declaration in the function&rsquo;s
definition, entirely analogous to the <code>arglist</code> declaration above,
you can specify a list of mnemonic names for the returned values.  This
list will be returned by <code>arglist</code> as the second value.
</p><div class="lisp">
<pre class="lisp">(arglist 'arglist)
  =&gt; (function &amp;optional real-flag) <span class="roman">and</span> (arglist return-list)
</pre></div>
</dd></dl>

<a name="function_002dname_002dfun"></a><dl>
<dt><a name="index-function_002dname-1"></a>Function: <strong>function-name</strong> <em>function &amp;optional try-flavor-name</em></dt>
<dd><p>Returns the name of the function <em>function</em>, if that can be determined.
If <em>function</em> does not describe what its name is, <em>function</em> itself is returned.
</p>
<p>If <em>try-flavor-name</em> is non-<code>nil</code>, then if <em>function</em> is a flavor
instance (which can, after all, be used as a function), then the flavor
name is returned.  If the optional argument is <code>nil</code>, flavor instances
are treated as anonymous.
</p></dd></dl>

<a name="eh_003aarg_002dname_002dfun"></a><dl>
<dt><a name="index-eh_003aarg_002dname"></a>Function: <strong>eh:arg-name</strong> <em>function arg-number</em></dt>
<dd><p>Returns the name of argument number <em>arg-number</em> in function <em>function</em>.
Returns <code>nil</code> if the function doesn&rsquo;t have such an argument,
or if the name is not recorded.
<code>&amp;rest</code> arguments are not obtained with <code>arg-number</code>;
use <code>rest-arg-name</code> to obtain the name of <em>function</em>&rsquo;s
<code>&amp;rest</code> argument, if any.
</p></dd></dl>

<a name="eh_003arest_002darg_002dname_002dfun"></a><dl>
<dt><a name="index-eh_003arest_002darg_002dname"></a>Function: <strong>eh:rest-arg-name</strong> <em>function</em></dt>
<dd><p>Returns the name of the rest argument of function <em>function</em>, or
<code>nil</code> if <em>function</em> does not have one.
</p></dd></dl>

<a name="eh_003alocal_002dname_002dfun"></a><dl>
<dt><a name="index-eh_003alocal_002dname"></a>Function: <strong>eh:local-name</strong> <em>function local-number</em></dt>
<dd><p>Returns the name of local variable number <em>local-number</em> in function <em>function</em>.
If <em>local-number</em> is zero, this gets the name of the rest arg
in any function that accepts a rest arg.
Returns <code>nil</code> if the function doesn&rsquo;t have such a local.
</p></dd></dl>

<a name="args_002dinfo_002dfun"></a><dl>
<dt><a name="index-args_002dinfo"></a>Function: <strong>args-info</strong> <em>function</em></dt>
<dd><p><code>args-info</code> returns a fixnum called the &quot;numeric argument descriptor&quot;
of the <em>function</em>, which describes the way the function takes arguments.
This descriptor is used internally by the microcode, the evaluator, and
the compiler.  <em>function</em> can be a function or a function spec.
</p>
<p>The information is stored in various bits and byte fields in the
fixnum, which are referenced by the symbolic names shown below.
By the usual Lisp Machine convention, those starting with a single &quot;<code>%</code>&quot;
are bit-masks (meant to be <code>logand</code>&rsquo;ed or <code>bit-test</code>&rsquo;ed with the number), and those
starting with &quot;<code>%%</code>&quot; are byte descriptors (meant to be used with <code>ldb</code>
or <code>ldb-test</code>).
	Here are the fields:
</p><dl compact="compact">
<dt><code>%%arg-desc-min-args</code></dt>
<dd><a name="index-_0025_0025arg_002ddesc_002dmin_002dargs"></a>
<p>This is the minimum number of arguments that may be passed
to this function, i.e the number of required parameters.
</p>
</dd>
<dt><code>%%arg-desc-max-args</code></dt>
<dd><a name="index-_0025_0025arg_002ddesc_002dmax_002dargs"></a>
<p>This is the maximum number of arguments that may be passed
to this function, i.e the sum of the number of required
parameters and the number of optional parameters.
If there is a rest argument, this is not really the maximum
number of arguments that may be passed; an arbitrarily-large
number of arguments is permitted, subject to limitations on
the maximum size of a stack frame (about 200 words).
</p>
</dd>
<dt><code>%arg-desc-evaled-rest</code></dt>
<dd><a name="index-_0025arg_002ddesc_002devaled_002drest"></a>
<p>If this bit is set, the function has a rest argument, and it is not quoted.
</p>
</dd>
<dt><code>%arg-desc-quoted-rest</code></dt>
<dd><a name="index-_0025arg_002ddesc_002dquoted_002drest"></a>
<p>If this bit is set, the function has a rest argument, and it is quoted.
Most special forms have this bit.
</p>
</dd>
<dt><code>%arg-desc-fef-quote-hair</code></dt>
<dd><a name="index-_0025arg_002ddesc_002dfef_002dquote_002dhair"></a>
<p>If this bit is set, there are some quoted arguments other
than the rest argument (if any), and the pattern of quoting is too complicated
to describe here.  The ADL (Argument Description List) in the FEF should be consulted.
This is only for special forms.
</p>
</dd>
<dt><code>%arg-desc-interpreted</code></dt>
<dd><a name="index-_0025arg_002ddesc_002dinterpreted"></a>
<p>This function is not a compiled-code object, and a numeric argument descriptor
cannot be computed.
Usually <code>args-info</code> will not return this bit, although <code>%args-info</code> will.
</p>
</dd>
<dt><code>%arg-desc-fef-bind-hair</code></dt>
<dd><a name="index-_0025arg_002ddesc_002dfef_002dbind_002dhair"></a>
<p>There is argument initialization, or something else too
complicated to describe here.
The ADL (Argument Description List) in the FEF should be consulted.
</p></dd>
</dl>

<p>Note that <code>%arg-desc-quoted-rest</code> and <code>%arg-desc-evaled-rest</code> cannot both be set.
</p></dd></dl>

<a name="g_t_0025args_002dinfo_002dfun"></a><dl>
<dt><a name="index-_0025args_002dinfo"></a>Function: <strong>%args-info</strong> <em>function</em></dt>
<dd><p>This is an internal function; it is like <code>args-info</code>
but does not work for interpreted functions.  Also, <em>function</em>
must be a function, not a function spec.  It exists because it has
to be in the microcode anyway, for <code>apply</code> and the basic
function-calling mechanism.
</p></dd></dl>

<a name="g_t_0022Encapsulations_0022"></a>
<h3 class="section">10.10 &quot;Encapsulations&quot;</h3>
<a name="index-encapsulation-1"></a>
<a name="index-basic-definition-1"></a>
<a name="encapsulate"></a>
<p>The definition of a function spec actually has two parts: the <em>basic
definition</em>, and <em>encapsulations</em>.  The basic definition is what
is created by functions like <code>defun</code>, and encapsulations are additions made by
<code>trace</code> or <code>advise</code> to the basic definition.  The purpose of making
the encapsulation a separate object is to keep track of what was made by
<code>defun</code> and what was made by <code>trace</code>.  If <code>defun</code> is done a second
time, it replaces the old basic definition with a new one while leaving
the encapsulations alone.
</p>
<p>Only advanced users should ever need to use encapsulations directly via
the primitives explained in this section.  The most common things to do
with encapsulations are provided as higher-level, easier-to-use
features: <code>trace</code> (see <a href="#trace_002dfun">trace-fun</a>), <code>breakon</code> (see <a href="#breakon_002dfun">breakon-fun</a>)
and <code>advise</code> (see <a href="#advise_002dfun">advise-fun</a>).
</p>
<p>The actual definition of the function spec is the outermost
encapsulation; this contains the next encapsulation, and so on.  The
innermost encapsulation contains the basic definition.  The way
this containing is done is as follows.
An encapsulation is actually a function whose debugging info alist
contains an element of the form
</p><div class="lisp">
<pre class="lisp">(si:encapsulated-definition <em>uninterned-symbol</em> <em>encapsulation-type</em>)
</pre></div>
<p>The presence of such an element in the debugging info alist
is how you recognize a function to be an encapsulation.  An encapsulation
is usually an interpreted function (a list starting with <code>named-lambda</code>) but
it can be a compiled function also, if the application which created it
wants to compile it.
</p>
<p><em>uninterned-symbol</em>&rsquo;s function definition is the thing that the
encapsulation contains, usually the basic definition of the function spec.  Or it
can be another encapsulation, which has in it another debugging info
item containing another uninterned symbol.  Eventually you get to a
function which is not an encapsulation; it does not have the sort of
debugging info item which encapsulations all have.  That function is the basic
definition of the function spec.
</p>
<p>Literally speaking, the definition of the function spec is the
outermost encapsulation, period.  The basic definition is not the
definition.  If you are asking for the definition of the function spec
because you want to apply it, the outermost encapsulation is exactly
what you want.  But the basic definition can be found mechanically
from the definition, by following the debugging info alists.  So it
makes sense to think of it as a part of the definition.  In regard to
the function-defining special forms such as <code>defun</code>, it is
convenient to think of the encapsulations as connecting between the
function spec and its basic definition.
</p>
<p>An encapsulation is created with the macro <code>si:encapsulate</code>.
</p>
<a name="si_003aencapsulate_002dfun"></a><dl>
<dt><a name="index-si_003aencapsulate"></a>Macro: <strong>si:encapsulate</strong></dt>
<dd><p>A call to <code>si:encapsulate</code> looks like
</p><div class="lisp">
<pre class="lisp">(si:encapsulate <em>function-spec</em> <em>outer-function</em> <em>type</em>
	     <em>body-form</em>
	     <em>extra-debugging-info</em>)
</pre></div>
<p>All the subforms of this macro are evaluated.  In fact, the macro could
almost be replaced with an ordinary function, except for the way
<em>body-form</em> is handled.
</p>
<p><em>function-spec</em> evaluates to the function spec whose definition the
new encapsulation should become.  <em>outer-function</em> is another function
spec, which should often be the same one.  Its only purpose is to be
used in any error messages from <code>si:encapsulate</code>.
</p>
<p><em>type</em> evaluates to a symbol which identifies the purpose of the
encapsulation and says what the application is.  For example, that could
be <code>advise</code> or <code>trace</code>.  The list of possible types is defined by
the system because encapsulations are supposed to be kept in an order
according to their type (see <code>si:encapsulation-standard-order</code>,
<a href="#si_003aencapsulation_002dstandard_002dorder_002dvar">si:encapsulation-standard-order-var</a>).  <em>type</em> should have an
<code>si:encapsulation-grind-function</code> property which tells <code>grindef</code> what to
do with an encapsulation of this type.
</p>
<p><em>body-form</em> evaluates to the body of the
encapsulation-definition, the code to be executed when it is called.
Backquote is typically used for this expression; see <a href="#backquote">backquote</a>.
<code>si:encapsulate</code> is a macro because, while <em>body</em> is
being evaluated, the variable <code>si:encapsulated-function</code> is bound to a
list of the form <code>(function <em>uninterned-symbol</em>)</code>, referring to the
uninterned symbol used to hold the prior definition of
<em>function-spec</em>.  If <code>si:encapsulate</code> were a function, <em>body-form</em>
would just get evaluated normally by the evaluator before <code>si:encapsulate</code>
ever got invoked, and so there would be no opportunity to bind <code>si:encapsulated-function</code>.
The form <em>body-form</em> should contain <code>`(apply ,si:encapsulated-function arglist)</code>
somewhere if the encapsulation is
to live up to its name and truly serve to encapsulate the original
definition.  (The variable <code>arglist</code> is bound by some of the code
which the <code>si:encapsulate</code> macro produces automatically.  When the
body of the encapsulation is run <code>arglist</code>&rsquo;s value will be the list of
the arguments which the encapsulation received.)
</p>
<p><em>extra-debugging-info</em> evaluates to a list of extra items to put into
the debugging info alist of the encapsulation function (besides the one
starting with <code>si:encapsulated-definition</code>, which every encapsulation
must have).  Some applications find this useful for recording
information about the encapsulation for their own later use.
</p>
<p>If <code>compile-encapsulations-flag</code> is non-<code>nil</code>, the encapsulation is
compiled before it is installed.  The encapsulations on a particular
function spec can be compiled by calling <code>compile-encapsulations</code>.
See <a href="#compile_002dencapsulations_002dfun">compile-encapsulations-fun</a>.
Compiled encapsulations can still be unencapsulated since the
information needed to do so is stored in the debugging info alist, which
is preserved by compilation.  However, applications which wish to modify
the code of the encapsulations they previously created must check for
encapsulations that have been compiled and uncompile them.  This can be
done by finding the <code>sys:interpreted-definition</code> entry in the debugging
info alist, which is present in all compiled functions except those made by
file-to-file compilation.
</p>
<p>When a special function is encapsulated, the encapsulation is itself a
special function with the same argument quoting pattern.  Therefore,
when the outermost encapsulation is started, each argument has been
evaluated or not as appropriate.  Because each encapsulation calls the
prior definition with <code>apply</code>, no further evaluation takes place, and the
basic definition of the special form also finds the arguments evaluated
or not as appropriate.  The basic definition may call <code>eval</code> on some
of these arguments or parts of them; the encapsulations should not.
</p>
<p>Macros cannot be encapsulated, but their expander functions can be; if
the definition of <em>function-spec</em> is a macro, then <code>si:encapsulate</code>
automatically encapsulates the expander function instead.  In this case,
the definition of the uninterned symbol is the original macro
definition, not just the original expander function.
It would not work for the encapsulation to apply the macro definition.
So during the evaluation of <em>body-form</em>, <code>si:encapsulated-function</code> is bound
to the form <code>(cdr (function <em>uninterned-symbol</em>))</code>, which extracts the
expander function from the prior definition of the macro.
</p>
<p>Because only the expander function is actually encapsulated, the
encapsulation does not see the evaluation or execution of the
expansion itself.  The value returned by the encapsulation is the
expansion of the macro call, not the value computed by the expansion.
</p></dd></dl>

<p>It is possible for one function to have multiple encapsulations,
created by different subsystems.  In this case, the order of
encapsulations is independent of the order in which they were made.
It depends instead on their types.  All possible encapsulation types
have a total order and a new encapsulation is put in the right place
among the existing encapsulations according to its type and their types.
</p>
<a name="si_003aencapsulation_002dstandard_002dorder_002dvar"></a><dl>
<dt><a name="index-si_003aencapsulation_002dstandard_002dorder"></a>Variable: <strong>si:encapsulation-standard-order</strong></dt>
<dd><p>The value of this variable is a list of the allowed encapsulation types,
in the order in which the encapsulations are supposed to be kept
(innermost encapsulations first).  If you want to add new kinds
of encapsulations, you should add another symbol to this list.
Initially its value is
</p><div class="lisp">
<pre class="lisp">(advise breakon trace si:rename-within)
</pre></div>
<p><code>advise</code> encapsulations are used to hold advice (see <a href="#advise_002dfun">advise-fun</a>).
<code>breakon</code> encapsulations are used for implementing <code>breakon</code> (see <a href="#breakon_002dfun">breakon-fun</a>).
<code>trace</code>
encapsulations are used for implementing tracing (see <a href="#trace_002dfun">trace-fun</a>).
<code>si:rename-within</code> encapsulations are used to record the fact that
function specs of the form <code>(:within <em>within-function</em>
<em>altered-function</em>)</code> have been defined.  The encapsulation goes on
<em>within-function</em> (see <a href="#rename_002dwithin_002dsection">rename-within-section</a> for more information).
</p></dd></dl>

<p>Every symbol used as an encapsulation type must be on the list
<code>si:encapsulation-standard-order</code>.  In addition, it should have an
<code>si:encapsulation-grind-function</code> property whose value is a function that
<code>grindef</code> will call to process encapsulations of that type.  This
function need not take care of printing the encapsulated function
because <code>grindef</code> will do that itself.  But it should print any
information about the encapsulation itself which the user ought to see.
Refer to the code for the grind function for <code>advise</code> to see how to
write one.
</p>
<p>To find the right place in the ordering to insert a new encapsulation,
it is necessary to parse existing ones.  This is done with the function
<code>si:unencapsulate-function-spec</code>.
</p>
<a name="si_003aunencapsulate_002dfunction_002dspec_002dfun"></a><dl>
<dt><a name="index-si_003aunencapsulate_002dfunction_002dspec"></a>Function: <strong>si:unencapsulate-function-spec</strong> <em>function-spec &amp;optional encapsulation-types</em></dt>
<dd><p>This takes one function spec and returns another.  If the original
function spec is undefined, or has only a basic definition (that is,
its definition is not an encapsulation), then the original function
spec is returned unchanged.
</p>
<p>If the definition of <em>function-spec</em> is an encapsulation, then
its debugging info is examined to find the uninterned symbol that
holds the encapsulated definition and the encapsulation type.
If the encapsulation is of a type that is to be skipped over, the
uninterned symbol replaces the original function spec and the process
repeats.
</p>
<p>The value returned is the uninterned symbol from inside the last
encapsulation skipped.  This uninterned symbol is the first one that
does not have a definition that is an encapsulation that should be
skipped.  Or the value can be <em>function-spec</em> if <em>function-spec</em>&rsquo;s
definition is not an encapsulation that should be skipped.
</p>
<p>The types of encapsulations to be skipped over are specified by
<em>encapsulation-types</em>.  This can be a list of the types to be
skipped, or <code>nil</code> meaning skip all encapsulations (this is the default).  Skipping all
encapsulations means returning the uninterned symbol that holds the basic
definition of <em>function-spec</em>.  That is, the <em>definition</em> of
the function spec returned is the <em>basic definition</em> of the function spec
supplied.  Thus,
</p><div class="lisp">
<pre class="lisp">(fdefinition (si:unencapsulate-function-spec 'foo))
</pre></div>
<p>returns the basic definition of <code>foo</code>, and
</p><div class="lisp">
<pre class="lisp">(fdefine (si:unencapsulate-function-spec 'foo) 'bar)
</pre></div>
<p>sets the basic definition (just like using <code>fdefine</code> with
<em>carefully</em> supplied as <code>t</code>).
</p>
<p><em>encapsulation-types</em> can also be a symbol, which should be an
encapsulation type; then we skip all types that are supposed to come
outside of the specified type.  For example, if
<em>encapsulation-types</em> is <code>trace</code>, then we skip all types of
encapsulations that come outside of <code>trace</code> encapsulations, but we
do not skip <code>trace</code> encapsulations themselves.  The result is a
function spec that is where the <code>trace</code> encapsulation ought to
be, if there is one.  Either the definition of this function spec is a
<code>trace</code> encapsulation, or there is no <code>trace</code> encapsulation
anywhere in the definition of <em>function-spec</em>, and this function
spec is where it would belong if there were one.  For example,
</p><div class="lisp">
<pre class="lisp">(let ((tem (si:unencapsulate-function-spec spec 'trace)))
  (and (eq tem (si:unencapsulate-function-spec tem '(trace)))
       (si:encapsulate tem spec 'trace `(...<em>body</em>...))))
</pre></div>
<p>finds the place where a <code>trace</code> encapsulation ought to go and
makes one unless there is already one there.
</p>
<div class="lisp">
<pre class="lisp">(let ((tem (si:unencapsulate-function-spec spec 'trace)))
  (fdefine tem (fdefinition (si:unencapsulate-function-spec
				tem '(trace)))))
</pre></div>
<p>eliminates any <code>trace</code> encapsulation by replacing it by whatever it
encapsulates.  (If there is no <code>trace</code> encapsulation, this code
changes nothing.)
</p>
<p>These examples show how a subsystem can insert its own type of
encapsulation in the proper sequence without knowing the names of any
other types of encapsulations.  Only the variable
<code>si:encapsulation-standard-order</code>, which is used by
<code>si:unencapsulate-function-spec</code>, knows the order.
</p></dd></dl>

<a name="g_t_0022Rename_002dWithin-Encapsulations_0022"></a>
<h4 class="subsection">10.10.1 &quot;Rename-Within Encapsulations&quot;</h4>
<a name="index-rename_002dwithin"></a>
<a name="index-function-renaming"></a>
<a name="rename_002dwithin_002dsection"></a>
<p>One special kind of encapsulation is the type <code>si:rename-within</code>.  This
encapsulation goes around a definition in which renamings of functions
have been done.
</p>
<p>How is this used?
</p>
<p>If you define, advise, or trace <code>(:within foo bar)</code>, then <code>bar</code>
gets renamed to <code>altered-bar-within-foo</code> wherever it is called from
<code>foo</code>, and <code>foo</code> gets a <code>si:rename-within</code> encapsulation to
record the fact.  The purpose of the encapsulation is to enable
various parts of the system to do what seems natural to the user.
For example, <code>grindef</code> (see <a href="#grindef_002dfun">grindef-fun</a>) notices the
encapsulation, and so knows to print <code>bar</code> instead of
<code>altered-bar-within-foo</code> when grinding the definition of <code>foo</code>.
</p>
<p>Also, if you redefine <code>foo</code>, or trace or advise it, the new
definition gets the same renaming done (<code>bar</code> replaced by
<code>altered-bar-within-foo</code>).  To make this work, everyone who alters
part of a function definition should pass the new part of the
definition through the function <code>si:rename-within-new-definition-maybe</code>.
</p>
<a name="si_003arename_002dwithin_002dnew_002ddefinition_002dmaybe_002dfun"></a><dl>
<dt><a name="index-si_003arename_002dwithin_002dnew_002ddefinition_002dmaybe"></a>Function: <strong>si:rename-within-new-definition-maybe</strong> <em>function-spec new-structure</em></dt>
<dd><p>Given <em>new-structure</em>, which is going to become a part of the
definition of <em>function-spec</em>, perform on it the replacements
described by the <code>si:rename-within</code> encapsulation in the
definition of <em>function-spec</em>, if there is one.  The altered
(copied) list structure is returned.
</p>
<p>It is not necessary to call this function yourself when you replace
the basic definition because <code>fdefine</code> with <em>carefully</em>
supplied as <code>t</code> does it for you.  <code>si:encapsulate</code> does this
to the body of the new encapsulation.  So you only need to call 
<code>si:rename-within-new-definition-maybe</code> yourself if you are rplac&rsquo;ing
part of the definition.
</p>
<p>For proper results, <em>function-spec</em> must be the outer-level function
spec.  That is, the value returned by <code>si:unencapsulate-function-spec</code>
is <em>not</em> the right thing to use.  It will have had one or more
encapsulations stripped off, including the <code>si:rename-within</code>
encapsulation if any, and so no renamings will be done.
</p></dd></dl>

<a name="g_t_0022Closures_0022"></a>
<h2 class="chapter">11 &quot;Closures&quot;</h2>
<a name="index-_0022closure_0022-1"></a>
<a name="closure"></a><a name="closure_002dchapter"></a><a name="index-coroutine"></a>

<p>A <em>closure</em> is a type of Lisp functional object useful
for implementing certain advanced access and control structures.
Closures give you more explicit control over the
environment by allowing you to save the environment created
by the entering of a dynamic contour (i.e a <code>lambda</code>, <code>do</code>,
<code>prog</code>, <code>progv</code>, <code>let</code>, or any of several other special
forms) and then to use that environment
elsewhere, even after the contour has been exited.
</p>
<a name="g_t_0022What-a-Closure-Is_0022"></a>
<h3 class="section">11.1 &quot;What a Closure Is&quot;</h3>

<p>There is a view of lambda-binding that we will use in this
section because it makes it easier to explain what closures do.  In
this view, when a variable is bound, a new value cell is created for it.
The old value cell is saved away somewhere and is inaccessible.  Any
references to the variable will get the contents of the new value cell,
and any <code>setq</code>&rsquo;s will change the contents of the new value cell.
When the binding is undone, the new value cell goes away, and the old
value cell, along with its contents, is restored.
</p>
<p>For example, consider the following sequence of Lisp forms:
</p><div class="lisp">
<pre class="lisp">(setq a 3)

(let ((a 10))
  (print (+ a 6)))

(print a)
</pre></div>

<p>Initially there is a value cell for <code>a</code>, and the <code>setq</code> form makes
the contents of that value cell be <code>3</code>.  Then the
<code>lambda</code>-combination is evaluated.  <code>a</code> is bound to <code>10</code>: the old
value cell, which still contains a <code>3</code>, is saved away, and a new
value cell is created with <code>10</code> as its contents.  The reference to
<code>a</code> inside the <code>lambda</code> expression evaluates to the current binding
of <code>a</code>, which is the contents of its current value cell, namely
<code>10</code>.  So <code>16</code> is printed.  Then the binding is undone, discarding
the new value cell, and restoring the old value cell, which still
contains a <code>3</code>.  The final <code>print</code> prints out a <code>3</code>.
</p>
<p>The form <code>(closure <em>var-list</em> <em>function</em>)</code>, where
<em>var-list</em> is a list of variables and <em>function</em> is any function,
creates and returns a closure.  When this closure is applied to some
arguments, all of the value cells of the variables on <em>var-list</em> are
saved away, and the value cells that those variables had <em>at the time
<code>closure</code> was called</em> (that is, at the time the closure was created)
are made to be the value cells of the symbols.  Then <em>function</em> is
applied to the arguments.  (This paragraph is somewhat complex, but it
completely describes the operation of closures; if you don&rsquo;t understand
it, come back and read it again after reading the next two paragraphs.)
</p>
<p>Here is another, lower-level explanation.  The closure object
stores several things inside it.  First, it saves the <em>function</em>.
Secondly, for each variable in <em>var-list</em>, it remembers what that
variable&rsquo;s value cell was when the closure was created.
Then when the closure is called as a function, it first temporarily restores
the value cells it has remembered inside the closure, and then applies <em>function</em> to the
same arguments to which the closure itself was applied.  When the function
returns, the value cells are restored to be as they were before the closure
was called.
</p>
<p>Now, if we evaluate the form
</p><div class="lisp">
<pre class="lisp">(setq a 
      (let ((x 3))
	(closure '(x) 'frob)))
</pre></div>
<p>what happens is that a new value cell is created for <code>x</code>, containing
a fixnum <code>3</code>.  Then a closure is created, which remembers
the function <code>frob</code>, the symbol <code>x</code>, and that value cell.
Finally the old value cell of <code>x</code> is restored, and the closure is
returned.  Notice that the new value cell is still around, because
it is still known about by the closure.  When the closure is applied,
say by doing <code>(funcall a 7)</code>,
this value cell will be restored and the value of <code>x</code> will be <code>3</code>
again.  If <code>frob</code> uses <code>x</code> as a free variable, it will see <code>3</code>
as the value.
</p>
<p>A closure can be made around any function, using any form
that evaluates to a function.  The form could evaluate to a
lambda expression, as in <code>'(lambda () x)</code>, or to a compiled function,
as would <code>(function (lambda () x))</code>.  In the example above, the
form is <code>'frob</code> and it evaluates to the symbol <code>frob</code>.  A
symbol is also a good function.  It is usually better to close around
a symbol that is the name of the desired function, so that the
closure points to the symbol.  Then, if the symbol is redefined, the
closure will use the new definition.  If you actually prefer that the
closure continue to use the old definition that was current when the
closure was made, then close around the definition of the symbol rather
than the symbol itself.  In the above example, that would be done by
</p><div class="lisp">
<pre class="lisp">(closure '(x) (function frob))
</pre></div>

<p>Because of the way closures are implemented, the variables to be
closed over must not get turned into &quot;local variables&quot; by the compiler.
Therefore, all such variables must be declared special.  This can be
done with an explicit <code>declare</code> (see <a href="#declare_002dfun">declare-fun</a>), with a special form
such as <code>defvar</code> (<a href="#defvar_002dfun">defvar-fun</a>), or with <code>let-closed</code>
(<a href="#let_002dclosed_002dfun">let-closed-fun</a>).  In simple cases, a <code>local-declare</code> around the
binding will do the job.  Usually the compiler can tell when a special
declaration is missing, but when making a closure the compiler
detects this only after acting on the assumption that the variable is
local, by which time it is too late to fix things.  The compiler will
warn you if this happens.
</p>
<p>In Zetalisp&rsquo;s implementation of closures,
lambda-binding never really allocates any storage to create new value
cells.   Value cells are created only by the <code>closure</code> function
itself, when they are needed.  Thus, there is no cost associated with closures when they are not in use.
</p>
<p>Zetalisp closures are not closures in the true sense,
as they do not save the whole variable-binding environment; however,
most of that environment is irrelevant in any given application.  The explicit
declaration of the variables that are to be closed allows the
implementation to have high efficiency.
It also allows the programmer to choose explicitly for each variable
whether it is to be bound at the point of call or
bound at the point of definition (e.g of creation of the closure), a choice
that is not conveniently available in other languages.  In addition the
program is clearer because the intended effect of the closure is made
manifest by listing the variables to be affected. 
</p>
<a name="index-internal-value-cell"></a>
<a name="index-external-value-cell"></a>
<a name="external_002dvalue_002dcell"></a><a name="internal_002dvalue_002dcell"></a><p>Closure implementation (which it not usually necessary for you
to understand) involves two kinds of value cells.  Every symbol has an
<em>internal value cell</em>, which is where its value is normally stored.
When a variable is closed over by a closure, the variable gets an
<em>external value cell</em> to hold its value.  The external value cells
behave according to the lambda-binding model used earlier in this
section.  The value in the external value cell is found through the
usual access mechanisms (such as evaluating the symbol, calling
<code>symeval</code>, etc.), because the internal value cell is made to contain
an invisible pointer to the external value cell currently in effect.
A symbol will use such an invisible pointer whenever its current value
cell is a value cell that some closure is remembering; at other times,
there won&rsquo;t be an invisible pointer, and the value will just reside in the
internal value cell.
</p>
<a name="g_t_0022Examples-of-the-Use-of-Closures_0022"></a>
<h3 class="section">11.2 &quot;Examples of the Use of Closures&quot;</h3>

<p>One thing we can do with closures is to implement a <em>generator</em>, which
is a kind of function which is called successively to obtain successive elements
of a sequence.
We will implement a function <code>make-list-generator</code>, which takes a list
and returns a generator that will return successive
elements of the list.  When it gets to the end it should return <code>nil</code>.
</p>
<p>The problem is that in between calls to the generator, the generator
must somehow remember where it is up to in the list.  Since all of its
bindings are undone when it is exited, it cannot save this information in
a bound variable.  It could save it in a global variable, but the problem
is that if we want to have more than one list generator at a time, they
will all try to use the same global variable and get in each other&rsquo;s way.
</p>
<p>Here is how we can use closures to solve the problem:
</p><div class="lisp">
<pre class="lisp">(defun make-list-generator (l)
    (declare (special l))
    (closure '(l)
	     (function (lambda ()
			  (prog1 (car l)
				 (setq l (cdr l)))))))
</pre></div>
<p>Now we can make as many list generators as we like; they won&rsquo;t get
in each other&rsquo;s way because each has its own (external) value cell for <code>l</code>.
Each of these value cells was created when the <code>make-list-generator</code>
function was entered, and the value cells are remembered by the closures.
</p>
<p>The following form uses closures to create an advanced accessing environment:
</p><div class="lisp">
<pre class="lisp">(defvar a)
(defvar b)

(defun foo () (setq a 5))

(defun bar () (cons a b))

(let ((a 1) (b 1))
   (setq x (closure '(a b) 'foo))
   (setq y (closure '(a b) 'bar)))
</pre></div>

<p>When the <code>let</code> is entered, new value cells are created for the symbols
<code>a</code> and <code>b</code>, and two closures are created that both point to those
value cells.  If we do <code>(funcall x)</code>, the function <code>foo</code> will
be run, and it will change the contents of the remembered value cell
of <code>a</code> to <code>5</code>.  If we then do <code>(funcall y)</code>, the function <code>bar</code>
will return <code>(5 . 1)</code>.  This shows that the value cell of <code>a</code> seen
by the closure <code>y</code> is the same value cell seen by the closure <code>x</code>.  The
top-level value cell of <code>a</code> is unaffected.
</p>
<p>Here is how we can create a function that prints always using base 10:
</p><div class="lisp">
<pre class="lisp">(deff print-in-base-10
      (let ((base 10.))
        (closure '(base) 'print)))
</pre></div>

<a name="Closure_002dManipulating-Functions"></a>
<h3 class="section">11.3 Closure-Manipulating Functions</h3>

<a name="closure_002dfun"></a><dl>
<dt><a name="index-closure"></a>Function: <strong>closure</strong> <em>var-list function</em></dt>
<dd><p>This creates and returns a closure of <em>function</em> over the variables
in <em>var-list</em>.  Note that all variables on <em>var-list</em>
must be declared special if the function is to compile correctly.
</p></dd></dl>

<p>To test whether an object is a closure, use the <code>closurep</code> predicate
(see <a href="#closurep_002dfun">closurep-fun</a>).  The <code>typep</code> function will return the symbol
<code>closure</code> if given a closure.  <code>(typep <em>x</em> 'closure)</code> is equivalent
to <code>(closurep <em>x</em>)</code>.
</p>
<a name="symeval_002din_002dclosure_002dfun"></a><dl>
<dt><a name="index-symeval_002din_002dclosure"></a>Function: <strong>symeval-in-closure</strong> <em>closure symbol</em></dt>
<dd><p>This returns the binding of <em>symbol</em> in the environment of <em>closure</em>;
that is, it returns what you would get if you restored the value cells
known about by <em>closure</em> and then evaluated <em>symbol</em>.
This allows you to &quot;look around inside&quot; a closure.
If <em>symbol</em> is not closed over by <em>closure</em>, this is just like <code>symeval</code>.
</p>
<p><em>symbol</em> may be a locative pointing to a value cell instead of a
symbol (this goes for all the whatever-in-closure functions).
</p></dd></dl>

<a name="set_002din_002dclosure_002dfun"></a><dl>
<dt><a name="index-set_002din_002dclosure"></a>Function: <strong>set-in-closure</strong> <em>closure symbol x</em></dt>
<dd><p>This sets the binding of <em>symbol</em> in the environment of <em>closure</em>
to <em>x</em>; that is, it does what would happen if you restored the value cells
known about by <em>closure</em> and then set <em>symbol</em> to <em>x</em>.
This allows you to change the contents of the value cells known about
by a closure.
If <em>symbol</em> is not closed over by <em>closure</em>, this is just like <code>set</code>.
</p></dd></dl>

<a name="locate_002din_002dclosure_002dfun"></a><dl>
<dt><a name="index-locate_002din_002dclosure"></a>Function: <strong>locate-in-closure</strong> <em>closure symbol</em></dt>
<dd><p>This returns the location of the place in <em>closure</em> where the saved
value of <em>symbol</em> is stored.  An equivalent form is
<code>(locf (symeval-in-closure <em>closure</em> <em>symbol</em>))</code>.
</p></dd></dl>

<a name="boundp_002din_002dclosure_002dfun"></a><dl>
<dt><a name="index-boundp_002din_002dclosure"></a>Function: <strong>boundp-in-closure</strong> <em>closure symbol</em></dt>
<dd><p>Returns <code>t</code> if <em>symbol</em> is not &quot;unbound&quot; in <em>closure</em>.
This is what <code>(boundp <em>symbol</em>)</code> would return if executed in
<em>closure</em>&rsquo;s saved environment.
</p></dd></dl>

<a name="makunbound_002din_002dclosure_002dfun"></a><dl>
<dt><a name="index-makunbound_002din_002dclosure"></a>Function: <strong>makunbound-in-closure</strong> <em>closure symbol</em></dt>
<dd><p>Makes <em>symbol</em> be unbound, inside <em>closure</em>.
This is what <code>(makunbound <em>symbol</em>)</code> would do if executed in
<em>closure</em>&rsquo;s saved environment.
</p></dd></dl>

<a name="closure_002dalist_002dfun"></a><dl>
<dt><a name="index-closure_002dalist"></a>Function: <strong>closure-alist</strong> <em>closure</em></dt>
<dd><p>Returns an alist of <code>(<em>symbol</em> . <em>value</em>)</code> pairs describing the
bindings that the closure performs when it is called.  This list is not
the same one that is actually stored in the closure; that one contains
pointers to value cells rather than symbols, and <code>closure-alist</code>
translates them back to symbols so you can understand them.  As a result,
clobbering part of this list will not change the closure.
</p>
<p>The list that is returned may contain &quot;unbound&quot; markers if some of the
closed-over variables were unbound in the closure&rsquo;s environment.
In this case, printing the value will get an error (accessing a cell
that contains an unbound marker is always an error unless done in a
special, careful way) but the value can still be passed around.
</p></dd></dl>

<a name="closure_002dvariables_002dfun"></a><dl>
<dt><a name="index-closure_002dvariables"></a>Function: <strong>closure-variables</strong> <em>closure</em></dt>
<dd><p>Returns a list of variables closed over in <em>closure</em>.  This is
<code>equal</code> to the first argument specified to the function <code>closure</code>
when this closure was created.
</p></dd></dl>

<a name="closure_002dfunction_002dfun"></a><dl>
<dt><a name="index-closure_002dfunction"></a>Function: <strong>closure-function</strong> <em>closure</em></dt>
<dd><p>Returns the closed function from <em>closure</em>.  This is the function
that was the second argument to <code>closure</code> when the closure was
created.
</p></dd></dl>

<a name="closure_002dbindings_002dfun"></a><dl>
<dt><a name="index-closure_002dbindings"></a>Function: <strong>closure-bindings</strong> <em>closure</em></dt>
<dd><p>Returns the actual list of bindings to be performed when <em>closure</em> is entered.
This list can be passed to <code>sys:%using-binding-instances</code>
to enter the closure&rsquo;s environment without calling the closure.
See <a href="#sys_003a_0025using_002dbinding_002dinstances_002dfun">sys:%using-binding-instances-fun</a>.
</p></dd></dl>

<a name="copy_002dclosure_002dfun"></a><dl>
<dt><a name="index-copy_002dclosure"></a>Function: <strong>copy-closure</strong> <em>closure</em></dt>
<dd><p>Returns a new closure that has the same function and variable values as
<em>closure</em>.  The bindings are not shared between the old closure and
the new one, so that if the old closure changes some closed variable&rsquo;s
values, the values in the new closure do not change.
</p></dd></dl>

<a name="let_002dclosed_002dfun"></a><dl>
<dt><a name="index-let_002dclosed"></a>Special Form: <strong>let-closed</strong> <em>((variable value)...) function</em></dt>
<dd><p>When using closures, it is very common to bind a set of variables with
initial values only in order to make a closure over those variables.
Furthermore, the variables must be declared as &quot;special&quot; for the
compiler.  <code>let-closed</code> is a special form which does all of this.  It
is best described by example:
</p><div class="lisp">
<pre class="lisp">(let-closed ((a 5) b (c 'x))
   (function (lambda () ...)))

<span class="roman">macro-expands into</span>

(local-declare ((special a b c))
   (let ((a 5) b (c 'x))
      (closure '(a b c)
         (function (lambda () ...)))))
</pre></div>
</dd></dl>

<a name="g_t_0022Entities_0022"></a>
<h3 class="section">11.4 &quot;Entities&quot;</h3>
<a name="entity"></a><a name="index-entity"></a>
<p>An entity is almost the same thing as a closure; the data type is
nominally different but an entity behaves just like a closure when
applied.  The difference is that some system functions, such as
<code>print</code>, operate on them differently.  When <code>print</code> sees a closure,
it prints the closure in a standard way.  When <code>print</code> sees an entity,
it calls the entity to ask the entity to print itself.
</p>
<p>To some degree, entities are made obsolete by flavors (see <a href="#flavor">flavor</a>).
The use of entities as message-receiving objects is explained in <a href="#flavor_002dentity">flavor-entity</a>.
</p>
<a name="entity_002dfun"></a><dl>
<dt><a name="index-entity-1"></a>Function: <strong>entity</strong> <em>variable-list function</em></dt>
<dd><p>Returns a newly constructed entity.  This function is just like the
function <code>closure</code> except that it returns an entity instead of a
closure.
</p>
<p>The <em>function</em> argument should be a symbol which has a function
definition and a value.  When <code>typep</code> is applied to this entity, it
will return the value of that symbol.
</p></dd></dl>

<p>To test whether an object is an entity, use the <code>entityp</code> predicate
(see <a href="#entityp_002dfun">entityp-fun</a>).  The functions <code>symeval-in-closure</code>,
<code>closure-alist</code>, <code>closure-function</code>, etc also operate on entities.
</p>

<a name="g_t_0022Stack-Groups_0022"></a>
<h2 class="chapter">12 &quot;Stack Groups&quot;</h2>
<a name="index-_0022stack-group_0022-1"></a>
<a name="stack_002dgroup"></a><a name="stack_002dgroup_002dchapter"></a><a name="index-coroutine-1"></a>

<p>A <em>stack group</em> (usually abbreviated &quot;SG&quot;) is a type of Lisp
object useful for implementation of certain advanced control structures
such as coroutines and generators.  Processes, which are a kind of
coroutine, are built on top of stack groups (see <a href="#process">process</a>).  A stack
group represents a computation and its internal state, including the
Lisp stack.
</p>
<p>At any time, the computation being performed by the Lisp
Machine is associated with one stack group, called the <em>current</em> or
<em>running</em> stack group.  The operation of making some stack group be
the current stack group is called a <em>resumption</em> or a <em>stack group
switch</em>; the previously running stack group is said to have <em>resumed</em> the new
stack group.  The <em>resume</em> operation has two parts: first, the state
of the running computation is saved away inside the current stack group,
and secondly the state saved in the new stack group is restored, and the
new stack group is made current.  Then the computation of the new stack
group resumes its course.
</p>
<p>The stack group itself holds a great deal of state information.
It contains the control stack, or &quot;regular PDL&quot;.  The control stack is
what you are shown by the backtracing commands of the error handler
(<code>Control-B</code>, <code>Meta-B</code>, and <code>Control-Meta-B</code>); it remembers the function which
is running, its caller, its caller&rsquo;s caller, etc., and
the point of execution of each function (the &quot;return addresses&quot; of each
function).  A stack group also contains the environment stack, or
&quot;special PDL&quot;.  This contains all of the values saved by
lambda-binding.  The name &quot;stack group&quot; derives from the existence
of these two stacks.  Finally, the stack group contains various internal state
information (contents of machine registers and so on).
</p>
<p>When the state of the current
stack group is saved away, all of its bindings are undone,
and when the state is restored, the bindings are put back.
Note that although bindings are temporarily undone, unwind-protect
handlers are <em>not</em> run by a stack-group switch (see <code>let-globally</code>,
<a href="#let_002dglobally_002dfun">let-globally-fun</a>).
</p>
<p>Each stack group is a separate environment for purposes of function
calling, throwing, dynamic variable binding, and condition signalling.  All
stack groups run in the same address space; thus they share the same Lisp
data and the same global (not lambda-bound) variables.
</p>
<p>When a new stack group is created, it is empty: it doesn&rsquo;t contain the state
of any computation, so it can&rsquo;t be resumed.  In order to get things going,
the stack group must be set to an initial state.  This is done by &quot;presetting&quot;
the stack group.  To preset a stack group, you supply a function and a set
of arguments.  The stack group is placed in such a state that when it is
first resumed, this function will call those arguments.  The function is
called the &quot;initial&quot; function of the stack group.
</p>
<a name="Resuming-of-Stack-Groups"></a>
<h3 class="section">12.1 Resuming of Stack Groups</h3>

<p>The interesting thing that happens to stack groups is that they resume
each other.  When one stack group resumes a second stack group, the
current state of Lisp execution is saved away in the first stack group
and is restored from the second stack group.  Resuming is also called
&quot;switching stack groups&quot;.
</p>
<p>At any time, there is one
stack group associated with the current computation; it is called the
current stack group.  The computations associated with other stack
groups have their states saved away in memory and are not
computing.  So the only stack group that can do anything at all, in
particular resuming other stack groups, is the current one.
</p>
<p>You can look at things from the point of view of one computation.  Suppose
it is running along, and it resumes some stack group.  Its state is saved
away into the current stack group, and the computation associated with the
one it called starts up.  The original computation lies dormant in the
original stack group, while other computations go around resuming each other,
until finally the original stack group is resumed by someone.  Then the
computation is restored from the stack group and gets to run again.
</p>
<p>There are several ways that the current stack group can resume other
stack groups.  This section describes all of them.
</p>
<a name="index-resumer"></a>
<p>Associated with each stack group is a <em>resumer</em>.  The resumer is <code>nil</code>
or another stack group.  Some forms of resuming examine and alter the
resumer of some stack groups.
</p>
<p>Resuming has another ability: it can transmit a Lisp object from the
old stack group to the new stack group.  Each stack group specifies
a value to transmit whenever it resumes another stack group; whenever
a stack group is resumed, it receives a value.
</p>
<p>In the descriptions below, let <em>c</em> stand for the current stack group,
<em>s</em> stand for some other stack group, and <em>x</em> stand for any
arbitrary Lisp object.
</p>
<p>Stack groups can be used as functions.  They accept one argument.  If
<em>c</em> calls <em>s</em> as a function with one argument <em>x</em>, then <em>s</em> is
resumed, and the object transmitted is <em>x</em>.  When <em>c</em> is resumed
(usually&ndash;but not necessarily&ndash;by <em>s</em>), the object transmitted by that
resumption will be returned as the value of the call to <em>s</em>.  This is
one of the simple ways to resume a stack group: call it as a function.
The value you transmit is the argument to the function, and the value
you receive is the value returned from the function.  Furthermore, this
form of resuming sets <em>s</em>&rsquo;s resumer to be <em>c</em>.
</p>
<p>Another way to resume a stack group is to use <code>stack-group-return</code>.
Rather than allowing you to specify which stack group to resume,
this function always resumes the resumer of the current stack group.
Thus, this is a good way to resume whoever it was who resumed <em>you</em>,
assuming he did it by function-calling.  <code>stack-group-return</code> takes
one argument which is the object to transmit.  It returns when someone
resumes the current stack group, and returns one value, the object
that was transmitted by that resumption.  <code>stack-group-return</code> does
not affect the resumer of any stack group.
</p>
<p>The most fundamental way to do resuming is with <code>stack-group-resume</code>,
which takes two arguments: the stack group, and a value to transmit.
It returns when someone resumes the current stack group, returning
the value that was transmitted by that resumption,
and does not affect any stack group&rsquo;s resumer.
</p>
<p>If the initial function of <em>c</em> attempts to return a value <em>x</em>, the
regular kind of Lisp function return cannot take place, since the
function did not have any caller (it got there when the stack group was
initialized).  So instead of normal function returning, a &quot;stack group
return&quot; happens.  <em>c</em>&rsquo;s resumer is resumed, and the value transmitted
is <em>x</em>.  <em>c</em> is left in a state (&quot;exhausted&quot;) from which it cannot
be resumed again; any attempt to resume it will signal an error.  Presetting
it will make it work again.
</p>
<p>Those are the &quot;voluntary&quot; forms of stack group switch; a resumption
happens because the computation said it should.  There are also two
&quot;involuntary&quot; forms, in which another stack group is resumed without the
explicit request of the running program.
</p>
<p>If an error occurs, the current stack group resumes the error handler stack
group.  The value transmitted is partially descriptive of the error, and
the error handler looks inside the saved state of the erring stack group
to get the rest of the information.  The error handler recovers from the
error by changing the saved state of the erring stack group and then
resuming it.
</p>
<p>When certain events occur, typically a 1-second clock tick, a <em>sequence
break</em> occurs.  This forces the current stack group to resume a special
stack group called the <em>scheduler</em> (see <a href="#scheduler">scheduler</a>).  The scheduler
implements processes by resuming, one after another, the stack group of each
process that is ready to run.
</p>
<a name="current_002dstack_002dgroup_002dresumer_002dvar"></a><dl>
<dt><a name="index-current_002dstack_002dgroup_002dresumer"></a>Variable: <strong>current-stack-group-resumer</strong></dt>
<dd><p>The binding of this variable is the resumer of the current stack group.
</p></dd></dl>

<a name="current_002dstack_002dgroup_002dvar"></a><dl>
<dt><a name="index-current_002dstack_002dgroup"></a>Variable: <strong>current-stack-group</strong></dt>
<dd><p>The value of <code>current-stack-group</code> is the stack group which is
currently running.  A program can use this variable to get its hands
on its own stack group.
</p></dd></dl>

<a name="Stack-Group-States"></a>
<h3 class="section">12.2 Stack Group States</h3>

<p>A stack group has a <em>state</em>, which controls what it will do when it
is resumed.  The code number for the state is returned by the function
<code>sys:sg-current-state</code>.  This number will be the value of one of
the following symbols.  Only the states actually used by the current
system are documented here; some other codes are defined but not used.
</p>
<dl compact="compact">
<dt><code>sys:sg-state-active</code></dt>
<dd><p>The stack group is the current one.
</p>
</dd>
<dt><code>sys:sg-state-resumable</code></dt>
<dd><p>The stack group is waiting to be resumed, at which time it will pick up
its saved machine state and continue doing what it was doing before.
</p>
</dd>
<dt><code>sys:sg-state-awaiting-return</code></dt>
<dd><p>The stack group called some other stack group as a function.  When it is
resumed, it will return from that function call.
</p>
</dd>
<dt><code>sys:sg-state-awaiting-initial-call</code></dt>
<dd><p>The stack group has been preset (see below) but has never been called.
When it is resumed, it will call its initial function with the preset
arguments.
</p>
</dd>
<dt><code>sys:sg-state-exhausted</code></dt>
<dd><p>The stack group&rsquo;s initial function has returned.  It cannot be resumed.
</p>
</dd>
<dt><code>sys:sg-state-awaiting-error-recovery</code></dt>
<dd><p>When a stack group gets an error it goes into this state, which prevents
anything from happening to it until the error handler has looked at it.
In the meantime it cannot be resumed.
</p>
</dd>
<dt><code>sys:sg-state-invoke-call-on-return</code></dt>
<dd><p>When the stack group is resumed, it will call a function.  The function
and arguments are already set up on the stack.  The debugger uses this
to force the stack group being debugged to do things.
</p></dd>
</dl>

<a name="Stack-Group-Functions"></a>
<h3 class="section">12.3 Stack Group Functions</h3>

<a name="make_002dstack_002dgroup_002dfun"></a><dl>
<dt><a name="index-make_002dstack_002dgroup"></a>Function: <strong>make-stack-group</strong> <em>name &amp;optional options</em></dt>
<dd><p>This creates and returns a new stack group.  <em>name</em> may be any symbol
or string; it is used in the stack group&rsquo;s printed representation.
<em>options</em> is a list of alternating keywords and values.  The options
are not too useful; most calls to <code>make-stack-group</code> don&rsquo;t need any
options at all.  The options are:
</p><dl compact="compact">
<dt><code>:sg-area</code></dt>
<dd><p>The area in which to create the stack group structure itself.
Defaults to the default area (the value of <code>default-cons-area</code>).
</p>
</dd>
<dt><code>:regular-pdl-area</code></dt>
<dd><p>The area in which to create the regular PDL.  Note that this
may not be any area; only certain areas will do, because regular PDLs
are cached in a hardware device called the <em>pdl buffer</em>.
The default is <code>sys:pdl-area</code>.
</p>
</dd>
<dt><code>:special-pdl-area</code></dt>
<dd><p>The area in which to create the special PDL.
Defaults to the default area (the value of <code>default-cons-area</code>).
</p>
</dd>
<dt><code>:regular-pdl-size</code></dt>
<dd><p>Length of the regular PDL to be created.  Defaults to 3000 octal.
</p>
</dd>
<dt><code>:special-pdl-size</code></dt>
<dd><p>Length of the special PDL to be created.  Defaults to 2000 octal.
</p>
</dd>
<dt><code>:swap-sv-on-call-out</code></dt>
<dt><code>:swap-sv-of-sg-that-calls-me</code></dt>
<dd><a name="index-_003aswap_002dsv_002dof_002dsg_002dthat_002dcalls_002dme-make_002dstack_002dgroup"></a>
<p>These flags default to 1.  If these are 0, the system does not maintain
separate binding environments for each stack group.  You do not want
to use this feature.
</p>
</dd>
<dt><code>:trap-enable</code></dt>
<dd><p>This determines what to do if a microcode error occurs.  If it is <code>1</code>
the system tries to handle the error; if it is <code>0</code> the machine halts.
Defaults to <code>1</code>.  It is zero only in the error handler stack group, a
trap in which would not work anyway.
</p>
</dd>
<dt><code>:safe</code></dt>
<dd><p>If this flag is <code>1</code> (the default), a strict call-return discipline among
stack-groups is enforced.  If <code>0</code>, no restriction on stack-group
switching is imposed.
</p></dd>
</dl>
</dd></dl>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003apdl_002doverflow"></a>Condition on sys:pdl-overflow: <strong>(<code>error</code>)</strong></dt>
<dd><p>This condition is signaled when there is overflow on either the regular
pdl or the special pdl.  The <code>:pdl-name</code> operation on the condition
instance returns either <code>:special</code> or <code>:regular</code>, to tell handlers
which one.
</p>
<p>The <code>:grow-pdl</code> proceed type is provided.  It takes no arguments.
Proceeding from the error automatically makes the affected pdl bigger.
</p></dd></dl>

<a name="eh_003apdl_002dgrow_002dratio_002dvar"></a><dl>
<dt><a name="index-eh_003apdl_002dgrow_002dratio"></a>Variable: <strong>eh:pdl-grow-ratio</strong></dt>
<dd><p>This is the factor by which to increase the size of a pdl after an overflow.
It is initially <code>1.5</code>.
</p></dd></dl>

<a name="stack_002dgroup_002dpreset_002dfun"></a><dl>
<dt><a name="index-stack_002dgroup_002dpreset"></a>Function: <strong>stack-group-preset</strong> <em>stack-group function &amp;rest arguments</em></dt>
<dd><p>This sets up <em>stack-group</em> so that when it is resumed,
<em>function</em> will be applied to <em>arguments</em> within the stack group.
Both stacks are made empty; all saved state in the stack group is destroyed.
<code>stack-group-preset</code> is typically used to initialize a stack group just after it is made,
but it may be done to any stack group at any time.  Doing this to a stack
group which is not exhausted will destroy its present state without
properly cleaning up by running <code>unwind-protect</code>s.
</p></dd></dl>

<a name="stack_002dgroup_002dresume_002dfun"></a><dl>
<dt><a name="index-stack_002dgroup_002dresume"></a>Function: <strong>stack-group-resume</strong> <em>s x</em></dt>
<dd><p>Resumes <em>s</em>, transmitting the value <em>x</em>.
No stack group&rsquo;s resumer is affected.
</p></dd></dl>

<a name="si_003asg_002dresumable_002dp_002dfun"></a><dl>
<dt><a name="index-si_003asg_002dresumable_002dp"></a>Function: <strong>si:sg-resumable-p</strong> <em>s</em></dt>
<dd><p><code>t</code> if <em>s</em>&rsquo;s state permits it to be resumed.
</p></dd></dl>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003awrong_002dstack_002dgroup_002dstate"></a>Condition on sys:wrong-stack-group-state: <strong>(<code>error</code>)</strong></dt>
<dd><p>This is signaled if, for example, you try to resume a stack group which
is in the &quot;exhausted&quot; state.
</p></dd></dl>

<a name="stack_002dgroup_002dreturn_002dfun"></a><dl>
<dt><a name="index-stack_002dgroup_002dreturn"></a>Function: <strong>stack-group-return</strong> <em>x</em></dt>
<dd><p>Resumes the current stack group&rsquo;s resumer, transmitting the value <em>x</em>.
No stack group&rsquo;s resumer is affected.
</p></dd></dl>

<a name="symeval_002din_002dstack_002dgroup_002dfun"></a><dl>
<dt><a name="index-symeval_002din_002dstack_002dgroup"></a>Function: <strong>symeval-in-stack-group</strong> <em>symbol sg &amp;optional frame as-if-current</em></dt>
<dd><p>Evaluates the variable <em>symbol</em> in the binding environment of
<em>sg</em>.  If <em>frame</em> is not <code>nil</code>, if evaluates <em>symbol</em> in the
binding environment of execution in that frame.  (A frame is an index
in the stack group&rsquo;s regular pdl).
</p>
<p>Two values are returned: the symbol&rsquo;s value, and a locative to where
the value is stored.  If <em>as-if-current</em> is not <code>nil</code>, the
locative points to where the value <em>would</em> be stored if <em>sg</em> were
running.  This may be different from where the value is stored now;
for example, the current binding in stack group <em>sg</em> is stored in
<em>symbol</em>&rsquo;s value cell when <em>sg</em> is running, but is probably
stored in <em>sg</em>&rsquo;s special pdl when <em>sg</em> is not running.
<em>as-if-current</em> makes no difference if <em>sg</em> actually <em>is</em>
the current stack group.
</p>
<p>If <em>symbol</em> is unbound in the specified stack group and frame,
this will get an unbound-variable error.
</p></dd></dl>

<a name="Analyzing-Stack-Frames"></a>
<h3 class="section">12.4 Analyzing Stack Frames</h3>

<p>A stack frame is represented by an index in the regular pdl array of the
stack group.  The word at this index is the function executing, or to be
called, in the frame.  The following words in the pdl contain the
arguments.
</p>
<a name="sg_002dregular_002dpdl_002dfun"></a><dl>
<dt><a name="index-sg_002dregular_002dpdl"></a>Function: <strong>sg-regular-pdl</strong> <em>sg</em></dt>
<dd><p>Returns the regular pdl of <em>sg</em>.  This is an array of type
<code>art-reg-pdl</code>.  Stack frames are represented as indices into this array.
</p></dd></dl>

<a name="sg_002dregular_002dpdl_002dpointer_002dfun"></a><dl>
<dt><a name="index-sg_002dregular_002dpdl_002dpointer"></a>Function: <strong>sg-regular-pdl-pointer</strong> <em>sg</em></dt>
<dd><p>Returns the index in <em>sg</em>&rsquo;s regular pdl of the last word pushed.
</p></dd></dl>

<a name="sg_002dspecial_002dpdl_002dfun"></a><dl>
<dt><a name="index-sg_002dspecial_002dpdl"></a>Function: <strong>sg-special-pdl</strong> <em>sg</em></dt>
<dd><p>Returns the special pdl of <em>sg</em>.  This is an array of type
<code>art-special-pdl</code>, used to hold special bindings made by functions
executing in that stack group.
</p></dd></dl>

<a name="sg_002dspecial_002dpdl_002dpointer_002dfun"></a><dl>
<dt><a name="index-sg_002dspecial_002dpdl_002dpointer"></a>Function: <strong>sg-special-pdl-pointer</strong> <em>sg</em></dt>
<dd><p>Returns the index in <em>sg</em>&rsquo;s special pdl of the last word pushed.
</p></dd></dl>

<p>The following functions are used to move from one stack frame to
another.
</p>
<a name="eh_003asg_002dinnermost_002dactive_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dinnermost_002dactive"></a>Function: <strong>eh:sg-innermost-active</strong> <em>sg</em></dt>
<dd><p>Returns (the regular pdl index of) the innermost frame in <em>sg</em>, the
one that would be executing if <em>sg</em> were current.  If <em>sg</em> is
current, the value is the frame of the caller of this function.
</p></dd></dl>

<a name="eh_003asg_002dnext_002dactive_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dnext_002dactive"></a>Function: <strong>eh:sg-next-active</strong> <em>sg frame</em></dt>
<dd><p>Returns the next active frame out from
<em>frame</em> in <em>sg</em>.  This is the one that called <em>frame</em>.  If
<em>frame</em> is the outermost frame, the value is <em>nil</em>.
</p></dd></dl>

<a name="eh_003asg_002dprevious_002dactive_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dprevious_002dactive"></a>Function: <strong>eh:sg-previous-active</strong> <em>sg frame</em></dt>
<dd><p>Returns the previous active frame in from <em>frame</em> in <em>sg</em>.
This is the one called by <em>frame</em>.  If <em>frame</em> is the currently
executing frame, the value is <code>nil</code>.  If <em>frame</em> is <code>nil</code>,
the value is the outermost or initial frame.
</p></dd></dl>

<a name="eh_003asg_002dinnermost_002dopen_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dinnermost_002dopen"></a>Function: <strong>eh:sg-innermost-open</strong> <em>sg</em></dt>
<dd><p>Returns the innermost open frame in <em>sg</em>, which may be the same as the
innermost active or it may be within it.  In other respects, this is
like <code>eh:sg-innermost-active</code>.
</p></dd></dl>

<a name="eh_003asg_002dnext_002dopen_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dnext_002dopen"></a>Function: <strong>eh:sg-next-open</strong> <em>sg frame</em></dt>
<dd><p>Like <code>eh:sg-next-active</code> but includes frames which are <em>open</em>, that is,
still accumulating arguments prior to calling the function.
</p></dd></dl>

<a name="eh_003asg_002dprevious_002dopen_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dprevious_002dopen"></a>Function: <strong>eh:sg-previous-open</strong> <em>sg frame</em></dt>
<dd><p>Like <code>eh:sg-previous-active</code> but includes frames which are <em>open</em>, that is,
still accumulating arguments prior to calling the function.
</p></dd></dl>

<a name="eh_003asg_002dframe_002dactive_002dp_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dframe_002dactive_002dp"></a>Function: <strong>eh:sg-frame-active-p</strong> <em>sg frame</em></dt>
<dd><p>Returns <code>t</code> if <em>frame</em> is active; that is, if the function has been
entered.
</p></dd></dl>

<p>Running interpreted code involves calls to <code>eval</code>, <code>cond</code>, etc.
which would not be there in compiled code.  The following three
functions can be used to skip over the stack frames of such functions,
showing only the frames for the functions the user would know about.
</p>
<a name="eh_003asg_002dnext_002dinteresting_002dactive_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dnext_002dinteresting_002dactive"></a>Function: <strong>eh:sg-next-interesting-active</strong> <em>sg frame</em></dt>
<dd><p>Like <code>eh:sg-next-active</code> but skips over uninteresting frames.
</p></dd></dl>

<a name="eh_003asg_002dprevious_002dinteresting_002dactive_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dprevious_002dinteresting_002dactive"></a>Function: <strong>eh:sg-previous-interesting-active</strong> <em>sg frame</em></dt>
<dd><p>Like <code>eh:sg-previous-active</code> but skips over uninteresting frames.
</p></dd></dl>

<a name="eh_003asg_002dout_002dto_002dinteresting_002dactive_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dout_002dto_002dinteresting_002dactive"></a>Function: <strong>eh:sg-out-to-interesting-active</strong> <em>sg frame</em></dt>
<dd><p>If <em>frame</em> is interesting, returns <em>frame</em>.  Otherwise, it returns
the next interesting active frame.
</p></dd></dl>

<p>These functions are used to analyze the data in a particular stack
frame:
</p>
<a name="sys_003arp_002dfunction_002dword_002dfun"></a><dl>
<dt><a name="index-sys_003arp_002dfunction_002dword"></a>Function: <strong>sys:rp-function-word</strong> <em>regpdl frame</em></dt>
<dd><p>Returns the function executing in <em>frame</em>.  <em>regpdl</em> should be
the <code>sg-regular-pdl</code> of the stack group.
</p></dd></dl>

<a name="eh_003asg_002dframe_002dnumber_002dof_002dspread_002dargs_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dframe_002dnumber_002dof_002dspread_002dargs"></a>Function: <strong>eh:sg-frame-number-of-spread-args</strong> <em>sg frame</em></dt>
<dd><p>Returns the number of arguments received by <em>frame</em>, which should be
an active frame.  The rest argument (if any) and arguments
received by it, do not count.
</p></dd></dl>

<a name="eh_003asg_002dframe_002darg_002dvalue_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dframe_002darg_002dvalue"></a>Function: <strong>eh:sg-frame-arg-value</strong> <em>sg frame n</em></dt>
<dd><p>Returns the value of argument number <em>n</em> of stack frame <em>frame</em> in
<em>sg</em>.  An error is signaled if <em>n</em> is out of range, if the frame is
active.  (For an open frame, the number of arguments is not yet
known, so there is no error check.)
</p>
<p>The second value is the location in which the argument is stored when
<em>sg</em> is running.  The location may not actually be in the stack, if
the argument is special.  The location may then contain other contents
when the stack group is not running.
</p></dd></dl>

<a name="eh_003asg_002dframe_002drest_002darg_002dvalue_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dframe_002drest_002darg_002dvalue"></a>Function: <strong>eh:sg-frame-rest-arg-value</strong> <em>sg frame</em></dt>
<dd><p>Returns the value of the rest argument in <em>frame</em>, or <code>nil</code> if there
is none.
</p>
<p>The second value is <code>t</code> if the function called in <em>frame</em> expects an
explicitly passed rest argument.
</p>
<p>The third value is <code>t</code> if the rest argument was passed explicitly.
If this is <code>nil</code>, the rest arg is a stack list that overlaps the
arguments of stack frame <em>frame</em>.  (If passed explicitly, it may still
be a stack list, but not in this frame.)
</p></dd></dl>

<a name="eh_003asg_002dframe_002dnumber_002dof_002dlocals_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dframe_002dnumber_002dof_002dlocals"></a>Function: <strong>eh:sg-frame-number-of-locals</strong> <em>sg frame</em></dt>
<dd><p>Returns the number of local variables in stack frame <em>frame</em>.
</p></dd></dl>

<a name="eh_003asg_002dframe_002dlocal_002dvalue_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dframe_002dlocal_002dvalue"></a>Function: <strong>eh:sg-frame-local-value</strong> <em>sg frame n</em></dt>
<dd><p>Returns the value of local variable number <em>n</em> of stack frame <em>frame</em> in
<em>sg</em>.  An error is signaled if <em>n</em> is out of range.
</p>
<p>The second value is the location in which the local is stored when
<em>sg</em> is running.  The location may not actually be in the stack; if
not, it may have other contents when the stack group is not running.
</p></dd></dl>

<a name="eh_003asg_002dframe_002dvalue_002dvalue_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dframe_002dvalue_002dvalue"></a>Function: <strong>eh:sg-frame-value-value</strong> <em>sg frame n &amp;optional create-slot</em></dt>
<dd><p>Returns the value and location of the <em>n</em>&rsquo;th multiple value <em>frame</em>
has returned.  If <em>frame</em> has not begun to return values, the value of
the value will be <code>nil</code> but the location will still be valid.
</p>
<p>If <em>frame</em> was called with <code>multiple-value-list</code>, it can return any
number of values, but they do not have cells to receive them until
<em>frame</em> returns them.  In this case, a non-<code>nil</code> <em>create-slot</em>
means that this function should allocate cells as necessary so that a
valid location can be returned.  Otherwise, the location as well as the
value will be <code>nil</code>.
</p></dd></dl>

<a name="eh_003asg_002dframe_002dvalue_002dlist_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dframe_002dvalue_002dlist"></a>Function: <strong>eh:sg-frame-value-list</strong> <em>sg frame &amp;optional new-number-of-values</em></dt>
<dd><p>Returns three values that describe whether <em>frame</em>&rsquo;s caller wants
multiple values, and any values <em>frame</em> has returned already.
</p>
<p>The first value is a list in which live the values being or to be
returned by <em>frame</em>.
</p>
<p>The second value is <code>nil</code> if this frame has not been invoked to return multiple values,
a number which is the number of values it has been asked for,
or a locative, meaning the frame was called with <code>multiple-value-list</code>.
In the last case, the first value includes only the values <em>frame</em>
has returned already, and the locative points to a cell that points
to the cons whose cdr should receive the next link of the list.
</p>
<p>The third value is how many values <em>frame</em> has returned so far.
</p>
<p>If <em>new-number-of-values</em> is non-<code>nil</code>, it is used to alter the
&quot;number of values already returned&quot; as recorded in the stack group.
This may alter the length of the list that is the first value.
The value you get is the altered one, in that case.
</p></dd></dl>

<a name="eh_003asg_002dframe_002dspecial_002dpdl_002drange_002dfun"></a><dl>
<dt><a name="index-eh_003asg_002dframe_002dspecial_002dpdl_002drange"></a>Function: <strong>eh:sg-frame-special-pdl-range</strong> <em>sg frame</em></dt>
<dd><p>Returns two values delimiting the range of <em>sg</em>&rsquo;s special pdl that
belongs to the specified stack frame.  The first value is the index of
the first special pdl word that belongs to the frame, and the second
value is the index of the next word that does not belong to it.
</p>
<p>If the specified frame has no special bindings, both values are <code>nil</code>.
Otherwise, the indicated special pdl words describe bindings made on
entry to or during execution in this frame.  The words come in pairs.
</p>
<p>The first word of each pair contains the saved value; the second points
to the location that was bound.  When the stack group is not current,
the saved value is the value for the binding made in this frame.  When
the stack group is current, the saved value is the shadowed value, and
the value for this binding is either in the cell that was bound, or is
the saved value of another binding, at a higher index, of the same cell.
</p>
<p>The bit <code>sys:%%specpdl-closure-binding</code> is nonzero in the first word
of the pair if the binding was made before entry to the function itself.
This includes bindings made by closures, and by instances (including
<code>self</code>).  Otherwise, the binding was made by the function itself.
This includes arguments that are declared special.
</p></dd></dl>

<p><code>symeval-in-stack-group</code> can be used to find the value of a special
variable at a certain stack frame.
</p>
<a name="Input_002fOutput-in-Stack-Groups"></a>
<h3 class="section">12.5 Input/Output in Stack Groups</h3>
<a name="sg_002dterminal_002dio_002dissues"></a>
<p>Because each stack group has its own set of dynamic bindings, a
stack group will not inherit its creator&rsquo;s value of <code>terminal-io</code>
(see <a href="#terminal_002dio_002dvar">terminal-io-var</a>), nor its caller&rsquo;s, unless you make special
provision for this.  The <code>terminal-io</code> a stack group gets by default
is a &quot;background&quot; stream that does not normally expect to be used.  If
it is used, it will turn into a &quot;background window&quot; that will request
the user&rsquo;s attention.  Usually this is because an error printout is
trying to be printed on the stream.  [This will all be explained
in the window system documentation.]
</p>
<p>If you write a program that uses multiple stack groups, and you want
them all to do input and output to the terminal, you should pass the
value of <code>terminal-io</code> to the top-level function of each stack group
as part of the <code>stack-group-preset</code>, and that function should bind
the variable <code>terminal-io</code>.
</p>
<p>Another technique is to use a closure as the top-level function
of a stack group.  This closure can bind <code>terminal-io</code> and any other
variables that should be shared between the stack group and its
creator.
</p>

<a name="An-Example-of-Stack-Groups"></a>
<h3 class="section">12.6 An Example of Stack Groups</h3>

<p>The canonical coroutine example is the so-called samefringe problem:
Given two trees, determine whether they contain the same
atoms in the same order, ignoring parenthesis structure.  A better
way of saying this is, given two binary trees built out of conses,
determine whether the sequence of atoms on the fringes of the trees
is the same, ignoring differences in the arrangement of the
internal skeletons of the two trees.  Following the usual rule
for trees, <code>nil</code> in the cdr of a cons is to be ignored.
</p>
<p>One way of solving this problem is to use <em>generator</em> coroutines.
We make a generator for each tree.  Each time the generator is called
it returns the next element of the fringe of its tree.  After the
generator has examined the entire tree, it returns a special &quot;exhausted&quot;
flag.  The generator is most naturally written as a recursive function.
The use of coroutines, i.e stack groups, allows the two generators to
recurse separately on two different control stacks without having to
coordinate with each other.
</p>
<p>The program is very simple.  Constructing it in the usual bottom-up style,
we first write a recursive function that takes a tree and <code>stack-group-return</code>s
each element of its fringe.  The <code>stack-group-return</code> is how the generator
coroutine delivers its output.  We could easily test this function by changing
<code>stack-group-return</code> to <code>print</code> and trying it on some examples.
</p><div class="lisp">
<pre class="lisp">(defun fringe (tree)
  (cond ((atom tree) (stack-group-return tree))
	(t (fringe (car tree))
	   (if (not (null (cdr tree)))
	       (fringe (cdr tree))))))
</pre></div>

<p>Now we package this function inside another, which takes care of
returning the special &quot;exhausted&quot; flag.
</p><div class="lisp">
<pre class="lisp">(defun fringe1 (tree exhausted)
  (fringe tree)
  exhausted)
</pre></div>

<p>The <code>samefringe</code> function takes the two trees as arguments and returns
<code>t</code> or <code>nil</code>.  It creates two stack groups to act as the two
generator coroutines, presets them to run the <code>fringe1</code> function, then
goes into a loop comparing the two fringes.  The value is <code>nil</code> if a difference
is discovered, or <code>t</code> if they are still the same when the end is reached.
</p><div class="lisp">
<pre class="lisp">(defun samefringe (tree1 tree2)
  (let ((sg1 (make-stack-group &quot;samefringe1&quot;))
	(sg2 (make-stack-group &quot;samefringe2&quot;))
	(exhausted (ncons nil)))
    (stack-group-preset sg1 #'fringe1 tree1 exhausted)
    (stack-group-preset sg2 #'fringe1 tree2 exhausted)
    (do ((v1) (v2)) (nil)
      (setq v1 (funcall sg1 nil)
	    v2 (funcall sg2 nil))
      (cond ((neq v1 v2) (return nil))
	    ((eq v1 exhausted) (return t))))))
</pre></div>

<p>Now we test it on a couple of examples.
</p><div class="lisp">
<pre class="lisp">(samefringe '(a b c) '(a (b c))) =&gt; t
(samefringe '(a b c) '(a b c d)) =&gt; nil
</pre></div>

<p>The problem with this is that a stack group is quite a large object, and
we make two of them every time we compare two fringes.  This is a lot of
unnecessary overhead.  It can easily be eliminated with a modest amount
of explicit storage allocation, using the resource facility (see
<a href="#defresource_002dfun">defresource-fun</a>).  While we&rsquo;re at it, we can avoid making the
exhausted flag fresh each time; its only important property is that it
not be an atom.
</p><div class="lisp">
<pre class="lisp">(defresource samefringe-coroutine ()
   :constructor (make-stack-group &quot;for-samefringe&quot;))

(defvar exhausted-flag (ncons nil))

(defun samefringe (tree1 tree2)
  (using-resource (sg1 samefringe-coroutine)
    (using-resource (sg2 samefringe-coroutine)
      (stack-group-preset sg1 #'fringe1 tree1 exhausted-flag)
      (stack-group-preset sg2 #'fringe1 tree2 exhausted-flag)
      (do ((v1) (v2)) (nil)
	(setq v1 (funcall sg1 nil)
	      v2 (funcall sg2 nil))
	(cond ((neq v1 v2) (return nil))
	      ((eq v1 exhausted-flag) (return t)))))))
</pre></div>

<p>Now we can compare the fringes of two trees with no allocation of memory whatsoever.
</p>
<a name="g_t_0022Locatives_0022"></a>
<h2 class="chapter">13 &quot;Locatives&quot;</h2>
<a name="index-locative"></a>
<a name="locative"></a>
<a name="g_t_0022Cells-and-Locatives_0022"></a>
<h3 class="section">13.1 &quot;Cells and Locatives&quot;</h3>
<a name="index-cell"></a>
<a name="locative_002dchapter"></a>
<p>A <em>locative</em> is a type of Lisp object used as a <em>pointer</em>
to a <em>cell</em>.  Locatives are inherently a more &quot;low level&quot; construct
than most Lisp objects; they require some knowledge of the nature of
the Lisp implementation.
</p>
<p>A <em>cell</em> is a machine word that can hold a (pointer to a)
Lisp object.  For example, a symbol has five cells: the print name cell,
the value cell, the function cell, the property list cell, and the
package cell.  The value cell holds (a pointer to) the binding of the
symbol, and so on.  Also, an array leader of length <em>n</em> has <em>n</em>
cells, and an <code>art-q</code> array of <em>n</em> elements has <em>n</em> cells.
(Numeric arrays do not have cells in this sense.)  A locative is
an object that points to a cell; it lets you refer to a cell so that
you can examine or alter its contents.
</p>
<a name="contents_002dfun"></a><dl>
<dt><a name="index-contents"></a>Function: <strong>contents</strong> <em>locative</em></dt>
<dd><p>Returns the contents of the cell which the locative points to.
This is actually the same as <code>cdr</code>, for reasons explained below.
</p>
<p>To modify the contents of the cell, use <code>setf</code> on <code>contents</code>:
</p><div class="lisp">
<pre class="lisp">(setf (contents loc) newvalue)
</pre></div>
</dd></dl>

<p>The macro <code>locf</code> (see <a href="#locf_002dfun">locf-fun</a>) can be used to convert a form
that accesses a cell to one that creates a locative pointer to that
cell: for example,
</p><div class="lisp">
<pre class="lisp">(locf (fsymeval x))
</pre></div>
<p>evaluates to a locative that points to the function cell of the value of
<code>x</code>; that is to say, it points to the place where <code>(fsymeval x)</code> is
stored.
</p>
<p><code>locf</code> is very convenient because it saves the writer and reader of
a program from having to remember the names of many functions that would
create locatives to cells found in different fashions.
</p>
<p>One thing you should know is that it is not possible to make a locative
to an element of a numeric array.  For example,
</p><div class="lisp">
<pre class="lisp">(setq foo (make-array 10 ':type art-1b))
(locf (aref foo 0))
</pre></div>
<p>will get an error.  Locatives may only point at entire words of memory,
which contain standard Lisp data.
</p>
<p>Because of cdr-coding (see <a href="#cdr_002dcode">cdr-code</a>), a cons does not always
contain an explicit cell which points to its cdr.  Therefore, it is
impossible to obtain a locative which points to such a cell.  However,
this is such a useful thing to do that <em>the cons itself</em> is usually
treated as if it were a locative pointing to a cell which holds the
cons&rsquo;s cdr.  <code>(locf (cdr x))</code> returns the value of <code>x</code>, and
<code>(contents x)</code> returns the cdr when <em>x</em> is a cons, so
<code>(contents (locf (cdr x)))</code> is the same as <code>(cdr x)</code>, as it should
be.  Most functions that are normally given locatives will accept a cons
as a &quot;locative&quot; to its cdr.
</p>
<p>A cons always does contain a cell which points to the car, and
<code>(locf (car x))</code> will return a locative whose pointer field is the
same as that of <code>x</code>&rsquo;s value.
</p>
<a name="g_t_0022Functions-That-Operate-on-Locatives_0022"></a>
<h3 class="section">13.2 &quot;Functions That Operate on Locatives&quot;</h3>

<a name="location_002dboundp_002dfun"></a><dl>
<dt><a name="index-location_002dboundp"></a>Function: <strong>location-boundp</strong> <em>locative</em></dt>
<dd><p>This returns <code>t</code> if the cell to which <em>locative</em> points contains
anything except an &quot;unbound&quot; marker.
</p>
<p>The unbound marker is a special data type, <code>dtp-null</code>, which is stored
in cells to say that their value is missing.  For example, an unbound
variable actually has an unbound marker in its value cell, and
<code>(location-boundp (locf x))</code> is equivalent to <code>(variable-boundp x)</code>.
</p></dd></dl>

<a name="location_002dmakunbound_002dfun"></a><dl>
<dt><a name="index-location_002dmakunbound"></a>Function: <strong>location-makunbound</strong> <em>locative</em></dt>
<dd><p>This stores an &quot;unbound&quot; marker into the cell to which <em>locative</em> points.
</p></dd></dl>

<p>Other functions with which locatives are expected or useful include
<code>get</code> (the locative points to the cell in which the plist is stored),
<code>store-conditional</code> (the locative points to the cell to be tested and
modified), and <code>bind</code> (the locative points to the cell to be bound).
</p>
<a name="Mixing-Locatives-with-Lists"></a>
<h3 class="section">13.3 Mixing Locatives with Lists</h3>

<p>Either of the functions <code>car</code> and <code>cdr</code> (see <a href="#car_002dfun">car-fun</a>) may
be given a locative, and will return the contents of the cell at which
the locative points.  They are both equivalent to <code>contents</code> when the
argument is a locative.
</p>
<p>Similarly, either of the functions <code>rplaca</code> and <code>rplacd</code> may
be used to store an object into the cell at which a locative
points.
</p><div class="lisp">
<pre class="lisp">For example,
</pre><pre class="lisp">(rplaca locative y)
</pre><pre class="lisp">is the same as
</pre><pre class="lisp">(setf (contents locative) y)
</pre></div>

<p>If you are just using locatives, you should use <code>contents</code>
rather than <code>car</code> or <code>cdr</code>.  But you can also mix locatives and
conses.  For example, the same variable may usefully sometimes have a
locative as its value and sometimes a cons.  Then it is useful that
<code>car</code> and <code>cdr</code> work on locatives, and it also matters which one you
use.  Pick the one that is right for the case of a cons.
</p>
<p>For example, the following function conses up a list in the forward
order by adding onto the end.  It needs to know where to put the pointer
to the next cell.  Usually it goes in the previous cell&rsquo;s cdr, but
the first cell gets put in the cell where the list is supposed to end
up.  A locative is used as the pointer to this cell.  The first time
through the loop, the <code>rplacd</code> is equivalent to <code>(setq res ...)</code>; on
later times through the loop the <code>rplacd</code> tacks an additional cons
onto the end of the list.
</p><div class="lisp">
<pre class="lisp">(defun simplified-version-of-mapcar (fcn lst)
  (do ((lst lst (cdr lst))
       (res nil)
       (loc (locf res)))
      ((null lst) res)
    (rplacd loc
	    (setq loc (ncons (funcall fcn (car lst)))))))
</pre></div>

<a name="g_t_0022Subprimitives_0022"></a>
<h2 class="chapter">14 &quot;Subprimitives&quot;</h2>
<a name="subprimitive_002dchapter"></a><a name="index-subprimitive"></a>
<p>Subprimitives are functions which are not intended to be used by
the average program, only by &quot;system programs&quot;.  They allow one to
manipulate the environment at a level lower than normal Lisp.
They are described in this chapter.
Subprimitives usually have names starting with a <code>%</code> character.
The &quot;primitives&quot; described in other sections of the manual typically
use subprimitives to accomplish their work.  To some extent the subprimitives take
the place of what in other systems would be individual machine instructions.
Subprimitives are normally hand-coded in microcode.
	There is plenty of stuff in this chapter that is not fully
explained; there are terms that are undefined, there are forward references,
and so on.  Furthermore, most of what is in here is considered subject
to change without notice.  In fact, this chapter does not exactly belong
in this manual, but in some other more low-level manual.  Since the latter
manual does not exist, it is here for the interim.
	Subprimitives by their very nature cannot do full checking.
Improper use of subprimitives can destroy the environment.
Subprimitives come in varying degrees of dangerousness.  Those without
a <code>%</code> sign in their name cannot destroy the environment, but are
dependent on &quot;internal&quot; details of the Lisp implementation.  The ones
whose names start with a <code>%</code> sign can
violate system conventions if used improperly.  The subprimitives are documented here
since they need to be documented somewhere, but this manual does not
document all the things you need to know in order to use them.  Still other
subprimitives are not documented here because they are very specialized.
Most of these are never used explicitly by a programmer; the compiler
inserts them into the program to perform operations which are expressed
differently in the source code.
	The most common problem you can cause using subprimitives, though
by no means the only one, is to create illegal pointers: pointers
that are, for one reason or another, according to storage conventions,
not allowed to exist.  The storage conventions are not documented;
as we said, you have to be an expert to use a lot of the functions
in this chapter correctly.  If you create such an illegal pointer, it probably will
not be detected immediately, but later on parts of the system may see it,
notice that it is illegal, and (probably) halt the Lisp Machine.
	In a certain sense <code>car</code>, <code>cdr</code>, <code>rplaca</code>, and <code>rplacd</code> are
subprimitives.  If these are given a locative instead of a list, they will
access or modify the cell addressed by the locative without regard to what
object the cell is inside.  Subprimitives can be used to create locatives
to strange places.
</p>
<a name="Data-Types"></a>
<h3 class="section">14.1 Data Types</h3>

<a name="data_002dtype_002dfun"></a><dl>
<dt><a name="index-data_002dtype"></a>Function: <strong>data-type</strong> <em>arg</em></dt>
<dd><p><code>data-type</code> returns a symbol that is the name
for the internal data-type of the &quot;pointer&quot; that represents <em>arg</em>.
Note that some types as seen by the user are not distinguished from each other
at this level, and some user types may be represented by more than one
internal type.  For example, <code>dtp-extended-number</code> is the symbol that
<code>data-type</code> would return for either a flonum or a bignum, even though
those two types are quite different.
The <code>typep</code> function (<a href="#typep_002dfun">typep-fun</a>) is a higher-level
primitive that is more useful in most cases; normal programs
should always use <code>typep</code> rather than <code>data-type</code>.
Some of these type codes are internal tag fields that are never
used in pointers that represent Lisp objects at all, but they are
documented here anyway.
</p><dl compact="compact">
<dt><code>dtp-symbol</code></dt>
<dd><p>The object is a symbol.
</p></dd>
<dt><code>dtp-fix</code></dt>
<dd><p>The object is a fixnum; the numeric value is contained in the address
field of the pointer.
</p></dd>
<dt><code>dtp-small-flonum</code></dt>
<dd><p>The object is a small flonum; the numeric value is contained in the
address field of the pointer.
</p></dd>
<dt><code>dtp-extended-number</code></dt>
<dd><p>The object is a flonum or a bignum.  This value will also be used for
future numeric types.
</p></dd>
<dt><code>dtp-list</code></dt>
<dd><p>The object is a cons.
</p></dd>
<dt><code>dtp-locative</code></dt>
<dd><p>The object is a locative pointer.
</p></dd>
<dt><code>dtp-array-pointer</code></dt>
<dd><p>The object is an array.
</p></dd>
<dt><code>dtp-fef-pointer</code></dt>
<dd><p>The object is a compiled function.
</p></dd>
<dt><code>dtp-u-entry</code></dt>
<dd><p>The object is a microcode entry.
</p></dd>
<dt><code>dtp-closure</code></dt>
<dd><p>The object is a closure; see <a href="#closure">closure</a>.
</p></dd>
<dt><code>dtp-stack-group</code></dt>
<dd><p>The object is a stack-group; see <a href="#stack_002dgroup">stack-group</a>.
</p></dd>
<dt><code>dtp-instance</code></dt>
<dd><p>The object is an instance of a flavor; see <a href="#flavor">flavor</a>.
</p></dd>
<dt><code>dtp-entity</code></dt>
<dd><p>The object is an entity; see <a href="#entity">entity</a>.
</p></dd>
<dt><code>dtp-select-method</code></dt>
<dd><p>The object is a &quot;select-method&quot;; see <a href="#select_002dmethod">select-method</a>.
</p></dd>
<dt><code>dtp-header</code></dt>
<dd><p>An internal type used to mark the first word of a multi-word structure.
</p></dd>
<dt><code>dtp-array-header</code></dt>
<dd><p>An internal type used to mark the first word of an array.
</p></dd>
<dt><code>dtp-symbol-header</code></dt>
<dd><p>An internal type used to mark the first word of a symbol.
</p></dd>
<dt><code>dtp-instance-header</code></dt>
<dd><p>An internal type used to mark the first word of an instance.
</p></dd>
<dt><code>dtp-null</code></dt>
<dd><p>Nothing to do with <code>nil</code>.  This is used in unbound value and function cells.
An attempt to refer to the contents of a cell that contains a <code>dtp-null</code>
gets an error.  This is how &quot;unbound variable&quot; and &quot;undefined function&quot; errors are detected.
</p></dd>
<dt><code>dtp-trap</code></dt>
<dd><p>The zero data-type, which is not used.  This hopes to detect microcode bugs.
</p></dd>
<dt><code>dtp-free</code></dt>
<dd><p>This type is used to fill free storage, to catch wild references.
</p></dd>
<dt><code>dtp-external-value-cell-pointer</code></dt>
<dd><p>An &quot;invisible pointer&quot; used for external value cells,
which are part of the closure mechanism (see <a href="#closure">closure</a>),
and used by compiled code to address value and function cells.
</p></dd>
<dt><code>dtp-header-forward</code></dt>
<dd><p>An &quot;invisible pointer&quot; used to indicate that the structure containing
it has been moved elsewhere.  The &quot;header word&quot; of the structure is
replaced by one of these invisible pointers.  See the function <code>structure-forward</code>
(<a href="#structure_002dforward_002dfun">structure-forward-fun</a>).
</p></dd>
<dt><code>dtp-body-forward</code></dt>
<dd><p>An &quot;invisible pointer&quot; used to indicate that the structure containing
it has been moved elsewhere.  This points to the word containing
the header-forward, which points to the new copy of the structure.
</p></dd>
<dt><code>dtp-one-q-forward</code></dt>
<dd><p>An &quot;invisible pointer&quot; used to indicate that the single cell containing
it has been moved elsewhere.
</p></dd>
<dt><code>dtp-gc-forward</code></dt>
<dd><p>This is used by the copying garbage collector to flag the obsolete copy
of an object; it points to the new copy.
</p></dd>
</dl>
</dd></dl>

<a name="q_002ddata_002dtypes_002dvar"></a><dl>
<dt><a name="index-q_002ddata_002dtypes-1"></a>Variable: <strong>q-data-types</strong></dt>
<dd><p>The value of <code>q-data-types</code> is a list of all of the symbolic
names for data types described above under <code>data-type</code>.
These are the symbols whose print names begin
with &quot;<code>dtp-</code>&quot;.  The values of these symbols are the internal numeric data-type codes
for the various types.
</p></dd></dl>

<a name="q_002ddata_002dtypes_002dfun"></a><dl>
<dt><a name="index-q_002ddata_002dtypes"></a>Function: <strong>q-data-types</strong> <em>type-code</em></dt>
<dd><p>Given the internal numeric data-type code, returns the corresponding symbolic name.
This &quot;function&quot; is actually an array.
</p></dd></dl>

<a name="Forwarding"></a>
<h3 class="section">14.2 Forwarding</h3>
<a name="index-invisible-pointers"></a>

<p>An <em>invisible pointer</em> is a kind of pointer that does not represent a
Lisp object, but just resides in memory.  There are several kinds of
invisible pointer, and there are various rules about where
they may or may not appear.  The basic property of an invisible pointer
is that if the Lisp Machine reads a word of memory and finds an
invisible pointer there, instead of seeing the invisible pointer as the
result of the read, it does a second read, at the location addressed by
the invisible pointer, and returns that as the result instead.  Writing behaves
in a similar fashion.  When the Lisp Machine writes a word of memory it first
checks to see if that word contains an invisible pointer; if so it goes to
the location pointed to by the invisible pointer and tries to write there instead.
Many subprimitives that read and write memory do not do this checking.
</p>
<p>The simplest kind of invisible pointer has the data type code
<code>dtp-one-q-forward</code>.  It is used to forward a single word of memory to
someplace else.  The invisible pointers with data types
<code>dtp-header-forward</code> and <code>dtp-body-forward</code> are used for moving
whole Lisp objects (such as cons cells or arrays) somewhere else.  The
<code>dtp-external-value-cell-pointer</code> is very similar to the
<code>dtp-one-q-forward</code>; the difference is that it is not &quot;invisible&quot; to
the operation of binding.  If the (internal) value cell of a symbol
contains a <code>dtp-external-value-cell-pointer</code> that points to some other
word (the external value cell), then <code>symeval</code> or <code>set</code> operations on
the symbol will consider the pointer to be invisible and use the
external value cell, but binding the symbol will save away the
<code>dtp-external-value-cell-pointer</code> itself, and store the new value into
the internal value cell of the symbol.  This is how closures are implemented.
</p>
<p><code>dtp-gc-forward</code> is not an invisible pointer at all; it only appears in
&quot;old space&quot; and will never be seen by any program other than the garbage
collector.  When an object is found not to be garbage, and the garbage collector 
moves it from &quot;old space&quot; to &quot;new space&quot;, a <code>dtp-gc-forward</code> is left behind
to point to the new copy of the object.  This ensures that other references
to the same object get the same new copy.
</p>
<a name="structure_002dforward_002dfun"></a><dl>
<dt><a name="index-structure_002dforward"></a>Function: <strong>structure-forward</strong> <em>old-object new-object</em></dt>
<dd><p>This causes references to <em>old-object</em> actually to reference
<em>new-object</em>, by storing invisible pointers in <em>old-object</em>.
It returns <em>old-object</em>.
</p>
<p>An example of the use of <code>structure-forward</code> is <code>adjust-array-size</code>.
If the array is being made bigger and cannot be expanded in place, a new
array is allocated, the contents are copied, and the old array is
structure-forwarded to the new one.  This forwarding ensures that pointers
to the old array, or to cells within it, continue to work.  When the garbage
collector goes to copy the old array, it notices the forwarding and uses
the new array as the copy; thus the overhead of forwarding disappears
eventually if garbage collection is in use.
</p></dd></dl>

<a name="follow_002dstructure_002dforwarding_002dfun"></a><dl>
<dt><a name="index-follow_002dstructure_002dforwarding"></a>Function: <strong>follow-structure-forwarding</strong> <em>object</em></dt>
<dd><p>Normally returns <em>object</em>, but if <em>object</em> has been <code>structure-forward</code>&rsquo;ed,
returns the object at the end of the chain of forwardings.  If <em>object</em>
is not exactly an object, but a locative to a cell in the middle of an object,
a locative to the corresponding cell in the latest copy of the object will be
returned.
</p></dd></dl>

<a name="forward_002dvalue_002dcell_002dfun"></a><dl>
<dt><a name="index-forward_002dvalue_002dcell"></a>Function: <strong>forward-value-cell</strong> <em>from-symbol to-symbol</em></dt>
<dd><p>This alters <em>from-symbol</em> so that it always has the same value
as <em>to-symbol</em>, by sharing its value cell.  A <code>dtp-one-q-forward</code>
invisible pointer is stored into <em>from-symbol</em>&rsquo;s value cell.
Do not do this while <em>from-symbol</em> is <code>lambda</code>-bound, as
the microcode does not bother to check for that case and something
bad will happen when <em>from-symbol</em> gets unbound.  The microcode check
is omitted to speed up binding and unbinding.
</p>
<p>To forward one arbitrary cell to another (rather than specifically
one value cell to another), given two locatives, do
</p><div class="lisp">
<pre class="lisp">(%p-store-tag-and-pointer <em>locative1</em> dtp-one-q-forward <em>locative2</em>)
</pre></div>
</dd></dl>

<a name="follow_002dcell_002dforwarding_002dfun"></a><dl>
<dt><a name="index-follow_002dcell_002dforwarding"></a>Function: <strong>follow-cell-forwarding</strong> <em>loc evcp-p</em></dt>
<dd><p><em>loc</em> is a locative to a cell.  Normally <em>loc</em> is returned, but if the
cell has been forwarded, this follows the chain of forwardings and returns
a locative to the final cell.  If the cell is part of a structure which has
been forwarded, the chain of structure forwardings is followed, too.
If <em>evcp-p</em> is <code>t</code>, external value cell pointers are followed; if
it is <code>nil</code> they are not.
</p></dd></dl>

<a name="Pointer-Manipulation"></a>
<h3 class="section">14.3 Pointer Manipulation</h3>

<p>It should again be emphasized that improper use of these functions
can damage or destroy the Lisp environment.  It is possible to create
pointers with illegal data-type, pointers to non-existent objects, and
pointers to untyped storage, which will completely confuse the garbage
collector.
</p>

<a name="g_t_0025data_002dtype_002dfun"></a><dl>
<dt><a name="index-_0025data_002dtype"></a>Function: <strong>%data-type</strong> <em>x</em></dt>
<dd><p>Returns the data-type field of <em>x</em>, as a fixnum.
</p></dd></dl>

<a name="g_t_0025pointer_002dfun"></a><dl>
<dt><a name="index-_0025pointer"></a>Function: <strong>%pointer</strong> <em>x</em></dt>
<dd><p>Returns the pointer field of <em>x</em>, as a fixnum.  For most
types, this is dangerous since the garbage collector can copy the object
and change its address.
</p></dd></dl>

<a name="g_t_0025make_002dpointer_002dfun"></a><dl>
<dt><a name="index-_0025make_002dpointer"></a>Function: <strong>%make-pointer</strong> <em>data-type pointer</em></dt>
<dd><p>This makes up a pointer, with <em>data-type</em> in the data-type
field and <em>pointer</em> in the pointer field, and returns it.  <em>data-type</em>
should be an internal numeric data-type code; these are the values of
the symbols that start with <code>dtp-</code>.  <em>pointer</em> may be any object;
its pointer field is used.  This is
most commonly used for changing the type of a pointer.  Do not use this
to make pointers which are not allowed to be in the machine, such as
<code>dtp-null</code>, invisible pointers, etc.
</p></dd></dl>

<a name="g_t_0025make_002dpointer_002doffset_002dfun"></a><dl>
<dt><a name="index-_0025make_002dpointer_002doffset"></a>Function: <strong>%make-pointer-offset</strong> <em>data-type pointer offset</em></dt>
<dd><p>This returns a pointer with <em>data-type</em> in the data-type
field, and <em>pointer</em> plus <em>offset</em> in the pointer field.  The
<em>data-type</em> and <em>pointer</em> arguments are like those of <code>%make-pointer</code>;
<em>offset</em> may be any object but is usually a fixnum.  The
types of the arguments are not checked; their pointer fields are simply
added together.  This is useful for constructing locative pointers
into the middle of an object.  However, note that it is illegal to
have a pointer to untyped data, such as the inside of a FEF or
a numeric array.
</p></dd></dl>

<a name="g_t_0025pointer_002ddifference_002dfun"></a><dl>
<dt><a name="index-_0025pointer_002ddifference"></a>Function: <strong>%pointer-difference</strong> <em>pointer-1 pointer-2</em></dt>
<dd><p>Returns a fixnum which is <em>pointer-1</em> minus <em>pointer-2</em>.
No type checks are made.  For the result to be meaningful, the two pointers
must point into the same object, so that their difference cannot change
as a result of garbage collection.
</p></dd></dl>

<a name="Analyzing-Structures"></a>
<h3 class="section">14.4 Analyzing Structures</h3>

<a name="g_t_0025find_002dstructure_002dheader_002dfun"></a><dl>
<dt><a name="index-_0025find_002dstructure_002dheader"></a>Function: <strong>%find-structure-header</strong> <em>pointer</em></dt>
<dd><p>This subprimitive finds the structure into which 
<em>pointer</em> points, by searching backward for a header.
It is a basic low-level function used by such things as the
garbage collector.
<em>pointer</em> is normally a locative, but its data-type is ignored.
Note that it is illegal to point into an &quot;unboxed&quot; portion of
a structure, for instance the middle of a numeric array.
</p>
<p>In structure space, the &quot;containing structure&quot; of a pointer
is well-defined by system storage conventions.  In list space,
it is considered to be the contiguous, cdr-coded segment of
list surrounding the location pointed to.  If a cons of the list
has been copied out by <code>rplacd</code>, the contiguous list includes
that pair and ends at that point.
</p></dd></dl>

<a name="g_t_0025find_002dstructure_002dleader_002dfun"></a><dl>
<dt><a name="index-_0025find_002dstructure_002dleader"></a>Function: <strong>%find-structure-leader</strong> <em>pointer</em></dt>
<dd><p>This is identical to <code>%find-structure-header</code>, except that if the
structure is an array with a leader, this returns a locative pointer
to the leader-header, rather than returning the array-pointer itself.
Thus the result of <code>%find-structure-leader</code> is always the lowest
address in the structure.  This is the one used internally by the garbage collector.
</p></dd></dl>

<a name="g_t_0025structure_002dboxed_002dsize_002dfun"></a><dl>
<dt><a name="index-_0025structure_002dboxed_002dsize"></a>Function: <strong>%structure-boxed-size</strong> <em>object</em></dt>
<dd><p>Returns the number of &quot;boxed Q&rsquo;s&quot; in <em>object</em>.  This is the number
of words at the front of the structure which contain normal Lisp objects.
Some structures, for example FEFs and numeric arrays, contain additional
&quot;unboxed Q&rsquo;s&quot; following their &quot;boxed Q&rsquo;s&quot;.
Note that the boxed size of a PDL (either regular or special) does not
include Q&rsquo;s above the current top of the PDL.  Those locations are boxed,
but their contents are considered garbage and are not protected by the
garbage collector.
</p></dd></dl>

<a name="g_t_0025structure_002dtotal_002dsize_002dfun"></a><dl>
<dt><a name="index-_0025structure_002dtotal_002dsize"></a>Function: <strong>%structure-total-size</strong> <em>object</em></dt>
<dd><p>Returns the total number of words occupied by the representation
of <em>object</em>, including boxed Q&rsquo;s, unboxed Q&rsquo;s, and garbage Q&rsquo;s off
the ends of PDLs.
</p></dd></dl>

<a name="Creating-Objects"></a>
<h3 class="section">14.5 Creating Objects</h3>

<a name="g_t_0025allocate_002dand_002dinitialize_002dfun"></a><dl>
<dt><a name="index-_0025allocate_002dand_002dinitialize"></a>Function: <strong>%allocate-and-initialize</strong> <em>data-type header-type header second-word area size</em></dt>
<dd><p>This is the subprimitive for creating most structured-type objects.
<em>area</em> is the area in which it is to be created, as a fixnum or a symbol.
<em>size</em> is the number of words to be allocated.  The value returned
points to the first word allocated and has data-type <em>data-type</em>.
Uninterruptibly, the words allocated are initialized so that storage
conventions are preserved at all times.  The first word, the header,
is initialized to have <em>header-type</em> in its data-type field 
and <em>header</em> in its pointer field.  The second word is initialized
to <em>second-word</em>.  The remaining words are initialized to <code>nil</code>.
The flag bits of all words are set to 0.  The cdr codes of all words
except the last are set to <code>cdr-next</code>; the cdr code of the last word
is set to <code>cdr-nil</code>.  It is probably a bad idea to rely on this.
</p></dd></dl>

<p>The basic functions for creating list-type objects are <code>cons</code> and
<code>make-list</code>; no special subprimitive is needed.  Closures, entities,
and select-methods are based on lists, but there is no primitive
for creating them.  To create one, create a list and then use <code>%make-pointer</code>
to change the data type from <code>dtp-list</code> to the desired type.
</p>
<a name="g_t_0025allocate_002dand_002dinitialize_002darray_002dfun"></a><dl>
<dt><a name="index-_0025allocate_002dand_002dinitialize_002darray"></a>Function: <strong>%allocate-and-initialize-array</strong> <em>header data-length leader-length area size</em></dt>
<dd><p>This is the subprimitive for creating arrays, called only by <code>make-array</code>.
It is different from <code>%allocate-and-initialize</code> because arrays have
a more complicated header structure.
</p></dd></dl>

<a name="Copying-Data"></a>
<h3 class="section">14.6 Copying Data</h3>

<a name="g_t_0025blt_002dfun"></a><dl>
<dt><a name="index-_0025blt"></a>Function: <strong>%blt</strong> <em>from to count increment</em></dt>
<dd><p>Copies <em>count</em> words, separated by <em>increment</em>.  The word at
address <em>from</em> is moved to address <em>to</em>, the word at address
<em>from</em><code>+</code><em>increment</em> is moved to address <em>to</em><code>+</code><em>increment</em>,
and so on until <em>count</em> words have been moved.
</p>
<p><code>%blt</code> is useful for copying parts of structures, making or
deleting space inside structures, and initializing structures.
</p>
<p>Only the pointer fields of <em>from</em> and <em>to</em> are significant;
they may be locatives or even fixnums.  If one of them must point
to the unboxed data in the middle of a structure, you must make it a fixnum,
and you must do so with interrupts disabled, or else garbage collection
could move the structure after you have already created the fixnum.
</p></dd></dl>

<a name="Returning-Storage"></a>
<h3 class="section">14.7 Returning Storage</h3>

<a name="return_002dstorage_002dfun"></a><dl>
<dt><a name="index-return_002dstorage"></a>Function: <strong>return-storage</strong> <em>object</em></dt>
<dd><p>This peculiar function attempts to return <em>object</em> to free storage.
If it is a displaced array, this returns the displaced array itself,
not the data that the array points to.  Currently <code>return-storage</code>
does nothing if the object is not at the end of its region, i.e if
it was not either the most recently allocated non-list object in its
area, or the most recently allocated list in its area.
</p>
<p>If you still have any references to <em>object</em> anywhere in the Lisp world
after this function returns, the garbage collector can get a fatal error
if it sees them.  Since the form that calls this function must get the
object from somewhere, it may not be clear how to legally call <code>return-storage</code>.
One of the only ways to do it is as follows:
</p><div class="lisp">
<pre class="lisp">(defun func ()
   (let ((object (make-array 100)))
      ...
      (return-storage (prog1 object (setq object nil)))))
</pre></div>
<p>so that the variable <code>object</code> does not refer to the object when
<code>return-storage</code> is called.  Alternatively, you can free the
object and get rid of all pointers to it while interrupts are turned
off with <code>without-interrupts</code>.
</p>
<p>You should only call this function if you know what you are doing;
otherwise the garbage collector can get fatal errors.  Be careful.
</p></dd></dl>

<a name="Locking-Subprimitive"></a>
<h3 class="section">14.8 Locking Subprimitive</h3>

<a name="g_t_0025store_002dconditional_002dfun"></a><dl>
<dt><a name="index-_0025store_002dconditional"></a>Function: <strong>%store-conditional</strong> <em>pointer old new</em></dt>
<dd><p>This is the basic locking primitive.  <em>pointer</em> is a locative to
a cell which is uninterruptibly read and written.  If the contents of
the cell is <code>eq</code> to <em>old</em>, then it is replaced by <em>new</em> and
<code>t</code> is returned.  Otherwise, <code>nil</code> is returned and the contents
of the cell are not changed.
</p></dd></dl>

<a name="I_002fO-Device-Subprimitives"></a>
<h3 class="section">14.9 I/O Device Subprimitives</h3>

<a name="g_t_0025unibus_002dread_002dfun"></a><dl>
<dt><a name="index-_0025unibus_002dread"></a>Function: <strong>%unibus-read</strong> <em>address</em></dt>
<dd><p>Returns as a fixnum the contents of the register at the specified Unibus
address.  You must specify a full 18-bit address.  This
is guaranteed to read the location only once.  Since the Lisp
Machine Unibus does not support byte operations, this always references
a 16-bit word, and so <em>address</em> will normally be an even number.
</p></dd></dl>

<a name="g_t_0025unibus_002dwrite_002dfun"></a><dl>
<dt><a name="index-_0025unibus_002dwrite"></a>Function: <strong>%unibus-write</strong> <em>address data</em></dt>
<dd><p>Writes the 16-bit number <em>data</em> at the specified Unibus
address, exactly once.
</p></dd></dl>

<a name="g_t_0025xbus_002dread_002dfun"></a><dl>
<dt><a name="index-_0025xbus_002dread"></a>Function: <strong>%xbus-read</strong> <em>io-offset</em></dt>
<dd><p>Returns the contents
of the register at the specified Xbus address.  <em>io-offset</em> is
an offset into the I/O portion of Xbus physical address space.
This is guaranteed to read the location exactly once.
The returned value can be either a fixnum or a bignum.
</p></dd></dl>

<a name="g_t_0025xbus_002dwrite_002dfun"></a><dl>
<dt><a name="index-_0025xbus_002dwrite"></a>Function: <strong>%xbus-write</strong> <em>io-offset data</em></dt>
<dd><p>Writes <em>data</em>, which can be a fixnum or a bignum, into the register at
the specified Xbus address.  <em>io-offset</em> is an offset into the I/O
portion of Xbus physical address space.  This is guaranteed to write the
location exactly once.
</p></dd></dl>

<a name="sys_003a_0025xbus_002dwrite_002dsync_002dfun"></a><dl>
<dt><a name="index-sys_003a_0025xbus_002dwrite_002dsync"></a>Function: <strong>sys:%xbus-write-sync</strong> <em>w-loc w-data delay sync-loc sync-mask sync-value</em></dt>
<dd><p>Does <code>(%xbus-write <em>w-loc</em> <em>w-data</em>)</code>, but first synchronizes to
within about one microsecond of a certain condition.  The synchronization
is achieved by looping until
</p><div class="lisp">
<pre class="lisp">(= (logand (%xbus-read <em>sync-loc</em>) <em>sync-mask</em>) <em>sync-value</em>)
</pre></div>
<p>is false, then looping until it is true, then looping <em>delay</em> times.
Thus the write happens a specified delay after the leading edge of the
synchronization condition.
The number of microseconds of delay is roughly one third of <em>delay</em>.
</p></dd></dl>

<a name="sys_003a_0025halt_002dfun"></a><dl>
<dt><a name="index-sys_003a_0025halt"></a>Function: <strong>sys:%halt</strong></dt>
<dd><p>Stops the machine.
</p></dd></dl>

<a name="Special-Memory-Referencing"></a>
<h3 class="section">14.10 Special Memory Referencing</h3>

<a name="g_t_0025p_002dcontents_002doffset_002dfun"></a><dl>
<dt><a name="index-_0025p_002dcontents_002doffset"></a>Function: <strong>%p-contents-offset</strong> <em>base-pointer offset</em></dt>
<dd><p>This checks the cell pointed to by <em>base-pointer</em> for
a forwarding pointer.  Having followed forwarding pointers to the
real structure pointed to, it adds <em>offset</em> to the resulting
forwarded <em>base-pointer</em> and returns the contents of that location.
</p></dd></dl>

<p>There is no <code>%p-contents</code>, since <code>car</code> performs that operation.
</p>
<a name="g_t_0025p_002dcontents_002das_002dlocative_002dfun"></a><dl>
<dt><a name="index-_0025p_002dcontents_002das_002dlocative"></a>Function: <strong>%p-contents-as-locative</strong> <em>pointer</em></dt>
<dd><p>Given a pointer to a memory location containing a pointer that isn&rsquo;t
allowed to be &quot;in the machine&quot; (typically an invisible pointer)
this function returns the contents of the location as a <code>dtp-locative</code>.
It changes the disallowed data type to <code>dtp-locative</code> so that you can safely
look at it and see what it points to.
</p></dd></dl>

<a name="g_t_0025p_002dcontents_002das_002dlocative_002doffset_002dfun"></a><dl>
<dt><a name="index-_0025p_002dcontents_002das_002dlocative_002doffset"></a>Function: <strong>%p-contents-as-locative-offset</strong> <em>base-pointer offset</em></dt>
<dd><p>This checks the cell pointed to by <em>base-pointer</em> for
a forwarding pointer.  Having followed forwarding pointers to the
real structure pointed to, it adds <em>offset</em> to the resulting
forwarded <em>base-pointer</em>, fetches the contents of that location,
and returns it with the data type changed to <code>dtp-locative</code> in case
it was a type that isn&rsquo;t allowed to be &quot;in the machine&quot; (typically
an invisible pointer).  This can be used, for example, to analyze the
<code>dtp-external-value-cell-pointer</code> pointers in a FEF, which are
used by the compiled code to reference value cells and function cells
of symbols.
</p></dd></dl>

<a name="g_t_0025p_002dstore_002dcontents_002dfun"></a><dl>
<dt><a name="index-_0025p_002dstore_002dcontents"></a>Function: <strong>%p-store-contents</strong> <em>pointer value</em></dt>
<dd><p><em>value</em> is stored into the data-type and pointer
fields of the location addressed by <em>pointer</em>.  The cdr-code
and flag-bit fields remain unchanged.  <em>value</em> is returned.
</p></dd></dl>

<a name="g_t_0025p_002dstore_002dcontents_002doffset_002dfun"></a><dl>
<dt><a name="index-_0025p_002dstore_002dcontents_002doffset"></a>Function: <strong>%p-store-contents-offset</strong> <em>value base-pointer offset</em></dt>
<dd><p>This checks the cell pointed to by <em>base-pointer</em> for
a forwarding pointer.  Having followed forwarding pointers to the
real structure pointed to, it adds <em>offset</em> to the resulting
forwarded <em>base-pointer</em> and stores <em>value</em> into the data-type and pointer
fields of that location.  The cdr-code
and flag-bit fields remain unchanged.  <em>value</em> is returned.
</p></dd></dl>

<a name="g_t_0025p_002dstore_002dtag_002dand_002dpointer_002dfun"></a><dl>
<dt><a name="index-_0025p_002dstore_002dtag_002dand_002dpointer"></a>Function: <strong>%p-store-tag-and-pointer</strong> <em>pointer miscfields pntrfield</em></dt>
<dd><p>Creates a <em>Q</em> by taking 8 bits from <em>miscfields</em>
and 24 bits from <em>pntrfield</em>, and stores that into the
location addressed by <em>pointer</em>.  The low 5 bits of <em>miscfields</em>
become the data-type, the next bit becomes the flag-bit, and the
top two bits become the cdr-code.  This is a good
way to store a forwarding pointer from one structure
to another (for example).
</p></dd></dl>

<a name="g_t_0025p_002dldb_002dfun"></a><dl>
<dt><a name="index-_0025p_002dldb"></a>Function: <strong>%p-ldb</strong> <em>ppss pointer</em></dt>
<dd><p>This is like <code>ldb</code> but gets a byte from the location
addressed by <em>pointer</em>.  Note that
you can load bytes out of the data type etc bits, not just
the pointer field, and that the word loaded out of need not
be a fixnum.  The result returned is always a fixnum.
</p></dd></dl>

<a name="g_t_0025p_002dldb_002doffset_002dfun"></a><dl>
<dt><a name="index-_0025p_002dldb_002doffset"></a>Function: <strong>%p-ldb-offset</strong> <em>ppss base-pointer offset</em></dt>
<dd><p>This checks the cell pointed to by <em>base-pointer</em> for
a forwarding pointer.  Having followed forwarding pointers to the
real structure pointed to, the byte specified by <em>ppss</em> is
loaded from the contents of the location addressed by the forwarded
<em>base-pointer</em> plus <em>offset</em>, and returned as a fixnum.
This is the way to reference byte fields within a structure
without violating system storage conventions.
</p></dd></dl>

<a name="g_t_0025p_002ddpb_002dfun"></a><dl>
<dt><a name="index-_0025p_002ddpb"></a>Function: <strong>%p-dpb</strong> <em>value ppss pointer</em></dt>
<dd><p>The <em>value</em>, a fixnum, is stored into the byte selected
by <em>ppss</em> in the word addressed by <em>pointer</em>.  <code>nil</code> is returned.
You can use this to alter data types, cdr codes, etc.
</p></dd></dl>

<a name="g_t_0025p_002ddpb_002doffset_002dfun"></a><dl>
<dt><a name="index-_0025p_002ddpb_002doffset"></a>Function: <strong>%p-dpb-offset</strong> <em>value ppss base-pointer offset</em></dt>
<dd><p>This checks the cell pointed to by <em>base-pointer</em> for
a forwarding pointer.  Having followed forwarding pointers to the
real structure pointed to, the <em>value</em> is stored into the byte specified by <em>ppss</em> in
the location addressed by the forwarded
<em>base-pointer</em> plus <em>offset</em>.  <code>nil</code> is returned.
This is the way to alter unboxed data within a structure
without violating system storage conventions.
</p></dd></dl>

<a name="g_t_0025p_002dmask_002dfield_002dfun"></a><dl>
<dt><a name="index-_0025p_002dmask_002dfield"></a>Function: <strong>%p-mask-field</strong> <em>ppss pointer</em></dt>
<dd><p>This is similar to <code>%p-ldb</code>, except that the selected
byte is returned in its original position within the word instead
of right-aligned.
</p></dd></dl>

<a name="g_t_0025p_002dmask_002dfield_002doffset_002dfun"></a><dl>
<dt><a name="index-_0025p_002dmask_002dfield_002doffset"></a>Function: <strong>%p-mask-field-offset</strong> <em>ppss base-pointer offset</em></dt>
<dd><p>This is similar to <code>%p-ldb-offset</code>, except that the selected
byte is returned in its original position within the word instead
of right-aligned.
</p></dd></dl>

<a name="g_t_0025p_002ddeposit_002dfield_002dfun"></a><dl>
<dt><a name="index-_0025p_002ddeposit_002dfield"></a>Function: <strong>%p-deposit-field</strong> <em>value ppss pointer</em></dt>
<dd><p>This is similar to <code>%p-dpb</code>, except that the selected
byte is stored from the corresponding bits of <em>value</em> rather than
the right-aligned bits.
</p></dd></dl>

<a name="g_t_0025p_002ddeposit_002dfield_002doffset_002dfun"></a><dl>
<dt><a name="index-_0025p_002ddeposit_002dfield_002doffset"></a>Function: <strong>%p-deposit-field-offset</strong> <em>value ppss base-pointer offset</em></dt>
<dd><p>This is similar to <code>%p-dpb-offset</code>, except that the selected
byte is stored from the corresponding bits of <em>value</em> rather than
the right-aligned bits.
</p></dd></dl>

<a name="g_t_0025p_002dpointer_002dfun"></a><dl>
<dt><a name="index-_0025p_002dpointer"></a>Function: <strong>%p-pointer</strong> <em>pointer</em></dt>
<dd><p>Extracts the pointer field of the contents of the
location addressed by <em>pointer</em> and returns
it as a fixnum.
</p></dd></dl>

<a name="g_t_0025p_002ddata_002dtype_002dfun"></a><dl>
<dt><a name="index-_0025p_002ddata_002dtype"></a>Function: <strong>%p-data-type</strong> <em>pointer</em></dt>
<dd><p>Extracts the data-type field of the contents of the
location addressed by <em>pointer</em> and returns
it as a fixnum.
</p></dd></dl>

<a name="g_t_0025p_002dcdr_002dcode_002dfun"></a><dl>
<dt><a name="index-_0025p_002dcdr_002dcode"></a>Function: <strong>%p-cdr-code</strong> <em>pointer</em></dt>
<dd><p>Extracts the cdr-code field of the contents of the
location addressed by <em>pointer</em> and returns
it as a fixnum.
</p></dd></dl>

<a name="g_t_0025p_002dstore_002dpointer_002dfun"></a><dl>
<dt><a name="index-_0025p_002dstore_002dpointer"></a>Function: <strong>%p-store-pointer</strong> <em>pointer value</em></dt>
<dd><p>Clobbers the pointer field of the location
addressed by <em>pointer</em> to <em>value</em>, and returns <em>value</em>.
</p></dd></dl>

<a name="g_t_0025p_002dstore_002ddata_002dtype_002dfun"></a><dl>
<dt><a name="index-_0025p_002dstore_002ddata_002dtype"></a>Function: <strong>%p-store-data-type</strong> <em>pointer value</em></dt>
<dd><p>Clobbers the data-type field of the location
addressed by <em>pointer</em> to <em>value</em>, and returns <em>value</em>.
</p></dd></dl>

<a name="g_t_0025p_002dstore_002dcdr_002dcode_002dfun"></a><dl>
<dt><a name="index-_0025p_002dstore_002dcdr_002dcode"></a>Function: <strong>%p-store-cdr-code</strong> <em>pointer value</em></dt>
<dd><p>Clobbers the cdr-code field of the location
addressed by <em>pointer</em> to <em>value</em>, and returns <em>value</em>.
</p></dd></dl>

<a name="g_t_0025stack_002dframe_002dpointer_002dfun"></a><dl>
<dt><a name="index-_0025stack_002dframe_002dpointer"></a>Function: <strong>%stack-frame-pointer</strong></dt>
<dd><p>Returns a locative pointer to its caller&rsquo;s stack frame.  This
function is not defined in the interpreted Lisp environment; it only works
in compiled code.  Since it turns into a &quot;misc&quot; instruction,
the &quot;caller&rsquo;s stack frame&quot; really means &quot;the frame for the FEF
that executed the <code>%stack-frame-pointer</code> instruction&quot;.
</p></dd></dl>

<a name="Storage-Layout-Definitions"></a>
<h3 class="section">14.11 Storage Layout Definitions</h3>

<p>The following special variables have values which define the most important attributes
of the way Lisp data structures are laid out in storage.  In addition to the variables
documented here, there are many others that are more specialized.  They are not
documented in this manual since they are in the <code>system</code> package rather than
the <code>global</code> package.  The variables whose names start with <code>%%</code> are
byte specifiers, intended to be used with subprimitives such as <code>%p-ldb</code>.
If you change the value of any of these variables, you will probably bring the
machine to a crashing halt.
</p>
<a name="g_t_0025_0025q_002dcdr_002dcode_002dvar"></a><dl>
<dt><a name="index-_0025_0025q_002dcdr_002dcode"></a>Variable: <strong>%%q-cdr-code</strong></dt>
<dd><p>The field of a memory word that contains the cdr-code.  See <a href="#cdr_002dcode">cdr-code</a>.
</p></dd></dl>

<a name="g_t_0025_0025q_002dflag_002dbit_002dvar"></a><dl>
<dt><a name="index-_0025_0025q_002dflag_002dbit"></a>Variable: <strong>%%q-flag-bit</strong></dt>
<dd><p>The field of a memory word that contains the flag-bit.  In most data
structures this bit is not used by the system and is available for the
user.  However, it may soon be reallocated to other purposes.
</p></dd></dl>

<a name="g_t_0025_0025q_002ddata_002dtype_002dvar"></a><dl>
<dt><a name="index-_0025_0025q_002ddata_002dtype"></a>Variable: <strong>%%q-data-type</strong></dt>
<dd><p>The field of a memory word that contains the data-type code.  See <a href="#data_002dtype_002dfun">data-type-fun</a>.
</p></dd></dl>

<a name="g_t_0025_0025q_002dpointer_002dvar"></a><dl>
<dt><a name="index-_0025_0025q_002dpointer"></a>Variable: <strong>%%q-pointer</strong></dt>
<dd><p>The field of a memory word that contains the pointer address, or immediate data.
</p></dd></dl>

<a name="g_t_0025_0025q_002dpointer_002dwithin_002dpage_002dvar"></a><dl>
<dt><a name="index-_0025_0025q_002dpointer_002dwithin_002dpage"></a>Variable: <strong>%%q-pointer-within-page</strong></dt>
<dd><p>The field of a memory word that contains the part of the address that lies
within a single page.
</p></dd></dl>

<a name="g_t_0025_0025q_002dtyped_002dpointer_002dvar"></a><dl>
<dt><a name="index-_0025_0025q_002dtyped_002dpointer"></a>Variable: <strong>%%q-typed-pointer</strong></dt>
<dd><p>The concatenation of the <code>%%q-data-type</code> and <code>%%q-pointer</code> fields.
</p></dd></dl>

<a name="g_t_0025_0025q_002dall_002dbut_002dtyped_002dpointer_002dvar"></a><dl>
<dt><a name="index-_0025_0025q_002dall_002dbut_002dtyped_002dpointer"></a>Variable: <strong>%%q-all-but-typed-pointer</strong></dt>
<dd><p>The field of a memory word that contains the tag fields, <code>%%q-cdr-code</code>
and <code>%%q-flag-bit</code>.
</p></dd></dl>

<a name="g_t_0025_0025q_002dall_002dbut_002dpointer_002dvar"></a><dl>
<dt><a name="index-_0025_0025q_002dall_002dbut_002dpointer"></a>Variable: <strong>%%q-all-but-pointer</strong></dt>
<dd><p>The concatenation of all fields of a memory word except for <code>%%q-pointer</code>.
</p></dd></dl>

<a name="g_t_0025_0025q_002dall_002dbut_002dcdr_002dcode_002dvar"></a><dl>
<dt><a name="index-_0025_0025q_002dall_002dbut_002dcdr_002dcode"></a>Variable: <strong>%%q-all-but-cdr-code</strong></dt>
<dd><p>The concatenation of all fields of a memory word except for <code>%%q-cdr-code</code>.
</p></dd></dl>

<a name="g_t_0025_0025q_002dhigh_002dhalf_002dvar"></a><dl>
<dt><a name="index-_0025_0025q_002dhigh_002dhalf"></a>Variable: <strong>%%q-high-half</strong></dt>
<dd><a name="g_t_0025_0025q_002dlow_002dhalf_002dvar"></a></dd><dt><a name="index-_0025_0025q_002dlow_002dhalf"></a>Variable: <strong>%%q-low-half</strong></dt>
<dd><p>The two halves of a memory word.  These fields are only used in storing compiled code.
</p></dd></dl>

<a name="cdr_002dnormal_002dvar"></a><dl>
<dt><a name="index-cdr_002dnormal"></a>Variable: <strong>cdr-normal</strong></dt>
<dd><a name="cdr_002dnext_002dvar"></a></dd><dt><a name="index-cdr_002dnext"></a>Variable: <strong>cdr-next</strong></dt>
<dd><a name="cdr_002dnil_002dvar"></a></dd><dt><a name="index-cdr_002dnil"></a>Variable: <strong>cdr-nil</strong></dt>
<dd><a name="cdr_002derror_002dvar"></a></dd><dt><a name="index-cdr_002derror"></a>Variable: <strong>cdr-error</strong></dt>
<dd><p>The values of these four variables are the numeric values that go in the cdr-code
field of a memory word.  See <a href="#cdr_002dcode">cdr-code</a> for the details of cdr-coding.
</p></dd></dl>

<a name="Function_002dCalling-Subprimitives"></a>
<h3 class="section">14.12 Function-Calling Subprimitives</h3>

<p>These subprimitives can be used (carefully!) to call a function with the
number of arguments variable at run time.  They only work in compiled code
and are not defined in the interpreted Lisp environment.
The preferred higher-level primitive is <code>lexpr-funcall</code> (<a href="#lexpr_002dfuncall_002dfun">lexpr-funcall-fun</a>).  
</p>
<a name="g_t_0025open_002dcall_002dblock_002dfun"></a><dl>
<dt><a name="index-_0025open_002dcall_002dblock"></a>Function: <strong>%open-call-block</strong> <em>function n-adi-pairs destination</em></dt>
<dd><p>Starts a call to <em>function</em>.  <em>n-adi-pairs</em> is the number of
pairs of additional information words already <code>%push</code>&rsquo;ed; normally
this should be <code>0</code>.  <em>destination</em> is where to put the result;
the useful values are <code>0</code> for the value to be ignored, <code>1</code>
for the value to go onto the stack, <code>3</code> for the value to be
the last argument to the previous open call block, and <code>2</code>
for the value to be returned from this frame.
</p></dd></dl>

<a name="g_t_0025push_002dfun"></a><dl>
<dt><a name="index-_0025push"></a>Function: <strong>%push</strong> <em>value</em></dt>
<dd><p>Pushes <em>value</em> onto the stack.  Use this to push the arguments.
</p></dd></dl>

<a name="g_t_0025activate_002dopen_002dcall_002dblock_002dfun"></a><dl>
<dt><a name="index-_0025activate_002dopen_002dcall_002dblock"></a>Function: <strong>%activate-open-call-block</strong></dt>
<dd><p>Causes the call to happen.
</p></dd></dl>

<a name="g_t_0025pop_002dfun"></a><dl>
<dt><a name="index-_0025pop"></a>Function: <strong>%pop</strong></dt>
<dd><p>Pops the top value off of the stack and returns it as its value.
Use this to recover the result from a call made by <code>%open-call-block</code>
with a destination of <code>1</code>.
</p></dd></dl>

<a name="g_t_0025assure_002dpdl_002droom_002dfun"></a><dl>
<dt><a name="index-_0025assure_002dpdl_002droom"></a>Function: <strong>%assure-pdl-room</strong> <em>n-words</em></dt>
<dd><p>Call this before doing a sequence of <code>%push</code>&rsquo;s or <code>%open-call-block</code>s
that will add <em>n-words</em> to the current frame.  This subprimitive checks
that the frame will not exceed the maximum legal frame size, which is 255 words
including all overhead.  This limit is dictated by the way stack frames are linked together.
If the frame is going to exceed the legal limit, <code>%assure-pdl-room</code> will signal
an error.
</p></dd></dl>


<a name="Special_002dBinding-Subprimitive"></a>
<h3 class="section">14.13 Special-Binding Subprimitive</h3>

<a name="bind_002dfun"></a><dl>
<dt><a name="index-bind"></a>Function: <strong>bind</strong> <em>locative value</em></dt>
<dd><p>Binds the cell pointed to by <em>locative</em> to <em>x</em>, in the caller&rsquo;s
environment. This function is not defined in the interpreted Lisp
environment; it only works from compiled code.  Since it turns into an
instruction, the &quot;caller&rsquo;s environment&quot; really means &quot;the binding block
for the stack frame that executed the <code>bind</code> instruction&quot;.  The preferred
higher-level primitives that turn into this are <code>let</code> (<a href="#let_002dfun">let-fun</a>),
<code>let-if</code> (<a href="#let_002dif_002dfun">let-if-fun</a>), and <code>progv</code> (<a href="#progv_002dfun">progv-fun</a>).
[This will be renamed to <code>%bind</code> in the future.]
</p>
<p>The binding is in effect for the scope of the innermost binding
construct, such as <code>prog</code> or <code>let</code>&ndash;even one that binds no
variables itself.
</p></dd></dl>

<a name="The-Paging-System"></a>
<h3 class="section">14.14 The Paging System</h3>


<p>[Someday this may discuss how it works.]
</p>
<a name="sys_003a_0025disk_002dswitches_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025disk_002dswitches"></a>Variable: <strong>sys:%disk-switches</strong></dt>
<dd><p>This variable contains bits that control various disk usage features.
</p>
<p>Bit 0 (the least significant bit) enables read-compares after disk read
operations.  This causes a considerable slowdown, so it is rarely used.
</p>
<p>Bit 1 enables read-compares after disk write operations.
</p>
<p>Bit 2 enables the
multiple page swap-out feature.  When this is enabled, as it is by
default, each time a page is swapped out, up to 20 contiguous pages will
also be written out to the disk if they have been modified.  This
greatly improves swapping performance.
</p>
<p>Bit 3 controls the multiple page swap-in feature, which is also on by
default.  This feature causes pages to be swapped in in groups; each
time a page is needed, several contiguous pages are swapped in in the
same disk operation.  The number of pages swapped in can be specified
for each area using <code>si:set-swap-recommendations-of-area</code>.
</p></dd></dl>

<a name="si_003aset_002dswap_002drecommendations_002dof_002darea_002dfun"></a><dl>
<dt><a name="index-si_003aset_002dswap_002drecommendations_002dof_002darea"></a>Function: <strong>si:set-swap-recommendations-of-area</strong> <em>area-number recommendation</em></dt>
<dd><p>Specifies that pages of area <em>area-number</em> should be swapped in in
groups of <em>recommendation</em> at a time.  This recommendation is used
only if the multiple page swap-in feature is enabled.
</p>
<p>Generally, the more memory a machine has, the higher the swap
recommendations should be to get optimum performance.  The
recommendations are set automatically according to the memory size when
the machine is booted.
</p></dd></dl>

<a name="si_003aset_002dall_002dswap_002drecommendations_002dfun"></a><dl>
<dt><a name="index-si_003aset_002dall_002dswap_002drecommendations"></a>Function: <strong>si:set-all-swap-recommendations</strong> <em>recommendation</em></dt>
<dd><p>Specifies the swap-in recommendation of all areas at once.
</p></dd></dl>


<a name="si_003awire_002dpage_002dfun"></a><dl>
<dt><a name="index-si_003awire_002dpage"></a>Function: <strong>si:wire-page</strong> <em>address &amp;optional (wire-p <code>t</code>)</em></dt>
<dd><p>If <em>wire-p</em> is <code>t</code>, the page containing <em>address</em> is <em>wired-down</em>; that is,
it cannot be paged-out.  If <em>wire-p</em> is <code>nil</code>, the page ceases to be wired-down.
</p></dd></dl>

<a name="si_003aunwire_002dpage_002dfun"></a><dl>
<dt><a name="index-si_003aunwire_002dpage"></a>Function: <strong>si:unwire-page</strong> <em>address</em></dt>
<dd><p><code>(si:unwire-page <em>address</em>)</code> is the same as
<code>(si:wire-page <em>address</em> <code>nil</code>)</code>.
</p></dd></dl>

<a name="sys_003apage_002din_002dstructure_002dfun"></a><dl>
<dt><a name="index-sys_003apage_002din_002dstructure"></a>Function: <strong>sys:page-in-structure</strong> <em>object</em></dt>
<dd><p>Makes sure that the storage that represents <em>object</em> is in main
memory.  Any pages that have been swapped out to disk are read in,
using as few disk operations as possible.  Consecutive disk pages are
transferred together, taking advantage of the full speed of the disk.
If <em>object</em> is large, this will be much faster than bringing the pages
in one at a time on demand.  The storage occupied by <em>object</em> is defined
by the <code>%find-structure-leader</code> and <code>%structure-total-size</code> subprimitives.
</p></dd></dl>

<a name="sys_003apage_002din_002darray_002dfun"></a><dl>
<dt><a name="index-sys_003apage_002din_002darray"></a>Function: <strong>sys:page-in-array</strong> <em>array &amp;optional from to</em></dt>
<dd><p>This is a version of <code>sys:page-in-structure</code> that can bring in a portion
of an array.  <em>from</em> and <em>to</em> are lists of subscripts; if they are shorter
than the dimensionality of <em>array</em>, the remaining subscripts are assumed to
be zero.
</p></dd></dl>

<a name="sys_003apage_002din_002dpixel_002darray_002dfun"></a><dl>
<dt><a name="index-sys_003apage_002din_002dpixel_002darray"></a>Function: <strong>sys:page-in-pixel-array</strong> <em>array &amp;optional from to</em></dt>
<dd><p>Like <code>sys:page-in-array</code> except that the lists <em>from</em> and <em>to</em>, if
present, are assumed to have their subscripts in the order horizontal,
vertical, regardless of which of those two is actually the first axis of
the array.  See <code>make-pixel-array</code>, <a href="#make_002dpixel_002darray_002dfun">make-pixel-array-fun</a>.
</p></dd></dl>

<a name="sys_003apage_002din_002dwords_002dfun"></a><dl>
<dt><a name="index-sys_003apage_002din_002dwords"></a>Function: <strong>sys:page-in-words</strong> <em>address n-words</em></dt>
<dd><p>Any pages that have been swapped out to disk in the range of address
space starting at <em>address</em> and continuing for <em>n-words</em> are read in
with as few disk operations as possible.
</p></dd></dl>

<a name="sys_003apage_002din_002darea_002dfun"></a><dl>
<dt><a name="index-sys_003apage_002din_002darea"></a>Function: <strong>sys:page-in-area</strong> <em>area-number</em></dt>
<dd><a name="sys_003apage_002din_002dregion_002dfun"></a></dd><dt><a name="index-sys_003apage_002din_002dregion"></a>Function: <strong>sys:page-in-region</strong> <em>region-number</em></dt>
<dd><p>All swapped-out pages of the specified region or area are brought into main memory.
</p></dd></dl>

<a name="sys_003apage_002dout_002dstructure_002dfun"></a><dl>
<dt><a name="index-sys_003apage_002dout_002dstructure"></a>Function: <strong>sys:page-out-structure</strong> <em>object</em></dt>
<dd><a name="sys_003apage_002dout_002darray_002dfun"></a></dd><dt><a name="index-sys_003apage_002dout_002darray"></a>Function: <strong>sys:page-out-array</strong> <em>array &amp;optional from to</em></dt>
<dd><a name="sys_003apage_002dout_002dpixel_002darray_002dfun"></a></dd><dt><a name="index-sys_003apage_002dout_002dpixel_002darray"></a>Function: <strong>sys:page-out-pixel-array</strong> <em>array &amp;optional from to</em></dt>
<dd><a name="sys_003apage_002dout_002dwords_002dfun"></a></dd><dt><a name="index-sys_003apage_002dout_002dwords"></a>Function: <strong>sys:page-out-words</strong> <em>address n-words</em></dt>
<dd><a name="sys_003apage_002dout_002darea_002dfun"></a></dd><dt><a name="index-sys_003apage_002dout_002darea"></a>Function: <strong>sys:page-out-area</strong> <em>area-number</em></dt>
<dd><a name="sys_003apage_002dout_002dregion_002dfun"></a></dd><dt><a name="index-sys_003apage_002dout_002dregion"></a>Function: <strong>sys:page-out-region</strong> <em>region-number</em></dt>
<dd><p>These are similar to the above, except that they take pages out of main
memory rather than bringing them in.  Actually, they only mark the pages
as having priority for replacement by others.  Use these operations when
you are done with a large object, to make the virtual memory system
prefer reclaiming that object&rsquo;s memory over swapping something else out.
</p></dd></dl>

<a name="sys_003a_0025change_002dpage_002dstatus_002dfun"></a><dl>
<dt><a name="index-sys_003a_0025change_002dpage_002dstatus"></a>Function: <strong>sys:%change-page-status</strong> <em>virtual-address swap-status access-status-and-meta-bits</em></dt>
<dd><p>The page hash table entry for the page containing <em>virtual-address</em>
is found and altered as specified.  <code>t</code> is returned if it was found,
<code>nil</code> if it was not (presumably the page is swapped out).  <em>swap-status</em>
and <em>access-status-and-meta-bits</em> can be <code>nil</code> if those fields are not
to be changed.  This doesn&rsquo;t make any error checks; you can really
screw things up if you call it with the wrong arguments.
</p></dd></dl>

<a name="sys_003a_0025compute_002dpage_002dhash_002dfun"></a><dl>
<dt><a name="index-sys_003a_0025compute_002dpage_002dhash"></a>Function: <strong>sys:%compute-page-hash</strong> <em>virtual-address</em></dt>
<dd><p>This makes the hashing function for the page hash table
available to the user.
</p></dd></dl>

<a name="sys_003a_0025create_002dphysical_002dpage_002dfun"></a><dl>
<dt><a name="index-sys_003a_0025create_002dphysical_002dpage"></a>Function: <strong>sys:%create-physical-page</strong> <em>physical-address</em></dt>
<dd><p>This is used when adjusting the size of real memory available
to the machine.  It adds an entry for the page frame at <em>physical-address</em>
to the page hash table, with virtual address -1, swap status flushable,
and map status 120 (read only).  This doesn&rsquo;t make error checks; you
can really screw things up if you call it with the wrong arguments.
</p></dd></dl>

<a name="sys_003a_0025delete_002dphysical_002dpage_002dfun"></a><dl>
<dt><a name="index-sys_003a_0025delete_002dphysical_002dpage"></a>Function: <strong>sys:%delete-physical-page</strong> <em>physical-address</em></dt>
<dd><p>If there is a page in the page frame at <em>physical-address</em>,
it is swapped out and its entry is deleted from the page hash table,
making that page frame unavailable for swapping in of pages in the
future.  This doesn&rsquo;t make error checks; you
can really screw things up if you call it with the wrong arguments.
</p></dd></dl>

<a name="sys_003a_0025disk_002drestore_002dfun"></a><dl>
<dt><a name="index-sys_003a_0025disk_002drestore"></a>Function: <strong>sys:%disk-restore</strong> <em>high-16-bits low-16-bits</em></dt>
<dd><p>Loads virtual memory from the partition named by the concatenation of
the two 16-bit arguments, and starts executing it.  The name <code>0</code>
refers to the default load (the one the machine loads when it is
started up).  This is the primitive used by <code>disk-restore</code> (see <a href="#disk_002drestore_002dfun">disk-restore-fun</a>).
</p></dd></dl>

<a name="sys_003a_0025disk_002dsave_002dfun"></a><dl>
<dt><a name="index-sys_003a_0025disk_002dsave"></a>Function: <strong>sys:%disk-save</strong> <em>physical-mem-size high-16-bits low-16-bits</em></dt>
<dd><p>Copies virtual memory into the partition named by the concatenation
of the two 16-bit arguments (<code>0</code> means the default), then restarts
the world, as if it had just been restored.  The <em>physical-mem-size</em>
argument should come from <code>%sys-com-memory-size</code> in <code>system-communication-area</code>.
This is the primitive used by <code>disk-save</code> (see <a href="#disk_002dsave_002dfun">disk-save-fun</a>).
</p></dd></dl>

<a name="si_003aset_002dmemory_002dsize_002dfun"></a><dl>
<dt><a name="index-si_003aset_002dmemory_002dsize"></a>Function: <strong>si:set-memory-size</strong> <em>nwords</em></dt>
<dd><p>Specifies the size of physical memory in words.  The Lisp machine
determines the actual amount of physical memory when it is booted, but with
this function you can tell it to use less memory than is actually present.
This may be useful for comparing performance based on the amount of memory.
</p></dd></dl>

<a name="Closure-Subprimitives"></a>
<h3 class="section">14.15 Closure Subprimitives</h3>

<p>These functions deal with things like what closures deal with: the distinction
between internal and external value cells and control over how they work.
</p>
<a name="sys_003a_0025binding_002dinstances_002dfun"></a><dl>
<dt><a name="index-sys_003a_0025binding_002dinstances"></a>Function: <strong>sys:%binding-instances</strong> <em>list-of-symbols</em></dt>
<dd><p>This is the primitive that could be used by <code>closure</code>.
First, if any of the symbols in <em>list-of-symbols</em> has no external
value cell, a new external value cell is created for it, with
the contents of the internal value cell.  Then a list of locatives,
twice as long as <em>list-of-symbols</em>, is created and returned.
The elements are grouped in pairs: pointers to the internal
and external value cells, respectively, of each of the symbols.
<code>closure</code> could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun closure (variables function)
  (%make-pointer dtp-closure
     (cons function (sys:%binding-instances variables))))
</pre></div>
</dd></dl>

<a name="sys_003a_0025using_002dbinding_002dinstances_002dfun"></a><dl>
<dt><a name="index-sys_003a_0025using_002dbinding_002dinstances"></a>Function: <strong>sys:%using-binding-instances</strong> <em>instance-list</em></dt>
<dd><p>This function is the primitive operation that invocation of closures
could use.  It takes a list such as <code>sys:%binding-instances</code> returns,
and for each pair of elements in the list, it &quot;adds&quot; a binding to the
current stack frame, in the same manner that the <code>bind</code> function
(which should be called <code>%bind</code>) does.  These bindings remain in effect
until the frame returns or is unwound.
</p>
<p><code>sys:%using-binding-instances</code> checks for redundant bindings and ignores them.
(A binding is redundant if the symbol is already bound to the desired external
value cell.)  This check avoids excessive growth of the special pdl in some cases
and is also made by the microcode which invokes closures, entities, and instances.
</p>
<p>Given a closure, <code>closure-bindings</code> extracts its list of binding instances,
which you can then pass to <code>sys:%using-binding-instances</code>.
</p></dd></dl>

<a name="sys_003a_0025internal_002dvalue_002dcell_002dfun"></a><dl>
<dt><a name="index-sys_003a_0025internal_002dvalue_002dcell"></a>Function: <strong>sys:%internal-value-cell</strong> <em>symbol</em></dt>
<dd><p>Returns the contents of the internal value cell of <em>symbol</em>.
<code>dtp-one-q-forward</code> pointers are considered invisible, as usual, but
<code>dtp-external-value-cell-pointer</code>s are <em>not</em>; this function can
return a <code>dtp-external-value-cell-pointer</code>.  Such pointers will be
considered invisible as soon as they leave the &quot;inside of the machine&quot;,
meaning internal registers and the stack.
</p></dd></dl>

<a name="Microcode-Variables"></a>
<h3 class="section">14.16 Microcode Variables</h3>

<p>The following variables&rsquo; values actually reside in the scratchpad memory
of the processor.  They are put there by <code>dtp-one-q-forward</code> invisible
pointers.  The values of these variables are used by the microcode.
Many of these variables are highly internal and you shouldn&rsquo;t expect to
understand them.
</p>
<a name="g_t_0025microcode_002dversion_002dnumber_002dvar"></a><dl>
<dt><a name="index-_0025microcode_002dversion_002dnumber"></a>Variable: <strong>%microcode-version-number</strong></dt>
<dd><p>This is the version number of the currently-loaded microcode, obtained
from the version number of the microcode source file.
</p></dd></dl>

<a name="sys_003a_0025number_002dof_002dmicro_002dentries_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025number_002dof_002dmicro_002dentries"></a>Variable: <strong>sys:%number-of-micro-entries</strong></dt>
<dd><p>Size of <code>micro-code-entry-area</code> and related areas.
</p></dd></dl>

<p><code>default-cons-area</code> is documented on <a href="#default_002dcons_002darea_002dvar">default-cons-area-var</a>.
</p>
<a name="sys_003anumber_002dcons_002darea_002dvar"></a><dl>
<dt><a name="index-sys_003anumber_002dcons_002darea"></a>Variable: <strong>sys:number-cons-area</strong></dt>
<dd><p>The area number of the area where bignums and flonums are consed.
Normally this variable contains the value of <code>sys:extra-pdl-area</code>, which
enables the &quot;temporary storage&quot; feature for numbers, saving garbage collection
overhead.
</p></dd></dl>

<p><code>current-stack-group</code> and <code>current-stack-group-resumer</code>
are documented on <a href="#current_002dstack_002dgroup_002dvar">current-stack-group-var</a>.
</p>
<a name="sys_003a_0025current_002dstack_002dgroup_002dstate_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025current_002dstack_002dgroup_002dstate"></a>Variable: <strong>sys:%current-stack-group-state</strong></dt>
<dd><p>The <code>sg-state</code> of the currently-running stack group.
</p></dd></dl>

<a name="sys_003a_0025current_002dstack_002dgroup_002dcalling_002dargs_002dpointer_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025current_002dstack_002dgroup_002dcalling_002dargs_002dpointer"></a>Variable: <strong>sys:%current-stack-group-calling-args-pointer</strong></dt>
<dd><p>The argument list of the currently-running stack group.
</p></dd></dl>

<a name="sys_003a_0025current_002dstack_002dgroup_002dcalling_002dargs_002dnumber_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025current_002dstack_002dgroup_002dcalling_002dargs_002dnumber"></a>Variable: <strong>sys:%current-stack-group-calling-args-number</strong></dt>
<dd><p>The number of arguments to the currently-running stack group.
</p></dd></dl>

<a name="sys_003a_0025trap_002dmicro_002dpc_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025trap_002dmicro_002dpc"></a>Variable: <strong>sys:%trap-micro-pc</strong></dt>
<dd><p>The microcode address of the most recent error trap.
</p></dd></dl>

<a name="sys_003a_0025initial_002dfef_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025initial_002dfef"></a>Variable: <strong>sys:%initial-fef</strong></dt>
<dd><p>The function that is called when the machine starts up.
Normally this is the definition of <code>si:lisp-top-level</code>.
</p></dd></dl>

<a name="sys_003a_0025initial_002dstack_002dgroup_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025initial_002dstack_002dgroup"></a>Variable: <strong>sys:%initial-stack-group</strong></dt>
<dd><p>The stack group in which the machine starts up.
</p></dd></dl>

<a name="sys_003a_0025error_002dhandler_002dstack_002dgroup_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025error_002dhandler_002dstack_002dgroup"></a>Variable: <strong>sys:%error-handler-stack-group</strong></dt>
<dd><p>The stack group that receives control when a microcode-detected error
occurs.  This stack group cleans up, signals the appropriate condition,
or assigns a stack group to run the debugger on the erring stack group.
</p></dd></dl>

<a name="sys_003a_0025scheduler_002dstack_002dgroup_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025scheduler_002dstack_002dgroup"></a>Variable: <strong>sys:%scheduler-stack-group</strong></dt>
<dd><p>The stack group that receives control when a sequence break occurs.
</p></dd></dl>

<a name="sys_003a_0025chaos_002dcsr_002daddress_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025chaos_002dcsr_002daddress"></a>Variable: <strong>sys:%chaos-csr-address</strong></dt>
<dd><p>A fixnum, the virtual address that maps to the Unibus location of the
Chaosnet interface.
</p></dd></dl>

<a name="g_t_0025mar_002dlow_002dvar"></a><dl>
<dt><a name="index-_0025mar_002dlow"></a>Variable: <strong>%mar-low</strong></dt>
<dd><p>A fixnum, the inclusive lower bound of the region of virtual
memory subject to the MAR feature (see <a href="#mar">mar</a>).
</p></dd></dl>

<a name="g_t_0025mar_002dhigh_002dvar"></a><dl>
<dt><a name="index-_0025mar_002dhigh"></a>Variable: <strong>%mar-high</strong></dt>
<dd><p>A fixnum, the inclusive upper bound of the region of virtual
memory subject to the MAR feature (see <a href="#mar">mar</a>).
</p></dd></dl>

<a name="sys_003a_0025inhibit_002dread_002donly_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025inhibit_002dread_002donly"></a>Variable: <strong>sys:%inhibit-read-only</strong></dt>
<dd><p>If non-<code>nil</code>, you can write into read-only areas.  This is used by <code>fasload</code>.
</p></dd></dl>

<p><code>self</code> is documented on <a href="#self_002dvar">self-var</a>.
</p>
<p><code>inhibit-scheduling-flag</code> is documented on <a href="#inhibit_002dscheduling_002dflag_002dvar">inhibit-scheduling-flag-var</a>.
</p>
<a name="inhibit_002dscavenging_002dflag_002dvar"></a><dl>
<dt><a name="index-inhibit_002dscavenging_002dflag"></a>Variable: <strong>inhibit-scavenging-flag</strong></dt>
<dd><p>If non-<code>nil</code>, the scavenger is turned off.  The scavenger is
the quasi-asynchronous portion of the garbage collector,
which normally runs during consing operations.
</p></dd></dl>

<a name="sys_003ascavenger_002dws_002denable_002dvar"></a><dl>
<dt><a name="index-sys_003ascavenger_002dws_002denable"></a>Variable: <strong>sys:scavenger-ws-enable</strong></dt>
<dd><p>If this is <code>nil</code>, scavenging can compete for all of the physical
memory of the machine.  Otherwise, it should be a fixnum, which
specifies how much physical memory the scavenger can use: page numbers
as high as this number or higher are not available to it.
</p></dd></dl>

<a name="sys_003a_0025region_002dcons_002dalarm_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025region_002dcons_002dalarm"></a>Variable: <strong>sys:%region-cons-alarm</strong></dt>
<dd><p>Incremented whenever a new region is allocated.
</p></dd></dl>

<a name="sys_003a_0025page_002dcons_002dalarm_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025page_002dcons_002dalarm"></a>Variable: <strong>sys:%page-cons-alarm</strong></dt>
<dd><p>Increments whenever a new page is allocated.
</p></dd></dl>

<a name="sys_003a_0025gc_002dflip_002dready_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025gc_002dflip_002dready"></a>Variable: <strong>sys:%gc-flip-ready</strong></dt>
<dd><p><code>t</code> while the scavenger is running, <code>nil</code> when there are no pointers
to oldspace.
</p></dd></dl>

<a name="sys_003a_0025gc_002dgeneration_002dnumber_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025gc_002dgeneration_002dnumber"></a>Variable: <strong>sys:%gc-generation-number</strong></dt>
<dd><p>A fixnum which is incremented whenever the garbage collector flips, converting
one or more regions from newspace to oldspace.
If this number has changed, the <code>%pointer</code> of an object may have changed.
</p></dd></dl>

<a name="sys_003a_0025disk_002drun_002dlight_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025disk_002drun_002dlight"></a>Variable: <strong>sys:%disk-run-light</strong></dt>
<dd><p>A fixnum, the virtual address of the TV buffer location of the run-light
which lights up when the disk is active.  This plus 2 is the address of the run-light
for the processor.  This minus 2 is the address of the run-light for the garbage collector.
</p></dd></dl>

<a name="sys_003a_0025loaded_002dband_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025loaded_002dband"></a>Variable: <strong>sys:%loaded-band</strong></dt>
<dd><p>A fixnum, the high 24 bits of the name of the disk partition
from which virtual memory was booted.  Used to create the greeting message.
</p></dd></dl>

<a name="sys_003a_0025disk_002dblocks_002dper_002dtrack_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025disk_002dblocks_002dper_002dtrack"></a>Variable: <strong>sys:%disk-blocks-per-track</strong></dt>
<dd><a name="sys_003a_0025disk_002dblocks_002dper_002dcylinder_002dvar"></a></dd><dt><a name="index-sys_003a_0025disk_002dblocks_002dper_002dcylinder"></a>Variable: <strong>sys:%disk-blocks-per-cylinder</strong></dt>
<dd><p>Configuration of the disk being used for paging.  Don&rsquo;t change these!
</p></dd></dl>

<p><code>sys:%disk-switches</code> is documented on <a href="#sys_003a_0025disk_002dswitches_002dvar">sys:%disk-switches-var</a>.
</p>
<a name="sys_003a_0025qlaryh_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025qlaryh"></a>Variable: <strong>sys:%qlaryh</strong></dt>
<dd><p>This is the last array to be called as a function, remembered for the
sake of the function <code>store</code>.
</p></dd></dl>

<a name="sys_003a_0025qlaryl_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025qlaryl"></a>Variable: <strong>sys:%qlaryl</strong></dt>
<dd><p>This is the index used the last time an array was called as a
function, remembered for the sake of the function <code>store</code>.
</p></dd></dl>

<a name="g_t_0025mc_002dcode_002dexit_002dvector_002dvar"></a><dl>
<dt><a name="index-_0025mc_002dcode_002dexit_002dvector"></a>Variable: <strong>%mc-code-exit-vector</strong></dt>
<dd><p>This is a vector of pointers that microcompiled code uses to refer to
quoted constants.
</p></dd></dl>

<a name="sys_003acurrently_002dprepared_002dsheet_002dvar"></a><dl>
<dt><a name="index-sys_003acurrently_002dprepared_002dsheet"></a>Variable: <strong>sys:currently-prepared-sheet</strong></dt>
<dd><p>Used for communication between the window system and the microcoded graphics primitives.
</p></dd></dl>

<p><code>sys:alphabetic-case-affects-string-comparison</code> is documented on
<a href="#alphabetic_002dcase_002daffects_002dstring_002dcomparison_002dvar">alphabetic-case-affects-string-comparison-var</a>.
</p>
<p><code>sys:tail-recursion-flag</code> is documented on
<a href="#tail_002drecursion_002dflag_002dvar">tail-recursion-flag-var</a>.
</p>
<p><code>zunderflow</code> is documented on <a href="#zunderflow_002dvar">zunderflow-var</a>.
</p>
<p>The next four have to do with implementing the metering system described
in <a href="#meter_002dsection">meter-section</a>.
</p>
<a name="sys_003a_0025meter_002dglobal_002denable_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025meter_002dglobal_002denable"></a>Variable: <strong>sys:%meter-global-enable</strong></dt>
<dd><p><code>t</code> if the metering system is turned on for all stack-groups.
</p></dd></dl>

<a name="sys_003a_0025meter_002dbuffer_002dpointer_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025meter_002dbuffer_002dpointer"></a>Variable: <strong>sys:%meter-buffer-pointer</strong></dt>
<dd><p>A temporary buffer used by the metering system.
</p></dd></dl>

<a name="sys_003a_0025meter_002ddisk_002daddress_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025meter_002ddisk_002daddress"></a>Variable: <strong>sys:%meter-disk-address</strong></dt>
<dd><p>Where the metering system writes its next block of results on the disk.
</p></dd></dl>

<a name="sys_003a_0025meter_002ddisk_002dcount_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025meter_002ddisk_002dcount"></a>Variable: <strong>sys:%meter-disk-count</strong></dt>
<dd><p>The number of disk blocks remaining for recording of metering information.
</p></dd></dl>

<a name="sys_003alexical_002denvironment_002dvar"></a><dl>
<dt><a name="index-sys_003alexical_002denvironment"></a>Variable: <strong>sys:lexical-environment</strong></dt>
<dd><p>This is the list of previous stack frames used by
<code>lexical-closure</code>.
</p></dd></dl>

<a name="sys_003aamem_002devcp_002dvector_002dvar"></a><dl>
<dt><a name="index-sys_003aamem_002devcp_002dvector"></a>Variable: <strong>sys:amem-evcp-vector</strong></dt>
<dd><p>This is a vector of shadow locations for all these microcode
variables, used in implementing closure-binding of them.
The microcode does not check for the presence of external value cell
pointers in the microcode locations that these variables correspond
to; therefore, when a closure would otherwise try to store an external
value cell pointer into one of them, it goes in this vector instead.
</p></dd></dl>

<p><code>background-cons-area</code> is documented on
<a href="#background_002dcons_002darea_002dvar">background-cons-area-var</a>.
</p>
<p><code>sys:self-mapping-table</code> is documented on
<a href="#sys_003aself_002dmapping_002dtable_002dvar">sys:self-mapping-table-var</a>.
</p>
<a name="sys_003a_0025gc_002dswitches_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025gc_002dswitches"></a>Variable: <strong>sys:%gc-switches</strong></dt>
<dd><p>What is this used for?
</p></dd></dl>

<a name="sys_003aa_002dmemory_002dlocation_002dnames_002dvar"></a><dl>
<dt><a name="index-sys_003aa_002dmemory_002dlocation_002dnames"></a>Variable: <strong>sys:a-memory-location-names</strong></dt>
<dd><p>A list of all of the above symbols (and any others added after this documentation
was written).
</p></dd></dl>

<a name="Meters"></a>
<h3 class="section">14.17 Meters</h3>

<a name="read_002dmeter_002dfun"></a><dl>
<dt><a name="index-read_002dmeter"></a>Function: <strong>read-meter</strong> <em>name</em></dt>
<dd><p>Returns the contents of the microcode meter named <em>name</em>, which can be a fixnum
or a bignum.  <em>name</em> must be one of the symbols listed below.
</p></dd></dl>

<a name="write_002dmeter_002dfun"></a><dl>
<dt><a name="index-write_002dmeter"></a>Function: <strong>write-meter</strong> <em>name value</em></dt>
<dd><p>Writes <em>value</em>, a fixnum or a bignum, into the microcode meter named <em>name</em>.
<em>name</em> must be one of the symbols listed below.
</p></dd></dl>

<p>The microcode meters are as follows:
</p>
<dl>
<dt><a name="index-sys_003a_0025count_002dchaos_002dtransmit_002daborts"></a>Meter: <strong>sys:%count-chaos-transmit-aborts</strong></dt>
<dd><p>The number of times transmission on the Chaosnet was aborted, either by a collision
or because the receiver was busy.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002dcons_002dwork"></a>Meter: <strong>sys:%count-cons-work</strong></dt>
<dt><a name="index-sys_003a_0025count_002dscavenger_002dwork"></a>Meter: <strong>sys:%count-scavenger-work</strong></dt>
<dd><p>Internal state of the garbage collection algorithm.
</p></dd></dl>

<a name="sys_003a_0025tv_002dclock_002drate_002dmeter"></a><dl>
<dt><a name="index-sys_003a_0025tv_002dclock_002drate"></a>Meter: <strong>sys:%tv-clock-rate</strong></dt>
<dd><p>The number of TV frames per clock sequence break.
The default value is 67., which causes clock sequence breaks to happen
about once per second.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002dfirst_002dlevel_002dmap_002dreloads"></a>Meter: <strong>sys:%count-first-level-map-reloads</strong></dt>
<dd><p>The number of times the first-level virtual-memory map was invalid
and had to be reloaded from the page hash table.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002dsecond_002dlevel_002dmap_002dreloads"></a>Meter: <strong>sys:%count-second-level-map-reloads</strong></dt>
<dd><p>The number of times the second-level virtual-memory map was invalid
and had to be reloaded from the page hash table.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002dmeta_002dbits_002dmap_002dreloads"></a>Meter: <strong>sys:%count-meta-bits-map-reloads</strong></dt>
<dd><p>The number of times the virtual address map was reloaded to contain only
&quot;meta bits&quot;, not an actual physical address.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002dpdl_002dbuffer_002dread_002dfaults"></a>Meter: <strong>sys:%count-pdl-buffer-read-faults</strong></dt>
<dd><p>The number of read references to the pdl buffer that were
virtual memory references that trapped.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002dpdl_002dbuffer_002dwrite_002dfaults"></a>Meter: <strong>sys:%count-pdl-buffer-write-faults</strong></dt>
<dd><p>The number of write references to the pdl buffer that were
virtual memory references that trapped.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002dpdl_002dbuffer_002dmemory_002dfaults"></a>Meter: <strong>sys:%count-pdl-buffer-memory-faults</strong></dt>
<dd><p>The number of virtual memory references that trapped in case
they should have gone to the pdl buffer, but turned out to be
real memory references after all (and therefore were needlessly
slowed down).
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002ddisk_002dpage_002dreads"></a>Meter: <strong>sys:%count-disk-page-reads</strong></dt>
<dd><p>The number of pages read from the disk.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002ddisk_002dpage_002dwrites"></a>Meter: <strong>sys:%count-disk-page-writes</strong></dt>
<dd><p>The number of pages written to the disk.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002dfresh_002dpages"></a>Meter: <strong>sys:%count-fresh-pages</strong></dt>
<dd><p>The number of fresh (newly-consed) pages created in core,
which would have otherwise been read from the disk.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002ddisk_002dpage_002dread_002doperations"></a>Meter: <strong>sys:%count-disk-page-read-operations</strong></dt>
<dd><p>The number of paging read operations; this can be smaller than the number of
disk pages read when more than one page at a time is read.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002ddisk_002dpage_002dwrite_002doperations"></a>Meter: <strong>sys:%count-disk-page-write-operations</strong></dt>
<dd><p>The number of paging write operations; this can be smaller than the number of
disk pages written when more than one page at a time is written.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002ddisk_002dprepages_002dused"></a>Meter: <strong>sys:%count-disk-prepages-used</strong></dt>
<dd><p>The number of times a page was used after being read in before it was needed.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002ddisk_002dprepages_002dnot_002dused"></a>Meter: <strong>sys:%count-disk-prepages-not-used</strong></dt>
<dd><p>The number of times a page was read in before it was needed, but got evicted
before it was ever used.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002ddisk_002dpage_002dwrite_002dwaits"></a>Meter: <strong>sys:%count-disk-page-write-waits</strong></dt>
<dd><p>The number of times the machine waited for a page to finish being written out
in order to evict the page.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002ddisk_002dpage_002dwrite_002dbusys"></a>Meter: <strong>sys:%count-disk-page-write-busys</strong></dt>
<dd><p>The number of times the machine waited for a page to finish being written out
in order to do something else with the disk.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025disk_002dwait_002dtime"></a>Meter: <strong>sys:%disk-wait-time</strong></dt>
<dd><p>The time spent waiting for the disk, in microseconds.  This can be used to
distinguish paging time from running time when measuring and optimizing the&lsquo;
performance of programs.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002ddisk_002derrors"></a>Meter: <strong>sys:%count-disk-errors</strong></dt>
<dd><p>The number of recoverable disk errors.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002ddisk_002drecalibrates"></a>Meter: <strong>sys:%count-disk-recalibrates</strong></dt>
<dd><p>The number of times the disk seek mechanism was recalibrated,
usually as part of error recovery.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002ddisk_002decc_002dcorrected_002derrors"></a>Meter: <strong>sys:%count-disk-ecc-corrected-errors</strong></dt>
<dd><p>The number of disk errors that were corrected through the error correcting code.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002ddisk_002dread_002dcompare_002ddifferences"></a>Meter: <strong>sys:%count-disk-read-compare-differences</strong></dt>
<dd><p>The number of times a read compare was done, no disk error occurred, but the
data on disk did not match the data in memory.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002ddisk_002dread_002dcompare_002drereads"></a>Meter: <strong>sys:%count-disk-read-compare-rereads</strong></dt>
<dd><p>The number of times a disk read was done over because after the read a read
compare was done and did not succeed (either it got an error or the data on disk
did not match the data in memory).
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002ddisk_002dread_002dcompare_002drewrites"></a>Meter: <strong>sys:%count-disk-read-compare-rewrites</strong></dt>
<dd><p>The number of times a disk write was done over because after the write a read
compare was done and did not succeed (either it got an error or the data on disk
did not match the data in memory).
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025disk_002derror_002dlog_002dpointer"></a>Meter: <strong>sys:%disk-error-log-pointer</strong></dt>
<dd><p>Address of the next entry to be written in the disk error log.  The function
<code>si:print-disk-error-log</code> (see <a href="#si_003aprint_002ddisk_002derror_002dlog_002dfun">si:print-disk-error-log-fun</a>) prints this log.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002daged_002dpages"></a>Meter: <strong>sys:%count-aged-pages</strong></dt>
<dd><p>The number of times the page ager set an age trap on a page, to determine
whether it was being referenced.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002dage_002dflushed_002dpages"></a>Meter: <strong>sys:%count-age-flushed-pages</strong></dt>
<dd><p>The number of times the page ager saw that a page still had an age trap
and hence made it &quot;flushable&quot;, a candidate for eviction from main memory.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025aging_002ddepth"></a>Meter: <strong>sys:%aging-depth</strong></dt>
<dd><p>A number from 0 to 3 that controls how long a page must remain unreferenced
before it becomes a candidate for eviction from main memory.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002dfindcore_002dsteps"></a>Meter: <strong>sys:%count-findcore-steps</strong></dt>
<dd><p>The number of pages inspected by the page replacement algorithm.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003a_0025count_002dfindcore_002demergencies"></a>Meter: <strong>sys:%count-findcore-emergencies</strong></dt>
<dd><p>The number of times no evictable page was found and extra aging had to be done.
</p></dd></dl>

<a name="sys_003aa_002dmemory_002dcounter_002dblock_002dnames_002dvar"></a><dl>
<dt><a name="index-sys_003aa_002dmemory_002dcounter_002dblock_002dnames"></a>Variable: <strong>sys:a-memory-counter-block-names</strong></dt>
<dd><p>A list of all of the above symbols (and any others added after this documentation
was written).
</p></dd></dl>

<a name="g_t_0022Areas_0022"></a>
<h2 class="chapter">15 &quot;Areas&quot;</h2>
<a name="index-area"></a>
<a name="area"></a><a name="area_002dchapter"></a>
<p>Storage in the Lisp Machine is divided into <em>areas</em>.  Each area
contains related objects, of any type.  Areas are intended to give the
user control over the paging behavior of his program, among other
things.  Putting frequently used data and rarely used data in different
areas can cause the frequently used data to occupy fewer pages.  For
example, the system puts the debugging info alists of compiled functions
in a special area so that the other list structure the functions point
to will be more compact.
</p>
<p>Whenever a new object is created the area to be used can
optionally be specified.  For example, instead of using <code>cons</code> you can
use <code>cons-in-area</code> (see <a href="#cons_002din_002darea_002dfun">cons-in-area-fun</a>).  Object-creating functions
which take keyword arguments generally accept a <code>:area</code> argument.
You can also control which area is used by binding <code>default-cons-area</code>
(see <a href="#default_002dcons_002darea_002dvar">default-cons-area-var</a>); most functions that allocate storage
use the value of this variable, by default, to specify the area to use.
</p>
<p>There is a default Working Storage area that collects those objects
that the user has not chosen to control explicitly. 
</p>
<p>Areas also give the user a handle to control the garbage
collector.  Some areas can be declared to be &quot;static&quot;, which means that
they change slowly and the garbage collector should not attempt to
reclaim any space in them.  This can eliminate a lot of useless
copying.  A &quot;static&quot; area can be explicitly
garbage-collected at infrequent intervals when it is believed that that
might be worthwhile. 
</p>
<p>Each area can potentially have a different storage discipline,
a different paging algorithm, and even a different data representation. 
The microcode will dispatch on an attribute of the area at the
appropriate times.  The structure of the machine makes the performance
cost of these features negligible; information about areas is stored
in extra bits in the memory mapping hardware where it can be quickly
dispatched on by the microcode; these dispatches usually have to be
done anyway to make the garbage collector work and to implement
invisible pointers.  This feature is not currently used by the system,
except for the list/structure distinction described below.
</p>
<p>Each area has a name and a number.  The name is a symbol whose
value is the number.  The number is an index into various internal
tables.  Normally the name is treated as a special variable, so the
number is what is given as an argument to a function that takes an area
as an argument.  Thus, areas are not Lisp objects; you cannot
pass an area itself as an argument to a function; you just pass its
number.  There is a maximum number of areas (set at cold-load generation
time); you can only have that many areas before the various internal
tables overflow.  Currently (as this manual is written) the limit is
<code>256</code> areas, of which <code>64</code> already exist when you start.
</p>
<p>The storage of an area consists of one or more <em>regions</em>.  Each region
is a contiguous section of address space with certain homogeneous properties.
The most important of these is the <em>data representation type</em>.  A given region
can only store one type.  The two types that exist now are <em>list</em> and <em>structure</em>.
A list is anything made out of conses (a closure for instance).  A structure is
anything made out of a block of memory with a header at the front; symbols, strings,
arrays, instances, compiled functions, etc.  Since lists and structures cannot be stored
in the same region, they cannot be on the same page.  It is necessary to know about
this when using areas to increase locality of reference.
</p>
<p>When you create an area, one region is created initially.  When you try
to allocate memory to hold an object in some area, the system tries to
find a region that has the right data representation type to hold this
object, and that has enough room for it to fit.  If there isn&rsquo;t any such
region, it makes a new one (or signals an error; see the <code>:size</code> option
to <code>make-area</code>, below).  The size of the new region is an attribute of
the area (controllable by the <code>:region-size</code> option to <code>make-area</code>).
If regions are too large, memory may get taken up by a region and never used.
If regions are too small, the system may run out of regions because regions,
like areas, are defined by internal tables that have a fixed size (set at
cold-load generation time).  Currently (as this manual is written) the limit
is <code>256</code> regions, of which about <code>90</code> already exist when you start.
(If you&rsquo;re wondering why the limit on regions isn&rsquo;t higher than the limit
on areas, as it clearly ought to be, it&rsquo;s just because both limits have
to be multiples of <code>256</code> for internal reasons, and <code>256</code> regions seem
to be enough.)
</p>
<a name="Area-Functions-and-Variables"></a>
<h3 class="section">15.1 Area Functions and Variables</h3>

<a name="default_002dcons_002darea_002dvar"></a><dl>
<dt><a name="index-default_002dcons_002darea"></a>Variable: <strong>default-cons-area</strong></dt>
<dd><p>The value of this variable is the number of the area in which objects are created
by default.  It is initially the number of <code>working-storage-area</code>.
Giving <code>nil</code> where an area is required uses the value of <code>default-cons-area</code>.
Note that to put objects into an area other than <code>working-storage-area</code>
you can either bind this variable or use functions such as
<code>cons-in-area</code> (see <a href="#cons_002din_002darea_002dfun">cons-in-area-fun</a>) which take the area as an explicit argument.
</p></dd></dl>

<a name="background_002dcons_002darea_002dvar"></a><dl>
<dt><a name="index-background_002dcons_002darea"></a>Variable: <strong>background-cons-area</strong></dt>
<dd><p>The value of this variable is the number of a non-temporary area in
which objects created as incidental side effects by system functions
should be created.  This area is used whenever an object is created that
should never be in a temporary area, even if <em>default-cons-area</em> is a
temporary area.
</p>
<p>By default, this area is <code>working-storage-area</code>.
</p></dd></dl>

<a name="make_002darea_002dfun"></a><dl>
<dt><a name="index-make_002darea"></a>Function: <strong>make-area</strong> <em>&amp;rest keywords</em></dt>
<dd><p>Creates a new area, whose name and attributes are specified by the keywords.
You must specify a symbol as a name; the symbol will be <code>setq</code>&rsquo;ed to
the area-number of the new area, and that number will also be returned,
so that you can use <code>make-area</code> as the initialization of a <code>defvar</code>.
The arguments are taken in pairs, the first being a keyword and the second
a &quot;value&quot; for that keyword.  The last three keywords documented herein
are in the nature of subprimitives; like the stuff in chapter
<a href="#subprimitive_002dchapter">subprimitive-chapter</a>, their meaning is system-dependent and is not
documented here.  The following keywords exist:
</p><dl compact="compact">
<dt><span class="roman">:name</span></dt>
<dd><p>A symbol that will be the name of the area.  This item is required.
</p>
</dd>
<dt><span class="roman">:size</span></dt>
<dd><p>The maximum allowed size of the area, in words.  Defaults to infinite.
(Actually, the default is the largest positive fixnum; but the area is
not limited to that size!)
If the number of words allocated to the area reaches this size, attempting
to cons an object in the area will signal an error.
</p>
</dd>
<dt><span class="roman">:region-size</span></dt>
<dd><p>The approximate size, in words, for regions within this area.  The
default is the area size if a <code>:size</code> argument was given, otherwise it is a
suitable medium size.  Note that if you specify <code>:size</code> and not
<code>:region-size</code>, the area will have exactly one region.  When making an
area that will be very big, it is desirable to make the region size
larger than the default region size to avoid creating very many regions
and possibly overflowing the system&rsquo;s fixed-size region tables.
</p>
</dd>
<dt><span class="roman">:representation</span></dt>
<dd><p>The type of object to be contained in the area&rsquo;s initial region.
The argument to this keyword can be <code>:list</code>, <code>:structure</code>, or a numeric code.
<code>:structure</code> is the default.  If you are only going to cons lists in your
area, you should specify <code>:list</code> so you don&rsquo;t get a useless structure region.
</p>
</dd>
<dt><span class="roman">:gc</span></dt>
<dd><p>The type of garbage-collection to be employed.  The choices are
<code>:dynamic</code> (which is the default), <code>:static</code>, and <code>:temporary</code>.
<code>:static</code> means that the area will not be copied by the garbage
collector, and nothing in the area or pointed to by the area will ever
be reclaimed, unless a garbage collection of this area is manually
requested.  <code>:temporary</code> is like <code>:static</code>, but in addition you are
allowed to use <code>si:reset-temporary-area</code> on this area.
</p>
</dd>
<dt><span class="roman">:read-only</span></dt>
<dd><p>With an argument of <code>t</code>, causes the area to be made read-only.  Defaults
to <code>nil</code>.  If an area is read-only, then any attempt to change anything
in it (altering a data object in the area or creating a new object in the
area) will signal an error unless <code>sys:%inhibit-read-only</code>
(see <a href="#sys_003a_0025inhibit_002dread_002donly_002dvar">sys:%inhibit-read-only-var</a>) is bound to a non-<code>nil</code> value.
</p>
</dd>
<dt><span class="roman">:pdl</span></dt>
<dd><p>With an argument of <code>t</code>, makes the area suitable for storing
regular-pdls of stack-groups.  This is a special attribute due to the
pdl-buffer hardware.  Defaults to <code>nil</code>.  Areas for which this is <code>nil</code>
may <em>not</em> be used to store regular-pdls.  Areas for which this is <code>t</code>
are relatively slow to access; all references to pages in the area will
take page faults to check whether the referenced location is really in
the pdl-buffer.
</p>
</dd>
<dt><span class="roman">sys:%%region-map-bits</span></dt>
<dd><p>Lets you specify the <em>map bits</em> explicitly, overriding the specification
from the other keywords.  This is for special hacks only.
</p>
</dd>
<dt><span class="roman">sys:%%region-space-type</span></dt>
<dd><p>Lets you specify the <em>space type</em> explicitly, overriding the specification
from the other keywords.  This is for special hacks only.
</p>
</dd>
<dt><span class="roman">sys:%%region-scavenge-enable</span></dt>
<dd><p>Lets you override the scavenge-enable bit explicitly.  This is an internal
flag related to the garbage collector.  Don&rsquo;t mess with this!
</p>
</dd>
<dt><span class="roman">:room</span></dt>
<dd><p>With an argument of <code>t</code>, adds this area to the list of areas that are
displayed by default by the <code>room</code> function (see <a href="#room_002dfun">room-fun</a>).
</p></dd>
</dl>

<div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(make-area ':name 'foo-area
	   ':gc ':dynamic
	   ':representation ':list)
</pre></div>
</dd></dl>

<a name="describe_002darea_002dfun"></a><dl>
<dt><a name="index-describe_002darea"></a>Function: <strong>describe-area</strong> <em>area</em></dt>
<dd><p><em>area</em> may be the name or the number of an area.  Various
attributes of the area are printed.
</p></dd></dl>

<a name="area_002dlist_002dvar"></a><dl>
<dt><a name="index-area_002dlist"></a>Variable: <strong>area-list</strong></dt>
<dd><p>The value of <code>area-list</code> is a list of the names of all existing areas.
This list shares storage with the internal area name table, so you should
not change it.
</p></dd></dl>

<a name="g_t_0025area_002dnumber_002dfun"></a><dl>
<dt><a name="index-_0025area_002dnumber"></a>Function: <strong>%area-number</strong> <em>pointer</em></dt>
<dd><p>Returns the number of the area to which <em>pointer</em> points, or <code>nil</code> if
it does not point within any known area.  The data-type of <em>pointer</em>
is ignored.
</p></dd></dl>

<a name="g_t_0025region_002dnumber_002dfun"></a><dl>
<dt><a name="index-_0025region_002dnumber"></a>Function: <strong>%region-number</strong> <em>pointer</em></dt>
<dd><p>Returns the number of the region to which <em>pointer</em> points, or <code>nil</code> if
it does not point within any known region.  The data-type of <em>pointer</em>
is ignored.  (This information is generally not very interesting to users;
it is important only inside the system.)
</p></dd></dl>

<a name="area_002dname_002dfun"></a><dl>
<dt><a name="index-area_002dname"></a>Function: <strong>area-name</strong> <em>number</em></dt>
<dd><p>Given an area number, returns the name.  This &quot;function&quot; is actually an array.
</p></dd></dl>

<a name="si_003areset_002dtemporary_002darea_002dfun"></a><dl>
<dt><a name="index-si_003areset_002dtemporary_002darea"></a>Function: <strong>si:reset-temporary-area</strong> <em>area-number</em></dt>
<dd><p>This very dangerous operation marks all the storage in area
<em>area-number</em> as free and available for re-use.  Any data in the area
will be lost and pointers to it will become meaningless.  In principle,
this operation should only be used if you are sure there are no pointers
into the area.
</p>
<p>If the area was not defined as &quot;temporary&quot;, this function gets an
error.
</p></dd></dl>

<p>See also <code>cons-in-area</code> (<a href="#cons_002din_002darea_002dfun">cons-in-area-fun</a>), <code>list-in-area</code> (<a href="#list_002din_002darea_002dfun">list-in-area-fun</a>),
and <code>room</code> (<a href="#room_002dfun">room-fun</a>).
</p>

<a name="Interesting-Areas"></a>
<h3 class="section">15.2 Interesting Areas</h3>

<p>This section lists the names of some of the areas and tells what they are for.
Only the ones of the most interest to a user are listed; there are many others.
</p>
<a name="working_002dstorage_002darea_002dvar"></a><dl>
<dt><a name="index-working_002dstorage_002darea"></a>Variable: <strong>working-storage-area</strong></dt>
<dd><p>This is the normal value of <code>default-cons-area</code>.
Most working data are consed in this area.
</p></dd></dl>

<a name="permanent_002dstorage_002darea_002dvar"></a><dl>
<dt><a name="index-permanent_002dstorage_002darea"></a>Variable: <strong>permanent-storage-area</strong></dt>
<dd><p>This area is to be used for &quot;permanent&quot; data, which will (almost) never become
garbage.  Unlike <code>working-storage-area</code>, the contents of this area
are not continually copied by the garbage collector; it is a static area.
</p></dd></dl>

<a name="sys_003ap_002dn_002dstring_002dvar"></a><dl>
<dt><a name="index-sys_003ap_002dn_002dstring"></a>Variable: <strong>sys:p-n-string</strong></dt>
<dd><p>Print-names of symbols are stored in this area.
</p></dd></dl>

<a name="sys_003anr_002dsym_002dvar"></a><dl>
<dt><a name="index-sys_003anr_002dsym"></a>Variable: <strong>sys:nr-sym</strong></dt>
<dd><p>This area contains most of the symbols in the Lisp world, except <code>t</code> and <code>nil</code>,
which are in a different place for historical reasons.
</p></dd></dl>

<a name="sys_003apkg_002darea_002dvar"></a><dl>
<dt><a name="index-sys_003apkg_002darea"></a>Variable: <strong>sys:pkg-area</strong></dt>
<dd><p>This area contains packages, principally the hash tables with which <code>intern</code>
keeps track of symbols.
</p></dd></dl>

<a name="macro_002dcompiled_002dprogram_002dvar"></a><dl>
<dt><a name="index-macro_002dcompiled_002dprogram"></a>Variable: <strong>macro-compiled-program</strong></dt>
<dd><p>FEFs (compiled functions) are put here by the compiler and by <code>fasload</code>.
</p></dd></dl>

<a name="sys_003aproperty_002dlist_002darea_002dvar"></a><dl>
<dt><a name="index-sys_003aproperty_002dlist_002darea"></a>Variable: <strong>sys:property-list-area</strong></dt>
<dd><p>This area holds the property lists of symbols.
</p></dd></dl>

<a name="sys_003ainit_002dlist_002darea_002dvar"></a><dl>
<dt><a name="index-sys_003ainit_002dlist_002darea"></a>Variable: <strong>sys:init-list-area</strong></dt>
<dd><a name="sys_003afasl_002dconstants_002darea_002dvar"></a></dd><dt><a name="index-sys_003afasl_002dconstants_002darea"></a>Variable: <strong>sys:fasl-constants-area</strong></dt>
<dd><p>These two areas contain constants used by compiled programs.
</p></dd></dl>

<a name="Errors-Pertaining-to-Areas"></a>
<h3 class="section">15.3 Errors Pertaining to Areas</h3>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003aarea_002doverflow"></a>Condition on sys:area-overflow: <strong>(<code>error</code>)</strong></dt>
<dd><p>This is signaled on an attempt to make an area bigger than its declared maximum size.
</p>
<p>The condition instance supports the operations <code>:area-name</code> and
<code>:area-maximum-size</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003aregion_002dtable_002doverflow"></a>Condition on sys:region-table-overflow: <strong>(<code>error</code>)</strong></dt>
<dd><p>This is signaled if you run out of regions.
</p></dd></dl>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003avirtual_002dmemory_002doverflow"></a>Condition on sys:virtual-memory-overflow: <strong>(<code>error</code>)</strong></dt>
<dd><p>This is signaled if all of virtual memory is part of some region and an
attempt is made to allocate a new region.  There may be free space left
in some regions in other areas, but there is no way to apply it to the
area in which storage is to be allocated. 
</p></dd></dl>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003acons_002din_002dfixed_002darea"></a>Condition on sys:cons-in-fixed-area: <strong>(<code>error</code>)</strong></dt>
<dd><p>This is signaled if an attempt is made add a second region to a fixed
area.  The fixed areas are certain areas, created at system
initialization, that are only allowed a single region, because their
contents must be contiguous in virtual memory.
</p></dd></dl>

<a name="g_t_0022The-Compiler_0022"></a>
<h2 class="chapter">16 &quot;The Compiler&quot;</h2>
<a name="compiler"></a><a name="compiler_002dchapter"></a><a name="index-compiler"></a>

<a name="g_t_0022The-Basic-Operations-of-the-Compiler_0022"></a>
<h3 class="section">16.1 &quot;The Basic Operations of the Compiler&quot;</h3>

<p>The purpose of the Lisp compiler is to convert Lisp functions
into programs in the Lisp Machine&rsquo;s instruction set, so that they
will run more quickly and take up less storage.  Compiled functions
are represented in Lisp by FEFs (Function
Entry Frames), which contain machine code as well as various other information.
The printed representation of a FEF is
</p><div class="lisp">
<pre class="lisp">#&lt;DTP-FEF-POINTER <em>address</em> <em>name</em>&gt;
</pre></div>

<p>If you want to understand the output of the compiler, refer
to <a href="#understanding_002dcompiled_002dcode">understanding-compiled-code</a>.
</p>
<a name="index-QFASL-files"></a>

<p>There are three ways to invoke the compiler from the Lisp
Machine.  First, you may have an interpreted function in the Lisp
environment that you would like to compile.  The function <code>compile</code>
is used to do this.  Second, you may have code in an editor buffer that
you would like to compile.  The Zwei editor has commands to read code
into Lisp and compile it.  Third, you may have a program (a group of
function definitions and other forms) written in a file on the file
system.  The function <code>qc-file</code> can translate this file into a
<em>QFASL</em> file that describes the compiled functions and associated
data.  The QFASL file format is capable of representing an arbitrary
collection of Lisp objects, including shared structure and cycles of
pointers.  The name derives from &quot;Q&quot;, a prefix once used to mean &quot;for
the Lisp machine, not for Maclisp&quot;, and &quot;FASL&quot;, an abbreviation for
&quot;fast loading&quot;.
</p>

<a name="g_t_0022How-to-Invoke-the-Compiler_0022"></a>
<h3 class="section">16.2 &quot;How to Invoke the Compiler&quot;</h3>

<a name="compile_002dfun"></a><dl>
<dt><a name="index-compile"></a>Function: <strong>compile</strong> <em>function-spec &amp;optional definition</em></dt>
<dd><p>If <em>definition</em> is supplied, it should be a <code>lambda</code>-expression.
Otherwise <em>function-spec</em> (this is usually a symbol, but see <a href="#function_002dspec">function-spec</a> for details)
should be defined as an interpreted function and
its definition will be used as the <code>lambda</code>-expression to be compiled.
The compiler converts the <code>lambda</code>-expression into a FEF, saves the
<code>lambda</code>-expression as the
<code>:previous-definition</code> property of <em>function-spec</em> if it is a symbol, and changes
<em>function-spec</em>&rsquo;s definition to be the FEF.  (See <code>fdefine</code>,
<a href="#fdefine_002dfun">fdefine-fun</a>.)
</p>
<p>If <em>function-spec</em>&rsquo;s definition is already a FEF, and that FEF&rsquo;s
debugging info alist records the interpreted definition it was compiled
from, that same definition is compiled again.  The original definition
is recorded in a FEF&rsquo;s debugging info alist whenever the function is
compiled in core (such as by means of <code>compile</code>, but not if the
function is loaded from a QFASL file, except for <code>defsubst</code>s).
</p></dd></dl>

<a name="uncompile_002dfun"></a><dl>
<dt><a name="index-uncompile"></a>Function: <strong>uncompile</strong> <em>function-spec</em></dt>
<dd><p>If <em>function-spec</em> is defined as a compiled function that records the
original definition that was compiled, then <em>function-spec</em> is redefined
with that original definition.  This undoes the effect of calling
<code>compile</code> on <em>function-spec</em>.
</p></dd></dl>

<a name="compile_002dlambda_002dfun"></a><dl>
<dt><a name="index-compile_002dlambda"></a>Function: <strong>compile-lambda</strong> <em>lambda-exp function-spec</em></dt>
<dd><p>Returns a compiled function object produced by compiling <em>lambda-exp</em>.
The function name recorded by the compiled function object is
<em>function-spec</em>, but that function spec is not defined
by <code>compile-lambda</code>.
</p></dd></dl>

<a name="compile_002dencapsulations_002dfun"></a><dl>
<dt><a name="index-compile_002dencapsulations"></a>Function: <strong>compile-encapsulations</strong> <em>function-spec</em></dt>
<dd><p>Compiles all encapsulations that <code>function-spec</code> currently has.
Encapsulations (see <a href="#encapsulate">encapsulate</a>) include tracing, breakons and
advice.  Compiling tracing or breakons makes it possible (or at least
more possible) to trace or breakon certain functions that are used in
the evaluator.  Compiling advice makes it less costly to advise
functions that are used frequently.
</p>
<p>Any encapsulation that is changed will cease to be compiled; thus, if
you add or remove advice, you must do <code>compile-encapsulations</code> again
if you wish the advice to be compiled again.
</p></dd></dl>

<a name="compile_002dencapsulations_002dflag_002dvar"></a><dl>
<dt><a name="index-compile_002dencapsulations_002dflag"></a>Variable: <strong>compile-encapsulations-flag</strong></dt>
<dd><p>If this is non-<code>nil</code>, all encapsulations that are created are compiled
automatically.
</p></dd></dl>

<a name="qc_002dfile_002dfun"></a><dl>
<dt><a name="index-qc_002dfile"></a>Function: <strong>qc-file</strong> <em>filename &amp;optional output-file load-flag in-core-flag package file-local-declarations dont-set-default-p read-then-process-flag</em></dt>
<dd><p>This function takes a formidable number of arguments, but normally only one
argument is supplied.
The file <em>filename</em> is given to the compiler, and the output of the
compiler is written to a file whose name is <em>filename</em> except with a
file type of <code>&quot;QFASL&quot;</code>.  The input format for files to the compiler is
described on <a href="#compiler_002dinput_002dsection">compiler-input-section</a>.
Macro definitions, <code>subst</code> definitions, and <code>special</code> declarations created during
the compilation are undone when the compilation is
finished.
</p>
<p>The optional arguments allow certain modifications to the standard procedure.
<em>output-file</em> lets you change where the output is written.
<em>package</em> lets you specify in what package the source file is to
be read.  Normally the system knows, or asks interactively,
and you need not supply this argument.
<em>load-flag</em> and <em>in-core-flag</em> are incomprehensible; you don&rsquo;t
want to use them.  <em>file-local-declarations</em> is for compiling
multiple files as if they were one.  <em>dont-set-default-p</em> suppresses the changing
of the default file name to <em>filename</em> that normally occurs.
</p>
<p>Normally, a form is read from the file and processed and then another
form is read and processed, and so on.  But if
<em>read-then-process-flag</em> is non-<code>nil</code>, the whole source file is read
before any of it is processed.  This is not done by default; it has the
problem that compile-time reader-macros defined in the file will not
work properly.
</p></dd></dl>

<a name="qc_002dfile_002dload_002dfun"></a><dl>
<dt><a name="index-qc_002dfile_002dload"></a>Function: <strong>qc-file-load</strong> <em>filename &amp;optional output-file load-flag in-core-flag package functions-defined file-local-declarations dont-set-default-p read-then-process-flag</em></dt>
<dd><p><code>qc-file-load</code> compiles a file and then loads in the resulting QFASL file.
</p></dd></dl>

<a name="compiler_003acompiler_002dverbose_002dvar"></a><dl>
<dt><a name="index-compiler_003acompiler_002dverbose"></a>Variable: <strong>compiler:compiler-verbose</strong></dt>
<dd><p>If this variable is non-<code>nil</code>, the compiler prints the name of each
function that it is about to compile.
</p></dd></dl>

<a name="compiler_003apeep_002denable_002dvar"></a><dl>
<dt><a name="index-compiler_003apeep_002denable"></a>Variable: <strong>compiler:peep-enable</strong></dt>
<dd><p>The peephole optimizer is used if this variable is non-<code>nil</code>.
The only reason to set it to <code>nil</code> is if there is a suspicion of a bug in the optimizer.
</p></dd></dl>

<p>See also the <code>disassemble</code> function (<a href="#disassemble_002dfun">disassemble-fun</a>), which lists the instructions
of a compiled function in symbolic form.
</p>

<a name="g_t_0022Input-to-the-Compiler_0022"></a>
<h3 class="section">16.3 &quot;Input to the Compiler&quot;</h3>
<a name="compiler_002dinput_002dsection"></a><a name="index-input-to-the-compiler"></a>

<p>The purpose of <code>qc-file</code> is to take a file and produce
a translated version which does the same thing as the original except
that the functions are compiled.  <code>qc-file</code> reads through the input
file, processing the forms in it one by one.  For each form, suitable
binary output is sent to the QFASL file so that when the QFASL file is
loaded the effect of that source form will be reproduced.  The differences
between source files and QFASL files are that QFASL files are in a compressed
binary form, which reads much faster but cannot be edited, and that
function definitions in QFASL files have been translated from Lisp forms
to FEFs.
</p>
<p>So, if the source contains a <code>(defun ...)</code> form at top level,
then when the QFASL file is loaded the function will be defined as a
compiled function.  If the source file contains a form that is not of a
type known specially to the compiler, then that form (encoded in QFASL
format) will be output &quot;directly&quot; into the QFASL file, so that when the
QFASL file is loaded that form will be evaluated.  Thus, if the source
file contains <code>(setq x 3)</code>, then the compiler will put in the QFASL
file instructions to set <code>x</code> to <code>3</code> at load time (that is, when
the QFASL file is loaded into the Lisp environment).  It happens that QFASL
files have a specific way to <code>setq</code> a symbol.  For a more general form,
the QFASL file would contain instructions to recreate the list structure
of a form and then call <code>eval</code> on it.
</p>
<p>The Lisp machine editor ZWEI assumes that source files are
formatted so that an open parenthesis at the left margin (that is, in
column zero) indicates the beginning of a function definition or other top
level list (with a few standard exceptions).  The compiler assumes that you
follow this indentation convention, enabling it to tell when a
close-parenthesis is missing from one function as soon as the beginning of
the next function is reached.
</p>
<p>If the compiler finds an open parenthesis in column zero in the middle
of a list, it invents enough close parentheses to close off the list
that is in progress.  A compiler warning is produced instead of an
error.  After that list has been processed, the open parenthesis is read
again.  The compilation of list that was forcefully closed off is
probably useless, but the compilation of the rest of the file is
usually correct.  You can read the file into the editor and fix and
recompile just the function that was unbalanced.
</p>
<p>A similar thing happens on end of file in the middle of a list, so
that you get to see any warnings for the function that was unbalanced.
</p>
<p>Certain special forms including <code>eval-when</code>, <code>progn</code>,
<code>local-declare</code>, <code>declare-flavor-instance-variables</code>, and <code>comment</code>
are customarily used around lists that start in column zero.  These symbols
have a non-<code>nil</code> <code>si:may-surround-defun</code> property that makes the
compiler permit this.  You can add such properties to other symbols if you
want.
</p>
<a name="compiler_003aqc_002dfile_002dcheck_002dindentation_002dvar"></a><dl>
<dt><a name="index-compiler_003aqc_002dfile_002dcheck_002dindentation"></a>Variable: <strong>compiler:qc-file-check-indentation</strong></dt>
<dd><p>The compiler checks for open-parentheses in column zero if this variable is
non-<code>nil</code>.
</p></dd></dl>

<p>Sometimes we want to put things in the file that are not merely
meant to be translated into QFASL form.  One such occasion is top level
macro definitions; the macros must actually get defined within the
compiler in order for the compiler to be able to expand them at compile
time.  So when a macro form is seen, usually it should be evaluated at
compile time as well as put into the QFASL file.
</p>
<p>Another thing we sometimes want to put in a file is
compiler declarations.  These are forms which should be evaluated
at compile time to tell the compiler something.  They should
not be put into the QFASL file, unless they are useful for working
incrementally on the functions in the file, compiling them one by one
from the editor.
</p>
<p>Therefore, a facility exists to allow the user to tell
the compiler just what to do with a form.  One might want a form
to be:
</p><dl compact="compact">
<dt><span class="roman">Put into the QFASL file (compiled, of course), or not.</span></dt>
<dt><span class="roman">Evaluated within the compiler, or not.</span></dt>
<dt><span class="roman">Evaluated if the file is read directly into Lisp, or not.</span></dt>
</dl>

<a name="index-eval_002dwhen"></a>
<p>The <code>eval-when</code> special form is used to control this.  An
<code>eval-when</code> form looks like
</p><div class="lisp">
<pre class="lisp">(eval-when <em>times-list</em>
  <em>form1</em>
  <em>form2</em>
  ...)
</pre></div>
<p>The <em>times-list</em> may contain one or more of the symbols <code>load</code>, <code>compile</code>,
or <code>eval</code>.
If <code>load</code> is present, the <em>forms</em> are written into the QFASL file
to be evaluated when the QFASL file is loaded (except that <code>defun</code> forms
will put the compiled definition into the QFASL file instead).
If <code>compile</code> is present, the <em>forms</em> are evaluated in the compiler.
If <code>eval</code> is present, the <em>forms</em> are evaluated when read into Lisp;
this is because <code>eval-when</code> is defined as a special form in Lisp.  (The
compiler ignores <code>eval</code> in the <em>times-list</em>.)
For example,
</p><div class="lisp">
<pre class="lisp">(eval-when (compile eval) (macro foo (x) (cadr x)))
</pre></div>
<p>would define <code>foo</code> as a macro in the compiler and when the file
is read in interpreted, but not when the QFASL file is fasloaded.
</p>
<a name="eval_002dwhen_002dfun"></a><dl>
<dt><a name="index-eval_002dwhen-1"></a>Special Form: <strong>eval-when</strong> <em>(time...) body...</em></dt>
<dd><p>When seen by the interpreter, if one of the <em>times</em> is the symbol <code>eval</code>
then the <em>body</em> forms are evaluated; otherwise <code>eval-when</code> does nothing.
</p>
<p>But when seen by the compiler, this special form does the special things described above.
</p></dd></dl>

<p>For the rest of this section, we will use lists such as are
given to <code>eval-when</code>, e.g <code>(load eval)</code>, <code>(load compile)</code>, etc.,
to describe when forms are evaluated.
</p>
<p>If a form is not enclosed in an <code>eval-when</code>,
then the times at which it will be evaluated depend on the form.
The following table summarizes at what times evaluation will take
place for any given form seen at top level by the compiler.
</p><dl compact="compact">
<dt><code>(eval-when <em>times-list</em> <em>form</em> ...)</code></dt>
<dd><p><em>times-list</em> specifies when the <em>form</em>... should be performed.
</p>
</dd>
<dt><code>(declare (special ...)) <span class="roman">or</span> (declare (unspecial ...))</code></dt>
<dd><p>The <code>special</code> or <code>unspecial</code> is performed at
<code>(load compile)</code> time.
</p>
</dd>
<dt><code>(declare <em>anything-else</em>)</code></dt>
<dd><p><em>anything-else</em> is performed only at
<code>(compile)</code> time.
</p>
<a name="index-special-variable-1"></a>
</dd>
<dt><code>(special ...) <span class="roman">or</span> (unspecial ...)</code></dt>
<dd><p><code>(load compile eval)</code>
</p>
</dd>
<dt><code>(macro ...) <span class="roman">or</span> (defmacro ...) <span class="roman">or</span> (defsubst ...)</code></dt>
<dt><code><span class="roman">or</span> (defflavor ...) <span class="roman">or</span> (defstruct ...)</code></dt>
<dd><p><code>(load compile eval)</code>.  However, during file to file compilation, the
definition is kept in effect only for the one file.  It is not done &quot;for
real&quot; until the file is loaded.
</p>
</dd>
<dt><code>(comment ...)</code></dt>
<dd><p>Ignored at all times.
</p>
</dd>
<dt><code>(compiler-let ((<em>var val</em>) ...) <em>body</em>...)</code></dt>
<dd><p>Processes the <em>body</em> in its normal fashion, but
at <code>(compile eval)</code> time, the indicated
variable bindings are in effect.  These variables will typically
affect the operation of the compiler or of macros.  See <a href="#compiler_002dlet_002ddiscussion">compiler-let-discussion</a>.
</p>
</dd>
<dt><code>(local-declare (<em>decl decl ...</em>) <em>body</em>...)</code></dt>
<dd><p>Processes the <em>body</em> in its normal fashion, with the indicated
declarations added to the front of the list which is the value
of <code>local-declarations</code>.
</p>
</dd>
<dt><code>(defun ...) <span class="roman">or</span> (defmethod ...) <span class="roman">or</span> (defselect ...)</code></dt>
<dd><p><code>(load eval)</code>, but at load time what is processed is not this form
itself, but the result of compiling it.
</p>
</dd>
<dt><code><em>anything-else</em></code></dt>
<dd><p><code>(load eval)</code>
</p></dd>
</dl>

<p>Sometimes a macro wants to return more than one form
for the compiler top level to see (and to be evaluated).  The following
facility is provided for such macros.  If a form
</p><div class="lisp">
<pre class="lisp">(progn (quote compile) <em>form1</em> <em>form2</em> ...)
</pre></div>
<p>is seen at the compiler top level, all of the <em>forms</em> are processed as if they had been at
compiler top level.  (Of course, in the interpreter they
will all be evaluated, and the <code>(quote compile)</code> will harmlessly
evaluate to the symbol <code>compile</code> and be ignored.)
See <a href="#progn_002dquote_002dcompile_002ddiscussion">progn-quote-compile-discussion</a>, for additional discussion of this.
</p>
<p>To prevent an expression from being optimized by the compiler,
surround it with a call to <code>dont-optimize</code>.
</p>
<a name="dont_002doptimize_002dfun"></a><dl>
<dt><a name="index-dont_002doptimize"></a>Special Form: <strong>dont-optimize</strong> <em>form</em></dt>
<dd><p>In execution, this is equivalent to simply <em>form</em>.  However, any
source-level optimizations that the compiler would normally perform on
the top level of <em>form</em> are not done.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(dont-optimize (apply 'foo (list 'a 'b)))
</pre><pre class="lisp">actually makes a list and calls <code>apply</code>, rather than doing
</pre><pre class="lisp">(foo 'a 'b)

(dont-optimize (si:flavor-method-table flav))
</pre></div>
<p>actually calls <code>si:flavor-method-table</code> as a function, rather than
substituting the definition of that <code>defsubst</code>.
</p>
<p><code>dont-optimize</code> can even be used around a <code>defsubst</code> inside of
<code>setf</code> or <code>locf</code>, to prevent open-coding of the <code>defsubst</code>.
In this case, a function will be created at load time to do the
setting or return the location.
</p><div class="lisp">
<pre class="lisp">(setf (dont-optimize (zwei:buffer-package buffer)) 
      (pkg-find-package &quot;foo&quot;))
</pre></div>

<p>Subforms of <em>form</em>, such as arguments, are still optimized or open
coded, unless additional <code>dont-optimize</code>&rsquo;s appear around them.
</p></dd></dl>

<a name="g_t_0022Compiler-Declarations_0022"></a>
<h3 class="section">16.4 &quot;Compiler Declarations&quot;</h3>

<a name="index-declaration"></a>

<p>Declarations provide auxiliary information on how to execute a
function or expression properly, in addition to &quot;what expression to
compute&quot;.  Many declarations are relevant to techniques of compilation
and are irrelevant when a function is interpreted.  Some do not affect
execution at all and only provide information about the function, for
the sake of <code>arglist</code>, for example.
</p>
<p>Declarations may apply to an entire function or to any expression within
it.  Declarations can be made around any subexpression by writing a
<code>local-declare</code> around the subexpression.  Declarations can be made on
an entire function by writing a <code>declare</code> at the front of the
function&rsquo;s body.
</p>
<a name="local_002ddeclare_002dfun"></a><dl>
<dt><a name="index-local_002ddeclare"></a>Special Form: <strong>local-declare</strong> <em>(declaration...) body...</em></dt>
<dd><p>A <code>local-declare</code> form looks like
</p><div class="lisp">
<pre class="lisp">(local-declare (<em>decl1</em> <em>decl2</em> ...)
   <em>form1</em>
   <em>form2</em>
   ...)
</pre></div>
<p>Each <em>decl</em> is consed onto the list <code>local-declarations</code> while
the <em>forms</em> are being evaluated (in the interpreter) or compiled
(in the compiler).
</p></dd></dl>

<a name="declare_002dfun"></a><dl>
<dt><a name="index-declare"></a>Special Form: <strong>declare</strong> <em>declaration...</em></dt>
<dd><p>The special form <code>declare</code> is used for writing declarations that apply
to an entire function definition.
</p>
<p>A <em>declare</em> inside a function definition, just after the argument
list, is equivalent to putting a <code>local-declare</code> around the function
definition.  More specifically,
</p><div class="lisp">
<pre class="lisp">(defun foo (a b)
  (declare (special a b))
  (bar))
</pre></div>

<p>is equivalent to
</p><div class="lisp">
<pre class="lisp">(local-declare ((special a b))
(defun foo (a b)
  (bar)))
</pre></div>

<p>Note that
</p><div class="lisp">
<pre class="lisp">(defun foo (a b)
  (local-declare ((special a b))
    (bar)))
</pre></div>
<p>will not do the job, because the declaration is not in effect for
the binding of the arguments of <code>foo</code>.
</p>
<p><code>declare</code> is preferable to <code>local-declare</code> in this sort of
situation, because it allows the <code>defun</code>s themselves to be the
top-level lists in the file.  While <code>local-declare</code> might appear to
have an advantage in that one <code>local-declare</code> may go around several
<code>defun</code>s, it tends to cause trouble to use <code>local-declare</code> in that
fashion.
</p>
<p><code>declare</code> has a similar meaning at the front of the body of a
<code>progn</code>, <code>prog</code>, <code>let</code>, <code>prog*</code>, <code>let*</code>, or internal <code>lambda</code>.  For
example,
</p><div class="lisp">
<pre class="lisp">(prog (x)
      (declare (special x))
      ...)
</pre><pre class="lisp">is equivalent to
</pre><pre class="lisp">(local-declare ((special x))
  (prog (x)
        ...))
</pre></div>

<p>At top level in the file, <code>(declare <em>declarations</em>...)</code> is equivalent to
<code>(eval-when (compile) <em>declarations</em>...)</code>.  This use of <code>declare</code>
is nearly obsolete, and should be avoided.
</p>
<p>Elsewhere, and in the interpreter, <code>declare</code>&rsquo;s are ignored.
</p></dd></dl>

<p>Here is a list of declarations that have system-defined meanings:
</p><dl compact="compact">
<dt><code>(:special <em>var1 var2 ...</em>)</code></dt>
<dd><p>The variables <em>var1</em>, <em>var2</em>, etc. will be treated as special
variables during the compilation of the <em>forms</em>.
</p>
</dd>
<dt><code>(:unspecial <em>var1 var2 ...</em>)</code></dt>
<dd><p>The variables <em>var1</em>, <em>var2</em>, etc. will be treated as local
variables during the compilation of the <em>forms</em>.
</p>
</dd>
<dt><code>(:def <em>name</em>  . <em>definition</em>)</code></dt>
<dd><p><em>name</em> will be defined for the compiler during the compilation
of the <em>forms</em>.  The compiler uses this to keep track of macros and
open-codable functions (<code>defsubst</code>s) defined in the file being compiled.
Note that the cddr of this item is a function.
</p>
</dd>
<dt><code>(<em>propname</em> <em>symbol</em> <em>value</em>)</code></dt>
<dd><p>Within <em>forms</em>, <code>(getdecl <em>symbol</em> <em>propname</em>)</code> will return
<em>value</em>.  This is how the compiler keeps track of
<code>defdecl</code>s.
</p></dd>
</dl>

<p>These declarations are significant only when they apply to an entire <code>defun</code>
</p><dl compact="compact">
<dt><code>(:arglist . <em>arglist</em>)</code></dt>
<dd><p>Records <em>arglist</em> as the argument list of the function, to be used instead of
its <code>lambda</code>-list if anyone asks what its arguments are.  This is
purely documentation.
</p>
</dd>
<dt><code>(:values . <em>values</em>) <span class="roman">or</span> (:return-list . <em>values</em>)</code></dt>
<dd><p>Records <em>values</em> as the return values list of the function, to be used if
anyone asks what values it returns.  This is purely documentation.
</p>
</dd>
<dt><code>(si:function-parent <em>parent-function-spec</em>)</code></dt>
<dd><p>Records <em>parent-function-spec</em> as the parent of this function.
If, in the editor, you ask to see the source of this function,
and the editor doesn&rsquo;t know where it is, the editor will show you
the source code for the parent function instead.
</p>
</dd>
<dt><code>(:self-flavor <em>flavorname</em>)</code></dt>
<dd><p>Instance variables of the flavor <em>flavorname</em>, in <em>self</em>, will be
accessible in the function.
</p></dd>
</dl>

<a name="local_002ddeclarations_002dvar"></a><dl>
<dt><a name="index-local_002ddeclarations"></a>Variable: <strong>local-declarations</strong></dt>
<dd><p>The value of this variable is a list of all declarations that are
temporarily in effect.  During compilation, it pertains to the code
being compiled.
During interpretation, it pertains to the code being interpreted.
(It is not used during execution of compiled code, since all processing
of the declarations was done at compile time.)
</p>
<p>As a result, at any time a macro is expanded, the value of
<code>local-declarations</code> pertains to the code being expanded.
</p></dd></dl>

<a name="sys_003afile_002dlocal_002ddeclarations_002dvar"></a><dl>
<dt><a name="index-sys_003afile_002dlocal_002ddeclarations"></a>Variable: <strong>sys:file-local-declarations</strong></dt>
<dd><p>During file-to-file compilation,
the value of this variable is a list of all declarations that are in
effect for the rest of the file.  Macro definitions, <code>defdecl</code>s,
and special declarations that come from <code>defvar</code>s are all recorded on
this list.
</p></dd></dl>

<a name="special_002dfun"></a><dl>
<dt><a name="index-special"></a>Special Form: <strong>special</strong> <em>variable...</em></dt>
<dd><p>Declares each <em>variable</em> to be &quot;special&quot; for the compiler.
Usually it is better to use <code>defvar</code> or <code>defconst</code>.
<code>special</code> is used to make it possible to compile one file that refers
to a variable without first having to load another file that defines
the variable.
</p></dd></dl>

<a name="unspecial_002dfun"></a><dl>
<dt><a name="index-unspecial"></a>Special Form: <strong>unspecial</strong> <em>variable...</em></dt>
<dd><p>Removes any &quot;special&quot; declarations of the <em>variables</em> for the compiler.
</p></dd></dl>

<p>When symbol properties are referred to during macro expansion, it is
desirable for properties defined in a file to be &quot;in effect&quot; for the
compilation of the rest of the file.  This will not happen if
<code>get</code> and <code>defprop</code> are used, because the <code>defprop</code> will
not be executed until the file is loaded.  Instead, you can use
<code>getdecl</code> and <code>defdecl</code>.  These are normally the same as
<code>get</code> and <code>defprop</code>, but during file-to-file compilation they
also refer to and create declarations.
</p>
<a name="getdecl_002dfun"></a><dl>
<dt><a name="index-getdecl"></a>Function: <strong>getdecl</strong> <em>symbol property</em></dt>
<dd><p>This is a version of <code>get</code> that allows the properties of
the <em>symbol</em> to be overridden by declarations.
</p>
<p>If <code>local-declarations</code> or <code>sys:file-local-declarations</code> contains
a declaration of the form <code>(<em>property</em> <em>symbol</em>
<em>value</em>)</code>, <code>getdecl</code> returns <em>value</em>.  Otherwise,
<code>getdecl</code> returns the result of <code>(get <em>symbol</em>
<em>property</em>)</code>.
</p>
<p><code>getdecl</code> is typically used in macro definitions.
For example, the <code>setf</code> macro uses <code>getdecl</code> to get the
<code>setf</code> property of the function in the expression for the field
to be set.
</p></dd></dl>

<a name="putdecl_002dfun"></a><dl>
<dt><a name="index-putdecl"></a>Function: <strong>putdecl</strong> <em>symbol property value</em></dt>
<dd><p>Causes <code>(getdecl <em>symbol</em> <em>property</em>)</code> to return
<em>value</em>.
</p>
<p><code>putdecl</code> usually simply does a <code>putprop</code>.  But if executed at
compile time during file-to-file compilation, it instead makes an entry
on <code>file-local-declarations</code> of the form <code>(<em>property</em> <em>symbol</em>
<em>value</em>)</code>.
</p>
<p>In either case, this stores <em>value</em> where <code>getdecl</code> will find it;
but if <code>putdecl</code> is done during compilation, it affects only the
rest of that compilation.
</p></dd></dl>

<a name="defdecl_002dfun"></a><dl>
<dt><a name="index-defdecl"></a>Special Form: <strong>defdecl</strong> <em>symbol property value</em></dt>
<dd><p>When executed, this is like <code>putdecl</code> except that the arguments
are not evaluated.  It is usually the same as <code>defprop</code>
except for the order of the arguments.
</p>
<p>Unlike <code>defprop</code>, when <code>defdecl</code> is encountered during file-to-file
compilation, it is executed, creating a declaration which remains in
effect for the rest of the compilation.  (The <code>defdecl</code> form also goes
into the QFASL file to be executed when the file is loaded).
<code>defprop</code> would have no effect whatever at compile time.
</p>
<p><code>defdecl</code> is often useful as a part of the expansion of a macro.
It is also useful as a top-level expression in a source file.
</p>
<div class="lisp">
<pre class="lisp">(defdecl foo setf ((foo x) . (set-foo x si:value)))
</pre></div>
<p>in a source file would allow <code>(setf (foo <em>arg</em>) <em>value</em>)</code>
to be used in functions in that source file; and, once the file was
loaded, by anyone.
</p></dd></dl>

<p>The next three functions are primarily for Maclisp compatibility.  In
Maclisp, they are declarations, used within a <code>declare</code> at top level
in the file.
</p>
<a name="g_t_002aexpr_002dfun"></a><dl>
<dt><a name="index-_002aexpr"></a>Special Form: <strong>*expr</strong> <em>symbol...</em></dt>
<dd><p>Declares each <em>symbol</em>
to be the name of a function.  In addition it prevents these functions from appearing
in the list of functions referenced but not defined, printed at the end of the compilation.
</p></dd></dl>

<a name="g_t_002alexpr_002dfun"></a><dl>
<dt><a name="index-_002alexpr"></a>Special Form: <strong>*lexpr</strong> <em>symbol...</em></dt>
<dd><p>Declares each <em>symbol</em>
to be the name of a function.  In addition it prevents these functions from appearing
in the list of functions referenced but not defined, printed at the end of the compilation.
</p></dd></dl>

<a name="g_t_002afexpr_002dfun"></a><dl>
<dt><a name="index-_002afexpr"></a>Special Form: <strong>*fexpr</strong> <em>symbol...</em></dt>
<dd><p>Declares each <em>symbol</em>
to be the name of a special form.  In addition it prevents these names from appearing
in the list of functions referenced but not defined, printed at the end of the compilation.
</p></dd></dl>

<p>There are some advertised variables whose compile-time values affect
the operation of the compiler.  The user may set these variables by
including in his file forms such as
</p><div class="lisp">
<pre class="lisp">(declare (setq open-code-map-switch t))
</pre></div>
<p>However, these variables seem not to be needed very often.
</p>
<a name="run_002din_002dmaclisp_002dswitch_002dvar"></a><dl>
<dt><a name="index-run_002din_002dmaclisp_002dswitch"></a>Variable: <strong>run-in-maclisp-switch</strong></dt>
<dd><p>If this variable is non-<code>nil</code>, the compiler will try to warn the
user about any constructs that will not work in Maclisp.  By no means
will all Lisp Machine system functions not built in to Maclisp be
cause for warnings;  only those that could not be written by the user
in Maclisp (for example, <code>make-array</code>, <code>value-cell-location</code>, etc.).
Also, lambda-list keywords such as
<code>&amp;optional</code> and initialized <code>prog</code> variables will be
mentioned.  This switch also inhibits the warnings for obsolete Maclisp functions.
The default value of this variable is <code>nil</code>.
</p></dd></dl>

<a name="obsolete_002dfunction_002dwarning_002dswitch_002dvar"></a><dl>
<dt><a name="index-obsolete_002dfunction_002dwarning_002dswitch"></a>Variable: <strong>obsolete-function-warning-switch</strong></dt>
<dd><p>If this variable is non-<code>nil</code>, the compiler will try to warn
the user whenever an &quot;obsolete&quot; Maclisp-compatibility function such as
<code>maknam</code> or <code>samepnamep</code> is used.  The default value is <code>t</code>.
</p></dd></dl>

<a name="allow_002dvariables_002din_002dfunction_002dposition_002dswitch_002dvar"></a><dl>
<dt><a name="index-allow_002dvariables_002din_002dfunction_002dposition_002dswitch"></a>Variable: <strong>allow-variables-in-function-position-switch</strong></dt>
<dd><p>If this variable is non-<code>nil</code>, the compiler allows the use of
the name of a variable in function position to mean that the
variable&rsquo;s value should be <code>funcall</code>&rsquo;d.  This is for compatibility
with old Maclisp programs.  The default value of this variable is
<code>nil</code>.
</p></dd></dl>

<a name="open_002dcode_002dmap_002dswitch_002dvar"></a><dl>
<dt><a name="index-open_002dcode_002dmap_002dswitch"></a>Variable: <strong>open-code-map-switch</strong></dt>
<dd><p>If this variable is non-<code>nil</code>, the compiler will attempt
to produce inline code for the mapping functions (<code>mapc</code>, <code>mapcar</code>, etc.,
but not <code>mapatoms</code>) if the function being mapped is an anonymous
lambda-expression.  This allows that function to reference
the local variables of the enclosing function without the need for special
declarations.
The generated code is also more efficient.  The default value is <code>t</code>.
</p></dd></dl>

<a name="all_002dspecial_002dswitch_002dvar"></a><dl>
<dt><a name="index-all_002dspecial_002dswitch"></a>Variable: <strong>all-special-switch</strong></dt>
<dd><p>If this variable is non-<code>nil</code>, the compiler regards all variables
as special, regardless of how they were declared.  This provides
compatibility with the interpreter at the cost of efficiency.
The default is <code>nil</code>.
</p></dd></dl>

<a name="inhibit_002dstyle_002dwarnings_002dswitch_002dvar"></a><dl>
<dt><a name="index-inhibit_002dstyle_002dwarnings_002dswitch"></a>Variable: <strong>inhibit-style-warnings-switch</strong></dt>
<dd><p>If this variable is non-<code>nil</code>, all compiler style-checking is
turned off.  Style checking is used to issue obsolete function
warnings, won&rsquo;t-run-in-Maclisp warnings, and other sorts of
warnings.  The default value is <code>nil</code>.  See also the
<code>inhibit-style-warnings</code> macro, which acts on one level only of an
expression.
</p></dd></dl>

<a name="compiler_002dlet_002dfun"></a><dl>
<dt><a name="index-compiler_002dlet"></a>Macro: <strong>compiler-let</strong> <em>((variable value)...) body...</em></dt>
<dd><p>Syntactically identical to <code>let</code>, <code>compiler-let</code> allows
compiler switches to be bound locally at compile time, during the
processing of the <em>body</em> forms.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(compiler-let ((open-code-map-switch nil))
          (map (function (lambda (x) ...)) foo))
</pre></div>
<p>will prevent the compiler from open-coding the <code>map</code>.
When interpreted, <code>compiler-let</code> is equivalent to <code>let</code>.  This
is so that global switches which affect the behavior of macro
expanders can be bound locally.
</p></dd></dl>

<a name="Using-Compiler-Warnings"></a>
<h3 class="section">16.5 Using Compiler Warnings</h3>
<a name="index-warnings-from-the-compiler"></a>
<a name="index-compiler-warnings"></a>

<p>When the compiler prints warnings, it also records them in a data base,
organized by file and by function within file.  Old warnings for
previous compilations of the same function are thrown away, so the data
base contains only warnings that are still applicable.  This data base
can be
used to visit, in the editor, the functions that got warnings.  You can
also save the data base and restore it later.
</p>
<p>There are three editor commands that you can use to begin visiting the
sites of the recorded warnings.  They differ only in how they decide
which files to look through:
</p>
<dl compact="compact">
<dt><code>Meta-X Edit Warnings</code></dt>
<dd><p>For each file that has any warnings, asks whether to edit the warnings
for that file.
</p>
</dd>
<dt><code>Meta-X Edit File Warnings</code></dt>
<dd><p>Reads the name of a file and then edits the warnings for that file.
</p>
</dd>
<dt><code>Meta-X Edit System Warnings</code></dt>
<dd><p>Reads the name of a system and then 
edits the warnings for all files in that system (see <code>defsystem</code>,
<a href="#defsystem_002dfun">defsystem-fun</a>).
</p></dd>
</dl>

<p>While the warnings are being edited, the warnings themselves appear in a
small window at the top of the editor frame, and the code appears in a
large window which occupies the rest of the editor frame.
</p>
<p>As soon as you have finished specifying the file(s) or system to
process, the editor will proceed to visit the code for the first
warning.  From then on, to move to the next warning, use the command
<code>Control-Shift-W</code>.  To move to the previous warning, use
<code>Meta-Shift-W</code>.  You can also switch to the warnings window with
<code>Control-X O</code> or with the mouse, and move around in that buffer.
When you use <code>Control-Shift-W</code> and there are no more warnings after
the cursor, you return to single-window mode.
</p>
<p>You can also insert the text of the warnings into any editor buffer:
</p><dl compact="compact">
<dt><code>Meta-X Insert File Warnings</code></dt>
<dd><p>Reads the name of a file and inserts into the buffer after point the
text for that file&rsquo;s warnings.  The mark is left after the warnings, but
the region is not turned on.
</p>
</dd>
<dt><code>Meta-X Insert Warnings</code></dt>
<dd><p>Inserts into the buffer after point the text for the warnings of all
files that have warnings.  The mark is left after the warnings, but the
region is not turned on.
</p></dd>
</dl>

<p>You can also dump the warnings data base into a file and
reload it
later.  Then you can do <code>Meta-X Edit Warnings</code> again in the later
session.  You dump the warnings with <code>si:dump-warnings</code> and load the
file again with <code>load</code>.  In addition, <code>make-system</code> with the
<code>:batch</code> option writes all the warnings into a file in this way.
</p>
<a name="si_003adump_002dwarnings_002dfun"></a><dl>
<dt><a name="index-si_003adump_002dwarnings"></a>Function: <strong>si:dump-warnings</strong> <em>output-file-pathname &amp;rest warnings-file-pathnames</em></dt>
<dd><p>Writes the warnings for the files named in <em>warnings-file-pathnames</em>
(a list of pathnames or strings) into a file named
<em>output-file-pathname</em>.
</p></dd></dl>

<a name="compiler_003awarn_002don_002derrors_002dvar"></a><dl>
<dt><a name="index-compiler_003awarn_002don_002derrors"></a>Variable: <strong>compiler:warn-on-errors</strong></dt>
<dd><p>If this variable is non-<code>nil</code>, errors in reading code to be compiled,
and errors in macro expansion within the compiler, produce only
warnings; they do not enter the debugger.  The variable is normally
<code>t</code>.
</p>
<p>The default setting is useful when you do not anticipate errors during
compilation, because it allows the compilation to proceed past such
errors.  If you have walked away from the machine, you do not come back
to find that your compilation stopped in the first file and did not
finish.
</p>
<p>If you find an inexplicable error in reading or macroexpansion, and wish
to use the debugger to localize it, set <code>compiler:warn-on-errors</code>
to <code>nil</code> and recompile.
</p></dd></dl>

<a name="Controlling-Compiler-Warnings"></a>
<h4 class="subsection">16.5.1 Controlling Compiler Warnings</h4>

<p>By controlling the compile-time values of the variables <code>run-in-maclisp-switch</code>,
<code>obsolete-function-warning-switch</code>, and <code>inhibit-style-warning-switch</code> (explained
above), you can enable or disable some of the warning messages of the compiler.
The following special form is also useful:
</p>
<a name="inhibit_002dstyle_002dwarnings_002dfun"></a><dl>
<dt><a name="index-inhibit_002dstyle_002dwarnings"></a>Macro: <strong>inhibit-style-warnings</strong> <em>form</em></dt>
<dd><p>Prevents the compiler from performing style-checking on the top level
of <em>form</em>.  Style-checking will still be done on the arguments of <em>form</em>.
Both obsolete function warnings and won&rsquo;t-run-in-Maclisp warnings are
done by means of the style-checking mechanism, so, for example,
</p><div class="lisp">
<pre class="lisp">(setq bar (inhibit-style-warnings (value-cell-location foo)))
</pre></div>
<p>will not warn that <code>value-cell-location</code> will not work in Maclisp,
but
</p><div class="lisp">
<pre class="lisp">(inhibit-style-warnings (setq bar (value-cell-location foo)))
</pre></div>
<p>will warn, since <code>inhibit-style-warnings</code> applies only to the top
level of the form inside it (in this case, to the <code>setq</code>).
</p></dd></dl>

<p>Sometimes functions take argument that they deliberately do not use.
Normally the compiler warns you if your program binds a variable that it
never references.  In order to disable this warning for variables that
you know you are not going to use, there are two things you can do.  The
first thing is to name the variables <code>ignore</code> or <code>ignored</code>.  The
compiler will not complain if a variable by one of these names is not
used.  Furthermore, by special dispensation, it is all right to have
more than one variable in a lambda-list that has one of these names.
The other thing you can do is simply use the variable for effect
(ignoring its value) at the front of the function.  Example:
</p><div class="lisp">
<pre class="lisp">(defun the-function (list fraz-name fraz-size)
  fraz-size       ; This argument is not used.
  ...)
</pre></div>
<p>This has the advantage that <code>arglist</code> (see <a href="#arglist_002dfun">arglist-fun</a>) will return
a more meaningful argument list for the function, rather than returning
something with <code>ignore</code>s in it.
<a name="index-ignore-1"></a>
<a name="index-ignored-arguments"></a>
</p>
<p>The following function is useful for requesting compiler warnings in
certain esoteric cases.  Normally, the compiler notices whenever any
function <em>x</em> uses (calls) any other function <em>y</em>; it makes notes of
all these uses, and then warns you at the end of the compilation if the
function <em>y</em> got called but was neither defined nor declared (by
<code>*expr</code>, see <a href="#g_t_002aexpr_002dfun">*expr-fun</a>).  This usually does what you want, but
sometimes there is no way the compiler can tell that a certain function is being
used.  Suppose that instead of <em>x</em>&rsquo;s containing any forms that call
<em>y</em>, <em>x</em> simply stores <em>y</em> away in a data structure somewhere, and
someplace else in the program that data structure is accessed and
<code>funcall</code> is done on it.  There is no way that the compiler can see
that this is going to happen, and so it can&rsquo;t notice the function usage,
and so it can&rsquo;t create a warning message.  In order to make such
warnings happen, you can explicitly call the following function at
compile-time.
</p>
<a name="compiler_003afunction_002dreferenced_002dfun"></a><dl>
<dt><a name="index-compiler_003afunction_002dreferenced"></a>Function: <strong>compiler:function-referenced</strong> <em>what by</em></dt>
<dd><p><em>what</em> is a symbol that is being used as a function.  <em>by</em> may be any function spec.  
<code>compiler:function-referenced</code> must be
called at compile-time while a compilation is in progress.  It tells the
compiler that the function <em>what</em> is referenced by <em>by</em>.  When the compilation
is finished, if the function <em>what</em> has not been defined, the compiler will
issue a warning to the effect that <em>by</em> referred to the function <em>what</em>,
which was never defined.
</p></dd></dl>

<p>You can also tell the compiler about any function it should consider
&quot;defined&quot;:
</p>
<a name="compiler_003acompilation_002ddefine_002dfun"></a><dl>
<dt><a name="index-compiler_003acompilation_002ddefine"></a>Function: <strong>compiler:compilation-define</strong> <em>function-spec</em></dt>
<dd><p><em>function-spec</em> is marked as &quot;defined&quot; for the sake of the compiler;
calls to this function will not produce warnings.
</p></dd></dl>

<a name="compiler_003amake_002dobsolete_002dfun"></a><dl>
<dt><a name="index-compiler_003amake_002dobsolete"></a>Special Form: <strong>compiler:make-obsolete</strong> <em>function reason</em></dt>
<dd><p>This special form declares a function to be obsolete; code that calls it
will get a compiler warning, under the control of <code>obsolete-function-warning-switch</code>.
This is used by the compiler to mark as obsolete some Maclisp functions which exist in
Zetalisp but should not be used in new programs.  It can also
be useful when maintaining a large system, as a reminder that a function has
become obsolete and usage of it should be phased out.  An example of an
obsolete-function declaration is:
</p><div class="lisp">
<pre class="lisp">(compiler:make-obsolete create-mumblefrotz
	&quot;use MUMBLIFY with the :FROTZ option instead&quot;)
</pre></div>
</dd></dl>

<a name="Recording-Warnings"></a>
<h4 class="subsection">16.5.2 Recording Warnings</h4>

<p>The warnings data base is not just for compilation.  It can record
operations for any number of different operations on files or parts of
files.  Compilation is merely the only operation in the system that uses it.
</p>
<p>Each operation about which warnings can be recorded should have a name,
preferably in the keyword package.  This symbol should have four
properties that tell the system how to print out the operation name
as various parts of speech.  For compilation, the operation name is
<code>:compile</code> and the properties are defined as follows:
</p>
<div class="lisp">
<pre class="lisp">(defprop :compile &quot;compilation&quot; name-as-action)
(defprop :compile &quot;compiling&quot; name-as-present-participle)
(defprop :compile &quot;compiled&quot; name-as-past-participle)
(defprop :compile &quot;compiler&quot; name-as-agent)
</pre></div>

<p>The warnings system considers that these operations are normally
performed on files that are composed of named objects.  Each warning is
associated with a filename and then with an object within the file.
It is also possible to record warnings about objects that are not within
any file.
</p>
<p>To tell the warnings system that you are starting to process all or part
of a file, use the macro <code>si:file-operation-with-warnings</code>.
</p>
<a name="sys_003afile_002doperation_002dwith_002dwarnings_002dfun"></a><dl>
<dt><a name="index-sys_003afile_002doperation_002dwith_002dwarnings"></a>Special Form: <strong>sys:file-operation-with-warnings</strong> <em>(generic-pathname operation-name whole-file-p) body...</em></dt>
<dd><p><em>body</em> is executed within a context set up so that warnings can be
recorded for operation <em>operation-name</em> about the file specified by
<em>generic-pathname</em> (see <a href="#fs_003apathname_002dgeneric_002dpathname_002dmethod">fs:pathname-generic-pathname-method</a>).
</p>
<p>In the case of compilation, this is done at the level of <code>qc-file</code>
(actually, it is done in <code>compiler:compile-stream</code>).
</p>
<p><em>whole-file-p</em> should be non-<code>nil</code> if the entire contents of the
file will be processed inside the <em>body</em> if it finishes; this implies
that any warnings left over from previous iterations of this operation
on this file should be thrown away on exit.  This is only relevant to
objects that are not found in the file this time; the assumption is that
the objects must have been deleted from the file and their warnings are
no longer appropriate.
</p>
<p>All three of the special arguments are specified as expressions that
are evaluated.
</p></dd></dl>

<p>Within the processing of a file, you must also announce when you are
beginning to process an object:
</p>
<a name="sys_003aobject_002doperation_002dwith_002dwarnings_002dfun"></a><dl>
<dt><a name="index-sys_003aobject_002doperation_002dwith_002dwarnings"></a>Special Form: <strong>sys:object-operation-with-warnings</strong> <em>(object-name location-function) body...</em></dt>
<dd><p><em>body</em> is execute in a context set up so that warnings are recorded
for the object named <em>object-name</em>, which can be a symbol or a list.
Object names are compared with <code>equal</code>.
</p>
<p>In the case of compilation, this macro goes around the processing of a
single function.
</p>
<p><em>location-function</em> is either <code>nil</code> or a function that the editor
uses to find the text of the object.  Refer to the file <code>SYS: ZWEI; POSS
LISP</code> for more details on this.
</p>
<p><em>object-name</em> and <em>location-function</em> are specified with expressions
that are evaluated.
</p>
<p>You can enter this macro recursively.  If the inner invocation is for
the same object as the outer one, it has no effect.  Otherwise, warnings
recorded in the inner invocation apply to the object specified therein.
</p></dd></dl>

<p>Finally, when you detect exceptions, you must make the actual warnings:
</p>
<a name="sys_003arecord_002dwarning_002dfun"></a><dl>
<dt><a name="index-sys_003arecord_002dwarning"></a>Function: <strong>sys:record-warning</strong> <em>type severity location-info format-string &amp;rest args</em></dt>
<dd><p>Records one warning for the object and file currently being processed.
The text of the warning is specified by <em>format-string</em>and <em>args</em>,
which are suitable arguments for <code>format</code>, but the warning is <em>not</em>
printed when you call this function.  Those arguments will be used to
reprint the warning later.
</p></dd></dl>


<a name="sys_003arecord_002dand_002dprint_002dwarning_002dfun"></a><dl>
<dt><a name="index-sys_003arecord_002dand_002dprint_002dwarning"></a>Function: <strong>sys:record-and-print-warning</strong> <em>type severity location-info format-string &amp;rest args</em></dt>
<dd><p>Records a warning and also prints it.
</p>
<p><em>type</em> is a symbol that identifies the specific cause of the warning.
Types have meaning only as defined by a particular operation, and at
present nothing makes much use of them.  The system defines one type:
<code>si:premature-warnings-marker</code>.
</p>
<p><em>severity</em> measures how important a warning this is, and the general
causal classification.  It should be a symbol in the keyword package.
Several severities are defined, and should be used when appropriate,
but nothing looks at them:
</p><dl compact="compact">
<dt><code>:implausible</code></dt>
<dd><p>This warning is about something that is not intrinsically wrong but is
probably due to a mistake of some sort.
</p>
</dd>
<dt><code>:impossible</code></dt>
<dd><p>This warning is about something that cannot have a meaning
even if circumstances outside the text being processed are
changed.
</p>
</dd>
<dt><code>:probable-error</code></dt>
<dd><p>This is used to indicate something that is certainly an error
but can be made correct by a change somewhere else; for example, calling
a function with the wrong number of arguments.
</p>
</dd>
<dt><code>:missing-declaration</code></dt>
<dd><p>This is used for warnings about free variables not declared special,
and such.  It means that the text was not actually incorrect, but
something else that is supposed to accompany it was missing.
</p>
</dd>
<dt><code>:obsolete</code></dt>
<dd><p>This warning is about something that you shouldn&rsquo;t use any more,
but which still does work.
</p>
</dd>
<dt><code>:very-obsolete</code></dt>
<dd><p>This is about something that doesn&rsquo;t even work any more.
</p>
</dd>
<dt><code>:maclisp</code></dt>
<dd><p>This is for something that doesn&rsquo;t work in Maclisp.
</p>
</dd>
<dt><code>:fatal</code></dt>
<dd><p>This indicates a problem so severe that no sense can be made of the
object at all.  It indicates that the presence or absence of other
warnings is not significant.
</p>
</dd>
<dt><code>:error</code></dt>
<dd><p>There was a Lisp error in processing the object.
</p></dd>
</dl>

<p><em>location-info</em> is intended to be used to inform the editor of the
precise location in the text of the cause of this warning.  It is not
defined as yet, and you should use <code>nil</code>.
</p></dd></dl>

<p>If a warning is encountered while processing data that doesn&rsquo;t really
have a name (such as forms in a source file that are not function
definitions), you can record a warning even though you are not inside
an invocation of <code>sys:object-operation-with-warnings</code>.  This
warning is known as a <em>premature warning</em> and it will be recorded with
the next object that is processed; a message will be added so that the
user can tell which warnings were premature.
</p>
<p>Refer to the file <code>SYS: SYS; QNEW LISP</code> for more information on the
warnings data base.
</p>
<a name="g_t_0022Compiler-Source_002dLevel-Optimizers_0022"></a>
<h3 class="section">16.6 &quot;Compiler Source-Level Optimizers&quot;</h3>
<a name="index-optimizer_002c-compiler"></a>

<p>The compiler stores optimizers for source code on property lists so as
to make it easy for the user to add them.  An optimizer can be used to
transform code into an equivalent but more efficient form (for
example, <code>(eq <em>obj</em> nil)</code> is transformed into <code>(null <em>obj</em>)</code>,
which can be compiled better).  An optimizer can also be used to
tell the compiler how to compile a special form.  For example,
in the interpreter <code>do</code> is a special form, implemented by a function
which takes quoted arguments and calls <code>eval</code>.  In the compiler,
<code>do</code> is expanded in a macro-like way by an optimizer into
equivalent Lisp code using <code>prog</code>, <code>cond</code>, and <code>go</code>, which
the compiler understands.
</p>
<p>The compiler finds the optimizers to apply to a form by looking for
the <code>compiler:optimizers</code> property of the symbol that is the
car of the form.  The value of this property should be a list of
optimizers, each of which must be a function of one argument.  The
compiler tries each optimizer in turn, passing the form to be
optimized as the argument.  An optimizer that returns the original
form unchanged (<code>eq</code> to the argument) has &quot;done nothing&quot;, and
the next optimizer is tried.  If the optimizer returns anything else,
it has &quot;done something&quot;, and the whole process starts over again.
Only after all the optimizers
have been tried and have done nothing is an ordinary macro definition
processed.  This is so that the macro definitions, which will be seen
by the interpreter, can be overridden for the compiler by optimizers.
</p>
<p>Optimizers should not be used to define new language features, because
they only take effect in the compiler; the interpreter (that is, the
evaluator) doesn&rsquo;t know about optimizers.  So an optimizer should not
change the effect of a form; it should produce another form that does
the same thing, possibly faster or with less memory or something.  That
is why they are called optimizers.  If you want to actually change
the form to do something else, you should be using macros.
</p>
<a name="compiler_003aadd_002doptimizer_002dfun"></a><dl>
<dt><a name="index-compiler_003aadd_002doptimizer"></a>Special Form: <strong>compiler:add-optimizer</strong> <em>function optimizer optimized-into...</em></dt>
<dd><p>Puts <em>optimizer</em> on <em>function</em>&rsquo;s optimizers list if it isn&rsquo;t there already.
<em>optimizer</em> is the name of an optimization function, and <em>function</em>
is the name of the function calls which are to be processed.  Neither
is evaluated.
</p>
<p><code>(compiler:add-optimizer <em>function</em> <em>optimizer</em> <em>optimize-into-1</em>
<em>optimize-into-2...</em>)</code> also remembers <em>optimize-into-1</em>, etc., as
names of functions which may be called in place of <em>function</em> as a
result of the optimization.  Then <code>who-calls</code> of <em>function</em> will
also mention calles of <em>optimize-into-1</em>, etc.
</p></dd></dl>


<a name="g_t_0022Files-that-Maclisp-Must-Compile_0022"></a>
<h3 class="section">16.7 &quot;Files that Maclisp Must Compile&quot;</h3>

<p>Certain programs are intended to be run both in Maclisp and in
Zetalisp.  Their source files need some special conventions.  For
example, all <code>special</code> declarations must be enclosed in <code>declare</code>s,
so that the Maclisp compiler will see them.  The main issue is that many
functions and special forms of Zetalisp do not exist in
Maclisp.  It is suggested that you turn on <code>run-in-maclisp-switch</code> in
such files, which will warn you about a lot of problems that your program
may have if you try to run it in Maclisp.
</p>
<p>The macro-character combination <code>#Q</code> causes the object that follows it
to be visible only when compiling for Zetalisp.  The combination <code>#M</code>
causes the following object to be visible only when compiling for
Maclisp.  These work both on subexpressions of the objects in the file
and at top level in the file.  To conditionalize top-level objects,
however, it is better to put the macros <code>if-for-lispm</code> and
<code>if-for-maclisp</code> around them.  The <code>if-for-lispm</code> macro turns off
<code>run-in-maclisp-switch</code> within its object, preventing spurious
warnings from the compiler.  The <code>#Q</code> macro-character cannot do this,
since it can be used to conditionalize any S-expression, not just a
top-level form.
</p>
<p>To allow a file to detect what environment it is being compiled in,
the following macros are provided:
</p>
<a name="if_002dfor_002dlispm_002dfun"></a><dl>
<dt><a name="index-if_002dfor_002dlispm"></a>Macro: <strong>if-for-lispm</strong> <em>form</em></dt>
<dd><p>If <code>(if-for-lispm <em>form</em>)</code> is seen at the top level of
the compiler, <em>form</em> is passed to the compiler top level if
the output of the compiler is a QFASL file intended for Zetalisp.
If the Zetalisp interpreter sees this it will evaluate <em>form</em>
(the macro expands into <em>form</em>).
</p></dd></dl>

<a name="if_002dfor_002dmaclisp_002dfun"></a><dl>
<dt><a name="index-if_002dfor_002dmaclisp"></a>Macro: <strong>if-for-maclisp</strong> <em>form</em></dt>
<dd><p>If <code>(if-for-maclisp <em>form</em>)</code> is seen at the top level of
the compiler, <em>form</em> is passed to the compiler top level if
the output of the compiler is a FASL file intended for Maclisp
(e.g if the compiler is COMPLR).
If the Zetalisp interpreter sees this it will ignore it
(the macro expands into <code>nil</code>).
</p></dd></dl>

<a name="if_002dfor_002dmaclisp_002delse_002dlispm_002dfun"></a><dl>
<dt><a name="index-if_002dfor_002dmaclisp_002delse_002dlispm"></a>Macro: <strong>if-for-maclisp-else-lispm</strong> <em>maclisp-form lispm-form</em></dt>
<dd><p>If <code>(if-for-maclisp-else-lispm <em>form1</em> <em>form2</em>)</code> is seen at the top level of
the compiler, <em>form1</em> is passed to the compiler top level if
the output of the compiler is a FASL file intended for Maclisp;
otherwise <em>form2</em> is passed to the compiler top level.
</p></dd></dl>

<a name="if_002din_002dlispm_002dfun"></a><dl>
<dt><a name="index-if_002din_002dlispm"></a>Macro: <strong>if-in-lispm</strong> <em>form</em></dt>
<dd><p>In Zetalisp, <code>(if-in-lispm <em>form</em>)</code> causes <em>form</em>
to be evaluated; in Maclisp, <em>form</em> is ignored.
</p></dd></dl>

<a name="if_002din_002dmaclisp_002dfun"></a><dl>
<dt><a name="index-if_002din_002dmaclisp"></a>Macro: <strong>if-in-maclisp</strong> <em>form</em></dt>
<dd><p>In Maclisp, <code>(if-in-maclisp <em>form</em>)</code> causes <em>form</em>
to be evaluated; in Zetalisp, <em>form</em> is ignored.
</p></dd></dl>

<p>In order to make sure that those macros are
defined when reading the file into the Maclisp compiler, you must
make the file start with a prelude, which should look like:
</p><div class="lisp">
<pre class="lisp">(declare (cond ((not (status feature lispm))
                (load '|AI: LISPM2; CONDIT|))))
		;; Or other suitable filename
</pre></div>
<p>This will do nothing when you compile the program on the Lisp Machine.
If you compile it with the Maclisp compiler, it will load in definitions
of the above macros, so that they will be available to your
program.  The form <code>(status feature lispm)</code> is generally useful in
other ways; it evaluates to <code>t</code> when evaluated on the Lisp machine and
to <code>nil</code> when evaluated in Maclisp.
</p>
<a name="Putting-Data-in-QFASL-Files"></a>
<h3 class="section">16.8 Putting Data in QFASL Files</h3>
<a name="index-fasdump"></a>
<a name="fasdump"></a>
<p>It is possible to make a QFASL file containing data, rather than a
compiled program.  This can be useful to speed up loading of a data
structure into the machine, as compared with reading in printed
representations.  Also, certain data structures such as arrays do not
have a convenient printed representation as text, but can be saved in
QFASL files.  For example, the system stores fonts this way.  Each
font is in a QFASL file (on the <code>SYS: FONTS;</code> directory) that
contains the data structures for that font.  When the file is loaded,
the symbol that is the name of the font gets set to the array that
represents the font.  Putting data into a QFASL file is often
referred to as &quot;<em>fasdumping</em> the data&quot;.
</p>
<p>In compiled programs, the constants are saved in the QFASL file in this way.
The compiler optimizes by making constants that are <code>equal</code> become <code>eq</code>
when the file is loaded.  This does not happen when you make a data file yourself;
identity of objects is preserved.  Note that when a QFASL file is loaded,
objects that were <code>eq</code> when the file was written are still <code>eq</code>; this does not
normally happen with text files.
</p>
<p>The following types of objects can be represented in QFASL files:  Symbols (but
uninterned symbols will be interned when the file is loaded),  numbers of all kinds,
lists,  strings,  arrays of all kinds,  instances, and FEFs.
</p>
<p>When an instance is fasdumped (put into a QFASL file), it is sent a <code>:fasd-form</code>
message, which must return a Lisp form that, when evaluated, will recreate the
equivalent of that instance.  This is because instances are often part of a large
data structure, and simply fasdumping all of the instance variables and making
a new instance with those same values is unlikely to work.  Instances remain
<code>eq</code>; the <code>:fasd-form</code> message is only sent the first time a particular instance
is encountered during writing of a QFASL file.  If the instance does
not accept the <code>:fasd-form</code> message, it cannot be fasdumped.
</p>
<a name="dump_002dforms_002dto_002dfile_002dfun"></a><dl>
<dt><a name="index-dump_002dforms_002dto_002dfile"></a>Function: <strong>dump-forms-to-file</strong> <em>filename forms-list &amp;optional attribute-list</em></dt>
<dd><p>Writes a QFASL file named <em>filename</em> which contains, in effect, the
forms in <em>forms-list</em>.  That is to say, when the file is loaded, its
effect will be the same as evaluating those forms.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(dump-forms-to-file &quot;foo&quot; '((setq x 1) (setq y 2)))
(load &quot;foo&quot;)
x =&gt; 1
y =&gt; 2
</pre></div>

<p><em>attribute-list</em> is the file attribute list to store in the QFASL
file.  It is a list of
alternating keywords and values, and corresponds to the <code>-*-</code> line of a source file.
The most useful keyword in this context is <code>:package</code>, whose value in the
attribute list specifies the package to be used both in dumping the forms and in
loading the file.  If no <code>:package</code> keyword is present, the file will be loaded in
whatever package is current at the time.
</p></dd></dl>

<a name="compiler_003afasd_002dsymbol_002dvalue_002dfun"></a><dl>
<dt><a name="index-compiler_003afasd_002dsymbol_002dvalue"></a>Function: <strong>compiler:fasd-symbol-value</strong> <em>filename symbol</em></dt>
<dd><p>Writes a QFASL file named <em>filename</em> which contains the value of <em>symbol</em>.
When the file is loaded, <em>symbol</em> will be <code>setq</code>&rsquo;ed to the same value.
<em>filename</em> is parsed with the same defaults that <code>load</code> and <code>qc-file</code> use.
The file type defaults to <code>&quot;QFASL&quot;</code>.
</p></dd></dl>

<a name="compiler_003afasd_002dfont_002dfun"></a><dl>
<dt><a name="index-compiler_003afasd_002dfont"></a>Function: <strong>compiler:fasd-font</strong> <em>name</em></dt>
<dd><p>Writes the font named <em>name</em> into a QFASL file with the appropriate name
(on the <code>SYS: FONTS;</code> directory).
</p></dd></dl>

<a name="compiler_003afasd_002dfile_002dsymbols_002dproperties_002dfun"></a><dl>
<dt><a name="index-compiler_003afasd_002dfile_002dsymbols_002dproperties"></a>Function: <strong>compiler:fasd-file-symbols-properties</strong> <em>filename symbols properties dump-values-p dump-functions-p new-symbol-function</em></dt>
<dd><p>This is a way to dump a complex data structure into a QFASL file.  The values,
the function definitions, and some of the properties of certain symbols are put into
the QFASL file in such a way that when the file is loaded the symbols will
be <code>setq</code>ed, <code>fdefine</code>d, and <code>putprop</code>ped appropriately.  The user can
control what happens to symbols discovered in the data structures being fasdumped.
</p>
<p><em>filename</em> is the name of the file to be written.  It is parsed with
the same defaults that <code>load</code> and <code>qc-file</code> use.  The file type
defaults to <code>&quot;QFASL&quot;</code>.
</p>
<p><em>symbols</em> is a list of symbols to be processed.  <em>properties</em> is a list
of properties which are to be fasdumped if they are found on the symbols.
<em>dump-values-p</em> and <em>dump-functions-p</em> control whether the values and
function definitions are also dumped.
</p>
<p><em>new-symbol-function</em> is called whenever a new symbol is found in the
structure being dumped.  It can do nothing, or it can add the symbol to the
list to be processed by calling <code>compiler:fasd-symbol-push</code>.  The value
returned by <em>new-symbol-function</em> is ignored.
</p></dd></dl>

<a name="Analyzing-QFASL-Files"></a>
<h3 class="section">16.9 Analyzing QFASL Files</h3>

<p>QFASL files are composed of 16-bit nibbles.  The first two nibbles in
the file contain fixed values, which are there so the system can tell a
proper QFASL file.  The next nibble is the beginning of the first
<em>group</em>.  A group starts with a nibble that specifies an operation.
It may be followed by other nibbles that are arguments.
</p>
<p>Most of the groups in a QFASL file are there to construct objects when
the file is loaded.  These objects are recorded in the <em>fasl-table</em>.
Each time an object is constructed, it is assigned the next sequential
index in the fasl-table.  The indices are used by other groups later in
the file, to refer back to objects already constructed.
</p>
<p>To prevent the fasl-table from becoming too large, the QFASL file
can be divided into <em>whacks</em>.  The fasl table is cleared out at the
beginning of each whack.
</p>
<p>The other groups in the QFASL file will perform operations such as
evaluating a list previously constructed or storing an object into a
symbol&rsquo;s function cell or value cell.
</p>
<p>If you are having trouble with a QFASL file and want to find out exactly
what it does when it is loaded, you can use UNFASL to find out.
</p>
<a name="si_003aunfasl_002dprint_002dfun"></a><dl>
<dt><a name="index-si_003aunfasl_002dprint"></a>Function: <strong>si:unfasl-print</strong> <em>input-file-name</em></dt>
<dd><p>Prints on <code>standard-output</code> a description of the contents of the QFASL
file <em>input-file-name</em>.
</p></dd></dl>

<a name="si_003aunfasl_002dfile_002dfun"></a><dl>
<dt><a name="index-si_003aunfasl_002dfile"></a>Function: <strong>si:unfasl-file</strong> <em>input-file-name &amp;optional output-file-name</em></dt>
<dd><p>Writes a description of the contents of the QFASL file
<em>input-file-name</em> into the output file.  The output file type defaults
to <code>UNFASL</code> and the rest of the pathname defaults from
<em>input-file-name</em>.
</p></dd></dl>

<a name="g_t_0022Compiler-Interlocking_0022"></a>
<h3 class="section">16.10 &quot;Compiler Interlocking&quot;</h3>

<p>Because the compiler uses a temporary area for its internal data (so
as to avoid the need for frequent garbage collection), it is not
reentrant.  Only one process can use the compiler at any given time.
</p>
<p>Calling the compiler when it is in use in another process will wait
until the other compilation is finished, and also produce a
notification: &quot;Compiler waiting for resources in process LOSSAGE-5&quot;.  If
the other compilation is proceeding, eventually it will finish and this
one will begin.  If the other compilation is hung for some reason, such
as because it is waiting to type out on an unexposed window, or is
having trouble with file servers, you should go to that process and
either cause the compilation to finish or abort it.
</p>
<a name="compiler_003alocking_002dresources_002dfun"></a><dl>
<dt><a name="index-compiler_003alocking_002dresources"></a>Special Form: <strong>compiler:locking-resources</strong> <em>body...</em></dt>
<dd><p>Executes the body, having locked the compiler lock.
</p></dd></dl>

<a name="g_t_0022Macros_0022"></a>
<h2 class="chapter">17 &quot;Macros&quot;</h2>
<a name="macro"></a><a name="macros_002dchapter"></a><a name="index-macros"></a>

<a name="g_t_0022Introduction-to-Macros_0022"></a>
<h3 class="section">17.1 &quot;Introduction to Macros&quot;</h3>

<p>If <code>eval</code> is handed a list whose car is a symbol, then <code>eval</code>
inspects the definition of the symbol to find out what to do.  If the
definition is a cons, and the car of the cons is the symbol
<code>macro</code>, then the definition (i.e that cons) is called a <em>macro</em>.
The cdr of the cons should be a function of one argument.
<code>eval</code> applies the function to the form it was originally given,
takes whatever is returned, and evaluates that in lieu of the
original form.
</p>
<p>Here is a simple example.  Suppose the definition of the symbol <code>first</code> is
</p><div class="lisp">
<pre class="lisp">(macro lambda (x) 
         (list 'car (cadr x)))
</pre></div>
<p>This thing is a macro: it is a cons whose car is the symbol
<code>macro</code>.  What happens if we try to evaluate a form <code>(first '(a b
c))</code>?  Well, <code>eval</code> sees that it has a list whose car is a symbol
(namely, <code>first</code>), so it looks at the definition of the symbol and
sees that it is a cons whose car is <code>macro</code>; the definition is
a macro.
</p>
<p><code>eval</code> takes the cdr of the cons, which is supposed to be the
macro&rsquo;s <em>expander function</em>, and calls it providing as an argument the
original form that <code>eval</code> was handed.  So it calls
<code>(lambda (x) (list 'car (cadr x)))</code> with argument <code>(first '(a b c))</code>.
Whatever this returns is the <em>expansion</em> of the macro call.  It will
be evaluated in place of the original form.
</p>
<p>In this case, <code>x</code> is bound to <code>(first '(a b c))</code>, <code>(cadr x)</code>
evaluates to <code>'(a b c)</code>, and <code>(list 'car (cadr x))</code> evaluates to
<code>(car '(a b c))</code>, which is the expansion.  <code>eval</code> now evaluates the
expansion.  <code>(car '(a b c))</code> returns <code>a</code>, and so the result is that
<code>(first '(a b c))</code> returns <code>a</code>.
</p>
<p>What have we done?  We have defined a macro called <code>first</code>.  What
the macro does is to <em>translate</em> the form to some other form.  Our
translation is very simple&ndash;it just translates forms that look like
<code>(first <em>x</em>)</code> into <code>(car <em>x</em>)</code>, for any form <em>x</em>.
We can do much more
interesting things with macros, but first we will show how
to define a macro.
</p>
<a name="macro_002dfun"></a><dl>
<dt><a name="index-macro"></a>Special Form: <strong>macro</strong></dt>
<dd><p>The primitive special form for defining macros is <code>macro</code>.
A macro definition looks like this:
</p><div class="lisp">
<pre class="lisp">(macro <em>name</em> (<em>arg</em>)
    <em>body</em>)
</pre></div>
<p><em>name</em> can be any function spec.  <em>arg</em> must be a variable.  <em>body</em> is
a sequence of Lisp forms that expand the macro; the last form should return
the expansion.
</p></dd></dl>

<p>To define our <code>first</code> macro, we would say
</p><div class="lisp">
<pre class="lisp">(macro first (x)
    (list 'car (cadr x)))
</pre></div>

<p>Here are some more simple examples of macros.  Suppose we want
any form that looks like <code>(addone <em>x</em>)</code> to be translated into
<code>(plus 1 <em>x</em>)</code>.  To define a macro to do this we would say
</p><div class="lisp">
<pre class="lisp">(macro addone (x)
   (list 'plus '1 (cadr x)))
</pre></div>

<p>Now say we wanted a macro which would translate <code>(increment <em>x</em>)</code>
into <code>(setq <em>x</em> (1+ <em>x</em>)</code>.  This would be:
</p><div class="lisp">
<pre class="lisp">(macro increment (x)
    (list 'setq (cadr x) (list '1+ (cadr x))))
</pre></div>
<p>Of course, this macro is of limited usefulness.  The reason is that the
form in the <em>cadr</em> of the <code>increment</code> form had better be a symbol.
If you tried <code>(increment (car x))</code>, it would be translated into
<code>(setq (car x) (1+ (car x)))</code>, and <code>setq</code> would complain.
(If you&rsquo;re interested in how to fix this problem, see <code>setf</code> (<a href="#setf_002dfun">setf-fun</a>);
but this is irrelevant to how macros work.)
</p>
<p>You can see from this discussion that macros are very different
from functions.  A function would not be able to tell what kind of
subforms are around in a call to itself; they get evaluated before the
function ever sees them.  However, a macro gets to look at the whole
form and see just what is going on there.  Macros are <em>not</em> functions;
if <code>first</code> is defined as a macro, it is not meaningful to apply
<code>first</code> to arguments.  A macro does not take arguments at all; its
expander function takes a <em>Lisp form</em> and turns it into another <em>Lisp
form</em>.
</p>
<p>The purpose of functions is to <em>compute</em>; the purpose of
macros is to <em>translate</em>.  Macros are used for a variety of purposes, the
most common being extensions to the Lisp language.  For example, Lisp
is powerful enough to express many different control structures, but it
does not provide every control structure anyone might ever possibly
want.  Instead, if a user wants some kind of control structure with a
syntax that is not provided, he can  translate it into some form that
Lisp <em>does</em> know about.
</p>
<p>For example, someone might want a limited iteration construct
which increments a variable by one until it exceeds a limit (like the
FOR statement of the BASIC language).  He might want it to look like
</p><div class="lisp">
<pre class="lisp">(for a 1 100 (print a) (print (* a a)))
</pre></div>
<p>To get this, he could write a macro to translate it into
</p><div class="lisp">
<pre class="lisp">(do ((a 1 (1+ a))) ((&gt; a 100)) (print a) (print (* a a)))
</pre></div>
<p>A macro to do this could be defined with
</p><div class="lisp">
<pre class="lisp">(macro for (x)
  (list* 'do
	 (list (list (second x) (third x) (list '1+ (second x))))
	 (list (list '&gt; (second x) (fourth x)))
	 (cddddr x)))
</pre></div>
<p>Now he has defined his own new control structure primitive, and it
will act just as if it were a special form provided by Lisp itself.
</p>
<a name="g_t_0022Aids-for-Defining-Macros_0022"></a>
<h3 class="section">17.2 &quot;Aids for Defining Macros&quot;</h3>

<p>The main problem with the definition for the <code>for</code> macro is
that it is verbose and clumsy.  If it is that hard to write a macro
to do a simple specialized iteration construct, one would wonder how
anyone could write macros of any real sophistication.
</p>
<p>There are two things that make the definition so inelegant.
One is that the programmer must write things like &quot;<code>(second x)</code>&quot;
and &quot;<code>(cddddr x)</code>&quot; to refer to the parts of the form he wants
to do things with.  The other problem is that the long chains of calls
to the <code>list</code> and <code>cons</code> functions are very hard to read.
</p>
<p>Two features are provided to solve these two problems.
The <code>defmacro</code> macro solves the former, and the &quot;backquote&quot; (<code>`</code>)
reader macro solves the latter.
</p>
<a name="g_t_0022Defmacro_0022"></a>
<h4 class="subsection">17.2.1 &quot;Defmacro&quot;</h4>
<a name="index-macro_002ddefining-macros"></a>
<a name="index-defmacro"></a>

<p>Instead of referring to the parts of our form by &quot;<code>(second x)</code>&quot;
and such, we would like to give names to the various pieces of the form,
and somehow have the <code>(second x)</code> automatically generated.  This is done
by a macro called <code>defmacro</code>.  It is easiest to explain what <code>defmacro</code> does
by showing an example. Here is how you would write the <code>for</code> macro
using <code>defmacro</code>:
</p><div class="lisp">
<pre class="lisp">(defmacro for (var lower upper . body)
  (list* 'do
	 (list (list var lower (list '1+ var)))
	 (list (list '&gt; var upper))
	 body))
</pre></div>

<p>The <code>(var lower upper  body)</code> is a <em>pattern</em> to match against
the body of the form (to be more precise, to match against the cdr
of the argument to the macro&rsquo;s expander function).  If <code>defmacro</code> tries to match the two
lists
</p><div class="lisp">
<pre class="lisp">(var lower upper . body)
<span class="roman">and</span>
(a 1 100 (print a) (print (* a a)))
</pre></div>
<p><code>var</code> will get bound to the symbol <code>a</code>, <code>lower</code> to the fixnum <code>1</code>,
<code>upper</code> to the fixnum <code>100</code>, and <code>body</code> to the list
<code>((print a) (print (* a a)))</code>.  Then inside the body of the <code>defmacro</code>,
<code>var, lower, upper,</code> and <code>body</code> are variables, bound to the matching
parts of the macro form.
</p>
<a name="defmacro_002dfun"></a><dl>
<dt><a name="index-defmacro-1"></a>Macro: <strong>defmacro</strong></dt>
<dd><p><code>defmacro</code> is a general purpose macro-defining macro.  A <code>defmacro</code>
form looks like 
</p><div class="lisp">
<pre class="lisp">(defmacro <em>name</em> <em>pattern</em> . <em>body</em>)
</pre></div>
<p>The <em>pattern</em> may be anything made up out of symbols and conses.
It is matched against the body of the macro form; both <em>pattern</em>
and the form are car&rsquo;ed and cdr&rsquo;ed identically, and whenever
a non-<code>nil</code> symbol is hit in <em>pattern</em>, the symbol is bound to the corresponding
part of the form.  All of the symbols in <em>pattern</em> can be used
as variables within <em>body</em>.  <em>name</em> is the name of the macro
to be defined; it can be any function spec (see <a href="#function_002dspec">function-spec</a>).
<em>body</em> is evaluated with these bindings in effect,
and its result is returned to the evaluator as the expansion of the macro.
</p></dd></dl>

<p>Note that the pattern need not be a list the way a lambda-list must.
In the above example, the pattern was a &quot;dotted list&quot;, since the symbol
<code>body</code> was supposed to match the cddddr of the macro form.
If we wanted a new iteration form, like <code>for</code> except that
our example would look like
</p><div class="lisp">
<pre class="lisp">(for a (1 100) (print a) (print (* a a)))
</pre></div>
<p>(just because we thought that was a nicer syntax), then we could
do it merely by modifying the pattern of the <code>defmacro</code> above;
the new pattern would be <code>(var (lower upper) . body)</code>.
</p>
<p>Here is how we would write our other examples using <code>defmacro</code>:
</p><div class="lisp">
<pre class="lisp">(defmacro first (the-list)
    (list 'car the-list))

(defmacro addone (form)
   (list 'plus '1 form))

(defmacro increment (symbol)
   (list 'setq symbol (list '1+ symbol)))
</pre></div>
<p>All of these were very simple macros and have very simple patterns,
but these examples show that we can replace the <code>(cadr x)</code> with a
readable mnemonic name such as <code>the-list</code> or <code>symbol</code>, which
makes the program clearer, and enables documentation facilities such
as the <code>arglist</code> function to describe the syntax of the special form
defined by the macro.
</p>
<p>There is another version of <code>defmacro</code> which defines
displacing macros (see <a href="#displacing_002dmacro">displacing-macro</a>).
<code>defmacro</code> has other, more complex features; see <a href="#defmacro_002dhair">defmacro-hair</a>.
</p>
<a name="g_t_0022Backquote_0022"></a>
<h4 class="subsection">17.2.2 &quot;Backquote&quot;</h4>
<a name="backquote"></a><a name="index-backquote"></a>

<p>Now we deal with the other problem: the long strings of calls to
<code>cons</code> and <code>list</code>.  This problem is relieved by introducing some new
characters that are special to the Lisp reader.  Just as the
single-quote character makes it easier to type things of the form
<code>(quote <em>x</em>)</code>, so will some more new special characters make it
easier to type forms that create new list structure.  The functionality
provided by these characters is called the <em>backquote</em> facility, which
allows you to create a list from a template including constant and
variable parts.
</p>
<p>The backquote facility is used by giving a backquote character
(<code>`</code>), followed by a form.  If the form does
not contain any use of the comma character, the backquote acts just
like a single quote: it creates a form which, when evaluated, produces
the form following the backquote.  For example,
</p><div class="lisp">
<pre class="lisp"> '(a b c) =&gt; (a b c)
 `(a b c) =&gt; (a b c)
</pre></div>
<p>So in the simple cases, backquote is just like the regular single-quote
macro.  The way to get it to do interesting things is to include a
comma somewhere inside of the form following the backquote.
The comma is followed by a form, and that form gets evaluated even
though it is inside the backquote.  For example,
</p><div class="lisp">
<pre class="lisp">(setq b 1)
`(a b c)  =&gt; (a b c)
`(a ,b c) =&gt; (a 1 c)
`(abc ,(+ b 4) ,(- b 1) (def ,b)) =&gt; (abc 5 0 (def 1))
</pre></div>
<p>In other words, backquote quotes everything <em>except</em> things preceded by
a comma; those things get evaluated.
</p>
<p>A list following a backquote can be thought of as a template for
some new list structure.  The parts of the list that are preceded by
commas are forms that fill in slots in the template; everything else is
just constant structure that will appear in the result.  This is usually
what you want in the body of a macro; some of the form generated by the macro
is constant, the same thing on every invocation of the macro.  Other parts
are different every time the macro is called, often being functions of
the form that the macro appeared in (the &quot;arguments&quot; of the macro).  The
latter parts are the ones for which you would use the comma.  Several examples
of this sort of use follow.
</p>
<p>When the reader sees the <code>`(a ,b c)</code> it is actually generating
a form such as <code>(list 'a b 'c)</code>.  The actual form generated may use
<code>list</code>, <code>cons</code>, <code>append</code>, or whatever might be a good idea; you
should never have to concern yourself with what it actually turns into.
All you need to care about is what it evaluates to.  Actually, it
doesn&rsquo;t use the regular functions <code>cons</code>, <code>list</code>, and so forth, but
uses special ones instead so that the grinder can recognize a form which
was created with the backquote syntax, and print it using backquote so
that it looks like what you typed in.  You should never write any
program that depends on this, anyway, because backquote makes no
guarantees about how it does what it does.  In particular, in some
circumstances it may decide to create constant forms, that will cause
sharing of list structure at run time, or it may decide to create forms
that will create new list structure at run time.
For example, if the readers sees <code>`(r  ,nil)</code>,
it may produce the same thing as <code>(cons 'r nil)</code>, or <code>'(r . nil)</code>.
Be careful that your program does not depend on which of these it does.
</p>
<p>This is generally found to be pretty confusing by most people; the best way
to explain further seems to be with examples.  Here is how we would write our
three simple macros using both the <code>defmacro</code> and backquote facilities.
</p><div class="lisp">
<pre class="lisp">(defmacro first (the-list)
    `(car ,the-list))

(defmacro addone (form)
   `(plus 1 ,form))

(defmacro increment (symbol)
   `(setq ,symbol (1+ ,symbol)))
</pre></div>
<p>To finally demonstrate how easy it is to define macros with these two facilities,
here is the final form of the <code>for</code> macro.
</p><div class="lisp">
<pre class="lisp">(defmacro for (var lower upper . body)
  `(do ((,var ,lower (1+ ,var))) ((&gt; ,var ,upper)) . ,body))
</pre></div>
<p>Look at how much simpler that is than the original definition.  Also,
look how closely it resembles the code it is producing.  The functionality
of the <code>for</code> really stands right out when written this way.
</p>
<p>If a comma inside a backquote form is followed by an &quot;atsign&quot;
character (<code>@</code>), it has a special meaning.  The &quot;<code>,@</code>&quot; should
be followed by a form whose value is a <em>list</em>; then each of the elements
of the list is put into the list being created by the backquote.  In other
words, instead of generating a call to the <code>cons</code> function, backquote
generates a call to <code>append</code>.  For example, if <code>a</code> is bound to
<code>(x y z)</code>, then <code>`(1 ,a 2)</code> would evaluate to <code>(1 (x y z) 2)</code>,
but <code>`(1 ,@a 2)</code> would evaluate to <code>(1 x y z 2)</code>.
</p>
<p>Here is an example of a macro definition that uses the &quot;<code>,@</code>&quot;
construction.  On way to define <code>do-forever</code> would be for it to expand
</p><div class="lisp">
<pre class="lisp">(do-forever <em>form1</em> <em>form2</em> <em>form3</em>)
</pre></div>
<p>into
</p><div class="lisp">
<pre class="lisp">(prog ()
    a <em>form1</em>
      <em>form2</em>
      <em>form3</em>
      (go a))
</pre></div>
<p>You could define the macro by
</p><div class="lisp">
<pre class="lisp">(defmacro do-forever (&amp;body body)
  `(prog ()
       a ,@body
	 (go a)))
</pre></div>

<p>A similar construct is &quot;<code>,</code>&quot; (comma, dot).  This means the same thing
as &quot;<code>,@</code>&quot; except that the list which is the value of the following form
may be modified destructively; backquote uses <code>nconc</code> rather than <code>append</code>.
This should of course be used with caution.
</p>
<p>Backquote does not make any guarantees about what parts of the structure it
shares and what parts it copies.  You should not do destructive operations
such as <code>nconc</code> on the results of backquote forms such as
</p><div class="lisp">
<pre class="lisp">`(,a b c d)
</pre></div>
<p>since backquote might choose to implement this as
</p><div class="lisp">
<pre class="lisp">(cons a '(b c d))
</pre></div>
<p>and <code>nconc</code> would smash the constant.  On the other hand, it would be
safe to <code>nconc</code> the result of
</p><div class="lisp">
<pre class="lisp">`(a b ,c ,d)
</pre></div>
<p>since there is nothing this could expand into that does not involve
making a new list, such as
</p><div class="lisp">
<pre class="lisp">(list 'a 'b c d)
</pre></div>

<p>Backquote of course guarantees not to do any destructive operations
(<code>rplaca</code>, <code>rplacd</code>, <code>nconc</code>) on the components of the
structure it builds, unless the &quot;<code>,</code>&quot; syntax is used.
</p>
<p>Advanced macro writers sometimes write &quot;macro-defining macros&quot;:
forms which expand into forms which, when evaluated, define macros.  In
such macros it is often useful to use nested backquote constructs.  The
following example illustrates the use of nested backquotes in the
writing of macro-defining macros.
</p>
<p>This example is a very simple version of <code>defstruct</code> (see <a href="#defstruct_002dfun">defstruct-fun</a>).
You should first understand the basic description of <code>defstruct</code> before
proceeding with this example.  The <code>defstruct</code> below does not accept
any options and allows only the simplest kind of items; that is, it allows
only forms like
</p><div class="lisp">
<pre class="lisp">(defstruct (<em>name</em>)
     <em>item1</em>
     <em>item2</em>
     <em>item3</em>
     <em>item4</em>
     ...)
</pre></div>
<p>We would like this form to expand into
</p><div class="lisp">
<pre class="lisp">(progn 'compile
 (defmacro <em>item1</em> (x)
      `(aref ,x 0))
 (defmacro <em>item2</em> (x)
      `(aref ,x 1))
 (defmacro <em>item3</em> (x)
      `(aref ,x 2))
 (defmacro <em>item4</em> (x)
      `(aref ,x 3))
 ...)
</pre></div>

<p>(The meaning of the <code>(progn 'compile ...)</code> is discussed on
<a href="#progn_002dquote_002dcompile_002dpage">progn-quote-compile-page</a>.) Here is the macro to perform the
expansion:
</p><div class="lisp">
<pre class="lisp">(defmacro defstruct ((name) . items)
     (do ((item-list items (cdr item-list))
	  (ans nil)
	  (i 0 (1+ i)))
	 ((null item-list)
          `(progn 'compile . ,(nreverse ans)))
       (setq ans
	     (cons `(defmacro ,(car item-list) (x)
			   `(aref ,x ,',i))
		   ans))))
</pre></div>
<p>The interesting part of this definition is the body of
the (inner) <code>defmacro</code> form:
</p><div class="lisp">
<pre class="lisp">`(aref ,x ,',i)
</pre></div>
<p>Instead of using this backquote construction, we could have written
</p><div class="lisp">
<pre class="lisp">(list 'aref x ,i)
</pre></div>
<p>That is, the &quot;<code>,',</code>&quot;
acts like a comma that matches the outer backquote, while
the &quot;<code>,</code>&quot; preceding the &quot;<code>x</code>&quot; matches with the inner
backquote.  Thus, the symbol <code>i</code> is evaluated when the
<code>defstruct</code> form is expanded, whereas the symbol <code>x</code> is
evaluated when the accessor macros are expanded.
</p>
<p>Backquote can be useful in situations other than the writing
of macros.  Whenever there is a piece of list structure to be consed
up, most of which is constant, the use of backquote can make the
program considerably clearer.
</p>
<a name="Substitutable-Functions"></a>
<h3 class="section">17.3 Substitutable Functions</h3>
<a name="index-subst-1"></a>
<a name="index-substitutable-function"></a>

<p>A substitutable function is a function that is open coded by the
compiler.  It is like any other function when applied, but it can be
expanded instead, and in that regard resembles a macro.
</p>
<a name="defsubst_002dfun"></a><dl>
<dt><a name="index-defsubst"></a>Special Form: <strong>defsubst</strong></dt>
<dd><p><code>defsubst</code> is used for defining substitutable functions.  It is used just
like <code>defun</code>.
</p><div class="lisp">
<pre class="lisp">(defsubst <em>name</em> <em>lambda-list</em> . <em>body</em>)
</pre></div>
<p>and does almost the same thing.  It defines a function that executes
identically to the one that a similar call to <code>defun</code> would define.  The
difference comes when a function that <em>calls</em> this one is compiled.  Then,
the call is open-coded by substituting the substitutable function&rsquo;s
definition into the code being compiled.  The function itself
looks like <code>(named-subst <em>name</em> <em>lambda-list</em> . <em>body</em>)</code>.  Such a function
is called a <code>subst</code>.  For example, if
we define
</p><div class="lisp">
<pre class="lisp">(defsubst square (x) (* x x))
(defun foo (a b) (square (+ a b)))
</pre></div>
<p>then if <code>foo</code> is used interpreted, <code>square</code> will work just as if it had
been defined by <code>defun</code>.  If <code>foo</code> is compiled, however, the squaring
will be substituted into it and it will compile just like
</p><div class="lisp">
<pre class="lisp">(defun foo (a b) (* (+ a b) (+ a b)))
</pre></div>
<p><code>square</code>&rsquo;s definition would be
</p><div class="lisp">
<pre class="lisp">(named-subst square (x) (* x x))
</pre></div>
<p>(The internal formats of <code>subst</code>s and <code>named-subst</code>s are explained in <a href="#subst">subst</a>.)
</p>
<p>A similar <code>square</code> could be defined as a macro, with
</p><div class="lisp">
<pre class="lisp">(defmacro square (x) `(* ,x ,x))
</pre></div>
<p>In general, anything that is implemented as a <code>subst</code> can be re-implemented
as a macro, just by changing the <code>defsubst</code> to a <code>defmacro</code> and putting
in the appropriate backquote and commas.  The disadvantage of macros
is that they are not functions, and so cannot be applied to arguments.
Their advantage is that they can do much more powerful things than
<code>subst</code>s can.  This is also a disadvantage since macros provide more
ways to get into trouble.  If something can be implemented either as a macro
or as a <code>subst</code>, it is generally better to make it a <code>subst</code>.
</p>
<p>The <em>lambda-list</em> of a <code>subst</code> may contain <code>&amp;optional</code> and
<code>&amp;rest</code>, but no other lambda-list keywords.  If there is a
rest-argument, it is replaced in the body with an explicit call to
<code>list</code>:
</p><div class="lisp">
<pre class="lisp">(defsubst append-to-foo (&amp;rest args) 
  (setq foo (append args foo)))

(append-to-foo x y z)
</pre></div>
<p>expands to
</p><div class="lisp">
<pre class="lisp">(setq foo (append (list x y z) foo))
</pre></div>

<p>Rest arguments in <code>subst</code>s are most useful with
<code>lexpr-funcall</code>, because of an optimization that is done:
</p><div class="lisp">
<pre class="lisp">(defsubst xhack (&amp;rest indices) 
  (lexpr-funcall 'xfun xarg1 indices))

(xhack a (car b))
</pre></div>
<p>is equivalent to
</p><div class="lisp">
<pre class="lisp">(xfun xarg1 a (car b))
</pre></div>
<p>If <code>xfun</code> is itself a <code>subst</code>, it will be expanded in turn.
</p>
<p>When a <code>defsubst</code> is compiled, its list structure definition is kept
around so that calls can still be open-coded by the compiler.  But
non-open-coded calls to the function run at the speed of compiled code.
The interpreted definition is kept in the compiled definition&rsquo;s
debugging info alist (see <a href="#debugging_002dinfo_002dfun">debugging-info-fun</a>).  Undeclared free
variables used in a <code>defsubst</code> being compiled do not get any warning,
because this is a common practice that works properly with nonspecial
variables when calls are open coded.
</p>
<p>If you are using a <code>defsubst</code> from outside the program to which it belongs,
you might sometimes be better off if it is not open-coded.
The decrease in speed might not be significant, and you would
have the advantage that you would not need to recompile your program
if the definition is changed.  You can prevent open-coding by putting
<code>dont-optimize</code> around the call to the <code>defsubst</code>.
</p><div class="lisp">
<pre class="lisp">(dont-optimize (xhack a (car b)))
</pre></div>
<p>See <a href="#dont_002doptimize_002dfun">dont-optimize-fun</a>.
</p>
<p>You will notice that the substitution performed is very simple and takes no care
about the possibility of computing an argument twice when it really ought to be
computed once.  
For instance, in the current implementation, the functions
</p><div class="lisp">
<pre class="lisp">(defsubst reverse-cons (x y) (cons y x))
(defsubst in-order (a b c) (and (&lt; a b) (&lt; b c)))
</pre></div>
<p>would present problems.  When compiled, because of the substitution
a call to <code>reverse-cons</code> would evaluate its arguments in the
wrong order, and a call to <code>in-order</code> could evaluate its second
argument twice.  This will be fixed at some point in the future,
but for now the writer of <code>defsubst</code>&rsquo;s must be cautious.
Also all occurrences of the argument names in the body are replaced
with the argument forms, wherever they appear.  Thus an argument name
should not be used in the body for anything else, such as a function
name or a symbol in a constant.
</p>
<p>As with <code>defun</code>, <em>name</em> can be any function spec.
</p></dd></dl>


<a name="Hints-to-Macro-Writers"></a>
<h3 class="section">17.4 Hints to Macro Writers</h3>

<p>There are many useful techniques for writing macros.  Over the years,
Lisp programmers have discovered techniques that most programmers find
useful, and have identified pitfalls that must be avoided.  This
section discusses some of these techniques and illustrates them with
examples.
</p>
<p>The most important thing to keep in mind as you learn to write macros
is that the first thing you should do is figure out what the macro form
is supposed to expand into, and only then should you start to actually
write the code of the macro.  If you have a firm grasp of what the
generated Lisp program is supposed to look like, you
will find the macro much easier to write.
</p>
<p>In general any macro that can be written as a substitutable
function (see <a href="#defsubst_002dfun">defsubst-fun</a>) should be written as one, not as a macro,
for several reasons: substitutable functions are easier to write and to
read; they can be passed as functional arguments (for example, you can
pass them to <code>mapcar</code>); and there are some subtleties that can occur
in macro definitions that need not be worried about in substitutable
functions.  A macro can be a substitutable function only if it has
exactly the semantics of a function, rather than of a special form.  The
macros we will see in this section are not semantically like functions;
they must be written as macros.
</p>
<a name="Name-Conflicts"></a>
<h4 class="subsection">17.4.1 Name Conflicts</h4>

<p>One of the most common errors in writing macros is best illustrated by
example.  Suppose we wanted to write <code>dolist</code> (see <a href="#dolist_002dfun">dolist-fun</a>) as
a macro that expanded into a <code>do</code> (see <a href="#do_002dfun">do-fun</a>).  The first step,
as always, is to figure out what the expansion should look like.  Let&rsquo;s
pick a representative example form, and figure out what its expansion
should be.  Here is a typical <code>dolist</code> form.
</p>
<div class="lisp">
<pre class="lisp">(dolist (element (append a b))
  (push element *big-list*)
  (foo element 3))
</pre></div>

<p>We want to create a <code>do</code> form that does the thing that the above
<code>dolist</code> form says to do.  That is the basic goal of the macro: it
must expand into code that does the same thing that the original code
says to do, but it should be in terms of existing Lisp constructs.
The <code>do</code> form might look like this:
</p>
<div class="lisp">
<pre class="lisp">(do ((list (append a b) (cdr list))
     (element))
    ((null list))
  (setq element (car list))
  (push element *big-list*)
  (foo element 3))
</pre></div>

<p>Now we could start writing the macro that would generate this code, and
in general convert any <code>dolist</code> into a <code>do</code>, in an analogous way.
However, there is a problem with the above scheme for expanding the
<code>dolist</code>.  The above expansion works fine.  But what if the input
form had been the following:
</p>
<div class="lisp">
<pre class="lisp">(dolist (list (append a b))
  (push list *big-list*)
  (foo list 3))
</pre></div>

<p>This is just like the form we saw above, except that the programmer happened
to decide to name the looping variable <code>list</code> rather than
<code>element</code>.  The corresponding expansion would be:
</p>
<div class="lisp">
<pre class="lisp">(do ((list (append a b) (cdr list))
     (list))
    ((null list))
  (setq list (car list))
  (push list *big-list*)
  (foo list 3))
</pre></div>

<p>This doesn&rsquo;t work at all!  In fact, this is not even a valid program,
since it contains a <code>do</code> that uses the same variable in two different
iteration clauses.
</p>
<p>Here&rsquo;s another example that causes trouble:
</p>
<div class="lisp">
<pre class="lisp">(let ((list nil))
  (dolist (element (append a b))
    (push element list)
    (foo list 3)))
</pre></div>

<p>If you work out the expansion of this form, you will see that there are
two variables named <code>list</code>, and that the programmer meant to refer to the
outer one but the generated code for the <code>push</code> actually uses
the inner one.
</p>
<p>The problem here is an accidental name conflict.  This can happen in
any macro that has to create a new variable.  If that variable ever
appears in a context in which user code might access it, then you have
to worry that it might conflict with some other name that the user is
using for his own program.
</p>
<p>One way to avoid this problem is to choose a name that is very
unlikely to be picked by the user, simply by choosing an unusual name.
This will probably work, but it is inelegant since there is no
guarantee that the user won&rsquo;t just happen to choose the same name.  The
way to really avoid the name conflict is to use an uninterned symbol as
the variable in the generated code.  The function <code>gensym</code> (see
<a href="#gensym_002dfun">gensym-fun</a>) is useful for creating such symbols.
</p>
<p>Here is the expansion of the original form, using an uninterned
symbol created by <code>gensym</code>.
</p>
<div class="lisp">
<pre class="lisp">(do ((g0005 (append a b) (cdr g0005))
     (element))
    ((null g0005))
  (setq element (car g0005))
  (push element *big-list*)
  (foo element 3))
</pre></div>

<p>This is the right kind of thing to expand into.  Now that we understand
how the expansion works, we are ready to actually write the macro.
Here it is:
</p>
<div class="lisp">
<pre class="lisp">(defmacro dolist ((var form) . body)
  (let ((dummy (gensym)))
    `(do ((,dummy ,form (cdr ,dummy))
	  (,var))
	 ((null ,dummy))
       (setq ,var (car ,dummy))
       . ,body)))
</pre></div>

<a name="index-dot_002c-in-symbols"></a>
<a name="index-period_002c-in-symbols"></a>
<p>Many system macros do not use <code>gensym</code> for the internal variables in their
expansions.  Instead they use symbols whose print names begin and end with a dot.
This provides meaningful names for these variables when looking at the generated
code and when looking at the state of a computation in the error-handler.
However, this convention means that users should avoid naming variables this way.
</p>
<a name="prog_002dcontext-Conflicts"></a>
<h4 class="subsection">17.4.2 prog-context Conflicts</h4>

<p>A related problem occurs when you write a macro that expands into a
<code>prog</code> (or a <code>do</code>, or something that expands into <code>prog</code> or <code>do</code>)
behind the user&rsquo;s back (unlike <code>dolist</code>, which is documented to be like
<code>do</code>).
Consider the <code>error-restart</code> special form (see <a href="#error_002drestart_002dfun">error-restart-fun</a>).
Suppose we wanted to implement it as a macro that expands into a <code>prog</code>.
If it expanded into a plain old <code>prog</code>, then the following (contrived)
Lisp program would not behave correctly:
</p>
<div class="lisp">
<pre class="lisp">(prog ()
   (setq a 3)
   (error-restart ((sys:abort error) &quot;Return from FOO.&quot;)
     (cond ((&gt; a 10)
            (return 5))
	   ((&gt; a 4)
            (ferror 'lose &quot;You lose.&quot;))))
   (setq b 7))
</pre></div>

<p>The problem is that the <code>return</code> would return from the
<code>error-restart</code> instead of the <code>prog</code>.  The way to avoid this
problem is to use a named <code>prog</code> whose name is <code>t</code>.  The name <code>t</code>
is special in that it is invisible to the <code>return</code> function.  If we
write <code>error-restart</code> as a macro that expands into a <code>prog</code> named
<code>t</code>, then the <code>return</code> will pass right through the
<code>error-restart</code> form and return from the <code>prog</code>, as it ought to.
</p>
<p>When <code>error-restart</code>&rsquo;s expansion is supposed to return from the
<code>prog</code> named <code>t</code>, it uses <code>return-from</code> <code>t</code>.
</p>
<p>In general, when a macro expands into a <code>prog</code> or a <code>do</code> around the
user&rsquo;s code, the <code>prog</code> or <code>do</code> should be named <code>t</code> so that
<code>return</code> forms in the user code will return to the right place,
unless the macro is documented as generating a <code>prog/do</code>-like form
which may be exited with <code>return</code>.
</p>
<a name="Macros-Expanding-into-Many-Forms"></a>
<h4 class="subsection">17.4.3 Macros Expanding into Many Forms</h4>
<a name="progn_002dquote_002dcompile_002ddiscussion"></a><a name="progn_002dquote_002dcompile_002dpage"></a>
<p>Sometimes a macro wants to do several different things when its expansion
is evaluated.  Another way to say this is that sometimes a macro wants to
expand into several things, all of which should happen sequentially at run
time (not macro-expand time).  For example, suppose you wanted to implement
<code>defconst</code> (see <a href="#defconst_002dfun">defconst-fun</a>) as a macro.  <code>defconst</code> must do two
things, declare the variable to be special and set the variable to its
initial value.  (We will implement a simplified <code>defconst</code> that does only
these two things, and doesn&rsquo;t have any options.)  What should a
<code>defconst</code> form expand into?  Well, what we would like is for an
appearance of
</p><div class="lisp">
<pre class="lisp">(defconst a (+ 4 b))
</pre></div>
<p>in a file to be the same thing as the appearance of the following two forms:
</p><div class="lisp">
<pre class="lisp">(declare (special a))
(setq a (+ 4 b))
</pre></div>
<p>However, because of the way that macros work, they only expand into one
form, not two.  So we need to have a <code>defconst</code> form expand into
one form that is just like having two forms in the file.
</p>
<p>There is such a form.  It looks like this:
</p><div class="lisp">
<pre class="lisp">(progn 'compile
       (declare (special a))
       (setq a (+ 4 b)))
</pre></div>
<p>In interpreted Lisp, it is easy to see what happens here.  This is a
<code>progn</code> special form, and so all its subforms are evaluated, in turn.
First the form <code>'compile</code> is evaluated.  The result is the symbol
<code>compile</code>; this value is not used, and evaluation of <code>'compile</code> has
no side-effects, so the <code>'compile</code> subform is effectively ignored.
Then the <code>declare</code> form and the <code>setq</code> form are evaluated.  So far,
so good.
</p>
<p>The interesting thing is the way this form is treated by the compiler.
The compiler specially recognizes any <code>progn</code> form at top level in a
file whose first subform is <code>'compile</code>.  When it sees such a
form, it processes each of the remaining subforms of the <code>progn</code> just
as if that form had appeared at top level in the file.  So the compiler
behaves exactly as if it had encountered the <code>declare</code> form at top
level, and then encountered the <code>setq</code> form at top level, even though
neither of those forms was actually at top-level (they were both inside
the <code>progn</code>).  This feature of the compiler is provided specifically for
the benefit of macros that want to expand into several things.
</p>
<p>Here is the macro definition:
</p><div class="lisp">
<pre class="lisp">(defmacro defconst (variable init-form)
  `(progn 'compile
	  (declare (special ,variable))
	  (setq ,variable ,init-form)))
</pre></div>

<p>Here is another example of a form that wants to expand into several
things.  We will implement a special form called <code>define-command</code>,
which is intended to be used in order to define commands in some
interactive user subsystem.  For each command, there are two things
provided by the <code>define-command</code> form: a function that executes the
command, and a text string that contains the documentation for the
command (in order to provide an on-line interactive documentation
feature).  This macro is a simplified version of a macro that is
actually used in the Zwei editor.  Suppose that in
this subsystem, commands are always functions of no arguments,
documentation strings are placed on the <code>help</code> property of the name
of the command, and the names of all commands are put onto a list.
A typical call to <code>define-command</code> would look like:
</p><div class="lisp">
<pre class="lisp">(define-command move-to-top
   &quot;This command moves you to the top.&quot;
   (do ()
       ((at-the-top-p))
     (move-up-one)))
</pre></div>
<p>This could expand into:
</p><div class="lisp">
<pre class="lisp">(progn 'compile
       (defprop
	 move-to-top
	 &quot;This command moves you to the top.&quot;
	 help)
       (push 'move-to-top *command-name-list*)
       (defun move-to-top ()
	 (do ()
	     ((at-the-top-p))
	   (move-up-one)))
       )
</pre></div>
<p>The <code>define-command</code> expands into three forms.  The first one sets up
the documentation string and the second one puts the command name onto
the list of all command names.  The third one is the <code>defun</code> that
actually defines the function itself.  Note that the <code>defprop</code> and
<code>push</code> happen at load-time (when the file is loaded); the function,
of course, also gets defined at load time.  (See the description of
<code>eval-when</code> (<a href="#eval_002dwhen_002dfun">eval-when-fun</a>) for more discussion of the differences
between compile time, load time, and eval time.)
</p>
<p>This technique makes Lisp a powerful language in which to implement
your own language.  When you write a large system in Lisp, frequently
you can make things much more convenient and clear by using macros to
extend Lisp into a customized language for your application.  In the
above example, we have created a little language extension: a new
special form that defines commands for our system.  It lets the writer
of the system put his documentation strings right next to the code that
they document, so that the two can be updated and maintained together.
The way that the Lisp environment works, with load-time evaluation able
to build data structures, lets the documentation data base and the list
of commands be constructed automatically.
</p>
<a name="Macros-that-Surround-Code"></a>
<h4 class="subsection">17.4.4 Macros that Surround Code</h4>

<p>There is a particular kind of macro that is very useful for many
applications.  This is a macro that you place &quot;around&quot; some Lisp code,
in order to make the evaluation of that code happen in some context.
For a very simple example, we could define a macro called
<code>with-output-in-base</code>, that executes the forms within its body
with any output of numbers that is done defaulting to a specified base.
</p><div class="lisp">
<pre class="lisp">(defmacro with-output-in-base ((base-form) &amp;body body)
   `(let ((base ,base-form))
      . ,body))
</pre></div>
<p>A typical use of this macro might look like:
</p><div class="lisp">
<pre class="lisp">(with-output-in-base (*default-base*)
   (print x)
   (print y))
</pre></div>
<p>which would expand into
</p><div class="lisp">
<pre class="lisp">(let ((base *default-base*))
  (print x)
  (print y))
</pre></div>

<p>This example is too trivial to be very useful; it is intended to
demonstrate some stylistic issues.  There are some special forms in
Zetalisp that are similar to this macro; see
<code>with-open-file</code> (<a href="#with_002dopen_002dfile_002dfun">with-open-file-fun</a>) and <code>with-input-from-string</code>
(<a href="#with_002dinput_002dfrom_002dstring_002dfun">with-input-from-string-fun</a>), for example.
The really interesting thing, of course, is that you can define your
own such special forms for your own specialized applications.  One very
powerful application of this technique was used in a system that
manipulates and solves the Rubik&rsquo;s cube puzzle.  The system heavily
uses a special form called <code>with-front-and-top</code>, whose meaning is
&quot;evaluate this code in a context in which this specified face of the
cube is considered the front face, and this other specified face is
considered the top face&quot;.
</p>
<p>The first thing to keep in mind when you write this sort of macro is
that you can make your macro much clearer to people who might read your
program if you conform to a set of loose standards of syntactic style.
By convention, the names of such special forms start with &quot;<code>with-</code>&quot;.
This seems to be a clear way of expressing the concept that we are
setting up a context; the meaning of the special form is &quot;do this stuff
<em>with</em> the following things true&quot;.  Another convention is that any
&quot;parameters&quot; to the special form should appear in a list that is the
first subform of the special form, and that the rest of the subforms
should make up a body of forms that are evaluated sequentially with the
last one returned.  All of the examples cited above work this way.  In
our <code>with-output-in-base</code> example, there was one parameter (the
base), which appears as the first (and only) element of a list that is
the first subform of the special form.  The extra level of parentheses
in the printed representation serves to separate the &quot;parameter&quot; forms
from the &quot;body&quot; forms so that it is textually apparent which is which;
it also provides a convenient way to provide default parameters (a good
example is the <code>with-input-from-string</code> special form
(<a href="#with_002dinput_002dfrom_002dstring_002dfun">with-input-from-string-fun</a>), which takes two required and two
optional &quot;parameters&quot;).  Another convention/technique is to use the
<code>&amp;body</code> keyword in the <code>defmacro</code> to tell the editor how to
correctly indent the special form (see <a href="#g_t_0026body">&amp;body</a>).
</p>
<p>The other thing to keep in mind is that control can leave the special
form either by the last form&rsquo;s returning, or by a non-local exit (that
is, something doing a <code>*throw</code>).  You should write the special form
in such a way that everything will be cleaned up appropriately no
matter which way control exits.  In our <code>with-output-in-base</code>
example, there is no problem, because non-local exits undo
lambda-bindings.  However, in even slightly more complicated cases, an
<code>unwind-protect</code> form (see <a href="#unwind_002dprotect_002dfun">unwind-protect-fun</a>) is needed: the
macro must expand into an <code>unwind-protect</code> that surrounds the body,
with &quot;cleanup&quot; forms that undo the context-setting-up that the macro
did.  For example, <code>using-resource</code> (see <a href="#using_002dresource_002dfun">using-resource-fun</a>)
is implemented as a macro
that does an <code>allocate-resource</code> and then performs the body inside of
an <code>unwind-protect</code> that has a <code>deallocate-resource</code> in its
&quot;cleanup&quot; forms.  This way the allocated resource item will be
deallocated whenever control leaves the <code>using-resource</code> special form.
</p>
<a name="Multiple-and-Out_002dof_002dorder-Evaluation"></a>
<h4 class="subsection">17.4.5 Multiple and Out-of-order Evaluation</h4>

<p>In any macro, you should always pay attention to the problem of
multiple or out-of-order evaluation of user subforms.  Here is an
example of a macro with such a problem.  This macro defines a special
form with two subforms.  The first is a reference, and the second is a
form.  The special form is defined to create a cons whose car and cdr
are both the value of the second subform, and then to set the reference
to be that cons.  Here is a possible definition:
</p><div class="lisp">
<pre class="lisp">(defmacro test (reference form)
   `(setf ,reference (cons ,form ,form)))
</pre></div>
<p>Simple cases will work all right:
</p><div class="lisp">
<pre class="lisp">(test foo 3) ==&gt;
  (setf foo (cons 3 3))
</pre></div>
<p>But a more complex example, in which the subform has side effects,
can produce surprising results:
</p><div class="lisp">
<pre class="lisp">(test foo (setq x (1+ x))) ==&gt;
  (setf foo (cons (setq x (1+ x))
                  (setq x (1+ x))))
</pre></div>
<p>The resulting code evaluates the <code>setq</code> form twice, and so <code>x</code>
is increased by two instead of by one.  A better definition of <code>test</code>
that avoids this problem is:
</p><div class="lisp">
<pre class="lisp">(defmacro test (reference form)
   (let ((value (gensym)))
     `(let ((,value ,form))
         (setf ,reference (cons ,value ,value)))))
</pre></div>
<p>With this definition, the expansion works as follows:
</p><div class="lisp">
<pre class="lisp">(test foo (setq x (1+ x))) ==&gt;
  (let ((g0005 (setq x (1+ x))))
     (setf foo (cons g0005 g0005)))
</pre></div>

<p>In general, when you define a new special form that has some forms as
its subforms, you have to be careful about just when those forms get
evaluated.  If you aren&rsquo;t careful, they can get evaluated more than
once, or in an unexpected order, and this can be semantically
significant if the forms have side-effects.  There&rsquo;s nothing
fundamentally wrong with multiple or out-of-order evalation if that is
really what you want and if it is what you document your special form
to do.  However, it is very common for special forms to simply behave
like functions, and when they are doing things like what functions do,
it&rsquo;s natural to expect them to be function-like in the evaluation of
their subforms.  Function forms have their subforms evaluated, each
only once, in left-to-right order, and special forms that are similar
to function forms should try to work that way too for clarity and
consistency.
</p>
<p>There is a tool that makes it easier for you to follow the principle
explained above.  It is a macro called <code>once-only</code>.  It is most easily
explained by example.  You would write <code>test</code> using
<code>once-only</code> as follows:
</p><div class="lisp">
<pre class="lisp">(defmacro test (reference form)
  (once-only (form)
    `(setf ,reference (cons ,form ,form))))
</pre></div>
<p>This defines <code>test</code> in such a way that the <code>form</code> is only evaluated
once, and references to <code>form</code> inside the macro body refer to that
value.  <code>once-only</code> automatically introduces a lambda-binding of a
generated symbol to hold the value of the form.  Actually, it is more
clever than that; it avoids introducing the lambda-binding for forms
whose evaluation is trivial and may be repeated without harm or cost,
such as numbers, symbols, and quoted structure.  This is just an
optimization that helps produce more efficient code.
</p>
<p>The <code>once-only</code> macro makes it easier to follow the principle, but it
does not completely or automatically solve the problems of multiple and
out-of-order evaluation.  It is just a tool that can solve some of the
problems some of the time; it is not a panacea.
</p>
<p>The following description attempts to explain what <code>once-only</code> does,
but it is a lot easier to use <code>once-only</code> by imitating the example
above than by trying to understand <code>once-only</code>&rsquo;s rather tricky
definition.
</p>
<a name="once_002donly_002dfun"></a><dl>
<dt><a name="index-once_002donly"></a>Macro: <strong>once-only</strong></dt>
<dd><p>A <code>once-only</code> form looks like 
</p><div class="lisp">
<pre class="lisp">(once-only <em>var-list</em>
  <em>form1</em>
  <em>form2</em>
  ...)
</pre></div>
<p><em>var-list</em> is a list of variables.  The <em>forms</em> are a Lisp program
that presumably uses the values of those variables.  When the form
resulting from the expansion of the <code>once-only</code> is evaluated, the first
thing it does is to inspect the values of each of the variables in
<em>var-list</em>; these values are assumed to be Lisp forms.  For each of the
variables, it binds that variable either to its current value, if the
current value is a trivial form, or to a generated symbol.  Next,
<code>once-only</code> evaluates the <em>forms</em> in this new binding environment and,
when they have been evaluated, it undoes the bindings.  The result of the
evaluation of the last <em>form</em> is presumed to be a Lisp form, typically
the expansion of a macro.  If all of the variables have been bound to
trivial forms, then <em>once-only</em> just returns that result.  Otherwise,
<code>once-only</code> returns the result wrapped in a lambda-combination that binds
the generated symbols to the result of evaluating the respective
non-trivial forms.
</p>
<p>The effect is that the program produced by evaluating the <code>once-only</code>
form is coded in such a way that, each of the forms which was the value
of one of the variables in <em>var-list</em> will be evaluated only once,
unless the form is such as to have no side effects.  At the same time,
no unnecessary temporary variables appear in the generated code, but the
body of the <code>once-only</code> is not cluttered up with extraneous code to
decide whether temporary variables are needed.
</p></dd></dl>

<p>Caution!  A number of system macros, <code>setf</code> for example, fail to
follow this convention.  Unexpected multiple evaluation and out-of-order
evaluation can occur with them.  This was done for the sake of efficiency,
is prominently mentioned in the documentation of these macros, and will
be fixed in the future.  It would be best not to compromise the semantic
simplicity of your own macros in this way.
</p>
<a name="Nesting-Macros"></a>
<h4 class="subsection">17.4.6 Nesting Macros</h4>
<a name="compiler_002dlet_002ddiscussion"></a>
<p>A useful technique for building language extensions is to define
programming constructs that employ two special forms, one of which is
used inside the body of the other.  Here is a simple example.  There
are two special forms.  The outer one is called <code>with-collection</code>,
and the inner one is called <code>collect</code>.  <code>collect</code> takes one
subform, which it evaluates; <code>with-collection</code> just has a body, whose
forms it evaluates sequentially.  <code>with-collection</code> returns a list of
all of the values that were given to <code>collect</code> during the evaluation
of the <code>with-collection</code>&rsquo;s body.  For example,
</p><div class="lisp">
<pre class="lisp">(with-collection
  (dotimes (i 5)
    (collect i)))

  =&gt; (1 2 3 4 5)
</pre></div>
<p>Remembering the first piece of advice we gave about macros, the
next thing to do is to figure out what the expansion looks like.
Here is how the above example could expand:
</p><div class="lisp">
<pre class="lisp">(let ((g0005 nil))
  (dotimes (i 5)
     (push i g0005))
  (nreverse g0005))
</pre></div>
<p>Now, how do we write the definition of the macros?  Well,
<code>with-collection</code> is pretty easy:
</p><div class="lisp">
<pre class="lisp">(defmacro with-collection (&amp;body body)
  (let ((var (gensym)))
     `(let ((,var nil))
        ,@body
        (nreverse ,var))))
</pre></div>
<p>The hard part is writing <code>collect</code>.  Let&rsquo;s try it:
</p><div class="lisp">
<pre class="lisp">(defmacro collect (argument)
  `(push ,argument ,var))
</pre></div>
<p>Note that something unusual is going on here: <code>collect</code> is using the
variable <code>var</code> freely.  It is depending on the binding that takes
place in the body of <code>with-collection</code> in order to get access to the
value of <code>var</code>.  Unfortunately, that binding took place when
<code>with-collection</code> got expanded; <code>with-collection</code>&rsquo;s expander
function bound <code>var</code>, and it got unbound when the expander function
was done.  By the time the <code>collect</code> form gets expanded, <code>var</code> has
long since been unbound.  The macro definitions above do not work.
Somehow the expander function of <code>with-collection</code> has to communicate
with the expander function of <code>collect</code> to pass over the generated
symbol.
</p>
<p>The only way for <code>with-collection</code> to convey information to the
expander function of <code>collect</code> is for it to expand into something
that passes that information.  What we can do is to define a special
variable (which we will call <code>*collect-variable*</code>), and have
<code>with-collection</code> expand into a form that binds this variable to the
name of the variable that the <code>collect</code> should use.  Now, consider
how this works in the interpreter.  The evaluator first sees the
<code>with-collection</code> form and calls the expander function to expand
it.  The expander function creates the expansion and returns to the
evaluator, which then evaluates the expansion.  The expansion includes
in it a <code>let</code> form to bind <code>*collect-variable*</code> to the generated
symbol.  When the evaluator sees this <code>let</code> form during the evaluation
of the expansion of the <code>with-collection</code> form, it sets up the
binding and recursively evaluates the body of the <code>let</code>.  Now, during
the evaluation of the body of the <code>let</code>, our special variable is
bound, and if the expander function of <code>collect</code> gets run, it is
able to see the value of <code>collection-variable</code> and incorporate the
generated symbol into its own expansion.
</p>
<p>Writing the macros this way is not quite right.  It works fine
interpreted, but the problem is that it does not work when we try to
compile Lisp code that uses these special forms.  When code is being
compiled, there isn&rsquo;t any interpreter to do the binding in our new
<code>let</code> form; macro expansion is done at compile time, but generated
code does not get run until the results of the compilation are loaded
and run.  The way to fix our definitions is to use <code>compiler-let</code>
instead of <code>let</code>.  <code>compiler-let</code> (see <a href="#compiler_002dlet_002dfun">compiler-let-fun</a>) is a
special form that exists specifically to do the sort of thing we are
trying to do here.  <code>compiler-let</code> is identical to <code>let</code> as far as
the interpreter is concerned, so changing our <code>let</code> to a
<code>compiler-let</code> won&rsquo;t affect the behavior in the interpreter; it will
continue to work.  When the compiler encounters a <code>compiler-let</code>, however,
it actually performs the bindings that the <code>compiler-let</code> specifies
and proceeds to compile the body of the <code>compiler-let</code> with all of
those bindings in effect.  In other words, it acts as the interpreter
would.
</p>
<p>Here&rsquo;s the right way to write these macros:
</p><div class="lisp">
<pre class="lisp">(defvar *collect-variable*)

(defmacro with-collection (&amp;body body)
  (let ((var (gensym)))
     `(let ((,var nil))
        (compiler-let ((*collect-variable* ',var))
           . ,body)
        (nreverse ,var))))

(defmacro collect (argument)
  `(push ,argument ,*collect-variable*))
</pre></div>

<a name="Functions-Used-During-Expansion"></a>
<h4 class="subsection">17.4.7 Functions Used During Expansion</h4>

<p>The technique of defining functions to be used during macro expansion
deserves explicit mention here.  It may not occur to you, but a macro
expander function is a Lisp program like any other Lisp program, and it
can benefit in all the usual ways by being broken down into a
collection of functions that do various parts of its work.  Usually
macro expander functions are pretty simple Lisp programs that take
things apart and put them together slightly differently, but
some macros are quite complex and do a lot of work.  Several features
of Zetalisp, including flavors, <code>loop</code>, and <code>defstruct</code>,
are implemented using very complex macros, which, like any complex
well-written Lisp program, are broken down into modular functions.  You should
keep this in mind if you ever invent an advanced language extension
or ever find yourself writing a five-page expander function.
</p>
<p>A particular thing to note is that any functions used by macro-expander
functions must be available at compile-time.  You can make a function
available at compile time by surrounding its defining form with an
<code>(eval-when (compile load eval) ...)</code>; see <a href="#eval_002dwhen_002dfun">eval-when-fun</a> for more
details.  Doing this means that at compile time the definition of the
function will be interpreted, not compiled, and hence will run more
slowly.  Another approach is to separate macro definitions and the
functions they call during expansion into a separate file, often called
a &quot;defs&quot; (definitions) file.  This file defines all the macros but does
not use any of them.  It can be separately compiled and loaded up
before compiling the main part of the program, which uses the macros.
The <em>system</em> facility (see <a href="#system_002dsystem">system-system</a>) helps keep these
various files straight, compiling and loading things in the right order.
</p>

<a name="g_t_0022Aids-for-Debugging-Macros_0022"></a>
<h3 class="section">17.5 &quot;Aids for Debugging Macros&quot;</h3>

<a name="mexp_002dfun"></a><dl>
<dt><a name="index-mexp"></a>Function: <strong>mexp</strong></dt>
<dd><p><code>mexp</code> goes into a loop in which it reads forms and sequentially
expands them, printing out the result of each expansion (using
the grinder (see <a href="#grind">grind</a>) to improve readability).  It terminates
when it reads an atom (anything that is not a cons).  If you type
in a form that is not a macro form, there will be no expansions
and so it will not type anything out, but just prompt you for
another form.  This allows you to see what your macros are
expanding into, without actually evaluating the result of the expansion.
</p></dd></dl>

<a name="g_t_0022Displacing-Macros_0022"></a>
<h3 class="section">17.6 &quot;Displacing Macros&quot;</h3>
<a name="displacing_002dmacro"></a><a name="index-displacing-macros"></a>
<p>Every time the the evaluator sees a macro form, it must
call the macro to expand the form.  If this expansion always
happens the same way, then it is wasteful to expand the whole
form every time it is reached; why not just expand it once?
A macro is passed the macro form itself, and so it can change
the car and cdr of the form to something else by using <code>rplaca</code>
and <code>rplacd</code>!  This way the first time the macro is expanded,
the expansion will be put where the macro form used to be, and the
next time that form is seen, it will already be expanded.  A macro that
does this is called a <em>displacing macro</em>, since it displaces
the macro form with its expansion.
</p>
<p>The major problem with this is that the Lisp form
gets changed by its evaluation.  If you were to write a program
which used such a macro, call <code>grindef</code> to look at it,
then run the program and call <code>grindef</code> again, you would
see the expanded macro the second time.  Presumably the reason
the macro is there at all is that it makes the program look nicer;
we would like to prevent the unnecessary expansions, but still let
<code>grindef</code> display the program in its more attractive form.
This is done with the function <code>displace</code>.
</p>
<p>Anothing thing to worry about with displacing macros is that if
you change the definition of a displacing macro, then your new
definition will not take effect in any form that has already been
displaced.  If you redefine a displacing macro, an existing form using
the macro will use the new definition only if the form has never been
evaluated.
</p>
<a name="displace_002dfun"></a><dl>
<dt><a name="index-displace"></a>Function: <strong>displace</strong> <em>form expansion</em></dt>
<dd><p><em>form</em> must be a list.
<code>displace</code> replaces the car and cdr of <em>form</em> so
that it looks like:
</p><div class="lisp">
<pre class="lisp">(si:displaced <em>original-form</em> <em>expansion</em>)
</pre></div>
<p><em>original-form</em> is equal to <em>form</em> but has a different
top-level cons so that the replacing mentioned above doesn&rsquo;t
affect it.  <code>si:displaced</code> is a macro, which returns
the caddr of its own macro form.  So when the <code>si:displaced</code>
form is given to the evaluator, it &quot;expands&quot; to <em>expansion</em>.
<code>displace</code> returns <em>expansion</em>.
</p></dd></dl>

<p>The grinder knows specially about <code>si:displaced</code> forms,
and will grind such a form as if it had seen the original form
instead of the <code>si:displaced</code> form.
</p>
<p>So if we wanted to rewrite our <code>addone</code> macro as a displacing
macro, instead of writing
</p><div class="lisp">
<pre class="lisp">(macro addone (x)
   (list 'plus '1 (cadr x)))
</pre></div>
<p>we would write
</p><div class="lisp">
<pre class="lisp">(macro addone (x)
   (displace x (list 'plus '1 (cadr x))))
</pre></div>

<p>Of course, we really want to use <code>defmacro</code> to define
most macros.  Since there is no way to get at the original macro form itself
from inside the body of a <code>defmacro</code>, another version of it is
provided:
</p>
<a name="defmacro_002ddisplace_002dfun"></a><dl>
<dt><a name="index-defmacro_002ddisplace"></a>Macro: <strong>defmacro-displace</strong></dt>
<dd><p><code>defmacro-displace</code> is just like <code>defmacro</code> except that
it defines a displacing macro, using the <code>displace</code> function.
</p></dd></dl>

<p>Now we can write the displacing version of <code>addone</code> as
</p><div class="lisp">
<pre class="lisp">(defmacro-displace addone (val)
   (list 'plus '1 val))
</pre></div>
<p>All we have done in this example is change the <code>defmacro</code> into
<code>defmacro-displace</code>.  <code>addone</code> is now a displacing macro.
</p>
<a name="g_t_0022Advanced-Features-of-Defmacro_0022"></a>
<h3 class="section">17.7 &quot;Advanced Features of Defmacro&quot;</h3>
<a name="defmacro_002dhair"></a>
<p>The pattern in a <code>defmacro</code> is more like the <code>lambda</code>-list
of a normal function than revealed above.  It is allowed to
contain certain <code>&amp;</code>-keywords.
</p>
<p><code>&amp;optional</code> is followed by <em>variable</em>, <code>(<em>variable</em>)</code>,
<code>(<em>variable</em> <em>default</em>)</code>, or <code>(<em>variable</em> <em>default</em>
<em>present-p</em>)</code>, exactly the same as in a function.  Note that
<em>default</em> is still a form to be evaluated, even though <em>variable</em>
is not being bound to the value of a form.  <em>variable</em> does not have
to be a symbol; it can be a pattern.  In this case the first form is
disallowed because it is syntactically ambigous.  The pattern must be
enclosed in a singleton list.  If <em>variable</em> is a pattern, <em>default</em>
can be evaluated more than once.
</p>
<p>Using <code>&amp;rest</code> is the same as using a dotted list as the pattern,
except that it may be easier to read and leaves a place to put <code>&amp;aux</code>.
</p>
<p><code>&amp;aux</code> is the same in a macro as in a function, and has nothing to do
with pattern matching.
</p>
<p><code>defmacro</code> has a couple of additional keywords not allowed in functions.
</p>
<a name="g_t_0026body"></a><p><code>&amp;body</code> is identical to <code>&amp;rest</code> except that it informs the editor and the grinder
that the remaining subforms constitute a &quot;body&quot; rather than &quot;arguments&quot;
and should be indented accordingly.
</p>
<a name="g_t_0026list_002dof"></a><p><code>&amp;list-of</code> <em>pattern</em> requires that the corresponding position of the
form being translated must contain a list (or <code>nil</code>).  It
matches <em>pattern</em> against each element of that list.  Each variable
in <em>pattern</em> is bound to a list of the corresponding values in each element
of the list matched by the <code>&amp;list-of</code>.  This may be clarified by an
example.  Suppose we want to be able to say things like
</p><div class="lisp">
<pre class="lisp">(send-commands (aref turtle-table i)
  (forward 100)
  (beep)
  (left 90)
  (pen 'down 'red)
  (forward 50)
  (pen 'up))
</pre></div>
<p>We could define a <code>send-commands</code> macro as follows:
</p><div class="lisp">
<pre class="lisp">(defmacro send-commands (object
		&amp;body &amp;list-of (command . arguments))
  `(let ((o ,object))
     . ,(mapcar #'(lambda (com args) `(send o ',com . ,args))
		command arguments)))
</pre></div>
<p>Note that this example uses <code>&amp;body</code> together with <code>&amp;list-of</code>, so you
don&rsquo;t see the list itself; the list is just the rest of the macro-form.
</p>
<p>You can combine <code>&amp;optional</code> and <code>&amp;list-of</code>.  Consider the following example:
</p><div class="lisp">
<pre class="lisp">(defmacro print-let (x &amp;optional &amp;list-of ((vars vals)
					   '((base 10.)
					     (*nopoint t))))
  `((lambda (,@vars) (print ,x))
    ,@vals))

(print-let foo)  ==&gt;
((lambda (base *nopoint) 
   (print foo))
 12
 t)

(print-let foo ((bar 3)))  ==&gt;
((lambda (bar)
   (print foo))
 3)
</pre></div>
<p>In this example we aren&rsquo;t using <code>&amp;body</code> or anything like it, so you do see
the list itself; that is why you see parentheses around the <code>(bar 3)</code>.
</p>
<a name="g_t_0022Functions-to-Expand-Macros_0022"></a>
<h3 class="section">17.8 &quot;Functions to Expand Macros&quot;</h3>

<p>The following two functions are provided to allow the user to
control expansion of macros; they are often useful for the writer of
advanced macro systems, and in tools that want to examine and understand
code that may contain macros.
</p>
<a name="macroexpand_002d1_002dfun"></a><dl>
<dt><a name="index-macroexpand_002d1"></a>Function: <strong>macroexpand-1</strong> <em>form</em></dt>
<dd><p>If <em>form</em> is a macro form, this expands it (once)
and returns the expanded form.  Otherwise it just
returns <em>form</em>.  <code>macroexpand-1</code> expands <code>defsubst</code>
function forms as well as macro forms.
</p></dd></dl>

<a name="macroexpand_002dfun"></a><dl>
<dt><a name="index-macroexpand"></a>Function: <strong>macroexpand</strong> <em>form</em></dt>
<dd><p>If <em>form</em> is a macro form, this expands it repeatedly
until it is not a macro form and returns the final expansion.
Otherwise, it just returns <em>form</em>.  <code>macroexpand</code> expands <code>defsubst</code>
function forms as well as macro forms.
</p></dd></dl>

<a name="Generalized-Variables"></a>
<h3 class="section">17.9 Generalized Variables</h3>
<a name="index-setf"></a>

<p>In Lisp, a variable is something that can remember one piece of data.  The
main operations on a variable are to recover that piece of data and to
change it.  These might be called <em>access</em> and <em>update</em>.  The concept of
variables named by symbols, explained in <a href="#variable_002dsection">variable-section</a>, can be
generalized to any storage location that can remember one piece of data, no
matter how that location is named.
</p>
<p>For each kind of generalized variable, there are typically two functions
which implement the conceptual <em>access</em> and <em>update</em> operations.  For
example, <code>symeval</code> accesses a symbol&rsquo;s value cell, and <code>set</code> updates
it.  <code>array-leader</code> accesses the contents of an array leader element, and
<code>store-array-leader</code> updates it.  <code>car</code> accesses the car of a cons,
and <code>rplaca</code> updates it.
</p>
<p>Rather than thinking of this as two functions, which operate on a storage
location somehow deduced from their arguments, we can shift our point of
view and think of the access function as a <em>name</em> for the storage
location.  Thus <code>(symeval 'foo)</code> is a name for the value of <code>foo</code>, and
<code>(aref a 105)</code> is a name for the 105th element of the array <code>a</code>.
Rather than having to remember the update function associated with each
access function, we adopt a uniform way of updating storage locations named
in this way, using the <code>setf</code> special form.  This is analogous to the
way we use the <code>setq</code> special form to convert the name of a variable
(which is also a form which accesses it) into a form that updates it.
</p>
<p><code>setf</code> is particularly useful in combination with structure-accessing
macros, such as those created with <code>defstruct</code>, because the knowledge of the
representation of the structure is embedded inside the macro, and the programmer
shouldn&rsquo;t have to know what it is in order to alter an element of the structure.
</p>
<p><code>setf</code> is actually a macro which expands into the appropriate update function.
It has a database, explained below, that associates from access functions to
update functions.
</p>
<a name="setf_002dfun"></a><dl>
<dt><a name="index-setf-1"></a>Macro: <strong>setf</strong> <em>access-form value</em></dt>
<dd><p><code>setf</code> takes a form that <em>accesses</em> something and &quot;inverts&quot; the form to produce a corresponding form to <em>update</em> the thing.
A <code>setf</code> expands into an update form, which stores the result of evaluating
the form <em>value</em> into the place referenced by the <em>access-form</em>.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(setf (array-leader foo 3) 'bar)
		==&gt; (store-array-leader 'bar foo 3)
(setf a 3) ==&gt; (setq a 3)
(setf (plist 'a) '(foo bar)) ==&gt; (setplist 'a '(foo bar))
(setf (aref q 2) 56) ==&gt; (aset 56 q 2)
(setf (cadr w) x) ==&gt; (rplaca (cdr w) x)
</pre></div>

<p>If <em>access-form</em> invokes a macro or a substitutable function, then
<code>setf</code> expands the <em>access-form</em> and starts over again.  This lets you
use <code>setf</code> together with <code>defstruct</code> accessor macros.
</p>
<p>For the sake of efficiency, the code produced by <code>setf</code>
does not preserve order of evaluation of the argument forms.  This is only a problem
if the argument forms have interacting side-effects.  For example,
if you evaluate
</p><div class="lisp">
<pre class="lisp">(setq x 3)
(setf (aref a x) (setq x 4))
</pre></div>
<p>then the form might set element <code>3</code> or element <code>4</code> of the array.
We do not guarantee which one it will do; don&rsquo;t just try it and see
and then depend on it, because it is subject to change without notice.
</p>
<p>Furthermore, the value produced by <code>setf</code> depends on the structure
type and is not guaranteed; <code>setf</code> should be used for side effect
only.
</p></dd></dl>

<p>Besides the <em>access</em> and <em>update</em> conceptual operations on
variables, there is a third basic operation, which we might call
<em>locate</em>.  Given the name of a storage cell, the <em>locate</em> operation
will return the address of that cell as a locative pointer (see
<a href="#locative">locative</a>).  This locative pointer is a first-class Lisp data object
which is a kind of reference to the cell.  It can be passed as an
argument to a function which operates on any kind of variable,
regardless of how it is named.  It can be used to <em>bind</em> the variable,
using the <code>bind</code> subprimitive (see <a href="#bind_002dfun">bind-fun</a>).
</p>
<p>Of course, this can work only on variables whose implementation is really to
store their value in a memory cell.  A variable with an <em>update</em>
operation that encrypts the value and an <em>access</em> operation that decrypts
it could not have the <em>locate</em> operation, since the value per se is not
actually stored anywhere.
</p>
<a name="locf_002dfun"></a><dl>
<dt><a name="index-locf"></a>Macro: <strong>locf</strong> <em>access-form</em></dt>
<dd><p><code>locf</code> takes a form that <em>accesses</em> some cell, and produces
a corresponding form to create a locative pointer to that cell.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(locf (array-leader foo 3)) ==&gt; (ap-leader foo 3)
(locf a) ==&gt; (value-cell-location 'a)
(locf (plist 'a)) ==&gt; (property-cell-location 'a)
(locf (aref q 2)) ==&gt; (aloc q 2)
</pre></div>

<p>If <em>access-form</em> invokes a macro or a substitutable function, then
<code>locf</code> expands the <em>access-form</em> and starts over again.  This lets you
use <code>locf</code> together with <code>defstruct</code> accessor macros.
</p></dd></dl>

<p>Both <code>setf</code> and <code>locf</code> work by means of property lists.
When the form <code>(setf (aref q 2) 56)</code> is expanded, <code>setf</code> looks
for the <code>setf</code> property of the symbol <code>aref</code>.  The value of the
<code>setf</code> property of a symbol should be a cons whose car
is a pattern to be matched with the <em>access-form</em> and whose cdr
is the corresponding <em>update-form</em>, with the symbol <code>si:val</code> in
place of the value to be stored.  The <code>setf</code> property of <code>aref</code>
is a cons whose car is <code>(aref array . subscripts)</code> and whose
cdr is <code>(aset si:val array . subscripts)</code>.  If the transformation that
<code>setf</code> is to do cannot be expressed as a simple pattern, an arbitrary
function may be used: when the form <code>(setf (foo bar) baz)</code>
is being expanded, if the <code>setf</code> property of <code>foo</code> is a symbol,
the function definition of that symbol will be applied to two arguments,
<code>(foo bar)</code> and <code>baz</code>, and the result will be taken to be the
expansion of the <code>setf</code>.
</p>
<p>Similarly, the <code>locf</code> function
uses the <code>locf</code> property, whose value is analogous.  For example, the <code>locf</code> property
of <code>aref</code> is a cons whose car is <code>(aref array . subscripts)</code>
and whose cdr is <code>(aloc array . subscripts)</code>.  There is no <code>si:val</code>
in the case of <code>locf</code>.
</p>
<p>Both <code>setf</code> and <code>locf</code> use <code>getdecl</code> to look for the property,
so you can define the property with <code>defdecl</code> and it will be available
for use at compile time in the rest of the same file.
</p>
<dl>
<dt><a name="index-_0028error_0029-on-sys_003aunknown_002dsetf_002dreference"></a>Condition on sys:unknown-setf-reference: <strong>(<code>error</code>)</strong></dt>
<dt><a name="index-_0028error_0029-on-sys_003aunknown_002dlocf_002dreference"></a>Condition on sys:unknown-locf-reference: <strong>(<code>error</code>)</strong></dt>
<dd><p>These are signaled when <code>setf</code> or <code>locf</code> does not know how to expand
the <em>access-form</em>.  The <code>:form</code> operation on the condition instance
returns the <em>access-form</em>.
</p></dd></dl>

<a name="incf_002dfun"></a><dl>
<dt><a name="index-incf"></a>Macro: <strong>incf</strong> <em>access-form [amount]</em></dt>
<dd><p>Increments the value of a generalized variable.  <code>(incf <em>ref</em>)</code> increments
the value of <em>ref</em> by 1.  <code>(incf <em>ref</em> <em>amount</em>)</code> adds <em>amount</em>
to <em>ref</em> and stores the sum back into <em>ref</em>.
</p>
<p><code>incf</code> expands into a <code>setf</code> form, so <em>ref</em> can be anything that
<code>setf</code> understands as its <em>access-form</em>.  This also means that you
should not depend on the returned value of an <code>incf</code> form.
</p>
<p>You must take great care with <code>incf</code> because it may evaluate
parts of <em>ref</em> more than once.  For example,
</p><div class="lisp">
<pre class="lisp">(incf (car (mumble))) ==&gt;
(setf (car (mumble)) (1+ (car (mumble)))) ==&gt;
(rplaca (mumble) (1+ (car (mumble))))
</pre></div>
<p>The <code>mumble</code> function is called more than once, whiuch may be
significantly inefficient if <code>mumble</code> is expensive and may be
downright wrong if <code>mumble</code> has side-effects.  The same problem
can come up with the <code>decf</code>, <code>push</code>, and <code>pop</code> macros (see below).
</p></dd></dl>

<a name="decf_002dfun"></a><dl>
<dt><a name="index-decf"></a>Macro: <strong>decf</strong> <em>access-form [amount]</em></dt>
<dd><p>Decrements the value of a generalized variable.  <code>(decf <em>ref</em>)</code> decrements
the value of <em>ref</em> by 1.  <code>(decf <em>ref</em> <em>amount</em>)</code> subtracts <em>amount</em>
from <em>ref</em> and stores the difference back into <em>ref</em>.
</p>
<p><code>decf</code> expands into a <code>setf</code> form, so <em>ref</em> can be anything that
<code>setf</code> understands as its <em>access-form</em>.  This also means that you
should not depend on the returned value of a <code>decf</code> form.
</p></dd></dl>

<a name="push_002dfun"></a><dl>
<dt><a name="index-push"></a>Macro: <strong>push</strong> <em>item access-form</em></dt>
<dd><p>Adds an item to the front of a list that is stored in a generalized variable.
<code>(push <em>item</em> <em>ref</em>)</code>
creates a new cons whose car is the result of evaluating <em>item</em>
and whose cdr is the contents of <em>ref</em>, and stores the new cons
into <em>ref</em>.
</p>
<p>The form
</p><div class="lisp">
<pre class="lisp">(push (hairy-function x y z) variable)
</pre></div>
<p>replaces the commonly-used construct
</p><div class="lisp">
<pre class="lisp">(setq variable (cons (hairy-function x y z) variable))
</pre></div>
<p>and is intended to be more explicit and esthetic.
</p>
<p>All the caveats that apply to <code>incf</code> apply to <code>push</code> as well:
forms within <em>ref</em> may be evaluated more than once.  The returned value
of <code>push</code> is not defined.
</p></dd></dl>

<a name="pop_002dfun"></a><dl>
<dt><a name="index-pop"></a>Macro: <strong>pop</strong> <em>access-form</em></dt>
<dd><p>Removes an element from the front of a list that is stored in a generalized variable.
<code>(pop <em>ref</em>)</code> finds the cons in <em>ref</em>, stores the cdr of the cons back into <em>ref</em>,
and returns the car of the cons.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(setq x '(a b c))
(pop x) =&gt; a
x =&gt; (b c)
</pre></div>
<p>All the caveats that apply to <code>incf</code> apply to <code>pop</code> as well:
forms within <em>ref</em> may be evaluated more than once.
</p></dd></dl>


<a name="The-LOOP-Iteration-Macro"></a>
<h2 class="chapter">18 The LOOP Iteration Macro</h2>

<a name="g_t_0022Introduction_0022-1"></a>
<h3 class="section">18.1 &quot;Introduction&quot;</h3>
<a name="loop_002dchapter"></a><a name="index-loop"></a>
<a name="loop_002dfun"></a><a name="index-iteration"></a>

<p><code>loop</code> is a Lisp macro that provides a programmable
iteration facility.  The same <code>loop</code> module operates compatibly in
Zetalisp, Maclisp (PDP-10 and Multics), and NIL, and a
moderately compatible package is under development for the MDL
programming environment.  <code>loop</code> was inspired by the &quot;FOR&quot;
facility of CLISP in InterLisp;  however, it is not compatible and
differs in several details.
</p>
<p>The general approach is that a form introduced by the word
<code>loop</code> generates a single program loop, into which a large variety
of features can be incorporated.  The loop consists of some
initialization (<em>prologue</em>) code, a body that may be executed
several times, and some exit (<em>epilogue</em>) code.  Variables may be
declared local to the loop.  The  features are concerned with loop
variables, deciding when to end the iteration, putting user-written
code into the loop, returning a value from the construct, and
iterating a variable through various real or virtual sets of values.
	The <code>loop</code> form consists of a series of clauses, each
introduced by a keyword symbol.  Forms appearing in or implied by the
clauses of a <code>loop</code> form are classed as those to be executed as
initialization code, body code, and/or exit code;  within each part of
the template filled in by <code>loop</code>, they are executed strictly in
the order implied by the original composition.  Thus, just as in
ordinary Lisp code, side-effects may be used, and one piece of code
may depend on following another for its proper operation.  This is the
principal philosophic difference from InterLisp&rsquo;s &quot;FOR&quot; facility.
	Note that <code>loop</code> forms are intended to look like stylized
English rather than Lisp code.  There is a notably low density of
parentheses, and many of the keywords are accepted in several
synonymous forms to allow writing of more euphonious and grammatical
English.  Some find this notation verbose and distasteful, while
others find it flexible and convenient.  The former are invited to
stick to <code>do</code>.
</p>
<p>Here are some examples to illustrate the use of <code>loop</code>.
</p><div class="lisp">
<pre class="lisp"><a name="print_002delements_002dof_002dlist_002dexample"></a>(defun print-elements-of-list (list-of-elements)
    (loop for element in list-of-elements
	  do (print element)))
</pre></div>
<p>The above function prints each element in its argument, which
should be a list.  It returns <code>nil</code>.
</p><div class="lisp">
<pre class="lisp">(defun gather-alist-entries (list-of-pairs)
    (loop for pair in list-of-pairs
	  collect (car pair)))
</pre></div>
<p><code>gather-alist-entries</code> takes an association list and
returns a list of the &quot;keys&quot;;  that is, <code>(gather-alist-entries
'((foo 1 2) (bar 259) (baz)))</code> returns <code>(foo bar baz)</code>.
</p><div class="lisp">
<pre class="lisp">(defun extract-interesting-numbers (start-value end-value)
   (loop for number from start-value to end-value
	 when (interesting-p number) collect number))
</pre></div>
<p>The above function takes two arguments, which should be
fixnums, and returns a list of all the numbers in that range
(inclusive) which satisfy the predicate <code>interesting-p</code>.
</p><div class="lisp">
<pre class="lisp">(defun find-maximum-element (an-array)
   (loop for i from 0 below (array-dimension-n 1 an-array)
	 maximize (aref an-array i)))
</pre></div>
<p><code>find-maximum-element</code> returns the maximum of the elements
of its argument, a one-dimensional array.  For Maclisp, <code>aref</code>
could be a macro which turns into either <code>funcall</code> or
<code>arraycall</code> depending on what is known about the type of the array.
</p><div class="lisp">
<pre class="lisp">(defun my-remove (object list)
   (loop for element in list
	 unless (equal object element) collect element))
</pre></div>
<p><code>my-remove</code> is like the Lisp function <code>delete</code>, except
that it copies the list rather than destructively splicing out
elements.  This is similar, although not identical, to the
Zetalisp function <code>remove</code>.
</p><div class="lisp">
<pre class="lisp">(defun find-frob (list)
   (loop for element in list
	 when (frobp element) return element
	 finally (ferror nil &quot;No frob found in the list ~S&quot; list)))
</pre></div>
<p>This returns the first element of its list argument which
satisfies the predicate <code>frobp</code>.  If none is found, an error is
generated.
</p>
<a name="g_t_0022Clauses_0022"></a>
<h3 class="section">18.2 &quot;Clauses&quot;</h3>

<p>Internally, <code>loop</code> constructs a <code>prog</code> which includes
variable bindings, pre-iteration (initialization) code,
post-iteration (exit) code, the body of the iteration, and stepping
of variables of iteration to their next values (which happens on
every iteration after executing the body).
	A <em>clause</em> consists of the keyword symbol and any Lisp
forms and keywords that it deals with.  For example,
</p><div class="lisp">
<pre class="lisp">(loop for x in l do (print x)),
</pre></div>
<p>contains two clauses, &quot;<code>for x in l</code>&quot; and &quot;<code>do (print x)</code>&quot;.
Certain of the parts of the clause will be described as being
<em>expressions</em>, e.g <code>(print x)</code> in the above.  An expression can
be a single Lisp form, or a series of forms implicitly collected with
<code>progn</code>.  An expression is terminated by the next following atom,
which is taken to be a keyword.  This syntax allows only the first
form in an expression to be atomic, but makes misspelled keywords
more easily detectable.
	<code>loop</code> uses print-name equality to compare keywords so
that <code>loop</code> forms may be written without package prefixes;  in
Lisp implementations that do not have packages, <code>eq</code> is used for
comparison.
</p>
<p>Bindings and iteration variable steppings may be performed
either sequentially or in
<a name="index-sequential-vs-parallel-binding-and-initialization"></a>
parallel, which affects how the stepping of one iteration variable
may depend on the value of another.  The syntax for distinguishing
the two will be described with the corresponding clauses.  When a set
of things is &quot;in parallel&quot;, all of the bindings produced will be
performed in parallel by a single lambda binding.  Subsequent
bindings will be performed inside of that binding environment.
</p>
<a name="g_t_0022Iteration_002dDriving-Clauses_0022"></a>
<h4 class="subsection">18.2.1 &quot;Iteration-Driving Clauses&quot;</h4>

<p>These clauses all create a <em>variable of iteration</em>, which
is bound locally to the loop and takes on a new value on each
successive iteration.  Note that if more than one iteration-driving
clause is used in the same loop, several variables are created that
all step together through their values;  when any of the iterations
terminates, the entire loop terminates.  Nested iterations are not
generated;  for those, you need a second <code>loop</code> form in the body of
the loop.  In order not to produce strange interactions, iteration
driving clauses are required to precede any clauses that produce
&quot;body&quot; code:  that is, all except those that produce prologue or
epilogue code (<code>initially</code> and <code>finally</code>), bindings
(<code>with</code>), the <code>named</code> clause, and the iteration termination
clauses (<code>while</code> and <code>until</code>).
</p>
<p>Clauses which drive the iteration may be arranged to perform
their testing and stepping either in series or in parallel.  They are
by default grouped in series, which allows the stepping computation of
one clause to use the just-computed values of the iteration variables
of previous clauses.  They may be made to step &quot;in parallel&quot;, as is
the case with the <code>do</code> special form, by &quot;joining&quot; the iteration
clauses with the keyword <code>and</code>.  The form this typically takes is
something like
</p><div class="lisp">
<pre class="lisp">(loop ... for x = (f) and for y = <em>init</em> then (g x) ...)
</pre></div>
<p>which sets <code>x</code> to <code>(f)</code> on every iteration, and binds <code>y</code>
to the value of <em>init</em> for the first iteration, and on every
iteration thereafter sets it to <code>(g x)</code>, where <code>x</code> still has
the value from the <em>previous</em> iteration.  Thus, if the calls to
<code>f</code> and <code>g</code> are not order-dependent, this would be best
written as
</p><div class="lisp">
<pre class="lisp">(loop ... for y = <em>init</em> then (g x) for x = (f) ...)
</pre></div>
<p>because, as a general rule, parallel stepping has more overhead than
sequential stepping.  Similarly, the example
</p><div class="lisp">
<pre class="lisp">(loop for sublist on some-list
      and for previous = 'undefined then sublist
      ...)
</pre></div>
<p>which is equivalent to the <code>do</code> construct
</p><div class="lisp">
<pre class="lisp">(do ((sublist some-list (cdr sublist))
     (previous 'undefined sublist))
    ((null sublist) ...)
  ...)
</pre></div>
<p>in terms of stepping, would be better written as
</p><div class="lisp">
<pre class="lisp">(loop for previous = 'undefined then sublist
      for sublist on some-list
      ...)
</pre></div>

<p>When iteration driving clauses are joined with <code>and</code>, if
the token following the <code>and</code> is not a keyword that introduces an
iteration driving clause, it is assumed to be the same as the keyword
that introduced the most recent clause;  thus, the above example
showing parallel stepping could have been written as
</p><div class="lisp">
<pre class="lisp">(loop for sublist on some-list
      and previous = 'undefined then sublist
      ...)
</pre></div>

<p>The order of evaluation in iteration-driving clauses is that
<a name="index-order-of-evaluation-in-iteration-clauses"></a>
those expressions that are only evaluated once are evaluated in order
at the beginning of the form, during the variable-binding phase, while
those expressions that are evaluated each time around the loop are
evaluated in order in the body.
</p>
<p>One common and simple iteration driving clause is
<code>repeat</code>:
</p><dl compact="compact">
<dt><code>repeat <em>expression</em></code></dt>
<dd><a name="index-repeat"></a>
<p>This evaluates <em>expression</em> (during the variable binding phase),
and causes the <code>loop</code> to iterate that many times.
<em>expression</em> is expected to evaluate to a fixnum.  If
<em>expression</em> evaluates to a zero or negative result, the body code
will not be executed.
</p></dd>
</dl>

<p>All remaining iteration driving clauses are subdispatches of
the keyword <code>for</code>, which is synonomous with <code>as</code>.
<a name="index-for-as"></a>
In all of them a <em>variable of iteration</em> is specified.  Note that,
in general, if an iteration driving clause implicitly supplies an
endtest, the value of this iteration variable is undefined as the loop is exited
(i.e, when the epilogue code is run).  This is
discussed in more detail in section
<a href="#loop_002diteration_002dframework_002dsection">loop-iteration-framework-section</a>.
</p>
<p>Here are all of the varieties of <code>for</code> clauses.  Optional
parts are enclosed in curly brackets.  The <em>data-type</em>s as used
here are discussed fully in section <a href="#loop_002ddata_002dtype_002dsection">loop-data-type-section</a>.
</p>
<dl compact="compact">
<dt><code>for <em>var</em> {<em>data-type</em>} in <em>expr1</em> {by <em>expr2</em>}</code></dt>
<dd><a name="index-for"></a>
<p>This iterates over each of the elements in the list <em>expr1</em>.  If
the <code>by</code> subclause is present, <em>expr2</em> is evaluated once
on entry to the loop
to supply the function to be used to fetch successive sublists,
instead of <code>cdr</code>.
</p>
</dd>
<dt><code>for <em>var</em> {<em>data-type</em>} on <em>expr1</em> {by <em>expr2</em>}</code></dt>
<dd><a name="index-for-1"></a>
<p>This is like the previous <code>for</code> format, except that <em>var</em> is
set to successive sublists of the list instead of successive elements.
Note that since <em>var</em> will always be a list, it is
not meaningful to specify a <em>data-type</em> unless <em>var</em> is
a <em>destructuring pattern</em>, as described in the section on
<em>destructuring</em>, <a href="#loop_002ddestructuring_002dpage">loop-destructuring-page</a>.  Note also that
<code>loop</code> uses a <code>null</code> rather than an <code>atom</code> test to
implement both this and the preceding clause.
</p>
</dd>
<dt><code>for <em>var</em> {<em>data-type</em>} = <em>expr</em></code></dt>
<dd><a name="index-for-2"></a>
<p>On each iteration, <em>expr</em> is evaluated and <em>var</em> is set to the result.
</p>
</dd>
<dt><code>for <em>var</em> {<em>data-type</em>} = <em>expr1</em> then <em>expr2</em></code></dt>
<dd><a name="index-for-3"></a>
<p><em>var</em> is bound to <em>expr1</em> when the loop is entered, and set to
<em>expr2</em> (re-evaluated) at all but the first iteration.  Since
<em>expr1</em> is evaluated during the binding phase, it cannot reference
other iteration variables set before it;  for that, use the following:
</p>
</dd>
<dt><code>for <em>var</em> {<em>data-type</em>} first <em>expr1</em> then <em>expr2</em></code></dt>
<dd><a name="index-for-4"></a>
<p>This sets <em>var</em> to <em>expr1</em> on the first iteration, and to
<em>expr2</em> (re-evaluated) on each succeeding iteration.  The
evaluation of both expressions is performed <em>inside</em> of the
<code>loop</code> binding environment, before the <code>loop</code> body.  This
allows the first value of <em>var</em> to come from the first value of
some other iteration variable, allowing such constructs as
</p><div class="lisp">
<pre class="lisp">(loop for term in poly
      for ans first (car term) then (gcd ans (car term))
      finally (return ans))
</pre></div>

</dd>
<dt><code>for <em>var</em> {<em>data-type</em>} from <em>expr1</em> {to <em>expr2</em>} {by <em>expr3</em>}</code></dt>
<dd><a name="index-for-5"></a>
<a name="loop_002darithmetic_002dstepping"></a><p>This performs numeric iteration.  <em>var</em> is initialized to
<em>expr1</em>, and on each succeeding iteration is incremented by
<em>expr3</em> (default <code>1</code>).  If the <code>to</code> phrase is given, the
iteration terminates when <em>var</em> becomes greater than <em>expr2</em>.
Each of the expressions is evaluated only once, and the <code>to</code> and
<code>by</code> phrases may be written in either order.  <code>downto</code> may be
used instead of <code>to</code>, in which case <em>var</em> is decremented by
the step value, and the endtest is adjusted accordingly.  If
<code>below</code> is used instead of <code>to</code>, or <code>above</code> instead of
<code>downto</code>, the iteration will be terminated before <em>expr2</em> is
reached, rather than after.  Note that the <code>to</code> variant
appropriate for the direction of stepping must be used for the endtest
to be formed correctly;  i.e the code will not work if <em>expr3</em>
is negative or zero.  If no limit-specifying clause is given, then the
direction of the stepping may be specified as being decreasing by
using <code>downfrom</code> instead of <code>from</code>.  <code>upfrom</code> may also be
used instead of <code>from</code>;  it forces the stepping direction to be
increasing.  The <em>data-type</em> defaults to <code>fixnum</code>.
</p>
</dd>
<dt><code>for <em>var</em> {<em>data-type</em>} being <em>expr</em> and its <em>path</em> ...</code></dt>
<dt><code>for <em>var</em> {<em>data-type</em>} being {each|the} <em>path</em> ...</code></dt>
<dd><a name="index-for-6"></a>
<p>This provides a user-definable iteration facility.  <em>path</em> names
the manner in which the iteration is to be performed.  The ellipsis
indicates where various path dependent preposition/expression pairs
may appear.  See the section on Iteration Paths
(<a href="#iteration_002dpath_002dpage">iteration-path-page</a>) for complete documentation.
</p></dd>
</dl>

<a name="g_t_0022Bindings_0022"></a>
<h4 class="subsection">18.2.2 &quot;Bindings&quot;</h4>
<a name="with_002dclause"></a><a name="index-with"></a>
<a name="index-variable-bindings"></a>
<p>The <code>with</code> keyword may be used to establish initial
bindings, that is, variables that are local to the loop but are only
set once, rather than on each iteration.  The <code>with</code> clause looks like:
</p><div class="lisp">
<pre class="lisp"><code>with <em>var1</em> {<em>data-type</em>} {= <em>expr1</em>}
     {and <em>var2</em> {<em>data-type</em>} {= <em>expr2</em>}}...</code>
</pre></div>
<p>If no <em>expr</em> is given, the variable is initialized to the
appropriate value for its data type, usually <code>nil</code>.
	<code>with</code> bindings linked by <code>and</code> are performed in
parallel; those not linked are performed sequentially.  That is,
</p><div class="lisp">
<pre class="lisp">(loop with a = (foo) and b = (bar) and c
      ...)
</pre></div>
<p>binds the variables like
</p><div class="lisp">
<pre class="lisp">((lambda (a b c) ...)
 (foo) (bar) nil)
</pre></div>
<p>whereas
</p><div class="lisp">
<pre class="lisp">(loop with a = (foo) with b = (bar a) with c ...)
</pre></div>
<p>binds the variables like
</p><div class="lisp">
<pre class="lisp">((lambda (a)
    ((lambda (b)
	((lambda (c) ...)
	 nil))
     (bar a)))
 (foo))
</pre></div>
<p>All <em>expr</em>&rsquo;s in <code>with</code> clauses are evaluated in the order they
are written, in lambda expressions surrounding the generated
<code>prog</code>.  The <code>loop</code> expression
</p><div class="lisp">
<pre class="lisp">(loop with a = <em>xa</em> and b = <em>xb</em>
      with c = <em>xc</em>
      for d = <em>xd</em> then (f d)
	and e = <em>xe</em> then (g e d)
      for p in <em>xp</em>
      with q = <em>xq</em>
      ...)
</pre></div>
<p>produces the following binding contour, where <code>t1</code> is a
<code>loop</code>-generated temporary:
</p><div class="lisp">
<pre class="lisp">((lambda (a b)
    ((lambda (c)
	((lambda (d e)
	     ((lambda (p t1)
		  ((lambda (q) ...)
		   <em>xq</em>))
	      nil <em>xp</em>))
	 <em>xd</em> <em>xe</em>))
     <em>xc</em>))
 <em>xa</em> <em>xb</em>)
</pre></div>
<p>Because all expressions in <code>with</code> clauses are evaluated during the
variable binding phase, they are best placed near the front of the
<code>loop</code> form for stylistic reasons.
</p>
<p>For binding more than one variable with no particular
initialization, one may use the construct
</p><div class="lisp">
<pre class="lisp"><code>with <em>variable-list</em> {<em>data-type-list</em>} {and ...}</code>
</pre></div>
<p>as in
</p><div class="lisp">
<pre class="lisp">with (i j k t1 t2) (fixnum fixnum fixnum) ...
</pre></div>
<p>A slightly shorter way of writing this is
</p><div class="lisp">
<pre class="lisp">with (i j k) fixnum and (t1 t2) ...
</pre></div>
<p>These are cases of <em>destructuring</em> which <code>loop</code> handles
specially;  destructuring and data type keywords are discussed in
sections <a href="#loop_002ddestructuring_002dsection">loop-destructuring-section</a> and
<a href="#loop_002ddata_002dtype_002dsection">loop-data-type-section</a>.
</p>
<p>Occasionally there are various implementational reasons 
<a name="loop_002dnodeclare_002dclause"></a>for a variable <em>not</em> to be given a local type declaration.  If
this is necessary, the <code>nodeclare</code> clause may be used:
</p><dl compact="compact">
<dt><code>nodeclare <em>variable-list</em></code></dt>
<dd><a name="index-nodeclare"></a>
<p>The variables in <em>variable-list</em> are noted by <code>loop</code> as not
requiring local type declarations.  Consider the following:
</p><div class="lisp">
<pre class="lisp">(declare (special k) (fixnum k))
(defun foo (l)
    (loop for x in l as k fixnum = (f x) ...))
</pre></div>
<p>If <code>k</code> did not have the <code>fixnum</code> data-type keyword given for
it, then <code>loop</code> would bind it to <code>nil</code>, and some compilers
would complain.  On the other hand, the <code>fixnum</code> keyword also
produces a local <code>fixnum</code> declaration for <code>k</code>;  since <code>k</code>
is special, some compilers will complain (or error out).  The solution
is to do:
</p><div class="lisp">
<pre class="lisp">(defun foo (l)
    (loop nodeclare (k)
	  for x in l as k fixnum = (f x) ...))
</pre></div>
<p>which tells <code>loop</code> not to make that local declaration.  The
<code>nodeclare</code> clause must come <em>before</em> any reference to the
variables so noted.  Positioning it incorrectly will cause this clause
to not take effect, and may not be diagnosed.
</p></dd>
</dl>

<a name="g_t_0022Entrance-and-Exit_0022"></a>
<h4 class="subsection">18.2.3 &quot;Entrance and Exit&quot;</h4>

<dl compact="compact">
<dt><code>initially <em>expression</em></code></dt>
<dd><a name="index-initially"></a>
<p>This puts <em>expression</em> into the <em>prologue</em> of the iteration.  It
will be evaluated before any other initialization code other than the
initial bindings.  For the sake of good style, the <code>initially</code>
clause should therefore be placed after any <code>with</code> clauses but
before the main body of the loop.
</p>
</dd>
<dt><code>finally <em>expression</em></code></dt>
<dd><a name="index-finally"></a>
<a name="loop_002dfinally_002dclause"></a><p>This puts <em>expression</em> into the <em>epilogue</em> of the loop, which is
evaluated when the iteration terminates (other than by an explicit
<code>return</code>).  For stylistic reasons, then, this clause should appear
last in the loop body.  Note that certain clauses may generate code
which terminates the iteration without running the epilogue code;
this behavior is noted with those clauses.  Most notable of these are
those described in the section <a href="#aggregated_002dboolean_002dtests_002dsection">aggregated-boolean-tests-section</a>,
Aggregated Boolean Tests.  This clause may be used to cause the loop
to return values in a non-standard way:
</p><div class="lisp">
<pre class="lisp">(loop for n in l
      sum n into the-sum
      count t into the-count
      finally (return (quotient the-sum the-count)))
</pre></div>
</dd>
</dl>

<a name="g_t_0022Side-Effects_0022"></a>
<h4 class="subsection">18.2.4 &quot;Side Effects&quot;</h4>
<a name="side_002deffects_002dsection"></a><dl compact="compact">
<dt><code>do <em>expression</em></code></dt>
<dt><code>doing <em>expression</em></code></dt>
<dd><a name="index-do-doing"></a>
<p><em>expression</em> is evaluated each time through the loop, as shown in
the <code>print-elements-of-list</code> example on
<a href="#print_002delements_002dof_002dlist_002dexample">print-elements-of-list-example</a>.
</p></dd>
</dl>

<a name="g_t_0022Values_0022"></a>
<h4 class="subsection">18.2.5 &quot;Values&quot;</h4>
<a name="values_002dsection"></a><p>The following clauses accumulate a return value for the
iteration in some manner.  The general form is
</p><div class="lisp">
<pre class="lisp"><code><em>type-of-collection expr</em> {<em>data-type</em>} {into <em>var</em>}</code>
</pre></div>
<p>where <em>type-of-collection</em> is a <code>loop</code> keyword, and <em>expr</em>
is the thing being &quot;accumulated&quot; somehow.  If no <code>into</code> is
specified, then the accumulation will be returned when the <code>loop</code>
terminates.  If there is an <code>into</code>, then when the epilogue of the
<code>loop</code> is reached, <em>var</em> (a variable automatically bound
locally in the loop) will have been set to the accumulated
result and may be used by the epilogue code.  In this way, a user may
accumulate and somehow pass back multiple values from a single
<code>loop</code>, or use them during the loop.  It is safe to reference
these variables during the loop, but they should not be modified
until the epilogue code of the loop is reached.
For example,
</p><div class="lisp">
<pre class="lisp">(loop for x in list
      collect (foo x) into foo-list
      collect (bar x) into bar-list
      collect (baz x) into baz-list
    finally (return (list foo-list bar-list baz-list)))
</pre></div>
<p>has the same effect as
</p><div class="lisp">
<pre class="lisp">(do ((g0001 list (cdr g0001))
     (x) (foo-list) (bar-list) (baz-list))
    ((null g0001)
     (list (nreverse foo-list)
	   (nreverse bar-list)
	   (nreverse baz-list)))
   (setq x (car g0001))
   (setq foo-list (cons (foo x) foo-list))
   (setq bar-list (cons (bar x) bar-list))
   (setq baz-list (cons (baz x) baz-list)))
</pre></div>
<p>except that <code>loop</code> arranges to form the lists in the correct
order, obviating the <code>nreverse</code>s at the end, and allowing the
lists to be examined during the computation.
</p>
<dl compact="compact">
<dt><code>collect <em>expr</em> {into <em>var</em>}</code></dt>
<dt><code>collecting ...</code></dt>
<dd><a name="index-collect-collecting"></a>
<a name="collect_002dclause"></a><p>This causes the values of <em>expr</em> on each iteration to be collected
into a list.
</p>
</dd>
<dt><code>nconc <em>expr</em> {into <em>var</em>}</code></dt>
<dt><code>nconcing ...</code></dt>
<dt><code>append ...</code></dt>
<dt><code>appending ...</code></dt>
<dd><a name="index-nconc-nconcing-append-appending"></a>
<p>These are like <code>collect</code>, but the results are <code>nconc</code>ed or
<code>append</code>ed together as appropriate.
</p><div class="lisp">
<pre class="lisp">(loop for i from 1 to 3
      nconc (list i (* i i)))
  =&gt; (1 1 2 4 3 9)
</pre></div>

</dd>
<dt><code>count <em>expr</em> {into <em>var</em>} {<em>data-type</em>}</code></dt>
<dt><code>counting ...</code></dt>
<dd><a name="index-count-counting"></a>
<p>If <em>expr</em> evaluates non-<code>nil</code>, a counter is incremented.
The <em>data-type</em> defaults to <code>fixnum</code>.
</p>
</dd>
<dt><code>sum <em>expr</em> {<em>data-type</em>} {into <em>var</em>}</code></dt>
<dt><code>summing ...</code></dt>
<dd><a name="index-sum-summing"></a>
<p>Evaluates <em>expr</em> on each iteration and accumulates the sum of all
the values.  <em>data-type</em> defaults to
<code>number</code>, which for all practical purposes is <code>notype</code>.  Note
that specifying <em>data-type</em> implies that <em>both</em> the sum and
the number being summed (the value of <em>expr</em>) will be of that type.
</p>
</dd>
<dt><code>maximize <em>expr</em> {<em>data-type</em>} {into <em>var</em>}</code></dt>
<dt><code>minimize ...</code></dt>
<dd><a name="index-maximize-minimize"></a>
<p>Computes the maximum (or minimum) of <em>expr</em> over all
iterations.  <em>data-type</em> defaults to <code>number</code>.  Note that if
the loop iterates zero times, or if conditionalization prevents the
code of this clause from being executed, the result will be
meaningless.  If <code>loop</code> can determine that the arithmetic being
performed is not contagious (by virtue of <em>data-type</em> being
<code>fixnum</code>, <code>flonum</code>, or <code>small-flonum</code>), then it may choose
to code this by doing an arithmetic comparison rather than calling
either <code>max</code> or <code>min</code>.  As with the <code>sum</code> clause,
specifying <em>data-type</em> implies that both the result of the
<code>max</code> or <code>min</code> operation and the value being maximized or
minimized will be of that type.
</p></dd>
</dl>

<p>Not only may there be multiple accumulations in a
<a name="index-multiple-accumulations"></a>
<code>loop</code>, but a single accumulation may come from multiple
places <em>within the same <code>loop</code> form</em>.  Obviously, the types of
the collection must be compatible.  <code>collect</code>, <code>nconc</code>, and
<code>append</code> may all be mixed, as may <code>sum</code> and <code>count</code>, and
<code>maximize</code> and <code>minimize</code>.  For example,
</p><div class="lisp">
<pre class="lisp">(loop for x in '(a b c) for y in '((1 2) (3 4) (5 6))
      collect x
      append y)
  =&gt; (a 1 2 b 3 4 c 5 6)
</pre></div>
<p>The following computes the average of the entries in the list
<em>list-of-frobs</em>:
</p><div class="lisp">
<pre class="lisp">(loop for x in list-of-frobs
      count t into count-var
      sum x into sum-var
    finally (return (quotient sum-var count-var)))
</pre></div>

<a name="g_t_0022Endtests_0022"></a>
<h4 class="subsection">18.2.6 &quot;Endtests&quot;</h4>
<a name="index-terminating-the-iteration"></a>
<p>The following clauses may be used to provide additional
control over when the iteration gets terminated, possibly causing
exit code (due to <code>finally</code>) to be performed and possibly returning
a value (e.g, from <code>collect</code>).
</p>
<dl compact="compact">
<dt><code>while <em>expr</em></code></dt>
<dd><a name="index-while"></a>
<p>If <em>expr</em> evaluates to <code>nil</code>, the loop is exited, performing
exit code (if any) and returning any accumulated value.  The
test is placed in the body of the loop where it is written.  It may
appear between sequential <code>for</code> clauses.
</p>
</dd>
<dt><code>until <em>expr</em></code></dt>
<dd><a name="index-until"></a>
<p>Identical to <code>while (not <em>expr</em>)</code>.
</p></dd>
</dl>

<p>This may be needed, for example, to step through a strange
data structure, as in
</p><div class="lisp">
<pre class="lisp">(loop until (top-of-concept-tree? concept)
      for concept = <em>expr</em> then (superior-concept concept)
      ...)
</pre></div>
<p>Note that the placement of the <code>while</code> clause before the <code>for</code>
clause is valid in this case because of the definition of this
particular variant of <code>for</code>, which <em>binds</em> <code>concept</code> to
its first value rather than setting it from inside the <code>loop</code>.
</p>
<p>The following may also be of use in terminating the iteration:
<a name="loop_002dfinish_002dfun"></a></p><dl>
<dt><a name="index-loop_002dfinish"></a>Macro: <strong>loop-finish</strong></dt>
<dd><p><code>(loop-finish)</code> causes the iteration to terminate &quot;normally&quot;, the
same as implicit termination by an iteration driving clause, or by the
use of <code>while</code> or <code>until</code>&ndash;the epilogue code (if any) will be
run, and any implicitly collected result will be returned as the value
of the <code>loop</code>.
For example,
</p><div class="lisp">
<pre class="lisp">(loop for x in '(1 2 3 4 5 6)
      collect x
      do (cond ((= x 4) (loop-finish))))
 =&gt; (1 2 3 4)
</pre></div>
<p>This particular example would be better written as <code>until (= x 4)</code>
in place of the <code>do</code> clause.
</p></dd></dl>

<a name="g_t_0022Aggregated-Boolean-Tests_0022"></a>
<h4 class="subsection">18.2.7 &quot;Aggregated Boolean Tests&quot;</h4>
<a name="aggregated_002dboolean_002dtests_002dsection"></a><p>All of these clauses perform some test and may immediately
terminate the iteration depending on the result of that test.
</p>
<dl compact="compact">
<dt><code>always <em>expr</em></code></dt>
<dd><a name="index-always"></a>
<p>Causes the loop to return <code>t</code> if <em>expr</em> <code>always</code> evaluates
non-<code>null</code>.  If <em>expr</em> evaluates to <code>nil</code> the loop
immediately returns <code>nil</code>, without running the epilogue code (if
any, as specified with the <code>finally</code> clause);  otherwise, <code>t</code>
will be returned when the loop finishes, after the epilogue code has
been run.
</p>
</dd>
<dt><code>never <em>expr</em></code></dt>
<dd><a name="index-never"></a>
<p>Causes the loop to return <code>t</code> if <em>expr</em> <code>never</code> evaluates
non-<code>null</code>.  This is equivalent to <code>always (not <em>expr</em>)</code>.
</p>
</dd>
<dt><code>thereis <em>expr</em></code></dt>
<dd><a name="index-thereis"></a>
<p>If <em>expr</em> evaluates non-<code>nil</code>, then the iteration is
terminated, and that value is returned without running the epilogue
code.
</p></dd>
</dl>

<a name="g_t_0022Conditionalization_0022"></a>
<h4 class="subsection">18.2.8 &quot;Conditionalization&quot;</h4>
<a name="index-clause_0028s_0029"></a>
<p>These clauses may be used to &quot;conditionalize&quot; the following
clause.  They may precede any of the side-effecting or value-producing
clauses, such as <code>do</code>, <code>collect</code>, <code>always</code>, or
<code>return</code>.
</p>
<dl compact="compact">
<dt><code>when <em>expr</em></code></dt>
<dt><code>if <em>expr</em></code></dt>
<dd><a name="index-when-if"></a>
<p>If <em>expr</em> evaluates to <code>nil</code>, the following clause will be
skipped, otherwise not.
</p>
</dd>
<dt><code>unless <em>expr</em></code></dt>
<dd><a name="index-unless-1"></a>
<p>This is equivalent to <code>when (not <em>expr</em>))</code>.
</p></dd>
</dl>

<p>Multiple conditionalization clauses may appear in sequence.
If one test fails, then any following tests in the immediate sequence,
as well as the clause being conditionalized, are skipped.
</p>
<p>Multiple clauses may be conditionalized under the same test by
joining them with <code>and</code>, as in
</p><div class="lisp">
<pre class="lisp">(loop for i from a to b
      when (zerop (remainder i 3))
        collect i and do (print i))
</pre></div>
<p>which returns a list of all multiples of <code>3</code> from <code>a</code> to
<code>b</code> (inclusive) and prints them as they are being collected.
</p>
<p>If-then-else conditionals may be written using the <code>else</code> keyword, as in
</p><div class="lisp">
<pre class="lisp">(loop for i from a to b
      when (oddp i)
        collect i into odd-numbers
      else collect i into even-numbers)
</pre></div>
<p>Multiple clauses may appear in an <code>else</code>-phrase, using <code>and</code> to join them
in the same way as above.
</p>
<p>Conditionals may be nested.  For example,
</p><div class="lisp">
<pre class="lisp">(loop for i from a to b
      when (zerop (remainder i 3))
	do (print i)
	and when (zerop (remainder i 2))
	      collect i)
</pre></div>
<p>returns a list of all multiples of <code>6</code> from <code>a</code> to <code>b</code>,
and prints all multiples of <code>3</code> from <code>a</code> to <code>b</code>.
</p>
<p>When <code>else</code> is used with nested conditionals, the &quot;dangling else&quot;
ambiguity is resolved by matching the <code>else</code> with the innermost <code>when</code>
not already matched with an <code>else</code>.  Here is a complicated example.
</p><div class="lisp">
<pre class="lisp">(loop for x in l
      when (atom x)
	when (memq x *distinguished-symbols*)
	  do (process1 x)
	else do (process2 x)
      else when (memq (car x) *special-prefixes*)
	     collect (process3 (car x) (cdr x))
	     and do (memoize x)
           else do (process4 x))
</pre></div>

<p>Useful with the conditionalization clauses is the <code>return</code>
clause, which causes an explicit return of its &quot;argument&quot; as
the value of the iteration, bypassing any epilogue code.  That is,
</p><div class="lisp">
<pre class="lisp"><code>when <em>expr1</em> return <em>expr2</em></code>
</pre></div>
<p>is equivalent to
</p><div class="lisp">
<pre class="lisp"><code>when <em>expr1</em> do (return <em>expr2</em>)</code>
</pre></div>
<p>Conditionalization of one of the &quot;aggregated boolean value&quot;
clauses simply causes the test that would cause the iteration to
terminate early not to be performed unless the condition succeeds.
For example,
</p><div class="lisp">
<pre class="lisp">(loop for x in l
      when (significant-p x)
	do (print x) (princ &quot;is significant.&quot;)
	and thereis (extra-special-significant-p x))
</pre></div>
<p>does not make the <code>extra-special-significant-p</code> check unless the
<code>significant-p</code> check succeeds.
</p>
<p>The format of a conditionalized clause is typically something
like
</p><div class="lisp">
<pre class="lisp"><code>when <em>expr1</em> <em>keyword</em> <em>expr2</em></code>
</pre></div>
<p>If <em>expr2</em> is the keyword <code>it</code>, then a variable is generated to
hold the value of <em>expr1</em>, and that variable gets substituted for
<em>expr2</em>.  Thus, the composition
</p><div class="lisp">
<pre class="lisp"><code>when <em>expr</em> return it</code>
</pre></div>
<p>is equivalent to the clause
</p><div class="lisp">
<pre class="lisp"><code>thereis <em>expr</em></code>
</pre></div>
<p>and one may collect all non-null values in an iteration by saying
</p><div class="lisp">
<pre class="lisp"><code>when <em>expression</em> collect it</code>
</pre></div>
<p>If multiple clauses are joined with <code>and</code>, the <code>it</code> keyword
may only be used in the first.  If multiple <code>when</code>s,
<code>unless</code>es, and/or <code>if</code>s occur in sequence, the value
substituted for <code>it</code> will be that of the last test performed.
The <code>it</code> keyword is not recognized in an <code>else</code>-phrase.
</p>
<a name="g_t_0022Miscellaneous-Other-Clauses_0022"></a>
<h4 class="subsection">18.2.9 &quot;Miscellaneous Other Clauses&quot;</h4>

<dl compact="compact">
<dt><code>named <em>name</em></code></dt>
<dd><a name="index-named"></a>
<p>This gives a name of <em>name</em> to the <code>prog</code> that <code>loop</code> generates,
so that one may use the <code>return-from</code> form to return explicitly out of
that particular <code>loop</code>:
</p><div class="lisp">
<pre class="lisp">(loop named sue
      ...
      do (loop ... do (return-from sue <em>value</em>) ...)
      ...)
</pre></div>
<p>The <code>return-from</code> form shown causes <em>value</em> to be immediately
returned as the value of the outer <code>loop</code>.  Only one name may be
given to any particular <code>loop</code> construct.
This feature does not exist in the Maclisp version of <code>loop</code>, since
Maclisp does not support &quot;named progs&quot;.
</p>
</dd>
<dt><code>return <em>expression</em></code></dt>
<dd><a name="index-return-1"></a>
<p>Immediately returns the value of <em>expression</em> as the value of the
loop, without running the epilogue code.  This is most useful with
some sort of conditionalization, as discussed in the previous
section.  Unlike most of the other clauses, <code>return</code> is not
considered to &quot;generate body code&quot;, so it is allowed to occur between
iteration clauses, as in
</p><div class="lisp">
<pre class="lisp">(loop for entry in list
      when (not (numberp entry))
	return (error ...)
      as frob = (times entry 2)
      ...)
</pre></div>
<p>If one instead desires the loop to have some return value when it
finishes normally, one may place a call to the <code>return</code> function in the
epilogue (with the <code>finally</code> clause, <a href="#loop_002dfinally_002dclause">loop-finally-clause</a>).
</p></dd>
</dl>

<a name="g_t_0022Loop-Synonyms_0022"></a>
<h3 class="section">18.3 &quot;Loop Synonyms&quot;</h3>

<a name="define_002dloop_002dmacro_002dfun"></a><dl>
<dt><a name="index-define_002dloop_002dmacro"></a>Macro: <strong>define-loop-macro</strong> <em>keyword</em></dt>
<dd><p>May be used to make <em>keyword</em>, a <code>loop</code> keyword (such as
<code>for</code>), into a Lisp macro that may introduce a <code>loop</code> form.
For example, after evaluating
</p><div class="lisp">
<pre class="lisp">(define-loop-macro for),
</pre></div>
<p>one may now write an iteration as
</p><div class="lisp">
<pre class="lisp">(for i from 1 below n do ...)
</pre></div>
</dd></dl>
<p>This facility exists primarily for diehard users of a
predecessor of <code>loop</code>.  Its unconstrained use is not recommended,
as it tends to decrease the transportability of the code and
needlessly uses up a function name.
</p>
<a name="g_t_0022Data-Types_0022-1"></a>
<h3 class="section">18.4 &quot;Data Types&quot;</h3>
<a name="loop_002ddata_002dtype_002dsection"></a><a name="loop_002ddata_002dtype_002dpage"></a><a name="index-data-type-keywords"></a>
<p>In many of the clause descriptions, an optional <em>data-type</em>
is shown.  A <em>data-type</em> in this sense is an atomic symbol, and is
recognizable as such by <code>loop</code>.  These are used for declaration
and initialization purposes;  for example, in
</p><div class="lisp">
<pre class="lisp">(loop for x in l
      maximize x flonum into the-max
      sum x flonum into the-sum
      ...)
</pre></div>
<p>the <code>flonum</code> data-type keyword for the <code>maximize</code> clause
says that the result of the <code>max</code> operation, and its &quot;argument&quot;
(<code>x</code>), will both be flonums;  hence <code>loop</code> may choose to code
this operation specially since it knows there can be no contagious
arithmetic.  The <code>flonum</code> data-type keyword for the <code>sum</code>
clause behaves similarly, and in addition causes <code>the-sum</code> to be
correctly initialized to <code>0.0</code> rather than <code>0</code>.  The
<code>flonum</code> keywords will also cause the variables <code>the-max</code> and
<code>the-sum</code> to be declared to be <code>flonum</code>, in implementations
where such a declaration exists.  In general, a numeric data-type more
specific than <code>number</code>, whether explicitly specified or defaulted,
is considered by <code>loop</code> to be license to generate code using
type-specific arithmetic functions where reasonable.  The following
data-type keywords are recognized by <code>loop</code> (others may be
defined;  for that, consult the source code):
</p>
<dl compact="compact">
<dt><code>fixnum</code></dt>
<dd><p>An implementation-dependent limited range integer.
</p></dd>
<dt><code>flonum</code></dt>
<dd><p>An implementation-dependent limited precision floating point number.
</p></dd>
<dt><code>small-flonum</code></dt>
<dd><p>This is recognized in the Zetalisp implementation only, where its
only significance is for initialization purposes, since no such
declaration exists.
</p></dd>
<dt><code>integer</code></dt>
<dd><p>Any integer (no range restriction).
</p></dd>
<dt><code>number</code></dt>
<dd><p>Any number.
</p></dd>
<dt><code>notype</code></dt>
<dd><p>Unspecified type (i.e, anything else).
</p></dd>
</dl>
<p>Note that explicit specification of a non-numeric type for a
numeric operation (such as the <code>summing</code> clause) may cause a variable
to be initialized to <code>nil</code> when it should be <code>0</code>.
	If local data-type declarations must be inhibited, one can use
the <code>nodeclare</code> clause, which is described on
<a href="#loop_002dnodeclare_002dclause">loop-nodeclare-clause</a>.
</p>
<a name="g_t_0022Destructuring_0022"></a>
<h3 class="section">18.5 &quot;Destructuring&quot;</h3>
<a name="loop_002ddestructuring_002dsection"></a><a name="loop_002ddestructuring_002dpage"></a><p><em>Destructuring</em> provides one with the ability to
&quot;simultaneously&quot; assign or bind multiple variables to components of
some data structure.  Typically this is used with list structure.
For example,
</p><div class="lisp">
<pre class="lisp">(loop with (foo . bar) = '(a b c) ...)
</pre></div>
<p>has the effect of binding <code>foo</code> to <code>a</code> and <code>bar</code> to <code>(b
c)</code>.
	<code>loop</code>&rsquo;s destructuring support is intended to parallel if
not augment that provided by the host Lisp implementation, with a goal
of minimally providing destructuring over list structure patterns.
Thus, in Lisp implementations with no system destructuring support at
all, one may still use list-structure patterns as <code>loop</code> iteration
variables and in <code>with</code> bindings.  In NIL, <code>loop</code> also
supports destructuring over vectors.
	One may specify the data types of the components of a pattern
by using a corresponding pattern of the data type keywords in place of
a single data type keyword.  This syntax remains unambiguous because
wherever a data type keyword is possible, a <code>loop</code> keyword is
the only other possibility.  Thus, if one wants to do
</p><div class="lisp">
<pre class="lisp">(loop for x in l
      as i fixnum = (car x)
      and j fixnum = (cadr x)
      and k fixnum = (cddr x)
      ...)
</pre></div>
<p>and no reference to <code>x</code> is needed, one may instead write
</p><div class="lisp">
<pre class="lisp">(loop for (i j . k) (fixnum fixnum . fixnum) in l ...)
</pre></div>
<p>To allow some abbreviation of the data type pattern, an atomic
component of the data type pattern is considered to state that all
components of the corresponding part of the variable pattern are of
that type.  That is, the previous form could be written as
</p><div class="lisp">
<pre class="lisp">(loop for (i j . k) fixnum in l ...)
</pre></div>
<p>This generality allows binding of multiple typed variables in a
reasonably concise manner, as in
</p><div class="lisp">
<pre class="lisp">(loop with (a b c) and (i j k) fixnum ...)
</pre></div>
<p>which binds <code>a</code>, <code>b</code>, and <code>c</code> to <code>nil</code> and <code>i</code>,
<code>j</code>, and <code>k</code> to <code>0</code> for use as temporaries during the
iteration, and declares <code>i</code>, <code>j</code>, and <code>k</code> to be fixnums
for the benefit of the compiler.
</p><div class="lisp">
<pre class="lisp">(defun map-over-properties (fn symbol)
   (loop for (propname propval) on (plist symbol) by 'cddr
	 do (funcall fn symbol propname propval)))
</pre></div>
<p>maps <em>fn</em> over the properties on <em>symbol</em>, giving it arguments
of the symbol, the property name, and the value of that property.
	In Lisp implementations where <code>loop</code> performs its own
destructuring, notably Multics Maclisp and Zetalisp, one can
cause <code>loop</code> to use already provided destructuring support
instead:
<a name="si_003aloop_002duse_002dsystem_002ddestructuring_003f_002dvar"></a></p><dl>
<dt><a name="index-si_003aloop_002duse_002dsystem_002ddestructuring_003f"></a>Variable: <strong>si:loop-use-system-destructuring?</strong></dt>
<dd><p>This variable exists <em>only</em> in <code>loop</code> implementations in Lisps
that do not provide destructuring support in the default environment.
It is by default <code>nil</code>.  If changed, then <code>loop</code> will behave
as it does in Lisps that <em>do</em> provide destructuring support:
destructuring binding will be performed using <code>let</code>, and
destructuring assignment will be performed using <code>desetq</code>.
Presumably if one&rsquo;s personalized environment supplies these macros,
then one should set this variable to <code>t</code>;  however, there is
little if any efficiency loss if this is not done.
</p></dd></dl>

<a name="g_t_0022The-Iteration-Framework_0022"></a>
<h3 class="section">18.6 &quot;The Iteration Framework&quot;</h3>
<a name="loop_002diteration_002dframework_002dsection"></a><a name="loop_002diteration_002dframework_002dpage"></a><p>This section describes the way <code>loop</code> constructs
iterations.  It is necessary if you will be writing your own iteration
paths, and may be useful in clarifying what <code>loop</code> does with its
input.
	<code>loop</code> considers the act of <em>stepping</em> to have four
possible parts.  Each iteration-driving clause has some or all of these
four parts, which are executed in this order:
</p><dl compact="compact">
<dt><em>pre-step-endtest</em></dt>
<dd><p>This is an endtest which determines if it is safe to step to the next
value of the iteration variable.
</p></dd>
<dt><em>steps</em></dt>
<dd><p>Variables that get &quot;stepped&quot;.  This is internally manipulated as a
list of the form <code>(<em>var1</em> <em>val1</em> <em>var2</em> <em>val2</em>
..)</code>;  all of those variables are stepped in parallel, meaning that
all of the <em>val</em>s are evaluated before any of the <em>var</em>s are
set.
</p></dd>
<dt><em>post-step-endtest</em></dt>
<dd><p>Sometimes you can&rsquo;t see if you are done until you step to the next
value;  that is, the endtest is a function of the stepped-to value.
</p></dd>
<dt><em>pseudo-steps</em></dt>
<dd><p>Other things that need to be stepped.  This is typically used for
internal variables that are more conveniently stepped here, or to
set up iteration variables that are functions of some internal
variable(s) actually driving the iteration.  This is a list
like <em>steps</em>, but the variables in it do not get stepped in
parallel.
</p></dd>
</dl>
<p>The above alone is actually insufficient in just about all
iteration driving clauses that <code>loop</code> handles.  What is missing
is that in most cases the stepping and testing for the first time
through the loop is different from that of all other times.  So, what
<code>loop</code> deals with is two four-tuples as above;  one for the first
iteration, and one for the rest.  The first may be thought of as
describing code that immediately precedes the loop in the <code>prog</code>,
and the second as following the body code&ndash;in fact, <code>loop</code> does
just this, but severely perturbs it in order to reduce code
duplication.  Two lists of forms are constructed in parallel:  one is
the first-iteration endtests and steps, the other the
remaining-iterations endtests and steps.  These lists have dummy
entries in them so that identical expressions will appear in the same
position in both.  When <code>loop</code> is done parsing all of the clauses,
these lists get merged back together such that corresponding identical
expressions in both lists are not duplicated unless they are &quot;simple&quot;
and it is worth doing.
	Thus, one <em>may</em> get some duplicated code if one has
multiple iterations.  Alternatively, <code>loop</code> may decide to use and
test a flag variable that indicates whether one iteration has been
performed.  In general, sequential iterations have less overhead than
parallel iterations, both from the inherent overhead of stepping
multiple variables in parallel, and from the standpoint of potential
code duplication.
	One other point that must be noted about parallel stepping is
that although the user iteration variables are guaranteed to be
stepped in parallel, the placement of the endtest for any particular
iteration may be either before or after the stepping.  A notable case
of this is
</p><div class="lisp">
<pre class="lisp">(loop for i from 1 to 3 and dummy = (print 'foo)
      collect i)
  =&gt; (1 2 3)
</pre></div>
<p>but prints <code>foo</code> <em>four</em> times.  Certain other constructs, such
as <code>for <em>var</em> on</code>, may or may not do this depending on the
particular construction.
	This problem also means that it may not be safe to examine an
iteration variable in the epilogue of the loop form.  As a general
rule, if an iteration driving clause implicitly supplies an endtest,
then one cannot know the state of the iteration variable when the loop
terminates.  Although one can guess on the basis of whether the
iteration variable itself holds the data upon which the endtest is
based, that guess <em>may</em> be wrong.  Thus,
</p><div class="lisp">
<pre class="lisp">(loop for subl on <em>expr</em>
      ...
      finally (f subl))
</pre></div>
<p>is incorrect, but
</p><div class="lisp">
<pre class="lisp">(loop as frob = <em>expr</em> while (g frob)
      ...
      finally (f frob))
</pre></div>
<p>is safe because the endtest is explicitly dissociated from the
stepping.
</p>
<a name="g_t_0022Iteration-Paths_0022"></a>
<h3 class="section">18.7 &quot;Iteration Paths&quot;</h3>
<a name="iteration_002dpath_002dpage"></a><p>Iteration paths provide a mechanism for user extension of
iteration-driving clauses.  The interface is constrained so that the
definition of a path need not depend on much of the internals of
<code>loop</code>.  The typical form of an iteration path is
</p><div class="lisp">
<pre class="lisp">for <em>var</em> {<em>data-type</em>} being {each|the} <em>pathname</em> {<em>preposition1</em> <em>expr1</em>}...
</pre></div>
<p><em>pathname</em> is an atomic symbol which is defined as a <code>loop</code> path
function.  The usage and defaulting of <em>data-type</em> is up to the
path function.  Any number of preposition/expression pairs may be
present; the prepositions allowable for any particular path are
defined by that path.  For example,
</p><div class="lisp">
<pre class="lisp">(loop for x being the array-elements of my-array from 1 to 10
      ...)
</pre></div>
<p>To enhance readability, pathnames are usually defined in both the
singular and plural forms;  this particular example could have been
written as
</p><div class="lisp">
<pre class="lisp">(loop for x being each array-element of my-array from 1 to 10
      ...)
</pre></div>

<p>Another format, which is not so generally applicable, is
</p><div class="lisp">
<pre class="lisp">for <em>var</em> {<em>data-type</em>} being <em>expr0</em> and its <em>pathname</em> {<em>preposition1</em> <em>expr1</em>}...
</pre></div>
<p>In this format, <em>var</em> takes on the value of <em>expr0</em> the first
time through the loop.  Support for this format is usually limited to
paths which step through some data structure, such as the &quot;superiors&quot;
of something.  Thus, we can hypothesize the <code>cdrs</code> path, such that
</p><div class="lisp">
<pre class="lisp">(loop for x being the cdrs of '(a b c . d) collect x)
 =&gt; ((b c . d) (c . d) d)
</pre></div>
<p>but
</p><div class="lisp">
<pre class="lisp">(loop for x being '(a b c . d) and its cdrs collect x)
 =&gt; ((a b c . d) (b c . d) (c . d) d)
</pre></div>
<p>To satisfy the anthropomorphic among you, <code>his</code>, <code>her</code>, or
<code>their</code> may be substituted for the <code>its</code> keyword, as may
<code>each</code>.  Egocentricity is not condoned.  Some example uses of
iteration paths are shown in section <a href="#predefined_002dpaths_002dsection">predefined-paths-section</a>.
</p>
<p>Very often, iteration paths step internal variables which the
<a name="loop_002dusing_002dcrock"></a>user does not specify, such as an index into some data-structure.
Although in most cases the user does not wish to be concerned with
such low-level matters, it is occasionally useful to have a handle on
such things.  <code>loop</code> provides an additional syntax with which one
may provide a variable name to be used as an &quot;internal&quot; variable by an
iteration path, with the <code>using</code> &quot;prepositional phrase&quot;.
<a name="index-using"></a>
The <code>using</code> phrase is placed with the other phrases associated
with the path, and contains any number of keyword/variable-name pairs:
</p><div class="lisp">
<pre class="lisp">(loop for x being the array-elements of a using (index i)
      ...)
</pre></div>
<p>which says that the variable <code>i</code> should be used to hold the index
of the array being stepped through.  The particular keywords which may
be used are defined by the iteration path;  the <code>index</code> keyword is
recognized by all <code>loop</code> sequence paths (section
<a href="#loop_002dsequence_002dsection">loop-sequence-section</a>).  Note that any individual <code>using</code>
phrase applies to only one path;  it is parsed along with the
&quot;prepositional phrases&quot;.  It is an error if the path does not call for
a variable using that keyword.
</p>
<p>By special dispensation, if a <em>pathname</em> is not recognized,
then the <code>default-loop-path</code> path will be invoked upon a syntactic
transformation of the original input. Essentially, the <code>loop</code> fragment
<a name="index-in"></a>
</p><div class="lisp">
<pre class="lisp">for <em>var</em> being <em>frob</em>
</pre></div>
<p>is taken as if it were
</p><div class="lisp">
<pre class="lisp">for <em>var</em> being default-loop-path in <em>frob</em>
</pre></div>
<p>and
</p><div class="lisp">
<pre class="lisp">for <em>var</em> being <em>expr</em> and its <em>frob</em> ...
</pre></div>
<p>is taken as if it were
</p><div class="lisp">
<pre class="lisp">for <em>var</em> being <em>expr</em> and its default-loop-path in <em>frob</em>
</pre></div>
<p>Thus, this &quot;undefined pathname hook&quot; only works if the
<code>default-loop-path</code> path is defined.  Obviously, the use of this
&quot;hook&quot; is competitive, since only one such hook may be in use, and the
potential for syntactic ambiguity exists if <em>frob</em> is the name of
a defined iteration path.  This feature is not for casual use;  it is
intended for use by large systems that wish to use a special
syntax for some feature they provide.
</p>
<a name="g_t_0022Pre_002dDefined-Paths_0022"></a>
<h4 class="subsection">18.7.1 &quot;Pre-Defined Paths&quot;</h4>
<a name="predefined_002dpaths_002dsection"></a><p><code>loop</code> comes with two pre-defined iteration path
functions;  one implements a <code>mapatoms</code>-like iteration path
facility and the other is used for defining iteration paths for
stepping through sequences.
</p>
<a name="g_t_0022The-Interned_002dSymbols-Path_0022"></a>
<h4 class="subsubsection">18.7.1.1 &quot;The Interned-Symbols Path&quot;</h4>
<a name="index-interned_002dsymbols"></a>
<a name="index-in-1"></a>
<p>The <code>interned-symbols</code> iteration path is like a
<code>mapatoms</code> for <code>loop</code>.
</p><div class="lisp">
<pre class="lisp">(loop for sym being interned-symbols ...)
</pre></div>
<p>iterates over all of the symbols in the current package and its
superiors (or, in Maclisp, the current obarray).  This is the same set
of symbols over which <code>mapatoms</code> iterates, although not
necessarily in the same order.  The particular package to look in may
be specified as in
</p><div class="lisp">
<pre class="lisp">(loop for sym being the interned-symbols in <em>package</em> ...)
</pre></div>
<p>which is like giving a second argument to <code>mapatoms</code>.
	In Lisp implementations with some sort of hierarchical package
structure such as Zetalisp, one may restrict the iteration to
be over just the package specified and not its superiors, by using the
<code>local-interned-symbols</code> path:
</p><div class="lisp">
<pre class="lisp">(loop for sym being the local-interned-symbols  {in <em>package</em>}
      ...)
</pre></div>
<p>Example:
</p><div class="lisp">
<pre class="lisp">(defun my-apropos (sub-string &amp;optional (pkg package))
    (loop for x being the interned-symbols in pkg
	  when (string-search sub-string x)
	    when (or (boundp x) (fboundp x) (plist x))
	      do (print-interesting-info x)))
</pre></div>
<p>In the Zetalisp and NIL implementations of <code>loop</code>, a package
specified with the <code>in</code> preposition may be anything acceptable to
the <code>pkg-find-package</code> function.  The code generated by this path
will contain calls to internal <code>loop</code> functions, with the effect
that it will be transparent to changes to the implementation of
packages.  In the Maclisp implementation, the obarray <em>must</em> be an
array pointer, <em>not</em> a symbol with an <code>array</code> property.
</p>
<a name="g_t_0022Sequence-Iteration_0022"></a>
<h4 class="subsubsection">18.7.1.2 &quot;Sequence Iteration&quot;</h4>
<a name="loop_002dsequence_002dsection"></a><a name="loop_002dsequence_002dpage"></a><p>One very common form of iteration is done over the elements
of some object that is accessible by means of an integer index.
<code>loop</code> defines an iteration path function for doing this in a
general way and provides a simple interface to allow users to define
iteration paths for various kinds of &quot;indexable&quot; data.
</p>
<a name="define_002dloop_002dsequence_002dpath_002dfun"></a><dl>
<dt><a name="index-define_002dloop_002dsequence_002dpath"></a>Macro: <strong>define-loop-sequence-path</strong></dt>
<dd><p><code>(define-loop-sequence-path <em>path-name-or-names</em>
    <em>fetch-fun</em> <em>size-fun</em>
    <em>sequence-type</em> <em>default-var-type</em>)</code>
<em>path-name-or-names</em> is either an atomic path name or list of path
names.  <em>fetch-fun</em> is a function of two arguments, the sequence
and the index of the item to be fetched.  (Indexing is assumed to be
zero-origined.)  <em>size-fun</em> is a function of one argument, the
sequence;  it should return the number of elements in the sequence.
<em>sequence-type</em> is the name of the data-type of the sequence, and
<em>default-var-type</em> the name of the data-type of the elements of
the sequence.  These last two items are optional.
</p></dd></dl>

<p>The Zetalisp implementation of <code>loop</code> utilizes the
Zetalisp array manipulation primitives to define both
<code>array-element</code> and <code>array-elements</code> as iteration paths:
<a name="index-array_002delements"></a>
<code>(define-loop-sequence-path (array-element array-elements)
    aref array-active-length)</code>
Then, the <code>loop</code> clause
<a name="index-of"></a>
</p><div class="lisp">
<pre class="lisp">for <em>var</em> being the array-elements of <em>array</em>
</pre></div>
<p>will step <em>var</em> over the elements of <em>array</em>, starting from
<code>0</code>.  The sequence path function also accepts <code>in</code> as a
synonym for <code>of</code>.
	The range and stepping of the iteration may be specified with
the use of all of the same keywords which are accepted by the <code>loop</code>
arithmetic stepper (<code>for <em>var</em> from ...</code>);  they are
<code>by</code>, <code>to</code>, <code>downto</code>, <code>from</code>, <code>downfrom</code>,
<code>below</code>, and <code>above</code>, and are interpreted in the same manner.
Thus,
</p><div class="lisp">
<pre class="lisp">(loop for <em>var</em> being the array-elements of <em>array</em>
	  from 1 by 2
      ...)
</pre></div>
<p>steps <em>var</em> over all of the odd elements of <em>array</em>, and
</p><div class="lisp">
<pre class="lisp">(loop for <em>var</em> being the array-elements of <em>array</em>
	  downto 0
      ...)
</pre></div>
<p>steps in &quot;reverse&quot; order.
</p><div class="lisp">
<pre class="lisp">(define-loop-sequence-path (vector-elements vector-element)
    vref vector-length notype notype)
</pre></div>
<p>is how the <code>vector-elements</code> iteration path can be defined in NIL
(which it is).  One can then do such things as
</p><div class="lisp">
<pre class="lisp">(defun cons-a-lot (item &amp;restv other-items)
    (and other-items
	 (loop for x being the vector-elements of other-items
	       collect (cons item x))))
</pre></div>
<p>All such sequence iteration paths allow one to specify the
variable to be used as the index variable, by use of the <code>index</code>
keyword with the <code>using</code> prepositional phrase, as described (with
an example) on <a href="#loop_002dusing_002dcrock">loop-using-crock</a>.
</p>

<a name="g_t_0022Defining-Paths_0022"></a>
<h4 class="subsection">18.7.2 &quot;Defining Paths&quot;</h4>

<p>This section and the next may not be of interest to those
not interested in defining their own iteration paths.
	 In addition to the code which defines the iteration (section
<a href="#loop_002diteration_002dframework_002dsection">loop-iteration-framework-section</a>), a <code>loop</code> iteration clause (e.g
a <code>for</code> or <code>as</code> clause) produces variables to be bound and
pre-iteration (<em>prologue</em>) code.  This breakdown allows a
user-interface to <code>loop</code> which does not have to depend on or know
about the internals of <code>loop</code>.  To complete this separation, the
iteration path mechanism parses the clause before giving it to the user
function that will return those items.  A function to generate code for
a path may be declared to <code>loop</code> with the <code>define-loop-path</code>
function:
<a name="define_002dloop_002dpath_002dfun"></a></p><dl>
<dt><a name="index-define_002dloop_002dpath"></a>Macro: <strong>define-loop-path</strong></dt>
<dd><p><code>(define-loop-path <em>pathname-or-names</em> <em>path-function</em>
     <em>list-of-allowable-prepositions</em>
     <em>datum-1</em> <em>datum-2</em> ...)</code>
This defines <em>path-function</em> to be the handler for the path(s)
<em>pathname-or-names</em>, which may be either a symbol or a list of
symbols.  Such a handler should follow the conventions described
below.  The <em>datum-i</em> are optional;  they are passed in to
<em>path-function</em> as a list.
</p></dd></dl>

<p>The handler will be called with the following arguments:
</p><dl compact="compact">
<dt><em>path-name</em></dt>
<dd><p>The name of the path that caused the path function to be invoked.
</p></dd>
<dt><em>variable</em></dt>
<dd><p>The &quot;iteration variable&quot;.
</p></dd>
<dt><em>data-type</em></dt>
<dd><p>The data type supplied with the iteration variable, or <code>nil</code> if
none was supplied.
</p></dd>
<dt><em>prepositional-phrases</em></dt>
<dd><p>This is a list with entries of the form <em>(preposition
expression)</em>, in the order in which they were collected.  This may
also include some supplied implicitly (e.g an <code>of</code> phrase when
the iteration is inclusive, and an <code>in</code> phrase for the
<code>default-loop-path</code> path); the ordering will show the order of
evaluation that should be followed for the expressions.
</p></dd>
<dt><em>inclusive?</em></dt>
<dd><p>This is <code>t</code> if <em>variable</em> should have the starting point of
the path as its value on the first iteration (by virtue of being
specified with syntax like <code>for <em>var</em> being <em>expr</em> and its
<em>pathname</em></code>), <code>nil</code> otherwise.  When <code>t</code>, <em>expr</em>
will appear in <em>prepositional-phrases</em> with the <code>of</code>
preposition;  for example, <code>for x being foo and its cdrs</code> gets
<em>prepositional-phrases</em> of <code>((of foo))</code>.
</p></dd>
<dt><em>allowed-prepositions</em></dt>
<dd><p>This is the list of allowable prepositions declared for the pathname
that caused the path function to be invoked.  It and <em>data</em>
(immediately below) may be used by the path function such that a
single function may handle similar paths.
</p></dd>
<dt><em>data</em></dt>
<dd><p>This is the list of &quot;data&quot; declared for the pathname that caused the
path function to be invoked.  It may, for instance, contain a
canonicalized pathname, or a set of functions or flags to aid the
path function in determining what to do.  In this way, the same
path function may be able to handle different paths.
</p></dd>
</dl>
<p>The handler should return a list of either six or ten
elements:
</p><dl compact="compact">
<dt><em>variable-bindings</em></dt>
<dd><p>This is a list of variables that need to be bound.  The entries in it
may be of the form <em>variable</em>, (<em>variable</em> <em>expression</em>),
or (<em>variable</em> <em>expression</em> <em>data-type</em>).  Note that it is
the responsibility of the handler to make sure the iteration variable
gets bound.  All of these variables will be bound in parallel;
if initialization of one depends on others, it should be done with a
<code>setq</code> in the <em>prologue-forms</em>.  Returning only the variable
without any initialization expression is not allowed if the variable
is a destructuring pattern.
</p></dd>
<dt><em>prologue-forms</em></dt>
<dd><p>This is a list of forms that should be included in the <code>loop</code>
prologue.
</p></dd>
<dt><em>the four items of the iteration specification</em></dt>
<dd><p>These are the four items described in section
<a href="#loop_002diteration_002dframework_002dsection">loop-iteration-framework-section</a>,
<a href="#loop_002diteration_002dframework_002dpage">loop-iteration-framework-page</a>:  <em>pre-step-endtest</em>,
<em>steps</em>, <em>post-step-endtest</em>, and <em>pseudo-steps</em>.
</p></dd>
<dt><em>another four items of iteration specification</em></dt>
<dd><p>If these four items are given, they apply to the first iteration, and
the previous four apply to all succeeding iterations;  otherwise, the
previous four apply to <em>all</em> iterations.
</p></dd>
</dl>

<p>Here are the routines that are used by <code>loop</code> to compare
keywords for equality.  In all cases, a <em>token</em> may be any Lisp
object, but a <em>keyword</em> is expected to be an atomic symbol.  In
certain implementations these functions may be implemented as macros.
</p>
<a name="si_003aloop_002dtequal_002dfun"></a><dl>
<dt><a name="index-si_003aloop_002dtequal"></a>Function: <strong>si:loop-tequal</strong> <em>token keyword</em></dt>
<dd><p>This is the <code>loop</code> token comparison function.  <em>token</em> is any Lisp
object;  <em>keyword</em> is the keyword it is to be compared
against.  It returns <code>t</code> if they represent the same token,
comparing in a manner appropriate for the implementation.
</p></dd></dl>

<a name="si_003aloop_002dtmember_002dfun"></a><dl>
<dt><a name="index-si_003aloop_002dtmember"></a>Function: <strong>si:loop-tmember</strong> <em>token keyword-list</em></dt>
<dd><p>The <code>member</code> variant of <code>si:loop-tequal</code>.
</p></dd></dl>

<a name="si_003aloop_002dtassoc_002dfun"></a><dl>
<dt><a name="index-si_003aloop_002dtassoc"></a>Function: <strong>si:loop-tassoc</strong> <em>token keyword-alist</em></dt>
<dd><p>The <code>assoc</code> variant of <code>si:loop-tequal</code>.
</p></dd></dl>

<p>If an iteration path function desires to make an internal
variable accessible to the user, it should call the following function
instead of <code>gensym</code>:
<a name="index-using-1"></a>
<a name="si_003aloop_002dnamed_002dvariable_002dfun"></a></p><dl>
<dt><a name="index-si_003aloop_002dnamed_002dvariable"></a>Function: <strong>si:loop-named-variable</strong> <em>keyword</em></dt>
<dd><p>This should only be called from within an iteration path function.  If
<em>keyword</em> has been specified in a <code>using</code> phrase for this
path, the corresponding variable is returned;  otherwise, <code>gensym</code>
is called and that new symbol returned.  Within a given path function,
this routine should only be called once for any given keyword.
</p>
<p>If the user specifies a <code>using</code> preposition containing any keywords
for which the path function does not call <code>si:loop-named-variable</code>,
<code>loop</code> will inform the user of his error.
</p></dd></dl>

<a name="g_t_0022An-Example-Path-Definition_0022"></a>
<h4 class="subsubsection">18.7.2.1 &quot;An Example Path Definition&quot;</h4>
<p>Here is an example function that defines the
<code>string-characters</code> iteration path.  This path steps a variable
through all of the characters of a string.  It accepts the format
</p><div class="lisp">
<pre class="lisp">(loop for <em>var</em> being the string-characters of <em>str</em> ...)
</pre></div>
<p>The function is defined to handle the path by
</p><div class="lisp">
<pre class="lisp">(define-loop-path string-characters string-chars-path
      (of))










</pre></div>

<div align="center">This half-page intentionally left almost blank.
</div>
<p>Here is the function:
</p><div class="lisp">
<pre class="lisp">(defun string-chars-path (path-name variable data-type
			  prep-phrases inclusive?
			  allowed-prepositions data
			  &amp;aux (bindings nil)
			       (prologue nil)
			       (string-var (gensym))
			       (index-var (gensym))
			       (size-var (gensym)))
   allowed-prepositions data ; unused variables
   ; To iterate over the characters of a string, we need
   ; to save the string, save the size of the string,
   ; step an index variable through that range, setting
   ; the user's variable to the character at that index.
   ; Default the data-type of the user's variable:
   (cond ((null data-type) (setq data-type 'fixnum)))
   ; We support exactly one &quot;preposition&quot;, which is
   ; required, so this check suffices:
   (cond ((null prep-phrases)
	  (ferror nil &quot;OF missing in ~S iteration path of ~S&quot;
		  path-name variable)))
   ; We do not support &quot;inclusive&quot; iteration:
   (cond ((not (null inclusive?))
	  (ferror nil
	    &quot;Inclusive stepping not supported in ~S path ~
	     of ~S (prep phrases = ~:S)&quot;
	    path-name variable prep-phrases)))
   ; Set up the bindings
   (setq bindings (list (list variable nil data-type)
			(list string-var (cadar prep-phrases))
			(list index-var 0 'fixnum)
			(list size-var 0 'fixnum)))
   ; Now set the size variable
   (setq prologue (list `(setq ,size-var (string-length
					    ,string-var))))
   ; and return the appropriate stuff, explained below.
   (list bindings
	 prologue
	 `(= ,index-var ,size-var)
	 nil 
	 nil
	 ; <code>char-n</code> <span class="roman">is the NIL string referencing primitive.</span>
	 ; <span class="roman">In Zetalisp, <code>aref</code> could be used instead.</span>
	 (list variable `(char-n ,string-var ,index-var)
	       index-var `(1+ ,index-var))))
</pre></div>

<p>The first element of the returned list is the bindings.  The
second is a list of forms to be placed in the <em>prologue</em>.  The
remaining elements specify how the iteration is to be performed.  This
example is a particularly simple case, for two reasons:  the actual
&quot;variable of iteration&quot;, <code>index-var</code>, is purely internal
(being <code>gensym</code>med), and the stepping of it (<code>1+</code>) is such
that it may be performed safely without an endtest.  Thus
<code>index-var</code> may be stepped immediately after the setting of the
user&rsquo;s variable, causing the iteration specification for the first
iteration to be identical to the iteration specification for all
remaining iterations.  This is advantageous from the standpoint of the
optimizations <code>loop</code> is able to perform, although it is frequently
not possible due to the semantics of the iteration (e.g, <code>for
<em>var</em> first <em>expr1</em> then <em>expr2</em></code>) or to subtleties of
the stepping.  It is safe for this path to step the user&rsquo;s variable in
the <em>pseudo-steps</em> (the fourth item of an iteration specification)
rather than the &quot;real&quot; steps (the second), because the step value can
have no dependencies on any other (user) iteration variables.  Using
the pseudo-steps generally results in some efficiency gains.
	If one desired the index variable in the above definition to
be user-accessible through the <code>using</code> phrase feature with the
<a name="index-using-2"></a>
<code>index</code> keyword, the function would need to be changed in two
ways.  First, <code>index-var</code> should be bound to
<code>(si:loop-named-variable 'index)</code> instead of <code>(gensym)</code>.
Secondly, the efficiency hack of stepping the index variable ahead of
the iteration variable must not be done.  This is effected by changing
the last form to be
</p><div class="lisp">
<pre class="lisp">(list bindings prologue
      nil
      (list index-var `(1+ ,index-var))
      `(= ,index-var ,size-var)
      (list variable `(char-n ,string-var ,index-var))
      nil
      nil
      `(= ,index-var ,size-var)
      (list variable `(char-n ,string-var ,index-var)))
</pre></div>
<p>Note that although the second <code>`(= ,index-var ,size-var)</code> could
have been placed earlier (where the second <code>nil</code> is), it is best
for it to match up with the equivalent test in the first iteration
specification grouping.
</p>


<a name="g_t_0022Defstruct_0022"></a>
<h2 class="chapter">19 &quot;Defstruct&quot;</h2>
<a name="defstruct"></a><a name="defstruct_002dchapter"></a><a name="index-structures"></a>
<a name="index-defstruct"></a>
<a name="index-record-_0028structure_0029"></a>
<a name="index-macro-defining-macros"></a>

<p><code>defstruct</code> provides a facility in Lisp for creating and
using aggregate datatypes with named elements.  These are like
&quot;structures&quot; in PL/I, or &quot;records&quot; in PASCAL.  In the last two chapters we
saw how to use macros to extend the control structures of Lisp; here we
see how they can be used to extend Lisp&rsquo;s data structures as well.
</p>
<a name="g_t_0022Introduction-to-Structure-Macros_0022"></a>
<h3 class="section">19.1 &quot;Introduction to Structure Macros&quot;</h3>

<p>To explain the basic idea, assume you were writing a Lisp
program that dealt with space ships.  In your program, you want to
represent a space ship by a Lisp object of some kind.  The interesting
things about a space ship, as far as your program is concerned, are
its position (X and Y), velocity (X and Y), and mass.  How do you
represent a space ship?
</p>
<p>Well, the representation could be a list of the x-position,
y-position, and so on.  Equally well it could be an array of five
elements, the zeroth being the x-position, the first being the
y-position, and so on.  The problem with both of these representations
is that the &quot;elements&quot; (such as x-position) occupy places in the object
which are quite arbitrary, and hard to remember (Hmm, was the mass the
third or the fourth element of the array?).  This would make programs
harder to write and read.  It would not be obvious when reading
a program that an expression such as <code>(cadddr ship1)</code> or <code>(aref ship2 3)</code>
means &quot;the y component of the ship&rsquo;s velocity&quot;, and it would be very easy
to write <code>caddr</code> in place of <code>cadddr</code>.
</p>
<p>What we would like to see are names, easy to remember and to understand.
If the symbol <code>foo</code> were bound to a representation of a space ship, then
</p><div class="lisp">
<pre class="lisp">(ship-x-position foo)
</pre></div>
<p>could return its x-position, and
</p><div class="lisp">
<pre class="lisp">(ship-y-position foo)
</pre></div>
<p>its y-position, and so forth.  The <code>defstruct</code> facility does just this.
</p>
<p><code>defstruct</code> itself is a macro which defines a structure.  For the
space ship example above, we might define the structure by saying:
</p><div class="lisp">
<pre class="lisp">(defstruct (ship)
     ship-x-position
     ship-y-position
     ship-x-velocity
     ship-y-velocity
     ship-mass)
</pre></div>

<p>This says that every <code>ship</code> is an object with five named components.
(This is a very simple case of <code>defstruct</code>; we will see the general form
later.)  The evaluation of this form does several things.  First, it
defines <code>ship-x-position</code> to be a function which, given a ship, returns
the x component of its position.  This is called an <em>accessor function</em>,
because it <em>accesses</em> a component of a structure.
<a name="index-accessor-function"></a>
<code>defstruct</code> defines the other four accessor functions analogously.
</p>
<p><code>defstruct</code> will also define <code>make-ship</code> to be a macro which expands
into the necessary Lisp code to create a <code>ship</code> object.  So <code>(setq x
(make-ship))</code> will make a new ship, and set <code>x</code> to it.  This macro is
called the <em>constructor macro</em>, because it constructs a new structure.
<a name="index-constructor-macro"></a>
</p>
<p>We also want to be able to change the contents of a structure.  To do this,
we use the <code>setf</code> macro (see <a href="#setf_002dfun">setf-fun</a>), as follows (for example):
</p><div class="lisp">
<pre class="lisp">(setf (ship-x-position x) 100)
</pre></div>
<p>Here <code>x</code> is bound to a ship, and after the evaluation of the <code>setf</code>
form, the <code>ship-x-position</code> of that ship will be 100.  Another way
to change the contents of a structure is to use the alterant macro,
which is described later, in <a href="#using_002ddefstruct_002dalterant">using-defstruct-alterant</a>.
</p>
<p>How does all this map into the familiar primitives of Lisp?  In this simple
example, we left the choice of implementation technique up to
<code>defstruct</code>; it will choose to represent a ship as an array.  The array has
five elements, which are the five components of the ship.  The accessor
functions are defined thus:
</p><div class="lisp">
<pre class="lisp">(defun ship-x-function (ship)
  (aref ship 0))
</pre></div>
<p>The constructor macro <code>(make-ship)</code> expands into <code>(make-array 5)</code>, which
makes an array of the appropriate size to be a ship.  Note that a program which
uses ships need not contain any explicit knowledge that ships are represented
as five-element arrays; this is kept hidden by <code>defstruct</code>.
</p>
<p>The accessor functions are not actually ordinary functions; instead they
are <code>subst</code>s (see <a href="#subst">subst</a>).  This difference has two implications: it allows
<code>setf</code> to understand the accessor functions, and it allows the compiler to
substitute the body of an accessor function directly into any function that uses it,
making compiled programs that use <code>defstruct</code> exactly equal in efficiency to
programs that &quot;do it by hand.&quot;  Thus writing <code>(ship-mass s)</code> is exactly
equivalent to writing <code>(aref s 4)</code>, and writing <code>(setf (ship-mass s) m)</code>
is exactly equivalent to writing <code>(aset m s 4)</code>, when the program is compiled.
It is also possible to tell <code>defstruct</code> to implement the accessor
functions as macros; this is not normally done in Zetalisp, however.
</p>
<p>We can now use the <code>describe-defstruct</code> function to look at the
<code>ship</code> object, and see what its contents are:
</p><div class="lisp">
<pre class="lisp">(describe-defstruct x 'ship) =&gt;

#&lt;art-q-5 17073131&gt; is a ship
   ship-x-position:              100
   ship-y-position:              nil
   ship-x-velocity:              nil
   ship-y-velocity:              nil
   ship-mass:                    nil
#&lt;art-q-5 17073131&gt;
</pre></div>
<p>(The <code>describe-defstruct</code> function is explained more fully on
<a href="#describe_002ddefstruct_002dfun">describe-defstruct-fun</a>.)
</p>
<p>By itself, this simple example provides a powerful structure
definition tool.  But, in fact, <code>defstruct</code> has many other features.  First
of all, we might want to specify what kind of Lisp object to use for the
&quot;implementation&quot; of the structure.  The example above implemented a &quot;ship&quot;
as an array, but <code>defstruct</code> can also implement structures as array-leaders,
lists, and other things.  (For array-leaders, the accessor functions call
<code>array-leader</code>, for lists, <code>nth</code>, and so on.)
</p>
<p>Most structures are implemented as arrays.  Lists take slightly less
storage, but elements near the end of a long list are slower to access.
Array leaders allow you to have a homogeneous aggregate (the array)
and a heterogeneous aggregate with named elements (the leader) tied
together into one object.
</p>
<p><code>defstruct</code> allows you to specify to the constructor
macro what the various elements of the structure should be initialized
to.  It also lets you give, in the <code>defstruct</code> form, default values
for the initialization of each element.
</p>
<p>The <code>defstruct</code> in Zetalisp also works in various
dialects of Maclisp, and so it has some features that are not useful in
Zetalisp.  When possible, the Maclisp-specific features attempt
to do something reasonable or harmless in Zetalisp, to make it
easier to write code that will run equally well in Zetalisp and
Maclisp.  (Note that this <code>defstruct</code> is not necessarily the default
one installed in Maclisp!)
</p>
<a name="g_t_0022How-to-Use-Defstruct_0022"></a>
<h3 class="section">19.2 &quot;How to Use Defstruct&quot;</h3>
<a name="index-slot"></a>

<a name="defstruct_002dfun"></a><dl>
<dt><a name="index-defstruct-1"></a>Macro: <strong>defstruct</strong></dt>
<dd><p>A call to <code>defstruct</code> looks like:
</p><div class="lisp">
<pre class="lisp">(defstruct (<em>name</em> <em>option-1</em> <em>option-2</em> ...)
	   <em>slot-description-1</em>
	   <em>slot-description-2</em>
	   ...)
</pre></div>
<p><em>name</em> must be a symbol; it is the name of the structure.  It is given a
<code>si:defstruct-description</code> property that describes the attributes and elements of the
structure; this is intended to be used by programs that examine Lisp
programs and that want to display the contents of structures in a helpful
way.  <em>name</em> is used for other things, described below.
</p>
<p>Each <em>option</em> may be either a symbol, which should be one of the recognized
option names listed in the next section, or a list, whose car should be one of the
option names and the rest of which should be &quot;arguments&quot; to the option.
Some options have arguments that default; others require that arguments be
given explicitly.
</p>
<p>Each <em>slot-description</em> may be in any of three forms:
</p><div class="lisp">
<pre class="lisp"><span class="roman">(1)</span>	<em>slot-name</em>
<span class="roman">(2)</span>	<code>(<em>slot-name</em> <em>default-init</em>)</code>
<span class="roman">(3)</span>	((<em>slot-name-1</em> <em>byte-spec-1</em> <em>default-init-1</em>)
	 (<em>slot-name-2</em> <em>byte-spec-2</em> <em>default-init-2</em>)
		...)
</pre></div>
<p>Each <em>slot-description</em> allocates one element of the physical structure,
even though in form (3) several slots are defined.
</p>
<p>Each <em>slot-name</em> must always be a symbol; an accessor function is defined
for each slot.
</p>
<p>In form (1), <em>slot-name</em> simply defines a slot with the given name.  An
accessor function will be defined with the name <em>slot-name</em> (but see the
<code>:conc-name</code> option, <a href="#defstruct_002dconc_002dname_002doption">defstruct-conc-name-option</a>).  Form (2) is
similar, but allows a default initialization for the slot.  Initialization
is explained further on <a href="#defstruct_002dinitialization">defstruct-initialization</a>.  Form (3) lets you pack
several slots into a single element of the physical underlying structure, using
the byte field feature of <code>defstruct</code>, which is explained on
<a href="#defstruct_002dbyte_002dfield">defstruct-byte-field</a>.
</p></dd></dl>

<p>Because evaluation of a <code>defstruct</code> form causes many functions and macros
to be defined, you must take care not to define the same name with two
different <code>defstruct</code> forms.  A name can only have one function
definition at a time; if it is redefined, the latest definition is the one
that takes effect, and the earlier definition is clobbered.  (This is no
different from the requirement that each <code>defun</code> which is intended to
define a distinct function must have a distinct name.)
</p>
<p>To systematize this necessary carefulness, as well as for
clarity in the code, it is conventional to prefix the names of all of the
accessor functions with some text unique to the structure.  In the example
above, all the names started with <code>ship-</code>.  The <code>:conc-name</code>
option can be used to provide such prefixes automatically (see <a href="#defstruct_002dconc_002dname_002doption">defstruct-conc-name-option</a>).
Similarly, the conventional name for the constructor macro in the example
above was <code>make-ship</code>, and the conventional name for the alterant macro
(see <a href="#using_002ddefstruct_002dalterant">using-defstruct-alterant</a>) was <code>alter-ship</code>.
</p>
<p>The <code>describe-defstruct</code> function lets you examine an instance of
a structure.
</p>
<a name="describe_002ddefstruct_002dfun"></a><dl>
<dt><a name="index-describe_002ddefstruct"></a>Function: <strong>describe-defstruct</strong> <em>instance &amp;optional name</em></dt>
<dd><p><code>describe-defstruct</code> takes an <em>instance</em> of a structure, and prints
out a description of the instance, including the contents of each of its
slots.  <em>name</em> should be the name of the structure; you must provide
the name of the structure so that <code>describe-defstruct</code> can know what
structure <em>instance</em> is an instance of, and therefore figure out what
the names of the slots of <em>instance</em> are.
</p>
<p>If <em>instance</em> is a named structure, you don&rsquo;t have to provide <em>name</em>,
since it is just the named structure symbol of <em>instance</em>.
Normally the <code>describe</code> function (see <a href="#describe_002dfun">describe-fun</a>) will call
<code>describe-defstruct</code> if it is asked to describe a named structure;
however some named structures have their own idea of how to describe themselves.
See <a href="#named_002dstructure">named-structure</a> for more information about named structures.
</p></dd></dl>

<a name="g_t_0022Options-to-Defstruct_0022"></a>
<h3 class="section">19.3 &quot;Options to Defstruct&quot;</h3>

<p>This section explains each of the options that can be given to <code>defstruct</code>.
</p>
<p>Here is an example that shows the typical syntax of a call to <code>defstruct</code>
that gives several options.
</p><div class="lisp">
<pre class="lisp">(defstruct (foo (:type :array)
		(:make-array (:type 'art-8b :leader-length 3))
		:conc-name
		(:size-symbol foo))
  a
  b)
</pre></div>

<dl compact="compact">
<dt><code>:type</code></dt>
<dd><a name="index-_003atype-defstruct"></a>
<p>The <code>:type</code> option specifies what kind of Lisp object will be used
to implement the structure.  It must be given one argument, which must
be one of the symbols enumerated below, or a user-defined type.
If the option itself is not
provided, the type defaults to <code>:array</code>.  You can define your
own types; this is explained in <a href="#defining_002dyour_002down_002ddefstruct_002dtypes">defining-your-own-defstruct-types</a>.
</p>
<dl compact="compact">
<dt><code>:array</code></dt>
<dd><a name="index-_003aarray-defstruct"></a>
<p>Use an array, storing components in the body of the array.
</p></dd>
<dt><code>:named-array</code></dt>
<dd><a name="index-_003anamed_002darray-defstruct"></a>
<p>Like <code>:array</code>, but make the array a named structure (see
<a href="#named_002dstructure">named-structure</a>) using the name of the structure as the named
structure symbol.  Element <code>0</code> of the array will hold the named
structure symbol and so will not be used to hold a component of the
structure.
</p></dd>
<dt><code>:array-leader</code></dt>
<dd><a name="index-_003aarray_002dleader-defstruct"></a>
<p>Use an array, storing components in the leader of the array.
(See the <code>:make-array</code> option, described below.)
</p></dd>
<dt><code>:named-array-leader</code></dt>
<dd><a name="index-_003anamed_002darray_002dleader-defstruct"></a>
<p>Like <code>:array-leader</code>, but make the array a named structure (see
<a href="#named_002dstructure">named-structure</a>) using the name of the structure as the named
structure symbol.  Element <code>1</code> of the leader will hold the named
structure symbol and so will not be used to hold a component of the
structure.
</p></dd>
<dt><code>:list</code></dt>
<dd><a name="index-_003alist-defstruct"></a>
<p>Use a list.
</p></dd>
<dt><code>:named-list</code></dt>
<dd><a name="index-_003anamed_002dlist-defstruct"></a>
<p>Like <code>:list</code>, but the first element of the list will hold the
symbol that is the name of the structure and so will not be used
as a component.
</p></dd>
<dt><code>:fixnum-array</code></dt>
<dd><a name="index-_003afixnum_002darray-defstruct"></a>
<p>Like <code>:array</code>, but the type of the array is <code>art-32b</code>.
</p></dd>
<dt><code>:flonum-array</code></dt>
<dd><a name="index-_003aflonum_002darray-defstruct"></a>
<p>Like <code>:array</code>, but the type of the array is <code>art-float</code>.
</p></dd>
<dt><code>:tree</code></dt>
<dd><a name="index-_003atree-defstruct"></a>
<p>The structure is implemented out of a binary tree of conses, with
the leaves serving as the slots.
</p></dd>
<dt><code>:fixnum</code></dt>
<dd><a name="index-_003afixnum-defstruct"></a>
<p>This unusual type implements the structure as a single fixnum.  The
structure may only have one slot.  This is only useful with the
byte field feature (see <a href="#defstruct_002dbyte_002dfield">defstruct-byte-field</a>); it lets you store
a bunch of small numbers within fields of a fixnum, giving the
fields names.
</p></dd>
<dt><code>:grouped-array</code></dt>
<dd><a name="index-_003agrouped_002darray-defstruct"></a>
<p>This is described in <a href="#grouped_002darray">grouped-array</a>.
</p></dd>
</dl>

</dd>
<dt><code>:constructor</code></dt>
<dd><a name="index-_003aconstructor-defstruct"></a>
<p>This option takes one argument, which specifies the name of the constructor
macro.  If the argument is not provided or if the option itself is not
provided, the name of the constructor is made by concatenating the
string <code>&quot;make-&quot;</code> to the name of the structure.  If the argument is
provided and is <code>nil</code>, no constructor is defined.  Use of the constructor
macro is explained in <a href="#using_002ddefstruct_002dconstructor">using-defstruct-constructor</a>.
</p>
</dd>
<dt><code>:alterant</code></dt>
<dd><a name="index-_003aalterant-defstruct"></a>
<p>This option takes one argument, which specifies the name of the alterant
macro.  If the argument is not provided or if the option itself is not
provided, the name of the alterant is made by concatenating the
string <code>&quot;alter-&quot;</code> to the name of the structure.  If the argument is
provided and is <code>nil</code>, no alterant is defined.  Use of the alterant
macro is explained in <a href="#using_002ddefstruct_002dalterant">using-defstruct-alterant</a>.
</p>
</dd>
<dt><code>:predicate defstruct</code></dt>
<dd><p>The <code>:predicate</code> option causes <code>defstruct</code> to generate a predicate
to recognize instances of the structure.  Naturally it only works for
&quot;named&quot; types.  The argument to the <code>:predicate</code> option is the name of
the predicate.  If the option is present without an argument, then the
name is formed by concatenating &quot;<code>-p</code>&quot; to the end of the name symbol
of the structure.  If the option is not present, then no predicate is
generated.  Example:
</p><div class="lisp">
<pre class="lisp">(defstruct (foo :named :predicate)
  foo-a
  foo-b)
</pre></div>
<p>defines a single argument function, <code>foo-p</code>, that is true only of
instances of this structure.
</p>
</dd>
<dt><code>:copier defstruct</code></dt>
<dd><p>This option causes <code>defstruct</code> to generate a single argument function that will
copy instances of this structure.  Its argument is the name of the copying
function.  If the option is present without an argument, then the name is
formed by concatenating &quot;<code>copy-</code>&quot; with the name of the structure.  Example:
</p><div class="lisp">
<pre class="lisp">(defstruct (foo (:type :list) :copier)
  foo-a
  foo-b)
</pre></div>
<p>Generates a function approximately like:
</p><div class="lisp">
<pre class="lisp">(defun copy-foo (x)
  (list (car x) (cadr x)))
</pre></div>

</dd>
<dt><code>:default-pointer</code></dt>
<dd><a name="index-_003adefault_002dpointer-defstruct"></a>
<a name="defstruct_002ddefault_002dpointer_002doption"></a><p>Normally, the accessors defined by <code>defstruct</code> expect to
be given exactly one argument.  However, if the <code>:default-pointer</code>
argument is used, the argument to each accessor is optional.  If you use
an accessor in the usual way it will do the usual thing, but if you
invoke it without its argument, it will behave as if you had invoked it
on the result of evaluating the form which is the argument to the
<code>:default-pointer</code> argument.  Here is an example:
</p>
<div class="lisp">
<pre class="lisp">(defstruct (room (:default-pointer *default-room*))
   room-name
   room-contents)

(room-name x) ==&gt; (aref x 0)
(room-name)   ==&gt; (aref *default-room* 0)
</pre></div>

<p>If the argument to the <code>:default-pointer</code> argument is not given, it
defaults to the name of the structure.
</p>
</dd>
<dt><code>:conc-name</code></dt>
<dd><a name="index-_003aconc_002dname-defstruct"></a>
<a name="defstruct_002dconc_002dname_002doption"></a><p>It is conventional to begin the names of all the accessor functions of
a structure with a specific prefix, usually
the name of the structure followed by a hyphen.  The <code>:conc-name</code>
option allows you to specify this prefix and have it concatenated
onto the front of all the slot names to make the names of the accessor
functions.  The argument should be a string to be used as the prefix,
or a symbol whose pname is to be used.
If <code>:conc-name</code> is specified without an argument, the prefix will be the
name of the structure followed by a hyphen.  If you do not specify the
<code>:conc-name</code> option, the names of the accessors are the same as the slot
names, and it is up to you to name the slots according to some suitable convention.
</p>
<p>The constructor and alterant macros are given slot names, not accessor names.
It is important to keep this in mind when using <code>:conc-name</code>, since it
causes the slot and accessor names to be different.  Here is an example:
</p><div class="lisp">
<pre class="lisp">(defstruct (door :conc-name)
   knob-color
   width)

(setq d (make-door knob-color 'red width 5.0))

(door-knob-color d) ==&gt; red
</pre></div>

</dd>
<dt><code>:include</code></dt>
<dd><a name="index-_003ainclude-defstruct"></a>
<a name="defstruct_002dinclude_002doption"></a><p>This option is used for building a new structure definition as an extension of an old
structure definition.  Suppose you have a structure called <code>person</code> that
looks like this:
</p>
<div class="lisp">
<pre class="lisp">(defstruct (person :conc-name)
   name
   age
   sex)
</pre></div>

<p>Now suppose you want to make a new structure to represent an astronaut.
Since astronauts are people too, you would like them to also have the
attributes of name, age, and sex, and you would like Lisp functions
that operate on <code>person</code> structures to operate just as well on
<code>astronaut</code> structures.  You can do this by defining <code>astronaut</code>
with the <code>:include</code> option, as follows:
</p>
<div class="lisp">
<pre class="lisp">(defstruct (astronaut (:include person))
   helmet-size
   (favorite-beverage 'tang))
</pre></div>

<p>The <code>:include</code> option inserts the slots of the included structure at
the front of the list of slots for this structure.  That is, an
<code>astronaut</code> will have five slots; first the three defined in
<code>person</code>, and then after those the two defined in <code>astronaut</code>
itself.  The accessor functions defined by the <code>person</code> structure
can be applied to instances of the <code>astronaut</code> structure, and they
will work correctly.  The following examples illustrate how you can
use <code>astronaut</code> structures:
</p>
<div class="lisp">
<pre class="lisp">(setq x (make-astronaut name 'buzz
			age 45.
			sex t
			helmet-size 17.5))

(person-name x) =&gt; buzz
(favorite-beverage x) =&gt; tang
</pre></div>

<p>Note that the <code>:conc-name</code> option was <em>not</em> inherited from the
included structure; it only applies to the accessor functions of <code>person</code>
and not to those of <code>astronaut</code>.  Similarly, the <code>:default-pointer</code>
and <code>:but-first</code> options, as well as the <code>:conc-name</code> option, only
apply to the accessor functions for the structure in which they are enclosed; they are not
inherited if you <code>:include</code> a structure that uses them.
</p>
<p>The argument to the <code>:include</code> option is required, and must be the
name of some previously defined structure of the same type as this
structure.  <code>:include</code> does not work with structures of type
<code>:tree</code> or of type <code>:grouped-array</code>.
</p>
<p>The following is an advanced feature.  Sometimes, when one structure
includes another, the default values for the slots that came from the
included structure are not what you want.  The new structure can specify
different default values for the included slots than the included
structure specifies, by giving the <code>:include</code> option as:
</p>
<div class="lisp">
<pre class="lisp">(:include <em>name new-init-1 ... new-init-n</em>)
</pre></div>

<p>Each <em>new-init</em> is either the name of an included slot or a list of
the form <code>(<em>name-of-included-slot init-form</em>)</code>.  If it is just a
slot name, then in the new structure the slot will have no initial
value.  Otherwise its initial value form will be replaced by the
<em>init-form</em>.  The old (included) structure is unmodified.
</p>
<p>For example, if we had wanted to define <code>astronaut</code> so that the
default age for an astronaut is <code>45.</code>, then we could have said:
</p><div class="lisp">
<pre class="lisp">(defstruct (astronaut (:include person (age 45.)))
   helmet-size
   (favorite-beverage 'tang))
</pre></div>

</dd>
<dt><code>:named</code></dt>
<dd><a name="index-_003anamed-defstruct"></a>
<p>This means that you want to use one of the &quot;named&quot; types.  If you
specify a type of <code>:array</code>, <code>:array-leader</code>, or <code>:list</code>, and give
the <code>:named</code> option, then the <code>:named-array</code>,
<code>:named-array-leader</code>, or <code>:named-list</code> type will be used instead.
Asking for type <code>:array</code> and giving the <code>:named</code> option as well
is the same as asking for the type <code>:named-array</code>; the only difference
is stylistic.
</p>
</dd>
<dt><code>:make-array</code></dt>
<dd><a name="index-_003amake_002darray-defstruct"></a>
<a name="defstruct_002dmake_002darray_002doption"></a><p>If the structure being defined is implemented as an array, this option
may be used to control those aspects of the array that are not otherwise constrained by
<code>defstruct</code>.  For example, you might want to control the area in which
the array is allocated.  Also, if you are creating a structure of type
<code>:array-leader</code>, you almost certainly want to specify the dimensions
of the array to be created, and you may want to specify the type of the
array.  Of course, this option is only meaningful if the structure is,
in fact, being implemented by an array.
</p>
<p>The argument to the <code>:make-array</code> option should be a list of alternating
keyword symbols to the <code>make-array</code> function (see <a href="#make_002darray_002dfun">make-array-fun</a>),
and forms whose values are the arguments to those keywords.  For example,
<code>(:make-array (:type 'art-16b))</code> would request that the type of the
array be <code>art-16b</code>.  Note that the keyword symbol is <em>not</em> evaluated.
</p>
<p><code>defstruct</code> overrides any of the <code>:make-array</code> options that it needs
to.  For example, if your structure is of type <code>:array</code>, then
<code>defstruct</code> will supply the size of that array regardless of what you
say in the <code>:make-array</code> option.  If you use the <code>:initial-value</code>
<code>make-array</code> option, it will initialize all the slots, but
<code>defstruct</code>&rsquo;s own initializations will be done afterward.
</p>
<p>Constructor macros for structures implemented as arrays all allow the
keyword <code>:make-array</code> to be supplied.  Attributes supplied therein
overide any <code>:make-array</code> option attributes supplied in the original
<code>defstruct</code> form.  If some attribute appears in neither the invocation
of the constructor nor in the <code>:make-array</code> option to <code>defstruct</code>,
then the constructor will chose appropriate defaults.  The <code>:make-array</code> option
may only be used with the default, non-by-position (see below) style of constructor.
</p>
<p>If a structure is of type <code>:array-leader</code>, you probably want to
specify the dimensions of the array.  The dimensions of an array are
given to <code>:make-array</code> as a position argument rather than a keyword
argument, so there is no way to specify them in the above syntax.  To
solve this problem, you can use the keyword <code>:dimensions</code> or the
keyword <code>:length</code> (they mean the same thing), with a value that is
anything acceptable as <code>make-array</code>&rsquo;s first argument.
</p>
</dd>
<dt><code>:times</code></dt>
<dd><a name="index-_003atimes-defstruct"></a>
<p>This option is used for structures of type <code>:grouped-array</code> to control
the number of repetitions of the structure that will be allocated by the
constructor macro.  (See <a href="#grouped_002darray">grouped-array</a>.)  The constructor macro will
also allow <code>:times</code> to be used as a keyword that will override the value
given in the original <code>defstruct</code> form.  If <code>:times</code> appears in
neither the invocation of the constructor nor in the <code>:make-array</code> option
to <code>defstruct</code>, then the constructor will only allocate one instance of
the structure.
</p>
</dd>
<dt><code>:size-symbol</code></dt>
<dd><a name="index-_003asize_002dsymbol-defstruct"></a>
<a name="defstruct_002dsize_002dsymbol_002doption"></a><p>The <code>:size-symbol</code> option allows a user to specify a global variable whose
value will be the &quot;size&quot; of the structure; this variable is declared with
<code>defconst</code>.  The exact meaning of the size
varies, but in general this number is the one you would need to know if
you were going to allocate one of these structures yourself.  The symbol
will have this value both at compile time and at run time.  If this
option is present without an argument, then the name of the structure is
concatenated with <code>&quot;-size&quot;</code> to produce the symbol.
</p>
</dd>
<dt><code>:size-macro</code></dt>
<dd><a name="index-_003asize_002dmacro-defstruct"></a>
<p>This is similar to the <code>:size-symbol</code> option.  A macro of no arguments
is defined that expands into the size of the structure.  The name of
this macro defaults as with <code>:size-symbol</code>.
</p>
</dd>
<dt><code>:initial-offset</code></dt>
<dd><a name="index-_003ainitial_002doffset-defstruct"></a>
<p>This allows you to tell <code>defstruct</code> to skip over a certain
number of slots before it starts allocating the slots described in the
body.  This option requires an argument (which must be a fixnum), which
is the number of slots you want <code>defstruct</code> to skip.  To make use of
this option requires that you have some familiarity with how <code>defstruct</code>
is implementing your structure; otherwise, you will be unable to make
use of the slots that <code>defstruct</code> has left unused.
</p>
</dd>
<dt><code>:but-first</code></dt>
<dd><a name="index-_003abut_002dfirst-defstruct"></a>
<p>This option is best explained by example:
</p>
<div class="lisp">
<pre class="lisp">(defstruct (head (:type :list)
		 (:default-pointer person)
		 (:but-first person-head))
  nose
  mouth
  eyes)
</pre></div>

<p>The accessors expand like this:
</p>
<div class="lisp">
<pre class="lisp">(nose x)	==&gt; (car (person-head x))
(nose)		==&gt; (car (person-head person))
</pre></div>

<p>The idea is that <code>:but-first</code>&rsquo;s argument will be an accessor from some
other structure, and it is never expected that this structure will be
found outside of that slot of that other structure.  Actually, you can
use any one-argument function, or a macro that acts like a one-argument
function.  It is an error for
the <code>:but-first</code> option to be used without an argument.
</p>
</dd>
<dt><code>:callable-accessors</code></dt>
<dd><a name="index-_003acallable_002daccessors-defstruct"></a>
<p>This option controls whether accessors are really functions,
and therefore &quot;callable&quot;, or whether they are really macros.  With
an argument of <code>t</code>, or with no argument, or if the option is not
provided, then the accessors are really functions.  Specifically,
they are <code>subst</code>s, so that they have all the efficiency of macros
in compiled programs, while still being function objects that
can be manipulated (passed to <code>mapcar</code>, etc.).  If
the argument is <code>nil</code> then the accessors will really be macros.
</p>
</dd>
<dt><code>:eval-when</code></dt>
<dd><a name="index-_003aeval_002dwhen-defstruct"></a>
<p>Normally the functions and macros defined by <code>defstruct</code> are defined at
eval-time, compile-time, and load-time.  This option allows the user
to control this behavior.  The argument to the <code>:eval-when</code> option
is just like the list that is the first subform of an <code>eval-when</code>
special form (see <a href="#eval_002dwhen_002dfun">eval-when-fun</a>).  For example,
<code>(:eval-when (:eval :compile))</code>
will cause the functions and macros to be defined only when the code is running
interpreted or inside the compiler.
</p>
</dd>
<dt><code>:property</code></dt>
<dd><a name="index-_003aproperty-defstruct"></a>
<a name="defstruct_002dproperty_002doption"></a><p>For each structure defined by defstruct, a property list is maintained
for the recording of arbitrary properties about that structure.  (That
is, there is one property list per structure definition, not one for
each instantiation of the structure.)
</p>
<p>The <code>:property</code> option can be used to give a <code>defstruct</code> an
arbitrary property.  <code>(:property <em>property-name value</em>)</code> gives the
<code>defstruct</code> a <em>property-name</em> property of <em>value</em>.  Neither
argument is evaluated.  To access the property list, the user will have
to look inside the <code>defstruct-description</code> structure himself (see
<a href="#defstruct_002ddescription">defstruct-description</a>).
</p>
</dd>
<dt><code>:print defstruct</code></dt>
<dd><p>This allows the user to control the printed representation of his
structure in an a way independent of the Lisp dialect in use.  Here is
an example:
</p><div class="lisp">
<pre class="lisp">(defstruct (foo :named
	        (:print &quot;#&lt;Foo ~S ~S&gt;&quot;
                        (foo-a foo) (foo-b foo)))
  foo-a
  foo-b)
</pre></div>
<p>Of course, this only works if you use some named type, so that the system
can recognize examples of this structure automatically.
</p>
<p>The arguments to the <code>:print</code> option are arguments to the <code>format</code>
function (except for the stream of course!).  They are evaluated in an
environment where the name symbol of the structure (<code>foo</code> in this
case) is bound to the instance of the structure to be printed.
</p>
<p>This works by defining, automatically, a named structure handler.  Do
not use the <code>:print</code> option if you define a named structure handler
yourself, as they will conflict.
</p>
</dd>
<dt><code><em>type</em></code></dt>
<dd><p>In addition to the options listed above, any currently defined type
(any legal argument to the <code>:type</code> option) can be used as an option.
This is mostly for compatibility with the old version of <code>defstruct</code>.
It allows you to say just <em>type</em> instead of <code>(:type <em>type</em>)</code>.  It
is an error to give an argument to one of these options.
</p>
</dd>
<dt><code><em>other</em></code></dt>
<dd><p>Finally, if an option isn&rsquo;t found among those listed above,
<code>defstruct</code> checks whether this option is a valid for the type of structure
it is creating (By looking at the <code>defstruct-keywords</code> slot of the
<code>defstruct-type-description</code> structure for <em>type</em>. See below.) If this is not
a valid option, an error is sinalled. Otherwise, if the option is of the form
<code>(<em>option-name value</em>)</code>, it is treated just like <code>(:property <em>option-name value</em>)</code>.
That is, the <code>defstruct</code> is given an <em>option-name</em> property of <em>value</em>.
</p>
<p>This provides a primitive way for you to define your own options to
<code>defstruct</code>, particularly in connection with user-defined types (see
<a href="#defining_002dyour_002down_002ddefstruct_002dtypes">defining-your-own-defstruct-types</a>).  Several of the options listed above
are actually implemented using this mechanism.
</p></dd>
</dl>

<a name="g_t_0022Using-the-Constructor-and-Alterant-Macros_0022"></a>
<h3 class="section">19.4 &quot;Using the Constructor and Alterant Macros&quot;</h3>

<p>After you have defined a new structure with <code>defstruct</code>, you can
create instances of this structure using the constructor macro, and
you can alter the values of its slots using the alterant macro.  By
default, <code>defstruct</code> defines both the constructor and the alterant,
forming their names by concatenating <code>&quot;make-&quot;</code> and <code>&quot;alter-&quot;</code>,
respectively, onto the name of the structure.  You can specify the names
yourself by passing the name you want to use as the argument to the
<code>:constructor</code> or <code>:alterant</code> options, or specify that you don&rsquo;t
want the macro created at all by passing <code>nil</code> as the argument.
</p>
<a name="Constructor-Macros"></a>
<h4 class="subsection">19.4.1 Constructor Macros</h4>
<a name="using_002ddefstruct_002dconstructor"></a><a name="index-constructor-macro-1"></a>

<p>A call to a constructor macro, in general, has the form
</p><div class="lisp">
<pre class="lisp">(<em>name-of-constructor-macro</em>
        <em>symbol-1</em> <em>form-1</em>
        <em>symbol-2</em> <em>form-2</em>
        ...)
</pre></div>
<p>Each <em>symbol</em> may be either the name of a <em>slot</em> of the structure,
or a specially recognized keyword.  All the <em>forms</em> are evaluated.
</p>
<a name="defstruct_002dinitialization"></a><p>If <em>symbol</em> is the name of a <em>slot</em> (<em>not</em> the name of an accessor),
then that element of
the created structure will be initialized to the value of <em>form</em>.  If
no <em>symbol</em> is present for a given slot, then the slot will be
initialized to the result of evaluating the default initialization form specified in
the call to <code>defstruct</code>.  (In other words, the
initialization form specified to the constructor overrides the initialization form
specified to <code>defstruct</code>.)  If the <code>defstruct</code> itself also did not
specify any initialization, the element&rsquo;s initial value is undefined.
You should always specify the initialization, either in the <code>defstruct</code>
or in the constructor macro, if you care about the initial value of the slot.
</p>
<p>Notes: The order of evaluation of the initialization forms is <em>not</em>
necessarily the same as the order in which they appear in the constructor
call, nor the order in which they appear in the <code>defstruct</code>; you should
make sure your code does not depend on the order of evaluation.  The forms
are re-evaluated on every constructor-macro call, so that if, for example,
the form <code>(gensym)</code> were used as an initialization form, either in a call
to a constructor macro or as a default initialization in the <code>defstruct</code>, then every call
to the constructor macro would create a new symbol.
</p>
<p>There are two symbols that are specially recognized by the
constructor.  They are <code>:make-array</code>, which should only be used for
<code>:array</code> and <code>:array-leader</code> type structures (or the named versions
of those types), and <code>:times</code>, which should only be used for
<code>:grouped-array</code> type structures.  If one of these symbols appears instead
of a slot name, then it is interpreted just as the <code>:make-array</code>
option or the <code>:times</code> option (see <a href="#defstruct_002dmake_002darray_002doption">defstruct-make-array-option</a>),
and it overrides what was requested in that option.  For example:
</p><div class="lisp">
<pre class="lisp">(make-ship ship-x-position 10.0
	   ship-y-position 12.0
	   :make-array (:leader-length 5 :area disaster-area))
</pre></div>

<a name="By_002dposition-Constructor-Macros"></a>
<h4 class="subsection">19.4.2 By-position Constructor Macros</h4>

<p>If the <code>:constructor</code> option is given as
<code>(:constructor <em>name</em> <em>arglist</em>)</code>, then instead of making a keyword
driven constructor, <code>defstruct</code> defines a &quot;function style&quot; constructor,
taking arguments whose meaning is determined by the argument&rsquo;s position
rather than by a keyword.
The <em>arglist</em> is used to describe what the arguments to the
constructor will be.  In the simplest case something like
<code>(:constructor make-foo (a b c))</code> defines <code>make-foo</code> to be a three-argument
constructor macro whose arguments are used to initialize the
slots named <code>a</code>, <code>b</code>, and <code>c</code>.
</p>
<p>In addition, the keywords <code>&amp;optional</code>, <code>&amp;rest</code>, and <code>&amp;aux</code> are
recognized in the argument list.  They work in the way you might expect,
but there are a few fine points worthy of explanation:
</p>
<div class="lisp">
<pre class="lisp">(:constructor make-foo 
	(a &amp;optional b (c 'sea) &amp;rest d &amp;aux e (f 'eff)))
</pre></div>

<p>This defines <code>make-foo</code> to be a constructor of one or more arguments.
The first argument is used to initialize the <code>a</code> slot.  The second
argument is used to initialize the <code>b</code> slot.  If there isn&rsquo;t any
second argument, then the default value given in the body of the
<code>defstruct</code> (if given) is used instead.  The third argument is used to
initialize the <code>c</code> slot.  If there isn&rsquo;t any third argument, then the
symbol <code>sea</code> is used instead.  Any arguments following the third
argument are collected into a list and used to initialize the <code>d</code>
slot.  If there are three or fewer arguments, then <code>nil</code> is placed in
the <code>d</code> slot.  The <code>e</code> slot <em>is not initialized</em>; its initial
value is undefined.  Finally, the <code>f</code> slot is initialized to contain
the symbol <code>eff</code>.
</p>
<p>The actions taken in the <code>b</code> and <code>e</code> cases were carefully
chosen to allow the user to specify all possible behaviors.  Note that
the <code>&amp;aux</code> &quot;variables&quot; can be used to completely override the default
initializations given in the body.
</p>
<p>Since there is so much freedom in defining constructors this
way, it would be cruel to only allow the <code>:constructor</code> option to be
given once.  So, by special dispensation, you are allowed to give the
<code>:constructor</code> option more than once, so that you can define several
different constructors, each with a different syntax.
</p>
<p>Note that even these &quot;function style&quot; constructors do not
guarantee that their arguments will be evaluated in the order that you
wrote them.  Also note that you cannot specify the <code>:make-array</code>
nor <code>:times</code> information in this form of constructor macro.
</p>
<p>These constructors additionally do not allow the use of
cons-keywords, such as <code>:make-array</code>, for customization of the
underlying structure. If you want to do this sort of hairyness, you have
to use the simple regular constructors.
</p>
<a name="Alterant-Macros"></a>
<h4 class="subsection">19.4.3 Alterant Macros</h4>
<a name="using_002ddefstruct_002dalterant"></a><a name="index-alterant-macro"></a>

<p>A call to the alterant macro, in general, has the form
</p><div class="lisp">
<pre class="lisp">(<em>name-of-alterant-macro</em> <em>instance-form</em>
     <em>slot-name-1</em> <em>form-1</em>
     <em>slot-name-2</em> <em>form-2</em>
     <em>...</em>)
</pre></div>
<p><em>instance-form</em> is evaluated and should return an instance of the
structure.  Each <em>form</em> is evaluated and the corresponding slot is
changed to have the result as its new value.  The slots are altered
after all the <em>forms</em> are evaluated, so you can exchange the values
of two slots, as follows:
</p><div class="lisp">
<pre class="lisp">(alter-ship enterprise
    ship-x-position (ship-y-position enterprise)
    ship-y-position (ship-x-position enterprise))
</pre></div>

<p>As with the constructor macro, the order of evaluation of the <em>forms</em> is
undefined.  Using the alterant macro can produce more efficient Lisp
than using consecutive <code>setf</code>s when you are altering two byte fields
of the same object, or when you are using the <code>:but-first</code> option.
</p>
<a name="g_t_0022Byte-Fields_0022"></a>
<h3 class="section">19.5 &quot;Byte Fields&quot;</h3>
<a name="defstruct_002dbyte_002dfield"></a><p>The byte field feature of <code>defstruct</code> allows you to specify that
several slots of your structure are bytes (see
<a href="#byte_002dmanipulation_002dfunctions">byte-manipulation-functions</a>) in an integer stored in one
element of the structure.  For example, suppose we had the following
structure:
</p>
<div class="lisp">
<pre class="lisp">(defstruct (phone-book-entry (:type :list))
  name
  address
  (area-code 617.)
  exchange
  line-number)
</pre></div>

<p>This will work correctly.  However, it wastes space.  Area codes and
exchange numbers are always less than <code>1000</code>, and so both can fit
into <code>10</code> bit fields when expressed as binary numbers.  Since Lisp
Machine fixnums have (more than) <code>20</code> bits, both of these
values can be packed into a single fixnum.  To tell <code>defstruct</code> to do
so, you can change the structure definition to the following:
</p>
<div class="lisp">
<pre class="lisp">(defstruct (phone-book-entry (:type :list))
  name
  address
  ((area-code #o1212 617.)
   (exchange #o0012))
  line-number)
</pre></div>

<p>The magic octal numbers <code>#o1212</code> and <code>#o0012</code> are byte specifiers to be used
with the functions <code>ldb</code> and <code>dpb</code>.  The accessors, constructor, and
alterant will now operate as follows:
</p>
<div class="lisp">
<pre class="lisp">(area-code pbe)	==&gt; (ldb #o1212 (caddr pbe))
(exchange pbe)	==&gt; (ldb #o0012 (caddr pbe))
</pre></div>
<div class="lisp">
<pre class="lisp">

(make-phone-book-entry
   name &quot;Fred Derf&quot;
   address &quot;259 Octal St.&quot;
   exchange ex
   line-number 7788.)

==&gt; (list &quot;Fred Derf&quot; &quot;259 Octal St.&quot; (dpb ex 12 2322000) 17154)

</pre></div>
<div class="lisp">
<pre class="lisp">(alter-phone-book-entry pbe
   area-code ac
   exchange ex)

==&gt; ((lambda (g0530)
       (setf (nth 2 g0530)
	     (dpb ac 1212 (dpb ex 12 (nth 2 g0530)))))
     pbe)
</pre></div>

<p>Note that the alterant macro is optimized to only read and write the
second element of the list once, even though you are altering two
different byte fields within it.  This is more efficient than using two
<code>setf</code>s.  Additional optimization by the alterant macro occurs if the
byte specifiers in the <code>defstruct</code> slot descriptions are constants.
However, you don&rsquo;t need to worry about the details of how the alterant
macro does its work.
</p>
<p>If the byte specifier is <code>nil</code>, then the accessor will
be defined to be the usual kind that accesses the entire Lisp object,
thus returning all the byte field components as a fixnum.  These slots
may have default initialization forms.
</p>
<p>The byte specifier need not be a constant; a variable or, indeed, any
Lisp form, is legal as a byte specifier.  It will be evaluated each
time the slot is accessed.  Of course, unless you are doing something
very strange you will not want the byte specifier to change between
accesses.
</p>
<p>Constructor macros initialize
words divided into byte fields as if they were deposited in in the
following order:
</p>
<p>1) Initializations for the entire word given in the defstruct form.
</p>
<p>2) Initializations for the byte fields given in the defstruct form.
</p>
<p>3) Initializations for the entire word given in the constructor macro
form. 
</p>
<p>4) Initializations for the byte fields given in the constructor macro
form. 
</p>
<p>Alterant macros work similarly: the modification for the entire Lisp
object is done first, followed by modifications to specific byte fields.
If any byte fields being initialized or altered overlap each other, the
action of the constructor and alterant will be unpredictable.
</p>
<a name="g_t_0022Grouped-Arrays_0022"></a>
<h3 class="section">19.6 &quot;Grouped Arrays&quot;</h3>
<a name="grouped_002darray"></a><a name="index-grouped-array"></a>

<p>The grouped array feature allows you to store several instances
of a structure side-by-side within an array.  This feature is somewhat
limited; it does not support the <code>:include</code> and <code>:named</code> options.
</p>
<p>The accessor functions are defined to take an extra argument, which
should be an integer, and is the index into the array of where this
instance of the structure starts.  This index should normally be a multiple
of the size of the structure, for things to make sense.  Note that the
index is the <em>first</em> argument to the accessor function and the structure
is the <em>second</em> argument, the opposite of what you might expect.  This
is because the structure is <code>&amp;optional</code> if the <code>:default-pointer</code> option
is used.
</p>
<p>Note that the &quot;size&quot; of the structure (for purposes of the <code>:size-symbol</code>
and <code>:size-macro</code> options) is the number of elements in <em>one</em> instance of the structure;
the actual length of the array is the product of the size of the structure and the
number of instances.  The number of instances to be created by the constructor
macro is given as the argument to the <code>:times</code> option to <code>defstruct</code>, or 
the <code>:times</code> keyword of the constructor macro.
</p>
<a name="Named-Structures"></a>
<h3 class="section">19.7 Named Structures</h3>

<a name="named_002dstructure"></a><a name="index-named-structure"></a>

<p>The <em>named structure</em> feature provides a very simple form of
user-defined data type.  Any array may be made a named structure,
although usually the <code>:named</code> option of <code>defstruct</code> is used to
create named structures.  The principal advantages to a named structure
are that it has a more informative printed representation than a normal
array and that the <code>describe</code> function knows how to give a detailed
description of it.  (You don&rsquo;t have to use <code>describe-defstruct</code>,
because <code>describe</code> can figure out what the names of the slots of the
structure are by looking at the named structure&rsquo;s name.) Because of
these improved user-interface features it is recommended that &quot;system&quot;
data structures be implemented with named structures.
</p>
<p>Another kind of user-defined data type, more advanced but less
efficient when just used as a record structure, is provided by the
<em>flavor</em> feature (see <a href="#flavor">flavor</a>).
</p>
<p>A named structure has an associated symbol, called its &quot;named
structure symbol&quot;, which represents what user-defined type it is an
instance of; the <code>typep</code> function, applied to the named structure,
will return this symbol.  If the array has a leader, then the symbol is
found in element 1 of the leader; otherwise it is found in element 0 of
the array.  (Note: if a numeric-type array is to be a named structure,
it must have a leader, since a symbol cannot be stored in any element
of a numeric array.)
</p>
<p>If you call <code>typep</code> with two arguments, the first being
an instance of a named structure and the second being its named
structure symbol, <code>typep</code> will return <code>t</code>.  <code>t</code> will also
be returned if the second argument is the named structure symbol of
a <code>:named</code> <code>defstruct</code> included (using the <code>:include</code> option,
see <a href="#defstruct_002dinclude_002doption">defstruct-include-option</a>), directly or indirectly, by the <code>defstruct</code> for this
structure.  For example, if the structure <code>astronaut</code> includes
the structure <code>person</code>, and <code>person</code> is a named structure,
then giving <code>typep</code> an instance of an <code>astronaut</code> as the first
argument, and the symbol <code>person</code> as the second argument, will
return <code>t</code>.  This reflects the fact that an astronaut is, in fact,
a person, as well as being an astronaut.
</p>
<p>You may associate with a named structure a function that will handle
various operations that can be done on the named structure.  Currently,
you can control how the named structure is printed, and what <code>describe</code>
will do with it.
</p>
<p>To provide such a handler function, make the function be the <code>named-structure-invoke</code>
property of the named structure symbol.  The functions
which know about named structures will apply this handler function to
several arguments.  The first is a &quot;keyword&quot; symbol to
identify the calling function, and the second is the named structure
itself.  The rest of the arguments passed depend on the caller; any
named structure function should have a &quot;<code>&amp;rest</code>&quot; parameter to
absorb any extra arguments that might be passed.  Just what
the function is expected to do depends on the keyword it is passed
as its first argument.  The following are the keywords defined at present:
</p><dl compact="compact">
<dt><code>:which-operations</code></dt>
<dd><p>Should return a list of the names of the operations the function handles.
</p>
</dd>
<dt><code>:print-self</code></dt>
<dd><p>The arguments are <code>:print-self</code>, the named structure, the stream to output to,
the current depth in
list-structure, and <code>t</code> if slashification is enabled (<code>prin1</code>
versus <code>princ</code>).  The printed representation of the named structure
should be output to the stream.  If the named structure symbol
is not defined as a function, or <code>:print-self</code> is not in its
<code>:which-operations</code> list, the printer will default to a reasonable
printed representation, namely:
</p><div class="lisp">
<pre class="lisp">#&lt;<em>named-structure-symbol</em> <em>octal-address</em>&gt;
</pre></div>

</dd>
<dt><code>:describe</code></dt>
<dd><a name="named_002dstructure_002ddescribe_002dmethod"></a><p>The arguments are <code>:describe</code> and the named structure.  It should
output a description of itself to <code>standard-output</code>.  If the named
structure symbol is not defined as a function, or <code>:describe</code> is not
in its <code>:which-operations</code> list, the describe system will
check whether the named structure was created by using the <code>:named</code>
option of <code>defstruct</code>; if so, the names and values of the structure&rsquo;s
fields will be enumerated.
</p>
</dd>
<dt><code>:sxhash</code></dt>
<dd><p>The arguments are <code>:sxhash</code>, the named structure, and a flag.  It
should return a hash code to use as the value of <code>sxhash</code> for this
structure.  It is often useful to call <code>sxhash</code> on some (perhaps all)
of the components of the structure and combine the results.
</p>
<p>The flag says that it is permissible to use the structure&rsquo;s address in
forming the hash code.  For some kinds of structure, there may be no way
to generate a good hash code except to use the address.  If
the flag is <code>nil</code>, they must simply do the best they can, even if it
means always returning zero.
</p>
<p>It is permissible to return <code>nil</code> for <code>:sxhash</code>.  Then <code>sxhash</code>
will produce a hash code in its default fashion.
</p></dd>
</dl>

<p>Here is an example of a simple named-structure handler function:
</p><div class="lisp">
<pre class="lisp">(defun (person named-structure-invoke) (op self &amp;rest args)
  (selectq op
    (:which-operations '(:print-self))
    (:print-self
      (format (first args)
	      (if (third args) &quot;#&lt;person ~A&gt;&quot; &quot;~A&quot;)
	      (person-name self)))))
</pre></div>
<p>For this definition to have any effect, the person <code>defstruct</code> used
as an example earlier must be modified to include the <code>:named</code> attribute.
</p>
<p>This handler causes a person structure to include its name in its printed
representation; it also causes <code>princ</code> of a person to print just the
name, with no &quot;<code>#&lt;</code>&quot; syntax.  Even though the astronaut structure of
our examples <code>:include</code>s the person structure, this named-structure
handler will not be invoked when an astronaut is printed, and an astronaut
will not include his name in his printed representation.  This is because
named structures are not as general as flavors (see <a href="#flavor">flavor</a>).
</p>
<p>The following functions operate on named structures.
</p>
<a name="named_002dstructure_002dp_002dfun"></a><dl>
<dt><a name="index-named_002dstructure_002dp"></a>Function: <strong>named-structure-p</strong> <em>x</em></dt>
<dd><p>This semi-predicate returns <code>nil</code> if <em>x</em> is not a named structure; otherwise
it returns <em>x</em>&rsquo;s named structure symbol.
</p></dd></dl>

<a name="named_002dstructure_002dsymbol_002dfun"></a><dl>
<dt><a name="index-named_002dstructure_002dsymbol"></a>Function: <strong>named-structure-symbol</strong> <em>x</em></dt>
<dd><p><em>x</em> should be a named structure.  This returns <em>x</em>&rsquo;s named structure
symbol: if <em>x</em> has an array leader, element 1 of the leader is returned,
otherwise element 0 of the array is returned.
</p></dd></dl>

<a name="make_002darray_002dinto_002dnamed_002dstructure_002dfun"></a><dl>
<dt><a name="index-make_002darray_002dinto_002dnamed_002dstructure"></a>Function: <strong>make-array-into-named-structure</strong> <em>array</em></dt>
<dd><p><em>array</em> is made to be a named structure and is returned.
</p></dd></dl>

<a name="named_002dstructure_002dinvoke_002dfun"></a><dl>
<dt><a name="index-named_002dstructure_002dinvoke"></a>Function: <strong>named-structure-invoke</strong> <em>operation structure &amp;rest args</em></dt>
<dd><p><em>operation</em> should be a keyword symbol, and <em>structure</em> should be a
named structure.  The handler function of the named structure symbol,
found as the value of the <code>named-structure-invoke</code> property of the
symbol, is called with appropriate arguments.  (This function used
to take its first two arguments in the opposite order, and that
argument order will continue to work indefinitely, but it should
not be used in new programs.)
</p></dd></dl>

<p>See also the <code>:named-structure-symbol</code> keyword to <code>make-array</code>, <a href="#make_002darray_002dfun">make-array-fun</a>.
</p>
<a name="The-si_003adefstruct_002ddescription-Structure"></a>
<h3 class="section">19.8 The si:defstruct-description Structure</h3>
<a name="defstruct_002ddescription"></a><p>This section discusses the internal structures used by
<code>defstruct</code> that might be useful to programs that want to interface
to <code>defstruct</code> nicely.  For example, if you want to write a program
that examines structures and displays them the way <code>describe</code>
(see <a href="#describe_002dfun">describe-fun</a>) and the Inspector do, your program will work
by examining these structures.
The information in this section is also
necessary for anyone who is thinking of defining his own structure
types.
</p>
<p>Whenever the user defines a new structure using <code>defstruct</code>,
<code>defstruct</code> creates an instance of the <code>si:defstruct-description</code> structure.
This structure can be found as the <code>si:defstruct-description</code> property of
the name of the structure; it contains such useful information as the
name of the structure, the number of slots in the structure, and so on.
	The <code>si:defstruct-description</code> structure is defined as follows,
in the <code>system-internals</code> package (also called the <code>si</code> package):
</p>
<div class="lisp">
<pre class="lisp">(defstruct (defstruct-description
		(:default-pointer description)
		(:conc-name defstruct-description-))
	   name
	   size
	   property-alist
	   slot-alist
	   documentation)
</pre></div>
<p>(This is a simplified version of the real definition.  There are other slots
in the structure, which we aren&rsquo;t telling you about.)
</p>
<p>The <code>name</code> slot contains the symbol supplied by the user to be
the name of his structure, such as <code>spaceship</code> or
<code>phone-book-entry</code>.
	The <code>size</code> slot contains the total number of locations in an
instance of this kind of structure.  This is <em>not</em> the same number as
that obtained from the <code>:size-symbol</code> or <code>:size-macro</code> options to
<code>defstruct</code>.  A named structure, for example, usually uses up an extra
location to store the name of the structure, so the <code>:size-macro</code> option
will get a number one larger than that stored in the <code>defstruct</code>
description.
	The <code>property-alist</code> slot contains an alist with pairs of the
form <code>(<em>property-name</em>  <em>property</em>)</code> containing properties placed there
by the <code>:property</code> option to <code>defstruct</code> or by property names used as
options to <code>defstruct</code> (see the <code>:property</code> option, <a href="#defstruct_002dproperty_002doption">defstruct-property-option</a>).
	The <code>slot-alist</code> slot contains an alist of pairs of the form
<code>(<em>slot-name</em>  <em>slot-description</em>)</code>.  A <em>slot-description</em> is
an instance of the <code>defstruct-slot-description</code> structure.  The
<code>defstruct-slot-description</code> structure is defined something like
this, also in the <code>si</code> package:
</p>
<div class="lisp">
<pre class="lisp"><a name="defstruct_002dslot_002ddescription_002dstructure"></a>(defstruct (defstruct-slot-description
		(:default-pointer slot-description)
		(:conc-name defstruct-slot-description-))
	   number
	   ppss
	   init-code
	   type
	   property-alist
	   ref-macro-name
	   documentation)
</pre></div>
<p>(This is also a simplified version of the real definition.)
	The <code>number</code> slot contains the number of the location of this
slot in an instance of the structure.  Locations are numbered,
starting with <code>0</code>, and continuing up to a number one less than the size of the
structure.  The actual location of the slot is determined by the
reference-consing function associated with the type of the structure; see
<a href="#defstruct_002dreference_002dconsing_002dfunction">defstruct-reference-consing-function</a>.
	The <code>ppss</code> slot contains the byte specifier code for this slot if
this slot is a byte field of its location.  If this slot is the entire
location, then the <code>ppss</code> slot contains <code>nil</code>.
	The <code>init-code</code> slot contains the initialization code supplied
for this slot by the user in his <code>defstruct</code> form.  If there is no
initialization code for this slot then the init-code slot contains the
symbol <code>si:%%defstruct-empty%%</code>.
	The <code>ref-macro-name</code> slot contains the symbol that is defined as
a macro or a subst that expands into a reference to this slot (that is, the name
of the accessor function).
</p>
<a name="Extensions-to-Defstruct"></a>
<h3 class="section">19.9 Extensions to Defstruct</h3>
<a name="defining_002dyour_002down_002ddefstruct_002dtypes"></a>
<p>The macro <code>defstruct-define-type</code> can be used to teach <code>defstruct</code>
about new types that it can use to implement structures.
</p>
<a name="defstruct_002ddefine_002dtype_002dfun"></a><dl>
<dt><a name="index-defstruct_002ddefine_002dtype"></a>Macro: <strong>defstruct-define-type</strong></dt>
<dd><p>This macro is used for teaching <code>defstruct</code> about new types; it is described
in the rest of this chapter.
</p></dd></dl>

<a name="An-Example"></a>
<h4 class="subsection">19.9.1 An Example</h4>

<p>Let us start by examining a sample call to
<code>defstruct-define-type</code>.  This is how the <code>:list</code> type of structure might
have been defined:
</p>
<div class="lisp">
<pre class="lisp">(defstruct-define-type :list
	(:cons (initialization-list description keyword-options) 
	       :list
	       `(list . ,initialization-list))
	(:ref (slot-number description argument)
	      `(nth ,slot-number ,argument)))
</pre></div>

<p>This is the simplest possible form of <code>defstruct-define-type</code>.  It
provides <code>defstruct</code> with two Lisp forms: one for creating forms to
construct instances of the structure, and one for creating forms to
become the bodies of accessors for slots of the structure.
</p>
<p>The keyword <code>:cons</code> is followed by a list of three variables that will
be bound while the constructor-creating form is evaluated.  The first,
<code>initialization-list</code>, will be bound to a list of the initialization
forms for the slots of the structure.  The second, <code>description</code>, will
be bound to the <code>defstruct-description</code> structure for the structure
(see <a href="#defstruct_002ddescription">defstruct-description</a>).  The third variable and the <code>:list</code> keyword
will be explained later.
</p>
<p>The keyword <code>:ref</code> is followed by a list of three variables that will
be bound while the accessor-creating form is evaluated.  The first,
<code>slot-number</code>, will bound to the number of the slot that the new accessor
should reference.  The second, <code>description</code>, will be bound to the
<code>defstruct-description</code> structure for the structure.  The third, <code>argument</code>,
will be bound to the form that was provided as the argument to the accessor.
</p>
<a name="Syntax-of-defstruct_002ddefine_002dtype"></a>
<h4 class="subsection">19.9.2 Syntax of defstruct-define-type</h4>

<p>The syntax of <code>defstruct-define-type</code> is:
</p>
<div class="lisp">
<pre class="lisp">(defstruct-define-type <em>type</em>
	<em>option-1</em>
	<em>option-2</em>
	...)
</pre></div>
<p>where each <em>option</em> is either the symbolic name of an option or a list of
the form <code>(<em>option-name</em>   <em>rest</em>)</code>.  Different options interpret
<em>rest</em> in different ways.  The symbol <em>type</em> is given an
<code>si:defstruct-type-description</code> property of a structure that describes the type
completely.
</p>

<a name="Options-to-defstruct_002ddefine_002dtype"></a>
<h4 class="subsection">19.9.3 Options to defstruct-define-type</h4>

<p>This section is a catalog of all the options currently known
about by <code>defstruct-define-type</code>.
</p>
<dl compact="compact">
<dt><code>:cons</code></dt>
<dd><a name="index-_003acons-defstruct_002ddefine_002dtype"></a>
<a name="defstruct_002dreference_002dconsing_002dfunction"></a><p>With the <code>:cons</code> option to <code>defstruct-define-type</code> you
supply <code>defstruct</code> with the code to cons up a
form that will construct an instance of a structure of this type.
</p>
<p>The <code>:cons</code> option has the syntax:
</p><div class="lisp">
<pre class="lisp">(:cons (<em>inits</em> <em>description</em> <em>keywords</em>) <em>kind</em>
       <em>body</em>)
</pre></div>
<p><em>body</em> is some code that should construct and return a piece
of code that will construct, initialize, and return an instance of a
structure of this type.
</p>
<p>The symbol <em>inits</em> will be bound to the information that the
constructor conser should use to initialize the slots of the
structure.  The exact form of this argument is determined by the
symbol <em>kind</em>.  There are currently two kinds of initialization.
There is the <code>:list</code> kind, where <em>inits</em> is bound to a list of
initializations, in the correct order, with <code>nil</code>s in uninitialized
slots.  And there is the <code>:alist</code> kind, where <em>inits</em> is bound to an
alist with pairs of the form <code>(<em>slot-number</em>  <em>init-code</em>)</code>.
</p>
<p>The symbol <em>description</em> will be bound to the instance of the
<code>defstruct-description</code> structure (see <a href="#defstruct_002ddescription">defstruct-description</a>) that
<code>defstruct</code> maintains for this particular structure.  This is so that
the constructor conser can find out such things as the total size of
the structure it is supposed to create.
</p>
<p>The symbol <em>keywords</em> will be bound to an alist with pairs of the form
<code>(<em>keyword</em>  <em>value</em>)</code>, where each <em>keyword</em> was a keyword supplied to
the constructor macro that wasn&rsquo;t the name of a slot, and <em>value</em> was the Lisp
object that followed the keyword.  This is how you can make your own special
keywords, like the existing <code>:make-array</code> and <code>:times</code> keywords.  See the
section on using the constructor macro, <a href="#using_002ddefstruct_002dconstructor">using-defstruct-constructor</a>.  You
specify the list of acceptable keywords with
the <code>:keywords</code> option (see <a href="#defstruct_002ddefine_002dtype_002dkeywords">defstruct-define-type-keywords</a>).
	It is an error not to supply the <code>:cons</code> option to
<code>defstruct-define-type</code>.
</p>
</dd>
<dt><code>:ref</code></dt>
<dd><a name="index-_003aref-defstruct_002ddefine_002dtype"></a>
<p>With the <code>:ref</code> option to <code>defstruct-define-type</code> you supply
<code>defstruct</code> with the code to cons up a form that will reference an
instance of a structure of this type.
</p>
<p>The <code>:ref</code> option has the syntax:
</p><div class="lisp">
<pre class="lisp">(:ref (<em>number</em> <em>description</em> <em>arg-1</em> ... <em>arg-n</em>)
      <em>body</em>)
</pre></div>
<p><em>body</em> is some code that should construct and return a piece
of code that will reference an instance of a structure of this type.
</p>
<p>The symbol <em>number</em> will be bound to the location of the slot
that is to be referenced.  This is the same number that is found
in the number slot of the <code>defstruct-slot-description</code> structure
(see <a href="#defstruct_002dslot_002ddescription_002dstructure">defstruct-slot-description-structure</a>).
</p>
<p>The symbol <em>description</em> will be bound to the instance of the
<code>defstruct-description</code> structure that <code>defstruct</code> maintains for this
particular structure.
</p>
<p>The symbols <em>arg-i</em> are bound to the forms supplied to the accessor as
arguments.  Normally there should be only one of these.  The <em>last</em> argument
is the one that will be defaulted by the <code>:default-pointer</code> option (see
<a href="#defstruct_002ddefault_002dpointer_002doption">defstruct-default-pointer-option</a>).  <code>defstruct</code> will check that the user
has supplied exactly <em>n</em> arguments to the accessor function before calling the
reference consing code.
</p>
<p>It is an error not to supply the <code>:ref</code> option to
<code>defstruct-define-type</code>. 
</p>
</dd>
<dt><code>:overhead</code></dt>
<dd><a name="index-_003aoverhead-defstruct_002ddefine_002dtype"></a>
<p>The <code>:overhead</code> option to <code>defstruct-define-type</code> is how the user
declares to <code>defstruct</code> that the implementation of this particular type
of structure &quot;uses up&quot; some number of locations in the object
actually constructed.  This option is used by various &quot;named&quot; types of
structures that store the name of the structure in one location.
</p>
<p>The syntax of <code>:overhead</code> is <code>(:overhead <em>n</em>)</code>, where <em>n</em> is a
fixnum that says how many locations of overhead this type needs.
</p>
<p>This number is used only by the <code>:size-macro</code> and <code>:size-symbol</code>
options to <code>defstruct</code> (see <a href="#defstruct_002dsize_002dsymbol_002doption">defstruct-size-symbol-option</a>).
</p>
</dd>
<dt><code>:named</code></dt>
<dd><a name="index-_003anamed-defstruct_002ddefine_002dtype"></a>
<p>The <code>:named</code> option to <code>defstruct-define-type</code> controls the use of
the <code>:named</code> option to <code>defstruct</code>.  With no argument, the <code>:named</code> option
means that this type is an acceptable &quot;named structure&quot;.  With an
argument, as in <code>(:named <em>type-name</em>)</code>, the symbol <em>type-name</em> should be
the name of some other structure type that <code>defstruct</code> should use if
someone asks for the named version of this type.  (For example, in the
definition of the <code>:list</code> type the <code>:named</code> option is used like this:
<code>(:named :named-list)</code>.)
</p>
</dd>
<dt><code>:cons-keywords</code></dt>
<dd><a name="index-_003acons_002dkeywords-defstruct_002ddefine_002dtype"></a>
<a name="defstruct_002ddefine_002dtype_002dkeywords"></a><p>The <code>:cons-keywords</code> option to <code>defstruct-define-type</code> allows the user to
define additional constructor keywords for this type of structure.  (The
<code>:make-array</code> constructor keyword for structures of type <code>:array</code> is an
example.)  The syntax is: <code>(:cons-keywords <em>keyword-1</em> ... <em>keyword-n</em>)</code> where
each <em>keyword</em> is a symbol that the constructor conser expects to find in
the <em>keywords</em> alist (explained above).
</p>
</dd>
<dt><code>:keywords</code></dt>
<dd><a name="index-_003akeywords-defstruct_002ddefine_002dtype"></a>
<p><code>:keywords</code> is an old name for the <code>:cons-keywords</code> option.
</p>
</dd>
<dt><code>:defstruct-keywords</code></dt>
<dd><a name="index-_003adefstruct_002dkeywords-defstruct_002ddefine_002dtype"></a>
<p>The <code>:defstruct-keywords</code> option to <code>defstruct-define-type</code> allows
the user to define additional defstruct keywords for this type of
structure.  (The <code>:times</code> defstruct constructor keyword for structures of
type <code>:grouped-array</code> is an example.)  The syntax is: <code>(:defstruct-keywords
<em>keyword-1</em> ... <em>keyword-n</em>)</code> where each <em>keyword</em> is a symbol
that <code>defstruct</code> expects to find to put in the <code>property-alist</code>
slot of the <code>defstuct-description</code> structure (defined above)
</p>

</dd>
<dt><code>:predicate defstruct-define-type</code></dt>
<dd><p>With the <code>:predicate</code> option to <code>defstruct-define-type</code>,
<code>defstruct</code> is told how to produce predicates for a particular type
(for the <code>:predicate</code> option to <code>defstruct</code>).  Its syntax is:
</p><div class="lisp">
<pre class="lisp">(predicate (<em>description</em> <em>name</em>)
   <em>body</em>...)
</pre></div>
<p>The variable <em>description</em> will be bound to the <code>defstruct-description</code> structure
maintained for the structure we are to generate a predicate for.  The variable
<em>name</em> is bound to the symbol that is to be defined as a predicate.  <em>body</em> is
a piece of code to evaluate to return the defining form for the predicate.  A
typical use of this option might look like:
</p><div class="lisp">
<pre class="lisp">(predicate (description name)
  `(defun ,name (x)
     (and (frobbozp x)
	  (eq (frobbozref x 0)
	      ',(defstruct-description-name)))))
</pre></div>

</dd>
<dt><code>:copier defstruct-define-type</code></dt>
<dd><p><code>defstruct</code> knows how to generate a copier function using the
constructor and reference macro code that must be provided with any new
defstruct type.  Nevertheless it is sometimes desirable to specify a
specific method of copying a particular defstruct type.  The <code>:copier</code>
option to <code>defstruct-define-type</code> allow this to be done:
</p><div class="lisp">
<pre class="lisp">(copier (<em>description</em> <em>name</em>)
 <em>body</em>)
</pre></div>
<p>As with the <code>:predicate</code> option, <em>description</em> is bound to an instance of the
<code>defstruct-description</code> structure, <em>name</em> is bound to the symbol to be defined,
and <em>body</em> is some code to evaluate to get the defining form.  For example:
</p><div class="lisp">
<pre class="lisp">(copier (description name)
  `(fset-carefully ',name 'copy-frobboz))
</pre></div>

</dd>
<dt><code>:defstruct</code></dt>
<dd><a name="index-_003adefstruct-defstruct_002ddefine_002dtype"></a>
<p>The <code>:defstruct</code> option to <code>defstruct-define-type</code> allows the user
to run some code and return some forms as part of the expansion of the
<code>defstruct</code> macro.
</p>
<p>The <code>:defstruct</code> option has the syntax:
</p><div class="lisp">
<pre class="lisp">(:defstruct (<em>description</em>)
	    <em>body</em>)
</pre></div>
<p><em>body</em> is a piece of code that will be run whenever <code>defstruct</code>
is expanding a <code>defstruct</code> form that defines a structure of this type.
The symbol <em>description</em> will be bound to the instance of the
<code>defstruct-description</code> structure that <code>defstruct</code> maintains for this
particular structure.
</p>
<p>The value returned by the <em>body</em> should be a <em>list</em>
of forms to be included with those that the <code>defstruct</code> expands into.
Thus, if you only want to run some code at <code>defstruct</code>-expand time, and
you don&rsquo;t want to actually output any additional code, then you should
be careful to return <code>nil</code> from the code in this option.
</p>
<p><code>defstruct</code> will cause the <em>body</em> forms to be evaluated as early as possible in the
parsing of a structure definition, and for the returned forms to be evalutated as late
as possible in the macro-expansion of the <code>defstuct</code> forms. This is so that <em>body</em>
can rehack arguments, signal errors, and the like before many of <code>defstruct</code>&rsquo;s
internal forms are exectuted, while enabling it to return code which will modify or extend
the default forms produced by a vanilla <code>defstuct</code>.
</p>
</dd>
</dl>
<p>fo</p>

<a name="Objects_002c-Message-Passing_002c-and-Flavors"></a>
<h2 class="chapter">20 Objects, Message Passing, and Flavors</h2>
<a name="flavor_002dchapter"></a><a name="index-flavor"></a>
<a name="index-message"></a>
<a name="index-method"></a>
<a name="index-object"></a>
<a name="index-instance"></a>
<a name="flavor"></a>
<p>The object-oriented programming style used in the Smalltalk and
Actor families of languages is available in Zetalisp and used
by the Lisp Machine software system.  Its purpose is to perform
<em>generic operations</em> on objects.  Part of its implementation is
simply a convention in procedure-calling style; part is a powerful
language feature, called Flavors, for defining abstract objects.
This chapter attempts to explain what programming with objects and with
message passing means, the various means of implementing these in
Zetalisp, and when you should use them.  It assumes no prior
knowledge of any other languages.
</p>
<a name="Objects"></a>
<h3 class="section">20.1 Objects</h3>

<p>When writing a program, it is often convenient to model what the program
does in terms of <em>objects</em>, conceptual entities that can be likened to
real-world things.  Choosing what objects to provide in a program is
very important to the proper organization of the program.  In an
object-oriented design, specifying what objects exist is the first
task in designing the system.  In a text editor, the objects might be
&quot;pieces of text&quot;, &quot;pointers into text&quot;, and &quot;display windows&quot;.  In an
electrical design system, the objects might be &quot;resistors&quot;,
&quot;capacitors&quot;, &quot;transistors&quot;, &quot;wires&quot;, and &quot;display windows&quot;.  After
specifying what objects there are, the next task of the design is to
figure out what operations can be performed on each object.  In the text
editor example, operations on &quot;pieces of text&quot; might include inserting
text and deleting text; operations on &quot;pointers into text&quot; might include
moving forward and backward; and operations on &quot;display windows&quot; might
include redisplaying the window and changing which &quot;piece of text&quot; the
window is associated with.
</p>
<p>In this model, we think of the program as being built around a set of
objects, each of which has a set of operations that can be performed on
it.  More rigorously, the program defines several <em>types</em> of object
(the editor above has three types), and it can create many <em>instances</em>
of each type (that is, there can be many pieces of text, many pointers
into text, and many windows).  The program defines a set of types of
object and, for each type, a set of operations that can be performed on
any object of the type.
</p>
<p>This should not be wholly unfamiliar to the reader.  Earlier in this
manual, we saw a few examples of this kind of programming.  A simple
example is disembodied property lists, and the functions <code>get</code>,
<code>putprop</code>, and <code>remprop</code>.  The disembodied property list is a type of
object; you can instantiate one with <code>(cons nil nil)</code> (that is, by
evaluating this form you can create a new disembodied property list);
there are three operations on the object, namely <code>get</code>, <code>putprop</code>,
and <code>remprop</code>.  Another example in the manual was the first example of
the use of <code>defstruct</code>, which was called a <code>ship</code>.  <code>defstruct</code>
automatically defined some operations on this object, the operations to
access its elements.  We could define other functions that did useful
things with <code>ship</code>s, such as computing their speed, angle of travel,
momentum, or velocity, stopping them, moving them elsewhere, and so on.
</p>
<p>In both cases, we represent our conceptual object by one Lisp object.
The Lisp object we use for the representation has <em>structure</em> and refers
to other Lisp objects.  In the property list case, the Lisp object is a
list with alternating indicators and values; in the <code>ship</code> case, the
Lisp object is an array whose details are taken care of by
<code>defstruct</code>.  In both cases, we can say that the object keeps track of
an <em>internal state</em>, which can be <em>examined</em> and <em>altered</em> by the
operations available for that type of object.  <code>get</code> examines the state
of a property list, and <code>putprop</code> alters it; <code>ship-x-position</code>
examines the state of a ship, and <code>(setf (ship-mass) 5.0)</code> alters it.
</p>
<p>We have now seen the essence of object-oriented programming.  A
conceptual object is modeled by a single Lisp object, which bundles up
some state information.  For every type of object, there is a set of
operations that can be performed to examine or alter the state of the
object.
</p>
<a name="Modularity"></a>
<h3 class="section">20.2 Modularity</h3>

<p>An important benefit of the object-oriented style is that it lends
itself to a particularly simple and lucid kind of modularity.
If you have modular programming constructs and techniques available,
they help and encourage you to write
programs that are easy to read and understand, and so are more
reliable and maintainable.  Object-oriented programming lets a
programmer implement a useful facility that presents the caller with a set
of external interfaces, without requiring the caller to understand how
the internal details of the implementation work.  In other words, a program
that calls this facility can treat the facility as a black box; the
program knows what the facility&rsquo;s external interfaces guarantee to do,
and that is all it knows.
</p>
<p>For example, a program that uses disembodied property lists never needs
to know that the property list is being maintained as a list of
alternating indicators and values; the program simply performs the
operations, passing them inputs and getting back outputs.  The program
only depends on the external definition of these operations: it knows
that if it <code>putprop</code>s a property, and doesn&rsquo;t <code>remprop</code> it (or
<code>putprop</code> over it), then it can do <code>get</code> and be sure of getting back
the same thing it put in.  The important thing about this hiding of
the details of the implementation is that someone reading a program that uses disembodied
property lists need not concern himself with how they are implemented;
he need only understand what they undertake to do.  This saves the
programmer a lot of time and lets him concentrate his energies on
understanding the program he is working on.  Another good thing about
this hiding is that the representation of property lists could be
changed and the program would continue to work.  For example, instead
of a list of alternating elements, the property list could be
implemented as an association list or a hash table.  Nothing in the
calling program would change at all.
</p>
<p>The same is true of the <code>ship</code> example.  The caller is presented with
a collection of operations, such as <code>ship-x-position</code>,
<code>ship-y-position</code>, <code>ship-speed</code>, and <code>ship-direction</code>; it simply
calls these and looks at their answers, without caring how they did what
they did.  In our example above, <code>ship-x-position</code> and
<code>ship-y-position</code> would be accessor functions, defined automatically
by <code>defstruct</code>, while <code>ship-speed</code> and <code>ship-direction</code> would be
functions defined by the implementor of the <code>ship</code> type.  The code
might look like this:
</p>
<div class="lisp">
<pre class="lisp">(defstruct (ship)
  ship-x-position
  ship-y-position
  ship-x-velocity
  ship-y-velocity
  ship-mass)

(defun ship-speed (ship)
  (sqrt (+ (^ (ship-x-velocity ship) 2)
           (^ (ship-y-velocity ship) 2))))

(defun ship-direction (ship)
  (atan (ship-y-velocity ship)
        (ship-x-velocity ship)))
</pre></div>

<p>The caller need not know that the first two functions were structure accessors
and that the second two were written by hand and do arithmetic.  Those
facts would not be considered part of the black box characteristics of
the implementation of the <code>ship</code> type.  The <code>ship</code> type does not
guarantee which functions will be implemented in which ways; such aspects
are not part of the contract between <code>ship</code> and its callers.  In fact,
<code>ship</code> could have been written this way instead:
</p>
<div class="lisp">
<pre class="lisp">(defstruct (ship)
  ship-x-position
  ship-y-position
  ship-speed
  ship-direction
  ship-mass)

(defun ship-x-velocity (ship)
  (* (ship-speed ship) (cos (ship-direction ship))))

(defun ship-y-velocity (ship)
  (* (ship-speed ship) (sin (ship-direction ship))))
</pre></div>

<p>In this second implementation of the <code>ship</code> type, we have decided to
store the velocity in polar coordinates instead of rectangular
coordinates.  This is purely an implementation decision.  The caller has
no idea which of the two ways the implementation uses; he just
performs the operations on the object by calling the appropriate
functions.
</p>
<p>We have now created our own types of objects, whose implementations are
hidden from the programs that use them.  Such types are usually referred to as
<em>abstract types</em>.  The object-oriented style of programming can be
used to create abstract types by hiding the implementation of the
operations and simply documenting what the operations are defined to do.
</p>
<p>Some more terminology: the quantities being held by the elements of the
<code>ship</code> structure are referred to as <em>instance variables</em>.  Each
instance of a type has the same operations defined on it; what
distinguishes one instance from another (besides <code>eq</code>ness)
is the values that reside in its instance variables.  The example above
illustrates that a caller of operations does not know what the instance
variables are; our two ways of writing the <code>ship</code> operations have
different instance variables, but from the outside they have exactly the
same operations.
</p>
<p>One might ask: &quot;But what if the caller evaluates <code>(aref ship 2)</code> and
notices that he gets back the x-velocity rather than the speed?  Then he
can tell which of the two implementations were used.&quot;  This is true; if
the caller were to do that, he could tell.  However, when a facility is
implemented in the object-oriented style, only certain functions are
documented and advertised, the functions that are considered to be
operations on the type of object.  The contract from <code>ship</code> to its
callers only speaks about what happens if the caller calls these
functions.  The contract makes no guarantees at all about what would
happen if the caller were to start poking around on his own using
<code>aref</code>.  A caller who does so <em>is in error</em>; he is depending on
something that is not specified in the contract.  No guarantees were
ever made about the results of such action, and so anything may happen;
indeed, <code>ship</code> may get reimplemented overnight, and the code that does
the <code>aref</code> will have a different effect entirely and probably stop
working.  This example shows why the concept of a contract between a callee and
a caller is important: the contract specifies the interface
between the two modules.
</p>
<p>Unlike some other languages that provide abstract types, Zetalisp
makes no attempt to have the language automatically forbid
constructs that circumvent the contract.  This is intentional.  One
reason for this is that the Lisp Machine is an interactive system, and
so it is important to be able to examine and alter internal state
interactively (usually from a debugger).  Furthermore, there is no
strong distinction between the &quot;system&quot; programs and the &quot;user&quot; programs
on the Lisp Machine; users are allowed to get into any part of the
language system and change what they want to change.
</p>
<p>In summary: by defining a set of operations and making only a
specific set of external entrypoints available to the caller, the
programmer can create his own abstract types.  These types can be useful
facilities for other programs and programmers.  Since the implementation
of the type is hidden from the callers, modularity is maintained and
the implementation can be changed easily.
</p>
<p>We have hidden the implementation of an abstract type by making its
operations into functions which the user may call.  The important thing
is not that they are functions&ndash;in Lisp everything is done with functions.
The important thing is that we have defined a new conceptual operation
and given it a name, rather than requiring anyone who wants to do the
operation to write it out step-by-step.  Thus we say <code>(ship-x-velocity s)</code>
rather than <code>(aref s 2)</code>.
</p>
<p>It is just as true of such abstract-operation functions as of ordinary
functions that sometimes they are simple enough that we want the compiler
to compile special code for them rather than really calling the function.
(Compiling special code like this is often called <em>open-coding</em>.)
The compiler is directed to do this through use of macros, defsubsts, or
optimizers.  <code>defstruct</code> arranges for this kind of special compilation
for the functions that get the instance variables of a structure.
</p>
<p>When we use this optimization, the implementation of the abstract type
is only hidden in a certain sense.  It does not appear in the Lisp code
written by the user, but does appear in the compiled code.  The reason
is that there may be some compiled functions that use the macros (or whatever);
even if you change the definition of the macro, the existing compiled
code will continue to use the old definition.  Thus, if
the implementation of a module is changed programs that use it may need to be
recompiled.  This is something we sometimes accept for the sake of
efficiency.
</p>
<p>In the present implementation of flavors, which is discussed below,
there is no such compiler incorporation of nonmodular knowledge into a
program, except when the <code>:ordered-instance-variables</code> feature is
used; see <a href="#ordered_002dinstance_002dvariables_002doption">ordered-instance-variables-option</a>, where this problem is
explained further.  If you don&rsquo;t use the
<code>:ordered-instance-variables</code>&quot; feature, you don&rsquo;t have to worry about
this.
</p>
<a name="Generic-Operations"></a>
<h3 class="section">20.3 Generic Operations</h3>

<p>Suppose we think about the rest of the program that uses the
<code>ship</code> abstraction.  It may want to deal with other objects that are
like <code>ship</code>s in that they are movable objects with mass, but unlike
<code>ship</code>s in other ways.  A more advanced model of a ship might include
the concept of the ship&rsquo;s engine power, the number of passengers on
board, and its name.  An object representing a meteor probably would
not have any of these, but might have another attribute such as how
much iron is in it.
</p>
<p>However, all kinds of movable objects have positions, velocities, and
masses, and the system will contain some programs that deal with these
quantities in a uniform way, regardless of what kind of object the
attributes apply to.  For example, a piece of the system that calculates
every object&rsquo;s orbit in space need not worry about the other, more
peripheral attributes of various types of objects; it works the same way
for all objects.  Unfortunately, a program that tries to calculate the
orbit of a ship will need to know the ship&rsquo;s attributes, and will have
to call <code>ship-x-position</code> and <code>ship-y-velocity</code> and so on.  The problem is
that these functions won&rsquo;t work for meteors.  There would have to be a
second program to calculate orbits for meteors that would be exactly the
same, except that where the first one calls <code>ship-x-position</code>, the
second one would call <code>meteor-x-position</code>, and so on.  This would be
very bad; a great deal of code would have to exist in multiple copies,
all of it would have to be maintained in parallel, and it would take up
space for no good reason.
</p>
<p>What is needed is an operation that can be performed on objects of
several different types.  For each type, it should do the thing
appropriate for that type.  Such operations are called <em>generic</em>
operations.  The classic example of generic operations is the arithmetic
functions in most programming languages, including Zetalisp.
The <code>+</code> (or <code>plus</code>) function will accept either fixnums or flonums,
and perform either fixnum addition or flonum addition, whichever is
appropriate, based on the data types of the objects being manipulated.
In our example, we need a generic <code>x-position</code> operation that can be
performed on either <code>ship</code>s, <code>meteor</code>s, or any other kind of mobile
object represented in the system.  This way, we can write a single
program to calculate orbits.  When it wants to know the <em>x</em> position
of the object it is dealing with, it simply invokes the generic
<code>x-position</code> operation on the object, and whatever type of object it
has, the correct operation is performed, and the <em>x</em> position is
returned.
</p>
<p>Another terminology for the use of such generic operations has emerged
from the Smalltalk and Actor languages: performing a generic operation
is called <em>sending a message</em>.  The message consists of an operation
name (a symbol) and arguments.  The objects in the program are thought
of as little people, who get sent messages and respond with answers
(returned values).  In the example above, the objects are sent
<code>x-position</code> messages, to which they respond with their <em>x</em>
position.
</p>
<p>Sending a message is a way of invoking a function without specifying
which function is to be called.  Instead, the data determines the
function to use.  The caller specifies an operation name and an object;
that is, it said what operation to perform, and what object to perform
it on.  The function to invoke is found from this information.
</p>
<p>The two data used to figure out which function
to call are the <em>type</em> of the object, and the <em>name</em> of the operation.
The same set of functions are used for all instances of a given type, so
the type is the only attribute of the object used to figure out which
function to call.  The rest of the message besides the operation are data
which are passed as arguments to the function, so the operation is the only
part of the message used to find the function.  Such a function is
called a <em>method</em>.  For example, if we send an <code>x-position</code> message
to an object of type <code>ship</code>, then the function we find is &quot;the
<code>ship</code> type&rsquo;s <code>x-position</code> method&quot;.  A method is a function that
handles a specific operation on a specific kind of object; this
method handles messages named <code>x-position</code> to objects of type
<code>ship</code>.
</p>
<p>In our new terminology: the orbit-calculating program finds the <em>x</em>
position of the object it is working on by sending that object a message
consisting of the operation <code>x-position</code> and no arguments.  The
returned value of the message is the <em>x</em> position of the object.  If
the object was of type <code>ship</code>, then the <code>ship</code> type&rsquo;s <code>x-position</code>
method was invoked; if it was of type <code>meteor</code>, then the <code>meteor</code>
type&rsquo;s <code>x-position</code> method was invoked.  The orbit-calculating program
just sends the message, and the right function is invoked based on the
type of the object.  We now have true generic functions, in the form of
message passing: the same operation can mean different things depending
on the type of the object.
</p>
<a name="Generic-Operations-in-Lisp"></a>
<h3 class="section">20.4 Generic Operations in Lisp</h3>

<p>How do we implement message passing in Lisp?  Our convention is that objects
that receive messages are always <em>functional</em> objects (that is, you
can apply them to arguments).  A message is sent to an object by
calling that object as a function, passing the operation name as
the first argument and the arguments of the message as the rest of the
arguments.  Operation names are represented by symbols; normally these
symbols are in the keyword package (see <a href="#package">package</a>), since messages are
a protocol for communication between different programs, which may
reside in different packages.  So if we have a variable <code>my-ship</code>
whose value is an object of type <code>ship</code>, and we want to know its
<em>x</em> position, we send it a message as follows:
</p>
<div class="lisp">
<pre class="lisp">(funcall my-ship ':x-position)
</pre></div>

<p>This form returns the <em>x</em> position as its returned value.  To set the
ship&rsquo;s <em>x</em> position to <code>3.0</code>, we send it a message like this:
</p>
<div class="lisp">
<pre class="lisp">(funcall my-ship ':set-x-position 3.0)
</pre></div>

<p>It should be stressed that no new features are added to Lisp for message
sending; we simply define a convention on the way objects take
arguments.  The convention says that an object accepts messages by
always interpreting its first argument as an operation name.  The object
must consider this operation name, find the function which is the method
for that operation, and invoke that function.
</p>
<a name="send_002dfun"></a><dl>
<dt><a name="index-send"></a>Function: <strong>send</strong> <em>object operation &amp;rest arguments</em></dt>
<dd><p>Sends <em>object</em> a message with operation and arguments as specified.
Currently <code>send</code> is identical to <code>funcall</code>, but preferable when
a message is being sent, just for clarity.
</p>
<p>There are vague ideas of making <em>send</em> different from <em>funcall</em>
if <em>object</em> is a symbol, list, number, or other object that does not
normally handle messages when funcalled, but the meaning of this is
not completely clear.
</p></dd></dl>

<a name="lexpr_002dsend_002dfun"></a><dl>
<dt><a name="index-lexpr_002dsend"></a>Function: <strong>lexpr-send</strong> <em>object operation &amp;rest arguments</em></dt>
<dd><p>Currently <code>lexpr-send</code> is the same as <code>lexpr-funcall</code>.
</p></dd></dl>

<p>This raises the question of how message receiving works.  The object
must somehow find the right method for the message it is sent.
Furthermore, the object now has to be callable as a function; objects
can&rsquo;t just be <code>defstructs</code> any more, since those aren&rsquo;t functions.  But
the structure defined by <code>defstruct</code> was doing something useful: it
was holding the instance variables (the internal state) of the object.
We need a function with internal state; that is, we need a coroutine.
</p>
<p>Of the Zetalisp features presented so far, the most appropriate
is the closure (see <a href="#closure">closure</a>).  A message-receiving object could be
implemented as a closure over a set of instance variables.  The function
inside the closure would have a big <code>selectq</code> form to dispatch on its
first argument.  (Actually, rather than using closures and a <code>selectq</code>,
you would probably use entities and <code>defselect</code>; see <a href="#entity">entity</a>.)
</p>
<a name="entity_002dusage"></a>
<p>While using closures (or entities) does work, it has several serious
problems.  The main problem is that in order to add a new operation to a
system, it is necessary to modify a lot of code; you have to find all
the types that understand that operation, and add a new clause to the
<code>selectq</code>.  The problem with this is that you cannot textually
separate the implementation of your new operation from the rest of the
system; the methods must be interleaved with the other operations for
the type.  Adding a new operation should only require <em>adding</em> Lisp code;
it should not require <em>modifying</em> Lisp code.
</p>
<p>The conventional way of making generic operations is to have a procedure
for each operation, which has a big <code>selectq</code> for all the types; this
means you have to modify code to add a type.  The way described above is
to have a procedure for each type, which has a big <code>selectq</code> for all
the operations; this means you have to modify code to add an operation.
Neither of these has the desired property that extending the system
should only require adding code, rather than modifying code.
</p>
<p>Closures (and entities) are also somewhat clumsy and crude.  A far more
streamlined, convenient, and powerful system for creating
message-receiving objects exists; it is called the <em>flavor</em> mechanism.
With flavors, you can add a new method simply by adding code, without
modifying anything.  Furthermore, many common and useful things
are very easy to do with flavors.  The rest of this chapter describes
flavors.
</p>
<a name="Simple-Use-of-Flavors"></a>
<h3 class="section">20.5 Simple Use of Flavors</h3>

<p>A <em>flavor</em>, in its simplest form, is a definition of an abstract type.
New flavors are created with the <code>defflavor</code> special form, and
methods of the flavor are created with the <code>defmethod</code> special form.
New instances of a flavor are created with the <code>make-instance</code>
function.  This section explains simple uses of these forms.
</p>
<p>For an example of a simple use of flavors, here is how the <code>ship</code>
example above would be implemented.
</p>
<div class="lisp">
<pre class="lisp">(defflavor ship (x-position y-position 
                 x-velocity y-velocity mass)
	        ()
  :gettable-instance-variables)

(defmethod (ship :speed) ()
  (sqrt (+ (^ x-velocity 2)
           (^ y-velocity 2))))

(defmethod (ship :direction) ()
  (atan y-velocity x-velocity))
</pre></div>

<p>The code above creates a new flavor.  The first subform of the
<code>defflavor</code> is <code>ship</code>, which is the name of the new flavor.  Next
is the list of instance variables; they are the five that should be
familiar by now.  The next subform is something we will get to later.
The rest of the subforms are the body of the <code>defflavor</code>, and each
one specifies an option about this flavor.  In our example, there is
only one option, namely <code>:gettable-instance-variables</code>.  This means
that for each instance variable, a method should automatically be
generated to return the value of that instance variable.  The name of
the operation is a symbol with the same name as the instance variable, but
interned on the keyword package.  Thus, methods are created to handle
the operations <code>:x-position</code>, <code>:y-position</code>, and so on.
</p>
<p>Each of the two <code>defmethod</code> forms adds a method to the flavor.  The
first one adds a handler to the flavor <code>ship</code> for the operation
<code>:speed</code>.  The second subform is the lambda-list, and the rest is the
body of the function that handles the <code>:speed</code> operation.  The body can
refer to or set any instance variables of the flavor, the same as it can
with local variables or special variables.  When any instance of the
<code>ship</code> flavor is invoked with a first argument of <code>:direction</code>, the
body of the second <code>defmethod</code> will be evaluated in an environment in
which the instance variables of <code>ship</code> refer to the instance variables
of this instance (the one to which the message was sent).  So when the
arguments of <code>atan</code> are evaluated, the values of instance variables of
the object to which the message was sent will be used as the arguments.
<code>atan</code> will be invoked, and the result it returns will be returned by
the instance itself.
</p>
<p>Now we have seen how to create a new abstract type: a new flavor.  Every
instance of this flavor will have the five instance variables named in
the <code>defflavor</code> form, and the seven methods we have seen (five that
were automatically generated because of the
<code>:gettable-instance-variables</code> option, and two that we wrote
ourselves).  The way to create an instance of our new flavor is with the
<code>make-instance</code> function.  Here is how it could be used:
</p>
<div class="lisp">
<pre class="lisp">(setq my-ship (make-instance 'ship))
</pre></div>

<p>This will return an object whose printed representation is:
</p>
<div class="lisp">
<pre class="lisp">#&lt;SHIP 13731210&gt;
</pre></div>

<p>(Of course, the value of the magic number will vary; it is not
interesting anyway.)  The argument to <code>make-instance</code> is,
as you can see, the name of the flavor to be instantiated.  Additional
arguments, not used here, are <em>init options</em>, that is, commands
to the flavor of which we are making an instance, selecting optional
features.  This will be discussed more in a moment.
</p>
<p>Examination of the flavor we have defined shows that it is quite
useless as it stands, since there is no way to set any of the
parameters.  We can fix this up easily by putting the
<code>:settable-instance-variables</code> option into the <code>defflavor</code> form.
This option tells <code>defflavor</code> to generate methods for operations
<code>:set-x-position</code>, <code>:set-y-position</code>, and so on; each such method
takes one argument and sets the corresponding instance variable to the
given value.
</p>
<p>Another option we can add to the <code>defflavor</code> is
<code>:inittable-instance-variables</code>, which allows us to initialize the values
of the instance variables when an instance is first created.
<code>:inittable-instance-variables</code> does not create any methods; instead,
it makes <em>initialization keywords</em> named <code>:x-position</code>,
<code>:y-position</code>, etc., that can be used as init-option arguments to
<code>make-instance</code> to initialize the corresponding instance variables.
The set of init options are sometimes called the <em>init-plist</em> because
they are like a property list.
</p>
<p>Here is the improved <code>defflavor</code>:
</p><div class="lisp">
<pre class="lisp">(defflavor ship (x-position y-position
                 x-velocity y-velocity mass) 
		()
  :gettable-instance-variables
  :settable-instance-variables
  :inittable-instance-variables)
</pre></div>

<p>All we have to do is evaluate this new <code>defflavor</code>, and the existing
flavor definition will be updated and now include the new methods and
initialization options.  In fact, the instance we generated a while ago
will now be able to accept these new operations!  We can set the mass of
the ship we created by evaluating
</p><div class="lisp">
<pre class="lisp">(funcall my-ship ':set-mass 3.0)
</pre></div>
<p>and the <code>mass</code> instance variable of <code>my-ship</code> will properly get set
to <code>3.0</code>.  If you want to play around with flavors, it is useful
to know that <code>describe</code> of an instance tells you the flavor of the
instance and the values of its instance variables.  If we were to evaluate
<code>(describe my-ship)</code> at this point, the following would be printed:
</p>
<div class="lisp">
<pre class="lisp">#&lt;SHIP 13731210&gt;, an object of flavor SHIP,
 has instance variable values:
	X-POSITION:         unbound
	Y-POSITION:         unbound
	X-VELOCITY:         unbound
	Y-VELOCITY:         unbound
	MASS:               3.0
</pre></div>

<p>Now that the instance variables are &quot;inittable&quot;, we can create another
ship and initialize some of the instance variables using the init-plist.
Let&rsquo;s do that and <code>describe</code> the result:
</p>
<div class="lisp">
<pre class="lisp">(setq her-ship (make-instance 'ship ':x-position 0.0
			            ':y-position 2.0
				    ':mass 3.5))
		=&gt; #&lt;SHIP 13756521&gt;


(describe her-ship)
#&lt;SHIP 13756521&gt;, an object of flavor SHIP,
 has instance variable values:
	X-POSITION:         0.0
	Y-POSITION:         2.0
	X-VELOCITY:         unbound
	Y-VELOCITY:         unbound
	MASS:               3.5
</pre></div>

<p>A flavor can also establish default initial values for instance
variables.  These default values are used when a new instance is created
if the values are not initialized any other way.  The syntax for
specifying a default initial value is to replace the name of the
instance variable by a list, whose first element is the name and whose
second is a form to evaluate to produce the default initial value.  For
example:
</p>
<div class="lisp">
<pre class="lisp">(defvar *default-x-velocity* 2.0)
(defvar *default-y-velocity* 3.0)

(defflavor ship ((x-position 0.0)
		 (y-position 0.0)
		 (x-velocity *default-x-velocity*)
		 (y-velocity *default-y-velocity*)
		 mass) 
		()
  :gettable-instance-variables
  :settable-instance-variables
  :inittable-instance-variables)

(setq another-ship (make-instance 'ship ':x-position 3.4))

(describe another-ship)
#&lt;SHIP 14563643&gt;, an object of flavor SHIP,
 has instance variable values:
	X-POSITION:         3.4
	Y-POSITION:         0.0
	X-VELOCITY:         2.0
	Y-VELOCITY:         3.0
	MASS:               unbound
</pre></div>

<p><code>x-position</code> was initialized explicitly, so the default was ignored.
<code>y-position</code> was initialized from the default value, which was
<code>0.0</code>.  The two velocity instance variables were initialized from
their default values, which came from two global variables.  <code>mass</code>
was not explicitly initialized and did not have a default
initialization, so it was left unbound.
</p>
<p>There are many other options that can be used in <code>defflavor</code>, and the
init options can be used more flexibly than just to initialize instance
variables; full details are given later in this chapter.  But even with
the small set of features we have seen so far, it is easy to write
object-oriented programs.
</p>
<a name="Mixing-Flavors"></a>
<h3 class="section">20.6 Mixing Flavors</h3>

<p>Now we have a system for defining message-receiving objects so that we
can have generic operations.  If we want to create a new type called
<code>meteor</code> that would accept the same generic operations as <code>ship</code>, we
could simply write another <code>defflavor</code> and two more <code>defmethods</code>
that looked just like those of <code>ship</code>, and then meteors and ships
would both accept the same operations.  <code>ship</code> would have some
more instance variables for holding attributes specific to ships
and some more methods for operations that are not generic, but
are only defined for ships; the same would be true of <code>meteor</code>.
</p>
<p>However, this would be a a wasteful thing to do.  The same code has to
be repeated in several places, and several instance variables have to be
repeated.  The code now needs to be maintained in many places, which is
always undesirable.  The power of flavors (and the name &quot;flavors&quot;) comes
from the ability to mix several flavors and get a new flavor.  Since the
functionality of <code>ship</code> and <code>meteor</code> partially overlap, we can take
the common functionality and move it into its own flavor, which might be
called <code>moving-object</code>.  We would define <code>moving-object</code> the same
way as we defined <code>ship</code> in the previous section.  Then, <code>ship</code> and
<code>meteor</code> could be defined like this:
</p>
<div class="lisp">
<pre class="lisp">(defflavor ship (engine-power number-of-passengers name) 
                (moving-object)
   :gettable-instance-variables)

(defflavor meteor (percent-iron) (moving-object)
   :inittable-instance-variables)
</pre></div>

<p>These <code>defflavor</code> forms use the second subform, which we ignored
previously.  The second subform is a list of flavors to be combined to
form the new flavor; such flavors are called <em>components</em>.
Concentrating on <code>ship</code> for a moment (analogous things are true of
<code>meteor</code>), we see that it has exactly one component flavor:
<code>moving-object</code>.  It also has a list of instance variables, which
includes only the ship-specific instance variables and not the ones that
it shares with <code>meteor</code>.  By incorporating <code>moving-object</code>, the <code>ship</code>
flavor acquires all of its instance variables, and so need not name them
again.  It also acquires all of <code>moving-object</code>&rsquo;s methods, too.  So
with the new definition, <code>ship</code> instances will still implement the
<code>:x-velocity</code> and <code>:speed</code> operations, and they will do the same thing.
However, the <code>:engine-power</code> operation will also be understood (and will
return the value of the <code>engine-power</code> instance variable).
</p>
<p>What we have done here is to take an abstract type, <code>moving-object</code>,
and build two more specialized and powerful abstract types on top of it.
Any ship or meteor can do anything a moving object can do, and each also
has its own specific abilities.  This kind of building can continue; we
could define a flavor called <code>ship-with-passenger</code> that was built on
top of <code>ship</code>, and it would inherit all of <code>moving-object</code>&rsquo;s
instance variables and methods as well as <code>ship</code>&rsquo;s instance variables
and methods.  Furthermore, the second subform of <code>defflavor</code> can be a
list of several components, meaning that the new flavor should combine
all the instance variables and methods of all the flavors in the list,
as well as the ones <em>those</em> flavors are built on, and so on.  All the
components taken together form a big tree of flavors.  A flavor is built
from its components, its components&rsquo; components, and so on.  We
sometimes use the term &quot;components&quot; to mean the immediate components
(the ones listed in the <code>defflavor</code>), and sometimes to mean all the
components (including the components of the immediate components and so
on).  (Actually, it is not strictly a tree, since some flavors might be
components through more than one path.  It is really a directed graph;
it can even be cyclic.)
</p>
<p>The order in which the components are combined to form a flavor is
important.  The tree of flavors is turned into an ordered list by
performing a <em>top-down, depth-first</em> walk of the tree, including
non-terminal nodes <em>before</em> the subtrees they head, ignoring any
flavor that has been encountered previously somewhere else in the tree.
For example, if <code>flavor-1</code>&rsquo;s immediate components are <code>flavor-2</code> and
<code>flavor-3</code>, and <code>flavor-2</code>&rsquo;s components are <code>flavor-4</code> and
<code>flavor-5</code>, and <code>flavor-3</code>&rsquo;s component was <code>flavor-4</code>, then the
complete list of components of <code>flavor-1</code> would be:
</p><div class="lisp">
<pre class="lisp">flavor-1, flavor-2, flavor-4, flavor-5, flavor-3
</pre></div>
<p>The flavors earlier in this list are the more specific, less basic ones;
in our example, <code>ship-with-passengers</code> would be first in the list,
followed by <code>ship</code>, followed by <code>moving-object</code>.  A flavor is always
the first in the list of its own components.  Notice that <code>flavor-4</code>
does not appear twice in this list.  Only the first occurrence of a
flavor appears; duplicates are removed.  (The elimination of duplicates
is done during the walk; if there is a cycle in the directed graph, it
will not cause a non-terminating computation.)
</p>
<p>The set of instance variables for the new flavor is the union of all the
sets of instance variables in all the component flavors.  If both
<code>flavor-2</code> and <code>flavor-3</code> have instance variables named <code>foo</code>,
then <code>flavor-1</code> will have an instance variable named <code>foo</code>, and any
methods that refer to <code>foo</code> will refer to this same instance variable.
Thus different components of a flavor can communicate with one another
using shared instance variables.  (Typically, only one component ever
sets the variable, and the others only look at it.)  The default initial
value for an instance variable comes from the first component flavor to
specify one.
</p>
<a name="index-combined_002dmethod"></a>
<a name="combined_002dmethod"></a><p>The way the methods of the components are combined is the heart of the
flavor system.  When a flavor is defined, a single function, called a
<em>combined method</em>, is constructed for each operation supported by the
flavor.  This function is constructed out of all the methods for that
operation from all the components of the flavor.  There are many different
ways that methods can be combined; these can be selected by the user
when a flavor is defined.  The user can also create new forms of
combination.
</p>
<p>There are several kinds of methods, but
so far, the only kinds of methods we have seen are <em>primary</em> methods.
The default way primary methods are combined is that all but the
earliest one provided are ignored.  In other words, the combined method
is simply the primary method of the first flavor to provide a primary
method.  What this means is that if you are starting with a flavor
<code>foo</code> and building a flavor <code>bar</code> on top of it, then you can
override <code>foo</code>&rsquo;s method for an operation by providing your own method.
Your method will be called, and <code>foo</code>&rsquo;s will never be called.
</p>
<p>Simple overriding is often useful; if you want to make a new flavor
<code>bar</code> that is just like <code>foo</code> except that it reacts completely
differently to a few operations, then this will work.  However, often you
don&rsquo;t want to completely override the base flavor&rsquo;s (<code>foo</code>&rsquo;s) method;
sometimes you want to add some extra things to be done.  This is where
combination of methods is used.
</p>
<p>The usual way methods are combined is that one flavor provides a primary
method, and other flavors provide <em>daemon methods</em>.  The idea
is that the primary method is &quot;in charge&quot; of the main business of
handling the operation, but other flavors just want to keep informed
that the message was sent, or just want to do the part of the operation
associated with their own area of responsibility.
</p>
<p>When methods are combined, a single primary method is found; it comes
from the first component flavor that has one.  Any primary methods
belonging to later component flavors are ignored.  This is just
what we saw above; <code>bar</code> could override <code>foo</code>&rsquo;s primary method
by providing its own primary method.
</p>
<a name="index-daemon-methods"></a>

<p>However, you can define other kinds of methods; in particular,
<em>daemon</em> methods.  They come in two kinds, <em>before</em> and <em>after</em>.  There is
a special syntax in <code>defmethod</code> for defining such methods.  Here is an example
of the syntax.  To give the <code>ship</code> flavor an after-daemon method for the
<code>:speed</code> operation, the following syntax would be used:
</p><div class="lisp">
<pre class="lisp">(defmethod (ship :after :speed) ()
   <em>body</em>)
</pre></div>

<p>Now, when a message is sent, it is handled by a new function called the
<em>combined</em> method.  The combined method first calls all of the before daemons,
then the primary method, then all the after daemons.  Each method is passed the
same arguments that the combined method was given.  The returned values from the
combined method are the values returned by the primary method; any values
returned from the daemons are ignored.  Before-daemons are called in the order
that flavors are combined, while after-daemons are called in the reverse order.
In other words, if you build <code>bar</code> on top of <code>foo</code>, then <code>bar</code>&rsquo;s
before-daemons will run before any of those in <code>foo</code>, and <code>bar</code>&rsquo;s
after-daemons will run after any of those in <code>foo</code>.
</p>
<p>The reason for this order is to keep the modularity order correct.  If
we create <code>flavor-1</code> built on <code>flavor-2</code>; then it should not matter
what <code>flavor-2</code> is built out of.  Our new before-daemons go before all
methods of <code>flavor-2</code>, and our new after-daemons go after all methods of
<code>flavor-2</code>.  Note that if you have no daemons, this reduces to the
form of combination described above.  The most recently added component
flavor is the highest level of abstraction; you build a higher-level
object on top of a lower-level object by adding new components to the
front.  The syntax for defining daemon methods can be found in the
description of <code>defmethod</code> below.
</p>
<p>To make this a bit more clear, let&rsquo;s consider a simple example that is
easy to play with: the <code>:print-self</code> method.  The Lisp printer
(i.e the <code>print</code> function; see <a href="#printer">printer</a>) prints instances of flavors by sending
them <code>:print-self</code> messages.  The first argument to the
<code>:print-self</code> operation is a stream (we can ignore the others for now),
and the receiver of the message is supposed to print its printed
representation on the stream.  In the <code>ship</code> example above, the reason
that instances of the <code>ship</code> flavor printed the way they did is
because the <code>ship</code> flavor was actually built on top of a very basic
flavor called <code>vanilla-flavor</code>; this component is provided
automatically by <code>defflavor</code>.  It was <code>vanilla-flavor</code>&rsquo;s
<code>:print-self</code> method that was doing the printing.  Now, if we give
<code>ship</code> its own primary method for the <code>:print-self</code> operation, then
that method will take over the job of printing completely;
<code>vanilla-flavor</code>&rsquo;s method will not be called at all.  However, if we
give <code>ship</code> a before-daemon method for the <code>:print-self</code> operation,
then it will get invoked before the <code>vanilla-flavor</code> method, and so
whatever it prints will appear before what <code>vanilla-flavor</code> prints.
So we can use before-daemons to add prefixes to a printed
representation; similarly, after-daemons can add suffixes.
</p>
<p>There are other ways to combine methods besides daemons, but this way is the
most common.  The more advanced ways of combining methods are explained
in a later section; see <a href="#method_002dcombination">method-combination</a>.  The <code>vanilla-flavor</code> and what it does for
you are also explained later; see <a href="#vanilla_002dflavor">vanilla-flavor</a>.
</p>
<a name="Flavor-Functions"></a>
<h3 class="section">20.7 Flavor Functions</h3>

<a name="defflavor_002dfun"></a><dl>
<dt><a name="index-defflavor"></a>Macro: <strong>defflavor</strong></dt>
<dd><p>A flavor is defined by a form
</p><div class="lisp">
<pre class="lisp">(defflavor <em>flavor-name</em> (<em>var1</em> <em>var2</em>...) (<em>flav1</em> <em>flav2</em>...)
	<em>opt1</em> <em>opt2</em>...)
</pre></div>
<p><em>flavor-name</em> is a symbol which serves to name this flavor.  It will get an <code>si:flavor</code>
property of the internal data-structure containing the details of the flavor.
</p>
<p><code>(typep <em>obj</em>)</code>, where <em>obj</em> is an instance of the flavor named
<em>flavor-name</em>, will return the symbol <em>flavor-name</em>.
<code>(typep <em>obj</em> <em>flavor-name</em>)</code> is <code>t</code> if <em>obj</em> is an instance of a
flavor, one of whose components (possibly itself) is <em>flavor-name</em>.
</p>
<p><em>var1</em>, <em>var2</em>, etc. are the names of the instance-variables
containing the local state for this flavor.  A list of the name of an
instance-variable and a default initialization form is also acceptable;
the initialization form will be evaluated when an instance of
the flavor is created if no other initial value for
the variable is obtained.  If no initialization is specified, the variable
will remain unbound.
</p>
<p><em>flav1</em>, <em>flav2</em>, etc. are the names of the component flavors out of
which this flavor is built.  The features of those flavors are inherited
as described previously.
</p>
<p><em>opt1</em>, <em>opt2</em>, etc. are options; each option may be either a
keyword symbol or a list of a keyword symbol and arguments.  The options
to <code>defflavor</code> are described in <a href="#defflavor_002doptions">defflavor-options</a>.
</p></dd></dl>

<a name="g_t_002aall_002dflavor_002dnames_002a_002dvar"></a><dl>
<dt><a name="index-_002aall_002dflavor_002dnames_002a"></a>Variable: <strong>*all-flavor-names*</strong></dt>
<dd><p>This is a list of the names of all the flavors that have ever been <code>defflavor</code>&rsquo;ed.
</p></dd></dl>

<a name="defmethod_002dfun"></a><dl>
<dt><a name="index-defmethod"></a>Macro: <strong>defmethod</strong></dt>
<dd><p>A method, that is, a function to handle a particular operation for instances
of a particular flavor, is defined by a form such as
</p><div class="lisp">
<pre class="lisp">(defmethod (<em>flavor-name</em> <em>method-type</em> <em>operation</em>) <em>lambda-list</em>
  <em>form1</em> <em>form2</em>...)
</pre></div>
<p><em>flavor-name</em> is a symbol which is the name of the flavor which is to
receive the method.
<em>operation</em> is a keyword symbol which names the operation
to be handled.  <em>method-type</em> is a keyword symbol for the type of method;
it is omitted when you are defining a primary method.  For some method-types,
additional information is expected.  It comes after <em>operation</em>.
</p>
<p>The meaning of the <em>method-type</em> depends on what kind of
method-combination is declared for this operation.  For instance, for
daemons <code>:before</code> and <code>:after</code> are allowed.  See
<a href="#method_002dcombination">method-combination</a> for a complete description of method types and
the way methods are combined.
</p>
<p><em>lambda-list</em> describes the arguments and <code>&amp;aux</code> variables of the
function; the first argument to the method, which is the operation
name itself, is automatically handled and so is not included in the
lambda-list.  Note that methods may not have <code>&amp;quote</code> arguments;
that is they must be functions, not special forms.  <em>form1</em>,
<em>form2</em>, etc. are the function body; the value of the last form
is returned.
</p>
<p>The variant form
</p><div class="lisp">
<pre class="lisp">(defmethod (<em>flavor-name</em> <em>operation</em>) <em>function</em>)
</pre></div>
<p>where <em>function</em> is a symbol, says that <em>flavor-name</em>&rsquo;s method for
<em>operation</em> is <em>function</em>, a symbol which names a function.  That
function must take appropriate arguments; the first argument is the
operation.
</p>
<p>If you redefine a method that is already defined, the old definition is
replaced by the new one.  Given a flavor, an operation name, and a
method type, there can only be one function (with the exception of
<code>:case</code> methods), so if you define a <code>:before</code> daemon method for the
<code>foo</code> flavor to handle the <code>:bar</code> operation, then you replace the
previous before-daemon; however, you do not affect the primary method or
methods of any other type, operation or flavor.
</p>
<p>The function spec for a method (see <a href="#method_002dfunction_002dspec">method-function-spec</a>) looks like:
</p><div class="lisp">
<pre class="lisp">(:method <em>flavor-name</em> <em>operation</em>)  <span class="roman">or</span>
(:method <em>flavor-name</em> <em>method-type</em> <em>operation</em>)
(:method <em>flavor-name</em> <em>method-type</em> <em>operation</em> <em>suboperation</em>)
</pre></div>
<p>This is useful to know if you want to trace (<a href="#trace_002dfun">trace-fun</a>), breakon
(<a href="#breakon_002dfun">breakon-fun</a>) or advise (<a href="#advise_002dfun">advise-fun</a>) a method, or if you want to
poke around at the method function itself, e.g  disassemble it
(see <a href="#disassemble_002dfun">disassemble-fun</a>).
</p></dd></dl>

<a name="make_002dinstance_002dfun"></a><dl>
<dt><a name="index-make_002dinstance"></a>Function: <strong>make-instance</strong> <em>flavor-name init-option1 value1 init-option2 value2... </em></dt>
<dd><p>Creates and returns an instance of the specified flavor.  Arguments
after the first are alternating init-option keywords and arguments to
those keywords.  These options are used to initialize instance variables
and to select arbitrary options, as described above.  An <code>:init</code>
message is sent to the newly-created object with one argument, the
init-plist.  This is a disembodied property-list containing the
init-options specified and those defaulted from the flavor&rsquo;s
<code>:default-init-plist</code> (however, init keywords that simply initialize instance
variables, and the corresponding values, may be absent when the
<code>:init</code> methods are called).  <code>make-instance</code> is an easy-to-call
interface to <code>instantiate-flavor</code>; for full details refer to that
function.
</p></dd></dl>

<a name="instantiate_002dflavor_002dfun"></a><dl>
<dt><a name="index-instantiate_002dflavor"></a>Function: <strong>instantiate-flavor</strong> <em>flavor-name init-plist &amp;optional send-init-message-p return-unhandled-keywords area</em></dt>
<dd><p>This is an extended version of <code>make-instance</code>, giving you more features.
Note that it takes the init-plist as an argument, rather than taking a <code>&amp;rest</code>
argument of init-options and values.
</p>
<p>The <em>init-plist</em> argument must be a disembodied property list;
<code>locf</code> of a <code>&amp;rest</code> argument will do.  Beware!  This property list
can be modified; the properties from the default-init-plist are
<code>putprop</code>&rsquo;ed on if not already present, and some <code>:init</code> methods
do explicit <code>putprop</code>s onto the init-plist.
</p>
<p>Do not use <code>nil</code> as the <em>init-plist</em> argument.  This would mean
to use the properties of the symbol <code>nil</code> as the init options.
If your goal is to have no init options, you must provide a property list
containing no properties, such as a cons whose cdr is <code>nil</code>.
</p>
<p>The <code>:init</code> methods should not look on the <em>init-plist</em> for keywords
that simply initialize instance variables (that is, keywords defined
with <code>:inittable-instance-variables</code> rather than <code>:init-keywords</code>).
The corresponding instance variables will already be set up when the
<code>:init</code> methods are called, and sometimes the keywords and their
values may actually be missing from the <em>init-plist</em> if it is more
efficient not to put them on.  To avoid problems, always refer to the
instance variables themselves rather than looking for the init keywords
that initialize them.
</p>
<p>In the event that <code>:init</code> methods <code>remprop</code> properties already on
the init-plist (as opposed to simply doing <code>get</code> and <code>putprop</code>),
then the init-plist will get <code>rplacd</code>&rsquo;ed.  This means that the actual
list of options will be modified.  It also means that <code>locf</code> of a
<code>&amp;rest</code> argument will not work; the caller of <code>instantiate-flavor</code>
must copy its rest argument (e.g with <code>copylist</code>); this is because
<code>rplacd</code> is not allowed on <code>&amp;rest</code> arguments.
</p>
<p>First, if the flavor&rsquo;s method hash-table and other internal information have
not been computed or are not up to date, they are computed.  This may
take a substantial amount of time and invoke the compiler, but will
only happen once for a particular flavor no matter how many instances
you make, unless you redefine the flavor.
</p>
<p>Next, the instance variables are initialized.  There are
several ways this initialization can happen.
If an instance variable is declared inittable, and a keyword with
the same spelling as its name appears in <em>init-plist</em>, it is set
to the value specified after that keyword.  If an instance variable
does not get initialized this way, and an initialization form was
specified for it in a <code>defflavor</code>, that form is evaluated and the
variable is set to the result.  The initialization form may not refer to
any instance variables or to <code>self</code>; it will not be evaluated in the &quot;inside&quot;
environment in which methods are called.
If an instance variable does not get initialized either of these ways
it will be left unbound; an <code>:init</code> method may initialize it
(see below).  Note that a simple empty disembodied property list is
<code>(nil)</code>, which is what you should give if you want an empty init-plist.
If you use <code>nil</code>, the property list of <code>nil</code> will be used, which
is probably not what you want.
</p>
<p>If any keyword appears in the <em>init-plist</em> but is not used to
initialize an instance variable and is not declared in an
<code>:init-keywords</code> option (see <a href="#init_002dkeywords_002doption">init-keywords-option</a>) it is presumed
to be a misspelling.  So any keywords that you handle in an <code>:init</code>
handler should also be mentioned in the <code>:init-keywords</code> option
of the definition of the flavor.
</p>
<p>If the <em>return-unhandled-keywords</em> argument is
not supplied, such keywords are complained about by signalling an error.
But if <em>return-unhandled-keywords</em> is supplied non-<code>nil</code>, a list of
such keywords is returned as the second value of <code>instantiate-flavor</code>.
</p>
<p>Note that default values in the <em>init-plist</em> can come from
the <code>:default-init-plist</code> option to <code>defflavor</code>.  See
<a href="#default_002dinit_002dplist_002doption">default-init-plist-option</a>.
</p>
<p>If the <em>send-init-message-p</em> argument is supplied and non-<code>nil</code>, an
<code>:init</code> message is sent to the newly-created instance, with one
argument, the <em>init-plist</em>.  <code>get</code> can be used to extract options
from this property-list.  Each flavor that needs initialization can
contribute an <code>:init</code> method by defining a daemon.
</p>
<p>If the <em>area</em> argument is specified, it is the number of an area in which
to cons the instance; otherwise it is consed in the default area.
</p></dd></dl>

<dl>
<dt><a name="index-flavor-on-_0022all"></a>Meta Method on &quot;all: <strong>flavor</strong> <em>instances&quot; :init init-plist</em></dt>
<dd><p>This operation is implemented on all flavor instances.  Its purpose is to
examine the init keywords and perform whatever initializations are
appropriate.  <em>init-plist</em> is the argument that was given to
<code>instantiate-flavor</code>, and may be passed directly to <code>get</code>
to examine the value of any particular init option.
</p>
<p>The default definition of this operation does nothing.  However,
many flavors add <code>:before</code> and <code>:after</code> daemons to it.
</p></dd></dl>

<a name="defwrapper_002dfun"></a><dl>
<dt><a name="index-defwrapper"></a>Macro: <strong>defwrapper</strong></dt>
<dd><p>This is hairy and if you don&rsquo;t understand it you should skip it.
</p>
<p>Sometimes the way the flavor system combines the methods of different
flavors (the daemon system) is not powerful enough.  In that case <code>defwrapper</code>
can be used to define a macro that expands into code that is wrapped around
the invocation of the methods.  This is best explained by an example;
suppose you needed a lock locked during the processing of the
<code>:foo</code> operation on flavor <code>bar</code>, which takes two arguments,
and you have a <code>lock-frobboz</code> special-form that knows how to lock the lock
(presumably it generates an <code>unwind-protect</code>).  <code>lock-frobboz</code> needs to see
the first argument to the operation; perhaps that tells it what sort of operation
is going to be performed (read or write).
</p><div class="lisp">
<pre class="lisp">(defwrapper (bar :foo) ((arg1 arg2) . body)
  `(lock-frobboz (self arg1)
     . ,body))
</pre></div>
<p>The use of the <code>body</code> macro-argument prevents the <code>defwrapper</code>&rsquo;ed
macro from knowing the exact implementation and allows several <code>defwrapper</code>s
from different flavors to be combined properly.
</p>
<p>Note well that the argument variables, <code>arg1</code> and <code>arg2</code>, are not referenced
with commas before them.  These may look like <code>defmacro</code> &quot;argument&quot; variables,
but they are not.  Those variables are not bound at the time the <code>defwrapper</code>-defined
macro is expanded and the back-quoting is done; rather the result of that
macro-expansion and back-quoting is code which, when a message is sent, will
bind those variables to the arguments in the message as local variables of
the combined method.
</p>
<p>Consider another example.  Suppose you thought you wanted a <code>:before</code> daemon,
but found that if the argument was <code>nil</code> you needed to return from processing
the message immediately, without executing the primary method.  You could write
a wrapper such as
</p><div class="lisp">
<pre class="lisp">(defwrapper (bar :foo) ((arg1) . body)
  `(cond ((null arg1))		;Do nothing if arg1 is nil
	 (t <em>before-code</em>
	    . ,body)))
</pre></div>

<p>Suppose you need a variable for communication among the daemons for a particular
operation; perhaps the <code>:after</code> daemons need to know what the primary method did,
and it is something that cannot be easily deduced from just the arguments.  You
might use an instance variable for this, or you might create a special variable
which is bound during the processing of the operation and used free by the methods.
</p><div class="lisp">
<pre class="lisp">(defvar *communication*)
(defwrapper (bar :foo) (ignore . body)
  `(let ((*communication* nil))
     . ,body))
</pre></div>

<p>Similarly you might want a wrapper that puts a <code>*catch</code> around the processing
of an operation so that any one of the methods could throw out in the event of
an unexpected condition.
</p>
<p>Like daemon methods, wrappers work in outside-in order; when you add a
<code>defwrapper</code> to a flavor built on other flavors, the new wrapper
is placed outside any wrappers of the component flavors.  However,
<em>all</em> wrappers happen before <em>any</em> daemons happen.  When the combined
method is built, the calls to the before-daemon methods, primary methods,
and after-daemon methods are all placed together, and then the wrappers
are wrapped around them.  Thus, if a component flavor defines a wrapper,
methods added by new flavors will execute within that wrapper&rsquo;s context.
</p>
<p><code>:around</code> methods can do some of the same things that wrappers can.  See
<a href="#around_002dmethod_002dtype">around-method-type</a>.  If one flavor defines both a wrapper and an
<code>:around</code> method for the same operation, the <code>:around</code> method is
executed inside the wrapper.
</p>
<p>By careful about inserting the body into an internal lambda-expression within
the wrapper&rsquo;s code.  This interacts with internals details of the way
combined methods are implemented.  It can be done if it is done
carefully.  But it is much simpler to use an <code>:around</code> method instead.
</p></dd></dl>

<a name="undefmethod_002dfun"></a><dl>
<dt><a name="index-undefmethod"></a>Macro: <strong>undefmethod</strong> <em>(flavor [type] operation [suboperation])</em></dt>
<dd><div class="lisp">
<pre class="lisp">(undefmethod (flavor :before :operation))
<span class="roman">removes the method created by</span>
(defmethod (flavor :before :operation) (<em>args</em>) ...)
</pre></div>

<p>To remove a wrapper, use <code>undefmethod</code> with <code>:wrapper</code> as the method type.
</p>
<p><code>undefmethod</code> is simply an interface to <code>fundefine</code>
(see <a href="#fundefine_002dfun">fundefine-fun</a>) that accepts the same syntax as
<code>defmethod</code>.
</p>
<p>If a file that used to contain a method definition is reloaded
and if that method no longer seems to have a definition in the file,
the user is asked whether to <code>undefmethod</code> that method.  This may be
important to enable the modified program to inherit the methods it is
supposed to inherit.  If the method in question has been redefined by some
other file, this is not done, the assumption being that the definition was
merely moved.
</p></dd></dl>

<a name="self_002dvar"></a><dl>
<dt><a name="index-self"></a>Variable: <strong>self</strong></dt>
<dd><p>When a message is sent to an object, the variable <code>self</code> is automatically
bound to that object, for the benefit of methods which want to manipulate
the object itself (as opposed to its instance variables).
</p></dd></dl>

<a name="funcall_002dself_002dfun"></a><dl>
<dt><a name="index-funcall_002dself"></a>Function: <strong>funcall-self</strong> <em>operation arguments...</em></dt>
<dd><p>When <code>self</code> is an instance or an entity, <code>(funcall-self
<em>args</em>...)</code> has the same effect as <code>(funcall self <em>args</em>...)</code>
except that it is a little faster.  If <code>self</code> is not an instance (or
an entity, see <a href="#entity">entity</a>), <code>funcall-self</code> and <code>funcall self</code> do the
same thing.
</p>
<p>When <code>self</code> is an instance, <code>funcall-self</code> will only work correctly
if it is used in a method or a subroutine of a method.  Just binding
<code>self</code> by hand and using this will not work.
</p></dd></dl>

<a name="lexpr_002dfuncall_002dself_002dfun"></a><dl>
<dt><a name="index-lexpr_002dfuncall_002dself"></a>Function: <strong>lexpr-funcall-self</strong> <em>operation arguments... list-of-arguments</em></dt>
<dd><p>This function is a cross between <code>lexpr-funcall</code> and <code>funcall-self</code>.
When <code>self</code> is an instance or an entity, <code>(lexpr-funcall-self
<em>args</em>...)</code> has the same effect as <code>(lexpr-funcall self
<em>args</em>...)</code> except that it is a little faster.  If <code>self</code> is not an
instance (or an entity, see <a href="#entity">entity</a>), <code>lexpr-funcall-self</code> and
<code>lexpr-funcall</code> do the same thing. 
</p></dd></dl>

<a name="funcall_002dwith_002dmapping_002dtable_002dfun"></a><dl>
<dt><a name="index-funcall_002dwith_002dmapping_002dtable"></a>Function: <strong>funcall-with-mapping-table</strong> <em>function mapping-table &amp;rest arguments</em></dt>
<dd><p><em>function</em> is applied to <em>arguments</em> with <code>sys:self-mapping-table</code>
bound to <em>mapping-table</em>.  This is faster than binding the variable
yourself and doing an ordinary <code>funcall</code>, because the system assumes
that the mapping table you specify is the correct one for <em>function</em>
to be run with.  However, if you pass the wrong mapping table, incorrect
execution will take place.
</p>
<p>This function is used in the code for combined methods and is also useful
for the user in <code>:around</code> methods (see <a href="#around_002dmethod_002dtype">around-method-type</a>).
</p></dd></dl>

<a name="lexpr_002dfuncall_002dwith_002dmapping_002dtable_002dfun"></a><dl>
<dt><a name="index-lexpr_002dfuncall_002dwith_002dmapping_002dtable"></a>Function: <strong>lexpr-funcall-with-mapping-table</strong> <em>function mapping-table &amp;rest arguments</em></dt>
<dd><p><em>function</em> is applied to <em>arguments</em> using <code>lexpr-funcall</code>, with
<code>sys:self-mapping-table</code> bound to <em>mapping-table</em>.
</p></dd></dl>

<a name="declare_002dflavor_002dinstance_002dvariables_002dfun"></a><dl>
<dt><a name="index-declare_002dflavor_002dinstance_002dvariables"></a>Macro: <strong>declare-flavor-instance-variables</strong> <em>(flavor) body...</em></dt>
<dd><p>Sometimes you will write a function which is not itself a method, but
which is to be called by methods and wants to be able to access the
instance variables of the object <code>self</code>.  The form
</p><div class="lisp">
<pre class="lisp">(declare-flavor-instance-variables (<em>flavor-name</em>)
  (defun <em>function</em> <em>args</em> <em>body</em>...))
</pre></div>
<p>surrounds the function definition with a declaration of
the instance variables for the specified flavor, which will make them
accessible by name.  Any kind of function definition is allowed;
it does not have to use <code>defun</code> per se.
</p>
<p>If you call such a function when <code>self</code>&rsquo;s value is an instance whose
flavor does not include <em>flavor-name</em> as a component, it is an error.
</p>
<p>Cleaner than using <code>declare-flavor-instance-variables</code>, because it
does not involve putting anything around the function definition, is using
a local declaration.  Put <code>(declare (:self-flavor <em>flavorname</em>))</code> as
the first expression in the body of the function.  For example:
</p><div class="lisp">
<pre class="lisp">(defun foo (a b)
  (declare (:self-flavor myobject))
  (+ a (* b speed)))
</pre></div>
<p>(where <code>speed</code> is an instance variable of the flavor <code>myobject</code>)
is equivalent to
</p><div class="lisp">
<pre class="lisp">(declare-flavor-instance-variables (myobject)
(defun foo (a b)
  (+ a (* b speed))))
</pre></div>
</dd></dl>

<a name="with_002dself_002dvariables_002dbound_002dfun"></a><dl>
<dt><a name="index-with_002dself_002dvariables_002dbound"></a>Special Form: <strong>with-self-variables-bound</strong> <em>body...</em></dt>
<dd><p>Within the body of this special form, all of <code>self</code>&rsquo;s instance
variables are bound as specials to the values inside <code>self</code>.
(Normally this is true only of those instance variables that are
specified in <code>:special-instance-variables</code> when <code>self</code>&rsquo;s flavor was
defined.)
</p>
<p>As a result, inside the body you can use <code>set</code>, <code>boundp</code> and
<code>symeval</code> freely on the instance variables of <code>self</code>.
</p>
<p>This special form is used by the interpreter when a method that is not
compiled is executed, so that the interpreted references to instance
variables will work properly.
</p></dd></dl>

<a name="recompile_002dflavor_002dfun"></a><dl>
<dt><a name="index-recompile_002dflavor"></a>Function: <strong>recompile-flavor</strong> <em>flavor-name &amp;optional single-operation (use-old-combined-methods <code>t</code>) (do-dependents <code>t</code>)</em></dt>
<dd><p>Updates the internal data of the flavor and any flavors that depend on it.
If <em>single-operation</em> is supplied non-<code>nil</code>, only the methods for that
operation are changed.  The system does this when you define a new method that
did not previously exist.
If <em>use-old-combined-methods</em> is <code>t</code>, then the existing combined
method functions will be used if possible.  New ones will only be generated
if the set of methods to be called has changed.  This
is the default.
If <em>use-old-combined-methods</em> is <code>nil</code>, automatically-generated functions
to call multiple methods or to contain code generated by wrappers will be regenerated
unconditionally.
If <em>do-dependents</em> is <code>nil</code>, only the specific flavor you specified
will be recompiled.  Normally it and all flavors that depend on it will be recompiled.
</p>
<p><code>recompile-flavor</code> affects only flavors that have already been compiled.
Typically this means it affects flavors that have been instantiated,
but does not bother with mixins (see <a href="#mixin_002dflavor">mixin-flavor</a>).
</p></dd></dl>

<a name="compile_002dflavor_002dmethods_002dfun"></a><dl>
<dt><a name="index-compile_002dflavor_002dmethods"></a>Macro: <strong>compile-flavor-methods</strong> <em>flavor...</em></dt>
<dd><p>The form <code>(compile-flavor-methods <em>flavor-name-1</em>
<em>flavor-name-2</em>...)</code>, placed in a file to be compiled, will cause the
compiler to include the automatically-generated combined methods for the
named flavors in the resulting QFASL file, provided all of the
necessary flavor definitions have been made.  Furthermore, when the QFASL file is
loaded, internal data structures (such as the list of all methods of a
flavor) will be generated.
</p>
<p>This means that the combined methods get compiled at compile time and
the data structures get generated at load time, rather than both things
happening at run time.  This is a very good thing, since if the
the compiler must be invoked at run time, the program will be
slow the first time it are run.  (The compiler will still be called if
incompatible changes have been made, such as addition or deletion of
methods that must be called by a combined method.)
</p>
<p>You should only use <code>compile-flavor-methods</code> for flavors that are
going to be instantiated.  For a flavor that will never be instantiated
(that is, a flavor that only serves to be a component of other flavors
that actually do get instantiated), it is a complete waste of time,
except in the unusual case where those other flavors can all inherit
the combined methods of this flavor instead of each one having its
own copy of a combined method which happens to be identical to the
others.  In this unusual case, you should use the <code>:abstract-flavor</code>
option in <code>defflavor</code>.
</p>
<p>The <code>compile-flavor-methods</code> forms should be compiled after all of
the information needed to create the combined methods is available.  You
should put these forms after all of the definitions of all relevant
flavors, wrappers, and methods of all components of the flavors mentioned.
</p>
<p>The methods used by <code>compile-flavor-methods</code> to form the combined
methods that go in the QFASL file are all those present in the file
being compiled and all those defined in the Lisp world.
</p>
<p>When a <code>compile-flavor-methods</code> form is seen by the interpreter,
the combined methods are compiled and the internal data structures
are generated.
</p></dd></dl>

<a name="get_002dhandler_002dfor_002dfun"></a><dl>
<dt><a name="index-get_002dhandler_002dfor"></a>Function: <strong>get-handler-for</strong> <em>object operation</em></dt>
<dd><p>Given an object and an operation, will return that object&rsquo;s method for that
operation, or <code>nil</code> if it has none.  When <em>object</em> is an instance of
a flavor, this function can be useful to find which of that flavor&rsquo;s
components supplies the method.  If you get back a combined method,
you can use the <code>Meta-X List Combined Methods</code> editor command (<a href="#list_002dcombined_002dmethods">list-combined-methods</a>)
to find out what it does.
</p>
<p>This is related to the <code>:handler</code> function spec
(see <a href="#function_002dspec">function-spec</a>).
</p>
<p>This function can be used with other
things than flavors and has an optional argument which is not relevant here
and not documented.
</p></dd></dl>

<a name="flavor_002dallows_002dinit_002dkeyword_002dp_002dfun"></a><dl>
<dt><a name="index-flavor_002dallows_002dinit_002dkeyword_002dp"></a>Function: <strong>flavor-allows-init-keyword-p</strong> <em>flavor-name keyword</em></dt>
<dd><p>Returns non-<code>nil</code> if the flavor named <em>flavor-name</em> allows <em>keyword</em>
in the init options when it is instantiated, or <code>nil</code> if it does not.
The non-<code>nil</code> value is the name of the component flavor that contributes
the support of that keyword.
</p></dd></dl>

<a name="si_003aflavor_002dall_002dallowed_002dinit_002dkeywords_002dfun"></a><dl>
<dt><a name="index-si_003aflavor_002dall_002dallowed_002dinit_002dkeywords"></a>Function: <strong>si:flavor-all-allowed-init-keywords</strong> <em>flavor-name</em></dt>
<dd><p>Returns a list of all the init keywords that may be used
in instantiating <em>flavor-name</em>.
</p></dd></dl>

<a name="symeval_002din_002dinstance_002dfun"></a><dl>
<dt><a name="index-symeval_002din_002dinstance"></a>Function: <strong>symeval-in-instance</strong> <em>instance symbol &amp;optional no-error-p</em></dt>
<dd><p>This function is used to find the value of an instance variable
inside a particular instance.  <em>Instance</em> is the instance to
be examined, and <em>symbol</em> is the instance variable whose value
should be returned.  If there is no such instance variable, an
error is signalled, unless <em>no-error-p</em> is non-<code>nil</code> in which
case <code>nil</code> is returned.
</p></dd></dl>

<a name="set_002din_002dinstance_002dfun"></a><dl>
<dt><a name="index-set_002din_002dinstance"></a>Function: <strong>set-in-instance</strong> <em>instance symbol value</em></dt>
<dd><p>This function is used to alter the value of an instance variable inside
a particular instance. <em>Instance</em> is the instance to be altered,
<em>symbol</em> is the instance variable whose value should be set, and
<em>value</em> is the new value.  If there is no such instance variable, an
error is signalled.
</p></dd></dl>

<a name="locate_002din_002dinstance_002dfun"></a><dl>
<dt><a name="index-locate_002din_002dinstance"></a>Function: <strong>locate-in-instance</strong> <em>instance symbol</em></dt>
<dd><p>Returns a locative pointer to the cell inside <em>instance</em> which holds the
value of the instance variable named <em>symbol</em>.
</p></dd></dl>

<a name="describe_002dflavor_002dfun"></a><dl>
<dt><a name="index-describe_002dflavor"></a>Function: <strong>describe-flavor</strong> <em>flavor-name</em></dt>
<dd><p>This function prints out descriptive information about a flavor; it is
self-explanatory.  An important thing it tells you that can be hard to
figure out yourself is the combined list of component flavors; this list
is what is printed after the phrase &quot;and directly or indirectly depends
on&quot;.
</p></dd></dl>

<a name="si_003a_002aflavor_002dcompilations_002a_002dvar"></a><dl>
<dt><a name="index-si_003a_002aflavor_002dcompilations_002a"></a>Variable: <strong>si:*flavor-compilations*</strong></dt>
<dd><p>This variable contains a history of when the flavor mechanism invoked
the compiler.  It is a list; elements toward the front of the list
represent more recent compilations.  Elements are typically of the
form
</p><div class="lisp">
<pre class="lisp">(<em>function-spec</em> <em>pathname</em>)
</pre></div>
<p>where the function spec starts with <code>:method</code> and has a method type of
<code>:combined</code>.
</p>
<p>You may <code>setq</code> this variable to <code>nil</code> at any time; for instance before
loading some files that you suspect may have missing or obsolete
<code>compile-flavor-methods</code> in them.
</p></dd></dl>

<a name="sys_003aunclaimed_002dmessage_002dcondition"></a><dl>
<dt><a name="index-_0028error_0029-on-sys_003aunclaimed_002dmessage"></a>Condition on sys:unclaimed-message: <strong>(<code>error</code>)</strong></dt>
<dd><p>This condition is signaled whenever a flavor instance is sent a message whose
operation it does not handle.  The condition instance supports these operations:
</p><dl compact="compact">
<dt><code>:object</code></dt>
<dd><p>The flavor instance that received the message.
</p></dd>
<dt><code>:operation</code></dt>
<dd><p>The operation that was not handled.
</p></dd>
<dt><code>:arguments</code></dt>
<dd><p>The list of arguments to that operation
</p></dd>
</dl>
</dd></dl>

<a name="Defflavor-Options"></a>
<h3 class="section">20.8 Defflavor Options</h3>

<a name="defflavor_002doptions"></a>
<p>There are quite a few options to <code>defflavor</code>.  They are all described here,
although some are for very specialized purposes and not of interest to most users.
Each option can be written in two forms; either the keyword by itself, or a list
of the keyword and &quot;arguments&quot; to that keyword.
</p>
<p>Several of these options declare things about instance variables.
These options can be given with arguments which are instance variables,
or without any arguments in which case they refer to all of the
instance variables listed at the top of the <code>defflavor</code>.  This is
<em>not</em> necessarily all the instance variables of the component
flavors, just the ones mentioned in this flavor&rsquo;s <code>defflavor</code>.  When
arguments are given, they must be instance variables that were listed
at the top of the <code>defflavor</code>; otherwise they are assumed to be
misspelled and an error is signalled.  It is legal to declare things
about instance variables inherited from a component flavor, but to do
so you must list these instance variables explicitly in the instance
variable list at the top of the <code>defflavor</code>.
</p>
<dl compact="compact">
<dt><code>:gettable-instance-variables</code></dt>
<dd><a name="index-_003agettable_002dinstance_002dvariables-defflavor"></a>
<a name="gettable_002dinstance_002dvariables_002doption"></a><p>Enables automatic generation of methods for getting the values of
instance variables.  The operation name is the name of the variable, in
the keyword package (i.e put a colon in front of it).
</p>
<p>Note that there is nothing special about these methods; you could easily
define them yourself.  This option generates them automatically to save
you the trouble of writing out a lot of very simple method definitions.
(The same is true of methods defined by the
<code>:settable-instance-variables</code> option.)  If you define a method for the
same operation name as one of the automatically generated methods, the new
definition will override the old one, just as if you had manually
defined two methods for the same operation name.
</p>
</dd>
<dt><code>:settable-instance-variables</code></dt>
<dd><a name="index-_003asettable_002dinstance_002dvariables-defflavor"></a>
<p>Enables automatic generation of methods for setting the values of
instance variables.  The operation name is &quot;<code>:set-</code>&quot; followed by the
name of the variable.  All settable instance
variables are also automatically made gettable and inittable.
(See the note in the description of the <code>:gettable-instance-variables</code>
option, above.)
</p>
</dd>
<dt><code>:inittable-instance-variables</code></dt>
<dd><a name="index-_003ainittable_002dinstance_002dvariables-defflavor"></a>
<p>The instance variables listed as arguments, or all instance variables
listed in this <code>defflavor</code> if the keyword is given alone, are made
<em>inittable</em>.  This means that they can be initialized through use of a
keyword (a colon followed by the name of the variable) as an init-option
argument to <code>make-instance</code>.
</p>
</dd>
<dt><code>:special-instance-variables</code></dt>
<dd><a name="index-_003aspecial_002dinstance_002dvariables-defflavor"></a>
<p>The instance variables listed as arguments, or all instance variables
listed in this <code>defflavor</code> if the keyword is given alone, are made
special.  Whenever a message is sent to an instance of this flavor (or
any containing flavor), these instance variables will actually be bound
as specials: they will be bound through the execution of all the methods.
</p>
<p>You must do this to any instance variables that you wish to be accessible
through <code>symeval</code>, <code>set</code>, <code>boundp</code> and <code>makunbound</code>.  Since
those functions refer only to the special value cell of a symbol, values
of instance variables not made special will not be visible to them.
</p>
<p>This should also be done for any instance variables that are declared
globally special.  If you omit this, the flavor system will do it for
you automatically when you instantiate the flavor, and give you a
warning to remind you to fix the <code>defflavor</code>.
</p>
</dd>
<dt><code>:init-keywords</code></dt>
<dd><a name="index-_003ainit_002dkeywords-defflavor"></a>
<a name="init_002dkeywords_002doption"></a><p>The arguments are declared to be valid keywords to use in
<code>instantiate-flavor</code> when creating an instance of this flavor (or any
flavor containing it).  The system uses this for error-checking: before
the system sends the <code>:init</code> message, it makes sure that all the
keywords in the init-plist are either inittable instance variables or
elements of this list.  If the caller misspells a keyword or otherwise
uses a keyword that no component flavor handles, this feature will
signal an error.  When you write a <code>:init</code> method that accepts some
keywords, they should be listed in the <code>:init-keywords</code> option of the
flavor.
</p>
</dd>
<dt><code>:default-init-plist</code></dt>
<dd><a name="index-_003adefault_002dinit_002dplist-defflavor"></a>
<a name="default_002dinit_002dplist_002doption"></a><p>The arguments are alternating keywords and value forms, like a
property-list.  When the flavor is instantiated, these properties and
values are put into the init-plist unless already present.  This allows
one component flavor to default an option to another component flavor.
The value forms are only evaluated when and if they are used.  For
example,
</p><div class="lisp">
<pre class="lisp">(:default-init-plist :frob-array
		     (make-array 100))
</pre></div>
<p>would provide a default &quot;frob array&quot; for any instance for which the
user did not provide one explicitly.
</p>
</dd>
<dt><code>:required-instance-variables</code></dt>
<dd><a name="index-_003arequired_002dinstance_002dvariables-defflavor"></a>
<a name="required_002dinstance_002dvariables_002doption"></a><p>Declares that any flavor incorporating this one that is instantiated
into an object must contain the specified instance variables.
An error occurs if there is an attempt to instantiate a flavor that
incorporates this one if it does not have these in its set of instance
variables.  Note that this option is not one of those that checks
the spelling of its arguments in the way described at the start of this section
(if it did, it would be useless).
</p>
<p>Required instance variables may be freely accessed by methods just like
normal instance variables.  The difference between listing instance
variables here and listing them at the front of the <code>defflavor</code> is
that the latter declares that this flavor &quot;owns&quot; those variables and
will take care of initializing them, while the former declares that this
flavor depends on those variables but that some other flavor must be
provided to manage them and whatever features they imply.
</p>
</dd>
<dt><code>:required-methods</code></dt>
<dd><a name="index-_003arequired_002dmethods-defflavor"></a>
<p>The arguments are names of operations that any flavor incorporating this
one must handle.  An error occurs if there is an attempt to instantiate
such a flavor and it is lacking a method for one of these operations.
Typically this option appears in the <code>defflavor</code> for a base flavor
(see <a href="#base_002dflavor">base-flavor</a>).  Usually this is used when a base flavor does a
<code>funcall-self</code> (<a href="#funcall_002dself_002dfun">funcall-self-fun</a>) to send itself a message that is
not handled by the base flavor itself; the idea is that the base flavor
will not be instantiated alone, but only with other components (mixins)
that do handle the message.  This keyword allows the error of having no
handler for the message be detected when the flavor instantiated or when
<code>compile-flavor-methods</code> is done, rather than when the missing
operation is used.
</p>
</dd>
<dt><code>:required-flavors</code></dt>
<dd><a name="index-_003arequired_002dflavors-defflavor"></a>
<p>The arguments are names of flavors that any flavor incorporating this one
must include as components, directly or indirectly.  The difference between
declaring flavors as required and listing them directly as components at the
top of the <code>defflavor</code> is that declaring flavors to be required does not make
any commitments about where those flavors will appear in the ordered list of
components; that is left up to whoever does specify them as components.
The purpose of declaring a flavor to be required is to allow
instance variables declared by that flavor to be accessed.  It also provides
error checking: an attempt to instantiate a flavor that does not include the
required flavors as components will signal an error.  Compare this with
<code>:required-methods</code> and <code>:required-instance-variables</code>.
</p>
<p>For an example of the use of required flavors, consider the <code>ship</code>
example given earlier, and suppose we want to define a <code>relativity-mixin</code>
which increases the mass dependent on the speed.  We might write,
</p><div class="lisp">
<pre class="lisp">(defflavor relativity-mixin () (moving-object))
(defmethod (relativity-mixin :mass) ()
  (// mass (sqrt (- 1 (^ (// (funcall-self ':speed)
			     *speed-of-light*)
			 2)))))
</pre></div>
<p>but this would lose because any flavor that had <code>relativity-mixin</code>
as a component would get <code>moving-object</code> right after it in its
component list.  As a base flavor, <code>moving-object</code> should be last
in the list of components so that other components mixed in can replace
its methods and so that daemon methods combine in the right order.
<code>relativity-mixin</code> has no business changing the order in which flavors
are combined, which should be under the control of its caller.  For example,
</p><div class="lisp">
<pre class="lisp">(defflavor starship ()
	   (relativity-mixin long-distance-mixin ship))
</pre></div>
<p>puts <code>moving-object</code> last (inheriting it from <code>ship</code>).
</p>
<p>So instead of the definition above we write,
</p><div class="lisp">
<pre class="lisp">(defflavor relativity-mixin () ()
	(:required-flavors moving-object))
</pre></div>
<p>which allows <code>relativity-mixin</code>&rsquo;s methods to access <code>moving-object</code>
instance variables such as <code>mass</code> (the rest mass), but does not
specify any place for <code>moving-object</code> in the list of components.
</p>
<p>It is very common to specify the <em>base flavor</em> of a mixin with the
<code>:required-flavors</code> option in this way.
</p>
</dd>
<dt><code>:included-flavors</code></dt>
<dd><a name="index-_003aincluded_002dflavors-defflavor"></a>
<p>The arguments are names of flavors to be included in this flavor.  The difference
between declaring flavors here and declaring them at the top of the <code>defflavor</code>
is that when component flavors are combined, if an included flavor is not specified
as a normal component, it is inserted into the list of components immediately after
the last component to include it.  Thus included flavors act like defaults.
The important thing is that if an included flavor <em>is</em> specified as a component,
its position in the list of components is completely controlled by that specification,
independently of where the flavor that includes it appears in the list.
</p>
<p><code>:included-flavors</code> and <code>:required-flavors</code> are used in similar ways; it would
have been reasonable to use <code>:included-flavors</code> in the <code>relativity-mixin</code>
example above.  The difference is that when a flavor is required but not given
as a normal component, an error is signalled, but when a flavor is included
but not given as a normal component, it is automatically inserted into the list
of components at a &quot;reasonable&quot; place.
</p>
</dd>
<dt><code>:no-vanilla-flavor</code></dt>
<dd><a name="index-_003ano_002dvanilla_002dflavor-defflavor"></a>
<p>Normally when a flavor is instantiated, the special flavor
<code>si:vanilla-flavor</code> is included automatically at the end of its list of
components.  The vanilla flavor provides some default methods for the
standard operations which all objects are supposed to understand.  These
include <code>:print-self</code>, <code>:describe</code>, <code>:which-operations</code>, and several
other operations.  See <a href="#vanilla_002dflavor">vanilla-flavor</a>.
</p>
<p>If any component of a flavor specifies the <code>:no-vanilla-flavor</code> option,
then <code>si:vanilla-flavor</code> will not be included in that flavor.  This option
should not be used casually.
</p>
</dd>
<dt><code>:default-handler</code></dt>
<dd><a name="index-_003adefault_002dhandler-defflavor"></a>
<p>The argument is the name of a function that is to be called when a message
is received for which there is no method.
It will be called with whatever arguments the instance was called with,
including the operation name; whatever values it returns will be returned.
If this option is not specified
on any component flavor, it defaults to a function that will signal an error.
</p>
</dd>
<dt><code>:ordered-instance-variables</code></dt>
<dd><a name="index-_003aordered_002dinstance_002dvariables-defflavor"></a>
<a name="ordered_002dinstance_002dvariables_002doption"></a><p>This option is mostly for esoteric internal system uses.
The arguments are names of instance variables which must appear first (and in this order)
in all instances of this flavor, or any flavor depending on this flavor.
This is used for instance variables that are specially known about by
microcode, and also in connection with the <code>:outside-accessible-instance-variables</code>
option.  If the keyword is given alone, the arguments default to the list
of instance variables given at the top of this <code>defflavor</code>.
</p>
<p>Removing any of the <code>:ordered-instance-variables</code>, or changing their
positions in the list, requires that you recompile all methods that use
any of the affected instance variables.
</p>
</dd>
<dt><code>:outside-accessible-instance-variables</code></dt>
<dd><a name="index-_003aoutside_002daccessible_002dinstance_002dvariables-defflavor"></a>
<a name="outside_002daccessible_002dinstance_002dvariables_002doption"></a><p>The arguments are instance variables which are to be accessible from
&quot;outside&quot; of this object, that is from functions other than methods.
A macro (actually a <code>defsubst</code>) is defined which takes an object of
this flavor as an argument and returns the value of the instance variable;
<code>setf</code> may be used to set the value of the instance variable.  The name
of the macro is the name of the flavor concatenated with a hyphen and the
name of the instance variable.  These macros are similar to the accessor
macros created by <code>defstruct</code> (see <a href="#defstruct">defstruct</a>.)
</p>
<p>This feature works in two different ways, depending on whether the instance
variable has been declared to have a fixed slot in all instances, via the
<code>:ordered-instance-variables</code> option.
</p>
<p>If the variable is not ordered, the position of its value cell in the
instance will have to be computed at run time.  This takes noticeable
time, although less than actually sending a message would take.  An
error will be signalled if the argument to the accessor macro is
not an instance or is an instance that does not have an instance
variable with the appropriate name.  However, there is no error check
that the flavor of the instance is the flavor the accessor macro was
defined for, or a flavor built upon that flavor.  This error check
would be too expensive.
</p>
<p>If the variable is ordered, the compiler will compile a call to
the accessor macro into a subprimitive which simply accesses that
variable&rsquo;s assigned slot by number.  This subprimitive is only three
or four times slower than <code>car</code>.  The only error-checking
performed is to make sure that the argument is really an instance
and is really big enough to contain that slot.  There is no check
that the accessed slot really belongs to an instance variable of
the appropriate name.
</p>
</dd>
<dt><code>:accessor-prefix</code></dt>
<dd><a name="index-_003aaccessor_002dprefix-defflavor"></a>
<p>Normally the accessor macro created by the <code>:outside-accessible-instance-variables</code>
option to access the flavor <em>f</em>&rsquo;s instance variable <em>v</em> is named <em>f-v</em>.
Specifying <code>(:accessor-prefix get$)</code> causes it to be named <code>get$<em>v</em></code> instead.
</p>
</dd>
<dt><code>:abstract-flavor</code></dt>
<dd><p>This option marks the flavor as one that is not supposed to be
instantiated (that is, is supposed to be used only to make other
flavors).  An attempt to instantiate the flavor will signal an error.
</p>
<p>It is sometimes useful to do <code>compile-flavor-methods</code> on a flavor that
is not going to be instantiated, if the combined methods for this flavor
will be inherited and shared by many others.  <code>:abstract-flavor</code> tells
<code>compile-flavor-methods</code> not to complain about missing required
flavors, methods or instance variables.  Presumably the flavors that
depend on this one and actually are instantiated will supply what is
lacking.
</p>
</dd>
<dt><code>:method-combination</code></dt>
<dd><a name="index-_003amethod_002dcombination-defflavor"></a>
<a name="method_002dcombination_002doption"></a><p>Declares the way that methods from different flavors will be combined.
Each &quot;argument&quot; to this option is a list <code>(<em>type order operation1 operation2</em>...)</code>.
<em>operation1</em>, <em>operation2</em>, etc. are names of operations whose methods
are to be combined in the declared fashion.  <em>type</em> is a keyword that
is a defined type of combination; see <a href="#method_002dcombination">method-combination</a>.  <em>Order</em>
is a keyword whose interpretation is up to <em>type</em>; typically it is
either <code>:base-flavor-first</code> or <code>:base-flavor-last</code>.
</p>
<p>Any component of a flavor may specify the type of method combination
to be used for a particular operation.  If no component specifies a type
of method combination, then the default type is used, namely <code>:daemon</code>.
If more than one component of a flavor specifies it, then they must
agree on the specification, or else an error is signalled.
</p>
</dd>
<dt><code>:documentation</code></dt>
<dd><a name="index-_003adocumentation-defflavor"></a>
<p>The list of arguments to this option is remembered on the flavor&rsquo;s property
list as the <code>:documentation</code> property.  The (loose) standard for what can
be in this list is as follows; this may be extended in the future.  A string
is documentation on what the flavor is for; this may consist of a brief
overview in the first line, then several paragraphs of detailed documentation.
A symbol is one of the following keywords:
</p><dl compact="compact">
<dt><code>:mixin</code></dt>
<dd><a name="index-_003amixin-_0022defflavor-_003adocumentation_0022"></a>
<p>A flavor that you may want to mix with others to provide a useful feature.
</p></dd>
<dt><code>:essential-mixin</code></dt>
<dd><a name="index-_003aessential_002dmixin-_0022defflavor-_003adocumentation_0022"></a>
<p>A flavor that must be mixed in to all flavors of its class, or inappropriate
behavior will ensue.
</p></dd>
<dt><code>:lowlevel-mixin</code></dt>
<dd><a name="index-_003alowlevel_002dmixin-_0022defflavor-_003adocumentation_0022"></a>
<p>A mixin used only to build other mixins.
</p></dd>
<dt><code>:combination</code></dt>
<dd><a name="index-_003acombination-_0022defflavor-_003adocumentation_0022"></a>
<p>A combination of flavors for a specific purpose.
</p></dd>
<dt><code>:special-purpose</code></dt>
<dd><a name="index-_003aspecial_002dpurpose-_0022defflavor-_003adocumentation_0022"></a>
<p>A flavor that is not intended for general use, used for some internal or
kludgey purpose by a particular program.
</p>
</dd>
</dl>

<p>This documentation can be viewed with the <code>describe-flavor</code> function
(see <a href="#describe_002dflavor_002dfun">describe-flavor-fun</a>) or the editor&rsquo;s <code>Meta-X Describe Flavor</code>
command (see <a href="#describe_002dflavor_002dcommand">describe-flavor-command</a>).
</p>
</dd>
</dl>

<a name="Flavor-Families"></a>
<h3 class="section">20.9 Flavor Families</h3>

<a name="base_002dflavor"></a><a name="mixin_002dflavor"></a><a name="index-base_002dflavor"></a>
<a name="index-mixin"></a>

<p>The following organization conventions are recommended for all programs that use flavors.
</p>
<p>A <em>base flavor</em> is a flavor that defines a whole family of related flavors,
all of which will have that base flavor as one of their components.
Typically the base flavor includes things relevant to the whole family,
such as instance variables, <code>:required-methods</code> and <code>:required-instance-variables</code>
declarations, default methods for certain operations, <code>:method-combination</code>
declarations, and documentation on the general protocols and conventions
of the family.  Some base flavors are complete and can be instantiated, but
most are not instantiatable and merely serve as a base upon which to build
other flavors.  The base flavor for the <em>foo</em> family is often named <code>basic-<em>foo</em></code>.
</p>
<p>A <em>mixin flavor</em> is a flavor that defines one particular feature of an object.
A mixin cannot be instantiated, because it is not a complete description.
Each module or feature of a program
is defined as a separate mixin; a usable flavor can be constructed by choosing
the mixins for the desired characteristics and combining them, along with the
appropriate base flavor.  By organizing your flavors this way, you keep separate
features in separate flavors, and you can pick and choose among them.
Sometimes the order of combining mixins does not matter,
but often it does, because the order of flavor combination controls the order
in which daemons are invoked and wrappers are wrapped.  Such order dependencies
should be documented as part of the conventions of the appropriate family of flavors.
A mixin flavor that provides the <em>mumble</em> feature is often named <em>mumble<code>-mixin</code></em>.
</p>
<p>If you are writing a program that uses someone else&rsquo;s facility to do something,
using that facility&rsquo;s flavors and methods, your program may still define
its own flavors, in a simple way.  The facility provides a base flavor and
a set of mixins: the caller can combine these in various ways depending
on exactly what it wants, since the facility probably will not provide all possible
useful combinations.  Even if your private flavor has exactly the
same components as a pre-existing flavor, it can still be useful since
you can use its <code>:default-init-plist</code> (see <a href="#default_002dinit_002dplist_002doption">default-init-plist-option</a>) to
select options of its component flavors and you can define one or two methods
to customize it &quot;just a little&quot;.
</p>
<a name="Vanilla-Flavor"></a>
<h3 class="section">20.10 Vanilla Flavor</h3>
<a name="vanilla_002dflavor"></a>
<p>The operations described in this section are a standard protocol, which all
message-receiving objects are assumed to understand.  The standard methods
that implement this protocol are automatically supplied by the flavor
system unless the user specifically tells it not to do so.  These methods
are associated with the flavor <code>si:vanilla-flavor</code>:
</p>
<dl>
<dt><a name="index-si_003avanilla_002dflavor-on-"></a>Flavor on : <strong>si:vanilla-flavor</strong></dt>
<dd><p>Unless you specify otherwise (with the <code>:no-vanilla-flavor</code> option to
<code>defflavor</code>), every flavor includes the &quot;vanilla&quot; flavor, which has no
instance variables but provides some basic useful methods.
</p></dd></dl>

<dl>
<dt><a name="index-stream-on-_003aprint_002dself"></a>Message on :print-self: <strong>stream</strong> <em>prindepth slashify-p</em></dt>
<dd><p>The object should output its printed-representation to a stream.  The
printer sends this message when it encounters an instance or an entity.
The arguments are the stream, the current depth in list-structure (for
comparison with <code>prinlevel</code>), and whether slashification is enabled
(<code>prin1</code> vs <code>princ</code>; see <a href="#slashification">slashification</a>).  Vanilla-flavor ignores
the last two arguments and prints something like <code>#&lt;<em>flavor-name
octal-address</em>&gt;</code>.  The <em>flavor-name</em> tells you what type of object
it is and the <em>octal-address</em> allows you to tell different objects
apart (provided the garbage collector doesn&rsquo;t move them behind your back).
</p></dd></dl>

<dl>
<dt><a name="index-_003adescribe-on-"></a>Message on : <strong>:describe</strong></dt>
<dd><p>The object should describe itself, printing a description onto the
<code>standard-output</code> stream.  The <code>describe</code> function sends this
message when it encounters an instance or an entity.  Vanilla-flavor
outputs in a reasonable format the object, the name of its flavor, and
the names and values of its instance-variables.
</p></dd></dl>

<dl>
<dt><a name="index-_003awhich_002doperations-on-"></a>Message on : <strong>:which-operations</strong></dt>
<dd><p>The object should return a list of the operations it can handle.
Vanilla-flavor generates the list once per flavor and remembers it,
minimizing consing and compute-time.  If a new method is added, the
list is regenerated the next time someone asks for it.
</p></dd></dl>

<dl>
<dt><a name="index-operation-on-_003aoperation_002dhandled_002dp"></a>Message on :operation-handled-p: <strong>operation</strong></dt>
<dd><p><em>operation</em> is an operation name.  The object should return <code>t</code> if it
has a handler for the specified operation, <code>nil</code> if it does not.
</p></dd></dl>

<dl>
<dt><a name="index-operation-on-_003aget_002dhandler_002dfor"></a>Message on :get-handler-for: <strong>operation</strong></dt>
<dd><p><em>operation</em> is an operation name.
The object should return the method it uses to handle <em>operation</em>.
If it has no handler for that operation, it should return <code>nil</code>.
This is like the <code>get-handler-for</code> function (see <a href="#get_002dhandler_002dfor_002dfun">get-handler-for-fun</a>),
but, of course, you can use it only on objects known to accept messages.
</p></dd></dl>

<dl>
<dt><a name="index-operation-on-_003asend_002dif_002dhandles"></a>Message on :send-if-handles: <strong>operation</strong> <em>&amp;rest arguments</em></dt>
<dd><p><em>operation</em> is an operation name and <em>arguments</em> is a list of
arguments for the operation.  If the object handles the operation, it
should send itself a message with that operation and arguments.  If it
doesn&rsquo;t handle the operation it should just return <code>nil</code>.
</p></dd></dl>

<dl>
<dt><a name="index-form-on-_003aeval_002dinside_002dyourself"></a>Message on :eval-inside-yourself: <strong>form</strong></dt>
<dd><p>The argument is a form that is evaluated in an environment in which special
variables with the names of the instance variables are bound to the values
of the instance variables.  It works to <code>setq</code> one of these special variables;
the instance variable will be modified.  This is intended to be used mainly
for debugging.
</p></dd></dl>

<dl>
<dt><a name="index-function-on-_003afuncall_002dinside_002dyourself"></a>Message on :funcall-inside-yourself: <strong>function</strong> <em>&amp;rest args</em></dt>
<dd><p><em>function</em> is applied to <em>args</em> in an environment in which special
variables with the names of the instance variables are bound to the values
of the instance variables.  It works to <code>setq</code> one of these special variables;
the instance variable will be modified.  This is a way of allowing callers
to provide actions to be performed in an environment set up by the instance.
</p></dd></dl>

<dl>
<dt><a name="index-_003abreak-on-"></a>Message on : <strong>:break</strong></dt>
<dd><p><code>break</code> is called in an environment in which special
variables with the names of the instance variables are bound to the values
of the instance variables.
</p></dd></dl>

<a name="Method-Combination"></a>
<h3 class="section">20.11 Method Combination</h3>

<a name="method_002dcombination"></a>
<p>As was mentioned earlier, there are many ways to combine methods.  The
way we have seen is called the <code>:daemon</code> type of combination.  To use
one of the others, you use the <code>:method-combination</code> option to
<code>defflavor</code> (see <a href="#method_002dcombination_002doption">method-combination-option</a>) to say that all the
methods for a certain operation on this flavor, or any flavor built on it,
should be combined in a certain way.
</p>
<p>The following types of method combination are supplied by the system.
It is possible to define your own types of method combination; for
information on this, see the code.  Note that for most types of method
combination other than <code>:daemon</code> you must define the order in which
the methods are combined, either <code>:base-flavor-first</code> or
<code>:base-flavor-last</code>, in the <code>:method-combination</code> option.  In this
context, &quot;base-flavor&quot; means the last element of the flavor&rsquo;s
fully-expanded list of components.
</p>
<p>A few method types (<code>:default</code>, <code>:around</code>) have a universal meaning
independent of the method combination type.  Aside from these, the
method type keywords allowed vary depending on the type of method
combination selected, and many combination types allow only untyped
methods.  There are also certain method types used for internal
purposes.
</p>
<dl compact="compact">
<dt><code>:daemon</code></dt>
<dd><p>This is the default type of method combination.  All the <code>:before</code>
methods are called, then the primary (untyped) method for the outermost
flavor that has one is called, then all the <code>:after</code> methods are
called.  The value returned is the value of the primary method.
</p>
</dd>
<dt><code>:daemon-with-or</code></dt>
<dd><p>This is like the <code>:daemon</code> method combination type, except that the primary
method is wrapped in an <code>:or</code> special form with all <code>:or</code> methods.
Multiple values will be returned from the primary method, but not from the
<code>:or</code> methods.  This will produce combined methods like this
(simplified to ignore multiple values):
</p>
<div class="lisp">
<pre class="lisp">(progn (foo-before-method)
       (or (foo-or-method)
	   (foo-primary-method))
       (foo-after-method))
</pre></div>

<p>This is useful primarily for flavors in which a mixin introduces an
alternative to the primary method.  Each <code>:or</code> method gets a chance
to run before the primary method and to decide whether the primary
method should be run or not; if any <code>:or</code> method returns a non-<code>nil</code>
value, the primary method is not run (nor are the rest of the <code>:or</code>
methods).  Note that the ordering of the combination of the <code>:or</code> methods
is controlled by the <em>order</em> keyword in the <code>:method-combination</code> option
to <code>defflavor</code> (see <a href="#method_002dcombination_002doption">method-combination-option</a>).
</p>
</dd>
<dt><code>:daemon-with-and</code></dt>
<dd><p>This is like <code>:daemon-with-or</code> except that it combines <code>:and</code> methods
in an <code>and</code> special form.  The primary method will only be run
if all of the <code>:and</code> methods return non-<code>nil</code> values.
</p>
</dd>
<dt><code>:daemon-with-override</code></dt>
<dd><p>This is like the <code>:daemon</code> method combination type, except an <code>or</code>
special form is wrapped around the entire combined method with all
<code>:override</code> typed methods before the combined method.  This differs
from <code>:daemon-with-or</code> in that the <code>:before</code> and <code>:after</code> daemons
are run only if <em>none</em> of the <code>:override</code> methods returns
non-<code>nil</code>.  The combined method looks something like this:
</p>
<div class="lisp">
<pre class="lisp">(or (foo-override-method)
    (progn (foo-before-method)
	   (foo-primary-method)
	   (foo-after-method)))
</pre></div>

</dd>
<dt><code>:progn</code></dt>
<dd><p>All the methods are called, inside a <code>progn</code> special form.  No typed
methods are allowed.  The result of the combined method is whatever the
last of the methods returns.
</p>
</dd>
<dt><code>:or</code></dt>
<dd><p>All the methods are called, inside an <code>or</code> special form.
No typed methods are allowed.  This means that each of the
methods is called in turn.  If a method returns a non-<code>nil</code> value,
that value is returned and none of the rest of the methods are called;
otherwise, the next method is called.  In other words, each method
is given a chance to handle the message; if it doesn&rsquo;t want to handle
the message, it should return <code>nil</code>, and the next method will get
a chance to try.
</p>
</dd>
<dt><code>:and</code></dt>
<dd><p>All the methods are called, inside an <code>and</code> special form.
No typed methods are allowed.  The basic idea is much like <code>:or</code>;
see above.
</p>
</dd>
<dt><code>:append</code></dt>
<dd><p>All the methods are called, and the values are appended together.
</p>
</dd>
<dt><code>:nconc</code></dt>
<dd><p>All the methods are called, and the values are <code>nconc</code>&rsquo;d together.
</p>
</dd>
<dt><code>:list</code></dt>
<dd><p>Calls all the methods and returns a list of their returned values.  No typed
methods are allowed.
</p>
</dd>
<dt><code>:inverse-list</code></dt>
<dd><p>Calls each method with one argument; these arguments are successive elements of the list that
is the sole argument to the operation.  No typed methods are allowed.  Returns no
particular value.  If the result of a <code>:list</code>-combined operation is
sent back with an <code>:inverse-list</code>-combined operation, with the same
ordering and with corresponding method definitions, each component
flavor receives the value that came from that flavor.
</p>
</dd>
<dt><code>:pass-on</code></dt>
<dd><p>Calls each method on the values returned by the preceeding one.  The values
returned by the combined method are those of the outermost call.  The format
of the declaration in the <code>defflavor</code> is:
</p>
<div class="lisp">
<pre class="lisp">(:method-combination (:pass-on (<em>ordering</em> . <em>arglist</em>))
                     . <em>operation-names</em>)
</pre></div>

<p>Where <em>ordering</em> is <code>:base-flavor-first</code> or <code>:base-flavor-last</code>.
<em>arglist</em> may include the <code>&amp;aux</code> and <code>&amp;optional</code> keywords.
</p>
</dd>
<dt><code>:case</code></dt>
<dd><p>With <code>:case</code> method combination, the combined method automatically
does a <code>selectq</code> dispatch on the first argument of the operation,
known as the <em>suboperation</em>.  Methods of type <code>:case</code> can be used,
and each one specifies one suboperation that it applies to.  If no
<code>:case</code> method matches the suboperation, the primary method, if any,
is called.
</p>
<div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(defflavor foo (a b) ()
  (:method-combination (:case :base-flavor-last :win)))

</pre><pre class="lisp">This method will handle <code>(send a-foo ':win ':a)</code>:
</pre><pre class="lisp">(defmethod (foo :case :win :a) ()
  a)

</pre><pre class="lisp">This method will handle <code>(send a-foo ':win ':a*b)</code>:
</pre><pre class="lisp">(defmethod (foo :case :win :a*b) ()
  (* a b))

</pre><pre class="lisp">This method will handle <code>(send a-foo ':win ':something-else)</code>:
</pre><pre class="lisp">(defmethod (foo :win) (suboperation)
  (list 'something-random suboperation))
</pre></div>

<p><code>:case</code> methods are unusual in that one flavor can have many <code>:case</code>
methods for the same operation, as long as they are for different
suboperations.
</p>
<p>The suboperations <code>:which-operations</code>, <code>:operation-handled-p</code>,
<code>:send-if-handles</code> and <code>:get-handler-for</code> are all handled
automatically based on the collection of <code>:case</code> methods that are
present.
</p>
<p>Methods of type <code>:or</code> are also allowed.  They are called just before
the primary method, and if one of them returns a non-<code>nil</code> value, that
is the value of the operation, and no more methods are called.
</p></dd>
</dl>

<p>Here is a table of all the method types used in the standard system.  A user
can add more, by defining new forms of method-combination.
</p>
<dl compact="compact">
<dt><code><span class="roman">(no type)</span></code></dt>
<dd><p>If no type is given to <code>defmethod</code>, a primary method is created.
This is the most common type of method.
</p>
</dd>
<dt><code>:before</code></dt>
<dt><code>:after</code></dt>
<dd><p>These are used for the before-daemon and after-daemon
methods used by <code>:daemon</code> method-combination.
</p>
</dd>
<dt><code>:default</code></dt>
<dd><p>If there are no untyped methods among any of the flavors being combined,
then the <code>:default</code> methods (if any) are treated as if they were untyped.
If there are any untyped methods, the <code>:default</code> methods are ignored.
</p>
<p>Typically a base-flavor (see <a href="#base_002dflavor">base-flavor</a>) will define some default
methods for certain of the operations understood by its family.  When
using the default kind of method-combination these default methods will
not be called if a flavor provides its own method.  But with certain
strange forms of method-combination (<code>:or</code> for example) the
base-flavor uses a <code>:default</code> method to achieve its desired effect.
</p>
</dd>
<dt><code>:or</code></dt>
<dt><code>:and</code></dt>
<dd><p>These are used for <code>:daemon-with-or</code> and <code>:daemon-with-and</code>
method combination.  The <code>:or</code> methods are wrapped in an <code>or</code>,
or the <code>:and</code> methods are wrapped in an <code>and</code>, together
with the primary method, between the <code>:before</code> and <code>:after</code> methods.
</p>
</dd>
<dt><code>:override</code></dt>
<dd><p>This allows the features of <code>:or</code> method-combination to
be used together with daemons.  If you specify
method-combination type <code>:daemon-with-override</code>, you may use
<code>:override</code> methods.  The <code>:override</code> methods are executed first, until
one of them returns non-<code>nil</code>.  If this happens, that method&rsquo;s value(s)
are returned and no more methods are used.  If all the <code>:override</code>
methods return <code>nil</code>, the <code>:before</code>, primary and <code>:after</code> methods are
executed as usual.
</p>
<p>In typical usages of this feature, the
<code>:override</code> method usually returns <code>nil</code> and does nothing,
but in exceptional circumstances it takes over the handling of the
operation.
</p>
</dd>
<dt><code>:case</code></dt>
<dd><p><code>:case</code> methods are used by <code>:case</code> method combination.
</p></dd>
</dl>

<p>These method types can be used with any method combination type; they
have standard meanings independent of the method combination type being
used.
</p>
<dl compact="compact">
<dd><a name="around_002dmethod_002dtype"></a></dd>
<dt><code>:around</code></dt>
<dd><p>An <code>:around</code> method is able to control when, whether and how the
remaining methods will be executed.  It is given a continuation that is a
function that will execute the remaining methods, and has complete
responsibility for calling it or not, and deciding what arguments to give
it.  For the simplest behavior, the arguments should be the operation name
and operation arguments that the <code>:around</code> method itself received; but
sometimes the whole purpose of the <code>:around</code> method is to modify the
arguments before the remaining methods see them.
</p>
<p>The <code>:around</code> method receives three special arguments before the
arguments of the operation itself: the <em>continuation</em>, the
<em>mapping-table</em>, and the <em>original-argument-list</em>.  The last is a list
of the operation name and operation arguments.  The simplest way
for the <code>:around</code> method to invoke the remaining methods is to do
</p><div class="lisp">
<pre class="lisp">(lexpr-funcall-with-mapping-table
  <em>continuation</em> <em>mapping-table</em>
  <em>original-argument-list</em>)
</pre></div>
<p>In general, the <em>continuation</em> should be called with either
<code>funcall-with-mapping-table</code> or <code>lexpr-funcall-with-mapping-table</code>,
providing the <em>continuation</em>, the <em>mapping-table</em>, and the operation name
(which you know because it is the same as in the <code>defmethod</code>), followed
by whatever arguments the remaining methods are supposed to see.
</p>
<div class="lisp">
<pre class="lisp">(defflavor foo-one-bigger-mixin () ())

(defmethod (foo-one-bigger-mixin :around :set-foo)
           (cont mt ignore new-foo)
  (funcall-with-mapping-table cont mt ':set-foo
  			      (1+ new-foo)))
</pre></div>
<p>is a mixin which modifies the <code>:set-foo</code> operation so that the value
actually used in it is one greater than the value specified in the message.
</p>
</dd>
<dt><code>:wrapper</code></dt>
<dd><p>This type is used internally by <code>defwrapper</code>.
</p>
<p>Note that if one flavor defines both a wrapper and an <code>:around</code> method
for the same operation, the <code>:around</code> method is executed inside the
wrapper.
</p>
</dd>
<dt><code>:combined</code></dt>
<dd><p>Used internally for automatically-generated <em>combined</em> methods.
</p></dd>
</dl>

<p>The most common form of combination is <code>:daemon</code>.  One thing may not
be clear: when do you use a <code>:before</code> daemon and when do you use an <code>:after</code>
daemon?  In some cases the primary method performs a clearly-defined
action and the choice is obvious:  <code>:before :launch-rocket</code> puts in the
fuel, and <code>:after :launch-rocket</code> turns on the radar tracking.
</p>
<p>In other cases the choice can be less obvious.  Consider the <code>:init</code>
message, which is sent to a newly-created object.  To decide what kind
of daemon to use, we observe the order in which daemon methods are
called.  First the <code>:before</code> daemon of the highest level of
abstraction is called, then <code>:before</code> daemons of successively lower
levels of abstraction are called, and finally the <code>:before</code> daemon (if
any) of the base flavor is called.  Then the primary method is called.
After that, the <code>:after</code> daemon for the lowest level of abstraction is
called, followed by the <code>:after</code> daemons at successively higher levels
of abstraction.
</p>
<p>Now, if there is no interaction among all these methods, if their
actions are completely orthogonal, then it doesn&rsquo;t matter whether you
use a <code>:before</code> daemon or an <code>:after</code> daemon.  It makes a difference
if there is some interaction.  The interaction we are talking about is
usually done through instance variables; in general, instance variables
are how the methods of different component flavors communicate with each
other.  In the case of the <code>:init</code> operation, the <em>init-plist</em> can be
used as well.  The important thing to remember is that no method knows
beforehand which other flavors have been mixed in to form this flavor; a
method cannot make any assumptions about how this flavor has been
combined, and in what order the various components are mixed.
</p>
<p>This means that when a <code>:before</code> daemon has run, it must assume that
none of the methods for this operation have run yet.  But the <code>:after</code>
daemon knows that the <code>:before</code> daemon for each of the other flavors
has run.  So if one flavor wants to convey information to the other, the
first one should &quot;transmit&quot; the information in a <code>:before</code> daemon, and
the second one should &quot;receive&quot; it in an <code>:after</code> daemon.  So while
the <code>:before</code> daemons are run, information is &quot;transmitted&quot;; that is,
instance variables get set up.  Then, when the <code>:after</code> daemons are
run, they can look at the instance variables and act on their values.
</p>
<p>In the case of the <code>:init</code> method, the <code>:before</code> daemons typically set up
instance variables of the object based on the init-plist, while the
<code>:after</code> daemons actually do things, relying on the fact that all of the
instance variables have been initialized by the time they are called.
</p>
<p>The problems become most difficult when you are creating a network of
instances of various flavors that are supposed to point to each other.
For example, suppose you have flavors for &quot;buffers&quot; and &quot;streams&quot;, and
each buffer should be accompanied by a stream.  If you create the stream
in the <code>:before</code> <code>:init</code> method for buffers, you can inform the
stream of its corresponding buffer with an init keyword, but the stream
may try sending messages back to the buffer, which is not yet ready to
be used.  If you create the stream in the <code>:after</code> <code>:init</code> method
for buffers, there will be no problem with stream creation, but some
other <code>:after</code> <code>:init</code> methods of other mixins may have run and made
the assumption that there is to be no stream.  The only way to guarantee
success is to create the stream in a <code>:before</code> method and inform it of
its associated buffer by sending it a message from the buffer&rsquo;s
<code>:after</code> <code>:init</code> method.  This scheme&ndash;creating associated objects
in <code>:before</code> methods but linking them up in <code>:after</code> methods&ndash;often
avoids problems, because all the various associated objects used by
various mixins will at least exist before anything is done with any of
them.
</p>
<p>Of course, since flavors are not hierarchically organized, the notion of
levels of abstraction is not strictly applicable.  However, it remains a
useful way of thinking about systems.
</p>
<a name="Implementation-of-Flavors"></a>
<h3 class="section">20.12 Implementation of Flavors</h3>

<p>An object that is an instance of a flavor is implemented using the
data type <code>dtp-instance</code>.  The representation is a structure whose
first word, tagged with <code>dtp-instance-header</code>, points to a structure
(known to the microcode as an &quot;instance descriptor&quot;) containing the
internal data for the flavor.  The remaining words of the structure are value cells
containing the values of the instance variables.  The instance descriptor
is a <code>defstruct</code> that appears on the <code>si:flavor</code> property of the flavor
name.  It contains, among other things, the name of the flavor, the
size of an instance, the table of methods for handling operations, and
information for accessing the instance variables.
</p>
<p><code>defflavor</code> creates such a data structure for each flavor, and
links them together according to the dependency relationships
between flavors.
</p>
<p>A message is sent to an instance simply by calling it as a function,
with the first argument being the operation.
The microcode binds <code>self</code> to the object and binds those instance
variables that are defined to be special to the value
cells in the instance.  Then it
passes on the operation and arguments to a funcallable hash table taken
from the flavor-structure for this flavor.
</p>
<p>When the funcallable hash table is called as a function, it hashes the
first argument (the operation) to find a function to handle the operation
and an array called a mapping table.  The variable
<code>sys:self-mapping-table</code> is bound to the mapping table, which tells
the microcode how to access the other instance variables, those not
defined to be special.  Then the function is called.  If there is only
one method to be invoked, this function is that method; otherwise it is
an automatically-generated function called the combined method (see
<a href="#combined_002dmethod">combined-method</a>),
which calls the appropriate methods in the right order.
If there are wrappers, they are incorporated into this combined
method.
</p>
<p>The mapping table is an array whose elements correspond to the instance
variables which can be accessed by the flavor to which the currently
executing method belongs.  Each element contains the position in
<code>self</code> of that instance variable.  This position varies with the other
instance variables and component flavors of the flavor of <code>self</code>.
</p>
<p>Each time the combined method calls another method, it sets up the
mapping table required by that method&ndash;not in general the same
one which the combined method itself uses.  The mapping tables for the
called methods are extracted from the array leader of the mapping table
used by the combined method, which is kept in a local variable of the
combined method&rsquo;s stack frame while <code>sys:self-mapping-table</code> is set to
the mapping tables for the component methods.
</p>
<a name="sys_003aself_002dmapping_002dtable_002dvar"></a><dl>
<dt><a name="index-sys_003aself_002dmapping_002dtable"></a>Variable: <strong>sys:self-mapping-table</strong></dt>
<dd><p>This variable holds the current mapping table, which tells the running
flavor method where in <code>self</code> to find each instance variable.
</p></dd></dl>

<p>Ordered instance variables are referred to directly without going
through the mapping table.  This is a little faster, and reduces the
amount of space needed for mapping tables.  It is also the reason why
compiled code contains the positions of the ordered instance variables
and must be recompiled when they change.
</p>
<a name="Order-of-Definition"></a>
<h4 class="subsection">20.12.1 Order of Definition</h4>

<p>There is a certain amount of freedom to the order in which you do <code>defflavor</code>&rsquo;s,
<code>defmethod</code>&rsquo;s, and <code>defwrapper</code>&rsquo;s.  This freedom is designed to make it easy
to load programs containing complex flavor structures without having to do things
in a certain order.  It is considered important that not all the methods for a flavor
need be defined in the same file.  Thus the partitioning of a program into files
can be along modular lines.
</p>
<p>The rules for the order of definition are as follows.
</p>
<p>Before a method can be defined (with <code>defmethod</code> or <code>defwrapper</code>) its flavor
must have been defined (with <code>defflavor</code>).  This makes sense because the system
has to have a place to remember the method, and because it has to know the
instance-variables of the flavor if the method is to be compiled.
</p>
<p>When a flavor is defined (with <code>defflavor</code>) it is not necessary that
all of its component flavors be defined already.  This is to allow
<code>defflavor</code>&rsquo;s to be spread between files according to the modularity
of a program, and to provide for mutually-dependent flavors.
Methods can be defined for a flavor some of whose component flavors are
not yet defined; however, in certain cases compiling those methods will
produce a warning that an instance variable was declared
special (because the system did not realize it was an instance
variable).  If this happens, you should fix the problem and recompile.
</p>
<p>The methods automatically generated by the <code>:gettable-instance-variables</code>
and <code>:settable-instance-variables</code> <code>defflavor</code> options
(see <a href="#gettable_002dinstance_002dvariables_002doption">gettable-instance-variables-option</a>) are generated at the time
the <code>defflavor</code> is done.
</p>
<p>The first time a flavor is instantiated, or when
<code>compile-flavor-methods</code> is done, the system looks through all of the
component flavors and gathers various information.  At this point an
error will be signalled if not all of the components have been
<code>defflavor</code>&rsquo;ed.  This is also the time at which certain other errors
are detected, for instance lack of a required instance-variable (see the
<code>:required-instance-variables</code> <code>defflavor</code> option,
<a href="#required_002dinstance_002dvariables_002doption">required-instance-variables-option</a>).  The combined methods (see
<a href="#combined_002dmethod">combined-method</a>) are generated at this time also, unless they already
exist.
</p>
<p>After a flavor has been instantiated, it is possible to make changes to it.
These changes will affect all existing instances if possible.  This is
described more fully immediately below.
</p>
<a name="Changing-a-Flavor"></a>
<h4 class="subsection">20.12.2 Changing a Flavor</h4>

<p>You can change anything about a flavor at any time.  You can change the
flavor&rsquo;s general attributes by doing another <code>defflavor</code> with the same
name.  You can add or modify methods by doing <code>defmethod</code>&rsquo;s.  If you
do a <code>defmethod</code> with the same flavor-name, operation (and
suboperation if any), and (optional) method-type as an existing method,
that method is replaced by the new definition.  You can remove a
method with <code>undefmethod</code> (see <a href="#undefmethod_002dfun">undefmethod-fun</a>).
</p>
<p>These changes will always propagate to all flavors that depend upon the
changed flavor.  Normally the system will propagate the changes to all
existing instances of the changed flavor and all flavors that depend on
it.  However, this is not possible when the flavor has been changed so
drastically that the old instances would not work properly with the new
flavor.  This happens if you change the number of instance variables, which
changes the size of an instance.  It also happens if you change the order
of the instance variables (and hence the storage layout of an instance),
or if you change the component flavors (which can change several subtle
aspects of an instance).  The system does not keep a list of all the
instances of each flavor, so it cannot find the instances and modify them
to conform to the new flavor definition.  Instead it gives you a warning
message, on the <code>error-output</code> stream, to the effect that the flavor
was changed incompatibly and the old instances will not get the new version.
The system leaves the old flavor data-structure intact (the old instances
will continue to point at it) and makes a new one to contain the new version
of the flavor.  If a less drastic change is made, the system modifies the
original flavor data-structure, thus affecting the old instances that
point at it.  However, if you redefine methods in such a way that they
only work for the new version of the flavor, then trying to use those
methods with the old instances won&rsquo;t work.
</p>
<a name="Restrictions"></a>
<h4 class="subsection">20.12.3 Restrictions</h4>

<p>There is presently an implementation restriction that when using daemons,
the primary method may return at most three values if there are any <code>:after</code>
daemons.  This is because the combined method needs a place to remember the
values while it calls the daemons.  This will be fixed some day.
</p>
<a name="Entities"></a>
<h3 class="section">20.13 Entities</h3>

<a name="flavor_002dentity"></a>
<p>An <em>entity</em> is a Lisp object; the entity is one of the primitive
datatypes provided by the Lisp Machine system (the <code>data-type</code>
function (see <a href="#data_002dtype_002dfun">data-type-fun</a>) will return <code>dtp-entity</code> if it is
given an entity).  Entities are just like closures: they have all the
same attributes and functionality.  The only difference between the two
primitive types is their data type: entities are clearly distinguished
from closures because they have a different data type.  The reason there
is an important difference between them is that various parts of the
(not so primitive) Lisp system treat them differently.  The Lisp functions
that deal with entities are discussed in <a href="#entity">entity</a>.
</p>
<p>A closure is simply a kind of function, but
an entity is assumed to be a message-receiving object.  Thus, when the
Lisp printer (see <a href="#printer">printer</a>) is given a closure, it prints a simple
textual representation, but when it is handed an entity, it sends the
entity a <code>:print-self</code> message, which the entity is expected to
handle.  The <code>describe</code> function (see <a href="#describe_002dfun">describe-fun</a>) also sends
entities messages when it is handed them.  So when you want to make a
message-receiving object out of a closure, as described on
<a href="#entity_002dusage">entity-usage</a>, you should use an entity instead.
</p>
<p>Usually there is no point in using entities instead of flavors.
Flavors have had considerably more attention paid to their efficiency and
to good tools for using them.  If what you are doing is flavor-like, it
is better to use flavors.
</p>
<p>Entities are created with the <code>entity</code> function (see <a href="#entity_002dfun">entity-fun</a>).
The function part of an entity should usually be a function created
by <code>defselect</code> (see <a href="#defselect_002dfun">defselect-fun</a>).
</p>
<a name="Useful-Editor-Commands"></a>
<h3 class="section">20.14 Useful Editor Commands</h3>

<p>Since we presently lack an editor manual, this section briefly documents
some editor commands that are useful in conjunction with flavors.
</p>
<dl compact="compact">
<dt><code>Meta-.</code></dt>
<dd><p>The <code>Meta-.</code> (<code>Edit Definition</code>) command can find the definition of a flavor
in the same way that it can find the definition of a function.
</p>
<p><code>Edit Definition</code> can find the definition of a method if you it a
suitable function spec starting with <code>:method</code>.  The keyword
<code>:method</code> may be omitted if the definition is in the editor already.
Completion will occur on the flavor name and operation name as usual.
</p>
<a name="describe_002dflavor_002dcommand"></a></dd>
<dt><code>Meta-X Describe Flavor</code></dt>
<dd><p>Asks for a flavor name in the mini-buffer and describes its characteristics.
When typing the flavor name you have completion over the names of all defined
flavors (thus this command can be used to aid in guessing the name of a flavor).
The display produced is mouse sensitive where there are names of flavors and
of methods; as usual the right-hand mouse button gives you a menu of operations
and the left-hand mouse button does the most common operation, typically positioning
the editor to the source code for the thing you are pointing at.
</p>
</dd>
<dt><code>Meta-X List Methods</code></dt>
<dt><code>Meta-X Edit Methods</code></dt>
<dd><p>Asks you for an operation in the mini-buffer and lists all the flavors
that have a method for that operation.  You may type in the operation name,
point to it with the mouse, or let it default to the operation of the message
being sent by the Lisp form the cursor is on.  <code>List Methods</code>
produces a mouse-sensitive display allowing you to edit selected methods
or just to see which flavors have methods, while <code>Edit Methods</code> skips the
display and proceeds directly to editing the methods.
</p>
<p>As usual with this type of command, the editor command <code>Control-Shift-P</code>
will advance the editor cursor to the next method in the list, reading in
its source file if necessary.  Typing <code>Control-Shift-P</code>, while the display
is on the screen, edits the first method.
</p>
<p>In addition, you can find a copy of the list in the editor buffer
<code>*Possibilities*</code>.  While in that buffer, the command <code>Control-/</code> will
visit the definition of the method described on the line the cursor is
pointing at.
</p>
<p>These techniques of moving through the objects listed apply to all the
following commands as well.
</p>
</dd>
<dt><code>Meta-X List Combined Methods</code></dt>
<dt><code>Meta-X Edit Combined Methods</code></dt>
<dd><a name="list_002dcombined_002dmethods"></a><p>Asks you for an operation name and a flavor in two mini-buffers and lists all
the methods that would be called to handle that operation for an instance of that
flavor.
</p>
<p><code>List Combined Methods</code> can be very useful for telling what a flavor
will do in response to a message.  It shows you the primary method,
the daemons, and the wrappers and lets you see the code for all of
them; type <code>Control-Shift-P</code> to get to successive ones.
</p>
</dd>
<dt><code>Meta-X List Flavor Components</code></dt>
<dt><code>Meta-X Edit Flavor Components</code></dt>
<dd><p>Asks you for a flavor and lists or begins visiting all the flavors it depends on.
</p>
</dd>
<dt><code>Meta-X List Flavor Dependents</code></dt>
<dt><code>Meta-X Edit Flavor Dependents</code></dt>
<dd><p>Asks you for a flavor and lists or begins visiting all the flavors which depend on it.
</p>
</dd>
<dt><code>Meta-X List Flavor Direct Dependents</code></dt>
<dt><code>Meta-X Edit Flavor Direct Dependents</code></dt>
<dd><p>Asks you for a flavor and lists or begins visiting all the flavors which depend on it.
</p>
</dd>
<dt><code>Meta-X List Flavor Methods</code></dt>
<dt><code>Meta-X Edit Flavor Methods</code></dt>
<dd><p>Asks you for a flavor and lists or begins visiting all the methods defined
for that flavor.  (This does not include methods inherited from its component
flavors.)
</p></dd>
</dl>

<a name="Property-List-Operations"></a>
<h3 class="section">20.15 Property List Operations</h3>

<p>It is often useful to associate a property list with an abstract object,
for the same reasons that it is useful to have a property list
associated with a symbol.  This section describes a mixin flavor that
can be used as a component of any new flavor in order to provide that
new flavor with a property list.  For more details and examples, see the
general discussion of property lists (<a href="#plist">plist</a>).  The usual property
list functions (<code>get</code>, <code>putprop</code>, etc) all work on instances by
sending the instance the corresponding message.
</p>
<a name="si_003aproperty_002dlist_002dmixin_002dflavor"></a><dl>
<dt><a name="index-si_003aproperty_002dlist_002dmixin-on-"></a>Flavor on : <strong>si:property-list-mixin</strong></dt>
<dd><p>This mixin flavor provides the basic operations on property lists.
</p></dd></dl>

<dl>
<dt><a name="index-_003aget-on-si_003aproperty_002dlist_002dmixin"></a>Method on si:property-list-mixin: <strong>:get</strong> <em>property-name</em></dt>
<dd><p>The <code>:get</code> operation looks up the object&rsquo;s <em>property-name</em> property.
If it finds such a property, it returns the value; otherwise it
returns <code>nil</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003agetl-on-si_003aproperty_002dlist_002dmixin"></a>Method on si:property-list-mixin: <strong>:getl</strong> <em>property-name-list</em></dt>
<dd><p>The <code>:getl</code> operation is like the <code>:get</code> operation, except that the
argument is a list of property names.  The <code>:getl</code> operation searches
down the property list until it finds a property whose property name is
one of the elements of <em>property-name-list</em>.  It returns the portion
of the property list begining with the first such property that it
found.  If it doesn&rsquo;t find any, it returns <code>nil</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003aputprop-on-si_003aproperty_002dlist_002dmixin"></a>Method on si:property-list-mixin: <strong>:putprop</strong> <em>value property-name</em></dt>
<dd><p>This gives the object an <em>property-name</em> property of <em>value</em>.
</p></dd></dl>

<dl>
<dt><a name="index-_003aremprop-on-si_003aproperty_002dlist_002dmixin"></a>Method on si:property-list-mixin: <strong>:remprop</strong> <em>property-name</em></dt>
<dd><p>This removes the object&rsquo;s <em>property-name</em> property, by splicing it out
of the property list.  It returns one of the cells spliced out, whose car
is the former value of the property that was just removed.  If there was
no such property to begin with, the value is <code>nil</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003aget_002dlocation-on-si_003aproperty_002dlist_002dmixin"></a>Method on si:property-list-mixin: <strong>:get-location</strong> <em>property-name</em></dt>
<dd><p>Returns a locative pointer to the cell in which this object&rsquo;s
<em>property-name</em> property is stored.  If there is no such property, a
cell is added to the property list and initialized to <code>nil</code>, and a
pointer to that cell is returned.  This operation never returns <code>nil</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003apush_002dproperty-on-si_003aproperty_002dlist_002dmixin"></a>Method on si:property-list-mixin: <strong>:push-property</strong> <em>value property-name</em></dt>
<dd><p>The <em>property-name</em> property of the object should be a list (note that
<code>nil</code> is a list and an absent property is <code>nil</code>).  This operation sets
the <em>property-name</em> property of the object to a list whose car is
<em>value</em> and whose cdr is the former <em>property-name</em> property of the
list.  This is analogous to doing
</p><div class="lisp">
<pre class="lisp">(push <em>value</em> (get <em>object</em> <em>property-name</em>))
</pre></div>
<p>See the <code>push</code> special form (<a href="#push_002dfun">push-fun</a>).
</p></dd></dl>

<dl>
<dt><a name="index-_003aproperty_002dlist-on-si_003aproperty_002dlist_002dmixin"></a>Method on si:property-list-mixin: <strong>:property-list</strong></dt>
<dd><p>This returns the list of alternating property names and values that implements
the property list.
</p></dd></dl>

<dl>
<dt><a name="index-_003aproperty_002dlist_002dlocation-on-si_003aproperty_002dlist_002dmixin"></a>Method on si:property-list-mixin: <strong>:property-list-location</strong></dt>
<dd><p>This returns a locative pointer to the cell in the instance which holds
the property list data.
</p></dd></dl>

<dl>
<dt><a name="index-_003aset_002dproperty_002dlist-on-si_003aproperty_002dlist_002dmixin"></a>Method on si:property-list-mixin: <strong>:set-property-list</strong> <em>list</em></dt>
<dd><p>This sets the list of alternating property names and values that implements
the property list to <em>list</em>.
</p></dd></dl>

<dl>
<dt><a name="index-_003aproperty_002dlist"></a>Operation on <code>si:print-readably-mixin</code>: <strong>:property-list</strong> <em>list</em></dt>
<dd><p>This initializes the list of alternating property names and values that implements
the property list to <em>list</em>.
</p></dd></dl>

<a name="Printing-Flavor-Instances-Readably"></a>
<h3 class="section">20.16 Printing Flavor Instances Readably</h3>

<p>A flavor instance can print out so that it can be read back in, as long
as you give it a <code>:print-self</code> method that produces a suitable
printed representation, and provide a way to parse it.  The convention
for doing this is to print as
</p><div class="lisp">
<pre class="lisp">#leftHorseshoe<em>flavor-name</em> <em>additional-data</em>delta
</pre></div>
<p>and make sure that the flavor defines or inherits a <code>:read-instance</code>
method that can parse the <em>additional-data</em> and return an instance
(see <a href="#horseshoe_002dread">horseshoe-read</a>).  A convenient way of doing this is to use
<code>si:print-readably-mixin</code>.
</p>
<dl>
<dt><a name="index-si_003aprint_002dreadably_002dmixin-on-"></a>Flavor on : <strong>si:print-readably-mixin</strong></dt>
<dd><p>This mixin provides for flavor instances to print out using the <code>#leftHorseshoe</code>
syntax, and also for reading things that were printed in that way.
</p></dd></dl>

<dl>
<dt><a name="index-_003areconstruction_002dinit_002dplist-on-si_003aprint_002dreadably_002dmixin"></a>Method on si:print-readably-mixin: <strong>:reconstruction-init-plist</strong></dt>
<dd><p>When you use <code>si:print-readably-mixin</code>, you must define the operation
<code>:reconstruction-init-plist</code>.  This should return an alternating list
of init options and values that could be passed to <code>make-instance</code> to
create an instance &quot;like&quot; this one.
</p></dd></dl>

<a name="g_t_0022The-I_002fO-System_0022"></a>
<h2 class="chapter">21 &quot;The I/O System&quot;</h2>
<a name="index-input-and-output"></a>
<a name="io_002dchapter"></a><p>Zetalisp provides a powerful and flexible system for performing
input and output to peripheral devices.  To allow device independent I/O
(that is, to allow programs to be written in a general way so that the
program&rsquo;s input and output may be connected with any device), the
Zetalisp I/O system provides the concept of an &quot;I/O stream&quot;.  Streams,
their usage, and their implementation are described in this chapter.
This chapter also describes the Lisp &quot;I/O&quot; operations <code>read</code> and
<code>print</code> and the printed representation they use for Lisp objects.
</p>
<a name="g_t_0022The-Character-Set_0022"></a>
<h3 class="section">21.1 &quot;The Character Set&quot;</h3>
<a name="index-character-set"></a>
<a name="character_002dset"></a>
<p>Zetalisp represents characters as fixnums.
The Lisp Machine&rsquo;s mapping between these numbers and the characters is listed here.
The mapping is similar to ASCII, but somewhat modified to allow the use
of the so-called SAIL extended graphics, while avoiding certain
ambiguities present in ITS.  For a long time ITS treated the <code>Backspace</code>,
<code>Control-H</code>, and <code></code> keys on the keyboard identically as
character code 10 octal; this problem is avoided from the start in
the Lisp Machine&rsquo;s mapping.
</p>
<p>It is worth pointing out that although the Zetalisp character set
is different from the PDP-10 character set, when files are transferred between
Lisp Machines and PDP-10&rsquo;s the characters are automatically converted.  Details
of the mapping are explained below.
</p>
<p>Fundamental characters are eight bits wide.  Only those less than
200 octal (with the 200 bit off) are printing graphics;
when output to a device they are assumed to print a character and move
the &quot;cursor&quot; one character position to the right.  (All software provides
for variable-width fonts, so the term &quot;character position&quot; shouldn&rsquo;t
be taken too literally.)
</p>
<p>Characters in the range of 200 to 236 inclusive are used for special
characters.  Character 200 is a &quot;null character&quot;, which does not correspond to
any key on the keyboard.  The null character is not used for anything much;
<code>fasload</code> uses it internally.  Characters 201 through 236 correspond to the special
function keys on the keyboard such as <code>Return</code> and <code>Call</code>.  The remaining characters
are reserved for future expansion.
</p>
<p>It should never be necessary for a user or a source program to know these numerical
values.  Indeed, they are likely to be changed in the future.  There are
symbolic names for all characters; see below.
</p>
<p>Most of the special characters do not normally appear in files (although
it is not forbidden for files to contain them).  These characters exist mainly
to be used as &quot;commands&quot; from the keyboard.
</p>
<p>A few special characters, however, are &quot;format effectors&quot; which are just
as legitimate as printing characters in text files.  The names and meanings of
these characters are:
</p><dl compact="compact">
<dt><span class="roman">Return</span></dt>
<dd><p>The &quot;newline&quot; character, which separates lines of text.  We do not use
the PDP-10 convention which separates lines by a pair of characters, a
&quot;carriage return&quot; and a &quot;linefeed&quot;.
</p>
</dd>
<dt><span class="roman">Page</span></dt>
<dd><p>The &quot;page separator&quot; character, which separates pages of text.
</p>
</dd>
<dt><span class="roman">Tab</span></dt>
<dd><p>The &quot;tabulation&quot; character, which spaces to the right until the next &quot;tab stop&quot;.
Tab stops are normally every 8 character positions.
</p></dd>
</dl>
<p>The space character is considered to be a printing character whose printed image
happens to be blank, rather than a format effector.
</p>
<p>In some contexts, a fixnum can hold both a character code
and a font number for that character.  The following byte
specifiers are defined:
</p>
<a name="g_t_0025_0025ch_002dchar_002dvar"></a><dl>
<dt><a name="index-_0025_0025ch_002dchar"></a>Variable: <strong>%%ch-char</strong></dt>
<dd><p>The value of <code>%%ch-char</code> is a byte specifier for the field
of a fixnum character that holds the character code.
</p></dd></dl>

<a name="g_t_0025_0025ch_002dfont_002dvar"></a><dl>
<dt><a name="index-_0025_0025ch_002dfont"></a>Variable: <strong>%%ch-font</strong></dt>
<dd><p>The value of <code>%%ch-font</code> is a byte specifier for the field
of a fixnum character that holds the font number.
</p></dd></dl>

<a name="index-keyboard-character"></a>
<p>Characters read in from the keyboard include a character code and
control bits.  A character cannot contain both a font number and control bits,
since these data are both stored in the same bits.  The following byte
specifiers are provided:
<a name="g_t_0025_0025kbd"></a><a name="index-_0025_0025kbd-fields"></a>
</p>
<a name="g_t_0025_0025kbd_002dchar_002dvar"></a><dl>
<dt><a name="index-_0025_0025kbd_002dchar"></a>Variable: <strong>%%kbd-char</strong></dt>
<dd><p>The value of <code>%%kbd-char</code> is a byte specifier for the field
of a keyboard character that holds the normal eight-bit character code.
</p></dd></dl>

<a name="g_t_0025_0025kbd_002dcontrol_002dvar"></a><dl>
<dt><a name="index-_0025_0025kbd_002dcontrol"></a>Variable: <strong>%%kbd-control</strong></dt>
<dd><p>The value of <code>%%kbd-control</code> is a byte specifier for the field
of a keyboard character that is 1 if either <code>Control</code> key was held down.
</p></dd></dl>

<a name="g_t_0025_0025kbd_002dmeta_002dvar"></a><dl>
<dt><a name="index-_0025_0025kbd_002dmeta"></a>Variable: <strong>%%kbd-meta</strong></dt>
<dd><p>The value of <code>%%kbd-meta</code> is a byte specifier for the field
of a keyboard character that is 1 if either <code>Meta</code> key was held down.
</p></dd></dl>

<a name="g_t_0025_0025kbd_002dsuper_002dvar"></a><dl>
<dt><a name="index-_0025_0025kbd_002dsuper"></a>Variable: <strong>%%kbd-super</strong></dt>
<dd><p>The value of <code>%%kbd-super</code> is a byte specifier for the field
of a keyboard character that is 1 if either <code>Super</code> key was held down.
</p></dd></dl>

<a name="g_t_0025_0025kbd_002dhyper_002dvar"></a><dl>
<dt><a name="index-_0025_0025kbd_002dhyper"></a>Variable: <strong>%%kbd-hyper</strong></dt>
<dd><p>The value of <code>%%kbd-hyper</code> is a byte specifier for the field
of a keyboard character that is 1 if either <code>Hyper</code> key was held down.
</p>
<p>This bit is also set if <code>Control</code> and/or <code>Meta</code> is typed in
combination with <code>Shift</code> and a letter.  <code>Shift</code> is much easier than
<code>Hyper</code> to reach with the left hand.
</p></dd></dl>

<a name="g_t_0025_0025kbd_002dcontrol_002dmeta_002dvar"></a><dl>
<dt><a name="index-_0025_0025kbd_002dcontrol_002dmeta"></a>Variable: <strong>%%kbd-control-meta</strong></dt>
<dd><p>The value of <code>%%kbd-control-meta</code> is a byte specifier for the four-bit field
of a keyboard character that contains the above control bits.  The least-significant
bit is <code>Control</code>.  The most significant bit is <code>Hyper</code>.
</p></dd></dl>

<p>The following fields are used by some programs that encode signals from
the mouse in a the format of a character.  Refer to the window system
documentation for an explanation of how these characters are generated.
</p>
<a name="g_t_0025_0025kbd_002dmouse_002dvar"></a><dl>
<dt><a name="index-_0025_0025kbd_002dmouse"></a>Variable: <strong>%%kbd-mouse</strong></dt>
<dd><p>The value of <code>%%kbd-mouse</code> is a byte specifier for the bit in a keyboard character
that indicates that the character is not really a character,
but a signal from the mouse.
</p></dd></dl>

<a name="g_t_0025_0025kbd_002dmouse_002dbutton_002dvar"></a><dl>
<dt><a name="index-_0025_0025kbd_002dmouse_002dbutton"></a>Variable: <strong>%%kbd-mouse-button</strong></dt>
<dd><p>The value of <code>%%kbd-mouse-button</code> is a byte specifier for the field in a mouse signal
that says which button was clicked.  The value is <code>0</code>, <code>1</code>, or <code>2</code> for
the left, middle, or right button, respectively.
</p></dd></dl>

<a name="g_t_0025_0025kbd_002dmouse_002dn_002dclicks_002dvar"></a><dl>
<dt><a name="index-_0025_0025kbd_002dmouse_002dn_002dclicks"></a>Variable: <strong>%%kbd-mouse-n-clicks</strong></dt>
<dd><p>The value of <code>%%kbd-mouse-n-clicks</code> 
is a byte specifier for the field in a mouse signal
that says how many times the button was clicked.
The value is one less than the number of times the button was clicked.
</p></dd></dl>

<p>When any of the control bits (<code>Control</code>, <code>Meta</code>, <code>Super</code>,
or <code>Hyper</code>) is set in conjunction with a letter, the letter will
always be upper-case.  The character codes that consist of a lower-case
letter and non-zero control bits are &quot;holes&quot; in the character set which
are never used for anything.  Note that when <code>Shift</code> is typed in
conjuction with <code>Control</code> and/or <code>Meta</code> and a letter, it means
<code>Hyper</code> rather than <code>Shift</code>.
</p>
<p>Since the control bits are not part of the fundamental 8-bit
character codes, there is no way to express keyboard input in terms of
simple character codes.  However, there is a convention accepted by the
relevant programs for encoding keyboard input into a string of
characters: if a character has its <code>Control</code> bit on, prefix it with an
alpha.  If a character has its <code>Meta</code> bit on, prefix it with a
beta.  If a character has both its <code>Control</code> and <code>Meta</code> bits on,
prefix it with an epsilon.  If a character has its <code>Super</code> bit on,
prefix it with a pi.  If a character has its <code>Hyper</code> bit on,
prefix it with a lambda.  To get an alpha, beta,
epsilon, pi, lambda, or equivalence into the string,
quote it by prefixing it with an equivalence.
</p>
<a name="character_002dset_002ddifferences"></a>
<p>When characters are written to a file server computer that
normally uses the ASCII character set to store text, Lisp Machine
characters are mapped into an encoding that is reasonably close to an
ASCII transliteration of the text.  When a file is written, the
characters are converted into this encoding; the inverse
transformation is done when a file is read back.  No information is
lost.  Note that the length of a file, in characters, will not be the
same measured in original Lisp Machine characters as it will measured in
the encoded ASCII characters.  In the currently implemented ASCII file
servers, the following encoding is used.  All printing characters and
any characters not mentioned explicitly here are represented as
themselves.  Codes 010 (lambda), 011 (gamma), 012 (delta), 014
(plus-minus), 015 (circle-plus), 177 (integral), 200 through 207
inclusive, 213 (<code>Delete</code>), and 216 and anything higher, are preceded
by a 177; that is, 177 is used as a &quot;quoting character&quot; for these codes.
Codes 210 (<code>Overstrike</code>), 211 (<code>Tab</code>), 212 (<code>Line</code>), and 214 (<code>Page</code>), are
converted to their ASCII cognates, namely 010 (backspace), 011
(horizontal tab), 012 (line feed), and 014 (form feed) respectively.
Code 215 (<code>Return</code>) is converted into 015 (carriage return) followed by
012 (line feed).  Code 377 is ignored completely, and so cannot be
stored in files.
</p><pre class="verbatim">000 center-dot (@LMcenterDot{})             040 space       100 @           140 `
001 down arrow (@LMdownArrow{})             041 !           101 A           141 a
002 alpha (@LMalpha{})                  042 &quot;           102 B           142 b
003 beta (@LMbeta{})                   043 #           103 C           143 c
004 and-sign (@LMandSign{})               044 $           104 D           144 d
005 not-sign (@LMnotSign{})               045 %           105 E           145 e
006 epsilon (@LMepsilon{})                046 &amp;           106 F           146 f
007 pi (@LMpi{})                     047 '           107 G           147 g
010 lambda (@ref{ctl-h})                 050 (           110 H           150 h
011 gamma (	)                  051 )           111 I           151 i
012 delta ()                  052 *           112 J           152 j
013 uparrow (@LMuparrow{})                053 +           113 K           153 k
014 plus-minus ()             054 ,           114 L           154 l
015 circle-plus (@ref{ctl-m})            055 -           115 M           155 m
016 infinity (@LMinfinity{})               056 .           116 N           156 n
017 partial delta (@LMpartialDelta{})          057 /           117 O           157 o
020 left horseshoe (@LMleftHorseshoe{})         060 0           120 P           160 p
021 right horseshoe (@LMdelta{})        061 1           121 Q           161 q
022 up horseshoe (@LMupHorseshoe{})           062 2           122 R           162 r
023 down horseshoe (@LMcirclePlus{})         063 3           123 S           163 s
024 universal quantifier (@LMuniversalQuantifier{})   064 4           124 T           164 t
025 existential quantifier (@LMexistentialQuantifier{}) 065 5           125 U           165 u
026 circle-X (@LMcircleX{})               066 6           126 V           166 v
027 double-arrow (@LMdoubleArrow{})           067 7           127 W           167 w
030 left arrow (@LMleftArrow{})             070 8           130 X           170 x
031 right arrow (@LMrightArrow{})            071 9           131 Y           171 y
032 not-equals (@LMnotEquals{})             072 :           132 Z           172 z
033 diamond (altmode) (@LMdiamond{})      073 ;           133 [           173 @{
034 less-or-equal (@LMlessOrEqual{})          074 &lt;           134 \           174 |
035 greater-or-equal (@LMgreaterOrEqual{})       075 =           135 ]           175 @}
036 equivalence (@LMequivalence{})            076 &gt;           136 ^           176 ~
037 or (@LMor{})                     077 ?           137 _           177 @ref{ctl-qm}
200 Null character     210 Overstrike    220 Stop-output   230 Roman-iv
201 Break              211 Tab           221 Abort         231 Hand-up
202 Clear              212 Line          222 Resume        232 Hand-down
203 Call               213 Delete        223 Status        233 Hand-left
204 Terminal escape    214 Page          224 End           234 Hand-right
205 Macro/backnext     215 Return        225 Roman-i       235 System
206 Help               216 Quote         226 Roman-ii      236 Network
207 Rubout             217 Hold-output   227 Roman-iii
237-377 reserved for the future


                    The Lisp Machine Character Set
</pre><a name="g_t_0022Printed-Representation_0022"></a>
<h3 class="section">21.2 &quot;Printed Representation&quot;</h3>

<p>People cannot deal directly with Lisp objects, because the
objects live inside the machine.  In order to let us get at and talk
about Lisp objects, Lisp provides a representation of objects in the
form of printed text; this is called the <em>printed representation</em>.
This is what you have been seeing in the examples throughout this manual.
Functions such as <code>print</code>, <code>prin1</code>,  and <code>princ</code> take a Lisp
object and send the characters of its printed representation to a
stream.  These functions (and the internal functions they call) are
known as the <em>printer</em>.  The <code>read</code> function takes characters from a stream,
interprets them as a printed representation of a Lisp object, builds a
corresponding object, and returns it; it and its subfunctions are known as the <em>reader</em>.
(Streams are explained in <a href="#streams">streams</a>.)
</p>
<p>This section describes in detail what the printed
representation is for any Lisp object, and just what <code>read</code> does.
For the rest of the chapter, the phrase &quot;printed representation&quot; will
usually be abbreviated as &quot;p.r.&quot;
</p>
<a name="g_t_0022What-the-Printer-Produces_0022"></a>
<h4 class="subsection">21.2.1 &quot;What the Printer Produces&quot;</h4>
<a name="printer"></a><a name="index-printer"></a>
<p>The printed representation of an object depends on its
type.  In this section, we will consider each type of object
and explain how it is printed.
</p>
<a name="slashification"></a><a name="index-slashification"></a>
<p>Printing is done either with or without <em>slashification</em>.
The non-slashified version is nicer looking in general, but
if you give it to <code>read</code> it won&rsquo;t do the right thing.
The slashified version is carefully set up so that <code>read</code>
will be able to read it in.  The primary effects of slashification
are that special characters used with other than their
normal meanings (e.g a parenthesis appearing in the name
of a symbol) are preceded by slashes or cause the name of the
symbol to be enclosed in vertical bars, and that symbols that
are not from the current package get printed out with their
package prefixes (a package prefix looks like a symbol followed
by a colon).
</p>
<p>For a fixnum or a bignum: if the number is negative, the printed representation
begins with a minus sign (&quot;<code>-</code>&quot;).  Then the value of the variable <code>base</code>
is examined.  If <code>base</code> is a positive fixnum, the number is printed
out in that base (<code>base</code> defaults to 8).  If it is a symbol with
a <code>si:princ-function</code> property, the value of the property will be
applied to two arguments: <code>minus</code> of the number to be printed,
and the stream to which to print it
(this is a hook to allow output in Roman numerals and the like).
Otherwise the value of <code>base</code> is invalid and an error is signalled.
Finally, if <code>base</code> equals 10 and the variable <code>*nopoint</code> is
<code>nil</code>, a decimal point is printed out.  Slashification does
not affect the printing of numbers.
</p>
<a name="base_002dvar"></a><dl>
<dt><a name="index-base"></a>Variable: <strong>base</strong></dt>
<dd><p>The value of <code>base</code> is a number that is the radix in which fixnums
are printed, or a symbol with a <code>si:princ-function</code> property.
The initial value of <code>base</code> is 8.
</p></dd></dl>

<a name="g_t_002anopoint_002dvar"></a><dl>
<dt><a name="index-_002anopoint"></a>Variable: <strong>*nopoint</strong></dt>
<dd><p>If the value of <code>*nopoint</code> is <code>nil</code>, a trailing decimal point
is printed when a fixnum is printed out in base 10.  This allows
the numbers to be read back in correctly even if <code>ibase</code>
is not 10. at the time of reading.  If <code>*nopoint</code> is non-<code>nil</code>,
the trailing decimal points are suppressed.  The initial value of
<code>*nopoint</code> is <code>nil</code>.
</p></dd></dl>

<p>For a flonum: the printer first decides whether to use ordinary
notation or exponential notation.  If the magnitude of the number is too large
or too small, such that the ordinary notation would require an unreasonable
number of leading or trailing zeroes, then exponential notation will be used.
The number is printed as an optional leading minus sign, one or more digits,
a decimal point, one or more digits, and an optional trailing exponent,
consisting of the letter <code>e</code>, an optional minus sign, and the power of ten.
The number of digits printed is the &quot;correct&quot; number; no information present
in the flonum is lost and no extra trailing digits are printed that do not represent
information in the flonum.  Feeding the p.r of a flonum back to the reader
is always supposed to produce an equal flonum.
Flonums are always printed in decimal; they are not affected by
slashification or by <code>base</code> and <code>*nopoint</code>.
</p>
<p>For a small flonum: the printed representation is very similar to that
of a flonum, except that exponential notation is always used and the exponent
is delimited by <code>s</code> rather than <code>e</code>.
</p>
<p>For a rationalnum: the printed representation consists of the
numerator, a backslash, and the denominator.  For example,
the value of <code>(rationalize .5)</code> is printed as <code>1\2</code>.
</p>
<p>For a complexnum: the printed representation consists of the
real part, the character <code>+</code>, the imaginary part, and the character <code>i</code>.
At the present, they cannot be read back in, and perhaps the printed
representation will be changed.
</p>
<p>For a symbol: if slashification is off, the p.r is simply the successive
characters of the print-name of the symbol. If slashification is on,
two changes must be made.  First, the symbol might require a package prefix
in order that <code>read</code> work correctly, assuming that the package into which
<code>read</code> will read the symbol is the one in which it is being printed.
See the section on packages (<a href="#package">package</a>) for an explanation
of the package name prefix.
Secondly, if the p.r would not read in as a symbol at all (that is, if
the print-name looks like a number, or contains special characters),
then the p.r must have some quoting for those characters, either
by the use of slashes (<code>/</code>) before each special character,
or by the use of vertical bars (<code>|</code>) around the whole name.
The decision whether quoting is required is done using the readtable
(see <a href="#readtable">readtable</a>),
so it is always accurate provided that <code>readtable</code> has the same value when
the output is read back in as when it was printed.
</p>
<p>For a string: if slashification is off, the p.r is simply the
successive characters of the string.  If slashification is on, the
string is printed between double quotes and any characters inside the
string that need to be preceded by slashes will be.   Normally these
are only double-quote and slash.  Compatibly with Maclisp, carriage
return is <em>not</em> ignored inside strings and vertical bars.
</p>
<p>For an instance or an entity: if the object has a method for the
<code>:print-self</code> message, that message is sent with three arguments: the
stream to print to, the current <em>depth</em> of list structure (see below),
and whether slashification is enabled.  The object should print a
suitable p.r on the stream.  See <a href="#flavor">flavor</a> for documentation on
instances.  Most such objects print like &quot;any other data type&quot; below,
except with additional information such as a name.  Some objects print
only their name when slashification is not in effect (when
<code>princ</code>&rsquo;ed).  Some objects, including pathnames, use a printed
representation that begins with <code>#</code>, ends with <code>delta</code>, and contains
sufficient information for the reader to reconstruct an
equivalent object.  See <a href="#horseshoe_002dread">horseshoe-read</a>.
</p>
<p>For an array that is a named structure: if the array has a
named structure symbol with a <code>named-structure-invoke</code> property
that is the name of a function, then that
function is called on five arguments: the symbol <code>:print-self</code>, the
object itself, the stream to print to, the current <em>depth</em> of list
structure (see below), and whether slashification is enabled.  A
suitable printed representation should be sent to the stream.  This
allows a user to define his own p.r for his named structures;
more information can be found in the named structure section (see
<a href="#named_002dstructure">named-structure</a>).  Typically the printed representation used will
start with either <code>#&lt;</code> if it is not supposed to be readable, or with
<code>#</code> (see <a href="#horseshoe_002dread">horseshoe-read</a>) if it is supposed to be readable.
</p>
<p>If the named structure symbol does not have a
<code>named-structure-invoke</code> property, the printed-representation is like
the p.r for random data-types: a number sign and a less than sign, the
named structure symbol, the numerical address of the array, and a
greater than sign.
</p>
<p>Other arrays: the p.r starts with a number sign and
a less-than sign.  Then the &quot;<code>art-</code>&quot; symbol for the array
type is printed.  Next the dimensions of the array are printed, separated 
by hyphens.  This is followed by a space, the machine address of the
array, and a greater-than sign.
</p>
<p>Conses:  The p.r for conses tends to favor <em>lists</em>.  It
starts with an open-parenthesis.  Then the <em>car</em> of the cons is
printed and the <em>cdr</em> of the cons is examined.  If it is <code>nil</code>, a
close-parenthesis is printed.  If it is anything else but a cons, space
dot space followed by that object is printed.  If it is a cons, we
print a space and start all over (from the point <em>after</em> we printed
the open-parenthesis) using this new cons.  Thus, a list is printed as
an open-parenthesis, the p.r.&rsquo;s of its elements separated by spaces, and a
close-parenthesis.
</p>
<p>This is how the usual printed representations such as <code>(a b (foo bar) c)</code>
are produced.
</p>
<p>The following additional feature is provided for the p.r of conses:
as a list is printed, <code>print</code> maintains the length of the list so far
and the depth of recursion of printing lists.  If the length exceeds the
value of the variable <code>prinlength</code>, <code>print</code> will terminate the printed
representation of the list with an ellipsis (three periods) and a close-parenthesis.
If the depth of recursion exceeds the value of the variable <code>prinlevel</code>,
then the list will be printed as &quot;**&quot;.  These two features allow a kind of abbreviated
printing that is more concise and suppresses detail.  Of course, neither
the ellipsis nor the &quot;**&quot; can be interpreted by <code>read</code>, since the relevant information
is lost.
</p>
<a name="prinlevel_002dvar"></a><dl>
<dt><a name="index-prinlevel"></a>Variable: <strong>prinlevel</strong></dt>
<dd><p><code>prinlevel</code> can be set to the maximum number of nested
lists that can be printed before the printer will give up and just print a
&quot;**&quot;.  If it is <code>nil</code>, which it is initially, any number of nested
lists can be printed.  Otherwise, the value of <code>prinlevel</code> must be a fixnum.
</p></dd></dl>

<a name="prinlength_002dvar"></a><dl>
<dt><a name="index-prinlength"></a>Variable: <strong>prinlength</strong></dt>
<dd><p><code>prinlength</code> can be set to the maximum number of elements of a list
that will be printed before the printer will give up and print a &quot;<code>...</code>&quot;.
If it is <code>nil</code>, which it is initially, any length list may be
printed.  Otherwise, the value of <code>prinlength</code> must be a fixnum.
</p></dd></dl>

<p>For any other data type: The printed representation starts with
<code>#&lt;</code> and ends with <code>&gt;</code>.  This sort of printed representation
cannot be read back in.  The <code>#&lt;</code> is followed by the
&quot;<code>dtp-</code>&quot; symbol for this datatype, a space, and the octal machine
address of the object.  The object&rsquo;s name, if one can be determined,
often appears before the address.  If this style of printed
representation is being used for a named structure or instance, other
interesting information may appear as well.  Finally a greater-than sign
(<code>&gt;</code>) is printed.
</p>
<p>Including the machine address in the p.r makes it possible to tell two objects of this
kind apart without explicitly calling <code>eq</code> on them.  This can be very useful during
debugging.  It is important to know that if garbage collection is turned on, objects
will occasionally be moved, and therefore their octal machine addresses will be
changed.  It is best to shut off garbage collection temporarily when depending on
these numbers.
</p>
<p>Printed representations that start with &quot;<code>#&lt;</code>&quot; can never be read
back.
This can be a problem if, for example, you are printing a structure into a
file with the intent of reading it in later.  The following feature allows
you to make sure that what you are printing may indeed be read with the reader.
</p>
<a name="si_003aprint_002dreadably_002dvar"></a><dl>
<dt><a name="index-si_003aprint_002dreadably"></a>Variable: <strong>si:print-readably</strong></dt>
<dd><p>When <code>si:print-readably</code> is bound to <code>t</code>, the printer will signal an error
if there is an attempt to print an object that cannot be interpreted by <code>read</code>.
When the printer sends a <code>:print-self</code> or a <code>:print</code> message, it assumes
that this error checking is done for it.  Thus it is possible for these messages
<em>not</em> to signal an error, if they see fit.
</p></dd></dl>

<a name="si_003aprinting_002drandom_002dobject_002dfun"></a><dl>
<dt><a name="index-si_003aprinting_002drandom_002dobject"></a>Macro: <strong>si:printing-random-object</strong> <em>(object stream . keywords) &amp;body body</em></dt>
<dd><p>The vast majority of objects that define <code>:print-self</code> messages have much
in common.  This macro is provided for convenience so that users do not
have to write out that repetitious code.  It is also the preferred interface
to <code>si:print-readably</code>.  With no keywords, <code>si:printing-random-object</code>
checks the value of <code>si:print-readably</code> and signals an error if it is not
<code>nil</code>.  It then prints a number sign and a less-than sign, evaluates the
forms in <em>body</em>, then prints a space, the octal machine address
of the object and
a greater-than sign.  A typical use of this macro might look like:
</p><div class="lisp">
<pre class="lisp">(si:printing-random-object (ship stream)
  (princ (typep ship) stream)
  (tyo #\space stream)
  (prin1 (ship-name ship) stream))
</pre></div>
<p>This might print <code>#&lt;ship &quot;ralph&quot; 23655126&gt;</code>.
</p></dd></dl>

<p>The following keywords may be used to modify the behaviour of <code>si:printing-random-object</code>:
</p>
<dl compact="compact">
<dt><code>:no-pointer</code></dt>
<dd><p>This suppresses printing of the octal address of the object.
</p>
</dd>
<dt><code>:typep</code></dt>
<dd><p>This prints the result of <code>(typep <em>object</em>)</code> after the less-than sign.
In the example above, this option could have been used instead of
the first two forms in the body.
</p></dd>
</dl>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003aprint_002dnot_002dreadable"></a>Condition on sys:print-not-readable: <strong>(<code>error</code>)</strong></dt>
<dd><p>This condition is signaled by <code>si:print-readably</code> when the object
cannot be printed readably.
</p>
<p>The condition instance supports the operation <code>:object</code>, which
returns the object that was being printed.
</p></dd></dl>

<a name="customizing_002dthe_002dprinter"></a>
<p>If you want to control the printed representation of some object,
usually the right way to do it is to make the object an array that is a
named structure (see <a href="#named_002dstructure">named-structure</a>), or an instance of a flavor
(see <a href="#flavor">flavor</a>).  However, occasionally it is desirable to get control
over all printing of objects, in order to change, in some way, how they
are printed.  If you need to do this, the best way to proceed is to
customize the behavior of <code>si:print-object</code> (see
<a href="#si_003aprint_002dobject_002dfun">si:print-object-fun</a>), which is the main internal function of the
printer.  All of the printing functions, such as <code>print</code> and
<code>princ</code>, as well as <code>format</code>, go through this function.  The way to
customize it is by using the &quot;advice&quot; facility (see <a href="#advise">advise</a>).
</p>
<a name="g_t_0022What-The-Reader-Accepts_0022"></a>
<h4 class="subsection">21.2.2 &quot;What The Reader Accepts&quot;</h4>
<a name="reader"></a><a name="index-reader"></a>
<p>The purpose of the reader is to accept characters,
interpret them as the p.r of a Lisp object, and return
a corresponding Lisp object.  The reader cannot accept
everything that the printer produces; for example, the
p.r.&rsquo;s of arrays (other than strings), compiled code
objects, closures, stack groups, etc., cannot be read in.
However, it has many features that are not seen in the
printer at all, such as more flexibility, comments, and
convenient abbreviations for frequently-used unwieldy constructs.
</p>
<p>This section shows what kind of p.r.&rsquo;s the reader understands,
and explains the readtable, reader macros, and various features
provided by <code>read</code>.
</p>
<p>In general, the reader operates by recognizing tokens in the input
stream.  Tokens can be self-delimiting or can be separated by delimiters such as
whitespace.  A token is the p.r of an atomic object such as a symbol or
number, or a special character such as a parenthesis.  The reader reads one
or more tokens until the complete p.r of an object has been seen, then
constructs and returns that object.
</p>
<p>The reader understands the p.r.&rsquo;s of fixnums in a way
more general than is employed by the printer.  Here is a complete
description of the format for fixnums.
</p>
<p>Let a <em>simple fixnum</em> be a string of digits, optionally
preceded by a plus sign or a minus sign, and optionally followed by a
trailing decimal point.  A simple fixnum will be interpreted by
<code>read</code> as a fixnum.  If the trailing decimal point is present, the
digits will be interpreted in decimal radix; otherwise, they will be
considered as a number whose radix is the value of the variable
<code>ibase</code>.
</p>
<a name="ibase_002dvar"></a><dl>
<dt><a name="index-ibase"></a>Variable: <strong>ibase</strong></dt>
<dd><p>The value of <code>ibase</code> is a number that is the radix in which
fixnums are read.  The initial value of <code>ibase</code> is 8.
</p></dd></dl>

<p><code>read</code> will also understand a simple fixnum,
followed by an underscore (<code>&quot;_&quot;</code>) or a circumflex (<code>&quot;^&quot;</code>),
followed by another simple fixnum.  The two simple fixnums
will be interpreted in the usual way;
the character in between indicates an operation that will then
performed on the two fixnums.  The underscore indicates a binary
&quot;left shift&quot;; that is, the fixnum to its left is doubled the
number of times indicated by the fixnum to its right.  The circumflex
multiplies the fixnum to its left by <code>ibase</code> the number of
times indicated by the fixnum to its right.  (The second simple
fixnum is not allowed to have a leading minus sign.)  Examples:  <code>645_6</code>
means <code>64500</code> (in octal) and <code>645^3</code> means <code>645000</code>.
	Here are some examples of valid representations
of fixnums to be given to <code>read</code>:
</p><div class="lisp">
<pre class="lisp">4
23456.
-546
+45^+6
2_11
</pre></div>

<p>The syntax for bignums is identical to the syntax for fixnums.  A number
is a bignum rather than a fixnum if and only if it is too large to be represented
as a fixnum.  Here are some examples of valid representations of bignums:
</p><div class="lisp">
<pre class="lisp">72361356126536125376512375126535123712635
-123456789.
105_1000
105_1000.
</pre></div>

<a name="flonum_002dexamples"></a><p>The syntax for a flonum is an optional plus or minus sign, optionally
some digits, a decimal point, and one or more digits.  Such a flonum or
a simple fixnum, followed by an &quot;<code>e</code>&quot; (or &quot;<code>E</code>&quot;) and a simple
fixnum, is also a flonum; the fixnum after the &quot;<code>e</code>&quot; is the exponent
of 10 by which the number is to be scaled.  (The exponent is not allowed
to have a trailing decimal point.)  If the exponent is introduced by
&quot;<code>s</code>&quot; (or &quot;<code>S</code>&quot;) rather than &quot;<code>e</code>&quot;, the number is a small-flonum.
Here are some examples of printed-representations that read as flonums:
</p><div class="lisp">
<pre class="lisp">0.0
1.5
14.0
0.01
707
-.3
+3.14159
6.03e23
1E-9
1.e3
</pre></div>

<p>Here are some examples of printed-representations that read as small-flonums:
</p><div class="lisp">
<pre class="lisp">0s0
1.5s9
-42S3
1.s5
</pre></div>

<p>The syntax for a rationalnum is an integer, a backslash, and another integer.
Here are examples:
</p><div class="lisp">
<pre class="lisp">1\2
100000000000000\3
</pre></div>

<p>A string of letters, numbers, and &quot;extended alphabetic&quot;
characters is recognized by the reader as a symbol, provided
it cannot be interpreted as a number.  Alphabetic case is ignored
in symbols; lower-case letters are translated to upper-case.
When the reader sees the p.r of a symbol, it <em>interns</em> it on a <em>package</em>
(see <a href="#package">package</a>, for an explanation of interning and the package system).
Symbols may start with digits; you could even
have one named <code>-345T</code>; <code>read</code> will accept this as a symbol
without complaint.  If you want to put strange characters (such as
lower-case letters, parentheses, or reader macro characters) inside the name of a symbol,
put a slash before each strange character.  If you want to have a symbol
whose print-name looks like a number, put a slash before some character
in the name.  You can also enclose the name of a symbol in vertical bars,
which quote all characters inside them except vertical bars and slashes, which
must be quoted with slash.
</p><div class="lisp">
<pre class="lisp">Examples of symbols:
</pre><pre class="lisp">foo
bar/(baz/)
34w23
|Frob Sale|
</pre></div>

<p>The reader will also recognize strings, which should be
surrounded by double-quotes.  If you want to put a double-quote or
a slash inside a string, precede it by a slash.
</p><div class="lisp">
<pre class="lisp">Examples of strings:
</pre><pre class="lisp">&quot;This is a typical string.&quot;
&quot;That is known as a /&quot;cons cell/&quot; in Lisp.&quot;
</pre></div>

<p>When <code>read</code> sees an open-parenthesis, it knows that
the p.r of a cons is coming, and calls itself recursively to
get the elements of the cons or the list that follows.  Any of
the following are valid:
</p><div class="lisp">
<pre class="lisp">(foo . bar)
(foo bar baz)
(foo . (bar . (baz . nil)))
(foo bar . quux)
</pre></div>
<p>The first is a cons, whose car and cdr are both symbols.  The second
is a list, and the third is exactly the same as the second (although
<code>print</code> would never produce it).  The fourth is a &quot;dotted list&quot;;
the cdr of the last cons cell (the second one) is not <code>nil</code>, but
<code>quux</code>.
<a name="index-dotted-list"></a>
</p>
<p>Whenever the reader sees any of the above, it creates new cons
cells; it never returns existing list structure.  This contrasts
with the case for symbols, as very often <code>read</code> returns symbols
that it found interned in the package rather than creating new symbols
itself.  Symbols are the only thing that work this way.
</p>
<p>The dot that separates the two elements of a dotted-pair p.r
for a cons is only recognized if it is surrounded by delimiters
(typically spaces).  Thus dot may be freely used within print-names of
symbols and within numbers.  This is not compatible with Maclisp; in
Maclisp <code>(a.b)</code> reads as a cons of symbols <code>a</code> and <code>b</code>, whereas in
Zetalisp it reads as a list of a symbol <code>a.b</code>.
</p>
<p>If the circle-X (<code>&quot;circleX&quot;</code>) character is encountered, it is an octal
escape, which may be useful for including weird characters in the input.  The
next three characters are read and interpreted as an octal number, and the
character whose code is that number replaces the circle-X and the digits in the
input stream.  This character is always taken to be an alphabetic character,
just as if it had been preceded by a slash.
</p>
<a name="g_t_0022Macro-Characters_0022"></a>
<h4 class="subsection">21.2.3 &quot;Macro Characters&quot;</h4>
<a name="index-macro-character"></a>

<p>Certain characters are defined to be macro characters.  When the reader
sees one of these, it calls a function associated with the character.  This
function reads whatever syntax it likes and returns the object represented by
that syntax.  Macro characters are always token delimiters; however, they are not
recognized when quoted by slash or vertical bar, nor when inside a string.
Macro characters are a syntax-extension mechanism available to the user.  Lisp
comes with several predefined macro characters:
</p>
<p>Quote (<code>'</code>) is an abbreviation to make it easier to put
constants in programs.  <code>'<em>foo</em></code> reads the same as <code>(quote <em>foo</em>)</code>.
</p>
<p>Semicolon (<code>;</code>) is used to enter comments.  The semicolon and everything 
up through the next carriage return are ignored.  Thus a comment can be put at
the end of any line without affecting the reader.
</p>
<p>Backquote (<code>`</code>) makes it easier to write programs to construct lists and trees
by using a template.
See <a href="#backquote">backquote</a>, for details.
</p>
<p>Comma (<code>,</code>) is part of the syntax of backquote and is invalid if used other
than inside the body of a backquote.  See <a href="#backquote">backquote</a>, for details.
</p>
<p>Sharp sign (<code>#</code>) introduces a number of other syntax extensions.  See the
following section.  Unlike the preceding characters, sharp sign is not a
delimiter.  A sharp sign in the middle of a symbol is an ordinary character.
</p>
<p>The function <code>set-syntax-macro-char</code> (see <a href="#set_002dsyntax_002dmacro_002dchar_002dfun">set-syntax-macro-char-fun</a>)
can be used to define your own macro characters.
</p>

<a name="g_t_0022Sharp_002dsign-Constructs_0022"></a>
<h4 class="subsection">21.2.4 &quot;Sharp-sign Constructs&quot;</h4>
<a name="index-sharp-sign-reader-macros"></a>
<a name="index-_0023-reader-macros"></a>

<p>The reader&rsquo;s syntax includes several abbreviations introduced by sharp sign
(<code>#</code>).  These take the general form of a sharp sign, a second character
which identifies the syntax, and following arguments.  Certain abbreviations
allow a decimal number or certain special &quot;modifier&quot; characters between the
sharp sign and the second character.  Here are the currently-defined sharp
sign constructs; more are likely to be added in the future.
</p>
<dl compact="compact">
<dd><a name="sharp_002dslash"></a></dd>
<dt><code>#/</code></dt>
<dd><p><code>#/<em>x</em></code> reads in as the number which is the character code for the
character <em>x</em>.  For example, <code>#/a</code> is equivalent to <code>141</code> but clearer
in its intent.  This is the recommended way to include character constants
in your code.  Note that the slash causes this construct to be parsed correctly
by the editors, EMACS and ZWEI.
</p>
<p>As in strings, upper and lower-case letters are distinguished after <code>#/</code>.
Any character works after <code>#/</code>, even those that are normally special to
<code>read</code>, such as parentheses.  Even non-printing characters may be used,
although for them <code>#\</code> is preferred.
</p>
<p>A semi-obsolete method of specifying control bits in a character is to
insert the characters <code>alpha</code>, <code>beta</code>, <code>epsilon</code>, <code>pi</code> and <code>lambda</code> between the
<code>#</code> and the <code>/</code>.  Those stand for <code>control</code>, <code>meta</code>,
<code>control-meta</code>, <code>super</code> and <code>hyper</code>, respectively.  This syntax should
be converted to the new <code>#\control-meta-x</code> syntax described below.
</p>
</dd>
<dt><code>#\</code></dt>
<dd><p><code>#\<em>name</em></code> reads in as the number that is the character code for the
non-printing character symbolized by <em>name</em>.  A large number of character
names are recognized; these are documented below
(<a href="#xr_002dspecial_002dcharacter_002dnames">xr-special-character-names</a>).  For example, <code>#\return</code> reads in as
a fixnum, being the character code for the <code>Return</code> character in the Lisp Machine
character set.  In general, the names that are written on the
keyboard keys are accepted.  In addition, all the nonalphanumeric
characters have names.  The abbreviations <code>cr</code> for <code>return</code> and
<code>sp</code> for
<code>space</code> are accepted, since these characters are
used so frequently.  The page separator character is
called <code>page</code>, although <code>form</code> and <code>clear-screen</code> are also accepted since
the keyboard has one of those legends on the page key.  The rules for reading
<em>name</em> are the same as those for symbols; thus upper and lower-case letters
are not distinguished, and the name must be terminated by a delimiter such as a
space, a carriage return, or a parenthesis.
</p>
<p>When the system types out the name of a special character, it uses the same table
as the <code>#\</code> reader; therefore any character name typed out is acceptable as input.
</p>
<p><code>#\</code> can also be used to read in the names of characters that have
control and meta bits set.  The syntax looks like <code>#\control-meta-b</code>
to get a &quot;B&quot; character with the control and meta bits set.  You can use
any of the prefix bit names <code>control</code>, <code>meta</code>, <code>hyper</code>, and
<code>super</code>.  They may be in any order, and case is not significant.
Prefix bit names can be abbreviated as single letters, and
<code>control</code> may be spelled <code>ctrl</code> as it is on the keyboards.
The last hyphen may be followed by a single character or by any of the
special character names normally recognized by <code>#\</code>.  A
single character is treated the same way the reader normally treats
characters in symbols; if you want to use a lower-case character or a
special character such as a parenthesis, you must precede it by a slash
character.  Examples: <code>#\Hyper-Super-A</code>, <code>\meta-hyper-roman-i</code>,
<code>#\CTRL-META-/(</code>.
</p>
<p><code>greek</code> (or <code>front</code>) and <code>top</code> are also allowed as names in the
<code>#\</code> construct.  Thus, <code>#\top-g</code> is equivalent to <code>#/^K</code> or
<code>#\uparrow</code>.  <code>#\top-g</code> should be used if you are specifying the
keyboard commands of a program and the mnemonic significance belongs to
the &quot;<code>G</code>&quot; rather than to the actual character code.
</p>
</dd>
<dt><code>#^</code></dt>
<dd><p><code>#^<em>x</em></code> is exactly like <code>#\control-<em>x</em></code> if the input is being
read by Zetalisp; it generates ASCII Control-<em>x</em>.
In Maclisp <em>x</em> is converted to upper case and then exclusive-or&rsquo;ed with 100 (octal).
Thus <code>#^<em>x</em></code> always generates the character returned by <code>tyi</code> if
the user holds down the control key and types <em>x</em>.
(In Maclisp <code>#\</code><code>control-<em>x</em></code> sets the bit set by the Control key when the TTY is
open in <code>fixnum</code> mode.)
</p>
</dd>
<dt><code>#'</code></dt>
<dd><p><code>#'<em>foo</em></code> is an abbreviation for <code>(function <em>foo</em>)</code>.
<em>foo</em> is the p.r of any object.  This abbreviation can be remembered by
analogy with the <code>'</code> macro-character, since the <code>function</code> and <code>quote</code>
special forms are somewhat analogous.
</p>
</dd>
<dt><code>#,</code></dt>
<dd><p><code>#,<em>foo</em></code> evaluates <em>foo</em> (the p.r of a Lisp form) at read
time, unless the compiler is doing the reading, in which case it is arranged
that <em>foo</em> will be evaluated when the QFASL file is loaded.  This is a way,
for example, to include in your code complex list-structure constants that cannot
be written with <code>quote</code>.  Note that the reader does not put <code>quote</code>
around the result of the evaluation.  You must do this yourself if you
want it, typically by using the <code>'</code> macro-character.  An example of 
a case where you do not want <code>quote</code> around it is when this object is
an element of a constant list.
</p>
</dd>
<dt><code>#.</code></dt>
<dd><p><code>#.<em>foo</em></code> evaluates <em>foo</em> (the p.r of a lisp form) at read
time, regardless of who is doing the reading.
</p>
</dd>
<dt><code>#`</code></dt>
<dd><p><code>#`</code> is a construct for repeating an expression with some
subexpressions varying.  It is an abbreviation for writing several
similar expressions or for the use of <code>mapc</code>.  Each subexpression
that is to be varied is written as a comma followed by a list of the
things to substitute.  The expression is expanded at read time into
a <code>progn</code> containing the individual versions.
</p><div class="lisp">
<pre class="lisp">#`(send stream ',(:clear-input :clear-output))
</pre></div>
<p>expands into
</p><div class="lisp">
<pre class="lisp">(progn (send stream ':clear-input)
       (send stream ':clear-output))
</pre></div>

<p>Multiple repetitions can be done in parallel by using commas
in several subexpressions:
</p><div class="lisp">
<pre class="lisp">#`(renamef ,(&quot;foo&quot; &quot;bar&quot;) ,(&quot;ofoo&quot; &quot;obar&quot;))
</pre></div>
<p>expands into
</p><div class="lisp">
<pre class="lisp">(progn (renamef &quot;foo&quot; &quot;ofoo&quot;)
       (renamef &quot;bar&quot; &quot;obar&quot;))
</pre></div>

<p>If you want to do multiple independent repetitions, you must use nested
<code>#`</code> constructs.  Individual commas inside the inner <code>#`</code> apply to
that <code>#`</code>; they vary at maximum speed.  To specify a subexpression
that varies in the outer <code>#`</code>, use two commas.
</p><div class="lisp">
<pre class="lisp">#`#`(print (* ,(5 7) ,,(11. 13.)))
</pre></div>
<p>expands into
</p><div class="lisp">
<pre class="lisp">(progn (progn (print (* 5 11.)) (print (* 7 11.)))
       (progn (print (* 5 13.)) (print (* 7 13.)))
</pre></div>

</dd>
<dt><code>#O</code></dt>
<dd><p><code>#O <em>number</em></code> reads <em>number</em> in octal regardless of the
setting of <code>ibase</code>.  Actually, any expression can be prefixed
by <code>#O</code>; it will be read with <code>ibase</code> bound to 8.
</p>
</dd>
<dt><code>#X</code></dt>
<dd><p><code>#X <em>number</em></code> reads <em>number</em> in radix 16. (hexadecimal)
regardless of the setting of <em>ibase</em>.  As with <code>#O</code>,
any expression can be prefixed by <code>#X</code>.
</p>
<p>The letters A through F are used as the digits beyond 9, but if a number
contains one of these, it must begin with a sign in order to be properly
recognized as a number.  Thus, <code>#X+FF</code> is the same as <code>377</code>, but
<code>#XFF</code> is the symbol <code>ff</code>.
</p>
</dd>
<dt><code>#R</code></dt>
<dd><p><code>#<em>radix</em>R <em>number</em></code> reads <em>number</em> in radix <em>radix</em> regardless
of the setting of <code>ibase</code>.  As with <code>#O</code>, any expression
can be prefixed by <code>#<em>radix</em>R</code>; it will be read with <code>ibase</code>
bound to <em>radix</em>.  <em>radix</em> must consist of digits only, and
it is read in decimal.
</p>
<p>For example, <code>#3R102</code> is another way of writing <code>11</code> and
<code>#11R32</code> is another way of writing <code>35</code>.  Bases larger than ten use
the letters starting with <code>A</code> as the additional digits.
</p>
<a name="index-conditionalization_002c-read_002dtime"></a>
</dd>
<dt><code>#Q</code></dt>
<dd><p><code>#Q <em>foo</em></code> reads as <em>foo</em> if the input is being read by
Zetalisp, otherwise it reads as nothing (whitespace).
</p>
</dd>
<dt><code>#M</code></dt>
<dd><p><code>#M <em>foo</em></code> reads as <em>foo</em> if the input is being read into Maclisp,
otherwise it reads as nothing (whitespace).
</p>
</dd>
<dt><code>#N</code></dt>
<dd><p><code>#N <em>foo</em></code> reads as <em>foo</em> if the input is being read into NIL
or compiled to run in NIL, otherwise it reads as nothing (white space).
</p>
</dd>
<dt><code>#+</code></dt>
<dd><a name="sharp_002dplus"></a><p>This abbreviation provides a read-time conditionalization facility similar
to, but more general than, that provided by <code>#M</code>, <code>#N</code>, and <code>#Q</code>.  It is used
as <code>#+<em>feature</em> <em>form</em></code>.  If <em>feature</em> is a symbol, then this is
read as <em>form</em> if <code>(status feature <em>feature</em>)</code> is <code>t</code>.
If <code>(status feature <em>feature</em>)</code> is <code>nil</code>, then this is read as whitespace.
Alternately, <em>feature</em> may be a boolean expression composed of <code>and</code>, <code>or</code>, and
<code>not</code> operators and symbols representing items that may appear on the 
<code>(status features)</code> list.
<code>(or lispm amber)</code> represents evaluation of the predicate
<code>(or (status feature lispm) (status feature amber))</code>
in the read-time environment.
</p>
<p>For example, <code>#+lispm <em>form</em></code> makes <em>form</em> exist if being read by Zetalisp,
and is thus equivalent to <code>#Q <em>form</em></code>.  Similarly, <code>#+maclisp <em>form</em></code> is equivalent
to <code>#M <em>form</em></code>.  <code>#+(or lispm nil) <em>form</em></code> will make <em>form</em> exist on either
Zetalisp or in NIL.  Note that items may be added to the <code>(status features)</code>
list by means of <code>(sstatus feature <em>feature</em>)</code>, thus allowing the user to selectively
interpret or compile pieces of code by parameterizing this list.  See <a href="#sstatus_002dfun">sstatus-fun</a>.
</p>
<p>Here is a list of features with standard meanings:
</p><dl compact="compact">
<dt><code>lispm</code></dt>
<dd><p>This feature is present on any Lisp machine (no matter what version of hardware
or software).
</p>
</dd>
<dt><code>maclisp</code></dt>
<dd><p>This feature is present in Maclisp.
</p>
</dd>
<dt><code>nil</code></dt>
<dd><p>This feature is present in NIL (New Implementation of Lisp).
</p>
</dd>
<dt><code>mit</code></dt>
<dd><p>This feature is present in the MIT Lisp machine system,
which is what this manual is about.
</p>
</dd>
<dt><code>symbolics</code></dt>
<dd><p>This feature is present in the Symbolics version of the Lisp machine system.
With luck, you should have no reason to be using that.
</p>
</dd>
<dt><code>chaos</code></dt>
<dd><p>This feature is present in Lisp machine systems that use the Chaosnet
protocol for their local network (regardless of details of hardware
interfacing to the network).
</p>
</dd>
<dt><code>ether</code></dt>
<dd><p>This feature is present in Lisp machines that use the Xerox-PARC
Ethernet protocol for their local network communication.
</p></dd>
</dl>

</dd>
<dt><code>#-</code></dt>
<dd><p><code>#-<em>feature</em> <em>form</em></code> is equivalent to <code>#+(not <em>feature</em>) <em>form</em></code>.
</p>
</dd>
<dt><code>#&lt;</code></dt>
<dd><p>This is not legal reader syntax.  It is used in the p.r of objects that cannot
be read back in.  Attempting to read a <code>#&lt;</code> will cause an error.
</p>
</dd>
<dt><code>#</code></dt>
<dd><a name="horseshoe_002dread"></a><p>This is used in the p.r of miscellaneous objects (usually named
structures or instances) that can be read back in.  <code>#</code> should be
followed by a typename and any other data needed to construct an
object, terminated with a <code>delta</code>.  For example, a pathname might print as
</p><div class="lisp">
<pre class="lisp">#FS:ITS-PATHNAME &quot;AI: RMS; TEST 5&quot;delta
</pre></div>
<p>The typename is a keyword that <code>read</code> uses to figure out how to read in
the rest of the printed representation and construct the object.  It is read in in
package <code>user</code> (but it can contain a package prefix).  The resulting symbol
should either have a <code>si:read-instance</code> property or be the name of a flavor
that handles the <code>:read-instance</code> operation.
</p>
<p>In the first case, the property is applied as a function to the typename symbol
itself and the input stream.  In the second, the handler for that operation is
applied to the operation name (as always), the typename symbol, and the input
stream (three arguments, but the first is implicit and not mentioned in the
<code>defmethod</code>).  <code>self</code> will be <code>nil</code> and instance variables should
not be referred to.
</p>
<p>In either case, the handler function should read the remaining data from
the stream, and construct and return the datum it describes.  It should
return with the <code>delta</code> character waiting to be read from the input stream
(<code>:untyi</code> it if necessary).  <code>read</code> will get an error after it is returned
to if a <code>delta</code> character is not next.
</p>
<p>The typename can be any symbol with an appropriate property or flavor, not
necessarily related to the type of object that is created; but for clarity, it is good
if it is the same as the <code>typep</code> of the object printed.  Since the type symbol is
passed to the handler, one flavor&rsquo;s handler can be inherited by many other
flavors and can examine the type symbol read in to decide what flavor to
construct.
</p>
</dd>
<dt><code>#|</code></dt>
<dd><p><code>#|</code> is used to comment out entire pieces of code.
Such a comment begins with <code>#|</code> and ends with <code>|#</code>.
The text in between should be one or more properly balanced
p.r&rsquo;s of Lisp objects.  This text will be skipped over by the reader,
and will not contribute to the value returned by <code>read</code>.
</p></dd>
</dl>

<p>The function <code>set-syntax-#-macro-char</code> (see <a href="#set_002dsyntax_002d_0023_002dmacro_002dchar_002dfun">set-syntax-#-macro-char-fun</a>) can be
used to define your own sharp sign abbreviations.
</p>

<a name="Special-Character-Names"></a>
<h4 class="subsection">21.2.5 Special Character Names</h4>
<a name="xr_002dspecial_002dcharacter_002dnames"></a><a name="index-special-character"></a>

<p>The following are the recognized special character names, in alphabetical order except
with synonyms together.  These names can be used after
a <code>&quot;#\&quot;</code> to get the character code for that character.  Most of these characters
type out as this name enclosed in a lozenge.
First we list the special function keys.
</p><div class="lisp">
<pre class="lisp"><code>abort		break		call		clear-input, clear
delete		end		hand-down	hand-left
hand-right	hand-up		help		hold-output
line, lf		macro, back-next	network
overstrike, backspace, bs		page, form, clear-screen
quote		resume		return, cr		
roman-i		roman-ii		roman-iii		roman-iv
rubout		space, sp		status		stop-output
system		tab		terminal, esc</code>
</pre></div>

<p>These are printing characters that also have special names because they may be hard
to type on a PDP-10.
</p><div class="lisp">
<pre class="lisp"><code>altmode		circle-plus	delta		gamma
integral		lambda		plus-minus	uparrow
center-dot	down-arrow	alpha		beta
and-sign		not-sign		epsilon		pi
lambda		gamma		delta		up-arrow
plus-minus	circle-plus	infinity		partial-delta
left-horseshoe	right-horseshoe	up-horseshoe	down-horseshoe
universal-quantifier			existential-quantifier
circle-x		double-arrow	left-arrow		right-arrow
not-equal		altmode		less-or-equal	greater-or-equal
equivalence	or-sign</code>
</pre></div>

<p>The following are special characters sometimes used to represent single and double
mouse clicks.  The buttons can be called either <code>l</code>, <code>m</code>, <code>r</code> or
<code>1</code>, <code>2</code>, <code>3</code> depending on stylistic preference.  These characters all contain
the <code>%%kbd-mouse</code> bit.
</p><div class="lisp">
<pre class="lisp"><code>mouse-l-1=mouse-1-1		mouse-l-2=mouse-1-2
mouse-m-1=mouse-2-1		mouse-m-2=mouse-2-2
mouse-r-1=mouse-3-1		mouse-r-2=mouse-3-2</code>
</pre></div>

<a name="g_t_0022The-Readtable_0022"></a>
<h4 class="subsection">21.2.6 &quot;The Readtable&quot;</h4>
<a name="readtable"></a><a name="index-readtable"></a>

<p>There is a data structure called the <em>readtable</em> which is
used to control the reader.  It contains information about the syntax of
each character.  Initially it is set up to give the standard Lisp
meanings to all the characters, but the user can change the meanings of
characters to alter and customize the syntax of characters.  It is also
possible to have several readtables describing different syntaxes and to
switch from one to another by binding the symbol <code>readtable</code>.
</p>
<a name="readtable_002dvar"></a><dl>
<dt><a name="index-readtable-1"></a>Variable: <strong>readtable</strong></dt>
<dd><p>The value of <code>readtable</code> is the current readtable.  This starts
out as the initial standard readtable.  You can bind this variable
to change temporarily the readtable being used.
</p></dd></dl>

<a name="si_003ainitial_002dreadtable_002dvar"></a><dl>
<dt><a name="index-si_003ainitial_002dreadtable"></a>Variable: <strong>si:initial-readtable</strong></dt>
<dd><p>The value of <code>si:initial-readtable</code> is the initial standard readtable.
You should not ever change the contents of this readtable; only examine
it by using it as the <em>from-readtable</em> argument to <code>copy-readtable</code>
or <code>set-syntax-from-char</code>.
</p></dd></dl>

<p>The user can program the reader by changing the readtable in any of three ways.
The syntax of a character can be set to one of several predefined possibilities.
A character can be made into a <em>macro character</em>, whose interpretation
is controlled by a user-supplied function which is called when the character is read.
The user can create a completely new readtable, using the readtable compiler
(<code>SYS: IO; RTC LISP</code>) to define new kinds of syntax and to assign syntax classes to
characters.  Use of the readtable compiler is not documented here.
</p>
<a name="copy_002dreadtable_002dfun"></a><dl>
<dt><a name="index-copy_002dreadtable"></a>Function: <strong>copy-readtable</strong> <em>&amp;optional from-readtable to-readtable</em></dt>
<dd><p><em>from-readtable</em>, which defaults to the current readtable, is copied.
If <em>to-readtable</em> is unsupplied or <code>nil</code>, a fresh copy is made.  Otherwise
<em>to-readtable</em> is clobbered with the copy.
Use <code>copy-readtable</code> to get a private readtable before using the following
functions to change the syntax of characters in it.  The value of <code>readtable</code>
at the start of a Lisp Machine session is the initial standard readtable, which
usually should not be modified.
</p></dd></dl>

<a name="set_002dsyntax_002dfrom_002dchar_002dfun"></a><dl>
<dt><a name="index-set_002dsyntax_002dfrom_002dchar"></a>Function: <strong>set-syntax-from-char</strong> <em>to-char from-char &amp;optional to-readtable from-readtable</em></dt>
<dd><p>Makes the syntax of <em>to-char</em> in <em>to-readtable</em> be the same as the syntax of
<em>from-char</em> in <em>from-readtable</em>.  <em>to-readtable</em> defaults to the current readtable,
and <em>from-readtable</em> defaults to the initial standard readtable.
</p></dd></dl>

<a name="set_002dcharacter_002dtranslation_002dfun"></a><dl>
<dt><a name="index-set_002dcharacter_002dtranslation"></a>Function: <strong>set-character-translation</strong> <em>from-char to-char &amp;optional readtable</em></dt>
<dd><p>Changes <em>readtable</em> so that <em>from-char</em> will be translated to <em>to-char</em> upon
read-in, when <em>readtable</em> is the current readtable.
This is normally used only for translating lower case letters to upper case.
Character translations are turned off by slash, string quotes, and vertical bars.
<em>readtable</em> defaults to the current readtable.
</p></dd></dl>

<a name="set_002dsyntax_002dmacro_002dchar_002dfun"></a><dl>
<dt><a name="index-set_002dsyntax_002dmacro_002dchar"></a>Function: <strong>set-syntax-macro-char</strong> <em>char function &amp;optional readtable</em></dt>
<dd><p>Changes <em>readtable</em> so that <em>char</em> is a macro character.  When
<em>char</em> is read, <em>function</em> is called.  <em>readtable</em> defaults to the
current readtable.
</p>
<p><em>function</em> is called with two arguments, <em>list-so-far</em> and the input stream.
When a list is being read, <em>list-so-far</em> is that list (<code>nil</code> if this is the
first element).  At the &quot;top level&quot; of <code>read</code>, <em>list-so-far</em> is the symbol
<code>:toplevel</code>.  After a dotted-pair dot, <em>list-so-far</em> is the symbol <code>:after-dot</code>.
<em>function</em> may read any number of characters from the input stream and process
them however it likes.
</p>
<p><em>function</em> should return three values, called <em>thing</em>, <em>type</em>, and <em>splice-p</em>.
<em>thing</em> is the object read.  If <em>splice-p</em> is <code>nil</code>, <em>thing</em> is the result.
If <em>splice-p</em> is non-<code>nil</code>, then when reading a list <em>thing</em> replaces
the list being read&ndash;often it will be <em>list-so-far</em> with something else 
<code>nconc</code>&rsquo;ed onto the end.  At top-level and after a dot, if <em>splice-p</em> is non-<code>nil</code>
the <em>thing</em> is ignored and the macro-character does not contribute anything to
the result of <code>read</code>.
<em>type</em> is a historical artifact and is not really used; <code>nil</code> is a safe value.
Most macro character functions return just one value and let the other two
default to <code>nil</code>.
</p>
<p><em>function</em> should not have any side-effects other than on the stream and <em>list-so-far</em>.
Because of the way the rubout-handler works, <em>function</em> can be called several times
during the reading of a single expression in which the macro character only appears once.
</p>
<p><em>char</em> is given the same syntax that single-quote, backquote, and comma have
in the initial readtable (it is called <code>:macro</code> syntax).
</p></dd></dl>

<a name="set_002dsyntax_002d_0023_002dmacro_002dchar_002dfun"></a><dl>
<dt><a name="index-set_002dsyntax_002d_0023_002dmacro_002dchar"></a>Function: <strong>set-syntax-#-macro-char</strong> <em>char function &amp;optional readtable</em></dt>
<dd><p>Causes <em>function</em> to be called when <code>#<em>char</em></code> is read.
<em>readtable</em> defaults to the current readtable.
The function&rsquo;s arguments and return values are the same as for normal macro
characters, documented above.  When <em>function</em> is called, the special variable
<code>si:xr-sharp-argument</code> contains <code>nil</code> or a number that is the
number or special bits between the <code>#</code> and <em>char</em>.
</p></dd></dl>

<a name="set_002dsyntax_002dfrom_002ddescription_002dfun"></a><dl>
<dt><a name="index-set_002dsyntax_002dfrom_002ddescription"></a>Function: <strong>set-syntax-from-description</strong> <em>char description &amp;optional readtable</em></dt>
<dd><p>Sets the syntax of <em>char</em> in <em>readtable</em> to be that described by the
symbol <em>description</em>.  The following descriptions are defined in the
standard readtable:
</p><dl compact="compact">
<dt><code>si:alphabetic</code></dt>
<dd><p>An ordinary character such as <code>&quot;A&quot;</code>.
</p></dd>
<dt><code>si:break</code></dt>
<dd><p>A token separator such as <code>&quot;(&quot;</code>.  (Obviously left parenthesis has other
properties besides being a break.
</p></dd>
<dt><code>si:whitespace</code></dt>
<dd><p>A token separator that can be ignored, such as <code>&quot; &quot;</code>.
</p></dd>
<dt><code>si:single</code></dt>
<dd><a name="index-single_002dcharacter-symbol"></a>
<p>A self-delimiting single-character symbol.  The initial readtable does not
contain any of these.
</p></dd>
<dt><code>si:slash</code></dt>
<dd><p>The character quoter.  In the initial readtable this is <code>&quot;/&quot;</code>.
</p></dd>
<dt><code>si:verticalbar</code></dt>
<dd><p>The symbol print-name quoter.  In the initial readtable this is <code>&quot;|&quot;</code>.
</p></dd>
<dt><code>si:doublequote</code></dt>
<dd><p>The string quoter.  In the initial readtable this is <code>`&quot;'</code>.
</p></dd>
<dt><code>si:macro</code></dt>
<dd><p>A macro character.  Don&rsquo;t use this; use <code>set-syntax-macro-char</code>.
</p></dd>
<dt><code>si:circlecross</code></dt>
<dd><p>The octal escape for special characters.  In the initial readtable this is <code>&quot;circleX&quot;</code>.
</p></dd>
</dl>

<p>These symbols will probably be moved to the standard keyword package at some point.
<em>readtable</em> defaults to the current readtable.
</p></dd></dl>

<a name="setsyntax_002dfun"></a><dl>
<dt><a name="index-setsyntax"></a>Function: <strong>setsyntax</strong> <em>character arg2 arg3</em></dt>
<dd><p>This exists only for Maclisp compatibility.  The above functions are preferred in new
programs.  The syntax of <em>character</em> is altered in the current readtable, according
to <em>arg2</em> and <em>arg3</em>.  <em>character</em> can be a fixnum, a symbol, or a string,
i.e anything acceptable to the <code>character</code> function.
<em>arg2</em> is usually a keyword; it can be in any package since this is a Maclisp
compatibility function.  The following values are allowed for <em>arg2</em>:
</p><dl compact="compact">
<dt><code>:macro</code></dt>
<dd><p>The character becomes a macro character.  <em>arg3</em> is the name of a function to be
invoked when this character is read.  The function takes no arguments, may <code>tyi</code> or
<code>read</code> from <code>standard-input</code> (i.e may call <code>tyi</code> or <code>read</code> without
specifying a stream),
and returns an object which is taken as the result of the read.
</p>
</dd>
<dt><code>:splicing</code></dt>
<dd><p>Like <code>:macro</code> but the object returned by the macro function is a list
that is <code>nconc</code>ed into the list being read.  If the character is read
anywhere except inside a list (at top level or after a dotted-pair dot),
then it may return <code>()</code>, which means it is ignored, or <code>(<em>obj</em>)</code>,
which means that <em>obj</em> is read.
</p>
</dd>
<dt><code>:single</code></dt>
<dd><p>The character becomes a self-delimiting single-character symbol.  If <em>arg3</em> is
a fixnum, the character is translated to that character.
</p>
</dd>
<dt><code>nil</code></dt>
<dd><p>The syntax of the character is not changed, but if <em>arg3</em> is
a fixnum, the character is translated to that character.
</p>
</dd>
<dt><code><span class="roman">a symbol</span></code></dt>
<dd><p>The syntax of the character is changed to be the same as that of
the character <em>arg2</em> in the standard initial readtable.  <em>arg2</em>
is converted to a character by taking the first character of its print name.
Also if <em>arg3</em> is
a fixnum, the character is translated to that character.
</p></dd>
</dl>
</dd></dl>

<a name="setsyntax_002dsharp_002dmacro_002dfun"></a><dl>
<dt><a name="index-setsyntax_002dsharp_002dmacro"></a>Function: <strong>setsyntax-sharp-macro</strong> <em>character type function &amp;optional readtable</em></dt>
<dd><p>This exists only for Maclisp compatibility.  <code>set-syntax-#-macro-char</code> is preferred.
If <em>function</em> is <code>nil</code>, <code>#<em>character</em></code> is turned off, otherwise it
becomes a macro that calls <em>function</em>.  <em>type</em> can be <code>:macro</code>, <code>:peek-macro</code>,
<code>:splicing</code>, or <code>:peek-splicing</code>.  The splicing part controls whether <em>function</em> returns
a single object or a list of objects.  Specifying peek causes <em>character</em>
to remain in the input stream when <em>function</em> is called; this is useful if
<em>character</em> is something like a left parenthesis.  <em>function</em> gets one
argument, which is <code>nil</code> or the number between the <code>#</code> and the <em>character</em>.
</p></dd></dl>


<a name="g_t_0022Input-Functions_0022"></a>
<h3 class="section">21.3 &quot;Input Functions&quot;</h3>

<p>Most of these functions take optional arguments called <em>stream</em> and <em>eof-option</em>.
<em>stream</em> is the stream from which the input is to be read; if unsupplied it
defaults to the value of <code>standard-input</code>.  The special pseudo-streams <code>nil</code> and
<code>t</code> are also accepted, mainly for Maclisp compatibility.  <code>nil</code> means
the value of <code>standard-input</code> (i.e the default) and <code>t</code> means the
value of <code>terminal-io</code> (i.e the interactive terminal).  This is all more-or-less
compatible with Maclisp, except that instead of the variable <code>standard-input</code>
Maclisp has several variables and complicated rules.  For detailed documentation
of streams, refer to <a href="#streams">streams</a>.
</p>
<p><em>eof-option</em> controls what happens if input is from a file (or any other
input source that has a definite end) and the end of the file is reached.  If
no <em>eof-option</em> argument is supplied, an error will be signalled.  If there
is an <em>eof-option</em>, it is the value to be returned.  Note that an
<em>eof-option</em> of <code>nil</code> means to return <code>nil</code> if the end of the file is
reached; it is <em>not</em> equivalent to supplying no <em>eof-option</em>.
</p>
<p>Functions such as <code>read</code>, which read an &quot;object&quot; rather than a single
character, will always signal an error, regardless of <em>eof-option</em>, if
the file ends in the middle of an object.  For example, if a file does
not contain enough right parentheses to balance the left parentheses in
it, <code>read</code> will complain.  If a file ends in a symbol or a number
immediately followed by end-of-file, <code>read</code> will read the symbol or
number successfully and when called again will see the end-of-file and
obey <em>eof-option</em>.  If a file contains ignorable text at the end, such
as blank lines and comments, <code>read</code> will not consider it to end in the
middle of an object and will obey <em>eof-option</em>.
</p>
<p>These end-of-file conventions are not completely compatible with Maclisp.
Maclisp&rsquo;s deviations from this are generally considered to be bugs rather than features.
</p>
<p>The functions below that take <em>stream</em> and <em>eof-option</em> arguments
can also be called with the stream and eof-option in the other order.
This functionality is only for compatibility with old Maclisp programs,
and should never be used in new programs.  The functions attempt to
figure out which way they were called by seeing whether each argument is
a plausible stream.  Unfortunately, there is an ambiguity with symbols:
a symbol might be a stream and it might be an eof-option.  If there are
two arguments, one being a symbol and the other being something that is
a valid stream, or only one argument, which is a symbol, then these
functions will interpret the symbol as an eof-option instead of as a
stream.  To force them to interpret a symbol as a stream, give the
symbol an <code>si:io-stream-p</code> property whose value is <code>t</code>.
</p>
<p>Note that all of these functions will echo their input if used on an
interactive stream (one which supports the <code>:rubout-handler</code>
operation; see below.)  The functions that input more than one
character at a time (<code>read</code>, <code>readline</code>) allow the input to be
edited using rubout.  <code>tyipeek</code> echoes all of the characters that
were skipped over if <code>tyi</code> would have echoed them; the character not
removed from the stream is not echoed either.
</p>
<a name="read_002dfun"></a><dl>
<dt><a name="index-read"></a>Function: <strong>read</strong> <em>&amp;optional stream eof-option</em></dt>
<dd><p><code>read</code> reads in the printed representation of a Lisp object
from <em>stream</em>, builds a corresponding Lisp object, and returns
the object.  The details have been explained above.
(This function can take its arguments in the other order, for Maclisp
compatibility only; see the note above.)
</p></dd></dl>

<a name="read_002dpreserve_002ddelimiters_002dvar"></a><dl>
<dt><a name="index-read_002dpreserve_002ddelimiters"></a>Variable: <strong>read-preserve-delimiters</strong></dt>
<dd><p>Certain printed representations given to <code>read</code>, notably those of symbols
and numbers, require a delimiting character after them.  (Lists do not, because
the matching close-parenthesis serves to mark the end of the list.)
Normally <code>read</code> will throw away the delimiting character if it is &quot;whitespace&quot;,
but will preserve it (with a <code>:untyi</code> stream operation) if the character is
syntactically meaningful, since it may be the start of the next expression.
</p>
<p>If <code>read-preserve-delimiters</code> is bound to <code>t</code> around a call to <code>read</code>,
no delimiting characters will be thrown away, even if they are whitespace.
This may be useful for certain reader macros or special syntaxes.
</p></dd></dl>

<a name="tyi_002dfun"></a><dl>
<dt><a name="index-tyi"></a>Function: <strong>tyi</strong> <em>&amp;optional stream eof-option</em></dt>
<dd><p><code>tyi</code> inputs one character from <em>stream</em> and returns it.
The character is echoed if <em>stream</em> is interactive,
except that <code>Rubout</code> is not echoed.
The <code>Control</code>, <code>Meta</code>, etc shifts echo as &quot;<code>C-</code>&quot;, &quot;<code>M-</code>&quot;, etc.
</p>
<p>The <code>:tyi</code> stream operation is preferred over the <code>tyi</code> function for
some purposes.  Note that it does not echo.  See <a href="#general_002dstream_002dops">general-stream-ops</a>.
</p>
<p>(This function can take its arguments in the other order, for Maclisp
compatibility only; see the note above.)
</p></dd></dl>

<a name="read_002dfor_002dtop_002dlevel_002dfun"></a><dl>
<dt><a name="index-read_002dfor_002dtop_002dlevel"></a>Function: <strong>read-for-top-level</strong> <em>&amp;optional stream eof-option</em></dt>
<dd><p>This is a slightly different version of <code>read</code>.  It differs from <code>read</code>
only in that it ignores close-parentheses seen at top level,
and it returns the symbol <code>si:eof</code> if the stream reaches end-of-file
if you have not supplied an <em>eof-option</em> (instead of signalling
an error as <code>read</code> would).  This version of <code>read</code> is used in
the system&rsquo;s &quot;read-eval-print&quot; loops.
</p>
<p>(This function can take its arguments in the other order, for uniformity
with <code>read</code> only; see the note above.)
</p></dd></dl>

<a name="read_002dcheck_002dindentation_002dfun"></a><dl>
<dt><a name="index-read_002dcheck_002dindentation"></a>Function: <strong>read-check-indentation</strong> <em>&amp;optional stream eof-option</em></dt>
<dd><p>This is like <code>read</code>, but validates the input based on indentation.
It assumes that the input data is formatted to follow the usual
convention for source files, that an open-parenthesis in column zero
indicates a top-level list (with certain specific exceptions).
An open-parenthesis in column zero encountered in the middle of a list
is more likely to result from close-parentheses missing before it than
from a mistake in indentation.
</p>
<p>If <code>read-check-indentation</code> finds an open-parenthesis
following a return character in the middle of a list, it
invents enough close-parentheses to close off all pending lists, and
returns.  The offending open-parenthesis is <code>:untyi</code>&rsquo;d so it can begin
the next list, as it probably should.  End of file in the middle of a
list is handled likewise.
</p>
<p><code>read-check-indentation</code> notifies the caller of the incorrect formatting
by signaling the condition <code>sys:missing-closeparen</code>.  This
is how the compiler is able to record a warning about the missing
parentheses.  If a condition handler proceeds, <code>read</code> goes ahead
and invents close-parentheses.
</p>
<p>There are a few special forms that are customarily used around function
definitions&ndash;for example, <code>eval-when</code>, <code>local-declare</code>, and <code>comment</code>.
Since it is desirable to begin the function definitions in
column zero anyway, <code>read-check-indentation</code> allows a list to begin
in column zero within one of these special forms.  A non-<code>nil</code>
<code>si:may-surround-defun</code> property identifies the symbols for which this
is allowed.
</p></dd></dl>

<a name="read_002dcheck_002dindentation_002dvar"></a><dl>
<dt><a name="index-read_002dcheck_002dindentation-1"></a>Variable: <strong>read-check-indentation</strong></dt>
<dd><p>This variable is non-<code>nil</code> during a read in which indentation is being
checked.
</p></dd></dl>

<a name="readline_002dfun"></a><dl>
<dt><a name="index-readline"></a>Function: <strong>readline</strong> <em>&amp;optional stream eof-option options</em></dt>
<dd><p><code>readline</code> reads in a line of text, terminated by a return.  It
returns the line as a character string, <em>without</em> the return
character.  This function is usually used to get a line of input from
the user.  If rubout processing is happening, then <em>options</em> is passed
as the list of options to the rubout handler.  One option that is
particularly useful is the <code>:do-not-echo</code> option (see
<a href="#g_t_003ado_002dnot_002decho_002doption">:do-not-echo-option</a>), which you can use to suppress the echoing of the <code>return</code>
character that terminates the line.  (This function can
take its arguments in the other order, for Maclisp compatibility only;
see the note above.)
</p></dd></dl>

<a name="readline_002dtrim_002dfun"></a><dl>
<dt><a name="index-readline_002dtrim"></a>Function: <strong>readline-trim</strong> <em>&amp;optional stream eof-option options</em></dt>
<dd><p>This is like <code>readline</code> except that leading and trailing spaces and
tabs are discarded from the value before it is returned.
</p></dd></dl>

<a name="readch_002dfun"></a><dl>
<dt><a name="index-readch"></a>Function: <strong>readch</strong> <em>&amp;optional stream eof-option</em></dt>
<dd><p>This function is provided only for Maclisp compatibility, since
in the Zetalisp characters are always represented as fixnums.
<code>readch</code> is just like <code>tyi</code>, except that instead of returning
a fixnum character, it returns a symbol whose print name is the character
read in.  The symbol is interned in the current package.
<a name="index-character-object"></a>
This is just like a Maclisp &quot;character object&quot;.
(This function can take its arguments in the other order, for Maclisp
compatibility only; see the note above.)
</p></dd></dl>

<a name="tyipeek_002dfun"></a><dl>
<dt><a name="index-tyipeek"></a>Function: <strong>tyipeek</strong> <em>&amp;optional peek-type stream eof-option</em></dt>
<dd><p>This function is provided mainly for Maclisp compatibility;
the <code>:tyipeek</code> stream operation is usually clearer (see <a href="#tyipeek_002dstream_002doperation">tyipeek-stream-operation</a>).
</p>
<p>What <code>tyipeek</code> does depends on the <em>peek-type</em>, which
defaults to <code>nil</code>.  With a <em>peek-type</em> of <code>nil</code>,
<code>tyipeek</code> returns the next character to be read from 
<em>stream</em>, without actually removing it from the input stream.
The next time input is done from <em>stream</em> the character will still
be there; in general, <code>(= (tyipeek) (tyi))</code> is <code>t</code>.
</p>
<p>If <em>peek-type</em> is a fixnum less than 1000 octal, then <code>tyipeek</code>
reads characters from <em>stream</em> until it gets one equal to <em>peek-type</em>.
That character is not removed from the input stream.
</p>
<p>If <em>peek-type</em> is <code>t</code>, then <code>tyipeek</code> skips over input characters
until the start of the printed representation of a Lisp object is reached.
As above, the last character (the one that starts an object)
is not removed from the input stream.
</p>
<p>The form of <code>tyipeek</code> supported by Maclisp in which <em>peek-type</em>
is a fixnum not less than 1000 octal is not supported, since the readtable
formats of the Maclisp reader and the Zetalisp reader are quite different.
</p>
<p>Characters passed over by <code>tyipeek</code> are echoed if <em>stream</em> is interactive.
</p></dd></dl>

<a name="prompt_002dand_002dread_002dfun"></a><dl>
<dt><a name="index-prompt_002dand_002dread"></a>Function: <strong>prompt-and-read</strong> <em>type-of-parsing format-string &amp;rest format-args</em></dt>
<dd><p><code>prompt-and-read</code> reads some sort of object from <code>query-io</code>, parsing
it according to <em>type-of-parsing</em>, and prompting by calling <code>format</code>
using <em>format-string</em> and <em>format-args</em>.
</p>
<p><em>type-of-parsing</em> is either a keyword or a list starting with a
keyword and continuing with a list of options and values, whose meanings
depend on the keyword used.
</p>
<p>The keywords defined are
</p><dl compact="compact">
<dt><code>:eval-sexp</code></dt>
<dd><p>This keyword directs <code>prompt-and-read</code> to accept a Lisp
expression.  It is evaluated, and the value is returned by <code>prompt-and-read</code>.
</p>
<p>If the Lisp expression is not a constant or quoted, the user is asked to
confirm the value it evaluated to.
</p>
</dd>
<dt><code>:eval-sexp-or-end</code></dt>
<dd><p>This keyword directs <code>prompt-and-read</code> to accept a Lisp expression or
just the character <code>End</code>.  If <code>End</code> is typed, <code>prompt-and-read</code>
returns <code>nil</code> as its first value and <code>#\end</code> as its second value.
Otherwise, things proceed as for <code>:eval-sexp</code>.
</p>
</dd>
<dt><code>:read</code></dt>
<dd><p>This keyword directs <code>prompt-and-read</code> to read an object and return it, with no evaluation.
</p>
</dd>
<dt><code>:number</code></dt>
<dd><p>This keyword directs <code>prompt-and-read</code> to read and return a number.
It will insist on getting a number, forcing the user to rub out anything else.
</p>
</dd>
<dt><code>:string</code></dt>
<dd><p>This keyword directs <code>prompt-and-read</code> to read a line and return its
contents as a string, using <code>readline</code>.
</p>
</dd>
<dt><code>:string-or-nil</code></dt>
<dd><p>This keyword directs <code>prompt-and-read</code> to read a line and return its
contents as a string, using <code>readline-trim</code>.  In addition, if the
result would be empty, <code>nil</code> is returned instead of the empty string.
</p>
</dd>
<dt><code>:pathname</code></dt>
<dd><p>This keyword directs <code>prompt-and-read</code> to read a line and parse it as
a pathname, merging it with the defaults.  You can specify the defaults to use
by passing a list of the form
</p><div class="lisp">
<pre class="lisp">(:pathname :defaults <em>defaults-alist-or-pathname</em>)
</pre></div>
<p>as the <em>type-of-parsing</em> argument.
</p>
</dd>
<dt><code>:fquery</code></dt>
<dd><p>This keyword directs <code>prompt-and-read</code> to query the user for a fixed
set of alternatives, using <code>fquery</code>.  <em>type-of-parsing</em> should always
be a list, whose car is <code>:fquery</code> and whose cdr is a list to be passed
as the list of options (<code>fquery</code>&rsquo;s first argument).
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(prompt-and-read `(:fquery 
		   . ,format:y-or-p-options)
                 &quot;Eat it? &quot;)
</pre><pre class="lisp">is equivalent to
</pre><pre class="lisp">(y-or-n-p &quot;Eat it? &quot;)
</pre></div>

<p>This keyword is most useful as a way to get to <code>fquery</code> when going
through an interface defined to call <code>prompt-and-read</code>.
</p></dd>
</dl>
</dd></dl>

<p>The following functions are related functions which do not operate on streams.
Most of the text at the beginning of this section does not apply to them.
</p>
<a name="read_002dfrom_002dstring_002dfun"></a><dl>
<dt><a name="index-read_002dfrom_002dstring"></a>Function: <strong>read-from-string</strong> <em>string &amp;optional eof-option (start 0) end</em></dt>
<dd><p>The characters of <em>string</em> are given successively
to the reader, and the Lisp object built by the reader is returned.
Macro characters and so on will all take effect.  If <em>string</em>
has a fill-pointer it controls how much can be read.
</p>
<p><em>eof-option</em> is what to return if the end of the string is reached, as
with other reading functions.  <em>start</em> is the index in the string of
the first character to be read.  <em>end</em> is the index at which to stop
reading; that point is treated as end of file.
</p>
<p><code>read-from-string</code> returns two values; the first is the object read
and the second is the index of the first character in the string not read.
If the entire string was read, this will be either the length of the string
or 1 more than the length of the string.
</p>
<div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(read-from-string &quot;(a b c)&quot;) =&gt; (a b c) <span class="roman">and</span> 7
</pre></div>
</dd></dl>

<a name="readlist_002dfun"></a><dl>
<dt><a name="index-readlist"></a>Function: <strong>readlist</strong> <em>char-list</em></dt>
<dd><p>This function is provided mainly for Maclisp compatibility.
<em>char-list</em> is a list of characters.  The characters may
be represented by anything that the function <code>character</code> accepts:
fixnums, strings, or symbols.  The characters are given successively
to the reader, and the Lisp object built by the reader is returned.
Macro characters and so on will all take effect.
</p>
<p>If there are more characters in <em>char-list</em> beyond those needed to
define an object, the extra characters are ignored.  If there are not
enough characters, an &quot;eof in middle of object&quot; error is signalled.
</p></dd></dl>

<p>See also the <code>with-input-from-string</code> special form (<a href="#with_002dinput_002dfrom_002dstring_002dfun">with-input-from-string-fun</a>).
</p>
<dl>
<dt><a name="index-_0028error_0029-on-sys_003aread_002derror"></a>Condition on sys:read-error: <strong>(<code>error</code>)</strong></dt>
<dd><p>This condition name classifies all errors detected by the reader per se.
</p></dd></dl>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003aend_002dof_002dfile"></a>Condition on sys:end-of-file: <strong>(<code>error</code>)</strong></dt>
<dd><p>All errors signaled to report end of file possess this condition name.
</p>
<p>The <code>:stream</code> operation on the condition instance returns the stream
on which end of file was reached.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003aread_002derror-sys_003aend_002dof_002dfile-error_0029-on-sys_003aread_002dend_002dof_002dfile"></a>Condition on sys:read-end-of-file: <strong>(<code>sys:read-error</code> <code>sys:end-of-file</code> <code>error</code>)</strong></dt>
<dd><p>Whenever <code>read</code> signals an error for end of file, the condition object
possesses this condition name.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003aread_002dend_002dof_002dfile-sys_003aread_002derror-sys_003aend_002dof_002dfile-error_0029-on-sys_003aread_002dlist_002dend_002dof_002dfile"></a>Condition on sys:read-list-end-of-file: <strong>(<code>sys:read-end-of-file</code> <code>sys:read-error</code> <code>sys:end-of-file</code> <code>error</code>)</strong></dt>
<dd><p>This condition is signaled when <code>read</code> detects end of file in the middle of a list.
</p>
<p>In addition to the <code>:stream</code> operation provided because
<code>sys:end-of-file</code> is one of the proceed types, the condition instance
supports the <code>:list</code> operation, which returns the list read so far.
</p>
<p>Proceed type <code>:no-action</code> is provided.  If it is used, the reader
invents a close-parenthesis to close off the list.
Within <code>read-check-indentation</code>, the reader signals the error only once,
no matter how many levels of list are unterminated.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003aread_002dend_002dof_002dfile-sys_003aread_002derror-sys_003aend_002dof_002dfile-error_0029-on-sys_003aread_002dstring_002dend_002dof_002dfile"></a>Condition on sys:read-string-end-of-file: <strong>(<code>sys:read-end-of-file</code> <code>sys:read-error</code> <code>sys:end-of-file</code> <code>error</code>)</strong></dt>
<dd><p>This is signaled when <code>read</code> detects end of file in the middle of a
string delimited by doublequotes.
</p>
<p>The <code>:string</code> operation on the condition instance returns the string
read so far.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003aread_002dend_002dof_002dfile-sys_003aread_002derror-sys_003aend_002dof_002dfile-error_0029-on-sys_003aread_002dsymbol_002dend_002dof_002dfile"></a>Condition on sys:read-symbol-end-of-file: <strong>(<code>sys:read-end-of-file</code> <code>sys:read-error</code> <code>sys:end-of-file</code> <code>error</code>)</strong></dt>
<dd><p>This is signaled when <code>read</code> detects end of file in the middle of a
symbol delimited by vertical bars.
</p>
<p>The <code>:string</code> operation on the condition instance returns the print
name read so far.
</p></dd></dl>

<dl>
<dt><a name="index-_0028condition_0029-on-sys_003amissing_002dcloseparen"></a>Condition on sys:missing-closeparen: <strong>(<code>condition</code>)</strong></dt>
<dd><p>This condition, which is not an error, is signaled when
<code>read-check-indentation</code> finds an open-parenthesis in column zero
within a list.
</p>
<p>Proceed type <code>:no-action</code> is provided.  On proceeding, the reader
invents enough close-parentheses to close off all the lists that are
pending.
</p></dd></dl>

<a name="g_t_0022Output-Functions_0022"></a>
<h3 class="section">21.4 &quot;Output Functions&quot;</h3>

<p>These functions all take an optional argument called <em>stream</em>, which is
where to send the output.  If unsupplied <em>stream</em> defaults to the value of
<code>standard-output</code>.  If <em>stream</em> is <code>nil</code>, the value of
<code>standard-output</code> (i.e the default) is used.  If it is <code>t</code>, the value of
<code>terminal-io</code> is used (i.e the interactive terminal).  If <em>stream</em> is a
list of streams, then the output is performed to all of the streams (this is
not implemented yet, and an error is signalled in this case).  This is all
more-or-less compatible with Maclisp, except that instead of the
variable <code>standard-output</code> Maclisp has several variables and complicated rules.
For detailed documentation of streams, refer to <a href="#streams">streams</a>.
</p>
<a name="prin1_002dfun"></a><dl>
<dt><a name="index-prin1"></a>Function: <strong>prin1</strong> <em>x &amp;optional stream</em></dt>
<dd><p><code>prin1</code> outputs the printed representation of <em>x</em> to
<em>stream</em>, with slashification (see <a href="#slashification">slashification</a>).
<em>x</em> is returned.
</p></dd></dl>

<a name="prin1_002dthen_002dspace_002dfun"></a><dl>
<dt><a name="index-prin1_002dthen_002dspace"></a>Function: <strong>prin1-then-space</strong> <em>x &amp;optional stream</em></dt>
<dd><p><code>prin1-then-space</code> is like <code>prin1</code> except that output
is followed by a space.
</p></dd></dl>

<a name="print_002dfun"></a><dl>
<dt><a name="index-print"></a>Function: <strong>print</strong> <em>x &amp;optional stream</em></dt>
<dd><p><code>print</code> is just like <code>prin1</code> except that output
is preceded by a carriage return and followed by a space.
<em>x</em> is returned.
</p></dd></dl>

<a name="princ_002dfun"></a><dl>
<dt><a name="index-princ"></a>Function: <strong>princ</strong> <em>x &amp;optional stream</em></dt>
<dd><p><code>princ</code> is just like <code>prin1</code> except that the
output is not slashified.
<em>x</em> is returned.
</p></dd></dl>

<a name="tyo_002dfun"></a><dl>
<dt><a name="index-tyo"></a>Function: <strong>tyo</strong> <em>char &amp;optional stream</em></dt>
<dd><p><code>tyo</code> outputs the character <em>char</em> to <em>stream</em>.
</p></dd></dl>

<a name="terpri_002dfun"></a><dl>
<dt><a name="index-terpri"></a>Function: <strong>terpri</strong> <em>&amp;optional stream</em></dt>
<dd><p><code>terpri</code> outputs a carriage return character to <code>stream</code>.
</p></dd></dl>

<p>The <code>format</code> function (see <a href="#format_002dfun">format-fun</a>) is very useful for producing
nicely formatted text.  It can do anything any of the above functions
can do, and it makes it easy to produce good looking messages and such.
<code>format</code> can generate a string or output to a stream.
</p>
<p>The <code>grindef</code> function (see <a href="#grindef_002dfun">grindef-fun</a>) is useful for formatting Lisp programs.
</p>
<p>See also the <code>with-output-to-string</code> special form (<a href="#with_002doutput_002dto_002dstring_002dfun">with-output-to-string-fun</a>).
</p>
<a name="stream_002dcopy_002duntil_002deof_002dfun"></a><dl>
<dt><a name="index-stream_002dcopy_002duntil_002deof"></a>Function: <strong>stream-copy-until-eof</strong> <em>from-stream to-stream &amp;optional leader-size</em></dt>
<dd><p><code>stream-copy-until-eof</code> inputs characters from <em>from-stream</em>
and outputs them to <em>to-stream</em>, until it reaches the end-of-file
on the <em>from-stream</em>.  For example, if <code>x</code> is bound to a stream
for a file opened for input, then <code>(stream-copy-until-eof x terminal-io)</code>
will print the file on the console.
</p>
<p>If <em>from-stream</em> supports the <code>:line-in</code> operation and <em>to-stream</em> 
supports the <code>:line-out</code> operation, then <code>stream-copy-until-eof</code> will
use those operations instead of <code>:tyi</code> and <code>:tyo</code>, for greater
efficiency.  <em>leader-size</em>  will be passed as the argument to the
<code>:line-in</code> operation.
</p></dd></dl>

<a name="beep_002dfun"></a><dl>
<dt><a name="index-beep"></a>Function: <strong>beep</strong> <em>&amp;optional beep-type (stream <code>terminal-io</code>)</em></dt>
<dd><p>This function is intended to attract the user&rsquo;s attention by causing
an audible beep, or flashing the screen, or something similar.  If
the stream supports the <code>:beep</code> operation, then this function sends
it a <code>:beep</code> message, passing <em>type</em> along as an argument.  Otherwise
it just causes an audible beep on the terminal.
<em>type</em> is a keyword selecting among several different beeping noises.
The allowed types have not yet been defined; <em>type</em> is currently ignored
and should always be <code>nil</code>.  (The <code>:beep</code> operation is described
on <a href="#streams_002dbeep_002dmethod">streams-beep-method</a>.)
</p></dd></dl>

<a name="cursorpos_002dfun"></a><dl>
<dt><a name="index-cursorpos"></a>Function: <strong>cursorpos</strong> <em>&amp;rest args</em></dt>
<dd><p>This function exists primarily for Maclisp compatibility.  Usually it is
preferable to send the appropriate messages (see the window system
documentation).
</p>
<p><code>cursorpos</code> normally operates on the <code>standard-output</code> stream;
however, if the last argument is a stream or <code>t</code> (meaning <code>terminal-io</code>)
then <code>cursorpos</code> uses that stream and ignores it when doing the operations
described below.  Note that <code>cursorpos</code> only works on streams
that are capable of these operations, for instance windows.
A stream is taken to be any argument that is not a number and not a symbol,
or that is a symbol other than <code>nil</code> with a name more than one character long.
</p>
<p><code>(cursorpos) =&gt; (<em>line</em>  <em>column</em>)</code>, the current
cursor position.
</p>
<p><code>(cursorpos <em>line</em> <em>column</em>)</code> moves the cursor to that position.
It returns <code>t</code> if it succeeds and <code>nil</code> if it doesn&rsquo;t.
</p>
<p><code>(cursorpos <em>op</em>)</code> performs a special operation coded by <em>op</em>,
and returns <code>t</code> if it succeeds and <code>nil</code> if it doesn&rsquo;t.
<em>op</em> is tested by string comparison, it is not a keyword symbol
and may be in any package.
</p><dl compact="compact">
<dt><code>F</code></dt>
<dd><p>Moves one space to the right.
</p></dd>
<dt><code>B</code></dt>
<dd><p>Moves one space to the left.
</p></dd>
<dt><code>D</code></dt>
<dd><p>Moves one line down.
</p></dd>
<dt><code>U</code></dt>
<dd><p>Moves one line up.
</p></dd>
<dt><code>T</code></dt>
<dd><p>Homes up (moves to the top left corner).  Note that <code>t</code> as the last
argument to <code>cursorpos</code> is interpreted as a stream, so a stream <em>must</em>
be specified if the <code>T</code> operation is used.
</p></dd>
<dt><code>Z</code></dt>
<dd><p>Home down (moves to the bottom left corner).
</p></dd>
<dt><code>A</code></dt>
<dd><p>Advances to a fresh line.  See the <code>:fresh-line</code> stream operation.
</p></dd>
<dt><code>C</code></dt>
<dd><p>Clears the window.
</p></dd>
<dt><code>E</code></dt>
<dd><p>Clear from the cursor to the end of the window.
</p></dd>
<dt><code>L</code></dt>
<dd><p>Clear from the cursor to the end of the line.
</p></dd>
<dt><code>K</code></dt>
<dd><p>Clear the character position at the cursor.
</p></dd>
<dt><code>X</code></dt>
<dd><p><code>B</code> then <code>K</code>.
</p></dd>
</dl>
</dd></dl>

<a name="exploden_002dfun"></a><dl>
<dt><a name="index-exploden"></a>Function: <strong>exploden</strong> <em>x</em></dt>
<dd><p><code>exploden</code> returns a list of characters (as fixnums) that
are the characters that would be typed out by <code>(princ <em>x</em>)</code>
(i.e the unslashified printed representation of <em>x</em>).
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(exploden '(+ /12 3)) =&gt; (50 53 40 61 62 40 63 51)
</pre></div>
</dd></dl>

<a name="explodec_002dfun"></a><dl>
<dt><a name="index-explodec"></a>Function: <strong>explodec</strong> <em>x</em></dt>
<dd><p><code>explodec</code> returns a list of characters represented by symbols
that are the characters that would be typed out by 
<code>(princ <em>x</em>)</code> (i.e the unslashified printed representation of <em>x</em>).
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(explodec '(+ /12 3)) =&gt; ( /( + /  /1 /2 /  /3 /) )
</pre></div>
<p>(Note that there are slashified spaces in the above list.)
</p></dd></dl>

<a name="explode_002dfun"></a><dl>
<dt><a name="index-explode"></a>Function: <strong>explode</strong> <em>x</em></dt>
<dd><p><code>explode</code> returns a list of characters represented by symbols
that are the characters that would be typed out by 
<code>(prin1 <em>x</em>)</code> (i.e the slashified printed representation of <em>x</em>).
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(explode '(+ /12 3)) =&gt; ( /( + /  // /1 /2 /  /3 /) )
</pre></div>
<p>(Note that there are slashified spaces in the above list.)
</p></dd></dl>

<a name="flatsize_002dfun"></a><dl>
<dt><a name="index-flatsize"></a>Function: <strong>flatsize</strong> <em>x</em></dt>
<dd><p><code>flatsize</code> returns the number of characters in the slashified printed representation
of <em>x</em>.
</p></dd></dl>

<a name="flatc_002dfun"></a><dl>
<dt><a name="index-flatc"></a>Function: <strong>flatc</strong> <em>x</em></dt>
<dd><p><code>flatc</code> returns the number of characters in the unslashified printed representation
of <em>x</em>.
</p></dd></dl>


<a name="g_t_0022I_002fO-Streams_0022"></a>
<h3 class="section">21.5 &quot;I/O Streams&quot;</h3>
<a name="streams"></a><a name="index-stream"></a>
<a name="index-I_002fO-stream"></a>

<p>Many programs accept input characters and produce output characters.
The method for performing input and output to one device is very different
from the method for some other device.  We would like our programs to be able
to use any device available, but without each program having to know about
each device.
</p>
<p>Zetalisp makes this possible with <em>i/o streams</em>.  A stream is a source
and/or sink of characters or bytes.  A set of <em>operations</em> is
available with every stream; operations include things like &quot;output a
character&quot; and &quot;input a character&quot;.  The way to perform an operation to
a stream is the same for all streams, although what happens inside the
stream is very different depending on what kind of a stream it is.  So
all a program has to know is how to deal with streams using the
standard, generic operations.  A programmer creating a new kind of stream
only needs to implement the appropriate standard operations.
</p>
<p>A stream is a message-receiving object.  This means that it is
something that you can apply to arguments.  The first argument is a
keyword symbol which is the name of the operation you wish to perform.
The rest of the arguments depend on what operation you are doing.
Message-passing and generic operations are explained in the flavor
chapter (<a href="#flavor">flavor</a>).
</p>
<p>Some streams can only do input, some can only do output, and some can
do both.  Some operations are only supported by some streams.  Also,
there are some operations that the stream may not support by itself,
but will work anyway, albeit slowly, because the &quot;stream default handler&quot; can handle
them.  If you have a stream, there is an operation called
<code>:which-operations</code> that will return a list of the names of all of
the operations that are supported &quot;natively&quot; by the stream.  <em>All</em>
streams support <code>:which-operations</code>, and so it may not be in the list
itself.
</p>
<p>All input streams support all the standard input operations, and all
output streams support all the standard output operations.  All
bidirectional streams support both.
</p>
<a name="g_t_0022Standard-Input-Stream-Operations_0022"></a>
<h4 class="subsection">21.5.1 &quot;Standard Input Stream Operations&quot;</h4>
<a name="general_002dstream_002dops"></a>
<dl>
<dt><a name="index-_003atyi-on-streams"></a>Meta Method on streams: <strong>:tyi</strong> <em>&amp;optional eof</em></dt>
<dd><p>The stream will input one character and return it.  For example, if the next
character to be read in by the stream is a &quot;C&quot;, then the form
</p><div class="lisp">
<pre class="lisp">(funcall s ':tyi)
</pre></div>
<p>will return the value of <code>#/C</code> (that is, 103 octal).
Note that the <code>:tyi</code> operation will not
&quot;echo&quot; the character in any fashion; it just does the input.  The
<code>tyi</code> function (see <a href="#tyi_002dfun">tyi-fun</a>) will do echoing
when reading from the terminal.
</p>
<p>The optional <em>eof</em> argument to the <code>:tyi</code>
message tells the stream what to do if it gets to the end of the
file.  If the argument is not provided or is <code>nil</code>, the stream will
return <code>nil</code> at the end of file.  Otherwise it will signal an error,
and print out the argument as the error message.
Note that this is <em>not</em> the same as the eof-option argument to
<code>read</code>, <code>tyi</code>, and related functions.
</p>
<p>The <code>:tyi</code> operation on a binary input stream will return a non-negative
number, not necessarily to be interpreted as a character.
</p></dd></dl>

<a name="tyipeek_002dstream_002doperation"></a><dl>
<dt><a name="index-_003atyipeek-on-streams"></a>Meta Method on streams: <strong>:tyipeek</strong> <em>&amp;optional eof</em></dt>
<dd><p>Peeks at the next character or byte from the stream without discarding
it.  The next <code>:tyi</code> or <code>:tyipeek</code> operation will get the same
character.
</p>
<p><em>eof</em> is the same as in the <code>:tyi</code> operation: if <code>nil</code>, end of
file returns <code>nil</code>; otherwise, end of file is an error and <em>eof</em> is
used as the error message.
</p></dd></dl>

<dl>
<dt><a name="index-_003auntyi-on-streams"></a>Meta Method on streams: <strong>:untyi</strong> <em>char</em></dt>
<dd><p>Unread the character or byte <em>char</em>; that is to say, put it back into
the input stream so that the next <code>:tyi</code> operation will read it again.
For example,
</p><div class="lisp">
<pre class="lisp">(funcall s ':untyi 120)
(funcall s ':tyi) ==&gt; 120
</pre></div>
<p>This operation is used by <code>read</code>, and any stream that supports <code>:tyi</code>
must support <code>:untyi</code> as well.
</p>
<p>You are only allowed to <code>:untyi</code> one character before doing a
<code>:tyi</code>, and the character you <code>:untyi</code> must be the last character
read from the stream.  That is, <code>:untyi</code> can only be used to &quot;back up&quot;
one character, not to stuff arbitrary data into the stream.  You also
can&rsquo;t <code>:untyi</code> after you have peeked ahead with <code>:tyipeek</code> since
that does one <code>:untyi</code> itself.  Some streams implement <code>:untyi</code> by
saving the character, while others implement it by backing up the
pointer to a buffer.
</p></dd></dl>

<dl>
<dt><a name="index-_003astring_002din-on-streams"></a>Meta Method on streams: <strong>:string-in</strong> <em>eof-option string &amp;optional (start 0) end</em></dt>
<dd><p>Reads characters from the stream and stores them into the array <em>string</em>.
Many streams can implement this far more efficiently that repeated
<code>:tyi</code>&rsquo;s.
<em>start</em> and <em>end</em>, if supplied, delimit the portion of <em>string</em> to
be stored into.  <em>eof-option</em> if non-<code>nil</code> is an error message and
an error is signalled if end-of-file is reached on the stream before the
string has been filled.  If <em>eof-option</em> is <code>nil</code>, any number of characters
before end-of-file is acceptable, even no characters.
</p>
<p>If <em>string</em> has an array-leader, the fill pointer is adjusted to <em>start</em> plus
the number of characters stored into <em>string</em>.
</p>
<p>Two values are returned: the index of the next position in <em>string</em> to be filled,
and a flag that is non-<code>nil</code> if end-of-file was reached before <em>string</em> was
filled.  Most callers will not need to look at either of these values.
</p>
<p><em>string</em> may be any kind of array, not necessarily a string; this is useful
when reading from a binary input stream.
</p></dd></dl>

<dl>
<dt><a name="index-_003aline_002din-on-streams"></a>Meta Method on streams: <strong>:line-in</strong> <em>&amp;optional leader</em></dt>
<dd><p>The stream should input one line from the input source, and return it as a
string with the carriage return character stripped off.  Contrary to what you
might assume from its name, this operation is not much like the <code>readline</code> function.
</p>
<p>Many streams have a string that is used as a buffer for lines.  If this string
itself were returned, there would be problems caused if the caller of the stream
attempted to save the string away somewhere, because the contents of the string
would change when the next line was read in.  In order to solve this problem,
the string must be copied. On the other hand, some streams don&rsquo;t reuse the
string, and it would be wasteful to copy it on every <code>:line-in</code> operation.
This problem is solved by using the <em>leader</em> argument to <code>:line-in</code>.  If
<em>leader</em> is <code>nil</code> (the default), the stream will not bother to copy the
string and the caller should not rely on the contents of that string after the
next operation on the stream.  If <em>leader</em> is <code>t</code>, the stream will make a
copy.  If <em>leader</em> is a fixnum then the stream will make a copy with an array
leader <em>leader</em> elements long.  (This is used by the editor, which represents
lines of buffers as strings with additional information in their array-leaders,
to eliminate an extra copy operation.)
</p>
<p>If the stream reaches the end-of-file while reading in characters, it will
return the characters it has read in as a string and return a second value of
<code>t</code>.  The caller of the stream should therefore arrange to receive the second
value, and check it to see whether the string returned was a whole line or just
the trailing characters after the last carriage return in the input source.
</p>
<p>This message should be implemented by all input streams whose data are
characters.
</p></dd></dl>

<dl>
<dt><a name="index-_003aread_002duntil_002deof-on-streams"></a>Meta Method on streams: <strong>:read-until-eof</strong></dt>
<dd><p>Discard all data from the stream until it is at end of file,
or do anything else with the same result.
</p></dd></dl>

<dl>
<dt><a name="index-_003aclose-on-streams"></a>Meta Method on streams: <strong>:close</strong> <em>&amp;optional ignore</em></dt>
<dd><p>Release resources associated with the string, when it is not going to be
used any more.  On some kinds of streams, this may do nothing.
On chaosnet streams, it closes the chaosnet connection, and
on file streams, it closes the input file on the file server.
</p>
<p>The argument is accepted for compatibility with <code>:close</code> on output streams.
</p></dd></dl>

<a name="g_t_0022Standard-Output-Stream-Operations_0022"></a>
<h4 class="subsection">21.5.2 &quot;Standard Output Stream Operations&quot;</h4>

<dl>
<dt><a name="index-_003atyo-on-streams"></a>Meta Method on streams: <strong>:tyo</strong> <em>char</em></dt>
<dd><p>The stream will output the character <em>char</em>.  For example, if <code>s</code> is bound
to a stream, then the form
</p><div class="lisp">
<pre class="lisp">(funcall s ':tyo #/B)
</pre></div>
<p>will output a <code>B</code> to the stream.  For binary output streams, the argument
is a non-negative number rather than specifically a character.
</p></dd></dl>

<dl>
<dt><a name="index-_003afresh_002dline-on-streams"></a>Meta Method on streams: <strong>:fresh-line</strong></dt>
<dd><p>This tells the stream that it should position itself at the beginning of
a new line.  If the stream is already at the beginning of a fresh line
it should do nothing; otherwise it should output a carriage return.  If
the stream cannot tell whether it is at the beginning of a line, it should
always output a carriage return.
</p></dd></dl>

<dl>
<dt><a name="index-_003astring_002dout-on-streams"></a>Meta Method on streams: <strong>:string-out</strong> <em>string &amp;optional start end</em></dt>
<dd><p>The characters of the string are successively output to the stream.  This
operation is provided for two reasons; first, it saves the writing of a loop
which is used very often, and second, many streams can perform this operation
much more efficiently than the equivalent sequence of <code>:tyo</code> operations.
</p>
<p>If <em>start</em> and <em>end</em> are not supplied, the whole string is output.
Otherwise a substring is output; <em>start</em> is the index of the first character
to be output (defaulting to <code>0</code>), and <em>end</em> is one greater than the index of
the last character to be output (defaulting to the length of the string).  Callers
need not pass these arguments, but all streams that handle <code>:string-out</code> must
check for them and interpret them appropriately.
</p></dd></dl>

<dl>
<dt><a name="index-_003aline_002dout-on-streams"></a>Meta Method on streams: <strong>:line-out</strong> <em>string &amp;optional start end</em></dt>
<dd><p>The characters of the string, followed by a carriage return character, are
output to the stream.  <em>start</em> and <em>end</em> optionally specify a substring,  as
with <code>:string-out</code>.  If the stream doesn&rsquo;t support <code>:line-out</code> itself, the
default handler will turn it into a bunch of <code>:tyo</code>s.
</p>
<p>This message should be implemented by all output streams whose data are
characters.
</p></dd></dl>

<a name="close_002dmessage"></a><dl>
<dt><a name="index-_003aclose-on-streams-1"></a>Meta Method on streams: <strong>:close</strong> <em>&amp;optional mode</em></dt>
<dd><p>The stream is &quot;closed&quot; and no further output operations should be performed on it.
However, it is all right to <code>:close</code> a closed stream.
</p>
<p>This operation does nothing on streams for which it is not meaningful.
</p>
<p>The <em>mode</em> argument is normally not supplied.  If it is <code>:abort</code>, we are
abnormally exiting from the use of this stream.  If the stream is outputting to
a file, and has not been closed already, the stream&rsquo;s newly-created file will be
deleted; it will be as if it was never opened in the first place.  Any previously
existing file with the same name will remain undisturbed.
</p></dd></dl>

<dl>
<dt><a name="index-_003aeof-on-streams"></a>Meta Method on streams: <strong>:eof</strong></dt>
<dd><p>Indicates the end of data on an output stream.  This is different from <code>:close</code>
because some devices allow multiple data files to be transmitted without closing.
<code>:close</code> implies <code>:eof</code> when the stream is an output stream and the close
mode is not <code>:abort</code>.
</p>
<p>This operation does nothing on streams for which it is not meaningful.
</p></dd></dl>

<a name="g_t_0022Asking-Streams-What-They-Can-Do_0022"></a>
<h4 class="subsection">21.5.3 &quot;Asking Streams What They Can Do&quot;</h4>

<p>All streams are supposed to support certain operations which enable a
program using the stream to ask which operations are available.
</p>
<dl>
<dt><a name="index-_003awhich_002doperations-on-streams"></a>Meta Method on streams: <strong>:which-operations</strong></dt>
<dd><p>This returns a list of operations handled &quot;natively&quot; by the stream.
Certain operations not in the list may work anyway, but slowly, so it is
just as well that any programs that work with or without them will
choose not to use them.
</p>
<p>Also, <code>:which-operations</code> is by convention not included in the list.
</p></dd></dl>

<dl>
<dt><a name="index-_003aoperation_002dhandled_002dp-on-streams"></a>Meta Method on streams: <strong>:operation-handled-p</strong> <em>operation</em></dt>
<dd><p>This returns <code>t</code> if <em>operation</em> is handled &quot;natively&quot; by the stream:
if <em>operation</em> is a member of the <code>:which-operations</code> list, or is
<code>:which-operations</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003asend_002dif_002dhandles-on-streams"></a>Meta Method on streams: <strong>:send-if-handles</strong> <em>operation &amp;rest arguments</em></dt>
<dd><p>This performs the operation <em>operation</em>, with the specified <em>arguments</em>,
only if the stream can handle it.  If <em>operation</em> is handled, this
is the same as sending an <em>operation</em> message directly, but if <em>operation</em>
is not handled, using <code>:send-if-handles</code> avoids any error.
</p>
<p>If <em>operation</em> is handled, <code>:send-if-handles</code> returns whatever values
the execution of the <em>operation</em> returns.  If <em>operation</em> is not handled,
<code>:send-if-handles</code> returns <code>nil</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003adirection-on-streams"></a>Meta Method on streams: <strong>:direction</strong></dt>
<dd><p>This operation returns <code>:input</code>, <code>:output</code>, or <code>:bidirectional</code>
for a bidirectional stream.
</p>
<p>There are a few kinds of streams, which cannot do either input or
output, for which the <code>:direction</code> operation returns <code>nil</code>.  For
example, <code>open</code> with the <code>:direction</code> keyword specified as <code>nil</code>
returns a stream-like object which cannot do input or output but can
handle certain file inquiry operations such as <code>:truename</code> and
<code>:creation-date</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003acharacters-on-streams"></a>Meta Method on streams: <strong>:characters</strong></dt>
<dd><p>This operation returns <code>t</code> if the data input or output on the stream
are characters, or <code>nil</code> if they are just numbers (as for a stream
reading a non-text file).
</p></dd></dl>

<a name="g_t_0022Operations-for-Interactive-Streams_0022"></a>
<h4 class="subsection">21.5.4 &quot;Operations for Interactive Streams&quot;</h4>

<p>The operations <code>:listen</code>, <code>:tyi-no-hang</code>, <code>:rubout-handler</code> and
<code>:beep</code> are intended for interactive streams, which communicate with
the user.  <code>:listen</code> and <code>:tyi-no-hang</code> are supported in a trivial
fashion by other streams, for compatibility.
</p>
<a name="g_t_003alisten_002dstream_002doperation"></a><dl>
<dt><a name="index-_003alisten-on-streams"></a>Meta Method on streams: <strong>:listen</strong></dt>
<dd><p>On an interactive device, the <code>:listen</code> operation returns non-<code>nil</code> if
there are any input characters immediately available, or <code>nil</code> if there is
no immediately available input.  On a non-interactive device, the operation
always returns non-<code>nil</code> except at end-of-file.
</p>
<p>The main purpose of <code>:listen</code> is to test whether the user has hit
a key, perhaps trying to stop a program in progress.
</p></dd></dl>

<dl>
<dt><a name="index-_003atyi_002dno_002dhang-on-streams"></a>Meta Method on streams: <strong>:tyi-no-hang</strong> <em>&amp;optional eof</em></dt>
<dd><p>Just like <code>:tyi</code> except that it returns <code>nil</code> rather than waiting if
it would be necessary to wait in order to get the character.  This lets
the caller check efficiently for input being available and get the input
if there is any.
</p>
<p><code>:tyi-no-hang</code> is different from <code>:listen</code> because it reads a
character.
</p>
<p>Streams for which the question of whether input is available is not
meaningful will treat this operation just like <code>:tyi</code>.  So will
chaosnet file streams.  Although in fact reading
character from a file stream may involve a delay, these delays are
<em>supposed</em> to be insignificant, so we pretend they do not exist.
</p></dd></dl>

<dl>
<dt><a name="index-_003arubout_002dhandler-on-streams"></a>Meta Method on streams: <strong>:rubout-handler</strong> <em>options function &amp;rest args</em></dt>
<dd><p>This is supported by interactive bidirectional streams, such as windows
on the terminal, and is described in its own section below (see
<a href="#rubout_002dhandler">rubout-handler</a>).
</p></dd></dl>

<a name="streams_002dbeep_002dmethod"></a><dl>
<dt><a name="index-_003abeep-on-streams"></a>Meta Method on streams: <strong>:beep</strong> <em>&amp;optional type</em></dt>
<dd><p>This is supported by interactive streams.  It attracts the attention of the
user by making an audible beep and/or flashing the screen.
<em>type</em> is a keyword selecting among several different beeping noises.
The allowed types have not yet been defined; <em>type</em> is currently ignored
and should always be <code>nil</code>.
</p></dd></dl>

<a name="g_t_0022Cursor-Positioning-Stream-Operations_0022"></a>
<h4 class="subsection">21.5.5 &quot;Cursor Positioning Stream Operations&quot;</h4>

<dl>
<dt><a name="index-_003aread_002dcursorpos-on-streams"></a>Meta Method on streams: <strong>:read-cursorpos</strong> <em>&amp;optional (units <code>':pixel</code>)</em></dt>
<dd><a name="read_002dcursorpos"></a><p>This operation is supported by all windows and some other streams.
</p>
<p>It returns two values, the current <em>x</em> and <em>y</em> coordinates
of the cursor.  It takes one optional argument, which is a symbol indicating
in what units <em>x</em> and <em>y</em> should be; the symbols <code>:pixel</code>
and <code>:character</code> are understood.  <code>:pixel</code> means that the coordinates
are measured in display pixels (bits), while <code>:character</code> means that
the coordinates are measured in characters horizontally and lines vertically.
</p>
<p>This operation and <code>:increment-cursorpos</code> are used by the <code>format</code> <code>&quot;~T&quot;</code>
request (see <a href="#format_002dt_002doperation">format-t-operation</a>), which is why <code>&quot;~T&quot;</code> doesn&rsquo;t work on all
streams.  Any stream that supports this operation should support
<code>:increment-cursorpos</code> as well.
</p>
<p>Some streams return a meaningful value for the horizontal position
but always return zero for the vertical position.  This is sufficient
for <code>&quot;~T&quot;</code> to work.
</p></dd></dl>

<dl>
<dt><a name="index-_003aincrement_002dcursorpos-on-streams"></a>Meta Method on streams: <strong>:increment-cursorpos</strong> <em>x-increment y-increment &amp;optional (units <code>':pixel</code>)</em></dt>
<dd><p>Moves the stream&rsquo;s cursor left or down according to the specified increments,
as if by outputting an appropriate number of space or return characters.
<em>x</em> and <em>y</em>
are like the values of <code>:read-cursorpos</code> and <em>units</em> is the same
as the <em>units</em> argument to <code>:read-cursorpos</code>.
</p>
<p>Any stream which supports this operation should support
<code>:read-cursorpos</code> as well, but it need not support <code>:set-cursorpos</code>.
</p>
<p>Moving the cursor with <code>:increment-cursorpos</code> differs from moving it
to the same place with <code>:set-cursorpos</code> in that this operation is
thought of as doing output and <code>:set-cursorpos</code> is not.  For example,
moving a window&rsquo;s cursor down with <code>:increment-cursorpos</code> when it is
near the bottom to begin with will wrap around, possibly doing a
<code>**MORE**</code>.  <code>:set-cursorpos</code>, by comparison, cannot move the cursor
&quot;down&quot; if it is at the bottom of the window; it can move the cursor
explicitly to the top of the window, but then no <code>**MORE**</code> will
happen.
</p>
<p>Some streams, such as those created by <code>with-output-to-string</code>, cannot
implement arbitrary cursor motion, but do implement this operation.
</p></dd></dl>

<dl>
<dt><a name="index-_003aset_002dcursorpos-on-streams"></a>Meta Method on streams: <strong>:set-cursorpos</strong> <em>x y &amp;optional (units <code>':pixel</code>)</em></dt>
<dd><p>This operation is supported by the same streams that support
<code>:read-cursorpos</code>.  It sets the position of the cursor.  <em>x</em> and <em>y</em>
are like the values of <code>:read-cursorpos</code> and <em>units</em> is the same
as the <em>units</em> argument to <code>:read-cursorpos</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003aclear_002dscreen-on-streams"></a>Meta Method on streams: <strong>:clear-screen</strong></dt>
<dd><p>Erases the screen area on which this stream displays.
Non-window streams don&rsquo;t support this operation.
</p></dd></dl>

<p>There are many other special-purpose stream operations for graphics.  They are
not documented here, but in the window-system documentation.  No claim that the
above operations are the most useful subset should be implied.
</p>
<a name="g_t_0022Operations-for-Efficient-Grinding_0022"></a>
<h4 class="subsection">21.5.6 &quot;Operations for Efficient Grinding&quot;</h4>

<p><code>grindef</code> runs much more efficiently on streams that implement
the <code>:untyo-mark</code> and <code>:untyo</code> operations.
</p>
<dl>
<dt><a name="index-_003auntyo_002dmark-on-streams"></a>Meta Method on streams: <strong>:untyo-mark</strong></dt>
<dd><p>This is used by the grinder (see <a href="#grindef_002dfun">grindef-fun</a>) if the output stream supports it.
It takes no arguments.  The stream
should return some object that indicates how far output has gotten up to in
the stream.
</p></dd></dl>

<dl>
<dt><a name="index-_003auntyo-on-streams"></a>Meta Method on streams: <strong>:untyo</strong> <em>mark</em></dt>
<dd><p>This is used by the grinder (see <a href="#grindef_002dfun">grindef-fun</a>) in conjunction with <code>:untyo-mark</code>.
It takes one argument, which is something returned by the <code>:untyo-mark</code>
operation of the stream.  The stream should back up output to the point
at which the object was returned.
</p></dd></dl>

<a name="g_t_0022Random-Access-File-Operations_0022"></a>
<h4 class="subsection">21.5.7 &quot;Random Access File Operations&quot;</h4>

<p>The following operations are implemented only by streams to random-access devices,
principally files.
</p>
<dl>
<dt><a name="index-_003aread_002dpointer-on-streams"></a>Meta Method on streams: <strong>:read-pointer</strong></dt>
<dd><p>Returns the current position within the file, in characters (bytes in fixnum
mode).  For text files on PDP-10 file servers, this is the number of Lisp
Machine characters, not PDP-10 characters.  The numbers are different because of
character-set translation.
</p></dd></dl>

<a name="streams_002dset_002dpointer_002dmethod"></a><dl>
<dt><a name="index-_003aset_002dpointer-on-streams"></a>Meta Method on streams: <strong>:set-pointer</strong> <em>new-pointer</em></dt>
<dd><p>Sets the reading position within the file to <em>new-pointer</em> (bytes in fixnum
mode).  For text files on PDP-10 file servers, this will not do anything reasonable
unless <em>new-pointer</em> is 0, because of character-set translation.
Some file systems support this operation for input streams only.
</p></dd></dl>

<dl>
<dt><a name="index-_003arewind-on-streams"></a>Meta Method on streams: <strong>:rewind</strong></dt>
<dd><p>This operation is obsolete.  It is the same as <code>:set-pointer</code> with
argument zero.
</p></dd></dl>

<a name="g_t_0022Buffered-Stream-Operations_0022"></a>
<h4 class="subsection">21.5.8 &quot;Buffered Stream Operations&quot;</h4>

<dl>
<dt><a name="index-_003aclear_002dinput-on-streams"></a>Meta Method on streams: <strong>:clear-input</strong></dt>
<dd><p>This operation discards any buffered input the stream may have.
It does nothing on streams for which it is not meaningful.
</p></dd></dl>

<dl>
<dt><a name="index-_003aclear_002doutput-on-streams"></a>Meta Method on streams: <strong>:clear-output</strong></dt>
<dd><p>This operation discards any buffered output the stream may have.
It does nothing on streams for which it is not meaningful.
</p></dd></dl>

<dl>
<dt><a name="index-_003aforce_002doutput-on-streams"></a>Meta Method on streams: <strong>:force-output</strong></dt>
<dd><p>This is for output streams to buffered asynchronous devices, such as the
Chaosnet.  <code>:force-output</code> causes any buffered output to be sent to the
device.  It does not wait for it to complete; use <code>:finish</code> for that.  If a
stream supports <code>:force-output</code>, then <code>:tyo</code>, <code>:string-out</code>, and
<code>:line-out</code> may have no visible effect until a <code>:force-output</code> is done.
</p>
<p>This operation does nothing on streams for which it is not meaningful.
</p></dd></dl>

<dl>
<dt><a name="index-_003afinish-on-streams"></a>Meta Method on streams: <strong>:finish</strong></dt>
<dd><p>This is for output streams to buffered asynchronous devices, such as the
Chaosnet.  <code>:finish</code> does a <code>:force-output</code>, then waits until the
currently pending I/O operation has been completed.
</p>
<p>This operation does nothing on streams for which it is not meaningful.
</p></dd></dl>

<p>The following operations are implemented only by buffered input streams.
They allow increased efficiency by making the stream&rsquo;s internal buffer
available to the user.
</p>
<dl>
<dt><a name="index-_003aread_002dinput_002dbuffer-on-streams"></a>Meta Method on streams: <strong>:read-input-buffer</strong> <em>&amp;optional eof</em></dt>
<dd><p>Returns three values: a buffer array, the index in that array of the next input byte,
and the index in that array just past the last available input byte.  These values
are similar to the <em>string</em>, <em>start</em>, <em>end</em> arguments taken by many functions
and stream operations.  If the end of the file
has been reached and no input bytes are available,
the stream returns <code>nil</code> or signals an error,
based on the <em>eof</em> argument, just like the <code>:tyi</code> message.
After reading as many bytes from the array
as you care to, you must send the <code>:advance-input-buffer</code> message.
</p></dd></dl>

<dl>
<dt><a name="index-_003aget_002dinput_002dbuffer-on-streams"></a>Meta Method on streams: <strong>:get-input-buffer</strong> <em>&amp;optional eof</em></dt>
<dd><p>This is an obsolete operation similar to <code>:read-input-buffer</code>.
The only difference is that the third value is the number of significant
elements in the buffer-array, rather than a final index.
If found in programs, it should be replaced with <code>:read-input-buffer</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003aadvance_002dinput_002dbuffer-on-streams"></a>Meta Method on streams: <strong>:advance-input-buffer</strong> <em>&amp;optional new-pointer</em></dt>
<dd><p>If <em>new-pointer</em> is non-<code>nil</code>, it is the index in the buffer array of the next
byte to be read.  If <em>new-pointer</em> is <code>nil</code>, the entire buffer has been used up.
</p></dd></dl>

<a name="g_t_0022Standard-Streams_0022"></a>
<h4 class="subsection">21.5.9 &quot;Standard Streams&quot;</h4>

<p>There are several variables whose values are streams used by many
functions in the Lisp system.  These variables and their uses are listed here.
By convention, variables that are expected to hold a stream capable of input
have names ending with <code>-input</code>, and similarly for output.  Those expected
to hold a bidirectional stream have names ending with <code>-io</code>.
</p>
<a name="standard_002dinput_002dvar"></a><dl>
<dt><a name="index-standard_002dinput"></a>Variable: <strong>standard-input</strong></dt>
<dd><p>In the normal Lisp top-level loop, input is read from
<code>standard-input</code> (that is, whatever stream is the value of
<code>standard-input</code>).  Many input functions, including <code>tyi</code> and
<code>read</code>, take a stream argument that defaults to <code>standard-input</code>.
</p></dd></dl>

<a name="standard_002doutput_002dvar"></a><dl>
<dt><a name="index-standard_002doutput"></a>Variable: <strong>standard-output</strong></dt>
<dd><p>In the normal Lisp top-level loop, output is sent to
<code>standard-output</code> (that is, whatever stream is the value of
<code>standard-output</code>).  Many output functions, including <code>tyo</code> and
<code>print</code>, take a stream argument that defaults to <code>standard-output</code>.
</p></dd></dl>

<a name="error_002doutput_002dvar"></a><dl>
<dt><a name="index-error_002doutput"></a>Variable: <strong>error-output</strong></dt>
<dd><p>The value of <code>error-output</code> is a stream to which noninteractive error
or warning messages should be sent.  Normally this is the same as
<code>standard-output</code>, but <code>standard-output</code> might be bound to a file
and <code>error-output</code> left going to the terminal.
</p>
<p>[This seems not be used by all the things that ought to use it.]
</p></dd></dl>

<a name="debug_002dio_002dvar"></a><dl>
<dt><a name="index-debug_002dio"></a>Variable: <strong>debug-io</strong></dt>
<dd><p>The value of <code>debug-io</code> is used for all input and output by
the error handler.  Normally this is <code>nil</code>, which is interpreted
as meaning to use the value of <code>terminal-io</code>.  (This feature is
provided because users often set <code>debug-io</code> by hand, and it is much
easier to set it back to <code>nil</code> afterward than to figure out the
proper synonym stream pointing to <code>terminal-io</code>).
</p></dd></dl>

<a name="query_002dio_002dvar"></a><dl>
<dt><a name="index-query_002dio"></a>Variable: <strong>query-io</strong></dt>
<dd><p>The value of <code>query-io</code> is a stream that should be used when
asking questions of the user.  The question should be output to this
stream, and the answer read from it.  The reason for this is that when
the normal input to a program may be coming from a file, questions such
as &quot;Do you really want to delete all of the files in your directory??&quot; should
be sent directly to the user, and the answer should come from the user,
not from the data file.  <code>query-io</code> is used by <code>fquery</code> and related
functions; see <a href="#fquery_002dfun">fquery-fun</a>.
</p></dd></dl>

<a name="terminal_002dio_002dvar"></a><dl>
<dt><a name="index-terminal_002dio"></a>Variable: <strong>terminal-io</strong></dt>
<dd><p>The value of <code>terminal-io</code> is the stream that connects to the user&rsquo;s
console.  In an &quot;interactive&quot; program, it will be the window from which
the program is being run; I/O on this stream will read from the
keyboard and display on the TV.  However, in a &quot;background&quot; program
that does not normally talk to the user, <code>terminal-io</code> defaults to a
stream that does not ever expect to be used.  If it is used, perhaps
by an error printout, it turns into a &quot;background&quot; window and requests
the user&rsquo;s attention.
</p></dd></dl>

<a name="trace_002doutput_002dvar"></a><dl>
<dt><a name="index-trace_002doutput"></a>Variable: <strong>trace-output</strong></dt>
<dd><p>The value of <code>trace-output</code> is the stream on which the <code>trace</code> function
prints its output.
</p></dd></dl>

<p><code>standard-input</code>, <code>standard-output</code>, <code>error-output</code>, <code>debug-io</code>,
<code>trace-output</code>, and <code>query-io</code> are initially bound to synonym
streams that pass all operations on to the stream that is the value of
<code>terminal-io</code>.  Thus any operations performed on those streams will go
to the TV terminal.
</p>
<p>Most user program should not change the value of <code>terminal-io</code>.  A
program which wants (for example) to divert output to a file should do
so by binding the value of <code>standard-output</code>; that way queries on
<code>query-io</code>, debugging on <code>debug-io</code> and error messages sent to
<code>error-output</code> can still get to the user by going through
<code>terminal-io</code>, which is usually what is desired.
</p>
<a name="g_t_0022Obtaining-Streams-to-Use_0022"></a>
<h4 class="subsection">21.5.10 &quot;Obtaining Streams to Use&quot;</h4>

<p>One important class of streams is windows.  Each window can be used as
a stream.  Output is displayed on the window and input comes from the
keyboard.  A window is created using <code>tv:make-window</code>.  Simple
programs use windows implicitly through <code>terminal-io</code>
and the other standard stream variables.
</p>
<p>Also important are <em>file streams</em>, which are produced by the function
<code>open</code> (see <a href="#open_002dfun">open-fun</a>).  These read or write the contents of a file.
</p>
<p><em>Chaosnet streams</em> are made from chaosnet connections.  Data output to
the stream goes out over the network; data coming in over the network is
available as input from the stream.  File streams that deal with
chaosnet file servers are very similar to chaosnet streams, but chaosnet
streams can be used for many purposes other than file access.
</p>
<p><em>String streams</em> read or write the contents of a string.  They are
made by <code>with-output-to-string</code> or <code>with-input-from-string</code>.
</p>
<p><em>Editor buffer streams</em> read or write the contents of an editor
buffer.
</p>
<p>The <em>null stream</em> may be passed to a program that asks for a stream
as an argument.  It returns immediate end of file if used for input
and throws away any output.  The null stream is the symbol
<code>si:null-stream</code>.  This is to say, you do not call that function to
get a stream or use the symbol&rsquo;s value as the stream; <em>the symbol
itself</em> is the object that is the stream.
</p>
<p>The <em>cold-load stream</em> is able to do i/o to the keyboard and screen
without using the window system.  It is what is used to by the error
handler if you type <code>Terminal Call</code> to handle a background error that the
window system cannot deal with.  It is called the cold-load stream
because it is what is used during system bootstrapping, before the
window system has been loaded.
</p>
<a name="si_003anull_002dstream_002dfun"></a><dl>
<dt><a name="index-si_003anull_002dstream"></a>Function: <strong>si:null-stream</strong> <em>operation &amp;rest arguments</em></dt>
<dd><p>This function is the null stream.  Like any stream, it supports various
operations.  Output operations are ignored and input operations report
end of file immediately, with no data.
</p></dd></dl>

<a name="si_003acold_002dload_002dstream_002dvar"></a><dl>
<dt><a name="index-si_003acold_002dload_002dstream"></a>Variable: <strong>si:cold-load-stream</strong></dt>
<dd><p>The value of this variable is the one and only cold-load stream.
</p></dd></dl>

<a name="with_002dopen_002dstream_002dfun"></a><dl>
<dt><a name="index-with_002dopen_002dstream"></a>Special Form: <strong>with-open-stream</strong> <em>(variable expression) body...</em></dt>
<dd><p><em>body</em> is executed with <em>variable</em> bound to the value of
<em>expression</em>, which ought to be a stream.  On exit, whether normal
or by throwing, a <code>:close</code> message with argument <code>:abort</code> is sent
to the stream.
</p>
<p>This is a generalization of <code>with-open-file</code>, which is equivalent
to using <code>with-open-stream</code> with a call to <code>open</code> as the
<em>expression</em>.
</p></dd></dl>

<a name="with_002dopen_002dstream_002dcase_002dfun"></a><dl>
<dt><a name="index-with_002dopen_002dstream_002dcase"></a>Special Form: <strong>with-open-stream-case</strong> <em>(variable expression) clauses...</em></dt>
<dd><p>Like <code>with-open-stream</code> as far as opening and closing the stream are
concerned, but instead of a simple body, it has clauses like those of a
<code>condition-case</code> that say what to do if <em>expression</em> does or does
not get an error.  See <code>with-open-file-case</code>, <a href="#with_002dopen_002dfile_002dcase_002dfun">with-open-file-case-fun</a>.
</p></dd></dl>

<a name="make_002dsyn_002dstream_002dfun"></a><dl>
<dt><a name="index-make_002dsyn_002dstream"></a>Function: <strong>make-syn-stream</strong> <em>symbol-or-locative</em></dt>
<dd><p><code>make-syn-stream</code> creates and returns a &quot;synonym stream&quot; (syn for
short).  Any operations sent to this stream will be redirected to the
stream that is the value of the argument (if it is a symbol) or the contents of it (if it is a locative).
</p>
<p>A synonym stream made from a symbol is actually a symbol named
<em>symbol</em><code>-syn-stream</code> whose function definition is <em>symbol</em>, with
a property that declares it to be a legitimate stream.  The generated
symbol is interned in the same package as <em>symbol</em>.
</p>
<p>A synonym stream made from a locative is a closure.
</p></dd></dl>

<a name="make_002dbroadcast_002dstream_002dfun"></a><dl>
<dt><a name="index-make_002dbroadcast_002dstream"></a>Function: <strong>make-broadcast-stream</strong> <em>&amp;rest streams</em></dt>
<dd><p>Returns a stream that only works in the output direction.  Any output sent to
this stream will be sent to all of the streams given.  The <code>:which-operations</code>
is the intersection of the <code>:which-operations</code> of all of the streams.  The value(s)
returned by a stream operation are the values returned by the last stream in <em>streams</em>.
</p></dd></dl>

<a name="zwei_003ainterval_002dstream_002dfun"></a><dl>
<dt><a name="index-zwei_003ainterval_002dstream"></a>Function: <strong>zwei:interval-stream</strong> <em>interval-or-from-bp &amp;optional to-bp in-order-p hack-fonts</em></dt>
<dd><p>Returns a bidirectional stream that reads or writes all or part of an
editor buffer.  Note that editor buffer streams can also be obtained
from <code>open</code> by using a pathname whose host is <code>ED</code>, <code>ED-BUFFER</code> or
<code>ED-FILE</code> (see <a href="#editor_002dhosts">editor-hosts</a>).
</p>
<p>The first three arguments specify the buffer or portion to be read or
written.  Either the first argument is an <em>interval</em> (a buffer is one
kind of interval), and all the text of that interval is read or written,
or the first two arguments are two buffer pointers delimiting the range
to be read or written.  The third argument is used only in the latter
case; if non-<code>nil</code>, it tells the function to assume that the second
buffer pointer comes later in the buffer than the first and not to take
the time to verify the assumption.
</p>
<p>The stream has only one pointer inside it, used for both input and
output.  As you do input, the pointer advances through the text.
When you do output, it is inserted in the buffer at the place where the
pointer has reached.  The pointer starts at the beginning of the
specified range.
</p>
<p><em>hack-fonts</em> tells what to do about fonts.
</p>
<p>If <em>hack-fonts</em> is <code>t</code>, then the character <code>epsilon</code> is recognized as
special when you output to the stream; sequences such as <code>epsilon2</code> are
interpreted as font-changes.  They do not get inserted into the buffer;
instead, they change the font in which following output will be
inserted.  On input, font change sequences are inserted to indicate
faithfully what was in the buffer.
</p>
<p>If <em>hack-fonts</em> is <code>:tyo</code>, then you are expected to read and write
16-bit characters containing font numbers.
</p>
<p>If <em>hack-fonts</em> is <code>nil</code>, then all output is inserted in font zero
and font information is discarded in the input you receive.
This is the best mode to use if you are evaluating the contents of an
editor buffer.
</p></dd></dl>

<a name="si_003awith_002dhelp_002dstream_002dfun"></a><dl>
<dt><a name="index-si_003awith_002dhelp_002dstream"></a>Special Form: <strong>si:with-help-stream</strong> <em>(stream options...) body...</em></dt>
<dd><p>Executes the <em>body</em> with the variable <em>stream</em> bound to a suitable
stream for printing a large help message.  If <code>standard-output</code> is a
window, then <em>stream</em> is also a window; a temporary window which fills
the screen.  Otherwise, <em>stream</em> is just the same as
<code>standard-output</code>.
</p>
<p>The purpose of this is to spare the user the need to read a large help
printout in a small window, or have his data overwritten by it
permanently.  This is the mechanism used if you type the <code>Help</code> key while
in the rubout handler.
</p>
<p>Important note: the body gets turned into a <code>lambda</code>-expression with the
stream and the width and height variables bound appropriately; this
means that variables from the surrounding program that are to be
accessed by the body must be special.
</p>
<p><em>options</em> is a list of alternating keywords and values.
</p><dl compact="compact">
<dt><code>:label</code></dt>
<dd><p>The value (which is evaluated) is used as the label of the temporary
window, if one is used.
</p>
</dd>
<dt><code>:width</code></dt>
<dd><p>The value, which is not evaluated, is a symbol.  While <em>body</em> is
executed, this symbol is bound to the width, in characters, available
for the message.
</p>
</dd>
<dt><code>:height</code></dt>
<dd><p>The value is a symbol, like the value after <code>:width</code>, and it is bound
to the height in lines of the area available for the help message.
</p>
</dd>
<dt><code>:superior</code></dt>
<dd><p>The value, which is evaluated, specifies the original stream to use in
deciding where to print the help message.  This overrides the use of
<code>standard-output</code>.
</p></dd>
</dl>
</dd></dl>

<a name="g_t_0022Implementing-Streams_0022"></a>
<h4 class="subsection">21.5.11 &quot;Implementing Streams&quot;</h4>

<p>There are two ways to implement a stream: using <code>defun</code> and using flavors.
</p>
<p>Using flavors is best when you can take advantage of the predefined
stream mixins, including those which perform buffering, or when you wish
to define several similar kinds of streams that can inherit methods from
each other.
</p>
<p><code>defun</code> may have an advantage if you are
dividing operations into broad groups and handling them by passing them
off to one or more other streams.  In this case, the automatic operation
decoding provided by flavors may get in the way.  A number of streams in
the system are implemented using <code>defun</code> (or using <code>defselect</code>,
which is nearly the same thing) for historical reasons.  It isn&rsquo;t yet
clear whether there is any reason not to convert most of them to use
flavors.
</p>
<p>If you use <code>defun</code>, you can use the <em>stream default handler</em> to
implement some of the standard operations for you in a default manner.
If you use flavors, there are predefined mixins to do this for you.
</p>
<p>A few streams are individual objects, one of a kind.  For example, there
is only one null stream, and no need for more, since two null streams
would behave identically.  But most streams are elements of a general
class.  For example, there can be many file streams for different files,
even though all behave the same way.  There can also be multiple streams
reading from different points in the same file.
</p>
<p>If you implement a class of streams with <code>defun</code>, then the actual
streams will be closures of the function you define, made with
<code>closure</code>.
</p>
<p>If you use flavors to implement the streams, having a class of similar
streams comes naturally: each instance of the flavor is a stream, and
the instance variables distinguish one stream of the class from another.
</p>
<a name="g_t_0022Implementing-Streams-with-Flavors_0022"></a>
<h4 class="subsection">21.5.12 &quot;Implementing Streams with Flavors&quot;</h4>

<p>To define a stream using flavors, define a flavor which incorporates the
appropriate predefined stream flavor, and then redefine those operations
which are peculiar to your own type of stream.
</p>
<p>Flavors for defining unbuffered streams:
</p>
<dl>
<dt><a name="index-si_003astream-on-"></a>Flavor on : <strong>si:stream</strong></dt>
<dd><p>This flavor provides default definitions for a few standard operations such as
<code>:direction</code> and <code>:characters</code>.  Usually you do not have to mention
this explicitly; instead you use the higher level flavors below, which
are built on this one.
</p></dd></dl>

<dl>
<dt><a name="index-si_003ainput_002dstream-on-"></a>Flavor on : <strong>si:input-stream</strong></dt>
<dd><p>This flavor provides default definitions of all the mandatory input
operations except <code>:tyi</code> and <code>:untyi</code>, in terms of those two.  You
can make a simple non-character input stream by defining a flavor
incorporating this one and giving it methods for <code>:tyi</code> and
<code>:untyi</code>.
</p></dd></dl>

<dl>
<dt><a name="index-si_003aoutput_002dstream-on-"></a>Flavor on : <strong>si:output-stream</strong></dt>
<dd><p>This flavor provides default definitions of all the mandatory output
operations except <code>:tyo</code>, in terms of <code>:tyo</code>.  All you need to do to
define a simple unbuffered non-character output stream is to define a
flavor incorporating this one and give it a method for the
<code>:tyo</code> operation.
</p></dd></dl>

<dl>
<dt><a name="index-si_003abidirectional_002dstream-on-"></a>Flavor on : <strong>si:bidirectional-stream</strong></dt>
<dd><p>This is a combination of <code>si:input-stream</code> and <code>si:output-stream</code>.
It defines <code>:direction</code> to return <code>:bidirectional</code>.  To define a
simple unbuffered non-character bidirectional stream, build on this
flavor and define <code>:tyi</code>, <code>:untyi</code> and <code>:tyo</code>.
</p></dd></dl>

<p>The unbuffered streams implement operations such as <code>:string-out</code> and
<code>:string-in</code> by repeated use of <code>:tyo</code> or <code>:tyi</code>.
</p>
<p>For greater efficiency, if the stream&rsquo;s data is available in blocks, it
is better to define a buffered stream.  You start with the predefined
buffered stream flavors, which define <code>:tyi</code> or <code>:tyo</code> themselves
and manage the buffers for you.  You must provide other operations that
the system uses to obtain the next input buffer or to write or discard
an output buffer.
</p>
<p>Flavors for defining buffered streams:
</p>
<dl>
<dt><a name="index-si_003abuffered_002dinput_002dstream-on-"></a>Flavor on : <strong>si:buffered-input-stream</strong></dt>
<dd><p>This flavor is the basis for a non-character buffered input stream.
It defines <code>:tyi</code> as well as all the other standard input operations,
but you must define the two operations <code>:next-input-buffer</code> and
<code>:discard-input-buffer</code>, which the buffer management routines use.
</p></dd></dl>

<dl>
<dt><a name="index-_003anext_002dinput_002dbuffer-on-si_003abuffered_002dinput_002dstream"></a>Method on si:buffered-input-stream: <strong>:next-input-buffer</strong></dt>
<dd><p>In a buffered input stream, this operation is used as a subroutine of
the standard input operations, such as <code>:tyi</code>, to get the next
bufferful of input data.  It should return three values: an array
containing the data, a starting index in the array, and an ending index.
For example, in a chaosnet stream, this operation would get the next
packet of input data and return pointers delimiting the actual data in
the packet.
</p></dd></dl>

<dl>
<dt><a name="index-_003adiscard_002dinput_002dbuffer-on-si_003abuffered_002dinput_002dstream"></a>Method on si:buffered-input-stream: <strong>:discard-input-buffer</strong> <em>buffer-array</em></dt>
<dd><p>In a buffered input stream, this operation is used as a subroutine of
the standard input operations such as <code>:tyi</code>.  It says that the buffer
management routines have used or thrown away all the input in a buffer,
and the buffer is no longer needed.
</p>
<p>In a chaosnet stream, this operation would return the buffer, a packet,
to the pool of free packets.
</p></dd></dl>

<dl>
<dt><a name="index-si_003abuffered_002doutput_002dstream-on-"></a>Flavor on : <strong>si:buffered-output-stream</strong></dt>
<dd><p>This flavor is the basis for a non-character buffered output stream.  It
defines <code>:tyo</code> as well as all the other standard output operations, but
you must define the operations <code>:new-output-buffer</code>,
<code>:send-output-buffer</code> and <code>:discard-output-buffer</code>, which the buffer
management routines use.
</p></dd></dl>

<dl>
<dt><a name="index-_003anew_002doutput_002dbuffer-on-si_003abuffered_002doutput_002dstream"></a>Method on si:buffered-output-stream: <strong>:new-output-buffer</strong></dt>
<dd><p>In a buffered output stream, this operation is used as a subroutine of
the
standard output operations, such as <code>:tyo</code>, to get an empty buffer for
storing more output data.  How the buffer is obtained depends on the
kind of stream, but in any case this operation should return an array
(the buffer), a starting index, and an ending index.  The two indices
delimit the part of the array that is to be used as a buffer.
</p>
<p>For example, a chaosnet stream would get a packet from the free pool
and return indices delimiting the part of the packet array which can
hold data bytes.
</p></dd></dl>

<dl>
<dt><a name="index-_003asend_002doutput_002dbuffer-on-si_003abuffered_002doutput_002dstream"></a>Method on si:buffered-output-stream: <strong>:send-output-buffer</strong> <em>buffer-array ending-index</em></dt>
<dd><p>In a buffered output stream, this operation is used as a subroutine of
the standard output operations, such as <code>:tyo</code>, to send the data in a
buffer that has been completely or partially filled.
</p>
<p><em>ending-index</em> is the first index in the buffer that has not actually
been stored.  This may not be the same as the ending index that was
returned by the <code>:new-output-buffer</code> operation that was used to
obtain this buffer; if a <code>:force-output</code> is done, <em>ending-index</em>
will indicate how much of the buffer was full at the time.
</p>
<p>The method for this operation should process the buffer&rsquo;s data and, if
necessary, return the buffer to a free pool.
</p></dd></dl>

<dl>
<dt><a name="index-_003adiscard_002doutput_002dbuffer-on-si_003abuffered_002doutput_002dstream"></a>Method on si:buffered-output-stream: <strong>:discard-output-buffer</strong> <em>buffer-array</em></dt>
<dd><p>In a buffered output stream, this operation is used as a subroutine
of the standard output operations, such as <code>:clear-output</code>, to free an
output buffer and say that the data in it should be ignored.
</p>
<p>It should simply return <em>buffer-array</em> to a free pool, if appropriate.
</p></dd></dl>

<p>Some buffered output streams simply have one buffer array which they use
over and over.  For such streams, <code>:new-output-buffer</code> can simply
return that particular array each time; <code>:send-output-buffer</code> and
<code>:discard-output-buffer</code> do not have to do anything about returning
the buffer to a free pool.  In fact, <code>:discard-output-buffer</code> can
probably do nothing.
</p>
<dl>
<dt><a name="index-si_003abuffered_002dstream-on-"></a>Flavor on : <strong>si:buffered-stream</strong></dt>
<dd><p>This is a combination of <code>si:buffered-input-stream</code> and
<code>si:buffered-output-stream</code>, used to make a buffered bidirectional
stream.  The input and output buffering are completely independent of
each other.  You must define all five of the low level operations:
<code>:new-output-buffer</code>, <code>:send-output-buffer</code> and
<code>:discard-output-buffer</code> for output, and <code>:next-input-buffer</code> and
<code>:discard-input-buffer</code> for input.
</p></dd></dl>

<p>The data in most streams are characters.  Character streams should support
either <code>:line-in</code> or <code>:line-out</code> in addition to the other standard
operations.
</p>
<dl>
<dt><a name="index-si_003aunbuffered_002dline_002dinput_002dstream-on-"></a>Flavor on : <strong>si:unbuffered-line-input-stream</strong></dt>
<dd><p>This flavor is the basis for unbuffered character input streams.
You need only define <code>:tyi</code> and <code>:untyi</code>.
</p></dd></dl>

<dl>
<dt><a name="index-si_003aline_002doutput_002dstream_002dmixin-on-"></a>Flavor on : <strong>si:line-output-stream-mixin</strong></dt>
<dd><p>To make an unbuffered character output stream, mix this flavor into the
one you define, together with <code>si:output-stream</code>.  In addition, you
must define <code>:tyo</code>, as for unbuffered non-character streams.
</p></dd></dl>

<dl>
<dt><a name="index-si_003abuffered_002dinput_002dcharacter_002dstream-on-"></a>Flavor on : <strong>si:buffered-input-character-stream</strong></dt>
<dd><p>This is used just like <code>si:buffered-input-stream</code>, but it also
provides the <code>:line-in</code> operation and makes <code>:characters</code> return
<code>t</code>.
</p></dd></dl>

<dl>
<dt><a name="index-si_003abuffered_002doutput_002dcharacter_002dstream-on-"></a>Flavor on : <strong>si:buffered-output-character-stream</strong></dt>
<dd><p>This is used just like <code>si:buffered-output-stream</code>, but it also
provides the <code>:line-out</code> operation and makes <code>:characters</code> return
<code>t</code>.
</p></dd></dl>

<dl>
<dt><a name="index-si_003abuffered_002dcharacter_002dstream-on-"></a>Flavor on : <strong>si:buffered-character-stream</strong></dt>
<dd><p>This is used just like <code>si:buffered-stream</code>, but it also
provides the <code>:line-in</code> and <code>:line-out</code> operations and makes
<code>:characters</code> return <code>t</code>.
</p></dd></dl>

<p>To make an unbuffered random-access stream, you need only define the
<code>:read-pointer</code> and <code>:set-pointer</code> operations as appropriate.
Since you provide the <code>:tyi</code> or <code>:tyo</code> handler yourself, the system
cannot help you.
</p>
<p>In a buffered random-access stream, the random access operations must
interact with the buffer management.  The system provides for this.
</p>
<dl>
<dt><a name="index-si_003ainput_002dpointer_002dremembering_002dmixin-on-"></a>Flavor on : <strong>si:input-pointer-remembering-mixin</strong></dt>
<dd><p>Incorporate this into a buffered input stream to
support random access.  This flavor defines the <code>:read-pointer</code> and
<code>:set-pointer</code> operations.  If you wish <code>:set-pointer</code> to work, you
must provide a definition for the <code>:set-buffer-pointer</code> operation.
You need not do so if you wish to support only <code>:read-pointer</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003aset_002dbuffer_002dpointer-on-si_003ainput_002dpointer_002dremembering_002dmixin"></a>Method on si:input-pointer-remembering-mixin: <strong>:set-buffer-pointer</strong> <em>new-pointer</em></dt>
<dd><p>You must define this operation if you use
<code>si:input-pointer-remembering-mixin</code> and want the <code>:set-pointer</code>
operation to work.
</p>
<p>This operation should arrange for the next <code>:next-input-buffer</code>
operation to provide a bufferful of data that includes the specified
character or byte position somewhere inside it.
</p>
<p>The value returned should be the file pointer corresponding to the first
character or byte of that next bufferful.
</p></dd></dl>

<dl>
<dt><a name="index-si_003aoutput_002dpointer_002dremembering_002dmixin-on-"></a>Flavor on : <strong>si:output-pointer-remembering-mixin</strong></dt>
<dd><p>Incorporate this into a buffered output stream to
support random access.  This mixin defines the <code>:read-pointer</code> and
<code>:set-pointer</code> operations.  If you wish <code>:set-pointer</code> to work, you
must provide definitions for the <code>:set-buffer-pointer</code> and
<code>:get-old-data</code> operations.  You need not do so if you wish to support
only <code>:read-pointer</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003aset_002dbuffer_002dpointer-on-si_003aoutput_002dpointer_002dremembering_002dmixin"></a>Method on si:output-pointer-remembering-mixin: <strong>:set-buffer-pointer</strong> <em>new-pointer</em></dt>
<dd><p>This is the same as in <code>si:input-pointer-remembering-mixin</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003aget_002dold_002ddata-on-si_003aoutput_002dpointer_002dremembering_002dmixin"></a>Method on si:output-pointer-remembering-mixin: <strong>:get-old-data</strong> <em>buffer-array lower-output-limit</em></dt>
<dd><p>The buffer management routines perform this operation when you do a
<code>:set-pointer</code> that outside the range of pointers that fit in the
current output buffer.  They first send the old buffer, then do
<code>:set-buffer-pointer</code> as described above to say where in the file the
next output buffer should come, then do <code>:new-output-buffer</code> to get the
new buffer.  Then the <code>:get-old-data</code> operation is performed.
</p>
<p>It should fill current buffer (<em>buffer-array</em>) with the <em>old</em>
contents of the file at the corresponding addresses, so that when the
buffer is eventually written, any bytes skipped over by random access
will retain their old values.
</p>
<p>The instance variable <code>si:stream-output-lower-limit</code> is the starting
index in the buffer of the part that is supposed to be used for output.
<code>si:stream-output-limit</code> is the ending index.
The instance variable <code>si:output-pointer-base</code> is the file pointer
corresponding to the starting index in the buffer. 
</p></dd></dl>

<dl>
<dt><a name="index-si_003afile_002dstream_002dmixin-on-"></a>Flavor on : <strong>si:file-stream-mixin</strong></dt>
<dd><p>Incorporate this mixin together with <code>si:stream</code> to make a <em>file probe stream</em>,
which cannot do input or output but records the answers to an enquiry
about a file.  You should specify the init option <code>:pathname</code> when you
instantiate the flavor.
</p>
<p>You must provide definitions for the <code>:plist</code> and <code>:truename</code>
operations; in terms of them, this mixin will define the operations
<code>:get</code>, <code>:creation-date</code>, and <code>:info</code>.
</p></dd></dl>

<dl>
<dt><a name="index-si_003ainput_002dfile_002dstream_002dmixin-on-"></a>Flavor on : <strong>si:input-file-stream-mixin</strong></dt>
<dd><p>Incorporate this mixin into input streams that are used to read files.
You should specify the file&rsquo;s pathname with the <code>:pathname</code> init option
when you instantiate the flavor.
</p>
<p>In addition to the services and requirements of
<code>si:file-stream-mixin</code>, this mixin takes care of mentioning the file
in the who-line.  It also includes
<code>si:input-pointer-remembering-mixin</code> so that the <code>:read-pointer</code>
operation, at least, will be available.
</p></dd></dl>

<dl>
<dt><a name="index-si_003aoutput_002dfile_002dstream_002dmixin-on-"></a>Flavor on : <strong>si:output-file-stream-mixin</strong></dt>
<dd><p>This is the analogue of <code>si:input-file-stream-mixin</code> for output
streams.
</p></dd></dl>

<a name="g_t_0022Implementing-Streams-Without-Flavors_0022"></a>
<h4 class="subsection">21.5.13 &quot;Implementing Streams Without Flavors&quot;</h4>

<p>You do not need to use flavors to implement a stream.
Any object that can be used as a function, and decodes its first
argument appropriately as an operation name, will serve as a stream.
Although in practice using flavors is as easy as any other way,
it is educational to see how to define streams &quot;from scratch&quot;.
</p>
<p>We could begin to define a simple output stream, which accepts
characters and conses them onto a list, as follows:
</p>
<div class="lisp">
<pre class="lisp">(defvar the-list nil)

(defun list-output-stream (op &amp;optional arg1 &amp;rest rest)
    (selectq op
        (:tyo
         (setq the-list (cons arg1 the-list)))
        (:which-operations '(:tyo))))
</pre></div>

<p>This is an output stream, and so it supports the <code>:tyo</code> operation.
All streams must support <code>:which-operations</code>.
</p>
<p>The lambda-list for a stream defined with a <code>defun</code> must always have
one required parameter (<em>op</em>), one optional parameter (<em>arg1</em>), and
a rest parameter (<em>rest</em>).
</p>
<p>This definition is not satisfactory, however.  It handles <code>:tyo</code>
properly, but it does not handle <code>:string-out</code>, <code>:direction</code>,
<code>:send-if-handles</code>, and other standard operations.
</p>
<p>The function <code>stream-default-handler</code> exists to spare us the trouble
of defining all those operations from scratch in simple streams like
this.  By adding one additional clause, we let the default handler take
care of all other operations, if it can.
</p>
<div class="lisp">
<pre class="lisp">(defun list-output-stream (op &amp;optional arg1 &amp;rest rest)
    (selectq op
        (:tyo
         (setq the-list (cons arg1 the-list)))
        (:which-operations '(:tyo))
        (otherwise
          (stream-default-handler #'list-output-stream
				  op arg1 rest))))
</pre></div>

<p>If the operation is not one that the stream understands (e.g <code>:string-out</code>),
it calls <code>stream-default-handler</code>.  Note how the rest argument is
passed to it.  This is why the argument list must look the way it does.
<code>stream-default-handler</code> can be thought of as a restricted analogue of
flavor inheritance.
</p>
<p>If we want to have only one stream of this sort, the symbol
<code>list-output-stream</code> can be used as the stream.  The data output to it
will appear in the global value of <code>the-list</code>.  One more step is
required, though:
</p><div class="lisp">
<pre class="lisp">(defprop list-output-stream t si:io-stream-p)
</pre></div>
<p>This tells certain functions including <code>read</code> to treat the symbol
<code>list-output-stream</code> as a stream rather than as an end-of-file option.
</p>
<p>If we wish to be able to create any number of list output
streams, each accumulating its own list, we must use closures:
</p>
<div class="lisp">
<pre class="lisp">(defvar the-stream)
(defvar the-list)

(defun list-output-stream (op &amp;optional arg1 &amp;rest rest)
    (selectq op
        (:tyo
	 (push arg1 the-list)))
	(:withdrawal (prog1 the-list (setq the-list nil)))
        (:which-operations '(:tyo :withdrawal))
        (otherwise
          (stream-default-handler the-stream
				  op arg1 rest))))

(defun make-list-output-stream ()
  (let ((the-stream the-list))
    (setq the-stream
	  (closure '(the-stream the-list)
                   'list-output-stream))))
</pre></div>

<p>We have added a new operation <code>:withdrawal</code> that can be used to find
out what data has been accumulated by a stream.  This is necessary
because we can no longer simply look at or set the global value of
<code>the-list</code>; that is not the same as the value closed into the stream.
</p>
<p>In addition, we have a new variable <code>the-stream</code> which allows the
function <code>list-output-stream</code> to know which stream it is serving at
any time.  This variable is passed to <code>stream-default-handler</code> so that
when it simulates <code>:string-out</code> by means of <code>:tyo</code>, it can do the
<code>:tyo</code>&rsquo;s to the same stream that the <code>:string-out</code> was done to.
</p>
<p>The same stream could be defined with <code>defselect</code> instead of
<code>defun</code>.  It actually makes only a small difference.  The <code>defun</code>
for <code>list-output-stream</code> could be replaced with this code:
</p>
<div class="lisp">
<pre class="lisp">(defselect (list-output-stream list-output-d-h)
  (:tyo (arg1)
    (push arg1 the-list))
  (:withdrawal ()
    (prog1 the-list (setq the-list nil))))

(defun list-output-d-h (op &amp;optional arg1 &amp;rest rest)
  (stream-default-handler the-stream op arg1 rest))
</pre></div>

<p><code>defselect</code> takes care of decoding the operations, provides a
definition for <code>:which-operations</code>, and allows you to write a separate
lambda list for each operation.
</p>
<p>By comparison, the same stream defined using flavors looks like this:
</p>
<div class="lisp">
<pre class="lisp">(defflavor list-output-stream ((the-list nil))
	   (si:line-output-stream-mixin si:output-stream))

(defmethod (list-output-stream :tyo) (character)
  (push character the-list))

(defmethod (list-outut-stream :withdrawal) ()
  (prog1 the-list (setq the-list nil)))

(defun make-list-output-stream ()
  (make-instance 'list-output-stream))
</pre></div>

<div class="lisp">
<pre class="lisp">Here is a simple input stream, which generates successive characters of a list.
</pre><pre class="lisp">(defvar the-list)	;Put your input list here
(defvar the-stream)
(defvar untyied-char nil)

(defun list-input-stream (op &amp;optional arg1 &amp;rest rest)
  (selectq op
    (:tyi
     (cond ((not (null untyied-char))
	    (prog1 untyied-char (setq untyied-char nil)))
	   ((null the-list)
	    (and arg1 (error arg1)))
	   (t (pop the-list))))
    (:untyi
     (setq untyied-char arg1))
    (:which-operations '(:tyi :untyi))
    (otherwise
      (stream-default-handler the-stream
                              op arg1 rest))))

(defun make-list-input-stream (the-list)
  (let (the-stream untyied-char)
    (setq the-stream
	  (closure '(the-list the-stream untyied-char)
		   'list-input-stream))))
</pre></div>
<p>The important things to note are that <code>:untyi</code> must be supported,
and that the stream must check for having reached the end of the information
and do the right thing with the argument to the <code>:tyi</code> operation.
</p>
<a name="stream_002ddefault_002dhandler_002dfun"></a><dl>
<dt><a name="index-stream_002ddefault_002dhandler"></a>Function: <strong>stream-default-handler</strong> <em>stream op arg1 rest</em></dt>
<dd><p><code>stream-default-handler</code> tries to handle the <em>op</em> operation on <em>stream</em>,
given arguments of <em>arg1</em> and the elements of <em>rest</em>.  The exact action
taken for each of the defined operations is explained with the documentation on
that operation, above.
</p></dd></dl>




<a name="g_t_0022Formatted-Output_0022"></a>
<h3 class="section">21.6 &quot;Formatted Output&quot;</h3>
<a name="index-formatted-output"></a>

<p>There are two ways of doing general formatted output.  One is the
function <code>format</code>.  The other is the <code>output</code> subsystem.
<code>format</code> uses a control string written in a special format
specifier language to control the output format.
<code>format:output</code> provides Lisp functions to do
output in particular formats.  
</p>
<p>For simple tasks in which only the most basic format specifiers are
needed, <code>format</code> is easy to use and has the advantage of brevity.
For more complicated tasks, the format specifier language becomes
obscure and hard to read.  Then <code>format:output</code> becomes advantageous
because it works with ordinary Lisp control constructs.
</p>
<p>For formatting Lisp code (as opposed to text and tables), there is
the grinder (see <a href="#grind">grind</a>).
</p>
<a name="The-Format-Function"></a>
<h4 class="subsection">21.6.1 The Format Function</h4>
<a name="format"></a>
<a name="format_002dfun"></a><dl>
<dt><a name="index-format"></a>Function: <strong>format</strong> <em>destination control-string &amp;rest args</em></dt>
<dd><p><code>format</code> is used to produce formatted output.
<code>format</code> outputs the characters of <em>control-string</em>, except
that a tilde (&quot;<code>~@</code>&quot;) introduces a directive.  The character after
the tilde, possibly preceded by prefix parameters and modifiers, specifies
what kind of formatting is desired.  Most directives use one or more
elements of <em>args</em> to create their output; the typical directive
puts the next element of <em>args</em> into the output, formatted in
some special way.
</p>
<p>The output is sent to <em>destination</em>.  If <em>destination</em> is
<code>nil</code>, a string is created which contains the output; this string is
returned as the value of the call to <code>format</code>.  In all other cases
<code>format</code> returns no interesting value (generally it returns <code>nil</code>).
If <em>destination</em> is a stream, the output is sent to it.  If
<em>destination</em> is <code>t</code>, the output is sent to <code>standard-output</code>.  If
<em>destination</em> is a string with an array-leader, such as would be
acceptable to <code>string-nconc</code> (see <a href="#string_002dnconc_002dfun">string-nconc-fun</a>), the output is
added to the end of that string.
</p></dd></dl>

<p>A directive consists of a tilde, optional prefix parameters
separated by commas, optional colon (&quot;<code>:</code>&quot;) and atsign (&quot;<code>@</code>&quot;) modifiers,
and a single character indicating what kind of directive this is.
The alphabetic case of the character is ignored.
The prefix parameters are generally decimal numbers.
Examples of control strings:
</p><div class="lisp">
<pre class="lisp">&quot;~S&quot;        ; <span class="roman">This is an S directive with no parameters.</span>
&quot;~3,4:@s&quot;   ; <span class="roman">This is an S directive with two parameters, 3 and 4,</span>
            ; <span class="roman">   and both the colon and atsign flags.</span>
&quot;~,4S&quot;      ; <span class="roman">The first prefix parameter is omitted and takes</span>
            ; <span class="roman">   on its default value, while the second is 4.</span>
</pre></div>

<p><code>format</code> includes some extremely complicated and specialized
features.  It is not necessary to understand all or even most of its
features to use <code>format</code> efficiently.  The beginner should
skip over anything in the following documentation that is not
immediately useful or clear.  The more sophisticated features are
there for the convenience of programs with complicated formatting
requirements.
</p>
<p>Sometimes a prefix parameter is used to specify a character, for
instance the padding character in a right- or left-justifying operation.
In this case a single quote (&quot;<code>'</code>&quot;) followed by the desired
character may be used as a prefix parameter, so that you don&rsquo;t have to
know the decimal numeric values of characters in the character set.  For
example, you can use
</p><div class="lisp">
<pre class="lisp">&quot;~5,'0d&quot;  <span class="roman">instead of</span> &quot;~5,48d&quot;
</pre></div>
<p>to print a decimal number in five columns with leading zeros.
</p>
<p>In place of a prefix parameter to a directive, you can put the letter
<code>V</code>, which takes an argument from <em>args</em> as a parameter to the
directive.  Normally this should be a number but it doesn&rsquo;t really have
to be.  This feature allows variable column-widths and the like.  Also,
you can use the character <code>#</code> in place of a parameter; it represents the
number of arguments remaining to be processed.
</p>
<p>Here are some relatively simple examples to give you the general
flavor of how <code>format</code> is used.
</p><div class="lisp">
<pre class="lisp">(format nil &quot;foo&quot;) =&gt; &quot;foo&quot;
(setq x 5)
(format nil &quot;The answer is ~D.&quot; x) =&gt; &quot;The answer is 5.&quot;
(format nil &quot;The answer is ~3D.&quot; x) =&gt; &quot;The answer is   5.&quot;
</pre></div>
<div class="lisp">
<pre class="lisp">(setq y &quot;elephant&quot;)
(format nil &quot;Look at the ~A!&quot; y) =&gt; &quot;Look at the elephant!&quot;
(format nil &quot;The character ~:@C is strange.&quot; 1003)
      =&gt; &quot;The character Meta-beta (Top-X) is strange.&quot;
</pre></div>
<div class="lisp">
<pre class="lisp">(setq n 3)
(format nil &quot;~D item~:P found.&quot; n) =&gt; &quot;3 items found.&quot;
(format nil &quot;~R dog~:[s are~; is~] here.&quot; n (= n 1))
      =&gt; &quot;three dogs are here.&quot;
(format nil &quot;~R dog~:*~[~1; is~:;s are~] here.&quot; n)
      =&gt; &quot;three dogs are here.&quot;
(format nil &quot;Here ~[~1;is~:;are~] ~:*~R pupp~:@P.&quot; n)
      =&gt; &quot;Here are three puppies.&quot;
</pre></div>

<p>The directives will now be described.
<em>arg</em> will be used to refer to the next argument from <em>args</em>.
</p><dl compact="compact">
<dt><code>~A</code></dt>
<dd><p><em>arg</em>, any Lisp object, is printed without slashification (as by <code>princ</code>).
<code>~:A</code> prints <code>()</code> if <em>arg</em> is <code>nil</code>; this is useful when printing
something that is always supposed to be a list.
<code>~<em>n</em>A</code> inserts spaces on the right, if necessary, to make the
column width at least <em>n</em>.  The <code>@</code> modifier causes the spaces
to be inserted on the left rather than the right.
<code>~<em>mincol,colinc,minpad,padchar</em>A</code> is the full form of <code>~A</code>,
which allows elaborate control of the padding.
The string is padded on the right with at least <em>minpad</em> copies
of <em>padchar</em>; padding characters are then inserted <em>colinc</em> characters
at a time until the total width is at least <em>mincol</em>.
The defaults are 0 for <em>mincol</em> and <em>minpad</em>, 1 for <em>colinc</em>,
and space for <em>padchar</em>.
</p>
</dd>
<dt><code>~S</code></dt>
<dd><p>This is just like <code>~A</code>, but <em>arg</em> is printed <em>with</em> slashification
(as by <code>prin1</code> rather than <code>princ</code>).
</p>
</dd>
<dt><code>~D</code></dt>
<dd><p><em>arg</em>, a number, is printed as a decimal integer.
Unlike <code>print</code>, <code>~D</code> will never put a decimal point after the number.
<code>~<em>n</em>D</code> uses a column width of <em>n</em>; spaces are inserted on
the left if the number requires less than <em>n</em> columns for its digits
and sign.  If the number doesn&rsquo;t fit in <em>n</em> columns, additional columns
are used as needed. <code>~<em>n</em>,<em>m</em>D</code> uses <em>m</em> as the pad character
instead of space.  If <em>arg</em> is not a number, it is printed
in <code>~A</code> format and decimal base.
The <code>@</code> modifier causes the number&rsquo;s sign to be printed always; the default
is only to print it if the number is negative.
The <code>:</code> modifier causes commas to be printed between groups of three digits;
the third prefix parameter may be used to change the character used as the comma.
Thus the most general form of <code>~D</code> is
<code>~<em>mincol</em>,<em>padchar</em>,<em>commachar</em>D</code>.
</p>
</dd>
<dt><code>~O</code></dt>
<dd><p>This is just like <code>~D</code> but prints in octal instead of decimal.
</p>
</dd>
<dt><code>~F</code></dt>
<dd><p><em>arg</em> is printed in floating point.  <code>~<em>n</em>F</code> rounds <em>arg</em> to a precision
of <em>n</em> digits.  The minimum value of <em>n</em> is 2, since a decimal point is
always printed.  If the magnitude of <em>arg</em> is too large or too small, it is printed
in exponential notation.  If <em>arg</em> is not a number, it is printed in
<code>~A</code> format.  Note that the prefix parameter <em>n</em> is not <em>mincol</em>; it
is the number of digits of precision desired.  Examples:
</p><div class="lisp">
<pre class="lisp">(format nil &quot;~2F&quot; 5)  =&gt;  &quot;5.0&quot;
(format nil &quot;~4F&quot; 5)  =&gt;  &quot;5.0&quot;
(format nil &quot;~4F&quot; 1.5) =&gt; &quot;1.5&quot;
(format nil &quot;~4F&quot; 3.14159265)  =&gt;  &quot;3.142&quot;
(format nil &quot;~3F&quot; 1e10)  =&gt;  &quot;1.0e10&quot;
</pre></div>

</dd>
<dt><code>~E</code></dt>
<dd><p><em>arg</em> is printed in exponential notation.  This is identical to <code>~F</code>,
including the use of a prefix parameter to specify the number of digits,
except that the number is always printed with a trailing exponent,
even if it is within a reasonable range.
</p>
</dd>
<dt><code>~$</code></dt>
<dd><p><code>~<em>rdig</em>,<em>ldig</em>,<em>field</em>,<em>padchar</em>$</code> prints
<em>arg</em>, a flonum, with exactly <em>rdig</em> digits after the decimal
point.  The default for <em>rdig</em> is 2, which is convenient for
printing amounts of money.  At least <em>ldig</em> digits will be printed
preceding the decimal point; leading zeros will be printed if there would
be fewer than <em>ldig</em>.  The default for <em>ldig</em> is 1.  The number is
right justified in a field <em>field</em>
columns long, padded out with <em>padchar</em>.  The colon modifier means
that the sign character is to be at the beginning of the field, before
the padding, rather than just to the left of the number.  The atsign modifier
says that the sign character should always be output.
</p>
<p>If <em>arg</em> is not a number, or is unreasonably large, it will be printed
in <code>~<em>field</em>,,,<em>padchar</em>@A</code> format; i.e it will be <code>princ</code>&rsquo;ed
right-justified in the specified field width.
</p>
</dd>
<dt><code>~C</code></dt>
<dd><p><code>(character <em>arg</em>)</code> is put in the output.  <em>arg</em> is treated as a
keyboard character (see <a href="#g_t_0025_0025kbd">%%kbd</a>), thus it may contain extra
control-bits.  These are printed first by representing them with
abbreviated prefixes: &quot;<code>C-</code>&quot; for <code>Control</code>, &quot;<code>M-</code>&quot; for <code>Meta</code>, &quot;<code>H-</code>&quot; for <code>Hyper</code>,
and &quot;<code>S-</code>&quot; for <code>Super</code>.
</p>
<p>With the colon flag (<code>~:C</code>), the names of the control bits are spelled out
(e.g &quot;<code>Control-Meta-F</code>&quot;) and non-printing characters
are represented by their names (e.g &quot;<code>Return</code>&quot;) rather than being output
as themselves.
</p>
<p>With both colon and atsign (<code>~:@C</code>), the colon-only format is printed, and then
if the character requires the <code>Top</code> or <code>Greek</code> (<code>Front</code>) shift key(s) to type it,
this fact is mentioned (e.g &quot;<code>universalQuantifier (Top-U)</code>&quot;).  This is the format
used for telling the user about a key he is expected to type, for instance
in prompt messages.
</p>
<p>For all three of these formats,
if the character is not a keyboard character but a mouse &quot;character&quot;,
it is printed as <code>Mouse-</code>, the name of the button, &quot;-&quot;, and the number of clicks.
</p>
<p>With just an atsign (<code>~@C</code>), the character is printed in such a way that
the Lisp reader can understand it, using &quot;<code>#/</code>&quot; or &quot;<code>#\</code>&quot;.
</p>
</dd>
<dt><code>~%</code></dt>
<dd><p>Outputs a carriage return.  <code>~<em>n</em>%</code> outputs <em>n</em> carriage returns.
No argument is used.  Simply putting a carriage return in the control string
would work, but <code>~%</code> is usually used because it makes the control string
look nicer in the Lisp source program.
</p>
</dd>
<dt><code>~&amp;</code></dt>
<dd><p>The <code>:fresh-line</code> operation is performed on the output stream.
Unless the stream knows that it is already at the front of a line,
this outputs a carriage return.  <code>~<em>n</em>&amp;</code> does a <code>:fresh-line</code> operation
and then outputs <em>n</em><code>-1</code> carriage returns.
</p>
</dd>
<dt><code>~|</code></dt>
<dd><p>Outputs a page separator character (<code>#\page</code>).  <code>~<em>n</em>|</code> does this
<em>n</em> times.  With a <code>:</code> modifier, if the output stream supports the
<code>:clear-screen</code> operation this directive clears the screen, otherwise
it outputs page separator character(s) as if no <code>:</code> modifier were
present.  <code>|</code> is vertical bar, not capital I.
</p>
</dd>
<dt><code>~X</code></dt>
<dd><p>Outputs a space.  <code>~<em>n</em>X</code> outputs <em>n</em> spaces.
</p>
</dd>
<dt><code>~~</code></dt>
<dd><p>Outputs a tilde.  <code>~<em>n</em>~@</code> outputs <em>n</em> tildes.
</p>
</dd>
<dt><code>~ &lt;CR&gt;</code></dt>
<dd><p>Tilde immediately followed by a carriage return ignores the carriage return
and any whitespace at the beginning of the next line.  With a <code>:</code>, the whitespace
is left in place.  With an <code>@</code>, the carriage return is left in place.
This directive is typically used when a format control string is too long
to fit nicely into one line of the program.
</p>
</dd>
<dt><code>~*</code></dt>
<dd><p><em>arg</em> is ignored.  <code>~<em>n</em>*</code> ignores the next <em>n</em> arguments.
<code>~:*</code> &quot;ignores backwards&quot;; that is, it backs up in the list of
arguments so that the argument last processed will be processed again.
<code>~<em>n</em>:*</code> backs up <em>n</em> arguments.  When within a <code>~{</code> construct
(see below), the ignoring (in either direction) is relative to the list
of arguments being processed by the iteration.
</p>
</dd>
<dt><code>~P</code></dt>
<dd><p>If <em>arg</em> is not <code>1</code>, a lower-case &quot;s&quot; is printed.  (&quot;<code>P</code>&quot; is for &quot;plural&quot;.)
<code>~:P</code> does the same thing, after doing a <code>~:*</code>; that is, it prints
a lower-case s if the <em>last</em> argument was not 1.  <code>~@P</code> prints &quot;y&quot;
if the argument is 1, or &quot;ies&quot; if it is not.  <code>~:@P</code> does the same thing,
but backs up first.
</p>
</dd>
<dt><code>~T</code></dt>
<dd><a name="format_002dt_002doperation"></a><p>Spaces over to a given column.  <code>~<em>n</em>,<em>m</em>T</code> will output
sufficient spaces to move the cursor to column <em>n</em>.  If the cursor
is already past column <em>n</em>, it will output spaces to move it to
column <em>n</em>+<em>mk</em>, for the smallest integer value <em>k</em> possible.
<em>n</em> and <em>m</em> default to <code>1</code>.  Without the colon flag, <em>n</em> and
<em>m</em> are in units of characters; with it, they are in units of pixels.
Note: this operation works properly <em>only</em> on streams that support
the <code>:read-cursorpos</code> and <code>:increment-cursorpos</code> stream operations
(see <a href="#read_002dcursorpos">read-cursorpos</a>).  On other streams, any <code>~T</code> operation
will simply output two spaces.  When <code>format</code> is creating
a string, <code>~T</code> will work, assuming that the first character in the string
is at the left margin.
</p>
</dd>
<dt><code>~R</code></dt>
<dd><p><code>~R</code> prints <em>arg</em> as a cardinal English number, e.g four.
<code>~:R</code> prints <em>arg</em> as an ordinal number, e.g fourth.
<code>~@R</code> prints <em>arg</em> as a Roman numeral, e.g <code>IV</code>.
<code>~:@R</code> prints <em>arg</em> as an old Roman numeral, e.g <code>IIII</code>.
</p>
<p><code>~<em>n</em>R</code> prints <em>arg</em> in radix <em>n</em>.
The flags and any remaining parameters are used as for the <code>~D</code> directive.
Indeed, <code>~D</code> is the same as <code>~10R</code>.  The full form here is therefore
<code>~<em>radix</em>,<em>mincol</em>,<em>padchar</em>,<em>commachar</em>R</code>.
</p>
</dd>
<dt><code>~<em>n</em>G</code></dt>
<dd><p>&quot;Goes to&quot; the <em>n</em>th argument.  <code>~0G</code> goes back to the
first argument in <em>args</em>.  Directives after a <code>~<em>n</em>G</code>
will take sequential arguments after the one gone to.
When within a <code>~{</code> construct, the &quot;goto&quot;
is relative to the list of arguments being processed by the iteration.
This is an &quot;absolute goto&quot;; for a &quot;relative goto&quot;, see <code>~*</code>.
</p>
</dd>
<dt><code>~[<em>str0</em>~;<em>str1</em>~;<em>...</em>~;<em>strn</em>~]</code></dt>
<dd><p>This is a set of alternative control strings.  The alternatives
(called <em>clauses</em>)
are separated by <code>~;</code> and the construct is terminated by <code>~]</code>.
For example,
</p><div class="lisp">
<pre class="lisp">&quot;~[Siamese ~;Manx ~;Persian ~;Tortoise-Shell ~
   ~;Tiger ~;Yu-Shiang ~]kitty&quot;
</pre></div>
<a name="index-kitty_002c-yu_002dshiang-1"></a>
<p>The <em>arg</em>th
alternative is selected; <code>0</code> selects the first.
If a prefix parameter is given (i.e <code>~<em>n</em>[</code>),
then the parameter is used instead of an argument
(this is useful only if the parameter is &quot;<code>#</code>&quot;).
If <em>arg</em> is out of range no alternative is selected.
After the selected alternative has been processed, the control string
continues after the <code>~]</code>.
</p>
<p><code>~[<em>str0</em>~;<em>str1</em>~;<em>...</em>~;<em>strn</em>~:;<em>default</em>~]</code> has a default case.
If the <em>last</em> <code>~;</code> used to separate clauses
is instead <code>~:;</code>, then the last clause is an &quot;else&quot; clause,
which is performed if no other clause is selected.
For example,
</p><div class="lisp">
<pre class="lisp">&quot;~[Siamese ~;Manx ~;Persian ~;Tiger ~
   ~;Yu-Shiang ~:;Bad ~] kitty&quot;
</pre></div>

<p><code>~[~<em>tag00</em>,<em>tag01</em>,<em>...</em>;<em>str0</em>~<em>tag10</em>,<em>tag11</em>,<em>...</em>;<em>str1...</em>~]</code>
allows the clauses to have explicit tags.  The parameters to each <code>~;</code>
are numeric tags for the clause which follows it.  That clause is processed
which has a tag matching the argument.  If <code>~<em>a1</em>,<em>a2</em>,<em>b1</em>,<em>b2</em>,<em>...</em>:;</code> (note the colon)
is used, then the following clause is tagged not by single values but
by ranges of values <em>a1</em> through <em>a2</em> (inclusive), <em>b1</em> through <em>b2</em>, etc.
<code>~:;</code> with no parameters may be used at the end to denote a default clause.
For example,
</p><div class="lisp">
<pre class="lisp">&quot;~[~'+,'-,'*,'//;operator ~'A,'Z,'a,'z:;letter ~
   ~'0,'9:;digit ~:;other ~]&quot;
</pre></div>

<p><code>~:[<em>false</em>~;<em>true</em>~]</code> selects the <em>false</em> control string
if <em>arg</em> is <code>nil</code>, and selects the <em>true</em> control string otherwise.
</p>
<p><code>~@[<em>true</em>~]</code> tests the argument.  If it is not <code>nil</code>,
then the argument is not used up, but is the next one to be processed,
and the one clause is processed.
If it is <code>nil</code>, then the argument is used up, and the clause is not processed.  For example,
</p><div class="lisp">
<pre class="lisp">(setq prinlevel nil prinlength 5)
(format nil &quot;~@[ PRINLEVEL=~D~]~@[ PRINLENGTH=~D~]&quot;
	    prinlevel prinlength)
   =&gt;  &quot; PRINLENGTH=5&quot;
</pre></div>

<p>The combination of <code>~[</code> and <code>#</code> is useful, for
example, for dealing with English conventions for printing lists:
</p><div class="lisp">
<pre class="lisp">(setq foo &quot;Items:~#[ none~; ~S~; ~S and ~
           ~S~:;~{~#[~1; and~] ~S~^,~}~].&quot;)
(format nil foo)
	=&gt;  &quot;Items: none.&quot;
(format nil foo 'foo)
	=&gt;  &quot;Items: FOO.&quot;
(format nil foo 'foo 'bar)
	=&gt;  &quot;Items: FOO and BAR.&quot;
(format nil foo 'foo 'bar 'baz)
	=&gt;  &quot;Items: FOO, BAR, and BAZ.&quot;
(format nil foo 'foo 'bar 'baz 'quux)
	=&gt;  &quot;Items: FOO, BAR, BAZ, and QUUX.&quot;
</pre></div>

</dd>
<dt><code>~;</code></dt>
<dd><p>Separates clauses in <code>~[</code> and <code>~&lt;</code> constructions.  It is undefined elsewhere.
</p>
</dd>
<dt><code>~]</code></dt>
<dd><p>Terminates a <code>~[</code>.  It is undefined elsewhere.
</p>
</dd>
<dt><code>~{<em>str</em>~}</code></dt>
<dd><p>This is an iteration construct.  The argument should be a list,
which is used as a set of arguments as if for a recursive call to <code>format</code>.
The string <em>str</em> is used repeatedly as the control string.
Each iteration can absorb as many elements of the list as it likes;
if <em>str</em> uses up two arguments by itself, then two elements of the
list will get used up each time around the loop.
If before any iteration step the list is empty, then the iteration is terminated.
Also, if a prefix parameter <em>n</em> is given, then there will be at most <em>n</em>
repetitions of processing of <em>str</em>.  Here are some simple examples:
</p><div class="lisp">
<pre class="lisp">(format nil &quot;Here it is:~{ ~S~}.&quot; '(a b c))
     =&gt; &quot;Here it is: A B C.&quot;
(format nil &quot;Pairs of things:~{ &lt;~S,~S&gt;~}.&quot; '(a 1 b 2 c 3))
     =&gt; &quot;Pairs of things: &lt;A,1&gt; &lt;B,2&gt; &lt;C,3&gt;.&quot;
</pre></div>

<p><code>~:{<em>str</em>~}</code> is similar, but the argument should be a list of sublists.
At each repetition step one sublist is used as the set of arguments for
processing <em>str</em>; on the next repetition a new sublist is used, whether
or not all of the last sublist had been processed.  Example:
</p><div class="lisp">
<pre class="lisp">(format nil &quot;Pairs of things:~:{ &lt;~S,~S&gt;~}.&quot;
	    '((a 1) (b 2) (c 3)))
     =&gt; &quot;Pairs of things: &lt;A,1&gt; &lt;B,2&gt; &lt;C,3&gt;.&quot;
</pre></div>

<p><code>~{<em>str</em>~}</code> is similar to <code>~{<em>str</em>~}</code>, but instead of
using one argument which is a list, all the remaining arguments
are used as the list of arguments for the iteration.  Example:
</p><div class="lisp">
<pre class="lisp">(format nil &quot;Pairs of things:~{ &lt;~S,~S&gt;~}.&quot;
	    'a 1 'b 2 'c 3)
     =&gt; &quot;Pairs of things: &lt;A,1&gt; &lt;B,2&gt; &lt;C,3&gt;.&quot;
</pre></div>

<p><code>~:{<em>str</em>~}</code> combines the features of <code>~:{<em>str</em>~}</code> and <code>~{<em>str</em>~}</code>.
All the remaining arguments
are used, and each one must be a list.
On each iteration the next argument is used as a list of arguments to <em>str</em>.
Example:
</p><div class="lisp">
<pre class="lisp">(format nil &quot;Pairs of things:~:{ &lt;~S,~S&gt;~}.&quot;
	    '(a 1) '(b 2) '(c 3))
     =&gt; &quot;Pairs of things: &lt;A,1&gt; &lt;B,2&gt; &lt;C,3&gt;.&quot;
</pre></div>

<p>Terminating the repetition construct with <code>~:@}</code> instead of <code>~@}</code>
forces <em>str</em> to be processed at least once even if the initial
list of arguments is null (however, it will not override an explicit
prefix parameter of zero).
</p>
<p>If <em>str</em> is empty, then an argument is used as <em>str</em>.  It must be a string,
and precedes any arguments processed by the iteration.  As an example,
the following are equivalent:
</p><div class="lisp">
<pre class="lisp">(lexpr-funcall #'format stream string args)
(format stream &quot;~1{~:@}&quot; string args)
</pre></div>
<p>This will use <code>string</code> as a formatting string.  The <code>~1{</code> says it will
be processed at most once, and the <code>~:}</code> says it will be processed at least once.
Therefore it is processed exactly once, using <code>args</code> as the arguments.
</p>
<p>As another example, the <code>format</code> function itself uses <code>format-error</code>
(a routine internal to the <code>format</code> package) to signal
error messages, which in turn uses <code>ferror</code>, which uses <code>format</code> recursively.  
Now <code>format-error</code> takes a string and arguments, just like <code>format</code>,
but also prints some additional information: if the control string in <code>ctl-string</code>
actually is a string (it might be a list&ndash;see below), then it prints the string
and a little arrow showing where in the processing of the control string the
error occurred.  The variable <code>ctl-index</code> points one character after the place of
the error.
</p><div class="lisp">
<pre class="lisp">(defun format-error (string &amp;rest args)
  (if (stringp ctl-string)
      (ferror nil &quot;~1{~:}~%~VTdownArrow~%~3X/&quot;~A/&quot;~%&quot;
	      string args (+ ctl-index 3) ctl-string)
      (ferror nil &quot;~1{~:}&quot; string args)))
</pre></div>
<p>This first processes the given string and arguments using <code>~1{~:}</code>, then
tabs a variable amount for printing the down-arrow, then prints the control
string between double-quotes.  The effect is something like this:
</p><div class="lisp">
<pre class="lisp">(format t &quot;The item is a ~[Foo~;Bar~;Loser~].&quot; 'quux)
&gt;&gt;ERROR: The argument to the FORMAT &quot;~[&quot; command 
         must be a number
                   downArrow
   &quot;The item is a ~[Foo~;Bar~;Loser~].&quot;
..
</pre></div>

</dd>
<dt><code>~}</code></dt>
<dd><p>Terminates a <code>~{</code>.  It is undefined elsewhere.
</p>
</dd>
<dt><code>~&lt;</code></dt>
<dd><p><code>~<em>mincol</em>,<em>colinc</em>,<em>minpad</em>,<em>padchar</em>&lt;<em>text</em>~&gt;</code>
justifies <em>text</em> within a field at least <em>mincol</em> wide.  <em>text</em>
may be divided up into segments with <code>~;</code>&ndash;the
spacing is evenly divided between the text segments.
With no modifiers, the leftmost text segment is left justified in the
field, and the rightmost text segment right justified;  if there is
only one, as a special case, it is right justified.
The <code>:</code> modifier causes
spacing to be introduced before the first text segment;  the <code>@</code>
modifier causes spacing to be added after the last.
<em>Minpad</em>, default <code>0</code>, is the minimum number of <em>padchar</em>
(default space) padding characters to be output between each segment.
If the total width needed to satisfy these constraints is greater
than <em>mincol</em>, then <em>mincol</em> is adjusted upwards in
<em>colinc</em> increments.  <em>colinc</em> defaults to <code>1</code>.  <em>mincol</em> defaults to <code>0</code>.
For example,
</p><div class="lisp">
<pre class="lisp">(format nil &quot;~10&lt;foo~;bar~&gt;&quot;)          =&gt;  &quot;foo    bar&quot;
(format nil &quot;~10:&lt;foo~;bar~&gt;&quot;)         =&gt;  &quot;  foo  bar&quot;
(format nil &quot;~10:@&lt;foo~;bar~&gt;&quot;)        =&gt;  &quot;  foo bar &quot;
(format nil &quot;~10&lt;foobar~&gt;&quot;)            =&gt;  &quot;    foobar&quot;
(format nil &quot;~10:&lt;foobar~&gt;&quot;)           =&gt;  &quot;    foobar&quot;
(format nil &quot;~10@&lt;foobar~&gt;&quot;)           =&gt;  &quot;foobar    &quot;
(format nil &quot;~10:@&lt;foobar~&gt;&quot;)          =&gt;  &quot;  foobar  &quot;
(format nil &quot;$~10,,,'*&lt;~3f~&gt;&quot; 2.59023) =&gt;  &quot;$******2.59&quot;
</pre></div>

<p>Note that <em>text</em> may include format directives.  The last example
illustrates how the <code>~&lt;</code> directive can be combined with the <code>~f</code>
directive to provide more advanced control over the formatting of
numbers.
</p>
<p>Here are some examples of the use of <code>~^</code> within a <code>~&lt;</code> construct.
<code>~^</code> is explained in detail below, however the general idea is that
it eliminates the segment in which it appears and all following segments
if there are no more arguments.
</p><div class="lisp">
<pre class="lisp">(format nil &quot;~15&lt;~S~;~^~S~;~^~S~&gt;&quot; 'foo)
	=&gt;  &quot;            FOO&quot;
(format nil &quot;~15&lt;~S~;~^~S~;~^~S~&gt;&quot; 'foo 'bar)
	=&gt;  &quot;FOO         BAR&quot;
(format nil &quot;~15&lt;~S~;~^~S~;~^~S~&gt;&quot; 'foo 'bar 'baz)
	=&gt;  &quot;FOO   BAR   BAZ&quot;
</pre></div>

<p>The idea is that if a segment contains a <code>~^</code>, and <code>format</code> runs out
of arguments, it just stops there instead of getting an error, and it as
well as the rest of the segments are ignored.
</p>
<a name="ultra_002dhairy_002dprint_002dlist"></a><p>If the first clause of a <code>~&lt;</code> is terminated with <code>~:;</code> instead of <code>~;</code>,
then it is used in a special way.  All of the clauses are processed
(subject to <code>~^</code>, of course), but the first one is omitted in
performing the spacing and padding.  When the padded result has been
determined, then if it will fit on the current line of output, it is output,
and the text for the first clause is discarded.  If, however, the padded text
will not fit on the current line, then the
text segment for the first clause is output before the padded text.  The first clause ought
to contain a carriage return (<code>~%</code>).  The first clause is
always processed, and so any arguments it refers to will be used;
the decision is whether to use the resulting segment of text, not whether to
process the first clause.  If the <code>~:;</code> has a prefix parameter <em>n</em>, then
the padded text must fit on the current line with <em>n</em> character positions to spare
to avoid outputting the first clause&rsquo;s text.
For example, the control string
</p><div class="lisp">
<pre class="lisp">&quot;~%;; ~{~&lt;~%;; ~1:; ~S~&gt;~^,~}.~%&quot;
</pre></div>
<p>can be used to print a list of items separated by commas, without
breaking items over line boundaries, and beginning each line with
&quot;<code>;; </code>&quot;.  The prefix parameter <code>1</code> in <code>~1:;</code> accounts for the width of the
comma which will follow the justified item if it is not the last
element in the list, or the period if it is.  If <code>~:;</code> has a second
prefix parameter, then it is used as the width of the line,
thus overriding the natural line width of the output stream.  To make
the preceding example use a line width of 50, one would write
</p><div class="lisp">
<pre class="lisp">&quot;~%;; ~{~&lt;~%;; ~1,50:; ~S~&gt;~^,~}.~%&quot;
</pre></div>

<p>If the second argument is not specified, then <code>format</code> sees whether
the stream handles the <code>:size-in-characters</code> message.  If it does,
then <code>format</code> sends that message and uses the first returned value as
the line length in characters.  If it doesn&rsquo;t, <code>format</code> uses <code>95.</code>
as the line length.
</p>
<p>Rather than using this complicated syntax, one can often call the function
<code>format:print-list</code> (see <a href="#format_003aprint_002dlist_002dfun">format:print-list-fun</a>).
</p>
</dd>
<dt><code>~&gt;</code></dt>
<dd><p>Terminates a <code>~&lt;</code>.  It is undefined elsewhere.
</p>
</dd>
<dt><code>~^</code></dt>
<dd><p>This is an escape construct.  If there are no more arguments remaining
to be processed, then the immediately enclosing <code>~{</code> or <code>~&lt;</code>
construct is terminated.  If there is no such enclosing construct, then
the entire formatting operation is terminated.
In the <code>~&lt;</code> case, the formatting <em>is</em> performed, but no
more segments are processed before doing the justification.
The <code>~^</code> should appear only at the <em>beginning</em> of a <code>~&lt;</code> clause,
because it aborts the entire clause.  <code>~^</code> may appear anywhere in a <code>~{</code> construct.
</p>
<p>If a prefix parameter is given, then termination occurs if the parameter
is zero.  (Hence <code>~^</code> is the same as <code>~#^</code>.)  If two parameters are
given, termination occurs if they are equal.  If three are given, termination
occurs if the second is between the other two in ascending order.  Of course,
this is useless if all the prefix parameters are constants; at least one
of them should be a <code>#</code> or a <code>V</code> parameter.
</p>
<p>If <code>~^</code> is used within a <code>~:{</code> construct, then it merely terminates
the current iteration step (because in the standard case it tests for
remaining arguments of the current step only); the next iteration step
commences immediately.  To terminate the entire iteration process,
use <code>~:^</code>.
</p>
</dd>
<dt><code>~Q</code></dt>
<dd><p>An escape to arbitrary user-supplied code.  <em>arg</em> is called as a function;
its arguments are the prefix parameters to <code>~Q</code>, if any.  <em>args</em> can be
passed to the function by using the <code>V</code> prefix parameter.  The function may
output to <code>standard-output</code> and may look at the variables <code>format:colon-flag</code>
and <code>format:atsign-flag</code>, which are <code>t</code> or <code>nil</code> to reflect the
<code>:</code> and <code>@</code> modifiers on the <code>~Q</code>.  For example,
</p><div class="lisp">
<pre class="lisp">(format t &quot;~VQ&quot; foo bar)
</pre></div>
<p>is a fancy way to say
</p><div class="lisp">
<pre class="lisp">(funcall bar foo)
</pre></div>
<p>and discard the value.
Note the reversal of order; the <code>V</code> is processed before the <code>Q</code>.
</p>
</dd>
<dt><code>~\</code></dt>
<dd><p>This begins a directive whose name is longer than one character.
The name is terminated by another <code>\</code> character.
The following directives have names longer than one character
and make use of the <code>~\</code> mechanism as part of their operation.
</p>
</dd>
<dt><code>~\date\</code></dt>
<dd><p>This expects an argument that is a universal time (see
<a href="#universal_002dtime">universal-time</a>), and prints it as a date and time using
<code>time:print-universal-date</code>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(format t &quot;It is now ~\date\&quot; (time:get-universal-time))
</pre><pre class="lisp">prints
</pre><pre class="lisp">It is now Saturday the fourth of December, 1982; 4:00:32 am
</pre></div>

</dd>
<dt><code>~\time\</code></dt>
<dd><p>This expects an argument that is a universal time (see
<a href="#universal_002dtime">universal-time</a>), and prints it in a brief format using
<code>time:print-universal-time</code>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(format t &quot;It is now ~\time\&quot; (time:get-universal-time))
</pre><pre class="lisp">prints
</pre><pre class="lisp">It is now 12/04/82 04:01:38
</pre></div>

</dd>
<dt><code>~\datime\</code></dt>
<dd><p>This prints the current time and date.  It does not use an argument.
It is equivalent to using the <code>~\time\</code> directive with
<code>(time:get-universal-time)</code> as argument.
</p>
</dd>
<dt><code>~\time-interval\</code></dt>
<dd><p>This prints a time interval measured in seconds using the function
<code>time:print-interval-or-never</code>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(format t &quot;It took ~\time-interval\.&quot; 3601.)
</pre><pre class="lisp">prints
</pre><pre class="lisp">It took 1 hour 1 second.
</pre></div>
</dd>
</dl>

<p>You can define your own directives.  How to do this is not documented
here; read the code.  Names of user-defined directives longer than one
character may be used if they are enclosed in backslashes (e.g
<code>~4,3\GRAPH\</code>).
</p>
<p>(Note: <code>format</code> also allows <em>control-string</em> to be a list.  If the
list is a list of one element, which is a string, the string is simply
printed.  This is for the use of the <code>format:outfmt</code> function below.
The old feature wherein a more complex interpretation of this list was
possible is now considered obsolete; use <code>format:output</code> if you like
using lists.)
</p>
<p>A condition instance can also be used as the <em>control-string</em>.  Then
the <code>:report</code> operation is used to print the condition instance;
any other arguments are ignored.  This way, you can pass a condition
instance directly to any function that normally expects a format string
and arguments.
</p>
<a name="format_003aprint_002dlist_002dfun"></a><dl>
<dt><a name="index-format_003aprint_002dlist"></a>Function: <strong>format:print-list</strong> <em>destination element-format list &amp;optional separator start-line tilde-brace-options</em></dt>
<dd><p>This function provides a simpler interface for the specific purpose of
printing comma-separated lists with no list element split across two
lines; see the description of the <code>~:;</code> directive
(<a href="#ultra_002dhairy_002dprint_002dlist">ultra-hairy-print-list</a>) to see the more complex way to do this
within <code>format</code>.  <em>destination</em> tells where to send the output; it
can be <code>t</code>, <code>nil</code>, a <code>string-nconc</code>-able string, or a stream, as
with <code>format</code>.  <em>element-format</em> is a <code>format</code> control-string
that tells how to print each element of <em>list</em>; it is used as the
body of a <code>&quot;~{...~}&quot;</code> construct.  <em>separator</em>, which defaults to
<code>&quot;, &quot;</code> (comma, space) is a string which goes after each element
except the last.  <code>format</code> control commands are not recommended in
<em>separator</em>.  <em>start-line</em>, which defaults to three spaces, is a
<code>format</code> control-string that is used as a prefix at the beginning of
each line of output, except the first.  <code>format</code> control commands are
allowed in <em>separator</em>, but they should not swallow arguments from
<em>list</em>.  <em>tilde-brace-options</em> is a string inserted before the
opening <code>&quot;{&quot;</code>; it defaults to the null string, but allows you to
insert colon and/or atsign.  The line-width of the stream is computed
the same way that the <code>~:;</code> command computes it;
it is not possible to override the natural line-width of the stream.
</p></dd></dl>


<a name="The-Output-Subsystem"></a>
<h4 class="subsection">21.6.2 The Output Subsystem</h4>

<p>The formatting functions associated with the <code>format:output</code> subsystem allow
you to do formatted output using Lisp-style control structure.  Instead
of a directive in a <code>format</code> control string, there is one formatting
function for each kind of formatted output.
</p>
<p>The calling conventions of the formatting functions are all similar.
The first argument is usually the datum to be output.  The second
argument is usually the minimum number of columns to use.  The
remaining arguments are options&ndash;alternating keywords and values.
</p>
<p>Options which most functions accept include <code>:padchar</code>, followed
by a character to use for padding; <code>:minpad</code>, followed by the
minimum number of padding characters to output after the data; and
<code>:tab-period</code>, followed by the distance between allowable places
to stop padding.  To make the meaning of <code>:tab-period</code> clearer, if
the value of <code>:tab-period</code> is 5, the minimum size of the field
is 10, and the value of <code>:minpad</code> is 2, then a datum that takes 9
characters will be padded out to 15 characters.  The requirement to
use at least two characters of padding means it can&rsquo;t fit into 10
characters, and the <code>:tab-period</code> of 5 means the next allowable
stopping place is at 10+5 characters.  The default values for
<code>:minpad</code> and <code>:tab-period</code>, if they are not specified, are
zero and one.  The default value for <code>:padchar</code> is space.
</p>
<p>The formatting functions always output to <code>standard-output</code> and do
not require an argument to specify the stream.  The macro
<code>format:output</code> allows you to specify the stream or a string, just
as <code>format</code> does, and also makes it convenient to concatenate
constant and variable output.
</p>
<a name="format_003aoutput_002dfun"></a><dl>
<dt><a name="index-format_003aoutput"></a>Macro: <strong>format:output</strong> <em>stream string-or-form...</em></dt>
<dd><p><code>format:output</code> makes it convenient to intersperse arbitrary output
operations with printing of constant strings.
<code>standard-output</code> is bound to <em>stream</em>, and each <em>string-or-form</em>
is processed in succession from left to right.  If it is a string, it is
printed; otherwise it is a form, which is evaluated for effect.  Presumably
the forms will send output to <code>standard-output</code>.
</p>
<p>If <em>stream</em> is written as <code>nil</code>, then the output is put into a
string which is returned by <code>format:output</code>.  If <em>stream</em> is written
as <code>t</code>, then the output goes to the prevailing value of
<code>standard-output</code>.  Otherwise <em>stream</em> is a form, which must evaluate
to a stream.
</p>
<p>Here is an example:
</p><div class="lisp">
<pre class="lisp">(format:output t &quot;FOO is &quot; (prin1 foo) &quot; now.&quot; (terpri))
</pre></div>

<p>Because <code>format:output</code> is a macro, what matters about <em>stream</em> is
not whether it <em>evaluates</em> to <code>t</code> or <code>nil</code>, but whether it
is actually written as <code>t</code> or <code>nil</code>.
</p></dd></dl>

<a name="format_003aoutfmt_002dfun"></a><dl>
<dt><a name="index-format_003aoutfmt"></a>Macro: <strong>format:outfmt</strong> <em>string-or-form...</em></dt>
<dd><p>Some system functions ask for a <code>format</code> control string and
arguments, to be printed later.  If you wish to generate the output
using the formatted output functions, you can use <code>format:outfmt</code>, which
produces a control argument that will eventually make <code>format</code>
print the desired output (this is a list whose one element is a string
containing the output).  A call to <code>format:outfmt</code> can be used as
the second argument to <code>ferror</code>, for example:
</p><div class="lisp">
<pre class="lisp">(ferror nil (format:outfmt &quot;Foo is &quot; (format:onum foo) 
			   &quot; which is too large&quot;))
</pre></div>
</dd></dl>

<a name="format_003aonum_002dfun"></a><dl>
<dt><a name="index-format_003aonum"></a>Function: <strong>format:onum</strong> <em>number &amp;optional radix minwidth &amp;rest options</em></dt>
<dd><p><code>format:onum</code> outputs <em>number</em> in base <em>radix</em>, padding to at least
<em>minwidth</em> columns and obeying the other padding options specified
as described above.
</p>
<p><em>radix</em> can be a number, or it can be <code>:roman</code>, <code>:english</code>,
or <code>:ordinal</code>.  The default <em>radix</em> is <code>10</code> (decimal).
</p>
<p>Two special keywords are allowed as options: <code>:signed</code> and
<code>:commas</code>.  <code>:signed</code> with value <code>t</code> means print a sign even if
the number is positive.  <code>:commas</code> with value <code>t</code> means print a
comma every third digit in the customary way.  These options are
meaningful only with numeric radices.
</p></dd></dl>

<a name="format_003aofloat_002dfun"></a><dl>
<dt><a name="index-format_003aofloat"></a>Function: <strong>format:ofloat</strong> <em>number &amp;optional n-digits force-exponential-notation minwidth &amp;rest options</em></dt>
<dd><p><code>format:ofloat</code> outputs <em>number</em> as a floating point number using
<em>n-digits</em> digits.  If <em>force-exponential-notation</em> is
non-<code>nil</code>, then an exponent is always used.  <em>minwidth</em> and
<em>options</em> are used to control padding as usual.
</p></dd></dl>

<a name="format_003aostring_002dfun"></a><dl>
<dt><a name="index-format_003aostring"></a>Function: <strong>format:ostring</strong> <em>string &amp;optional minwidth &amp;rest options</em></dt>
<dd><p><code>format:ostring</code> outputs <em>string</em>, padding to at least
<em>minwidth</em> columns if <em>minwidth</em> is not <code>nil</code>, and obeying
the other padding options specified as described above.
</p>
<p>Normally the contents of the string are left-justified; any padding
follows the data.  The special option <code>:right-justify</code> causes the
padding to come before the data.  The amount of padding is not
affected.
</p>
<p>The argument need not really be a string.  Any Lisp object is allowed,
and it is output by <code>princ</code>.
</p></dd></dl>

<a name="format_003aoprint_002dfun"></a><dl>
<dt><a name="index-format_003aoprint"></a>Function: <strong>format:oprint</strong> <em>object &amp;optional minwidth &amp;rest options</em></dt>
<dd><p><code>format:oprint</code> prints <em>object</em>, any Lisp object, padding to at
least <em>minwidth</em> columns if <em>minwidth</em> is not <code>nil</code>, and
obeying the padding options specified as described above.
</p>
<p>Normally the data are left justified; any padding follows.  The
special option <code>:right-justify</code> causes the padding to come before
the data.  The amount of padding is not affected.
</p>
<p>The printing of the object is done with <code>prin1</code>.
</p></dd></dl>

<a name="format_003aochar_002dfun"></a><dl>
<dt><a name="index-format_003aochar"></a>Function: <strong>format:ochar</strong> <em>character &amp;optional style top-explain minwidth &amp;rest options</em></dt>
<dd><p><code>format:ochar</code> outputs <em>character</em> in one of three styles, selected
by the <em>style</em> argument.  <em>minwidth</em> and <em>options</em> control
padding as usual.
</p>
<dl compact="compact">
<dt><code>:read <span class="roman">or</span> nil</code></dt>
<dd><p>The character is printed using <code>#/</code> or <code>#\</code> so that it could be read
back in.
</p>
</dd>
<dt><code>:editor</code></dt>
<dd><p>Output is in the style of
the string <code>&quot;Meta-Rubout&quot;</code>.  If the character has a name, the name is
used instead of the character.
</p>
</dd>
<dt><code>:brief</code></dt>
<dd><p>Brief prefixes such as <code>&quot;C-&quot;</code> and
<code>&quot;M-&quot;</code> are used, rather than <code>&quot;Control-&quot;</code> or <code>&quot;Meta-&quot;</code>.  Also,
character names are used only if there are meta bits present.
</p>
</dd>
<dt><code>:lozenged</code></dt>
<dd><p>The output is the same as that of the <code>:editor</code> style, but If the
character is not a graphic character or if it has meta bits, and the
stream supports the <code>:display-lozenged-string</code> operation, that
operation is used instead of <code>:string-out</code> to print the text.  On
windows this operation puts the character name inside a lozenge.
</p>
</dd>
<dt><code>:sail</code></dt>
<dd><p><code></code>, <code></code>, etc are used to represent &quot;<code>Control</code>&quot; and &quot;<code>Meta</code>&quot;,
and shorter names for characters are also used when possible.  See
<a href="#character_002dset">character-set</a>.
</p></dd>
</dl>

<p><em>top-explain</em> is useful with the <code>:editor</code>, <code>:brief</code> and
<code>:sail</code>
styles.  It says that any character that has to be typed using the
Top or Greek keys should be followed by an explanation of how to type
it.  For example: <code>&quot;rightArrow (Top-K)&quot;</code> or <code>&quot;alpha (Greek-a)&quot;</code>.
</p></dd></dl>

<a name="format_003atab_002dfun"></a><dl>
<dt><a name="index-format_003atab"></a>Function: <strong>format:tab</strong> <em>mincol &amp;rest options</em></dt>
<dd><p><code>format:tab</code> outputs padding at least until column <em>mincol</em>.  It
is the only formatting function that bases its actions on the actual
cursor position rather than the width of what is being output.  The
padding options <code>:padchar</code>, <code>:minpad</code>, and <code>:tab-period</code> are
obeyed.  Thus, at least the <code>:minpad</code> number of padding characters
are output even if that goes past <em>mincol</em>, and once past
<em>mincol</em>, padding can only stop at a multiple of <code>:tab-period</code>
characters past <em>mincol</em>.
</p>
<p>In addition, if the <code>:terpri</code> option is <code>t</code>, then if column
<em>mincol</em> is passed, <code>format:tab</code> starts a new line and indents it
to <em>mincol</em>.
</p>
<p>The <code>:unit</code> option specifies the units of horizontal position.
The default is to count in units of characters.  If <code>:unit</code> is
specified as <code>:pixel</code>, then the computation (and the argument
<em>mincol</em> and the <code>:minpad</code> and <code>:tab-period</code> options) are
in units of pixels.
</p></dd></dl>

<a name="format_003apad_002dfun"></a><dl>
<dt><a name="index-format_003apad"></a>Macro: <strong>format:pad</strong> <em>(minwidth option...) body...</em></dt>
<dd><p><code>format:pad</code> is used for printing several items in a fixed amount of
horizontal space, padding between them to use up any excess space.
Each of the <em>body</em> forms prints one item.  The padding goes between
items.  The entire <code>format:pad</code> always uses at least <em>minwidth</em>
columns; any columns that the items don&rsquo;t need are distributed as
padding between the items.  If that isn&rsquo;t enough space, then more
space is allocated in units controlled by the <code>:tab-period</code> option
until there is enough space.  If it&rsquo;s more than enough, the excess is
used as padding.
</p>
<p>If the <code>:minpad</code> option is specified, then at least that many pad
characters must go between each pair of items.
</p>
<p>Padding goes only between items.  If you want to treat several actual
pieces of output as one item, put a <code>progn</code> around them.  If you
want padding before the first item or after the last, as well as
between the items, include a dummy item <code>nil</code> at the beginning or
the end.
</p>
<p>If there is only one item, it is right justified.  One item followed by
<code>nil</code> is left-justified.  One item preceded and followed by <code>nil</code> is
centered.  Therefore, <code>format:pad</code> can be used to provide the usual
padding options for a function that does not provide them itself.
</p></dd></dl>

<a name="format_003aplural_002dfun"></a><dl>
<dt><a name="index-format_003aplural"></a>Function: <strong>format:plural</strong> <em>number singular &amp;optional plural</em></dt>
<dd><p><code>format:plural</code> outputs either the singular or the plural form of a
word depending on the value of <em>number</em>.  The singular is used if and only if
<em>number</em> is 1.  <em>singular</em> specifies the singular form of the word.
<code>string-pluralize</code> is used to compute the plural, unless
<em>plural</em> is explicitly specified.
</p>
<p>It is often useful for <em>number</em> to be a value returned by
<code>format:onum</code>, which returns its argument.  For example:
</p><div class="lisp">
<pre class="lisp">(format:plural (format:onum n-frobs) &quot; frob&quot;)
</pre></div>
<p>will print &quot;1 frob&quot; or &quot;2 frobs&quot;.
</p></dd></dl>

<a name="format_003abreakline_002dfun"></a><dl>
<dt><a name="index-format_003abreakline"></a>Macro: <strong>format:breakline</strong> <em>linel print-if-terpri print-always...</em></dt>
<dd><p><code>format:breakline</code> is used to go to the next line if there is
not enough room for something to be output on the current line.
The <em>print-always</em> forms print the text which is supposed to fit
on the line.  <em>linel</em> is the column before which the text must end.
If it doesn&rsquo;t end before that column, then <code>format:breakline</code>
moves to the next line and executes the <em>print-if-terpri</em> form
before doing the <em>print-always</em> forms.
</p>
<p>Constant strings are allowed as well as forms for <em>print-if-terpri</em>
and <em>print-always</em>.  A constant string is just printed.
</p>
<p>To go to a new line unconditionally, simply call <code>terpri</code>.
</p>
<p>Here is an example that prints the elements of a list,
separated by commas, breaking lines between elements when necessary.
</p>
<div class="lisp">
<pre class="lisp">(defun pcl (list linel)
  (do ((l list (cdr l))) ((null l))
    (format:breakline linel &quot;  &quot;
      (princ (car l))
      (and (cdr l) (princ &quot;, &quot;)))))
</pre></div>
</dd></dl>


<a name="Formatting-Lisp-Code"></a>
<h4 class="subsection">21.6.3 Formatting Lisp Code</h4>
<a name="index-formatting-lisp-code"></a>
<a name="index-pretty_002dprinting"></a>
<a name="index-grinding"></a>


<a name="grindef_002dfun"></a><dl>
<dt><a name="index-grindef"></a>Special Form: <strong>grindef</strong> <em>function-spec...</em></dt>
<dd><a name="grind"></a><p>Prints the definitions of one or more functions, with indentation to make the code
readable.  Certain other &quot;pretty-printing&quot; transformations are performed:  The <code>quote</code>
special form is represented with the <code>'</code> character.  Displacing macros are
printed as the original code rather than the result of macro expansion.
The code resulting from the backquote (<code>`</code>) reader macro is represented
in terms of <code>`</code>.
</p>
<p>The subforms to <code>grindef</code> are the function specs whose
definitions are to be printed; the usual way <code>grindef</code> is used
is with a form like <code>(grindef foo)</code> to print the definition
of <code>foo</code>.  When one of these subforms is a symbol, if
the symbol has a value its value is prettily printed also.  Definitions are
printed as <code>defun</code> special forms, and values are printed as <code>setq</code> special
forms.
</p>
<p>If a function is compiled, <code>grindef</code> will say so and try to find its
previous interpreted definition by looking on an associated property
list (see <code>uncompile</code> (<a href="#uncompile_002dfun">uncompile-fun</a>).  This will only work if the
function&rsquo;s interpreted definition was once in force; if the definition
of the function was simply loaded from a QFASL file, <code>grindef</code> will
not find the interpreted definition and will not be able to do anything
useful.
</p>
<p>With no subforms, <code>grindef</code> assumes the same arguments as when it was
last called.
</p></dd></dl>

<a name="grind_002dtop_002dlevel_002dfun"></a><dl>
<dt><a name="index-grind_002dtop_002dlevel"></a>Function: <strong>grind-top-level</strong> <em>obj &amp;optional width (stream <code>standard-output</code>) (untyo-p <code>nil</code>) (displaced <code>'si:displaced</code>) (terpri-p <code>t</code>) notify-fun loc</em></dt>
<dd><p>Pretty-prints <em>obj</em> on <em>stream</em>, putting up to <em>width</em> characters
per line.  This is the primitive interface to the pretty-printer.  Note that it does not
support variable-width fonts.  If the <em>width</em> argument is supplied, it is how many
characters wide the output is to be.  If <em>width</em> is unsupplied or <code>nil</code>,
<code>grind-top-level</code> will try to figure out the &quot;natural width&quot; of the stream,
by sending a <code>:size-in-characters</code> message to the stream and using the first
returned value.  If the stream doesn&rsquo;t handle that message, a width of <code>95.</code>
characters is used instead.
</p>
<p>The remaining optional arguments activate various strange features and usually should not
be supplied.  These options are for internal use by the system and are documented
here for only completeness.
If <em>untyo-p</em> is <code>t</code>, the <code>:untyo</code> and <code>:untyo-mark</code> operations will
be used on <em>stream</em>, speeding up the algorithm somewhat.  <em>displaced</em> controls the
checking for displacing macros; it is the symbol which flags a place that has been
displaced, or <code>nil</code> to disable the feature.
If <em>terpri-p</em> is <code>nil</code>, <code>grind-top-level</code> does
not advance to a fresh line before printing.
</p>
<p>If <em>notify-fun</em> is non-<code>nil</code>, it is a function that takes three
arguments, which is called for each &quot;token&quot; in the pretty-printed
output.  Tokens are atoms, open and close parentheses, and reader macro
characters such as <code>'</code>.  The arguments to <em>notify-fun</em> are the
token, its &quot;location&quot; (see next paragraph), and <code>t</code> if it is an atom
or <code>nil</code> if it is a character.
</p>
<p><em>loc</em> is the &quot;location&quot; (typically a cons) whose car is <em>obj</em>.  As the
grinder recursively descends through the structure being printed, it keeps track
of the location where each thing came from, for the benefit of the <em>notify-fun</em>,
if any.  This makes it possible for a program to correlate the printed output
with the list structure.  The &quot;location&quot; of a close parenthesis is <code>t</code>, because
close parentheses have no associated location.
</p></dd></dl>


<a name="g_t_0022Rubout-Handling_0022"></a>
<h3 class="section">21.7 &quot;Rubout Handling&quot;</h3>
<a name="rubout_002dhandler"></a><a name="rubout_002dhandling"></a><a name="index-rubout-handler"></a>

<p>The rubout handler is a feature of all interactive streams, that is, streams
that connect to terminals.  Its purpose is to allow the user to edit
minor mistakes in type-in.  At the same time, it is not supposed to
get in the way; input is to be seen by Lisp as soon as a syntactically complete
form has been typed.  The definition of &quot;syntactically complete form&quot;
depends on the function that is reading from the stream; for <code>read</code>, it
is a Lisp expression.
</p>
<p>Some interactive streams (&quot;editing Lisp listeners&quot;) have a rubout handler
that allows input to be edited with the full power of the ZWEI editor.
Most windows have a rubout handler that apes ZWEI, implementing about twenty
common ZWEI commands.  The cold load stream has
a simple rubout handler that allows just rubbing out of single
characters, and a few simple commands like clearing the screen and
erasing the entire input typed so far.  All three kinds of rubout
handler use the same protocol, which is described in this section.  We
also say a little about the most common of the three rubout handlers.
[Eventually some version of ZWEI will be used for all streams
except the cold load stream]
</p>
<p>The tricky thing about the rubout handler is the need for it to figure
out when you are all done.  The idea of a rubout handler is that you can
type in characters, and they are saved up in a buffer so that if you
change your mind, you can rub them out and type different characters.
However, at some point, the rubout handler has to decide that the time
has come to stop putting characters into the buffer and to let the
function parsing the input, such as <code>read</code>, return.  This is
called &quot;activating&quot;.  The right time to activate depends on the function
calling the rubout handler, and may be very complicated (if the function
is <code>read</code>, figuring out when one Lisp expression has been typed
requires knowledge of all the various printed representations, what all
currently-defined reader macros do, and so on).  Rubout handlers should
not have to know how to parse the characters in the buffer to
figure out what the caller is reading and when to activate; only the
caller should have to know this.  The rubout handler interface is
organized so that the calling function can do all the parsing, while the
rubout handler does all the handling of rubouts, and the two are kept
completely separate.
</p>
<p>The basic way that the rubout handler works is as follows.  When
an input function that reads characters from a stream, such as <code>read</code> or <code>readline</code>
(but not <code>tyi</code>), is invoked with a stream which has <code>:rubout-handler</code>
in its <code>:which-operations</code> list, that function &quot;enters&quot; the rubout handler.
It then goes ahead <code>:tyi</code>&rsquo;ing characters from the stream.  Because control
is inside the rubout handler, the stream will echo these characters so the user
can see what he is typing.  (Normally echoing is considered to be a higher-level
function outside of the province of streams, but when the higher-level function
tells the stream to enter the rubout handler it is also handing it the responsibility
for echoing.)  The rubout handler is also saving all these characters in a buffer,
for reasons disclosed in the following paragraph.
When the function, <code>read</code> or whatever, decides it has enough
input, it returns and control &quot;leaves&quot; the rubout handler.  That was the easy case.
</p>
<p>If the user types a rubout, a <code>*throw</code> is done out of all recursive levels
of <code>read</code>, reader macros, and so forth, back to the point where the rubout
handler was entered.  Also the rubout is echoed by erasing from the screen
the character which was rubbed out.  Now the <code>read</code> is tried over again,
re-reading all the characters that have not been rubbed out, not echoing
them this time.  When the saved characters have been exhausted, additional input is read
from the user in the usual fashion.
</p>
<p>The effect of this is a complete separation of the functions of rubout
handling and parsing, while at the same time mingling the execution of
these two functions in such a way that input is always &quot;activated&quot; at
just the right time.  It does mean that the parsing function (in the
usual case, <code>read</code> and all macro-character definitions) must be
prepared to be thrown through at any time and should not have
non-trivial side-effects, since it may be called multiple times.
</p>
<p>If an error occurs while inside the rubout handler, the error message is printed
and then additional characters are read.  When the user types a rubout,
it rubs out the error message as well as the character that caused the error.
The user can then proceed to type the corrected expression;
the input will be reparsed from the beginning in the usual fashion.
</p>
<p>The rubout handler based on the ZWEI editor interprets control
characters in the usual ZWEI way: as editing commands, allowing you to
edit your buffered input.
</p>
<p>The common rubout handler also recognizes a subset of the editor
commands, including <code>Rubout</code>, <code>Control-F</code> and <code>Meta-F</code> and others.
Typing <code>Help</code> while in the rubout handler displays a list of the
commands.  The kill and yank commands in the rubout handler use the same
kill ring as the editor, so you can kill an expression in the editor and
yank it back into a rubout handler with <code>Control-Y</code>, or kill an
expression in the rubout handler with <code>Control-K</code> or <code>Clear-input</code>
and yank it back in the editor.  The rubout processor also keeps a ring
buffer of most recent input strings (a separate ring for each stream),
and the commands <code>Control-C</code> and <code>Meta-C</code> retrieve from this ring
just as <code>Control-Y</code> and <code>Meta-Y</code> do from the kill ring.
</p>
<p>When not inside the rubout handler, and when
typing at a program that uses control characters for its own purposes,
control characters are treated the same as ordinary characters.
</p>
<p>Some programs such as the debugger allow the user to type either a
control character or an expression.  In such programs, you are really
not inside the rubout handler unless you have typed the beginning of an
expression.  When the input buffer is empty, a control character is
treated as a command for the program (such as, <code>Control-C</code> to continue
in the debugger); when there is text in the rubout handler buffer, the
same character is treated as a rubout handler command.  Another
consequence of this is that the message you get by typing <code>Help</code>
varies, being either the rubout handler&rsquo;s documentation or the
debugger&rsquo;s documentation. 
</p>
<p>The following explanation tells you how to write your own function
that invokes the rubout handler.  The functions <code>read</code> and <code>readline</code>
both work this way.  You should use the <code>readline1</code> example, below,
as a template for writing your own function.
</p>
<p>The way that the rubout handler is entered is complicated, since a
<code>*catch</code> must be established.  The variable <code>rubout-handler</code> is
non-<code>nil</code> if the current process is inside the rubout handler.  This is
used to handle recursive calls to <code>read</code> from inside reader macros and the
like.  If <code>rubout-handler</code> is <code>nil</code>, and the stream being read from
has <code>:rubout-handler</code> in its <code>:which-operations</code>, functions such as
<code>read</code> send the <code>:rubout-handler</code> message to the stream with arguments
of a list of options, the function, and its arguments.  The rubout handler
initializes itself and establishes its <code>*catch</code>, then calls back to the
specified function with <code>rubout-handler</code> bound to <code>t</code>.  User-written input
reading functions should follow this same protocol to get the same input
editing benefits as <code>read</code> and <code>readline</code>.
</p>
<a name="rubout_002dhandler_002dvar"></a><dl>
<dt><a name="index-rubout_002dhandler"></a>Variable: <strong>rubout-handler</strong></dt>
<dd><p><code>t</code> if control is inside the rubout handler in this process.
</p></dd></dl>

<p>As an example of how to use the rubout handler, here is a simplified
version of the <code>readline</code> function.  It doesn&rsquo;t bother about end-of-file
handling, use of <code>:line-in</code> for efficiency, etc.
</p><div class="lisp">
<pre class="lisp">(defun readline1 (stream)
  <span class="roman">;; If stream does rubout handling, get inside rubout handler</span>
  (cond ((and (not rubout-handler)
	      (memq ':rubout-handler
		    (funcall stream ':which-operations)))
	 (funcall stream ':rubout-handler '() #'readline1 stream))
	<span class="roman">;; Accumulate characters until <code>Return</code></span>
	(t (do ((ch (funcall stream ':tyi)
		    (funcall stream ':tyi))
		(len 100)
		(string (make-array 100 ':type 'art-string))
		(idx 0))
	       ((or (null ch) (= ch #\return))
		(adjust-array-size string idx)
		string)
	     (if (= idx len)
		 (adjust-array-size string (setq len (+ len 40))))
	     (aset ch string idx)
	     (setq idx (1+ idx))))))
</pre></div>

<p>The first argument to the <code>:rubout-handler</code> message is a list of
options.  The second argument is the function that the rubout handler
should call to do the reading, and the rest of the arguments are passed
to that function.  Note that in the example above, <code>readline1</code> is
sending the <code>:rubout-handler</code> message passing itself as the function,
and its own arguments as the arguments.  This is the usual thing to do.
It isn&rsquo;t passing any options.  The returned values of the message are
normally the returned values of the function (except sometimes when the
<code>:full-rubout</code> option is used; see below).
</p>
<p>Each option in the list of options given as the first argument to the <code>:rubout-handler</code>
message consists of a list whose first element is a
keyword and whose remaining elements are &quot;arguments&quot; to that keyword.  Note
that this is not the same format as the arguments to a typical function
that takes keyword arguments; rather this is an a-list of options.
The standard options are:
</p><dl compact="compact">
<dt><code>(:full-rubout <em>val</em>)</code></dt>
<dd><p>If the user rubs out all the characters he typed, then control will be returned
from the rubout handler immediately.  Two values are returned; the first is
<code>nil</code> and the second is <em>val</em>.  (If the user doesn&rsquo;t rub out all the
characters, then the rubout handler propagates multiple values back
from the function that it calls, as usual.)  In the absence of this option, the rubout
handler would simply wait for more characters to be typed in and would ignore
any additional rubouts.
</p>
</dd>
<dt><code>(:pass-through <em>char1</em> <em>char2</em>...)</code></dt>
<dd><p>The characters <em>char1</em>, <em>char2</em>, etc. are not to be treated as special by
the rubout handler.  You can use this to override the default processing of
characters such as <code>Clear-input</code> and to receive control characters.  Any function
that reads input and uses non-printing characters for anything should list them
in a <code>:pass-through</code> option.  This way, if input is being rubout-handled by
the editor, those non-printing characters will get their desired meaning rather
than their meaning as editor commands.
</p>
</dd>
<dt><code>(:prompt <em>function</em>)</code></dt>
<dt><code>(:reprompt <em>function</em>)</code></dt>
<dd><p>When it is time for the user to be prompted, <em>function</em> is called with
two arguments.  The first is a stream it may print on; the second is the
character which caused the need for prompting, e.g <code>#\clear-input</code>
or <code>#\clear-screen</code>, or <code>nil</code> if the rubout handler was just entered.
</p>
<p>The difference between <code>:prompt</code> and <code>:reprompt</code> is that the latter does
not call the prompt function when the rubout handler is first entered, but only
when the input is redisplayed (e.g after a screen clear).  If both options
are specified then <code>:reprompt</code> overrides <code>:prompt</code> except when the rubout
handler is first entered.
</p>
<p><em>function</em> may also be a string.  Then it is simply printed.
</p>
<p>If the rubout handler is exited with an empty buffer due to the
<code>:full-rubout</code> option, whatever prompt was printed is erased.
</p>
</dd>
<dt><code>(:initial-input <em>string</em>)</code></dt>
<dd><p>Pretends that the user typed <em>string</em>.  When the rubout handler is entered,
<em>string</em> is typed out.  The user can input more characters or rub out
characters from it.
</p>
<a name="g_t_003ado_002dnot_002decho_002doption"></a>
</dd>
<dt><code>(:do-not-echo <em>char-1</em> <em>char-2</em>...)</code></dt>
<dd><p>The characters <em>char-1</em>, <em>char-2</em>, etc are not to be echoed when
the user types them.  The comparison is done with <code>=</code>, not
<code>char-equal</code>.  You can use this to suppress echoing of the <code>return</code>
character that terminated a <code>readline</code>, for example.
</p></dd>
</dl>


<a name="The-_003aread-and-_003aprint-Stream-Operations"></a>
<h3 class="section">21.8 The :read and :print Stream Operations</h3>

<p>A stream can specially handle the reading and printing of objects by
handling the <code>:read</code> and <code>:print</code> stream operations.  Note that these
operations are optional and most streams do not support them.
</p>
<p>If the <code>read</code> function is given a stream that has <code>:read</code> in its
which-operations, then instead of reading in the normal way it sends the
<code>:read</code> message to the stream with one argument, <code>read</code>&rsquo;s
<em>eof-option</em> if it had one or a magic internal marker if it didn&rsquo;t.
Whatever the stream returns is what <code>read</code> returns.
If the stream wants to implement the <code>:read</code> operation by internally
calling <code>read</code>, it must use a different stream that does not have
<code>:read</code> in its which-operations.
</p>
<p>If a stream has <code>:print</code> in its which-operations, it may intercept all
object printing operations, including those due to the <code>print</code>, <code>prin1</code>,
and <code>princ</code> functions, those due to <code>format</code>, and those used internally,
for instance in printing the elements of a list.  The stream receives the
<code>:print</code> message with three arguments: the object being printed, the
<em>prindepth</em> (for comparison against the <code>prinlevel</code> variable), and
<em>slashify-p</em> (<code>t</code> for <code>prin1</code>, <code>nil</code> for <code>princ</code>).  If the stream
returns <code>nil</code>, then normal printing takes place as usual.  If the stream
returns non-<code>nil</code>, then <code>print</code> does nothing; the stream is assumed to have
output an appropriate printed representation for the object.
The two following functions are useful in this connection; however, they are
in the <code>system-internals</code> package and may be changed without much notice.
</p>
<a name="si_003aprint_002dobject_002dfun"></a><dl>
<dt><a name="index-si_003aprint_002dobject"></a>Function: <strong>si:print-object</strong> <em>object prindepth slashify-p stream &amp;optional which-operations</em></dt>
<dd><p>Outputs the printed-representation of <em>object</em> to <em>stream</em>, as modified
by <em>prindepth</em> and <em>slashify-p</em>.  This is the internal guts of the Lisp printer.
When a stream&rsquo;s <code>:print</code> handler calls this function, it should supply
the list <code>(:string-out)</code> for <em>which-operations</em>, to prevent itself from
being called recursively.  Or it can supply <code>nil</code> if it does not want to
receive <code>:string-out</code> messages.
</p>
<p>If you want to customize the behavior of all printing of Lisp objects,
advising (see <a href="#advise">advise</a>) this function is the way to do it.  See
<a href="#customizing_002dthe_002dprinter">customizing-the-printer</a>.
</p></dd></dl>

<a name="si_003aprint_002dlist_002dfun"></a><dl>
<dt><a name="index-si_003aprint_002dlist"></a>Function: <strong>si:print-list</strong> <em>list prindepth slashify-p stream which-operations</em></dt>
<dd><p>This is the part of the Lisp printer that prints lists.  A stream&rsquo;s
<code>:print</code> handler can call this function, passing along its own arguments
and its own which-operations, to arrange for a list to be printed the
normal way and the stream&rsquo;s <code>:print</code> hook to get a chance at each of the
list&rsquo;s elements.
</p></dd></dl>

<a name="g_t_0022Accessing-Files_0022"></a>
<h3 class="section">21.9 &quot;Accessing Files&quot;</h3>
<a name="file_002dstream"></a><a name="index-file"></a>

<p>The Lisp Machine can access files on a variety of remote file servers,
which are typically (but not necessarily) accessed through the Chaosnet,
as well as accessing files on the Lisp Machine itself, if the machine
has its its own file system.  This section tells you how to get a stream
which reads or writes a given file, and what the device-dependent
operations on that stream are.  Files are named with <em>pathnames</em>.
Since pathnames are quite complex they have their own chapter; see
<a href="#pathname">pathname</a>.  You are not allowed to refer to files without first logging
in, and you may also need to specify a username and password for the
host on which the file is stored; see <a href="#login_002dfun">login-fun</a>.
</p>
<a name="with_002dopen_002dfile_002dfun"></a><dl>
<dt><a name="index-with_002dopen_002dfile"></a>Special Form: <strong>with-open-file</strong> <em>(stream pathname options...) body...</em></dt>
<dd><p>Evaluates the <em>body</em> forms with the variable <em>stream</em> bound to a stream that
reads or writes the file named by the value of <em>pathname</em>.  The <em>options</em>
forms evaluate to the file-opening options to be used; see <a href="#file_002dopening_002doptions">file-opening-options</a>.
</p>
<p>When control leaves the body, either normally or abnormally (via <code>*throw</code>),
the file is closed.  If a new output file is being written and control leaves
abnormally, the file is aborted and it is as if it were never written.  Because
it always closes the file, even when an error exit is taken, <code>with-open-file</code>
is preferred over <code>open</code>.  Opening a large number of files and forgetting to
close them tends to break some remote file servers, ITS&rsquo;s for example.
</p>
<p><em>pathname</em> is the name of the file to be opened; it can be a pathname object,
a string, a symbol, or a Maclisp-compatible &quot;namelist&quot;.  It can be anything
acceptable to <code>fs:parse-pathname</code>; the complete rules for parsing pathnames
are explained in <a href="#pathname">pathname</a>.
</p>
<p>If an error, such as file not found, occurs, the result is whatever
<code>open</code> does, based on the value of the <code>:error</code> option passed to it.
</p></dd></dl>

<a name="with_002dopen_002dfile_002dcase_002dfun"></a><dl>
<dt><a name="index-with_002dopen_002dfile_002dcase"></a>Special Form: <strong>with-open-file-case</strong> <em>(stream pathname options...) clauses...</em></dt>
<dd><p>This opens and closes the file like <code>with-open-file</code>, but what
happens afterward is determined by <em>clauses</em> that are like the
clauses of a <code>condition-case</code>.  Each clause begins with a condition
name or a list of condition names and is executed if <code>open</code> signals a
condition that possesses any of those names.  A clause beginning with
the symbol <code>:no-error</code> is executed if <code>open</code> returns.  This would be
where the reading or writing of the file would be done.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(with-open-file-case (stream (send generic-pathname
				   ':source-pathname))
  (sys:remote-network-error (format t &quot;~&amp;Host down.&quot;))
  (fs:file-not-found (format t &quot;~&amp;(New file)&quot;))
  (:no-error (setq list (read stream))))
</pre></div>
</dd></dl>

<a name="file_002dretry_002dnew_002dpathname_002dfun"></a><dl>
<dt><a name="index-file_002dretry_002dnew_002dpathname"></a>Special Form: <strong>file-retry-new-pathname</strong> <em>(pathname-var condition-names...) body...</em></dt>
<dd><a name="file_002dretry_002dnew_002dpathname_002dif_002dfun"></a></dd><dt><a name="index-file_002dretry_002dnew_002dpathname_002dif"></a>Special Form: <strong>file-retry-new-pathname-if</strong> <em>cond-form (pathname-var condition-names...) body...</em></dt>
<dd><p><code>file-retry-new-pathname</code> executes <em>body</em>.  If <em>body</em> does not
signal any of the conditions in <em>condition-names</em>, <em>body</em>&rsquo;s values
are simply returned.  If any of <em>condition-names</em> is signaled,
<code>file-retry-new-pathname</code> reads a new pathname, <code>setq</code>&rsquo;s
<em>pathname-var</em> to it, and executes <em>body</em> again.
</p>
<p><code>file-retry-new-pathname-if</code> is similar, but the conditions are
handled only if <em>cond-form</em>&rsquo;s value is non-<code>nil</code>.
</p></dd></dl>

<a name="with_002dopen_002dfile_002dretry_002dfun"></a><dl>
<dt><a name="index-with_002dopen_002dfile_002dretry"></a>Special Form: <strong>with-open-file-retry</strong> <em>(stream (pathname-var condition-names...) options...) body...</em></dt>
<dd><p>Like <code>with-open-file</code>, except that if an error occurs inside <code>open</code>
with one of the specified <em>condition-names</em>, a new pathname is read,
the variable <em>pathname-var</em> is <code>setq</code>&rsquo;d to it, and the <code>open</code> is
retried.
</p></dd></dl>

<a name="open_002dfun"></a><dl>
<dt><a name="index-open"></a>Function: <strong>open</strong> <em>pathname &amp;rest options</em></dt>
<dd><p>Returns a stream that is connected to the specified file.  Unlike
Maclisp, the <code>open</code> function creates streams only for <em>files</em>;
streams of other kinds are created by other functions.  The <em>pathname</em>
and <em>options</em> arguments are the same as in <code>with-open-file</code>; see above.
</p>
<p>When the caller is finished with the stream, it should close the file by using
the <code>:close</code> operation or the <code>close</code> function.  The <code>with-open-file</code>
special form does this automatically and so is usually preferred.  <code>open</code>
should only be used when the control structure of the program necessitates opening
and closing of a file in some way more complex than the simple way provided
by <code>with-open-file</code>.  Any program that uses <code>open</code> should set up
<code>unwind-protect</code> handlers (see <a href="#unwind_002dprotect_002dfun">unwind-protect-fun</a>) to close its files
in the event of an abnormal exit.
</p></dd></dl>

<a name="close_002dfun"></a><dl>
<dt><a name="index-close"></a>Function: <strong>close</strong> <em>stream</em></dt>
<dd><p>The <code>close</code> function simply sends the <code>:close</code> message to <em>stream</em>.
</p></dd></dl>

<a name="deletef_002dfun"></a><dl>
<dt><a name="index-deletef"></a>Function: <strong>deletef</strong> <em>file &amp;optional (error-p <code>t</code>) query?</em></dt>
<dd><p><em>file</em> can be a pathname or a stream that is open to a file.  The
specified file is deleted.  <em>pathname</em> may contain wildcard
characters, in which case multiple files are deleted.
</p>
<p>If <em>query?</em> is non-<code>nil</code>, the user is queried about each file
(whether there are wildcards or not).  Only the files that the user
confirms are actually deleted.
</p>
<p>If <em>error-p</em> is <code>t</code>, then if an error occurs it will be signalled as
a Lisp error.  If <em>error-p</em> is <code>nil</code> and an error occurs, the error
message will be returned as a string.  Otherwise, the value is a list of
elements, one for each file considered.  The car of each element is
the truename of the file, and the cadr is non-<code>nil</code> if the file
was actually deleted (it will always be <code>t</code> unless querying was done).
</p></dd></dl>

<a name="undeletef_002dfun"></a><dl>
<dt><a name="index-undeletef"></a>Function: <strong>undeletef</strong> <em>file &amp;optional (error-p <code>t</code>) query?</em></dt>
<dd><p><em>file</em> can be a pathname or a stream that is open to a file.  The specified
file is undeleted.  Wildcards are allowed, just as in <code>deletef</code>.
The rest of the calling conventions are the same as well.
</p>
<p>Not all file systems support undeletion, and if it is not supported on
the one you are using, it get an error or return a string according to
<em>error-p</em>.  To find out whether a particular file system supports
this, send the <code>:undeletable-p</code> operation to a pathname.  If it
returns <code>t</code>, the file system of that pathname supports undeletion.
</p></dd></dl>

<a name="renamef_002dfun"></a><dl>
<dt><a name="index-renamef"></a>Function: <strong>renamef</strong> <em>file new-name &amp;optional (error-p <code>t</code>) query?</em></dt>
<dd><p><em>file</em> can be a pathname or a stream that is open to a file.  The specified
file is renamed to <em>new-name</em> (a pathname).
<em>file</em> may contain wildcards, in which case multiple files are
renamed.  Each file&rsquo;s new name is produced by passing <em>new-name</em> to
<code>merge-pathname-defaults</code> with the file&rsquo;s truename as the defaults.
Therefore, <em>new-name</em> should be a string in this case.
</p>
<p>If <em>query?</em> is non-<code>nil</code>, the user is queried about each file
(whether there are wildcards or not).  Only the files that the user
confirms are actually renamed.
</p>
<p>If <em>error-p</em> is <code>t</code>, then if an error occurs it will be signalled as
a Lisp error.  If <em>error-p</em> is <code>nil</code> and an error occurs, the error
message will be returned as a string.  Otherwise, the value is a list of
elements, one for each file considered.  The car of each element is
the original truename of the file, the cadr is the name it was to be
renamed to, and the caddr is non-<code>nil</code> if the file was renamed.
The caddr is <code>nil</code> if the user was queried and said no.
</p></dd></dl>

<a name="copy_002dfile_002dfun"></a><dl>
<dt><a name="index-copy_002dfile"></a>Function: <strong>copy-file</strong> <em>file new-file &amp;optional (error-p <code>t</code>) copy-mode</em></dt>
<dd><p><code>copy-file</code> is called almost like <code>renamef</code>.  Instead of renaming
files, it copies them.  Querying is not done.
</p>
<p><em>copy-mode</em> tells <code>copy-file</code> whether to copy the file as characters
or as binary; or else, how to decide which of those to do.
The possible values are <code>:characters</code>, <code>:binary</code>, <code>:ask</code>,
<code>:never-ask</code>, and <code>nil</code>.  <code>:characters</code> and <code>:binary</code> specify
straightforwardly which kind of transfer to do.  <code>:ask</code> says to always
ask the user about each file.  <code>:never-ask</code> says to guess about each
file from its byte size and filetype.  <code>nil</code> says to guess if guessing
appears to be reliable, otherwise ask the user.
</p></dd></dl>

<a name="probef_002dfun"></a><dl>
<dt><a name="index-probef"></a>Function: <strong>probef</strong> <em>pathname</em></dt>
<dd><p>Returns <code>nil</code> if there is no file named <em>pathname</em>, otherwise returns a
pathname that is the true name of the file, which can be different from
<em>pathname</em> because of file links, version numbers, etc.
</p>
<p>Any problem in opening the file except for <code>fs:file-not-found</code> signals
an error.
</p></dd></dl>

<a name="viewf_002dfun"></a><dl>
<dt><a name="index-viewf"></a>Function: <strong>viewf</strong> <em>pathname &amp;optional (output-stream <code>standard-output</code>) leader</em></dt>
<dd><p>Copies the contents of the file named <em>pathname</em>, opened in character
mode, onto <code>output-stream</code>.  Normally this has the effect of printing
the file on the terminal.  <em>leader</em> is passed along to
<code>stream-copy-until-eof</code> (see <a href="#stream_002dcopy_002duntil_002deof_002dfun">stream-copy-until-eof-fun</a>).
</p></dd></dl>

<a name="fs_003aclose_002dall_002dfiles_002dfun"></a><dl>
<dt><a name="index-fs_003aclose_002dall_002dfiles"></a>Function: <strong>fs:close-all-files</strong></dt>
<dd><p>Closes all open files.  This is useful when a program has run wild opening
files and not closing them.  It closes all the files in <code>:abort</code> mode
(see <a href="#close_002dmessage">close-message</a>), which means that files open for output will be
deleted.  Using this function is dangerous, because you may close files
out from under various programs like ZMACS and ZMAIL; only use it if you
have to and if you feel that you know what you&rsquo;re doing.
</p></dd></dl>

<a name="file_002dopening_002doptions"></a><p>The <em>options</em> used when opening a file are normally alternating keywords and
values, like any other function that takes keyword arguments.  In addition,
for compatibility with the Maclisp <code>open</code> function, if only a single option
is specified it is either a keyword or a list of keywords (not alternating with
values).
</p>
<p>The file-opening options control things like whether the stream is for input
from a existing file or output to a new file, whether the file is text or binary, etc.
</p>
<p>The following option keywords are standardly recognized; additional keywords
can be implemented by particular file system hosts.
</p>
<p>[Are all these keywords supported by all file systems?]
</p>
<dl compact="compact">
<dt><code>:direction</code></dt>
<dd><a name="index-_003adirection-open"></a>
<p>The possible values are <code>:input</code> (the default), <code>:output</code>, and <code>nil</code>.
The first two should be self-explanatory.
<code>nil</code> means that this is a &quot;probe&quot; opening; no data are to be transferred,
the file is being opened only to access or change its properties.
</p>
</dd>
<dt><code>:characters</code></dt>
<dd><a name="index-_003acharacters-open"></a>
<p>The possible values are <code>t</code> (the default), <code>nil</code>, which means that the
file is a binary file, and <code>:default</code>, which means that the file system should
decide whether the file contains characters or binary data and open it in the
appropriate mode.
</p>
</dd>
<dt><code>:byte-size</code></dt>
<dd><a name="index-_003abyte_002dsize-open"></a>
<p>The possible values are <code>nil</code> (the default), a number, which is the number
of bits per byte, and <code>:default</code>, which means that the file system should
choose the byte size based on attributes of the file.  If the file is being
opened as characters, <code>nil</code> selects the appropriate system-dependent byte
size for text files; it is usually not useful to use a different byte size.
If the file is being opened as binary, <code>nil</code> selects the default byte size
of 16 bits.
</p>
</dd>
<dt><code>:error</code></dt>
<dd><a name="index-_003aerror-open"></a>
<p>The possible values are <code>t</code> (the default), <code>:reprompt</code> and <code>nil</code>.
If an error occurs, this option controls whether the error is signalled
to the user (<code>t</code>), a new pathname is read (<code>:reprompt</code>) or a string
containing an error message is returned instead of a stream (<code>nil</code>).
</p>
<p><code>:reprompt</code> should be used whenever the caller does not need to know
which file was ultimately opened.  More sophisticated callers should use
<code>with-open-file-retry</code> or <code>file-retry-new-pathname</code> (see
<a href="#file_002dretry_002dnew_002dpathname_002dfun">file-retry-new-pathname-fun</a>).
</p>
</dd>
<dt><code>:new-file</code></dt>
<dd><a name="index-_003anew_002dfile-open"></a>
<p>If the value is <code>t</code>, the file system is allowed to create a new file.
If the value is <code>nil</code>, an existing file must be opened.
The default is <code>t</code> if <code>:direction</code> <code>:output</code> is specified, otherwise <code>nil</code>.
</p>
</dd>
<dt><code>:new-version</code></dt>
<dd><a name="index-_003anew_002dversion-open"></a>
<p>This controls what happens if the version field of the pathname being opened
is <code>:newest</code>.  If the value is <code>nil</code>, the newest existing version of the
file is found.  If the value is <code>t</code> (the default when <code>:direction</code> <code>:output</code>
is specified), then the next-higher-numbered version of the file is to be created.
</p>
</dd>
<dt><code>:old-file</code></dt>
<dd><a name="index-_003aold_002dfile-open"></a>
<p>This keyword controls what happens if a file with the specified name already
exists when <code>:direction</code> <code>:output</code> is specified.  Possible values are:
</p><dl compact="compact">
<dt><code>nil <span class="roman">or</span> :replace</code></dt>
<dd><p>The existing file is to be replaced when the new file is closed (providing
<code>:abort</code> is not specified when closing).  This is the default
if <code>:new-file</code> is specified as, or defaults to, <code>t</code>.
</p>
</dd>
<dt><code>t <span class="roman">or</span> :rewrite</code></dt>
<dd><p>The new data should be stored into the existing file.  This is the default
if <code>:new-file</code> is specified as <code>nil</code>.
</p>
</dd>
<dt><code>:append</code></dt>
<dd><p>Append new data to the end of the file.
</p>
</dd>
<dt><code>:error</code></dt>
<dd><p>Signal an error (file already exists).
</p>
</dd>
<dt><code>:rename</code></dt>
<dd><p>The old file is to be renamed to some other name, to get it out of the way.
</p>
</dd>
<dt><code>:rename-and-delete</code></dt>
<dd><p>The old file is renamed, possibly immediately, and deleted when the new file is closed.
</p>
</dd>
<dt><code>:new-version</code></dt>
<dd><p>Create a new version, instead of opening the version number specified in the pathname.
</p></dd>
</dl>

</dd>
<dt><code>:inhibit-links</code></dt>
<dd><a name="index-_003ainhibit_002dlinks-open"></a>
<p>The default is <code>nil</code>.  If the pathname is the name of a file-system link,
and this option is <code>t</code>, the link itself is opened rather than the file it
points to.  This is useful only with probe openings, since links contain
no data.
</p>
</dd>
<dt><code>:deleted</code></dt>
<dd><a name="index-_003adeleted-open"></a>
<p>The default is <code>nil</code>.  If <code>t</code> is specified, and the file system has the
concept of deleted but not expunged files, it is possible to open a deleted
file.  Otherwise deleted files are invisible.
</p>
</dd>
<dt><code>:temporary</code></dt>
<dd><a name="index-_003atemporary-open"></a>
<p>The default is <code>nil</code>.  If <code>t</code> is specified, the file is marked as
temporary, if the file system has that concept.
</p>
</dd>
<dt><code>:preserve-dates</code></dt>
<dd><a name="index-_003apreserve_002ddates-open"></a>
<p>The default is <code>nil</code>.  If <code>t</code> is specified, the file&rsquo;s reference and
modification dates are not updated.
</p>
</dd>
<dt><code>:flavor</code></dt>
<dd><a name="index-_003aflavor-open"></a>
<p>This controls the kind of file to be opened.  The default is <code>nil</code>, a
normal file.  Other possible values are <code>:directory</code> and <code>:link</code>.
</p>
</dd>
<dt><code>:link-to</code></dt>
<dd><a name="index-_003alink_002dto-open"></a>
<p>When creating a file with <code>:flavor</code> <code>:link</code>, this keyword must be
specified; its value is a pathname that becomes the target of the link.
</p>
</dd>
<dt><code>:estimated-size</code></dt>
<dd><a name="index-_003aestimated_002dsize-open"></a>
<p>The value may be <code>nil</code> (the default), which means there is no estimated
size, or a number of bytes.  Some file systems use this to optimize disk
allocation.
</p>
</dd>
<dt><code>:physical-volume</code></dt>
<dd><a name="index-_003aphysical_002dvolume-open"></a>
<p>The value may be <code>nil</code> (the default), or a string that is the name
of a physical volume on which the file is to be stored.  This is not meaningful
for all file systems.
</p>
</dd>
<dt><code>:logical-volume</code></dt>
<dd><a name="index-_003alogical_002dvolume-open"></a>
<p>The value may be <code>nil</code> (the default), or a string that is the name
of a logical volume on which the file is to be stored.  This is not meaningful
for all file systems.
</p>
</dd>
<dt><code>:incremental-update</code></dt>
<dd><a name="index-_003aincremental_002dupdate-open"></a>
<p>The value may be <code>nil</code> (the default), or <code>t</code> to cause the file system
to take extra pains to write data onto the disk more often.
</p>
</dd>
<dt><code>:super-image</code></dt>
<dd><a name="index-_003asuper_002dimage-open"></a>
<p>The value may be <code>nil</code> (the default), or <code>t</code>, which
disables the special treatment of rubout in ascii files.  Normally, rubout is
an escape which causes the following character to be interpreted specially,
allowing all characters from 0 through 376 to be stored.  This applies to
PDP-10 file servers only.
</p>
</dd>
<dt><code>:raw</code></dt>
<dd><a name="index-_003araw-open"></a>
<p>The value may be <code>nil</code> (the default), or <code>t</code>, which
disables all character set translation in ascii files.  This applies to PDP-10
file servers only.
</p>
</dd>
</dl>

<p>In the Maclisp compatibility mode, there is only one <em>option</em>, and it
is either a symbol or a list of symbols.  These symbols are recognized no
matter what package they are in, since Maclisp does not have packages.
The following symbols are recognized:
</p><dl compact="compact">
<dt><code>in, read</code></dt>
<dd><p>Select opening for input (the default).
</p>
</dd>
<dt><code>out, write, print</code></dt>
<dd><p>Select opening for output; a new file is to be created.
</p>
</dd>
<dt><code>binary, fixnum</code></dt>
<dd><p>Select binary mode; otherwise character mode is used.  Note that fixnum mode
uses 16-bit binary words and is not compatible with Maclisp fixnum mode, which
uses 36-bit words.  On the PDP-10, fixnum files are stored with two 16-bit words
per PDP-10 word, left-justified and in PDP-10 byte order.
</p>
</dd>
<dt><code>character, ascii</code></dt>
<dd><p>The opposite of fixnum.  This is the default.
</p>
</dd>
<dt><code>single, block</code></dt>
<dd><p>Ignored for compatibility with the Maclisp <code>open</code> function.
</p>
</dd>
<dt><code>byte-size</code></dt>
<dd><p>Must be followed by a number in the options list, and must be used in combination
with <code>fixnum</code>.  The number is the number of bits per byte, which can be from
1 to 16.  On a PDP-10 file server these bytes will be packed into words in the
standard way defined by the <code>ILDB</code> instruction.  The <code>:tyi</code> stream operation
will (of course) return the bytes one at a time.
</p>
</dd>
<dt><code>probe, error, noerror, raw, super-image, deleted, temporary</code></dt>
<dd><p>These are not available in Maclisp.  The corresponding keywords in the
normal form of file-opening options are preferred over these.
</p>
</dd>
</dl>

<a name="Loading-Files"></a>
<h4 class="subsection">21.9.1 Loading Files</h4>
<a name="index-loading"></a>
<a name="index-program-source-file"></a>

<p>To <em>load</em> a file is to read through the file, evaluating each form
in it.  Programs are typically stored in files; the expressions in the file are mostly
special forms such as <code>defun</code> and <code>defvar</code> which define the functions and
variables of the program.
</p>
<p>Loading a compiled (or QFASL) file is similar, except that the file does not
contain text but rather pre-digested expressions created by the
compiler which can be loaded more quickly.
</p>
<p>These functions are for loading single files.  There is a system for keeping track
of programs which consist of more than one file; for further information refer
to <a href="#system_002dsystem">system-system</a>.
</p>
<a name="load_002dfun"></a><dl>
<dt><a name="index-load"></a>Function: <strong>load</strong> <em>pathname &amp;optional pkg nonexistent-ok dont-set-default</em></dt>
<dd><p>This function loads the file named by <em>pathname</em> into the Lisp environment.
If the file is a QFASL file, it calls <code>fasload</code>; otherwise
it calls <code>readfile</code>.  Normally the file is read into its &quot;home&quot; package,
but if <em>pkg</em> is supplied it is the package in which the file is to be read.
<em>pkg</em> can be either a package or the name of a package as a string or a symbol.
If <em>pkg</em> is not specified, <code>load</code> prints a message saying what package
the file is being loaded into.
If <em>nonexistent-ok</em> is specified, <code>load</code> just returns if the file cannot
be opened.
</p>
<p><em>pathname</em> can be anything acceptable to <code>fs:parse-pathname</code>;
pathnames and the complete rules for parsing them are explained
in <a href="#pathname">pathname</a>.  <em>pathname</em> is defaulted from <code>fs:load-pathname-defaults</code>
(see <a href="#fs_003aload_002dpathname_002ddefaults_002dvar">fs:load-pathname-defaults-var</a>), which is the set
of defaults used by <code>load</code>, <code>qc-file</code>, and similar functions.
Normally <code>load</code> updates the pathname defaults from <em>pathname</em>,
but if <em>dont-set-default</em> is specified this is suppressed.
</p>
<p>If <em>pathname</em> contains an name but no type, <code>load</code> will first look
for the file with a type of <code>QFASL</code>, then look for a type of <code>LISP</code>.
</p></dd></dl>

<a name="readfile_002dfun"></a><dl>
<dt><a name="index-readfile"></a>Function: <strong>readfile</strong> <em>pathname &amp;optional pkg no-msg-p</em></dt>
<dd><p><code>readfile</code> is the version of <code>load</code> for text files.  It reads and evaluates
each expression in the file.  As with <code>load</code>, <em>pkg</em> can specify what package
to read the file into.  Unless <em>no-msg-p</em> is <code>t</code>, a message is printed
indicating what file is being read into what package.  The defaulting of
<em>pathname</em> is the same as in <code>load</code>.
</p></dd></dl>

<a name="fasload_002dfun"></a><dl>
<dt><a name="index-fasload"></a>Function: <strong>fasload</strong> <em>pathname &amp;optional pkg no-msg-p</em></dt>
<dd><p><code>fasload</code> is the version of <code>load</code> for QFASL files.  It defines
functions and performs other actions as directed by the specifications
inserted in the file by the compiler.  As with <code>load</code>, <em>pkg</em> can
specify what package to read the file into.  Unless <em>no-msg-p</em> is
<code>t</code>, a message is printed indicating what file is being read into what
package.  The defaulting of <em>pathname</em> is the same as in <code>load</code>.
</p></dd></dl>


<a name="File-Attribute-Lists"></a>
<h4 class="subsection">21.9.2 File Attribute Lists</h4>
<a name="index-file-attribute-list"></a>
<a name="index-attribute-list_002c-file"></a>
<a name="file_002dattribute_002dlist"></a><a name="file_002dattributes_002dlist"></a>
<p>Any text file can contain an &quot;attribute list&quot; that specifies several attributes
of the file.  The above loading functions, the compiler, and the editor look
at this property list.  Attribute lists are especially useful in program
source files, i.e a file that is intended to be loaded (or compiled and
then loaded).  QFASL files also contain attribute lists, copied from
their source files.
</p>
<p>If the first non-blank line in a text file contains the three characters
<code>&quot;-*-&quot;</code>,
some text, and <code>&quot;-*-&quot;</code> again, the text is recognized as the file&rsquo;s attribute list.
Each attribute consists of the attribute name, a colon, and the attribute value.
If there is more than one attribute they are separated by semicolons.  An example
of such an attribute list is:
</p><div class="lisp">
<pre class="lisp">; -*- Mode:Lisp; Package:Cellophane; Base:10 -*-
</pre></div>
<p>The semicolon makes this line look like a comment rather than a Lisp expression.
This defines three properties: mode, package, and base.
Another example is:
</p><div class="lisp">
<pre class="lisp">c Part of the Lisp machine manual.  -*- Mode:Bolio -*-
</pre></div>

<p>An attribute name is made up of letters, numbers, and otherwise-undefined
punctuation characters such as hyphens.  An attribute value can be such a
name, or a decimal number, or several such items separated by commas.
Spaces may be used freely to separate tokens.  Upper and lower-case
letters are not distinguished.  There is <em>no</em> quoting convention for
special characters such as colons and semicolons.
</p>
<p>If the attribute list text contains no colons, it is an old Emacs
format, containing only the value of the <code>Mode</code> attribute.
</p>
<p>The file attribute list format actually has nothing to do with Lisp; it
is just a convention for placing some information into a file that is
easy for a program to interpret.  The Emacs editor on the PDP-10 knows
how to interpret these attribute lists (primarily in order to look at the
<code>Mode</code> attribute).
</p>
<p>The Lisp Machine handles the attribute list stored in the file by
parsing it into a Lisp data structure, a property list.  Attribute names
are interpreted as Lisp symbols and are interned on the keyword package.
Numbers are interpreted as Lisp fixnums and are read in decimal.  If a
attribute value contains any commas, then the commas separate several
expressions that are formed into a list.
</p>
<p>When a file is compiled, its attribute list data structure is stored in
the QFASL file.  It can be loaded back from the QFASL file as well.
The representation in the QFASL file resembles nothing described here,
but when the attribute list is extracted from there, the same Lisp data
structure described above is obtained.
</p>
<p>When a file is edited, loaded, or compiled, its file attribute list is
read in and the properties are stored on the property list of the
generic pathname (see <a href="#generic_002dpathname">generic-pathname</a>) for that file, where they can
be retrieved with the <code>:get</code> and <code>:plist</code> messages.  This is done
using the function <code>fs:read-attribute-list</code>, below.  So the way you
examine the properties of a file is usually to use messages to a
pathname object that represents the generic pathname of a file.  Note
that there are other properties there, too.
</p>
<p>Here the attribute names with standard meanings:
</p><dl compact="compact">
<dt><span class="roman">Mode</span></dt>
<dd><p>The editor major mode to be used when editing this file.  This is typically
the name of the language in which the file is written.  The most common values
are <code>Lisp</code> and <code>Text</code>.
</p>
</dd>
<dt><span class="roman">Package</span></dt>
<dd><p>This attribute specifies the package in which symbols in the file should
be interned.  The attribute may be either the name of a package, or a
list that specifies both the package name and how to create the package
if it does not exist.  If it is a list, it should look like
<code>(<em>name</em> <em>superpackage</em> <em>initial-size</em> <em>...options...</em>)</code>.  See <a href="#package">package</a>
for more information about packages.
</p>
</dd>
<dt><span class="roman">Base</span></dt>
<dd><p>The number base in which the file is written (remember, it is
always parsed in decimal).  This affects both <code>ibase</code> and <code>base</code>,
since it is confusing to have the input and output bases be different.
The most common values are 8 and 10.
</p>
</dd>
<dt><span class="roman">Lowercase</span></dt>
<dd><p>If the attribute value is not <code>nil</code>, the file is written in lower-case letters
and the editor does not translate to upper case.  (The editor does not translate
to upper case by default unless the user selects &quot;Electric Shift Lock&quot; mode.)
</p>
</dd>
<dt><span class="roman">Fonts</span></dt>
<dd><p>The attribute value is a list of font names, separated by commas.  The editor
uses this for files that are written in more than one font.
</p>
</dd>
<dt><span class="roman">Backspace</span></dt>
<dd><p>If the attribute value is not <code>nil</code>, <code>Overstrike</code> characters in the
file should cause characters to overprint on each other.  The default is
to disallow overprinting and display <code>Overstrike</code> the way other
special function keys are displayed.  This default is to prevent the
confusion that can be engendered by overstruck text.
</p>
</dd>
<dt><span class="roman">Patch-File</span></dt>
<dd><p>If the attribute value is not <code>nil</code>, the file is a &quot;patch file&quot;.  When it is loaded
the system will not complain about function redefinitions.  In a patch
file, the <code>defvar</code> special-form turns into <code>defconst</code>; thus patch files will
always reinitialize variables.
</p>
</dd>
<dt><span class="roman">Cold-Load</span></dt>
<dd><p>A non-<code>nil</code> value for this attribute identifies files that are part of
the cold load, the core from which a new system version is built.
Certain features that do not work in the cold load check this flag to
give an error or a compiler warning if used in such files, so that the
problem can be detected sooner.
</p>
</dd>
</dl>

<p>You are free to define additional file attributes of your own.  However,
to avoid accidental name conflicts, you should choose names that are
different from all the names above, and from any names likely to be
defined by anybody else&rsquo;s programs.
</p>
<p>The following functions are used to examine file attribute lists:
</p>
<a name="fs_003afile_002dattribute_002dlist_002dfun"></a><dl>
<dt><a name="index-fs_003afile_002dattribute_002dlist"></a>Function: <strong>fs:file-attribute-list</strong> <em>pathname</em></dt>
<dd><p>Returns the attribute list of the file specified by the pathname.
This works on both text files and QFASL files.
</p></dd></dl>

<a name="fs_003aextract_002dattribute_002dlist_002dfun"></a><dl>
<dt><a name="index-fs_003aextract_002dattribute_002dlist"></a>Function: <strong>fs:extract-attribute-list</strong> <em>stream</em></dt>
<dd><p>Returns the attribute list read from the specified stream, which should
be pointing to the beginning of a file.  This
works on both text streams and QFASL file binary streams.
After the attribute list is read, the stream&rsquo;s pointer is set back to
the beginning of the file using the <code>:set-pointer</code> file
stream operation (see <a href="#streams_002dset_002dpointer_002dmethod">streams-set-pointer-method</a>).
</p></dd></dl>

<a name="fs_003aread_002dattribute_002dlist_002dfun"></a><dl>
<dt><a name="index-fs_003aread_002dattribute_002dlist"></a>Function: <strong>fs:read-attribute-list</strong> <em>pathname stream</em></dt>
<dd><p><em>pathname</em> should be a pathname object (<em>not</em> a string or namelist,
but an actual pathname); usually it is a generic pathname (see
<a href="#generic_002dpathname">generic-pathname</a>).  <em>stream</em> should be a stream that has been
opened and is pointing to the beginning of the file whose file attribute
list is to be parsed.  The attribute list is read from the stream and
then corresponding properties are placed on the specified <em>pathname</em>.
The attribute list is also returned.
</p></dd></dl>

<p>The fundamental way that programs in the Lisp Machine notice the
presence of properties on a file&rsquo;s attribute list is by examining the
property list in the generic pathname.  However, there is another way
that is more convenient for some applications.  File attributes can
cause special variables to be bound whenever Lisp expressions are being
read from the file&ndash;when the file is being loaded, when it is being
compiled, when it is being read from by the editor, and when its QFASL
file is being loaded.  This is how the <code>Package</code> and <code>Base</code> attributes work.
You can also deal with attributes this way, by using the following function:
</p>
<a name="fs_003afile_002dattribute_002dbindings_002dfun"></a><dl>
<dt><a name="index-fs_003afile_002dattribute_002dbindings"></a>Function: <strong>fs:file-attribute-bindings</strong> <em>pathname</em></dt>
<dd><p>This function examines the property list of <em>pathname</em> and finds all
those property names that have <code>fs:file-attribute-bindings</code> properties.
Each such property name specifies a set of variables to bind and
a set of values to which to bind them.  This function returns two values,
a list of all the variables and a list of all the corresponding values.
Usually you use this function by calling it on a generic pathname
that has had <code>fs:read-attribute-list</code> done on it, and then
you use the two returned values as the first two arguments of a
<code>progv</code>
special form (see <a href="#progv_002dfun">progv-fun</a>).  Inside the body of the <code>progv</code> the
specified bindings will be in effect.
</p>
<p>Usually <em>pathname</em> is a generic pathname.  It can also be a locative,
in which case it is interpreted to be the property list itself.
</p>
<p>Of the standard attribute names, the following ones have
<code>fs:file-attribute-bindings</code>, with the following effects.  <code>Package</code>
binds the variable <code>package</code> (see <a href="#package_002dvar">package-var</a>) to the package.
<code>Base</code> binds the variables <code>base</code> (see <a href="#base_002dvar">base-var</a>) and <code>ibase</code>
(see <a href="#ibase_002dvar">ibase-var</a>) to the value.  <code>Patch-file</code> binds
<code>fs:this-is-a-patch-file</code> to the value.  <code>Cold-load</code> binds
<code>si:file-in-cold-load</code> to the value.
</p>
<p>Any properties whose names do not have <code>fs:file-attribute-bindings</code>
properties are ignored completely.
</p>
<p>You can also add your own attribute names that affect bindings.  If
an indicator symbol has an <code>fs:file-attribute-bindings</code> property, the
value of that property is a function that is called when a file with a
file attribute of that name is going to be read from.  The function is
given three arguments: the file pathname, the attribute name, and the
attribute value.  It must return two values: a list of variables to be
bound and a list of values to bind them to.  The function for the
<code>Base</code> keyword could have been defined by:
</p><div class="lisp">
<pre class="lisp">(defun (:base file-attribute-bindings) (file ignore bse)
  (if (not (and (typep bse 'fixnum)
		(&gt; bse 1)
		(&lt; bse 37.)))
      (ferror 'fs:invalid-file-attrbute
	      &quot;File ~A has an illegal -*- Base:~D -*-&quot;
	      file bse))
  (values (list 'base 'ibase) (list bse bse)))
</pre></div>
</dd></dl>

<dl>
<dt><a name="index-_0028error_0029-on-fs_003ainvalid_002dfile_002dattribute"></a>Condition on fs:invalid-file-attribute: <strong>(<code>error</code>)</strong></dt>
<dd><p>An attribute in the file attribute list had a bad value.  This is detected within
<code>fs:file-attribute-bindings</code>.
</p></dd></dl>

<a name="File-Stream-Operations"></a>
<h4 class="subsection">21.9.3 File Stream Operations</h4>
<a name="file_002dstream_002doperations_002dsection"></a>
<p>The following operations may be used on file streams, in addition to the normal I/O
operations which work on all streams.  Note that several of these operations are
useful with file streams that have been closed.  Some operations
use pathnames; refer to <a href="#pathname">pathname</a> for an explanation of pathnames.
</p>
<dl>
<dt><a name="index-streams_0022-on-_0022file"></a>Meta Method on &quot;file: <strong>streams&quot;</strong> <em>:pathname</em></dt>
<dd><p>Returns the pathname that was opened to get this stream.  This may not be
identical to the argument to <code>open</code>, since missing components will have been
filled in from defaults.  The pathname may have been replaced wholesale if
an error occurred in the attempt to open the original pathname.
</p></dd></dl>

<dl>
<dt><a name="index-streams_0022-on-_0022file-1"></a>Meta Method on &quot;file: <strong>streams&quot;</strong> <em>:truename</em></dt>
<dd><p>Returns the pathname of the file actually open on this stream.  This can be
different from what <code>:pathname</code> returns because of file links, logical
devices, mapping of &quot;newest&quot; version to a particular version number, etc.  For
an output stream the truename is not meaningful until after the stream has been
closed, at least when the file server is an ITS.
</p></dd></dl>

<dl>
<dt><a name="index-streams_0022-on-_0022file-2"></a>Meta Method on &quot;file: <strong>streams&quot;</strong> <em>:generic-pathname</em></dt>
<dd><p>Returns the generic pathname of the pathname that was opened to get this
stream.  Normally this is the same as the result of sending the
<code>:generic-pathname</code> message to the value of the <code>:pathname</code>
operation on the stream; however, it does special things when the Lisp
system is bootstrapping itself.
</p></dd></dl>

<dl>
<dt><a name="index-streams_0022-on-_0022file-3"></a>Meta Method on &quot;file: <strong>streams&quot;</strong> <em>:qfaslp</em></dt>
<dd><p>Returns <code>t</code> if the file has a magic flag at the front that says it is a QFASL file,
<code>nil</code> if it is an ordinary file.
</p></dd></dl>

<dl>
<dt><a name="index-streams_0022-on-_0022file-4"></a>Meta Method on &quot;file: <strong>streams&quot;</strong> <em>:length</em></dt>
<dd><p>Returns the length of the file, in bytes or characters.  For text files on
PDP-10 file servers, this is the number of PDP-10 characters, not Lisp Machine
characters.  The numbers are different because of character-set translation;
see <a href="#character_002dset_002ddifferences">character-set-differences</a> for a full explanation.
For an output stream the length is not meaningful until after the stream has
been closed, at least when the file server is an ITS.
</p></dd></dl>

<dl>
<dt><a name="index-streams_0022-on-_0022file-5"></a>Meta Method on &quot;file: <strong>streams&quot;</strong> <em>:creation-date</em></dt>
<dd><p>Returns the creation date of the file, as a number that is a universal time.
See the chapter on the time package (<a href="#time">time</a>).
</p></dd></dl>

<dl>
<dt><a name="index-streams_0022-on-_0022file-6"></a>Meta Method on &quot;file: <strong>streams&quot;</strong> <em>:info</em></dt>
<dd><p>Returns a cons of the file&rsquo;s truename and its creation date.  This can
be used to tell if the file has been modified between two <code>open</code>s.
For an output stream the info is guaranteed to be correct until after
the stream has been closed.
</p></dd></dl>


<dl>
<dt><a name="index-streams_0022-on-_0022file-7"></a>Meta Method on &quot;file: <strong>streams&quot;</strong> <em>:set-byte-size new-byte-size</em></dt>
<dd><p>This is only allowed on binary (&quot;fixnum mode&quot;) file streams.  The byte size
can be changed to any number of bits from 1 to 16.
</p></dd></dl>

<dl>
<dt><a name="index-streams_0022-on-_0022file-8"></a>Meta Method on &quot;file: <strong>streams&quot;</strong> <em>:delete &amp;optional (error-p <code>t</code>)</em></dt>
<dd><p>Deletes the file open on this stream.  For the meaning of <em>error-p</em>, see the <code>deletef</code>
function.  The file doesn&rsquo;t really go away until the stream is closed.
</p></dd></dl>

<dl>
<dt><a name="index-streams_0022-on-_0022file-9"></a>Meta Method on &quot;file: <strong>streams&quot;</strong> <em>:undelete &amp;optional (error-p <code>t</code>)</em></dt>
<dd><p>If you have used the <code>:deleted</code> option in <code>open</code> to open a deleted
file, this operation undeletes the file.
</p></dd></dl>

<dl>
<dt><a name="index-streams_0022-on-_0022file-10"></a>Meta Method on &quot;file: <strong>streams&quot;</strong> <em>:rename new-name &amp;optional (error-p <code>t</code>)</em></dt>
<dd><p>Renames the file open on this stream.  For the meaning of <em>error-p</em>, see the <code>renamef</code>
function.
</p></dd></dl>


<p>File output streams implement the <code>:finish</code> and <code>:force-output</code> messages.
</p>

<a name="Accessing-Directories"></a>
<h3 class="section">21.10 Accessing Directories</h3>

<p>To understand the functions in this section, it helps to have read the following
chapter, on <em>pathnames</em>.
</p>
<a name="index-file-directory"></a>
<a name="index-directory-_0028of-files_0029"></a>

<a name="fs_003adirectory_002dlist_002dfun"></a><dl>
<dt><a name="index-fs_003adirectory_002dlist"></a>Function: <strong>fs:directory-list</strong> <em>pathname &amp;rest options</em></dt>
<dd><p>Finds all the files that match <em>pathname</em> and returns a list with one
element for each file.  Each element is a list whose car is the pathname
of the file and whose cdr is a list of the properties of the file; thus the element
is a disembodied property list and <code>get</code> may be used to access the file&rsquo;s
properties.  The car of one element is <code>nil</code>; the properties in this element
are properties of the file system as a whole rather than of a specific file.
</p>
<p>The matching is done using both host-independent and host-dependent
conventions.  <code>:wild</code> as a component of a pathname matches
anything; all files that match the remaining components of <em>pathname</em>
will be listed, regardless of their value for the wild component.  In addition,
there is host-dependent matching.  Typically this uses the asterisk
character (<code>*</code>) as a wild-card character.  A pathname component that
consists of just a <code>*</code> matches any value of that component (the same as
<code>:wild</code>).  A pathname component that contains <code>*</code> and other characters
matches any character (on ITS) or any string of characters (on TOPS-20) in
the starred positions and requires the specified characters otherwise.
In a TOPS-20 pathname, the <code>%</code> character is used to match a single
arbitrary character.
Other hosts will follow similar but not necessarily identical conventions.
</p>
<p>The <em>options</em> are keywords which modify the operation.  The following options
are currently defined:
</p><dl compact="compact">
<dt><code>:noerror</code></dt>
<dd><a name="index-_003anoerror-fs_003adirectory_002dlist"></a>
<p>If a file-system error (such as no such directory) occurs during the operation,
normally an error will be signalled and the user will be asked to supply a new pathname.
However, if <code>:noerror</code> is specified then, in the event of an error,
a string describing the error will be returned as the result of <code>fs:directory-list</code>.
This is identical to the <code>:noerror</code> option to <code>open</code>.
</p>
</dd>
<dt><code>:deleted</code></dt>
<dd><a name="index-_003adeleted-fs_003adirectory_002dlist"></a>
<p>This is for file servers on which deletion is not permanent.  It specifies
that deleted (but not yet expunged) files are to be included in the
directory listing.
</p>
</dd>
<dt><code>:sorted</code></dt>
<dd><a name="index-_003asorted-fs_003adirectory_002dlist"></a>
<p>This requests that the directory list be sorted by filenames before it
is returned.
</p></dd>
</dl>

<p>The properties that may appear in the list of property lists returned by
<code>fs:directory-list</code> are host-dependent to some extent.  The following
properties are those that are defined for both ITS and TOPS-20 file servers.  This set of
properties is likely to be extended or changed in the future.
</p><dl compact="compact">
<dt><code>:length-in-bytes</code></dt>
<dd><p>The length of the file expressed in terms of the basic units in which it is written
(characters in the case of a text file).
</p></dd>
<dt><code>:byte-size</code></dt>
<dd><p>The number of bits in one of those units.
</p></dd>
<dt><code>:length-in-blocks</code></dt>
<dd><p>The length of the file in terms of the file system&rsquo;s unit of storage allocation.
</p></dd>
<dt><code>:block-size</code></dt>
<dd><p>The number of bits in one of those units.
</p></dd>
<dt><code>:creation-date</code></dt>
<dd><p>The date the file was created, as a universal time.  See <a href="#time">time</a>.
</p></dd>
<dt><code>:reference-date</code></dt>
<dd><p>The most recent date on which the file was used, as a universal time.
</p></dd>
<dt><code>:modified-date</code></dt>
<dd><p>The most recent date on which the file&rsquo;s contents were changed, as a
universal time.
</p></dd>
<dt><code>:author</code></dt>
<dd><p>The name of the person who created the file, as a string.
</p></dd>
<dt><code>:not-backed-up</code></dt>
<dd><p><code>t</code> if the file exists only on disk, <code>nil</code> if it has been backed up on magnetic tape.
</p></dd>
<dt><code>:directory</code></dt>
<dd><p><code>t</code> if this file is actually a directory.
</p></dd>
<dt><code>:temporary</code></dt>
<dd><p><code>t</code> if this file is temporary.
</p></dd>
<dt><code>:deleted</code></dt>
<dd><p><code>t</code> if this file is deleted.  Deleted files are included in the
directory list only if you specify the <code>:deleted</code> option.
</p></dd>
<dt><code>:dont-delete</code></dt>
<dd><p><code>t</code> indicates that the file is not allowed to be deleted.
</p></dd>
<dt><code>:dont-supersede</code></dt>
<dd><p><code>t</code> indicates that the file may not be superseded; that is, a file
with the same name and higher version may not be created.
</p></dd>
<dt><code>:dont-reap</code></dt>
<dd><p><code>t</code> indicates that this file is not supposed to be deleted
automatically for lack of use.
</p></dd>
<dt><code>:dont-dump</code></dt>
<dd><p><code>t</code> indicates that this file is not supposed to be dumped onto
magnetic tape for backup purposes.
</p></dd>
<dt><code>:characters</code></dt>
<dd><p><code>t</code> indicates that this file contains characters (that is, text).
<code>nil</code> indicates that the file contains binary data.
This property, rather than the file&rsquo;s byte size, should be used to
decide whether it is a text file.
</p></dd>
<dt><code>:link-to</code></dt>
<dd><p>If the file is a link, this property is a string containing the name that
the link points to.
</p></dd>
</dl>

<p>The element in the directory list that has <code>nil</code> instead of a file&rsquo;s
pathname describes the directory as a whole.  One property that will
usually be found in this element is the <code>:pathname</code> property, whose
value is a pathname whose directory is the one you listed.  This will
usually be the same as the argument to <code>fs:directory-list</code>, plus
defaults.  But if that directory did not exist, and the user typed
another name on the keyboard, this property would reflect the name that
was typed.
</p>
<dl compact="compact">
<dt><code>:physical-volume-free-blocks</code></dt>
<dd><p>This property is an alist in which each element maps a physical volume
name (a string) into a number, the number of free blocks on that volume.
</p></dd>
<dt><code>:settable-properties</code></dt>
<dd><p>This property is a list of file property names that may be set.
This information is provided in the directory list because it is
different for different file systems.
</p></dd>
<dt><code>:pathname</code></dt>
<dd><p>This property is the pathname from which this directory list was made.
</p></dd>
<dt><code>:block-size</code></dt>
<dd><p>This is the number of words in a block in this directory.  It can be
used to interpret the numbers of free blocks.
</p></dd>
</dl>
</dd></dl>

<a name="fs_003adirectory_002dlist_002dstream_002dfun"></a><dl>
<dt><a name="index-fs_003adirectory_002dlist_002dstream"></a>Function: <strong>fs:directory-list-stream</strong> <em>pathname &amp;rest options</em></dt>
<dd><p>This is like <code>fs:directory-list</code> but returns the information in a
different form.  Instead of returning the directory list all at once, it
returns a special kind of stream which gives out one element of the
directory list at a time.
</p>
<p>The directory list stream supports two operations: <code>:entry</code> and
<code>:close</code>.  <code>:entry</code> asks for the next element of the directory
stream.  <code>:close</code> closes any connection to a remote file server.
</p>
<p>The purpose of using <code>fs:directory-list-stream</code> instead of
<code>fs:directory-list</code> is that, when communicating with a remote file
server, the directory list stream can give you some of the
information without waiting for it to all be transmitted and parsed.
This is desirable if the directory is being printed on the console.
</p></dd></dl>

<a name="fs_003aexpunge_002ddirectory_002dfun"></a><dl>
<dt><a name="index-fs_003aexpunge_002ddirectory"></a>Function: <strong>fs:expunge-directory</strong> <em>pathname &amp;key &amp;optional (error <code>t</code>)</em></dt>
<dd><p>Expunge the directory specified in <em>pathname</em>; that is, permanently
eliminate any deleted files in that directory.  If <em>error</em> is <code>nil</code>,
there is no error if the directory does not exist.
</p>
<p>Note that not all file systems support this function.  To find out
whether a particular one does, send the <code>:undeletable-p</code> operation to
a pathname.  If it returns <code>t</code>, the file system of that pathname
supports undeletion (and therefore expunging).
</p></dd></dl>

<a name="fs_003acreate_002ddirectory_002dfun"></a><dl>
<dt><a name="index-fs_003acreate_002ddirectory"></a>Function: <strong>fs:create-directory</strong> <em>pathname &amp;key &amp;optional (error <code>t</code>)</em></dt>
<dd><p>Creates the directory specified in <em>pathname</em>.
If <em>error</em> is <code>nil</code>, there is no error if the directory cannot be
created; instead an error string is returned.
Not all file servers support creation of directories.
</p></dd></dl>

<a name="fs_003aremote_002dconnect_002dfun"></a><dl>
<dt><a name="index-fs_003aremote_002dconnect"></a>Function: <strong>fs:remote-connect</strong> <em>pathname &amp;key &amp;optional (error <code>t</code>) access</em></dt>
<dd><p>Performs the TOPS-20 &quot;connect&quot; or &quot;access&quot; function, or their
equivalents, in a remote file server.  <em>access</em> specifies which one;
&quot;access&quot; is done if it is non-<code>nil</code>.
</p>
<p>The &quot;connect&quot; operation grants you full access to the
specified directory.  The &quot;access&quot; operation grants you whatever access
to all files and directories you would have if logged in on the
specified directory.  Both operations affect access only, since the connected
directory of the remote server is never used by transactions from a Lisp
Machine.
</p>
<p>This function may ask you for a password if one is required for the
directory you specify.  If the operation cannot be performed, then if
<em>error</em> is <code>nil</code>, an error string will be returned.
</p></dd></dl>

<a name="fs_003achange_002dfile_002dproperties_002dfun"></a><dl>
<dt><a name="index-fs_003achange_002dfile_002dproperties"></a>Function: <strong>fs:change-file-properties</strong> <em>pathname error-p &amp;rest properties</em></dt>
<dd><p>Some of the properties of a file may be changed; for instance, its creation
date or its author.  Exactly which properties may be changed depends on the
host file system; a list of the changeable property names is the <code>:settable-properties</code>
property of the file system as a whole, returned by <code>fs:directory-list</code>
as explained above.
</p>
<p><code>fs:change-file-properties</code> changes one or more properties of a file.
<em>pathname</em> names the file.  The <em>properties</em> arguments are alternating
keywords and values.  The <em>error-p</em> argument is the same as with <code>renamef</code>;
if an error occurs and it is <code>nil</code> a string describing the error will be
returned; if it is <code>t</code> a Lisp error will be signalled.  If no error occurs,
<code>fs:change-file-properties</code> returns <code>t</code>.
</p></dd></dl>

<a name="fs_003afile_002dproperties_002dfun"></a><dl>
<dt><a name="index-fs_003afile_002dproperties"></a>Function: <strong>fs:file-properties</strong> <em>pathname &amp;optional (error-p <code>t</code>)</em></dt>
<dd><p>Returns a disembodied property list for a single file (compare this to
<code>fs:directory-list</code>).  The car of the returned list is the truename of
the file and the cdr is an alternating list of indicators and values.
The <em>error-p</em> argument is the same as with <code>renamef</code>;
if an error occurs and it is <code>nil</code> a string describing the error will be
returned; if it is <code>t</code> (the default) a Lisp error will be signalled.
</p></dd></dl>

<a name="index-filename-completion"></a>
<a name="index-completion-_0028of-file-names_0029"></a>

<a name="fs_003acomplete_002dpathname_002dfun"></a><dl>
<dt><a name="index-fs_003acomplete_002dpathname"></a>Function: <strong>fs:complete-pathname</strong> <em>defaults string type version &amp;rest options</em></dt>
<dd><p><em>string</em> is a partially-specified file name.  (Presumably it was typed in by a user
and terminated with the <code>Altmode</code> key or the <code>End</code> key to request completion.)
<code>fs:complete-pathname</code> looks in the file system on the appropriate host and
returns a new, possibly more specific string.  Any unambiguous abbreviations
are expanded out in a host-dependent fashion.
</p>
<p><em>defaults</em>, <em>type</em>, and <em>version</em> are the arguments that will be given to
<code>fs:merge-pathname-defaults</code> (see <a href="#fs_003amerge_002dpathname_002ddefaults_002dfun">fs:merge-pathname-defaults-fun</a>) when the
user&rsquo;s input is eventually parsed and defaulted.
</p>
<p><em>options</em> are keywords (without following values) that control how the
completion will be performed.  The following option keywords are allowed:
</p><dl compact="compact">
<dt><code>:deleted</code></dt>
<dd><p>Looks for files which have been deleted but not yet expunged.
</p>
</dd>
<dt><code>:read <span class="roman">or</span> :in</code></dt>
<dd><a name="index-_003aread-fs_003acomplete_002dpathname"></a>
<a name="index-_003ain-fs_003acomplete_002dpathname"></a>
<p>The file is going to be read.  This is the default.
</p>
</dd>
<dt><code>:print <span class="roman">or</span> :write <span class="roman">or</span> :out</code></dt>
<dd><a name="index-_003aprint-fs_003acomplete_002dpathname"></a>
<a name="index-_003awrite-fs_003acomplete_002dpathname"></a>
<a name="index-_003aout-fs_003acomplete_002dpathname"></a>
<p>The file is going to be written (i.e a new version is going to be created).
</p>
</dd>
<dt><code>:old</code></dt>
<dd><p>Looks only for files that already exist.  This is the default.
</p>
</dd>
<dt><code>:new-ok</code></dt>
<dd><p>Allows either a file that already exists or a file that does not yet exist.
An example of the use of this is the <code>C-X</code> <code>C-F</code> (Find File) command in the editor.
</p>
</dd>
</dl>

<p>The first value returned is always a string containing a file name, either the
original string or a new, more specific string.  The second value returned
indicates the success or failure of the completion.  It is <code>nil</code> if an
error occurred.  One possible error is that the file is on a file system that
does not support completion, in which case the original string will be returned
unchanged.  Other possible second values are <code>:old</code>, which means that the
string completed to the name of a file that exists, <code>:new</code>, which means that
the string completed to the name of a file that could be created, and <code>nil</code>
again, which means that there is no possible completion.
</p></dd></dl>

<a name="index-Balance-Directories"></a>

<a name="fs_003abalance_002ddirectories_002dfun"></a><dl>
<dt><a name="index-fs_003abalance_002ddirectories"></a>Function: <strong>fs:balance-directories</strong> <em>pathname1 pathname2 &amp;rest options</em></dt>
<dd><p><code>fs:balance-directories</code> is a function for maintaining multiple copies
of a directory.  Often it is useful to maintain copies of your files on
more than one machine; this function provides a simple way of keeping
those copies up to date.
</p>
<p>The function first parses <em>pathname1</em>, filling in missing components
with wildcards (except for the version, which is <code>:newest</code>).  Then
<em>pathname2</em> is parsed with <em>pathname1</em> as the default.  The
resulting pathnames are used to generate directory lists using
<code>fs:directory-list</code>.  Note that the resulting directory lists need not
be entire directories; any subset of a directory that
<code>fs:directory-list</code> can produce will do.
</p>
<p>First the directory lists are matched up on the basis of file name and
type.  All of the files in either directory list which have both the
same name and the same type are grouped together.
</p>
<p>The directory lists are next analyzed to determine if the directories
are consistent, meaning that two files with the same name and type have
equal creation-dates when their versions match, and greater versions
have later creation-dates.  If any inconsistencies are found, a warning
message will be printed on the console.
</p>
<p>If the version specified for both <em>pathname1</em> and <em>pathname2</em> was
<code>:newest</code> (the default), then the newest version of each file in each
directory will be copied to the other directory if it is not already
there.  The result will be that each directory will have the newest copy
of every file in either of the two directories.
</p>
<p>If one or both of the specified versions is not <code>:newest</code>, then <em>every</em>
file that appears in one directory list and not in the other will be
copied.  This has the result that the two directories are completely the
same.  (Note that this is probably not the right thing to use to
<em>copy</em> an entire directory.  Use <code>copy-file</code> with a wildcard
argument instead.)
</p>
<p>The <em>options</em> are keywords which modify the operation.  The following
options are currently defined:
</p>
<dl compact="compact">
<dt><code>:ignore</code></dt>
<dd><a name="index-_003aignore-fs_003abalance_002ddirectories"></a>
<p>This option takes one argument, which is a list of file names to ignore
when making the directory lists.  The default value is &rsquo;().
</p>
</dd>
<dt><code>:error</code></dt>
<dd><a name="index-_003aerror-fs_003abalance_002ddirectories"></a>
<p>This option is identical to the <code>:error</code> option to <code>open</code>.
</p>
</dd>
<dt><code>:query-mode</code></dt>
<dd><a name="index-_003aquery_002dmode-fs_003abalance_002ddirectories"></a>
<p>This option takes one argument, which indicates whether or not the user
should be asked before files are transferred.  If the argument is
<code>nil</code>, no querying is done.  If it is <code>':1-&gt;2</code>, then only files
being transferred from <em>pathname2</em> to <em>pathname1</em> will be queried,
while if it is <code>':2-&gt;1</code>, then files transferred from <em>pathname1</em> to
<em>pathname2</em> will be queried.  If the argument is <code>':always</code>, then
the user will be asked about all files.
</p>
</dd>
<dt><code>:copy-mode</code></dt>
<dd><a name="index-_003acopy_002dmode-fs_003abalance_002ddirectories"></a>
<p>This option is identical to the <code>:copy-mode</code> option of <code>copy-file</code>,
and is used to control whether files are treated as binary or textual
data.
</p></dd>
</dl>
</dd></dl>

<a name="Errors-in-Accessing-Files"></a>
<h3 class="section">21.11 Errors in Accessing Files</h3>

<dl>
<dt><a name="index-_0028error_0029-on-fs_003afile_002derror"></a>Flavor Condition on fs:file-error: <strong>(<code>error</code>)</strong></dt>
<dd><p>This flavor is the basis for all errors signaled by the file system.
</p>
<p>It defines two special operations, <code>:pathname</code> and <code>:operation</code>.
Usually, these return the pathname of the file being operated on, and
the operation used.  This operation was performed either on the pathname
object itself, or on a stream.
</p>
<p>It defines prompting for the proceed types <code>:retry-file-operation</code> and
<code>:new-pathname</code>, both of which are provided for many file errors.
<code>:retry-file-operation</code> tries the operation again exactly as it was
requested by the program; <code>:new-pathname</code> expects on argument, a
pathname, and tries the same operation on this pathname instead of the
original one.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003afile_002derror_0029-on-fs_003afile_002doperation_002dfailure"></a>Condition on fs:file-operation-failure: <strong>(<code>fs:file-error</code>)</strong></dt>
<dd><p>This condition name signifies a problem with the file operation
requested.  It is an alternative to <code>fs:file-request-failure</code>
(<a href="#file_002drequest_002dfailure_002dpage">file-request-failure-page</a>), which means that the file system
was unable to consider the operation properly.
</p></dd></dl>

<p>All the following conditions in this section are always accompanied by
<code>fs:file-operation-failure</code>, <code>fs:file-error</code>, and <code>error</code>, so they
will not be mentioned.
</p>
<dl>
<dt><a name="index-fs_003afile_002dopen_002dfor_002doutput-on-"></a>Condition on : <strong>fs:file-open-for-output</strong></dt>
<dd><p>The request cannot be performed because the file is open for output.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003afile_002dlocked-on-"></a>Condition on : <strong>fs:file-locked</strong></dt>
<dd><p>The file cannot be accessed because it is already being accessed.  Just
which kinds of simultaneous access are allowed depends on the file
system.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003acircular_002dlink-on-"></a>Condition on : <strong>fs:circular-link</strong></dt>
<dd><p>A link could not be opened because it pointed, directly or indirectly
through other links, to itself.  In fact, some systems report this condition
whenever a chain of links exceeds a fixed length.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003ainvalid_002dbyte_002dsize-on-"></a>Condition on : <strong>fs:invalid-byte-size</strong></dt>
<dd><p>In <code>open</code>, the specified byte size was not valid for the particular
file server or file.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003ano_002dmore_002droom-on-"></a>Condition on : <strong>fs:no-more-room</strong></dt>
<dd><p>Processing a request requires resources not available, such as
space in a directory, or free disk blocks.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003afilepos_002dout_002dof_002drange-on-"></a>Condition on : <strong>fs:filepos-out-of-range</strong></dt>
<dd><p>The <code>:set-pointer</code> operation was used with a pointer value outside the bounds of the file.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003anot_002davailable-on-"></a>Condition on : <strong>fs:not-available</strong></dt>
<dd><p>A requested pack, file, etc. exists but is currently off line or not available to users.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003afile_002dlookup_002derror-on-"></a>Condition on : <strong>fs:file-lookup-error</strong></dt>
<dd><p>This condition name categorizes all sorts of failure to find a specified file,
for any operation.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003afile_002dlookup_002derror_0029-on-fs_003adevice_002dnot_002dfound"></a>Condition on fs:device-not-found: <strong>(<code>fs:file-lookup-error</code>)</strong></dt>
<dd><p>The specified device does not exist.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003afile_002dlookup_002derror_0029-on-fs_003adirectory_002dnot_002dfound"></a>Condition on fs:directory-not-found: <strong>(<code>fs:file-lookup-error</code>)</strong></dt>
<dd><p>The specified directory does not exist.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003afile_002dlookup_002derror_0029-on-fs_003afile_002dnot_002dfound"></a>Condition on fs:file-not-found: <strong>(<code>fs:file-lookup-error</code>)</strong></dt>
<dd><p>There is no file with the specified name, type and version.
This implies that the device and directory do exist,
or an error would have happened for them previously.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003afile_002dlookup_002derror_0029-on-fs_003alink_002dtarget_002dnot_002dfound"></a>Condition on fs:link-target-not-found: <strong>(<code>fs:file-lookup-error</code>)</strong></dt>
<dd><p>The file specified was a link, but the link&rsquo;s target filename
fails to be found.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003aaccess_002derror-on-"></a>Condition on : <strong>fs:access-error</strong></dt>
<dd><p>The operation is possible, but the file server is insubordinate and refuses to
obey you.
</p></dd></dl>

<dl>
<dt><a name="index-_0028access_002derror_0029_002e-on-fs_003aincorrect_002daccess_002dto_002dfile"></a>Condition on fs:incorrect-access-to-file: <strong>(<code>access-error</code>).</strong></dt>
<dt><a name="index-_0028access_002derror_0029_002e-on-fs_003aincorrect_002daccess_002dto_002ddirectory"></a>Condition on fs:incorrect-access-to-directory: <strong>(<code>access-error</code>).</strong></dt>
<dd><p>The file server refuses to obey you because of protection attached to
the file (or, the directory).
</p></dd></dl>

<dl>
<dt><a name="index-fs_003ainvalid_002dwildcard-on-"></a>Condition on : <strong>fs:invalid-wildcard</strong></dt>
<dd><p>A pathname had a wildcard in a place where the particular file server
does not support them.  Such pathnames will not be created by pathname
parsing, but they can be created with the <code>:new-pathname</code> operation.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003awildcard_002dnot_002dallowed-on-"></a>Condition on : <strong>fs:wildcard-not-allowed</strong></dt>
<dd><p>A pathname with a wildcard was used in an operation that does not support it.
For example, opening a file with a wildcard in its name.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003awrong_002dkind_002dof_002dfile-on-"></a>Condition on : <strong>fs:wrong-kind-of-file</strong></dt>
<dd><p>An operation was done on the wrong kind of file.
If files and directories share one name space and it is an error to open
a directory, the error will possess this condition name.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003acreation_002dfailure-on-"></a>Condition on : <strong>fs:creation-failure</strong></dt>
<dd><p>An attempt to create a file or directory failed for a reason
specifically connected with creation.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003acreation_002dfailure_0029-on-fs_003afile_002dalready_002dexists"></a>Condition on fs:file-already-exists: <strong>(<code>fs:creation-failure</code>)</strong></dt>
<dd><p>The file or directory to be created already exists.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003acreation_002dfailure-fs_003awrong_002dkind_002dof_002dfile_0029-on-fs_003asuperior_002dnot_002ddirectory"></a>Condition on fs:superior-not-directory: <strong>(<code>fs:creation-failure</code> <code>fs:wrong-kind-of-file</code>)</strong></dt>
<dd><p>In file systems where directories and files share one name space, this
error results from an attempt to create a file whose &quot;directory&quot; is some
other kind of file (not a directory).
</p></dd></dl>

<dl>
<dt><a name="index-fs_003adelete_002dfailure-on-"></a>Condition on : <strong>fs:delete-failure</strong></dt>
<dd><p>A file to be deleted exists, but for some reason cannot be deleted.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003adelete_002dfailure_0029-on-fs_003adirectory_002dnot_002dempty"></a>Condition on fs:directory-not-empty: <strong>(<code>fs:delete-failure</code>)</strong></dt>
<dd><p>A file could not be deleted because it is a directory and has files in it.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003adelete_002dfailure_0029-on-fs_003adont_002ddelete_002dflag_002dset"></a>Condition on fs:dont-delete-flag-set: <strong>(<code>fs:delete-failure</code>)</strong></dt>
<dd><p>A file could not be deleted because its &quot;don&rsquo;t delete&quot; flag is set.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003arename_002dfailure-on-"></a>Condition on : <strong>fs:rename-failure</strong></dt>
<dd><p>A file to be renamed exists, but the renaming could not be done.  The
<code>:new-pathname</code> operation on the condition instance returns the
specified new pathname, which may be a pathname or a string.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003arename_002dfailure_0029-on-fs_003arename_002dto_002dexisting_002dfile"></a>Condition on fs:rename-to-existing-file: <strong>(<code>fs:rename-failure</code>)</strong></dt>
<dd><p>Renaming cannot be done because there is already a file with the
specified new name.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003arename_002dfailure_0029-on-fs_003arename_002dacross_002ddirectories"></a>Condition on fs:rename-across-directories: <strong>(<code>fs:rename-failure</code>)</strong></dt>
<dd><p>Renaming cannot be done because the new pathname contains a different
device or directory from the one the file is on.  This may not always be
an error&ndash;some file systems support it in certain cases&ndash;but when
it is an error, it has this condition name.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003achange_002dproperty_002dfailure_0029-on-fs_003aunknown_002dproperty"></a>Condition on fs:unknown-property: <strong>(<code>fs:change-property-failure</code>)</strong></dt>
<dd><p>A property name specified in a <code>:change-properties</code> operation is not
supported by the file server.  (Some file servers support only a fixed
set of property names.)  The <code>:property</code> operation on the condition
instance returns the problematical property name.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003achange_002dproperty_002dfailure_0029-on-fs_003ainvalid_002dproperty_002dvalue"></a>Condition on fs:invalid-property-value: <strong>(<code>fs:change-property-failure</code>)</strong></dt>
<dd><p>In a <code>:change-properties</code> operation, some property was given a value
that is not valid for it.  The <code>:property</code> operation on the
condition instance returns the property name, and the <code>:value</code>
operation returns the specified value.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003achange_002dproperty_002dfailure_0029-on-fs_003ainvalid_002dproperty_002dname"></a>Condition on fs:invalid-property-name: <strong>(<code>fs:change-property-failure</code>)</strong></dt>
<dd><p>In a <code>:change-properties</code> operation, a syntactically invalid property
name was specified.  This may be because it is too long to be stored.
The <code>:property</code> operation on the condition instance returns the
property name.
</p></dd></dl>

<a name="g_t_0022File-Servers_0022"></a>
<h3 class="section">21.12 &quot;File Servers&quot;</h3>
<a name="index-file-servers"></a>
<a name="index-fascism"></a>
<a name="index-passwords"></a>
<a name="index-capabilities"></a>
<a name="passwords"></a>
<p>Files on remote file servers are accessed using <em>file servers</em> over
the Chaosnet.  Normally connections to servers are established
automatically when you try to use them, but there are a few ways you can
interact with them explicitly.
</p>
<p>When a file server is first created for you on a particular host, you
must tell the server how to log in on that host.  This involves
specifying a <em>username</em>, and, if the obstructionists are in control
of your site, a password.
The Lisp machine will prompt you for these on the terminal when they are
needed.
</p>
<p>Logging in a file server is not the same thing as logging in on the Lisp
machine (see <code>login</code>, <a href="#login_002dfun">login-fun</a>).  The latter identifies you as a
user in general and involves specifying one host, your login host.  The
former identifies you to a particular file server host and must be done
for each host on which you access files.  However, logging in on the
Lisp machine does specify the username for your login host and logs in
a file server there.
</p>
<p>The Lisp machine will always try your username (or the part that follows
the last period) as a first guess for your password (this happens to
take no extra time).  If that does not work, you will be asked to type a
password, or else a username and a password, on the keyboard.  You do
not have to give the same user name that you are logged in as, since you
may have or use different user names on different machines.
</p>
<a name="fs_003auser_002dunames_002dvar"></a><dl>
<dt><a name="index-fs_003auser_002dunames"></a>Variable: <strong>fs:user-unames</strong></dt>
<dd><p>This is an alist matching host names with the usernames you have
specified on those hosts.  Each element is the cons of a host object and
the username, as a string.
</p>
<p>For hosts running ITS, the symbol <code>fs:its</code> is used instead of a
host object.  This is because every user has the same user name on all
ITS hosts.
</p></dd></dl>

<a name="fs_003auser_002dhost_002dpassword_002dalist_002dvar"></a><dl>
<dt><a name="index-fs_003auser_002dhost_002dpassword_002dalist"></a>Variable: <strong>fs:user-host-password-alist</strong></dt>
<dd><p>Once you have specified a password for a given username and host, it
will be remembered for the duration of the session in this variable.
The value is a list of elements, each of the form
</p><div class="lisp">
<pre class="lisp">((<em>username</em> <em>hostname</em>) <em>password</em>)
</pre></div>
<p>All three data are strings.
</p></dd></dl>

<p>The remembered passwords are used if more than one file server is needed
on the same host, or if the connection is broken and a new file server
needs to be created.
</p>
<a name="index-paranoia"></a>
<p>If you are very scared of your password being known, you can turn off
the recording by setting this variable:
</p>
<a name="fs_003arecord_002dpasswords_002dflag_002dvar"></a><dl>
<dt><a name="index-fs_003arecord_002dpasswords_002dflag"></a>Variable: <strong>fs:record-passwords-flag</strong></dt>
<dd><p>Passwords are recorded when typed in if this variable is non-<code>nil</code>.
</p></dd></dl>

<p>You should set the variable at the front of your init file, and also set
the preceding variable to <code>nil</code>, since it will already have recorded
your password when you logged in.
</p>
<p>If you do not use a file server for a period of time, it is killed to
save resources on the server host.
</p>
<a name="fs_003ahost_002dunit_002dlifetime_002dvar"></a><dl>
<dt><a name="index-fs_003ahost_002dunit_002dlifetime"></a>Variable: <strong>fs:host-unit-lifetime</strong></dt>
<dd><p>This is the length of time after which an idle file server connection
should be closed, in 60&rsquo;ths of a second.  The default is 20 minutes.
</p></dd></dl>

<p>Some hosts have a caste system in which all users are not equal.  It is
sometimes necessary to enable one&rsquo;s privileges in order to exercise
them.  This is done with these functions:
</p>
<a name="fs_003aenable_002dcapabilities_002dfun"></a><dl>
<dt><a name="index-fs_003aenable_002dcapabilities"></a>Function: <strong>fs:enable-capabilities</strong> <em>host &amp;rest capabilities</em></dt>
<dd><p>Enable the named capabilities on file servers for the specified host.
<em>capabilities</em> is a list of strings, whose meanings depend on the
particular file system that is available on <em>host</em>.
If <em>capabilities</em> is <code>nil</code>, a default list of capabilities is
enabled; the default is also dependent on the operating system type.
</p></dd></dl>

<a name="fs_003adisable_002dcapabilities_002dfun"></a><dl>
<dt><a name="index-fs_003adisable_002dcapabilities"></a>Function: <strong>fs:disable-capabilities</strong> <em>host &amp;rest capabilities</em></dt>
<dd><p>Disable the named capabilities on file servers for the specified host.
<em>capabilities</em> is a list of strings, whose meanings depend on the
particular file system that is available on <em>host</em>.
If <em>capabilities</em> is <code>nil</code>, a default list of capabilities is
disabled; the default is also dependent on the operating system type.
</p></dd></dl>

<p>The PEEK system has a mode that displays the status of all your file
connections, and of the <em>host unit</em> data structures that record them.
Clicking on a connection with the mouse gets a menu of operations, of
which the most interesting is <code>reset</code>.  Resetting a host unit may
be useful if the connection becomes hung.
</p>
<a name="Errors-in-Communication-with-File-Servers"></a>
<h4 class="subsection">21.12.1 Errors in Communication with File Servers</h4>
<a name="file_002drequest_002dfailure_002dpage"></a>
<dl>
<dt><a name="index-_0028fs_003afile_002derror-error_0029-on-fs_003afile_002drequest_002dfailure"></a>Condition on fs:file-request-failure: <strong>(<code>fs:file-error</code> <code>error</code>)</strong></dt>
<dd><p>This condition name categorizes errors that prevent the file system from
processing the request made by the program.
</p></dd></dl>

<p>The following condition names are always accompanied by the more general
classifications <code>fs:file-request-failure</code>, <code>fs:file-error</code>, and <code>error</code>.
</p>
<dl>
<dt><a name="index-fs_003adata_002derror-on-"></a>Condition on : <strong>fs:data-error</strong></dt>
<dd><p>This condition signifies inconsistent data found in the file system,
indicating a failure in the file system software or hardware.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003ahost_002dnot_002davailable-on-"></a>Condition on : <strong>fs:host-not-available</strong></dt>
<dd><p>This condition signifies that the file server host is up, but refusing
connections for file servers.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003anetwork_002dlossage-on-"></a>Condition on : <strong>fs:network-lossage</strong></dt>
<dd><p>This condition signifies certain problems in the use of the chaosnet by a file server,
such as failure to open a data connection when it is expected.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003anot_002denough_002dresources-on-"></a>Condition on : <strong>fs:not-enough-resources</strong></dt>
<dd><p>This condition signifies a shortage of resources needed to consider
processing a request, as opposed to resources used up by the request
itself.  This may include running out of network connections or job
slots on the server host.  It does not include running out of space in a
directory or running out of disk space, because these are resources
whose requirements come from processing the request.
</p></dd></dl>

<dl>
<dt><a name="index-fs_003aunknown_002doperation-on-"></a>Condition on : <strong>fs:unknown-operation</strong></dt>
<dd><p>This condition signifies that the particular file system fails to
implement a standardly defined operation; such as, expunging or
undeletion on ITS.
</p></dd></dl>

<a name="Naming-of-Files"></a>
<h2 class="chapter">22 Naming of Files</h2>
<a name="index-filename"></a>
<a name="index-pathname"></a>
<a name="pathname"></a><a name="pathname_002dchapter"></a>
<p>A Lisp Machine generally has access to many file systems.  While it may
have its own file system on its own disks, usually a community of Lisp
Machine users want to have a shared file system accessible by any of the
Lisp Machines over a network.  These shared file systems can be
implemented by any computer that is capable of providing file system
service.  A file server computer may be a special-purpose computer that
does nothing but service file system requests from computers on a
network, or it may be a time-sharing system.
</p>
<p>Programs need to use names to designate files within these file systems.
The main difficulty in dealing with names of files is that different
file systems have different naming formats for files.  For example, in
the ITS file system, a typical name looks like:
</p><div class="lisp">
<pre class="lisp">	DSK: GEORGE; FOO QFASL
</pre></div>
<p>with <code>DSK</code> being a device name, <code>GEORGE</code> being a directory name, <code>FOO</code>
being the first file name and <code>QFASL</code> being the second file name.  However, in
TOPS-20, a similar file name is expressed as:
</p><div class="lisp">
<pre class="lisp">	PS:&lt;GEORGE&gt;FOO.QFASL
</pre></div>
<p>It would be unreasonable for each program that deals with file names to
be expected to know about each different file name format that exists, or
new formats that could get added in the future.  However, existing
programs should retain their abilities to manipulate the names.
</p>
<p>The functions and flavors described in this chapter exist to solve this
problem.  They provide an interface through which a program can deal with
names of files and manipulate them without depending on anything about
their syntax.  This lets a program deal with multiple remote file
servers simultaneously, using a uniform set of conventions.
</p>
<p>[On the other hand, changes in the standard pathname interface
frequently make your old programs fail to work with any file systems.
But that&rsquo;s excusable, right?]
</p>
<a name="Pathnames"></a>
<h3 class="section">22.1 Pathnames</h3>

<p>All file systems dealt with by the Lisp Machine are mapped into a common
model, in which files are named by something called a <em>pathname</em>.  A
pathname always has six components, each with a standard meaning.  These
components are the common interface that allows programs to work the
same way with different file systems; the mapping of the pathname
components into the concepts peculiar to each file system is taken care
of by the pathname software.  Pathname components are described in the
following section, and the mappings between components and user syntax
is described for each file system later in this chapter.
</p>
<p>A pathname is an instance of a flavor (see <a href="#flavor">flavor</a>); exactly which
flavor depends on what the host of the pathname is, but <code>fs:pathname</code>
is always one of its component flavors.  If <em>p</em> is a pathname, then
<code>(typep <em>p</em> 'fs:pathname)</code> will return <code>t</code>.  One of the messages
handled by host objects is the <code>:pathname-flavor</code> operation, which
returns the name of the flavor to use for pathnames on that host.  And
one of the differences between host flavors is how they handle this
operation.
</p>
<p>There are functions for manipulating pathnames, and there are also
messages that can be sent to them.  These are described later in this
chapter.
</p>
<a name="index-parse-_0028pathname_0029"></a>
<a name="index-merge-_0028pathname_0029"></a>
<p>Two important operations of the pathname system are <em>parsing</em> and <em>merging</em>.
Parsing is the conversion of a string&ndash;which might be something typed in by the
user when asked to supply the name of a file&ndash;into a pathname object.  This involves
finding out what host the pathname is for, then using the file name syntax
conventions of that host to parse the string into the standard pathname components.
Merging is the operation that takes a pathname with missing components and
supplies values for those components from a set of defaults.
</p>
<p>The function <code>string</code>, applied to a pathname, converts it into a
string that is in the file name syntax of its host&rsquo;s file system, except
that the name of the host followed by a colon is inserted at the front.
This is the inverse of parsing.  <code>princ</code> of a pathname also does this,
then prints the contents of the string.  Flavor operations such as
<code>:string-for-dired</code> exist which convert all or part of a pathname to a
string in other fashions that are designed for specific applications.
<code>prin1</code> of a pathname prints the pathname using the <code>#</code> syntax so
it can be read back in to produce an equivalent pathname (or the same
pathname, if read in the same session).
</p>
<p>Since each kind of file server can have its own character string
representation of names of its files, there has to be a different parser
for each of these representations, capable of examining such a character
string and figuring out what each component is.  The parsers all work
differently.  How can the parsing operation know which parser to use?
The first thing that the parser does is to figure out which host this
filename belongs to.  A filename character string may specify a host
explicitly by having the name of the host, followed by a colon, at
either the beginning or the end of the string.  For example, the following
strings all specify hosts explicitly:
</p><div class="lisp">
<pre class="lisp">AI: COMMON; GEE WHIZ		;<span class="roman"> This specifies host AI.</span>
COMMON; GEE WHIZ AI:		;<span class="roman"> So does this.</span>
AI: ARC: USERS1; FOO BAR	;<span class="roman"> So does this.</span>
ARC: USERS1; FOO BAR AI:	;<span class="roman"> So does this.</span>
EE:PS:&lt;COMMON&gt;GEE.WHIZ.5	;<span class="roman"> This specifies host EE.</span>
PS:&lt;COMMON&gt;GEE.WHIZ.5 EE:	;<span class="roman"> So does this.</span>
</pre></div>
<p>If the string does not specify a host explicitly, the parser will
assume some particular host is the one in question, and will use
the parser for that host&rsquo;s file system.  The optional arguments passed to
the parsing function (<code>fs:parse-pathname</code>) tell it which host to assume.
Note: the parser won&rsquo;t be confused by strings starting with <code>&quot;DSK:&quot;</code>
or <code>&quot;PS:&quot;</code> because it knows that neither of those is a valid host name.
(If some file system&rsquo;s syntax allowed file names that start with the name
of a valid host followed by a colon, there could be problems.)
</p>
<a name="pathname_002dplist_002dwarning"></a>
<p>Pathnames are kept unique, like symbols, so that there is only one
object with a given set of components.  This is useful because a
pathname object has a property list (see <a href="#plist">plist</a>) on which you can
store properties describing the file or family of files that the
pathname represents.  The uniqueness implies that any time the same
components are typed in, the program will get the same pathname object
and find there the properties it ought to find.
</p>
<p>Note that a pathname is not necessarily the name of a specific file.  Rather,
it is a way to get to a file; a pathname need not correspond to any file that
actually exists, and more than one pathname can refer to the same file.  For
example, the pathname with &quot;newest&quot; as its version will refer to the same file
as a pathname with the same components but a certain number as the version.
In systems with links, multiple file names, logical devices, etc two pathnames
that look quite different may really turn out to address the same file.
To get from a pathname to a file requires doing a file system operation
such as <code>open</code>.
</p>
<p>When you want to store properties describing an individual file,
use the pathname you get by sending <code>:truename</code> to a stream rather
than the pathname you open.  This avoids problems with different pathnames
that refer to the same file.
</p>
<p>To get a unique pathname object representing a family of files, send the
message <code>:generic-pathname</code> to a pathname for any file in the family
(see <a href="#generic_002dpathname">generic-pathname</a>).
</p>
<a name="Pathname-Components"></a>
<h3 class="section">22.2 Pathname Components</h3>

<a name="index-host-_0028pathname_0029"></a>
<a name="index-device-_0028pathname_0029"></a>
<a name="index-directory-_0028pathname_0029"></a>
<a name="index-name-_0028pathname_0029"></a>
<a name="index-type-_0028pathname_0029"></a>
<a name="index-version-_0028pathname_0029"></a>
<p>These are the components of a pathname.  They will be clarified by an example below.
</p><dl compact="compact">
<dt><em>host</em></dt>
<dd><p>An object that represents the file system machine on which the file
resides.  A host object is an instance of a flavor one of whose
components is <code>si:basic-host</code>.  The precise flavor varies depending on the type
of file system and how the files are to be accessed.
</p>
</dd>
<dt><em>device</em></dt>
<dd><p>Corresponds to the &quot;device&quot; or &quot;file structure&quot; concept in many host file systems.
</p>
</dd>
<dt><em>directory</em></dt>
<dd><p>The name of a group of related files belonging to a single user or project.
Corresponds to the &quot;directory&quot; concept in many host file systems.
</p>
</dd>
<dt><em>name</em></dt>
<dd><p>The name of a group of files that can be thought of as conceptually the
&quot;same&quot; file.  Many host file systems have a concept of &quot;name&quot; which maps
directly into this component.
</p>
</dd>
<dt><em>type</em></dt>
<dd><p>Corresponds to the &quot;filetype&quot; or &quot;extension&quot; concept in many host file systems.
This says what kind of file this is; such as, a Lisp source file, a QFASL file, etc.
</p>
</dd>
<dt><em>version</em></dt>
<dd><p>Corresponds to the &quot;version number&quot; concept in many host file systems.
This is a number that increments every time the file is modified.
</p></dd>
</dl>

<p>As an example, consider a Lisp program named <code>CONCH</code>.  If it belongs
to <code>GEORGE</code>, who uses the <code>FISH</code> machine, the host would be the
host-object for the machine <code>FISH</code>, the device would probably be the default
and the directory would be <code>GEORGE</code>.  On this directory
would be a number of files related to the <code>CONCH</code> program.  The source
code for this program would live in a set of files with name <code>CONCH</code>,
type <code>LISP</code>, and versions <code>1</code>, <code>2</code>, <code>3</code>, etc.  The compiled form
of the program would live in files named <code>CONCH</code> with type <code>QFASL</code>;
each would have the same version number as the source file that it came
from.  If the program had a documentation file, it would have type
<code>INFO</code>.
</p>
<p>Not all of the components of a pathname need to be specified.  If a
component of a pathname is missing, its value is <code>nil</code>.  Before a file
server can do anything interesting with a file, such as opening the
file, all the missing components of a pathname must be filled in from
defaults.  But pathnames with missing components are often handed around
inside the machine, since almost all pathnames typed by users do not
specify all the components explicitly.  The host is not allowed to be
missing from any pathname; since the behavior of a pathname is
host-dependent to some extent, it has to know what its host is.  All
pathnames have host attributes, even if the string being parsed does not
specify one explicitly.
</p>
<a name="index-unspecific-pathname-components"></a>

<p>A component of a pathname can also be the special symbol
<code>:unspecific</code>.  <code>:unspecific</code> means, explicitly, &quot;this component has
been specified as missing&quot;, whereas <code>nil</code> means that the component was
not specified and should default.  In merging, <code>:unspecific</code> counts as
a specified component and is not replaced by a default.  <code>:unspecific</code>
does <em>not</em> mean &quot;unspecified&quot;; it is unfortunate that those two words
are similar.
</p>
<p><code>:unspecific</code> is used in <em>generic</em> pathnames, which refer not to a
file but to a whole family of files.  The version, and usually the type,
of a generic pathname are <code>:unspecific</code>.  Another way <code>:unspecific</code>
is used has to do with mapping of pathnames into file systems such as
ITS that do not have all six components.  A component that is really not
there will be <code>:unspecific</code> in the pathname.  When a pathname is
converted to a string, <code>nil</code> and <code>:unspecific</code> both cause the
component not to appear in the string.
</p>
<p>A component of a pathname can also be the special symbol <code>:wild</code>.  This is
useful only when the pathname is being used with a directory primitive such
as <code>fs:directory-list</code> (see <a href="#fs_003adirectory_002dlist_002dfun">fs:directory-list-fun</a>), where it means that this pathname component matches
anything.  The printed representation of a pathname usually designates
<code>:wild</code> with an asterisk; however, this is host-dependent.
</p>
<p>What values are allowed for components of a pathname depends, in general,
on the pathname&rsquo;s host.  However, in order for pathnames to be usable
in a system-independent way certain global conventions are adhered to.
These conventions are stronger for the type and version than for the
other components, since the type and version are actually understood by
many programs, while the other components are usually just treated as something
supplied by the user that only needs to be remembered.
</p>
<p>In general, programs can interpret the components of a pathname
independent of the file system; and a certain minimum set of possible
values of each component will be supported on all file systems.  The
same pathname component value may have very different representations
when the pathname is made into a string, depending on the file system.
This does not affect programs that operate on the components.  The user,
when asked to type a pathname, always uses the system-dependent string
representation.  This is convenient for the user who moves between using
the Lisp machine on files stored on another host and making direct use of that
host.  However, when the mapping between string form and components is
complicated, the components may not be obvious from what you type.
</p>
<p>The type is always a string, or one of the special symbols <code>nil</code>,
<code>:unspecific</code>, and <code>:wild</code>.  Certain hosts impose a limit on the
size of string allowed, often very small.  Many programs that deal with
files have an idea of what type they want to use.  For example, Lisp
source programs are usually <code>&quot;LISP&quot;</code>, compiled Lisp programs are
<code>&quot;QFASL&quot;</code>, etc.  However, these file type conventions are
host-specific, for the important reason that some hosts do not allow a
string five characters long to be used as the type.  Therefore, programs
should use a <em>canonical type</em> rather than an actual string to specify
their conventional default file types.  Canonical types are described below.
</p>
<p>For the version, it is always legitimate to use a positive fixnum, or
certain special symbols.  <code>nil</code>, <code>:unspecific</code>, and <code>:wild</code> have
been explained above.  The other standardly allowed symbols are
<code>:newest</code> and <code>:oldest</code>.  <code>:newest</code> refers to the largest version
number that exists when reading a file, or that number plus one when
writing a new file.  <code>:oldest</code> refers to the smallest version number
that exists.  Some file systems may define other special version
symbols, such as <code>:installed</code> for example, or may allow negative
numbers.  Some do not support versions at all.  Then a pathname may still
contain any of the standard version components, but it does not matter
what the value is.
</p>
<a name="index-structured-pathname-components"></a>
<p>The device, directory, and name are more system-dependent.  These can be strings
(with host-dependent rules on allowed characters and length) or they can
be <em>structured</em>.  A structured component is a list of strings.  This
is used for file system features such as hierarchical directories.  The system is
arranged so that programs do not need to know about structured components
unless they do host-dependent operations.  Giving a string as a pathname component
to a host that wants a structured value converts the string to the appropriate
form.  Giving a structured component to a host that does not understand them
converts it to a string by taking the first element and ignoring the rest.
</p>
<p>Some host file systems have features that do not fit into this pathname
model.  For instance, directories might be accessible as files, there
might be complicated structure in the directories or names, or there
might be relative directories, such as &quot;&lt;&quot; in Multics.  These features
appear in the parsing of strings into pathnames, which is one reason why
the strings are written in host-dependent syntax.  Pathnames for hosts with
these features are also likely to handle additional messages besides the
common ones documented in this chapter, for the benefit of
host-dependent programs that want to access those features.  However,
note that once your program depends on any such features, it will only
work for certain file servers and not others; in general, it is a good
idea to make your program work just as well no matter what file server
is being used.
</p>
<a name="Raw-Components-and-Interchange-Components"></a>
<h4 class="subsection">22.2.1 Raw Components and Interchange Components</h4>
<a name="index-interchange-form-of-pathname-components"></a>
<a name="index-raw-pathname-components"></a>

<p>On some host file systems it is conventional to use lower-case letters
in file names, while in others upper case is customary, or possibly
required.  When pathname components are moved from pathnames of one file
system to pathnames of another file system, it is useful to convert the
case if necessary so that you get the right case convention for the
latter file system as a default.  This is especially useful when copying
files from one file system to another.
</p>
<p>The Lisp machine system defines two representations for each of several
pathname components (the device, directory, name and type).  There is
the <em>raw</em> form, which is what actually appears in the filename on the
host file system, and there is the <em>interchange</em> form, which may
differ in alphabetic case from the raw form.  The raw form is what is
stored inside the pathname object itself, but programs nearly always
operate on the interchange form.  The <code>:name</code>, <code>:type</code>, etc,
operations return the interchange form, and the <code>:new-name</code>, etc,
operations expect the interchange form.  Additional operations
<code>:raw-name</code>, etc, are provided for working with the raw components,
but these are rarely needed.
</p>
<p>The interchange form is defined so that it is always customarily in
upper case.  If upper case is customary on the host file system, then
the interchange form of a component is the same as the raw form.  If
lower case is customary on the host file system, as on Unix, then the
interchange form has case inverted.  More precisely, an all-upper-case
component is changed to all-lower-case, an all-lower-case component is
changed to all-upper-case, and a mixed-case component is not changed.
(This is a one-to-one mapping).  Thus, a Unix pathname with a name
component of <code>&quot;foo&quot;</code> will have an interchange-format name of
<code>&quot;FOO&quot;</code>, and vice versa.
</p>
<p>For host file systems which record case when files are created but
ignore case when comparing filenames, the interchange form is always
upper case.
</p>
<p>The host component is not really a name, and case is always ignored in
host names, so there is no need for two forms of host component.  The
version component does not need them either, because it is never a string.
</p>
<a name="Pathname-Component-Operations"></a>
<h4 class="subsection">22.2.2 Pathname Component Operations</h4>

<dl>
<dt><a name="index-_003ahost-on-fs_003apathname"></a>Method on fs:pathname: <strong>:host</strong></dt>
<dt><a name="index-_003adevice-on-fs_003apathname"></a>Method on fs:pathname: <strong>:device</strong></dt>
<dt><a name="index-_003adirectory-on-fs_003apathname"></a>Method on fs:pathname: <strong>:directory</strong></dt>
<dt><a name="index-_003aname-on-fs_003apathname"></a>Method on fs:pathname: <strong>:name</strong></dt>
<dt><a name="index-_003atype-on-fs_003apathname"></a>Method on fs:pathname: <strong>:type</strong></dt>
<dt><a name="index-_003aversion-on-fs_003apathname"></a>Method on fs:pathname: <strong>:version</strong></dt>
<dd><p>These return the components of the pathname, in interchange form.  The
returned values can be strings, special symbols, or lists of strings in
the case of structured components.  The type will always be a string or
a symbol.  The version will always be a number or a symbol.
</p></dd></dl>

<dl>
<dt><a name="index-_003araw_002ddevice-on-fs_003apathname"></a>Method on fs:pathname: <strong>:raw-device</strong></dt>
<dt><a name="index-_003araw_002ddirectory-on-fs_003apathname"></a>Method on fs:pathname: <strong>:raw-directory</strong></dt>
<dt><a name="index-_003araw_002dname-on-fs_003apathname"></a>Method on fs:pathname: <strong>:raw-name</strong></dt>
<dt><a name="index-_003araw_002dtype-on-fs_003apathname"></a>Method on fs:pathname: <strong>:raw-type</strong></dt>
<dd><p>These return the components of the pathname, in raw form.
</p></dd></dl>

<dl>
<dt><a name="index-_003anew_002ddevice-on-fs_003apathname"></a>Method on fs:pathname: <strong>:new-device</strong> <em>dev</em></dt>
<dt><a name="index-_003anew_002ddirectory-on-fs_003apathname"></a>Method on fs:pathname: <strong>:new-directory</strong> <em>dir</em></dt>
<dt><a name="index-_003anew_002dname-on-fs_003apathname"></a>Method on fs:pathname: <strong>:new-name</strong> <em>name</em></dt>
<dt><a name="index-_003anew_002dtype-on-fs_003apathname"></a>Method on fs:pathname: <strong>:new-type</strong> <em>type</em></dt>
<dt><a name="index-_003anew_002dversion-on-fs_003apathname"></a>Method on fs:pathname: <strong>:new-version</strong> <em>version</em></dt>
<dd><p>These return a new pathname that is the same as the pathname they are
sent to except that the value of one of the components has been changed.
The specified component value is interpreted as being in interchange
form, which means its case may be converted.  The <code>:new-device</code>,
<code>:new-directory</code> and <code>:new-name</code> operations accept a string (or a
special symbol) or a list that is a structured name.  If the host does
not define structured components, and you specify a list, its first
element is used.
</p></dd></dl>

<dl>
<dt><a name="index-_003anew_002draw_002ddevice-on-fs_003apathname"></a>Method on fs:pathname: <strong>:new-raw-device</strong> <em>dev</em></dt>
<dt><a name="index-_003anew_002draw_002ddirectory-on-fs_003apathname"></a>Method on fs:pathname: <strong>:new-raw-directory</strong> <em>dir</em></dt>
<dt><a name="index-_003anew_002draw_002dname-on-fs_003apathname"></a>Method on fs:pathname: <strong>:new-raw-name</strong> <em>name</em></dt>
<dt><a name="index-_003anew_002draw_002dtype-on-fs_003apathname"></a>Method on fs:pathname: <strong>:new-raw-type</strong> <em>type</em></dt>
<dd><p>These return a new pathname that is the same as the pathname they are
sent to except that the value of one of the components has been changed.
The specified component value is interpreted as raw.
</p></dd></dl>

<dl>
<dt><a name="index-_003anew_002dsuggested_002dname-on-fs_003apathname"></a>Method on fs:pathname: <strong>:new-suggested-name</strong> <em>name</em></dt>
<dt><a name="index-_003anew_002dsuggested_002ddirectory-on-fs_003apathname"></a>Method on fs:pathname: <strong>:new-suggested-directory</strong> <em>dir</em></dt>
<dd><p>These differ from the <code>:new-name</code> and <code>:new-directory</code> operations in
that the new pathname constructed has a name or directory based on the
suggestion, but not necessarily identical to it.  It tries, in a
system-dependent manner, to adapt the suggested name or directory to the
usual customs of the file system in use.
</p>
<p>For example, on a TOPS-20 system, these operations would convert
<em>name</em> or <em>dir</em> to upper case, because while lower-case letters
<em>may</em> appear in TOPS-20 pathnames, it is not customary to generate
such pathnames by default.
</p></dd></dl>

<dl>
<dt><a name="index-_003anew_002dpathname-on-fs_003apathname"></a>Method on fs:pathname: <strong>:new-pathname</strong> <em>&amp;rest options</em></dt>
<dd><p>This returns a new pathname that is the same as the pathname it is sent
to except that the values of some of the components have been changed.
<em>options</em> is a list of alternating keywords and values.  The keywords
all specify values of pathname components; they are <code>:host</code>,
<code>:device</code>, <code>:directory</code>, <code>:name</code>, <code>:type</code>, and <code>:version</code>.
Alternatively, the keywords <code>:raw-device</code>, <code>:raw-directory</code>,
<code>:raw-name</code> and <code>:raw-type</code> may be used to specify a component in
raw form.
</p>
<p>Two additional keywords, <code>:canonical-type</code> and <code>:original-type</code>,
allow the type field to be specified as a canonical type.  See the
following section for a description of canonical types.  Also, the value
specified for the keyword <code>:type</code> may be a canonical type symbol.
</p>
<p>The operations <code>:new-name</code>, etc, are equivalent to <code>:new-pathname</code>
specifying only one component to be changed; in fact, that is how those
operations are implemented.
</p></dd></dl>

<a name="Canonical-Types"></a>
<h4 class="subsection">22.2.3 Canonical Types</h4>
<a name="canonical_002dtypes"></a><a name="index-canonical-type-_0028of-a-pathname_0029"></a>

<p><em>Canonical types</em> are a way of specifying a pathname type component
using host-dependent conventions without making the program itself
explicitly host dependent.  For example, the function <code>qc-file</code>
normally provides a default type of <code>&quot;LISP&quot;</code>, but on VMS systems the
default must be <code>&quot;LSP&quot;</code> instead, and on Unix systems it is <code>&quot;l&quot;</code>.
What <code>qc-file</code> actually does is to use a canonical type, the keyword
<code>:lisp</code>, as the default.  This keyword is given a definition as a
canonical type, which specifies what it maps into on various file
systems.
</p>
<p>A single canonical type may have more than one mapping on a particular
file system.  For example, on TOPS-20 systems the canonical type
<code>:LISP</code> maps into either <code>&quot;LISP&quot;</code> or <code>&quot;LSP&quot;</code>.  One of the
possibilities is marked as &quot;preferred&quot;; in this case, it is <code>&quot;LISP&quot;</code>.
The effect of this is that either <code>FOO.LISP</code> or <code>FOO.LSP</code> would be
acceptable as having canonical type <code>:lisp</code>, but merging will
yield <code>&quot;LISP&quot;</code> as the type when defaulting from <code>:lisp</code>.
</p>
<p>Note that the canonical type of a pathname is not a distinct component.
It is another way of describing or specifying the type component.
</p>
<p>A canonical type must be defined before it is used.
</p>
<a name="fs_003adefine_002dcanonical_002dtype_002dfun"></a><dl>
<dt><a name="index-fs_003adefine_002dcanonical_002dtype"></a>Special Form: <strong>fs:define-canonical-type</strong> <em>symbol standard-mapping system-dependent-mappings...</em></dt>
<dd><p>Defines <em>symbol</em> as a canonical type.  <em>standard-mapping</em> is the
actual type component that it maps into (a string), with exceptions as
specified by <em>system-dependent-mappings</em>.  Each element of
<em>system-dependent-mappings</em> (that is, each additional argument) is a list of the form
</p><div class="lisp">
<pre class="lisp">(<em>system-type</em> <em>preferred-mapping</em> <em>other-mappings</em>...)
</pre></div>
<p><em>system-type</em> is one of the system-type keywords the <code>:system-type</code>
operation on a host object can return, such as <code>:unix</code>, <code>:tops20</code>,
and <code>:lispm</code> (see <a href="#si_003ahost_002dalist_002dvar">si:host-alist-var</a>).  The argument describes how
to map this canonical type on that type of file system.
<em>preferred-map</em> (a string) is the preferred mapping of the canonical
type, and <em>other-mappings</em> are additional strings that are accepted as
matching the canonical type.
</p>
<p><em>system-type</em> may also be a list of system types.  Then the argument
applies to all of those types of file systems.
</p>
<p>All of the mapping strings are in interchange form.
</p>
<p>For example, the canonical type <code>:lisp</code> is defined as follows:
</p><div class="lisp">
<pre class="lisp">(fs:define-canonical-type :lisp &quot;LISP&quot;
  (:unix &quot;L&quot; &quot;LISP&quot;)
  (:vms &quot;LSP&quot;)
  ((:tops20 :tenex) &quot;LISP&quot; &quot;LSP&quot;))
</pre></div>

<p>Other canonical types defined by the system include <code>:qfasl</code>,
<code>:text</code>, <code>:press</code>, <code>:qwabl</code>, <code>:babyl</code>, <code>:mail</code>, <code>:xmail</code>,
<code>:init</code>, <code>:patch-directory</code>, <code>:midas</code>, <code>:palx</code>, <code>:unfasl</code>,
<code>:kst</code>, <code>:widths</code>, and <code>:output</code>.  The standard mapping for each
is the symbol&rsquo;s pname.
</p></dd></dl>

<p>To match a pathname against a canonical type, use the <code>:canonical-type</code> operation.
</p>
<dl>
<dt><a name="index-_003acanonical_002dtype-on-fs_003apathname"></a>Method on fs:pathname: <strong>:canonical-type</strong></dt>
<dd><p>Returns two values which describe whether and how this pathname&rsquo;s type
component matches any canonical type.
</p>
<p>If the type component is one of the possible mappings of some canonical
type, the first value is that canonical type (the symbol).  The second
value is <code>nil</code> if the type component is the preferred mapping of the
canonical type; otherwise it is the actual type component, in
interchange form.  The second value is called the <em>original type</em> of
the pathname.
</p>
<p>If the type component does not match a canonical type, the first value is the
type component in interchange form (a string), and the second value is <code>nil</code>.
</p>
<p>This operation is useful in matching a pathname against a canonical
type; the first value is <code>eq</code> to the canonical type if the pathname
matches it.  The operation is also useful for transferring a type field
from one file system to another while preserving canonical type; this is
described below.
</p></dd></dl>

<p>A new pathname may also be constructed by specifying a canonical type.
</p>
<dl>
<dt><a name="index-_003anew_002dcanonical_002dtype-on-fs_003apathname"></a>Method on fs:pathname: <strong>:new-canonical-type</strong> <em>canonical-type &amp;optional original-type</em></dt>
<dd><p>Returns a pathname different from this one in having a type component
that matches <em>canonical-type</em>.
</p>
<p>If <em>original-type</em> is a possible mapping for <em>canonical-type</em> on
this pathname&rsquo;s host, then it is used as the type component.  Otherwise,
the preferred mapping for <em>canonical-type</em> is used.  If
<em>original-type</em> is not specified, it defaults to this pathname&rsquo;s type
component.  If it is specified as <code>nil</code>, the preferred mapping of the
canonical type is always used.  If <em>canonical-type</em> is a string rather
than an actual canonical type, it is used directly as the type
component, and the <em>original-type</em> does not matter.
</p>
<p>The <code>:new-pathname</code> operation accepts the keywords <code>:canonical-type</code>
and <code>:origial-type</code>.  The <code>:new-canonical-type</code> operation is
equivalent to <code>:new-pathname</code> with those keywords.
</p></dd></dl>

<p>Suppose you wish to copy the file named <em>old-pathname</em> to a directory
named <em>target-directory-pathname</em>, possibly on another host, while
preserving the name, version and canonical type.  That is, if the original file
has a name acceptable for a QFASL file, the new file should also.
Here is how to compute the new pathname:
</p><div class="lisp">
<pre class="lisp">(multiple-value-bind (canonical original)
    (send old-pathname ':canonical-type)
  (send target-directory-pathname ':new-pathname 
	':name (send old-pathname ':name)
	':version (send old-pathname ':version)
	':canonical-type canonical
	':original-type original))
</pre></div>

<p>Suppose that <em>old-pathname</em> is <code>OZ:&lt;FOO&gt;A.LISP.5</code>, where <code>OZ</code> is a
TOPS-20, and the target directory is on a VMS host.  <code>canonical</code> will
be <code>:lisp</code> and <code>original</code> will be <code>&quot;LISP&quot;</code>.  Since <code>&quot;LISP&quot;</code> is
not an acceptable mapping for <code>:lisp</code> on a VMS system, the resulting pathname
will have as its type component the preferred mapping for <code>:lisp</code> on VMS,
namely, <code>&quot;LSP&quot;</code>.
</p>
<p>But if the target host is a Unix host, the new file&rsquo;s type will be
<code>&quot;LISP&quot;</code>, since that is an acceptable (though not preferred) mapping
for <code>:lisp</code> on Unix hosts.
If you would rather that the preferred mapping always be used for the
new file&rsquo;s type, omit the <code>:original-type</code> argument to the
<code>:new-pathname</code> operation.  This would result in a type component of
<code>&quot;L&quot;</code> in interchange form, or <code>&quot;l&quot;</code> in raw form, in the new file&rsquo;s pathname.
</p>
<p>The function <code>qc-file</code> actually does something cleverer than using the
canonical type as a default.  Doing that, and opening the resulting
pathname, would look only for the preferred mapping of the canonical
type.  <code>qc-file</code> actually tries to open <em>each</em> possible mapping,
trying the preferred mapping first.  Here is how it does so:
</p>
<dl>
<dt><a name="index-_003aopen_002dcanonical_002ddefault_002dtype-on-fs_003apathname"></a>Method on fs:pathname: <strong>:open-canonical-default-type</strong> <em>canonical-type &amp;rest options</em></dt>
<dd><p>If this pathname&rsquo;s type component is non-<code>nil</code>, the pathname is simply
opened, passing the <em>options</em> to the <code>:open</code> operation.  If the type
component is <code>nil</code>, each mapping of <em>canonical-type</em> is tried as a
type component, in the order the mappings appear in the canonical type
definition.  If an open succeeds, a stream is returned.  The
possibilities continue to be tried as long as <code>fs:file-not-found</code>
errors happen; other errors are not handled.  If all the possibilities fail,
a <code>fs:file-not-found</code> error is signaled for the caller, with a pathname
that contains the preferred mapping as its type component.
</p></dd></dl>

<a name="Defaults-and-Merging"></a>
<h3 class="section">22.3 Defaults and Merging</h3>
<a name="index-default-_0028pathname_0029"></a>
<a name="index-merge-_0028pathname_0029-1"></a>

<p>When the user is asked to type in a pathname, it is of course unreasonable
to require the user to type a complete pathname, containing all components.
Instead there are defaults, so that components not specified by the user can
be supplied automatically by the system.  Each program that deals with pathnames
typically has its own set of defaults.
</p>
<p>The system defines an object called a <em>defaults alist</em>.  Functions are
provided to create one, get the default pathname out of one, merge a pathname
with one, and store a pathname back into one.  A defaults alist can remember
more than one default pathname if defaults are being kept separately for
each host; this is controlled by the variable <code>fs:*defaults-are-per-host*</code>.
The main primitive for using defaults is the function
<code>fs:merge-pathname-defaults</code> (see <a href="#fs_003amerge_002dpathname_002ddefaults_002dfun">fs:merge-pathname-defaults-fun</a>).
</p>
<p>In place of a defaults alist, you may use just a pathname.  Defaulting one
pathname from another is useful for cases such as a program that has an input
file and an output file, and asks the user for the name of both, letting
the unsupplied components of one name default from the other.  Unspecified
components of the output pathname will come from the input pathname, except
that the type should default not to the type of the input but to the appropriate
default type for output from this program.
</p>
<p>The implementation of a defaults alist is an association list of host names
and default pathnames.  The host name <code>nil</code> is special and holds the
defaults for all hosts, when defaults are not per-host.
</p>
<a name="pathname_002dmerging_002drules"></a><p>The <em>merging</em> operation takes as input a pathname, a defaults alist
(or another pathname), a default type, and a default version, and returns a
pathname.  Basically, the missing components in the pathname are filled
in from the defaults alist.  However, if a name is specified but the
type or version is not, then the type or version is treated specially.
</p>
<p>The full details of the merging rules are as follows.  First, if no host
is specified, the host is taken from the defaults.  If the
pathname explicitly specifies a host and does not supply a device, then the
device will be the default file device for that host.  
</p>
<p>If the pathname specifies a device named <code>DSK</code>, that is replaced with the
<em>working device</em> for the pathname&rsquo;s host, and the directory defaults to
the <em>working directory</em> for the host if it is not specified.  See
<code>fs:set-host-working-directory</code>, below.
</p>
<p>Next, if the pathname does not specify a host, device, directory, or name,
that component comes from the defaults.
</p>
<p>If the value of <code>fs:*always-merge-type-and-version*</code> is non-<code>nil</code>,
the type and version are merged just like the other components.
</p>
<p>If <code>fs:*always-merge-type-and-version*</code> is <code>nil</code>, as it normally
is, the merging rules for the type and version are more complicated
and depend on whether the pathname specifies a name.  If the pathname
doesn&rsquo;t specify a name, then the type and version, if not provided,
will come from the defaults, just like the other components.  However,
if the pathname does specify a name, then the type and version come
from the <em>default-type</em> and <em>default-version</em> arguments to
<code>merge-pathname-defaults</code>.  If those arguments were omitted, the
value of <code>fs:*name-specified-default-type*</code> (initially, <code>:lisp</code>)
is used as the default type, and <code>:newest</code> is used as the default
version.
</p>
<p>The reason for this is that the type and version
&quot;belong to&quot; some other filename, and are thought to be unlikely to have
anything to do
with the new filename you are typing in.
</p>
<a name="fs_003aset_002dhost_002dworking_002ddirectory_002dfun"></a><dl>
<dt><a name="index-fs_003aset_002dhost_002dworking_002ddirectory"></a>Function: <strong>fs:set-host-working-directory</strong> <em>host pathname</em></dt>
<dd><p>This sets the <em>working device</em> and <em>working directory</em> for <em>host</em> to
those specified in <em>pathname</em>.  <em>host</em> should be a host object or the
name of a host.  <em>pathname</em> may be a string or a pathname.
The working device and working directory are used for defaulting pathnames
in which the device is specified as <code>DSK</code>.
</p>
<p>The editor command <code>Meta-X Set Working Directory</code> provides a convenient
interface to this function.
</p></dd></dl>

<p>The following special variables are parts of the pathname interface
that are relevant to defaults.
</p>
<a name="fs_003a_002adefaults_002dare_002dper_002dhost_002a_002dvar"></a><dl>
<dt><a name="index-fs_003a_002adefaults_002dare_002dper_002dhost_002a"></a>Variable: <strong>fs:*defaults-are-per-host*</strong></dt>
<dd><p>This is a user customization option intended to be set by a user&rsquo;s
<code>LISPM INIT</code> file (see <a href="#lispm_002dinit_002dfile">lispm-init-file</a>).  The default value is
<code>nil</code>, which means that each program&rsquo;s set of defaults contains only
one default pathname.  If you type in just a host name and a colon, the
other components of the name will default from the previous host, with
appropriate translation to the new host&rsquo;s pathname syntax.  If
<code>fs:*defaults-are-per-host*</code> is set to <code>t</code>, each program&rsquo;s set of
defaults will maintain a separate default pathname for each host.  If
you type in just a host name and a colon, the last file that was
referenced on that host will be used. 
</p></dd></dl>

<a name="fs_003a_002aalways_002dmerge_002dtype_002dand_002dversion_002a_002dvar"></a><dl>
<dt><a name="index-fs_003a_002aalways_002dmerge_002dtype_002dand_002dversion_002a"></a>Variable: <strong>fs:*always-merge-type-and-version*</strong></dt>
<dd><p>If this variable is non-<code>nil</code>, then the type and version are defaulted
only from the pathname defaults just like the other components.
</p></dd></dl>

<a name="fs_003a_002aname_002dspecified_002ddefault_002dtype_002a_002dvar"></a><dl>
<dt><a name="index-fs_003a_002aname_002dspecified_002ddefault_002dtype_002a"></a>Variable: <strong>fs:*name-specified-default-type*</strong></dt>
<dd><p>If <code>fs:*always-merge-type-and-version*</code> is nil, then when a name is
specified but not a type, the type defaults from an argument to the
merging function.  If that argument is not specified, this variable&rsquo;s
value is used.  It may be a string or a canonical type keyword.  The
value is initially <code>:lisp</code>.
</p></dd></dl>

<a name="fs_003a_002adefault_002dpathname_002ddefaults_002a_002dvar"></a><dl>
<dt><a name="index-fs_003a_002adefault_002dpathname_002ddefaults_002a"></a>Variable: <strong>fs:*default-pathname-defaults*</strong></dt>
<dd><p>This is the default defaults alist; if the pathname primitives that need
a set of defaults are not given one, they use this one.  Most programs, however,
should have their own defaults rather than using these.
</p></dd></dl>

<a name="fs_003aload_002dpathname_002ddefaults_002dvar"></a><dl>
<dt><a name="index-fs_003aload_002dpathname_002ddefaults"></a>Variable: <strong>fs:load-pathname-defaults</strong></dt>
<dd><p>This is the defaults alist for the <code>load</code> and <code>qc-file</code> functions.  Other
functions may share these defaults if they deem this to be an appropriate user
interface.
</p></dd></dl>

<a name="fs_003alast_002dfile_002dopened_002dvar"></a><dl>
<dt><a name="index-fs_003alast_002dfile_002dopened"></a>Variable: <strong>fs:last-file-opened</strong></dt>
<dd><p>This is the pathname of the last file that was opened.  Occasionally this
is useful as a default.  Since some programs deal with files without
notifying the user, you must not expect the user to know what the
value of this symbol is.  Using this symbol as a default may cause
unfortunate surprises, and so such use is discouraged.
</p></dd></dl>


<p>These functions are used to manipulate defaults alists directly.
</p>
<a name="fs_003amake_002dpathname_002ddefaults_002dfun"></a><dl>
<dt><a name="index-fs_003amake_002dpathname_002ddefaults"></a>Function: <strong>fs:make-pathname-defaults</strong></dt>
<dd><p>Creates a defaults alist initially containing no defaults.  If you ask
this empty set of defaults for its default pathname before anything has
been stored into it you will get the file <code>FOO</code> on the user&rsquo;s home
directory on the host he logged in to.
</p></dd></dl>

<a name="fs_003acopy_002dpathname_002ddefaults_002dfun"></a><dl>
<dt><a name="index-fs_003acopy_002dpathname_002ddefaults"></a>Function: <strong>fs:copy-pathname-defaults</strong> <em>defaults</em></dt>
<dd><p>Creates a defaults alist initially a copy of <em>defaults</em>.
</p></dd></dl>

<a name="fs_003adefault_002dpathname_002dfun"></a><dl>
<dt><a name="index-fs_003adefault_002dpathname"></a>Function: <strong>fs:default-pathname</strong> <em>&amp;optional defaults host default-type default-version</em></dt>
<dd><p>This is the primitive function for getting a default pathname out of a defaults alist.
Specifying the optional arguments <em>host</em>, <em>default-type</em>, and <em>default-version</em>
to be non-<code>nil</code> forces those fields of the returned pathname to contain those values.
</p>
<p>If <code>fs:*defaults-are-per-host*</code> is <code>nil</code> (its default value), this gets the
one relevant default from the alist.  If it is <code>t</code>, this gets the default for
<em>host</em> if one is specified, otherwise for the host most recently used.
</p>
<p>If <em>defaults</em> is not specified, the default defaults are used.
</p>
<p>This function has an additional optional argument <em>internal-p</em>, is obsolete.
</p></dd></dl>

<a name="fs_003adefault_002dhost_002dfun"></a><dl>
<dt><a name="index-fs_003adefault_002dhost"></a>Function: <strong>fs:default-host</strong> <em>defaults</em></dt>
<dd><p>Returns the default host object specified by the defaults-alist <em>defaults</em>.
This is the host that will be used by pathname defaulting with the given defaults
if no host is specified.
</p></dd></dl>

<a name="fs_003aset_002ddefault_002dpathname_002dfun"></a><dl>
<dt><a name="index-fs_003aset_002ddefault_002dpathname"></a>Function: <strong>fs:set-default-pathname</strong> <em>pathname &amp;optional defaults</em></dt>
<dd><p>This is the primitive function for updating a set of defaults.  It
stores <em>pathname</em> into <em>defaults</em>.
If <em>defaults</em> is not specified, the default defaults are used.
</p></dd></dl>

<a name="Pathname-Functions"></a>
<h3 class="section">22.4 Pathname Functions</h3>

<p>These functions are what programs use to parse and default file names
that have been typed in or otherwise supplied by the user.
</p>
<a name="fs_003aparse_002dpathname_002dfun"></a><dl>
<dt><a name="index-fs_003aparse_002dpathname"></a>Function: <strong>fs:parse-pathname</strong> <em>thing &amp;optional host defaults</em></dt>
<dd><p>This turns <em>thing</em>, which can be a pathname, a string, a symbol, or a
Maclisp-style name list, into a pathname.  Most functions that are advertised
to take a pathname argument call <code>fs:parse-pathname</code> on it so that they will
accept anything that can be turned into a pathname.
</p>
<p>This function does <em>not</em> do defaulting, even though it has an argument
named <em>defaults</em>; it only does parsing.  The <em>host</em> and <em>defaults</em>
arguments are there because in order to parse a string into a pathname,
it is necessary to know what host it is for so that it can be parsed with
the file name syntax peculiar to that host.  If <em>thing</em> does not contain
a manifest host name, then if <em>host</em> is non-<code>nil</code>, it is the host name
to use, as a string.  If <em>thing</em> is a string, a manifest host name may be
at the beginning or the end, and consists of the name of a host followed by a colon.
If <em>host</em> is <code>nil</code> then the host name is obtained
from the default pathname in <em>defaults</em>.  If <em>defaults</em> is not supplied,
the default defaults (<code>fs:*default-pathname-defaults*</code>) are used.
</p>
<p>Note that if <em>host</em> is specified, and <em>thing</em> contains a host name, an
error is signalled if they are not the same host.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003apathname_002derror-error_0029-on-fs_003apathname_002dparse_002derror"></a>Condition on fs:pathname-parse-error: <strong>(<code>fs:pathname-error</code> <code>error</code>)</strong></dt>
<dd><p>This condition is signaled when <code>fs:parse-pathname</code> finds a syntax
error in the string it is given.
</p>
<p><code>fs:parse-pathname</code> sets up a nonlocal proceed type <code>:new-pathname</code>
for this condition.  The proceed type expects one argument, a pathname,
which is returned from <code>fs:parse-pathname</code>.
</p></dd></dl>

<a name="fs_003amerge_002dpathname_002ddefaults_002dfun"></a><dl>
<dt><a name="index-fs_003amerge_002dpathname_002ddefaults"></a>Function: <strong>fs:merge-pathname-defaults</strong> <em>pathname &amp;optional defaults default-type default-version</em></dt>
<dd><p>Fills in unspecified components of <em>pathname</em> from the defaults and returns
a new pathname.  This is the function that most programs should call to
process a file name supplied by the user.  <em>pathname</em> can be a pathname,
a string, a symbol, or a Maclisp namelist.  The returned value will always
be a pathname.  The merging rules are documented on <a href="#pathname_002dmerging_002drules">pathname-merging-rules</a>.
</p>
<p>If <em>defaults</em> is a pathname, rather than a defaults alist, then the defaults
are taken from its components.  This is how you merge two pathnames.  (In Maclisp
that operation is called <code>mergef</code>.)
</p>
<p><em>defaults</em> defaults to the value of <code>fs:*default-pathname-defaults*</code>
if unsupplied.  <em>default-type</em> defaults to the value of
<code>fs:*name-specified-default-type*</code>.  <em>default-version</em> defaults to <code>:newest</code>.
</p></dd></dl>

<a name="fs_003amerge_002dand_002dset_002dpathname_002ddefaults_002dfun"></a><dl>
<dt><a name="index-fs_003amerge_002dand_002dset_002dpathname_002ddefaults"></a>Function: <strong>fs:merge-and-set-pathname-defaults</strong> <em>pathname &amp;optional defaults default-type default-version</em></dt>
<dd><p>This is the same as <code>fs:merge-pathname-defaults</code> except that after it
is done the defaults-list <em>defaults</em> is modified so that the merged
pathname is the new default.  This is handy for programs that have
&quot;sticky&quot; defaults.  (If <em>defaults</em> is a pathname rather than a
defaults alist, then no storing back is done.)  The optional arguments
default the same way as in <code>fs:merge-pathname-defaults</code>.
</p></dd></dl>

<p>This function yields a pathname given its components.
</p>
<a name="fs_003amake_002dpathname_002dfun"></a><dl>
<dt><a name="index-fs_003amake_002dpathname"></a>Function: <strong>fs:make-pathname</strong> <em>&amp;rest options</em></dt>
<dd><p>The <em>options</em> are alternating keywords and values, which specify the
components of the pathname.  Missing components default to <code>nil</code>,
except the host (all pathnames must have a host).  The <code>:defaults</code>
option specifies what defaults to get the host from if none is
specified.  The other options allowed are <code>:host</code>,
<code>:device</code>, <code>:structured-device</code>, <code>:directory</code>,
<code>:structured-directory</code>, <code>:name</code>, <code>:structured-name</code>, <code>:type</code>,
and <code>:version</code>.
</p></dd></dl>

<p>These functions return useful information.
</p>
<a name="fs_003auser_002dhomedir_002dfun"></a><dl>
<dt><a name="index-fs_003auser_002dhomedir"></a>Function: <strong>fs:user-homedir</strong> <em>&amp;optional host reset-p</em></dt>
<dd><a name="index-home-directory"></a>
<p>Returns the pathname of the logged-in user&rsquo;s home directory on <em>host</em>, which defaults
to the host the user logged in to.  Home directory is a somewhat system-dependent
concept, but from the point of view of the Lisp Machine it is the directory where the
user keeps personal files such as init files and mail.
This function returns a pathname without any name, type, or version component
(those components are all <code>nil</code>).
If <em>reset-p</em> is specified non-<code>nil</code>, the machine the user is logged in to
is changed to be <em>host</em>.
</p></dd></dl>

<a name="fs_003ainit_002dfile_002dpathname_002dfun"></a><dl>
<dt><a name="index-fs_003ainit_002dfile_002dpathname"></a>Function: <strong>fs:init-file-pathname</strong> <em>program-name &amp;optional host</em></dt>
<dd><a name="index-init-file"></a>
<p>Returns the pathname of the logged-in user&rsquo;s init file for the program <em>program-name</em>,
on the <em>host</em>, which defaults to the host the user logged in to.  Programs that load
init files containing user customizations call this function to find where to look
for the file, so that they need not know the separate init file name conventions of
each host operating system.  The <em>program-name</em> <code>&quot;LISPM&quot;</code> is used by the <code>login</code>
function.
</p></dd></dl>

<p>These functions are useful for poking around.
</p>
<a name="fs_003adescribe_002dpathname_002dfun"></a><dl>
<dt><a name="index-fs_003adescribe_002dpathname"></a>Function: <strong>fs:describe-pathname</strong> <em>pathname</em></dt>
<dd><p>If <em>pathname</em> is a pathname object, this describes it, showing you its properties
(if any) and information about files with that name that have been loaded into the
machine.  If <em>pathname</em> is a string, this describes all interned pathnames that
match that string, ignoring components not specified in the string.
One thing this is useful for is finding the directory of a file
whose name you remember.  Giving <code>describe</code> (see <a href="#describe_002dfun">describe-fun</a>) a pathname
object will do the same thing as this function will.
</p></dd></dl>

<a name="fs_003apathname_002dplist_002dfun"></a><dl>
<dt><a name="index-fs_003apathname_002dplist"></a>Function: <strong>fs:pathname-plist</strong> <em>pathname</em></dt>
<dd><p>Parses and defaults <em>pathname</em>, then returns the list of properties of that pathname.
</p></dd></dl>

<a name="fs_003a_002apathname_002dhash_002dtable_002a_002dvar"></a><dl>
<dt><a name="index-fs_003a_002apathname_002dhash_002dtable_002a"></a>Variable: <strong>fs:*pathname-hash-table*</strong></dt>
<dd><p>This is the hash table in which pathname objects are interned.  Applying the
function <code>maphash</code> to this will extract all the pathnames in the world.
</p></dd></dl>

<a name="Generic-Pathnames"></a>
<h3 class="section">22.5 Generic Pathnames</h3>

<a name="index-generic-pathname"></a>
<a name="generic_002dpathname"></a>
<p>A generic pathname stands for a whole family of files.  The property
list of a generic pathname is used to remember information about the
family, some of which (such as the package) comes from the <code>-*-</code> line
(see <a href="#file_002dattribute_002dlist">file-attribute-list</a>)
of a source file in the family.  Several types of files with that name, in
that directory, belong together.  They are different members of the same
family; for example, they may be source code and compiled code.
However, there may be several other types
of files that form a logically distinct group even though they have
this same name; <code>TEXT</code> and <code>PRESS</code> for example.  The exact mapping is
done on a per host basis since it can sometimes be affected by host naming
conventions.
</p>
<p>The generic pathname of pathname <em>p</em> usually has the same host,
device, directory, and name as <em>p</em> does.  However, it has a version of
<code>:unspecific</code>.  The type of the generic pathname is obtained by
sending a <code>:generic-base-type</code> <em>type-of-p</em> message to the host of
<em>p</em>.  The default response to this message is to return the associated
type from <code>fs:*generic-base-type-alist*</code> if there is one, else
<em>type-of-p</em>.  Both the argument and the value are either strings, in
interchange form, or canonical type symbols.
</p>
<p>However, the ITS file system presents special problems.  One cannot
distinguish multiple generic base types in this same way since the type
component does not exist as such; it is derived from the second
filename, which unfortunately is also sometimes used as a version
number.  Thus, on ITS, the type of a generic pathname is always
<code>:unspecific</code> if there is any association for the type of the pathname
on <code>fs:*generic-base-type-alist*</code>. 
</p>
<p>Since generic pathnames are primarily useful for storing properties,
it is important that they be as standardized and conceptualized as possible.
For this reason, generic pathnames are defined to be &quot;backtranslated&quot;, i.e
the generic pathname of a pathname that is (or could be) the result of a logical host
translation has the host and directory of the logical pathname.  For
example, the generic pathname of <code>AI:LMWIN;STREAM &gt;</code> would be
<code>SYS:WINDOW;STREAM  </code> if <code>AI</code> is the system host.
</p>
<p>All version numbers of a particular pathname share the
same identical generic pathname.  If the values of particular properties have
changed between versions, it is possible for confusion to result.
One way to deal with this problem is to have the property be a list associating
version number with the actual desired property.  Then it is relatively
easy to determine which versions have which values for the property in question
and select one appropriately.  But in the applications for which
generic pathnames are typically used, this is not necessary.
</p>
<p>The <code>:generic-pathname</code> operation on a pathname returns its
corresponding generic pathname.  See
<a href="#fs_003apathname_002dgeneric_002dpathname_002dmethod">fs:pathname-generic-pathname-method</a>.  The <code>:source-pathname</code> operation
on a pathname returns the actual or probable pathname of the
corresponding source file (with <code>:newest</code> as the version).  See
<a href="#fs_003apathname_002dsource_002dpathname_002dmethod">fs:pathname-source-pathname-method</a>.
</p>
<a name="fs_003a_002ageneric_002dbase_002dtype_002dalist_002a_002dvar"></a><dl>
<dt><a name="index-fs_003a_002ageneric_002dbase_002dtype_002dalist_002a"></a>Variable: <strong>fs:*generic-base-type-alist*</strong></dt>
<dd><p>This is an association list of the file types and the type of the generic pathname
used for the group of which that file type is a part.  Constructing a generic
pathname will replace the file type with the association from this list, if there
is one (except that ITS hosts always replace with <code>:unspecific</code>).
File types not in this list are really part of the name in some sense.
The initial list is
</p><div class="lisp">
<pre class="lisp"> ((:text . :text) (&quot;DOC&quot; . :text)
  (:press . :text) (&quot;XGP&quot; . :text)
  (:lisp . :unspecific) (:qfasl . :unspecific)
  (NIL . :unspecific))
</pre></div>
<p>The association of <code>:lisp</code> and <code>:unspecific</code> is unfortunately made
necessary by the problems of ITS mentioned previously.  This way makes
the generic pathnames of logically mapped <code>LISP</code> files identical no
matter whether the logical host is mapped to an ITS host or not.
</p>
<p>The first entry in the list with a particular cdr is the entry for
the type that source files have.  Note how the first element whose
cdr is <code>:unspecific</code> is the one for <code>:lisp</code>.  This is how the
<code>:source-pathname</code> operation knows what to do, by default.
</p>
<p>Some users may need to add to this list.
</p></dd></dl>

<p>The system records certain properties on generic pathnames
automatically.
</p>
<dl compact="compact">
<dt><code>:warnings</code></dt>
<dd><p>This property is used to record compilation and other warnings for the
file.
</p>
</dd>
<dt><code>:definitions</code></dt>
<dd><p>This property records all the functions and other things defined in the
file.  The value has one element for each
package into which the file has been loaded; the element&rsquo;s car is the
package itself and the cdr is a list of definitions made.
</p>
<p>Each definition is a cons whose car is the symbol or function spec
defined and whose cdr is the type of definition (usually one of the
symbols <code>defun</code>, <code>defvar</code>, <code>defflavor</code> and <code>defstruct</code>).
</p>
</dd>
<dt><code>:systems</code></dt>
<dd><p>This property&rsquo;s value is a list of the names of all the systems (defined
with <code>defsystem</code>, see <a href="#defsystem_002dfun">defsystem-fun</a>) of which this is a source file.
</p>
</dd>
<dt><code>:file-id-package-alist</code></dt>
<dd><p>This property records what version of the file was most recently loaded.
In case the file has been loaded into more than one package, as is
sometimes necessary, the loaded version is remembered for each package
separately.  This is how <code>make-system</code> tells whether a file needs to
be reloaded.  The value is a list with an element for each package that
the file has been loaded into; the elements look like
</p><div class="lisp">
<pre class="lisp">(package file-information)
</pre></div>
<p><em>package</em> is the package object itself; <em>file-information</em>
is the value returned by the <code>:info</code> operation on a file stream, and
is usually a cons whose car is the truename (a pathname) and whose cdr
is the file creation date (a universal time number).
</p></dd>
</dl>

<p>Some additional properties are put on the generic pathname by reading
the attribute list of the file (see <a href="#fs_003aread_002dattribute_002dlist_002dfun">fs:read-attribute-list-fun</a>).  It
is not completely clear that this is the right place to store these
properties, so it may change in the future.  Any property name can
appear in the attributes list and get onto the generic pathname; the
standard ones are described in <a href="#file_002dattribute_002dlist">file-attribute-list</a>.
</p>

<a name="Pathname-Operations"></a>
<h3 class="section">22.6 Pathname Operations</h3>

<p>This section documents the operations a user may send to a pathname
object.  Pathnames handle some additional operations that are only
intended to be sent by the file system itself, and therefore are not
documented here.  Someone who wants to add a new host to the system
would need to understand those internal operations.  This section also
does not document operations that are peculiar to pathnames of a
particular host; those would be documented under that host.
</p>
<a name="fs_003apathname_002dgeneric_002dpathname_002dmethod"></a><dl>
<dt><a name="index-_003ageneric_002dpathname-on-fs_003apathname"></a>Method on fs:pathname: <strong>:generic-pathname</strong></dt>
<dd><p>Returns the generic pathname for the family of files of which this pathname is a member.
See <a href="#generic_002dpathname">generic-pathname</a> for documentation on generic pathnames.
</p></dd></dl>

<a name="fs_003apathname_002dsource_002dpathname_002dmethod"></a><dl>
<dt><a name="index-_003asource_002dpathname-on-fs_003apathname"></a>Method on fs:pathname: <strong>:source-pathname</strong></dt>
<dd><p>Returns the pathname for the source file in the family of files to which
this pathname belongs.  The returned pathname will have <code>:newest</code>
as its version.  If the file has been loaded in some fashion into the
Lisp environment, then the pathname type is that which the user actually
used.  Otherwise, the conventional file type for source files is determined
from the generic pathname.
</p></dd></dl>

<dl>
<dt><a name="index-_003aprimary_002ddevice-on-fs_003apathname"></a>Method on fs:pathname: <strong>:primary-device</strong></dt>
<dd><p>Returns the default device name for the pathname&rsquo;s host.  This is used
in generating the initial default pathname for a host.
</p></dd></dl>

<dl>
<dt><a name="index-_003awild_002dp-on-fs_003apathname"></a>Method on fs:pathname: <strong>:wild-p</strong></dt>
<dd><p>Returns <code>t</code> if this pathname contains any sort of wildcards.
</p></dd></dl>

<p>Operations to get a path name string out of a pathname object:
</p>
<dl>
<dt><a name="index-_003astring_002dfor_002dprinting-on-fs_003apathname"></a>Method on fs:pathname: <strong>:string-for-printing</strong></dt>
<dd><p>Returns a string that is the printed representation of the path name.  This is
the same as what you get if you <code>princ</code> the pathname or take <code>string</code> of it.
</p></dd></dl>

<dl>
<dt><a name="index-_003astring_002dfor_002dwholine-on-fs_003apathname"></a>Method on fs:pathname: <strong>:string-for-wholine</strong> <em>length</em></dt>
<dd><p>Returns a string like the <code>:string-for-printing</code>, but designed to fit
in <em>length</em> characters.  <em>length</em> is a suggestion; the actual
returned string may be shorter or longer than that.  However, the
who-line updater will truncate the value to that length if it is longer.
</p></dd></dl>

<dl>
<dt><a name="index-_003astring_002dfor_002deditor-on-fs_003apathname"></a>Method on fs:pathname: <strong>:string-for-editor</strong></dt>
<dd><p>Returns a string that is the pathname with its components rearranged so
that the name is first.  The editor uses this form to name its buffers.
</p></dd></dl>

<dl>
<dt><a name="index-_003astring_002dfor_002ddired-on-fs_003apathname"></a>Method on fs:pathname: <strong>:string-for-dired</strong></dt>
<dd><p>Returns a string to be used by the directory editor.  The string contains only
the name, type, and version.
</p></dd></dl>

<dl>
<dt><a name="index-_003astring_002dfor_002ddirectory-on-fs_003apathname"></a>Method on fs:pathname: <strong>:string-for-directory</strong></dt>
<dd><p>Returns a string that contains only the device and directory of
the pathname.  It identifies one directory among all directories on the host.
</p></dd></dl>

<dl>
<dt><a name="index-_003astring_002dfor_002dhost-on-fs_003apathname"></a>Method on fs:pathname: <strong>:string-for-host</strong></dt>
<dd><p>Returns a string that is the pathname the way the host file system likes to see it.
</p></dd></dl>

<p>Operations to move around through a hierarchy of directories:
</p>
<dl>
<dt><a name="index-_003apathname_002das_002ddirectory-on-fs_003apathname"></a>Method on fs:pathname: <strong>:pathname-as-directory</strong></dt>
<dd><p>Assuming that the file described by the pathname is a directory,
return another pathname specifying that <em>as</em> a directory.
Thus, if sent to a pathname <code>OZ:&lt;RMS&gt;FOO.DIRECTORY</code>, it would return the
pathname <code>OZ:&lt;RMS.FOO&gt;</code>.  The name, type and version of the returned
pathname are <code>:unspecific</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003adirectory_002dpathname_002das_002dfile-on-fs_003apathname"></a>Method on fs:pathname: <strong>:directory-pathname-as-file</strong></dt>
<dd><p>This is the inverse of the preceding operation.  It returns a pathname
specifying as a file the directory of the original pathname.  The name,
type and version of the original pathname are ignored.
</p></dd></dl>

<p>The special symbol <code>:root</code> can be used as the directory component of a
pathname on file systems that have a root directory.
</p>
<p>Operations to manipulate the property list of a pathname:
</p>
<dl>
<dt><a name="index-_003aget-on-fs_003apathname"></a>Method on fs:pathname: <strong>:get</strong> <em>indicator</em></dt>
<dt><a name="index-_003agetl-on-fs_003apathname"></a>Method on fs:pathname: <strong>:getl</strong> <em>list-of-indicators</em></dt>
<dt><a name="index-_003aputprop-on-fs_003apathname"></a>Method on fs:pathname: <strong>:putprop</strong> <em>value indicator</em></dt>
<dt><a name="index-_003aremprop-on-fs_003apathname"></a>Method on fs:pathname: <strong>:remprop</strong> <em>indicator</em></dt>
<dt><a name="index-_003aplist-on-fs_003apathname"></a>Method on fs:pathname: <strong>:plist</strong></dt>
<dd><p>These manipulate the pathname&rsquo;s property list, and are used if you call
the property list functions of the same names (see <a href="#get_002dfun">get-fun</a>) giving
the pathname as the first argument.  Please read the paragraph on
<a href="#pathname_002dplist_002dwarning">pathname-plist-warning</a> explaining some care you must take in using
property lists of pathnames.
</p></dd></dl>


<p>Here are the operations that access files.  Many accept an argument
<em>error</em> or <em>error-p</em> which specifies whether to signal an error or
to return a condition instance, if the file cannot be accessed.  For
these arguments, <code>nil</code> and non-<code>nil</code> are the only significant values.
<code>:reprompt</code> has no special meaning as a value.  That value when passed
to one of the file accessing functions (<code>open</code>, <code>deletef</code>, etc)
has its special significance at a higher level.
</p>
<dl>
<dt><a name="index-_003atruename-on-fs_003apathname"></a>Method on fs:pathname: <strong>:truename</strong></dt>
<dd><p>Return a pathname object describing the exact name of the file specified
by the pathname the object is sent to.
</p>
<p>This may be different from the original pathname.  For example, the
original pathname may have <code>:newest</code> as the version, but the truename
will have a number as the version.
</p></dd></dl>

<dl>
<dt><a name="index-_003aopen-on-fs_003apathname"></a>Method on fs:pathname: <strong>:open</strong> <em>pathname &amp;rest options</em></dt>
<dd><p>This operation opens a stream for the file named by the pathname.
The argument <em>pathname</em> is what the <code>:pathname</code> operation on the
resulting stream should return.  When a logical pathname is opened,
<em>pathname</em> will be that logical pathname, but <code>self</code> will be
its translated pathname.
</p>
<p><em>options</em> is a list of alternating keywords and values, as would be
passed to <code>open</code>.  The old style of <code>open</code> keywords are not allowed;
when they are used with <code>open</code>, <code>open</code> converts them to the new
style before sending the <code>:open</code> message.
</p></dd></dl>

<dl>
<dt><a name="index-_003adelete-on-fs_003apathname"></a>Method on fs:pathname: <strong>:delete</strong> <em>&amp;optional (error-p <code>t</code>)</em></dt>
<dt><a name="index-_003aundelete-on-fs_003apathname"></a>Method on fs:pathname: <strong>:undelete</strong> <em>&amp;optional (error-p <code>t</code>)</em></dt>
<dd><p>Delete or undelete the file specified by the pathname.
</p>
<p>All file systems support <code>:delete</code> but not all support <code>:undelete</code>.
</p>
<p>If <em>error-p</em> is <code>nil</code>, problems such as nonexistent files cause a
string describing the problem to be returned.  Otherwise, they signal an
error.
</p></dd></dl>

<dl>
<dt><a name="index-_003aundeletable_002dp-on-fs_003apathname"></a>Method on fs:pathname: <strong>:undeletable-p</strong></dt>
<dd><p>Returns <code>t</code> if this pathname is for a file system which allows
deletion to be undone.  Such pathnames will support the <code>:undelete</code>
and <code>:expunge</code> operations.
</p></dd></dl>

<dl>
<dt><a name="index-_003arename-on-fs_003apathname"></a>Method on fs:pathname: <strong>:rename</strong> <em>new-name &amp;optional (error-p <code>t</code>)</em></dt>
<dd><p>Rename the file specified by the pathname.  <em>new-name</em>, a string or
pathname, specifies the name to rename to.  If it is a string, it is
parsed using <code>self</code> as the defaults.
</p>
<p>If <em>error-p</em> is <code>nil</code>, problems such as nonexistent files cause a
string describing the problem to be returned.  Otherwise, they signal an
error.
</p></dd></dl>

<dl>
<dt><a name="index-_003acomplete_002dstring-on-fs_003apathname"></a>Method on fs:pathname: <strong>:complete-string</strong> <em>string options</em></dt>
<dd><p>Attempt to complete the filename <em>string</em>, returning the results.
This operation is used by the function <code>fs:complete-pathname</code> (see
<a href="#fs_003acomplete_002dpathname_002dfun">fs:complete-pathname-fun</a>).  The pathname the message is sent to is
used for defaults.  <em>options</em> is a list whose elements may include
<code>:deleted</code>, <code>:read</code> (file is for input), <code>:write</code> (it&rsquo;s for
output), <code>:old</code> (only existing files allowed), or <code>:new-ok</code> (new files
are allowed too).
</p>
<p>There are two values: a string, which is the completion as far as possible,
and a flag, which can be <code>:old</code>, <code>:new</code> or <code>nil</code>.
<code>:old</code> says that the returned string names an existing file,
<code>:new</code> says that the returned string is no file but some completion was done,
<code>nil</code> says that no completion was possible.
</p></dd></dl>

<dl>
<dt><a name="index-_003achange_002dproperties-on-fs_003apathname"></a>Method on fs:pathname: <strong>:change-properties</strong> <em>error-p &amp;rest properties</em></dt>
<dd><p>This operation changes the properties of the file specified by the
pathname.  <em>properties</em> should be an
alternating list of property names and values.
</p></dd></dl>

<dl>
<dt><a name="index-_003adirectory_002dlist-on-fs_003apathname"></a>Method on fs:pathname: <strong>:directory-list</strong> <em>options</em></dt>
<dd><p>Performs the work of <code>(fs:directory-list <em>this-pathname</em> <em>options</em>...)</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003awildcard_002dmap-on-fs_003apathname"></a>Method on fs:pathname: <strong>:wildcard-map</strong> <em>function plistp dir-list-options &amp;rest args</em></dt>
<dd><p>Map <em>function</em> over all the
files specified by this pathname (which may contain wildcards).
Each time <em>function</em> is called, its first argument will be a pathname
with no wildcards, or else a directory-list element (whose car is a
pathname and whose cdr contains property names and values).
The elements of <em>args</em> will be given to <em>function</em> as additional
arguments.
</p>
<p><em>plistp</em> says whether <em>function</em>&rsquo;s first argument should be a
directory-list element or just a pathname.  <code>t</code> specifies a
directory-list element.  That provides more information, but it makes it
necessary to do extra work if the specified pathname does <em>not</em>
contain wildcards.
</p>
<p><em>dir-list-options</em> is passed to <code>fs:directory-list</code>.  You can use this
to get deleted files mentioned in the list, for example.
</p></dd></dl>

<p>The remaining file-access operations are defined only on certain file
systems.
</p>
<dl>
<dt><a name="index-_003aexpunge-on-fs_003apathname"></a>Method on fs:pathname: <strong>:expunge</strong> <em>&amp;key &amp;optional (error <code>t</code>)</em></dt>
<dd><p>Expunge the directory specified by the host, device and directory
components of the pathname.
</p>
<p>The argument <em>error</em> says whether to signal an error if the directory
does not exist.  <code>nil</code> means just return a string instead.
</p></dd></dl>

<dl>
<dt><a name="index-_003acreate_002ddirectory-on-fs_003apathname"></a>Method on fs:pathname: <strong>:create-directory</strong> <em>&amp;key &amp;optional (error <code>t</code>)</em></dt>
<dd><p>Creates the directory specified in this pathname.
</p></dd></dl>

<dl>
<dt><a name="index-_003aremote_002dconnect-on-fs_003apathname"></a>Method on fs:pathname: <strong>:remote-connect</strong> <em>&amp;optional &amp;key (error <code>t</code>) access</em></dt>
<dd><p>This performs the work of <code>fs:remote-connect</code> with the same arguments
on this pathname&rsquo;s host.
</p></dd></dl>

<a name="Host-File-Systems-Supported"></a>
<h3 class="section">22.7 Host File Systems Supported</h3>

<p>This section lists the host file systems supported, gives an example
of the pathname syntax for each system, and discusses any special idiosyncracies.
More host types will no doubt be added in the future.
</p>
<a name="ITS"></a>
<h4 class="subsection">22.7.1 ITS</h4>

<a name="index-ITS-pathnames"></a>

<p>An ITS pathname looks like <code>&quot;<em>host</em>: <em>device</em>: <em>dir</em>; <em>name</em> <em>type-or-version</em>&quot;</code>.
The primary device is <code>DSK:</code> but other devices such as <code>ML:</code>, <code>ARC:</code>,
<code>DVR:</code>, or <code>PTR:</code> may be used.
</p>
<p>ITS does not exactly fit the virtual file system model, in that a file
name has two components (FN1 and FN2) rather than three (name, type, and
version).  Consequently to map any virtual pathname into an ITS
filename, it is necessary to choose whether the FN2 will be the type or
the version.  The rule is that usually the type goes in the FN2 and the
version is ignored; however, certain types (<code>LISP</code> and <code>TEXT</code>) are
ignored and instead the version goes in the FN2.  Also if the type is <code>:unspecific</code>
the FN2 is the version.
</p>
<p>Given an ITS filename, it is converted into a pathname by making the FN2
the version if it is &quot;&lt;&quot;, &quot;&gt;&quot;, or a number.  Otherwise the FN2 becomes
the type.  ITS pathnames allow the special version symbols <code>:oldest</code>
and <code>:newest</code>, which correspond to &quot;&lt;&quot; and &quot;&gt;&quot; respectively.
</p>
<p>In every ITS pathname either the version or the type is <code>:unspecific</code>
or <code>nil</code>; sometimes both are.  When you create a new ITS pathname, if
you specify only the version or only the type, the one not specified
becomes <code>:unspecific</code>.  If both are specified, the version is
<code>:unspecific</code> unless the type is a normally-ignored type (such as
<code>LISP</code>) in which case the version is <code>:newest</code> and the type is
<code>:unspecific</code> so that numeric FN2&rsquo;s are found.
</p>
<p>Each component of an ITS pathname is mapped to upper case and truncated to
six characters.
</p>
<p>Special characters (space, colon, and semicolon) in a component of an ITS pathname
can be quoted by prefixing them with right horseshoe (<code>delta</code>)
or equivalence sign (<code></code>).  Right horseshoe is the same character code in the
Lisp Machine character set as control-Q in the ITS character set.
</p>
<p>An ITS pathname can have a structured name, which is a list of two strings,
the FN1 and the FN2.  In this case there is neither a type nor a version.
</p>
<p>An ITS pathname with an FN2 but no FN1 (i.e a type and/or version but no name)
is represented with the placeholder FN1 <code>&quot;&quot;</code>, because ITS pathname syntax
provides no way to write an FN2 without an FN1 before it.
</p>
<p>The ITS init file naming convention is <code>&quot;<em>homedir</em>; <em>user</em> <em>program</em>&quot;</code>.
</p>
<a name="fs_003a_002aits_002duninteresting_002dtypes_002a_002dvar"></a><dl>
<dt><a name="index-fs_003a_002aits_002duninteresting_002dtypes_002a"></a>Variable: <strong>fs:*its-uninteresting-types*</strong></dt>
<dd><p>The ITS file system does not have separate file types and version numbers;
both components are stored in the &quot;FN2&quot;.  This variable is a list of the file
types that are &quot;not important&quot;; files with these types use the FN2 for a version
number.  Files with other types use the FN2 for the type and do not have a version
number.  The initial list is
</p><div class="lisp">
<pre class="lisp">(&quot;LISP&quot; &quot;TEXT&quot; nil :unspecific)
</pre></div>
<p>Some users may need to add to this list.
</p></dd></dl>

<dl>
<dt><a name="index-_003afn1-on-its_002dpathname"></a>Method on its-pathname: <strong>:fn1</strong></dt>
<dt><a name="index-_003afn2-on-its_002dpathname"></a>Method on its-pathname: <strong>:fn2</strong></dt>
<dd><p>These two operations return a string that is the FN1 or FN2 host-dependent
component of the pathname.
</p></dd></dl>

<dl>
<dt><a name="index-_003atype_002dand_002dversion-on-fs_003apathname"></a>Method on fs:pathname: <strong>:type-and-version</strong></dt>
<dt><a name="index-_003anew_002dtype_002dand_002dversion-on-fs_003apathname"></a>Method on fs:pathname: <strong>:new-type-and-version</strong> <em>new-type new-version</em></dt>
<dd><p>These two operations provide a way of pretending that ITS pathnames can
have both a type and a version.  It uses the first three characters of
the FN2 to store a type and the last three to store a version number.
</p>
<p>On an ITS-pathname,
<code>:type-and-version</code> returns the type and version thus extracted (not
the same as the type and version of the pathname).
<code>:new-type-and-version</code> returns a new pathname constructed from the
specified new type and new version.
</p>
<p>On any other type of pathname, these operations simply return or set
both the type component and the version component.
</p></dd></dl>

<a name="TOPS_002d20-_0028Twenex_0029_002c-Tenex_002c-and-VMS_002e"></a>
<h4 class="subsection">22.7.2 TOPS-20 (Twenex), Tenex, and VMS.</h4>

<a name="index-TOPS_002d20-pathnames"></a>
<a name="index-Twenex-pathnames"></a>

<p>A pathname on TOPS-20 (better known as Twenex) looks like
<code>&quot;<em>host</em>:<em>device</em>:&lt;<em>directory</em>&gt;<em>name</em>.<em>type</em>.<em>version</em>&quot;</code>.
The primary device is <code>PS:</code>.
</p>
<p>TOPS-20 pathnames are mapped to upper case.  Special characters (including
lower-case letters) are quoted with the circle-X (<code>circleX</code>) character, which
has the same character code in the Lisp Machine character set as <code>Control-V</code>
in the ASCII character set.
</p>
<p>If you specify a period after the name, but nothing after that,
then the type is <code>:unspecific</code>, which translates into an empty
extension on the TOPS-20 system.  If you omit the period, you have
allowed the type to be defaulted.
</p>
<p>TOPS-20 pathnames allow the special version symbols <code>:oldest</code> and
<code>:newest</code>.  In the string form of a pathname, these are expressed as
&quot;<code>.-2</code>&quot;, and as an omitted version.
</p>
<p>The directory component of a TOPS-20 pathname may be structured.  The
directory <code>&lt;FOO.BAR&gt;</code> is represented as the list <code>(&quot;FOO&quot; &quot;BAR&quot;)</code>.
</p>
<p>The characters <code>*</code> and <code>%</code> are wildcards that match any sequence of
characters and any single character (within one pathname component),
respectively.  To specify a filename that actually contains a <code>*</code> or
<code>%</code> character, quote the character with <code>circleX</code>.  When a component is
specified with just a single <code>*</code>, the symbol <code>:wild</code> appears in the
pathname object.  When wildcards are embedded in pathname components, the
pathname object represents them by using the character <code>#\break</code> to stand
for <code>*</code> and <code>#\quote</code> to stand for <code>%</code>.  If a <code>*</code> or <code>%</code>
character appears in a component of a pathname object, it stands for a
quoted character, since the convention is that quote characters are <em>not</em>
present in the components stored in the pathname object.
</p>
<p>The TOPS-20 init file naming convention is <code>&quot;&lt;<em>user</em>&gt;<em>program</em>.INIT&quot;</code>.
</p>
<p>When there is an attempt to display a TOPS-20 file name in the who-line and
there isn&rsquo;t enough room to show the entire name, the name is truncated
and followed by a center-dot character to indicate that there is more to
the name than can be displayed.
</p>
<a name="index-Tenex-pathnames"></a>
<p>Tenex pathnames are almost the same as TOPS-20 pathnames, except that
the version is preceeded by a semi-colon instead of a period, the
default device is <code>DSK</code> instead of <code>PS</code>, and the quoting
requirements are slightly different.
</p>
<a name="index-VMS-pathnames"></a>
<a name="index-Very-Mangled-Software"></a>

<p>VMS pathnames are basically like TOPS-20 pathnames, with a few
complexities.  The primary device is <code>SYS$SYSDISK</code>.
</p>
<p>First of all, only alphanumeric characters are allowed in filenames
(though <code>$</code> and underscore can appear in device names).
</p>
<p>Secondly, a version number is preceded by &quot;<code>;</code>&quot; rather than by &quot;<code>.</code>&quot;.
</p>
<p>Thirdly, file types (&quot;extensions&quot;) are limited to three characters.
Each of the system&rsquo;s canonical types has a special mapping for VMS pathnames,
which is three characters long:
</p><div class="lisp">
<pre class="lisp">:lisp  LSP	:text  TXT	:qfasl  QFS	:midas  MID
:press  PRS	:widths  WID	:patch-directory  PDR
:qwabl  QWB	:babyl  BAB	:mail  MAI	:xmail  XML
:init  INI 	:unfasl  UNF	:output  OUT
</pre></div>

<a name="Unix-pathnames"></a>
<h4 class="subsection">22.7.3 Unix pathnames</h4>
<a name="index-Unix-pathnames"></a>

<p>A Unix pathname is a sequence of directory or file names separated by
slashes.  The last name is the filename; preceding ones are directory
names (but directories are files anyway).  There are no devices or
versions.  Alphabetic case is significant in Unix pathnames, no case
conversion is normally done, and lower case is the default.  Therefore,
components of solid upper or lower case are inverted in case when going
between interchange form and raw form.  (What the user types in a
pathname string is the raw form.)
</p>
<p>Unix allows you to specify a pathname relative to your default directory
by using just a filename, or starting with the first subdirectory name;
you can specify it starting from the root directory by starting with
a slash.  In addition, you can start with &quot;<code>..</code>&quot; as a directory name one
or more times, to refer upward in the hierarchy from the default
directory.
</p>
<p>Unix pathnames on the Lisp Machine provide all these features too, but
the canonicalization to a simple descending list of directory names
starting from the root is done on the Lisp Machine itself when you merge
the specified pathname with the defaults.
</p>
<p>If a pathname string starts with a slash, the pathname object that
results from parsing it is called &quot;absolute&quot;.  Otherwise the pathname
object is called &quot;relative&quot;.
</p>
<p>In an absolute pathname object, the directory component is either a
symbol (<code>nil</code>, <code>:unspecific</code> or <code>:root</code>), a string, or a list of
strings.  A single string is used when there is only one level of
directory in the pathname.
</p>
<p>A relative pathname has a directory that is a list of the symbol
<code>:relative</code> followed by some strings.  When the pathname is merged
with defaults, the strings in the list are appended to the strings
in the default directory.  The result of merging is always an absolute
pathname.
</p>
<p>In a relative pathname&rsquo;s string form, the string &quot;<code>..</code>&quot; can be used as a
directory name.  It is translated to the symbol <code>:up</code> when the string
is parsed.  That symbol is processed when the relative pathname is
merged with the defaults.
</p>
<p>Restrictions on the length of Unix pathnames require abbreviations for
the standard Zetalisp pathname types, just as for VMS.  On Unix the
preferred mappings of all canonical types are one or two characters
long.  We give here the mappings in raw form; they are actually
specified in interchange form.
</p><div class="lisp">
<pre class="lisp">:lisp  l	:text  tx	:qfasl  qf	:midas  md
:press  pr	:widths  wd	:patch-directory  pd
:qwabl  qw	:babyl  bb	:mail  ma	:xmail  xm
:init  in	:unfasl  uf	:output  ot
</pre></div>

<a name="index-Multics-pathnames"></a>

<p>The Multics file system is much like the Unix one; there are absolute
and relative pathnames, absolute ones start with a directory delimiter,
and there are no devices or versions.  Alphabetic case is significant.
</p>
<p>There are differences in details.  Diretory names are terminated, and
absolute pathnames begun, with the character &quot;<code>&gt;</code>&quot;.  The containing
directory is referred to by the character &quot;<code>&lt;</code>&quot;, which is complete in
itself.  It does not require a delimiter.  Thus, <code>&lt;&lt;FOO&gt;BAR</code> refers to
subdirectory <code>FOO</code>, file <code>BAR</code> in the superdirectory of the superdirectory
of the default directory.
</p>
<p>The limits on filename sizes are very large, so the system canonical
types all use their standard mappings.  Since the mappings are specified
as upper case, and then interpreted as being in interchange form, the
actual file names on Multics will contain lower case.
</p>
<a name="Lisp-Machine-File-Systems"></a>
<h4 class="subsection">22.7.4 Lisp Machine File Systems</h4>
<a name="index-Lisp-machine-pathnames"></a>

<p>There are two file systems that run in the MIT Lisp Machine system.
They have different pathname syntax.  Both can be accessed either
remotely like any other file server, or locally.
</p>
<a name="index-Local_002dFile-pathnames"></a>

<p>The Local-File system uses host name <code>LM</code> for the machine you are on.
A Local-File system on another machine can be accessed using the name of
that machine as a host name, provided that machine is known as a file
server.
</p>
<p>The remainder of the pathname for the Local-File system looks like
<code>&quot;<em>directory</em>; <em>name</em>.<em>type</em>#<em>version</em>&quot;</code>.  There is no restriction on the length
of names; letters are converted to upper case.  Subdirectories are
allowed and are specified by putting periods between the directory
components, as in <code>RMS.SUBDIR;</code>.
</p>
<p>The TOPS-20 pathname syntax is also accepted.  In addition, if the flag
<code>fs:*lmfs-use-twenex-syntax*</code> is non-<code>nil</code>, Local-File pathnames will
print out using TOPS-20 syntax.  Note that since the printed representation
of a pathname is cached, changing this flag&rsquo;s value will not change the
printing of pathnames with existing representations.
</p>
<p>The Local-File system on the filecomputer at MIT has the host name <code>FS</code>.
</p>
<a name="index-LMFILE-pathnames"></a>

<p>The LMFILE system is primarily for use as a file server, unless you have
512k of memory.  At MIT it runs on the filecomputer and is accessed
remotely with host name <code>FC</code>.
</p>
<p>The remainder of an LMFILE pathname looks like <code>&quot;<em>directory</em>;
<em>name</em> <em>type</em>#<em>version</em>&quot;</code>.  However, the directory and name can
be composed of any number of subnames, separated by backslashes.  This
is how subdirectories are specified.  <code>FOO;BAR\X</code> refers to the same
file as <code>FOO\BAR;X</code>, but the two ways of specifying the file have
different consequences in defaulting, getting directory listings, etc.
</p>
<p>Case is significant in LMFILE pathnames; however, when you open a file,
the LMFILE system ignores the case when it matches your pathname against
the existing files.  As a result, the case you use matters when you
create or rename a file, and appears in directory listings, but it is
ignored when you refer to an existing file, and you cannot have two
files whose names differ only in case.  When components are accessed in
interchange form, they are always converted to upper case.
</p>
<a name="Logical-Pathnames"></a>
<h4 class="subsection">22.7.5 Logical Pathnames</h4>
<a name="index-logical-pathnames"></a>

<p>There is another kind of pathname that doesn&rsquo;t correspond to any
particular file server.  It is called a &quot;logical&quot; pathname, and its host
is called a &quot;logical&quot; host.  Every logical pathname can be translated
into a corresponding &quot;physical&quot; pathname; there is a mapping from
logical hosts into physical hosts used to effect this translation.
</p>
<p>The reason for having logical pathnames is to make it easy to keep bodies
of software on more than one file system.  An important example is the body
of software that constitutes the Lisp Machine system.  Every site has a
copy of all of the sources of the programs that are loaded into the initial
Lisp environment.  Some sites may store the sources on an ITS file system,
while others may store them on a TOPS-20.  However, there is software
that wants to deal with the pathnames of these files in such a way that the
software will work correctly no matter which site it is run at.  The way
this is accomplished is that there is a logical host called <code>SYS</code>;
all pathnames for system software files are actually logical pathnames with
host <code>SYS</code>.  At each site, <code>SYS</code> is defined as a logical host, but
translation will work differently at one site than at another.  At a site
where the sources are stored on a certain TOPS-20, for example, pathnames
of the <code>SYS</code> host will be translated into pathnames for that TOPS-20.
</p>
<p>Here is how translation is done.  For each logical host, there is a
mapping that takes the name of a directory on the logical host and
produces a device and a directory for the corresponding physical host.
To translate a logical pathname, the system finds the mapping for that
pathname&rsquo;s host and looks up that pathname&rsquo;s directory in the mapping.
If the directory is found, a new pathname is created whose host is the
physical host, and whose device and directory come from the mapping.
The other components of the new pathname are left the same.  There is
also, for each logical host, a &quot;default device&quot; (it is an instance
variable of the host object).  The &quot;default device&quot; is used if a
translation exists but specifies <code>nil</code> as the device.  If there is no
translation for the specified directory, an error is signaled.
</p>
<p>This means that when you invent a new logical host for a certain set
of files, you also make up a set of logical directory names, one for
each of the directories that the set of files is stored in.  Now when
you create the mappings at particular sites, you can choose any physical
host for the files to reside on, and for each of your logical directory
names, you can specify the actual directory name to use on the physical
host.  This gives you flexibility in setting up your directory names; if
you used a logical directory name called <code>FRED</code> and you want to move
your set of files to a new file server that already has a directory
called <code>FRED</code>, being used by someone else, you can translate <code>FRED</code>
to some other name and so avoid getting in the way of the existing
directory.  Furthermore, you can set up your directories on each host
to conform to the local naming conventions of that host.
</p>
<a name="fs_003aadd_002dlogical_002dpathname_002dhost_002dfun"></a><dl>
<dt><a name="index-fs_003aadd_002dlogical_002dpathname_002dhost"></a>Function: <strong>fs:add-logical-pathname-host</strong> <em>logical-host physical-host translations</em></dt>
<dd><p>This creates a new logical host named <em>logical-host</em>.  Its
corresponding &quot;physical&quot; host (that is, the host to which it will
forward most operations) is <em>physical-host</em>.  <em>logical-host</em> and
<em>physical-host</em> should both be strings.  <em>translations</em> should be a
list of translation specifications.  Each translation specification
should be a list of two strings.  The first is the name of a directory
on the logical host.  The second is a pathname whose device component
and directory component are the translation of that directory.
A translation for logical directory <code>nil</code> specifies the default device
for the logical host; if there is none, the primary device of the
physical host is used.
Example:
</p><div class="lisp">
<pre class="lisp">(fs:add-logical-pathname-host &quot;MUSIC&quot; &quot;MUSIC-10-A&quot;
      '((&quot;MELODY&quot; &quot;SS:&lt;MELODY&gt;&quot;)
        (&quot;DOC&quot; &quot;PS:&lt;MUSIC-DOCUMENTATION&gt;&quot;)))
</pre></div>

<p>This creates a new logical host called <code>MUSIC</code>.  If you try to read the
file <code>MUSIC:DOC;MANUAL  TEXT  2</code>, you will be re-directed to the file
<code>MUSIC-10-A:PS:&lt;MUSIC-DOCUMENTATION&gt;MANUAL.TEXT.2</code> (assuming that the
host <code>MUSIC-10-A</code> is a TOPS-20 system).
</p></dd></dl>

<dl>
<dt><a name="index-_003atranslated_002dpathname-on-fs_003alogical_002dpathname"></a>Method on fs:logical-pathname: <strong>:translated-pathname</strong></dt>
<dd><p>This converts a logical pathname to a physical pathname.  It returns the
translated pathname of this instance, a pathname whose <code>:host</code>
component is the physical host that corresponds to this instance&rsquo;s
logical host.
</p>
<p>If this operation is applied to a physical pathname, it simply returns itself.
</p></dd></dl>

<dl>
<dt><a name="index-_003aback_002dtranslated_002dpathname-on-fs_003alogical_002dpathname"></a>Method on fs:logical-pathname: <strong>:back-translated-pathname</strong> <em>pathname</em></dt>
<dd><p>This converts a physical pathname to a logical pathname.
<em>pathname</em> should be a pathname whose host is the physical host
corresponding to this instance&rsquo;s logical host.  This returns
a pathname whose host is the logical host and whose translation
is <em>pathname</em>.
</p>
<p>Here is an example of how this would be used in connection with truenames.
Given a stream that was obtained by opening a logical pathname,
</p><div class="lisp">
<pre class="lisp">(funcall stream ':pathname)
</pre></div>
<p>returns the logical pathname that was opened.
</p><div class="lisp">
<pre class="lisp">(funcall stream ':truename)
</pre></div>
<p>returns the true name of the file that is open, which of course is
a pathname on the physical host.  To get this in the form of a logical
pathname, one would do
</p><div class="lisp">
<pre class="lisp">(funcall (funcall stream ':pathname)
	 ':back-translated-pathname
	 (funcall stream ':truename))
</pre></div>

<p>If this operation is applied to a physical pathname, it simply returns its
argument.  Thus the above example will work no matter what kind of
pathname was opened to create the stream.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003apathname_002derror-error_0029-on-fs_003aunknown_002dlogical_002ddirectory"></a>Condition on fs:unknown-logical-directory: <strong>(<code>fs:pathname-error</code> <code>error</code>)</strong></dt>
<dd><p>This is signaled when a logical pathname&rsquo;s directory has no translation.
The condition instance supports the <code>:logical-directory</code> operation,
which returns the directory that was specified.
</p>
<p>Two proceed types are supported, <code>:new-directory</code> and <code>:new-translation</code>.
Each expects a single argument, a pathname or a string to be parsed into one.
In either case the device and directory of the pathname are used for translation.
<code>:new-directory</code> specifies the translation for this time only.
<code>:new-translation</code> records a translation permanently for the logical directory that was used.
</p></dd></dl>

<p>A logical pathname looks like <code>&quot;<em>host</em>: <em>directory</em>; <em>name</em> <em>type</em> <em>version</em>&quot;</code>.
There is no way to specify a device; parsing a logical pathname
always returns a pathname whose device component is <code>:unspecific</code>.
This is because devices don&rsquo;t have any meaning in logical pathnames.
</p>
<p>The equivalence-sign character (<code></code>) can be used for quoting special
characters such as spaces and semicolons.  The double-arrow character
(<code></code>) can be used as a place-holder for components that are <code>nil</code>,
and the up-horseshoe (<code>circlePlus</code>) indicates <code>:unspecific</code> (generic pathnames
typically have <code>:unspecific</code> as the type and the version).
All letters are mapped to upper case unless quoted.  The <code>:newest</code>, <code>:oldest</code>,
and <code>:wild</code> values for versions are specified with the strings
<code>&quot;&gt;&quot;</code>, <code>&quot;&lt;&quot;</code>, and <code>&quot;*&quot;</code> respectively.
</p>
<p>There isn&rsquo;t any init file naming convention for logical hosts; you
can&rsquo;t log into them.  The <code>:string-for-host</code>,
<code>:string-for-wholine</code>, <code>:string-for-dired</code>, and <code>:string-for-editor</code> messages are all
passed on to the translated pathname, but the <code>:string-for-printing</code>
is handled by the <code>fs:logical-pathname</code> flavor itself and shows
the logical name.
</p>
<a name="Editor-Buffer-Pathnames"></a>
<h4 class="subsection">22.7.6 Editor Buffer Pathnames</h4>
<a name="editor_002dhosts"></a><a name="zwei_002dhosts"></a>
<p>The hosts <code>ED</code>, <code>ED-BUFFER</code> and <code>ED-FILE</code> are used in pathnames
which refer to buffers in the editor.  If you open such a pathname, you
get a stream that reads or writes the contents of an editor buffer.  The
three host names differ only in the syntax of the pathname, and in how
it is interpreted.
</p>
<p>The host <code>ED</code> is followed by an abbreviation that should complete to
the name of an existing editor buffer.  For example, the pathname
<code>ED:FOO</code> could refer to the buffer <code>FOO.LISP PS:&lt;ME&gt; OZ:</code>.
</p>
<p>The host <code>ED-BUFFER</code> is followed by an exact buffer name.  If there is
no buffer with that name, one is created.  This is most useful for
creating a buffer.
</p>
<p>The host <code>ED-FILE</code> is followed by an arbitrary pathname, including a
host name.  An <code>ED-FILE</code> pathname refers to a buffer visiting that
file.  If necessary, the file is read into the editor.  For example,
<code>ED-FILE: OZ: PS:&lt;ME&gt;FOO.LISP</code> would refer to the same buffer as
<code>ED: FOO</code>.  The current default defaults are used in processing the
pathname that follows <code>ED-FILE</code>, when the pathname is parsed.
</p>
<a name="Hosts"></a>
<h3 class="section">22.8 Hosts</h3>
<a name="index-host-objects"></a>

<p>Each host known to the Lisp Machine is represented by a flavor instance
known as a host object.  The host object records such things as the name(s)
of the host, its operating system type, and its network address(es).
</p>
<p>Not all hosts support file access.  Those that do support it appear on the list
<code>fs:*pathname-host-list*</code> and can be the host component of pathnames.
A host object is also used as an argument when you make a chaosnet
connection for any purpose.
</p>
<p>The hosts that you can use for making network connections appear in the
value of <code>si:host-alist</code>.  Most of the hosts you can use for pathnames
are among these; but some, such as logical hosts, are not.
</p>
<a name="Parsing-Hostnames"></a>
<h4 class="subsection">22.8.1 Parsing Hostnames</h4>

<a name="si_003aparse_002dhost_002dfun"></a><dl>
<dt><a name="index-si_003aparse_002dhost"></a>Function: <strong>si:parse-host</strong> <em>namestring &amp;optional no-error-p unknown-ok</em></dt>
<dd><p>Returns a host object that recognizes the specified name.
If the name is not recognized, it is an error, unless <em>no-error-p</em> is
non-<code>nil</code>; in that case, <code>nil</code> is returned.
</p>
<p>If <em>unknown-ok</em> is non-<code>nil</code>, an unrecognized string is used to
construct a new host object.  However, that host object will not have a
known operating system type or network addresses.
</p>
<p>If a string of the form <code>CHAOS|</code><em>nnn</em> is used, a host object is
created and given <em>nnn</em> as its chaosnet address.  This can be done
regardless of the <em>unknown-ok</em> argument.
</p>
<p>The first argument is allowed to be a host object instead of a string.
In this case, that argument is simply returned.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003alocal_002dnetwork_002derror-sys_003anetwork_002derror-error_0029-on-sys_003aunknown_002dhost_002dname"></a>Condition on sys:unknown-host-name: <strong>(<code>sys:local-network-error</code> <code>sys:network-error</code> <code>error</code>)</strong></dt>
<dd><p>This condition is signaled by <code>si:parse-host</code> when the
host is not recognized, if that is an error.
</p>
<p>The <code>:name</code> operation on the condition instance returns the string
given to <code>si:parse-host</code>.
</p></dd></dl>

<a name="si_003aget_002dhost_002dfrom_002daddress_002dfun"></a><dl>
<dt><a name="index-si_003aget_002dhost_002dfrom_002daddress"></a>Function: <strong>si:get-host-from-address</strong> <em>address network</em></dt>
<dd><p>Returns a host object given an address and the name of the network which
that address is for.  Usually the symbol <code>:chaos</code> is used as the
network name.
</p>
<p><code>nil</code> is returned if there is no known host with that address.
</p></dd></dl>

<a name="fs_003aget_002dpathname_002dhost_002dfun"></a><dl>
<dt><a name="index-fs_003aget_002dpathname_002dhost"></a>Function: <strong>fs:get-pathname-host</strong> <em>name &amp;optional no-error-p</em></dt>
<dd><p>Returns a host object that can be used in pathnames.
If the name is not recognized, it is an error, unless <em>no-error-p</em> is
non-<code>nil</code>; in that case, <code>nil</code> is returned.
</p>
<p>The first argument is allowed to be a host object instead of a string.
In this case, that argument is simply returned.
</p></dd></dl>

<dl>
<dt><a name="index-_0028fs_003apathname_002derror-error_0029-on-fs_003aunknown_002dpathname_002dhost"></a>Condition on fs:unknown-pathname-host: <strong>(<code>fs:pathname-error</code> <code>error</code>)</strong></dt>
<dd><p>This condition is signaled by <code>fs:get-pathname-host</code> when the
host is not recognized, if that is an error.
</p>
<p>The <code>:name</code> operation on the condition instance returns the string
given to <code>fs:get-pathname-host</code>.
</p></dd></dl>

<p><code>si:parse-host</code> and <code>fs:get-pathname-host</code> differ in the set of
hosts searched.
</p>
<a name="fs_003a_002apathname_002dhost_002dlist_002a_002dvar"></a><dl>
<dt><a name="index-fs_003a_002apathname_002dhost_002dlist_002a"></a>Variable: <strong>fs:*pathname-host-list*</strong></dt>
<dd><p>This is a list of all the host objects that support file access.
</p></dd></dl>

<a name="si_003ahost_002dalist_002dvar"></a><dl>
<dt><a name="index-si_003ahost_002dalist"></a>Variable: <strong>si:host-alist</strong></dt>
<dd><p>This variable is a list of one element for each known network host.
The element looks like this:
</p><div class="lisp">
<pre class="lisp">(<em>full-name</em> <em>host-object</em> (<em>nickname</em> <em>nickname2</em> ... <em>full-name</em>)
 <em>system-type</em> <em>machine-type</em> <em>site</em>
 <em>network</em> <em>list-of-addresses</em> <em>network2</em> <em>list-of-addresses2</em> ...)
</pre></div>
<p>The <em>full-name</em> is the host&rsquo;s official name.  The <code>:name</code> operation on
the host object returns this.
</p>
<p>The <em>host-object</em> is a flavor instance that represents this host.
It may be <code>nil</code> if none has been created yet; <code>si:parse-host</code>
creates them when they are referred to.
</p>
<p>The <em>nickname</em>s are alternate names that <code>si:parse-host</code> will
recognize for this host, but which are not its official name.
</p>
<p>The <em>system-type</em> is a symbol that tells what software the
host runs.  This is used to decide what flavor of host object to
construct.  Symbols now used include <code>:lispm</code>, <code>:its</code>, <code>:tops-20</code>,
<code>:tenex</code>, <code>:vms</code>, <code>:unix</code>, <code>:multics</code>, <code>:minits</code>, <code>:waits</code>,
<code>:chaos-gateway</code>, <code>:dos</code>, <code>:rsx</code>, <code>:magicsix</code>, and others.  Not
all of these are specifically understood in any way by the Lisp machine.
If none of these applies to a host you wish to add, use a new symbol.
</p>
<p>The <em>machine-type</em> is a symbol that describes the hardware of the
host.  Symbols in use include <code>:lispm</code>, <code>:pdp10</code>, <code>:pdp11</code>,
<code>:vax</code>, <code>:pe3230</code>.  <code>(nil)</code> has also been observed to appear here.
Note that these machine types attempt to have wide meanings, lumping
together as various brands, models, etc.
</p>
<p>The <em>site</em> does not describe anything about the host.  Instead it
serves to say what the Lisp Machine&rsquo;s site name was when the host was
defined.  This is so that, when a Lisp Machine system is moved to a
different institution that has a disjoint set of hosts, all the old
site&rsquo;s hosts can be deleted from the host alist by site
reinitialization.
</p>
<p>The <em>network</em>s and lists of addresses describe how to reach the host.
Usually there will be only one network and only one address in the list.
The generality is so that hosts with multiple addresses on multiple
networks can be recorded.  Networks include <code>:chaos</code> and <code>:arpa</code>.
The address is meaningful only to code for a specific network.
</p></dd></dl>

<a name="Host-Object-Operations"></a>
<h4 class="subsection">22.8.2 Host Object Operations</h4>

<dl>
<dt><a name="index-objects_0022-on-_0022host"></a>Meta Method on &quot;host: <strong>objects&quot;</strong> <em>:name</em></dt>
<dd><p>Returns the full, official name of the host.
</p></dd></dl>

<dl>
<dt><a name="index-objects_0022-on-_0022host-1"></a>Meta Method on &quot;host: <strong>objects&quot;</strong> <em>:name-as-file-computer</em></dt>
<dd><p>Returns the name to print in pathnames on this host (assuming it
supports files).  This is likely to be a short nickname of the host.
</p></dd></dl>

<dl>
<dt><a name="index-objects_0022-on-_0022host-2"></a>Meta Method on &quot;host: <strong>objects&quot;</strong> <em>:short-name</em></dt>
<dd><p>Returns the shortest known nickname for this host.
</p></dd></dl>

<dl>
<dt><a name="index-objects_0022-on-_0022host-3"></a>Meta Method on &quot;host: <strong>objects&quot;</strong> <em>:pathname-host-namep string</em></dt>
<dd><p>Returns <code>t</code> if <em>string</em> is recognized as a name for this host for
purposes of pathname parsing.
</p></dd></dl>

<dl>
<dt><a name="index-objects_0022-on-_0022host-4"></a>Meta Method on &quot;host: <strong>objects&quot;</strong> <em>:system-type</em></dt>
<dd><p>Returns the operating system type symbol for this host.
See <a href="#host_002dtable">host-table</a>.
</p></dd></dl>

<dl>
<dt><a name="index-objects_0022-on-_0022host-5"></a>Meta Method on &quot;host: <strong>objects&quot;</strong> <em>:network-type</em></dt>
<dd><p>Returns the symbol for one network that this host is connected to,
or <code>nil</code> if it is not connected to any.  <code>:chaos</code> is preferred if it
is one of the possible values.
</p></dd></dl>

<dl>
<dt><a name="index-objects_0022-on-_0022host-6"></a>Meta Method on &quot;host: <strong>objects&quot;</strong> <em>:network-typep network</em></dt>
<dd><p>Returns <code>t</code> if the host is connected to the specified network.
</p></dd></dl>

<dl>
<dt><a name="index-objects_0022-on-_0022host-7"></a>Meta Method on &quot;host: <strong>objects&quot;</strong> <em>:sample-pathname</em></dt>
<dd><p>Returns a pathname for this host, whose device, directory, name, type
and version components are all <code>nil</code>.  Sample pathnames are often
useful because many file-system-dependent pathname operations depend
only on the pathname&rsquo;s host.
</p></dd></dl>

<dl>
<dt><a name="index-objects_0022-on-_0022host-8"></a>Meta Method on &quot;host: <strong>objects&quot;</strong> <em>:open-streams</em></dt>
<dd><p>Returns a list of all the open file streams for files on this host.
</p></dd></dl>

<dl>
<dt><a name="index-objects_0022-on-_0022host-9"></a>Meta Method on &quot;host: <strong>objects&quot;</strong> <em>:close-all-files</em></dt>
<dd><p>Closes all file streams open for files on this host.
</p></dd></dl>

<dl>
<dt><a name="index-objects_0022-on-_0022host-10"></a>Meta Method on &quot;host: <strong>objects&quot;</strong> <em>:generic-base-type type-component</em></dt>
<dd><p>Returns the type component for a generic pathname assuming it is being
made from a pathname whose type component is the one specified.
</p></dd></dl>

<a name="Maclisp-Conversion"></a>
<h3 class="section">22.9 Maclisp Conversion</h3>

<a name="index-namelists-_0028Maclisp-compatibility_0029"></a>
<a name="index-Maclisp-file-manipulation"></a>

<p>This section briefly discusses how to convert from Maclisp I/O and filename
functions to the corresponding but often more general Lisp Machine ones.
</p>
<p>The functions <code>load</code>, <code>open</code>, <code>probef</code>, <code>renamef</code>, and <code>deletef</code>
are upward compatible.  Most of them take optional additional arguments to
do additional things, usually connected with error handling.
Where Maclisp wants to see a file name in the form of a symbol or a list,
the Lisp Machine will accept those or a string or a pathname object.
<code>probef</code> returns a pathname or <code>nil</code> rather than a namelist or <code>nil</code>.
</p>
<p><code>load</code> keeps defaults, which it updates from the file name it is given.
</p>
<p>The old-I/O functions <code>uread</code>, <code>crunit</code>, etc do not exist in the Lisp Machine.
<code>fasload</code> exists but is a function rather than a special form.
</p>
<p>There is a special form, <code>with-open-file</code>, which should replace most calls
to <code>open</code>.  See <a href="#with_002dopen_002dfile_002dfun">with-open-file-fun</a>.
</p>
<p>The functions for manipulating file names themselves are different.  The system
will accept a namelist as a pathname, but will never create a namelist.
<code>mergef</code> is replaced by <code>fs:merge-pathname-defaults</code>.
<code>defaultf</code> is replaced by <code>fs:default-pathname</code> or <code>fs:set-default-pathname</code>,
depending on whether it is given an argument.
<code>namestring</code> is replaced by the <code>:string-for-printing</code> message to a pathname,
or the <code>string</code> function.
<code>namelist</code> is approximately replaced by <code>fs:parse-pathname</code>.
<code>(status udir)</code> and <code>(status homedir)</code> are approximately replaced by <code>fs:user-homedir</code>.
The <code>truename</code> function is replaced by the <code>:truename</code> stream operation,
which returns a pathname containing the actual name of the file open on that
stream.
The <code>directory</code> and <code>allfiles</code> functions are replaced by <code>fs:directory-list</code>.
</p>
<a name="The-Chaosnet"></a>
<h2 class="chapter">23 The Chaosnet</h2>
<a name="chaos_002dchapter"></a><a name="chaosnet"></a>
<p>The purpose of the basic software protocol of Chaosnet is to allow
high-speed communication among processes on different machines, with no
undetected transmission errors.
</p>
<a name="Chaosnet-Overview"></a>
<h3 class="section">23.1 Chaosnet Overview</h3>

<p>The principal service provided by Chaosnet is a <em>connection</em> between
two user processes.  This is a full-duplex reliable packet-transmission
channel.  The network undertakes never to garble, lose, duplicate, or
resequence the packets; in the event of a serious error it may break the
connection off entirely, informing both user processes.  User programs
may deal explicitly in terms of packets.  They may also ignore packet
boundaries and treat the connection as two uni-directional streams of
8-bit or 16-bit bytes, but this really works by means of packets.
</p>
<p>If you just want to ask a question of another process or host and
receive a reply, you can use a <em>simple transaction</em>: You send only
one packet to the other host, and it sends one packet back.  This is
more efficient than establishing a connection and using it only briefly.
In a simple transaction, the server cannot tell whether the user
received the answer; and if the user does not receive the answer, it
cannot tell whether the server received the question.  In fact, the
server might receive the question more than once.  If this is
unacceptable, a connection must be used.
</p>
<p>Each node (or host) on the network is identified by an <em>address</em>,
which is a 16-bit number.  These addresses are used in the routing of
packets.  There is a table (the system hosts table, <code>SYS: CHAOS; HOSTS
TXT</code>) that relates symbolic host names to numeric host addresses.  The
host table can record addresses on any number of different networks, and
in certain contexts a host address is meaningful only together with the
name of the network it is for.
</p>
<p>The data transmitted over connections are in units called <em>packets</em>.
Each packet contains an 8-bit number, the <em>opcode</em>, which indicates
what its function is.  Opcodes less than 200 (octal) are special
purpose.  Each such opcode that is used has an assigned name and a
specific function.  Users need not know about all of them.  Opcodes 200
through 277 are used for 8-bit user data.  Opcodes 300 through 377 are
used for 16-bit user data.
</p>
<p>Each packet also contains some number of data bytes, whose meaning
depends on the opcode.  If the opcode is for user data, then it is up to
the application user software to decide on the interpretation.
</p>
<p>Establishing a connection:
</p>
<p>A connection is created because one process sends a request to a host.
The request is a packet containing the special-purpose opcode RFC.  The
data contains a <em>contact name</em> which is used to find the process to
connect to.  There may be a process on the target host <em>listening</em> on
this contact name.  If so, it decides whether to agree to the
connection.  Alternatively, the contact name can be the name of a standard service
such as <code>TELNET</code>.  In this case, the receiving host will create a
process to respond, loaded with the program for that service.
</p>
<p>Once a connection has been established, there is no more need for the
contact name and it is discarded.  The Lisp machine remembers what
contact name was used to open a connection, but this is only for the
user&rsquo;s information.
</p>
<p>In the case where two existing processes that already know about each
other want to establish a connection, they must agree on a contact name,
and then one of them must send the request while the other listens.
They must agree between themselves which is to do which.
</p>
<p>Contact names are restricted to strings of upper-case letters, numbers,
and ASCII punctuation.  The maximum length of a contact name is limited
only by the packet size, although on ITS hosts the names of
automatically-started servers are limited by the file-system to six characters.
The contact name is terminated by a space.  If the RFC packet contains
data beyond the contact name, it is just for interpretation by the
listening process, which can also use it in deciding whether to accept
the connection.
</p>
<p>A simple transaction is also begun with an RFC packet.  There is
nothing in the RFC packet which indicates whether it is intended to
start a connection or a simple transaction.  The server has the option
of doing either one.  But normally any given server always does one or
the other, and the requestor knows which one to expect.
</p>
<p>The server accepts the request for a connection by sending an OPN packet
(a packet with opcode OPN) to the requestor.  It can also refuse the
connection by sending a CLS packet.  The data in the CLS packet is a
string explaining the reason for the refusal.  Another alternative is to
tell the requestor to try a different host or a different contact name.
This is called <em>forwarding</em> the request, and is done with a FWD
packet.
</p>
<p>The server can also respond with an answer, an ANS packet, which is the
second half of a simple transaction.  (Refusing and forwarding are also
meaningful when a simple transaction is intended, just as when a
connection is intended).
</p>
<p>Once the connection is open:
</p>
<p>Data transmitted through Chaosnet generally follow Lisp Machine
standards.  Bits and bytes are numbered from right to
left, or least-significant to most-significant.  The first 8-bit byte
in a 16-bit word is the one in the arithmetically least-significant
position.  The first 16-bit word in a 32-bit double-word is the one
in the arithmetically least-significant position.
</p>
<p>The character set used is dictated by the higher-level protocol in use.
Telnet and Supdup, for example, each specifies its own ASCII-based character set.
The &quot;default&quot; character set&ndash;used for new protocols and for text that
appears in the basic Chaosnet protocol, such as contact names&ndash;is
the Lisp Machine character set.
</p>
<p>Because PDP-10s need to reorder the characters in a word in order to
access them conveniently, it is necessary to distinguish 8-bit data from
16-bit data.  They are distinguished by the packet opcode: some opcodes
imply 8-bit bytes and some imply 16-bit bytes.  Packets known to contain
8-bit bytes, including opcodes 200 through 277, will be byte-swapped by
the PDP-10&rsquo;s front end.
</p>
<p>If one process tries to send data faster than the other can process it,
the buffered packets could devour lots of memory.  Preventing this is
the purpose of <em>flow control</em>.  Each process specifies a <em>window
size</em>, which is the number of packets that are allowed to be waiting for
that process to read.  Attempting to send on a connection whose other
side&rsquo;s window is full will block until the other side reads some
packets.  The default window size is 13, but for some applications you
might wish to specify a larger value.  There is little reason ever to
specify a smaller value.
</p>
<p>Breaking a connection:
</p>
<p>Either end of a connection can break the connection abruptly by sending
a CLS packet.  The data in this packet is a string describing why the
connection was broken.
</p>
<p>To break a connection gently, it is necessary to verify that all the
data transmitted was received properly before sending a CLS.  This
matters in some applications and is unnecessary in others.  When it is
needed, it is done by sending a special packet, an EOF packet, which is
mostly like a data packet except for its significance with regard to
closing the connection.  The EOF packet is like the words &quot;the end&quot; at
the end of a book: it tells the recipient that it has received all the
data it is supposed to receive, that there are no missing pages that
should have followed.  When the sender of the EOF sees the
acknowledgement for the EOF packet, indicating that the EOF was received
and understood, it can break the connection with a CLS.
</p>
<p>If a process that expects to receive an EOF gets a CLS with no EOF, it
takes this to mean that the connection was broken before the
transmission was finished.  If the process does receive an EOF, it does
not break the connection itself immediately.  It waits to see the sender
of the EOF break it.  If this does not happen in a few seconds, the EOF
recipient can break the connection.
</p>
<p>It is illegal to put data in an EOF packet; in other words, the byte
count should always be zero.  Most Chaosnet implementations will simply
ignore any data that is present in an EOF.
</p>
<a name="safe_002deof_002dprotocol"></a>
<p>If both sides are sending data and both need to know for certain where
&quot;the end&quot; is, they must do something a little more complicated.
Arbitrarily call one party the user and the other the server.  The
protocol is that after sending all its data, each party sends an EOF and
waits for it to be acknowledged.  The server, having seen its EOF
acknowledged, sends a second EOF.  The user, having seen its EOF
acknowledged, looks for a second EOF and <em>then</em> sends a CLS and goes
away.  The server goes away when it sees the user&rsquo;s CLS, or after a
brief timeout has elapsed.  This asymmetrical protocol guarantees that
each side gets a chance to know that both sides agree that all the data
have been transferred.  The first CLS will only be sent after both sides
have waited for their (first) EOF to be acknowledged.
</p>
<p>Clearing up inconsistencies:
</p>
<p>If a host crashes, it is supposed to forget all the connections that it
had.  When a packet arrives on one of the former connections, the host
will report &quot;no such connection&quot; to the sender with a LOS packet, whose
data is a string explaining what happened.  The same thing happens if a
CLS packet is lost; the intended recipient may keep trying to use the
connection that the other side (which sent the CLS) no longer believes
should exist.  LOS packets are used
whenever a host receives a packet that it should not be getting; the
recipient of the LOS packet knows that the connection it thought it was
using does not exist any more.
</p>
<a name="Conns"></a>
<h3 class="section">23.2 Conns</h3>

<p>On the Lisp machine, your handle on a connection is a named
structure of type <code>chaos:conn</code>.  The <code>conn</code> may have an actual
connection attached to it, or it may have a connection still being made,
or record that a connection was refused, closed or broken.
</p>
<dl compact="compact">
<dt><code>chaos:inactive-state &quot;connection state&quot;</code></dt>
<dd><p>This <code>conn</code> is not really in use at all.
</p>
</dd>
<dt><code>chaos:rfc-sent-state &quot;connection state&quot;</code></dt>
<dd><p>This <code>conn</code> was used to request a connection to another process,
but no reply has been received.  When the reply is received, it may
change the <code>conn</code>&rsquo;s state to <code>chaos:answered-state</code>,
<code>chaos:cls-received-state</code>, or <code>chaos:open-state</code>.
</p>
</dd>
<dt><code>chaos:listening-state &quot;connection state&quot;</code></dt>
<dd><p>This <code>conn</code> is being used to listen with.
If a RFC packet is received for the contact name you are listening
on, the state will change to <code>chaos:rfc-received-state</code>.
</p>
</dd>
<dt><code>chaos:rfc-received-state &quot;connection state&quot;</code></dt>
<dd><p>This means that your listen has &quot;heard&quot; an RFC packet that matches
it.  You can accept, reject, forward or answer the request.  Accepting
goes to state <code>chaos:open-state</code>; refusing or forwarding goes to to state
<code>chaos:inactive-state</code>.
</p>
</dd>
<dt><code>chaos:open-state &quot;connection state&quot;</code></dt>
<dd><p>This <code>conn</code> is one end of an open connection.
You can receive any data packets that are waiting and you can transmit
data.
</p>
</dd>
<dt><code>chaos:answered-state &quot;connection state&quot;</code></dt>
<dd><p>This <code>conn</code> was used to send an RFC packet and an ANS packet
was received in response (a simple transaction answer arrived).	 You can
read the ANS packet, that is all.
</p>
</dd>
<dt><code>chaos:cls-received-state &quot;connection state&quot;</code></dt>
<dd><p>This <code>conn</code> has received a CLS packet (the connection was closed
or refused).  You can read any data packets that came in before the
CLS; after them you can read the CLS.
</p>
</dd>
<dt><code>chaos:los-received-state &quot;connection state&quot;</code></dt>
<dd><p>This <code>conn</code>&rsquo;s connection was broken and the other end sent a LOS
packet to say so.  The LOS packet is the only packet available to be
read.
</p>
</dd>
<dt><code>chaos:host-down-state &quot;connection state&quot;</code></dt>
<dd><p>The host at the other end of this <code>conn</code>&rsquo;s connection has not
responded to anything for a significant time.
</p>
</dd>
<dt><code>chaos:foreign-state &quot;connection state&quot;</code></dt>
<dd><p>The connection is being used with a foreign protocol encapsulated in UNC
packets (see the Chaosnet memo for more information about this).
</p></dd>
</dl>

<p>These are
the fields of a <code>conn</code> that you might be interested in:
</p>
<a name="chaos_003aconn_002dstate_002dfun"></a><dl>
<dt><a name="index-chaos_003aconn_002dstate"></a>Function: <strong>chaos:conn-state</strong> <em>conn</em></dt>
<dd><p>This slot holds the state of <em>conn</em>.  It is one of the symbols listed above.
</p></dd></dl>

<a name="chaos_003aconn_002dforeign_002daddress_002dfun"></a><dl>
<dt><a name="index-chaos_003aconn_002dforeign_002daddress"></a>Function: <strong>chaos:conn-foreign-address</strong> <em>conn</em></dt>
<dd><p>Returns the address of the host at the other end of this connection.
Use <code>si:get-host-from-address</code> to find out which host this is
(see <a href="#si_003aget_002dhost_002dfrom_002daddress_002dfun">si:get-host-from-address-fun</a>).
</p></dd></dl>

<a name="chaos_003aconn_002dread_002dpkts_002dfun"></a><dl>
<dt><a name="index-chaos_003aconn_002dread_002dpkts"></a>Function: <strong>chaos:conn-read-pkts</strong> <em>conn</em></dt>
<dd><p>Internally threaded chain of incoming packets available to be read from
<em>conn</em>.
</p>
<p>Its main use for the applications programmer is to test whether there
are any incoming packets.
</p></dd></dl>

<a name="chaos_003aconn_002dwindow_002davailable_002dfun"></a><dl>
<dt><a name="index-chaos_003aconn_002dwindow_002davailable"></a>Function: <strong>chaos:conn-window-available</strong> <em>conn</em></dt>
<dd><p>Returns the number of packets you may transmit before the network
software forces you to wait for the receiver to read some.
This is just a minimum.  By the time you actually send this many
packets, the receiver may already have said he has room for some more.
</p></dd></dl>

<a name="chaos_003aconn_002dplist_002dfun"></a><dl>
<dt><a name="index-chaos_003aconn_002dplist"></a>Function: <strong>chaos:conn-plist</strong> <em>conn</em></dt>
<dd><p>This slot is used to store arbitrary properties on <em>conn</em>.
You can store properties yourself; use property names that are not in
the chaos package to avoid conflict.
</p></dd></dl>

<a name="chaos_003acontact_002dname_002dfun"></a><dl>
<dt><a name="index-chaos_003acontact_002dname"></a>Function: <strong>chaos:contact-name</strong> <em>conn</em></dt>
<dd><p>Returns the contact name with which <em>conn</em> was created.  The contact
name is not significant to the functioning of the connection once an RFC
and LSN have matched, but it is remembered for the sake of debugging.
</p></dd></dl>

<a name="chaos_003await_002dfun"></a><dl>
<dt><a name="index-chaos_003await"></a>Function: <strong>chaos:wait</strong> <em>conn state timeout &amp;optional whostate</em></dt>
<dd><p>Waits until the state of <em>conn</em> is not the symbol <em>state</em>, or until
<em>timeout</em> 60ths of a second have elapsed.  If the timeout occurs, <code>nil</code> is
returned; otherwise <code>t</code> is returned.  <em>whostate</em> is the process state to
put in the who-line; it defaults to <code>&quot;Chaosnet wait&quot;</code>.
</p></dd></dl>

<a name="Opening-and-Closing-Connections"></a>
<h3 class="section">23.3 Opening and Closing Connections</h3>

<a name="User_002dSide"></a>
<h4 class="subsection">23.3.1 User-Side</h4>

<a name="chaos_003aconnect_002dfun"></a><dl>
<dt><a name="index-chaos_003aconnect"></a>Function: <strong>chaos:connect</strong> <em>host contact-name &amp;optional window-size timeout</em></dt>
<dd><p>Opens a stream connection; returns a <code>conn</code> if it succeeds or else a
string giving the reason for failure.  <em>host</em> may be a number or the name
of a known host.  <em>contact-name</em> is a string containing the contact name
and any additional arguments to go in the RFC packet.  If <em>window-size</em>
is not specified it defaults to 13.  If <em>timeout</em> is not specified it
defaults to 600 (ten seconds).
</p></dd></dl>

<a name="chaos_003asimple_002dfun"></a><dl>
<dt><a name="index-chaos_003asimple"></a>Function: <strong>chaos:simple</strong> <em>host contact-name &amp;optional timeout</em></dt>
<dd><p>Taking arguments similar to those of <code>chaos:connect</code>, this performs the user
side of a simple-transaction.  The returned value is either an ANS packet
or a string containing a failure message.  The ANS packet should be disposed
of (using <code>chaos:return-pkt</code>, see below) when you are done with it.
</p></dd></dl>

<a name="chaos_003aremove_002dconn_002dfun"></a><dl>
<dt><a name="index-chaos_003aremove_002dconn"></a>Function: <strong>chaos:remove-conn</strong> <em>conn</em></dt>
<dd><p>Makes <em>conn</em> null and void.  It becomes inactive, all its buffered packets
are freed, and the corresponding Chaosnet connection (if any) goes away.
</p></dd></dl>

<a name="chaos_003aclose_002dfun"></a><dl>
<dt><a name="index-chaos_003aclose"></a>Function: <strong>chaos:close</strong> <em>conn &amp;optional reason</em></dt>
<dd><p>Closes and removes the connection.  If it is open, a CLS packet is sent
containing the string <em>reason</em>.  Don&rsquo;t use this to reject RFC&rsquo;s; use
<code>chaos:reject</code> for that.
</p></dd></dl>

<a name="chaos_003aopen_002dforeign_002dconnection_002dfun"></a><dl>
<dt><a name="index-chaos_003aopen_002dforeign_002dconnection"></a>Function: <strong>chaos:open-foreign-connection</strong> <em>host index &amp;optional pkt-allocation distinguished-port</em></dt>
<dd><p>Creates a <code>conn</code> that may be used to transmit and receive foreign
protocols encapsulated in UNC packets.  <em>host</em> and <em>index</em> are the
destination address for packets sent with <code>chaos:send-unc-pkt</code>.
<em>pkt-allocation</em> is the &quot;window size&quot;, i.e the maximum number of input
packets that may be buffered.  It defaults to 10.
If <em>distinguished-port</em> is supplied, the local index is set to it.
This is necessary for protocols that define the meanings of particular index
numbers.
</p>
<p>See the AI memo on the chaosnet for more information on using foreign protocols.
</p></dd></dl>

<a name="Server_002dSide"></a>
<h4 class="subsection">23.3.2 Server-Side</h4>

<a name="chaos_003alisten_002dfun"></a><dl>
<dt><a name="index-chaos_003alisten"></a>Function: <strong>chaos:listen</strong> <em>contact-name &amp;optional window-size wait-for-rfc</em></dt>
<dd><p>Waits for an RFC for the specified contact name to arrive, then returns a
<code>conn</code> that will be in <code>chaos:rfc-received-state</code>.  If <em>window-size</em> is
not specified it defaults to 13.  If <em>wait-for-rfc</em> is specified as <code>nil</code>
(it defaults to <code>t</code>) then the <code>conn</code> will be returned immediately without
waiting for an RFC to arrive.
</p></dd></dl>

<a name="chaos_003aserver_002dalist_002dvar"></a><dl>
<dt><a name="index-chaos_003aserver_002dalist"></a>Variable: <strong>chaos:server-alist</strong></dt>
<dd><p>Contains an entry for each server that always exists.  When an RFC
arrives for one of these servers, the specified form is evaluated in the
background process; typically it creates a process that will then do a
<code>chaos:listen</code>.  Use the <code>add-initialization</code> function to add entries
to this list.
</p></dd></dl>

<a name="chaos_003aaccept_002dfun"></a><dl>
<dt><a name="index-chaos_003aaccept"></a>Function: <strong>chaos:accept</strong> <em>conn</em></dt>
<dd><p><em>conn</em> must be in <code>chaos:rfc-received-state</code>.  An OPN packet will be
transmitted and <em>conn</em> will enter the <em>Open</em> state.  If the RFC packet
has not already been read with <code>chaos:get-next-pkt</code>, it is discarded.  You
should read it before accepting, if it contains arguments in addition to the
contact name.
</p></dd></dl>

<a name="chaos_003areject_002dfun"></a><dl>
<dt><a name="index-chaos_003areject"></a>Function: <strong>chaos:reject</strong> <em>conn reason</em></dt>
<dd><p><em>conn</em> must be in <code>chaos:rfc-received-state</code>.  A CLS packet containing
the string <em>reason</em> will be sent and <em>conn</em> will be removed.
</p></dd></dl>

<a name="chaos_003aforward_002dall_002dfun"></a><dl>
<dt><a name="index-chaos_003aforward_002dall"></a>Function: <strong>chaos:forward-all</strong> <em>contact-name host</em></dt>
<dd><p>Cause all future requests for connection to this host on <em>contact-name</em> 
to be forwarded to the same contact name at host <em>host</em>.
</p></dd></dl>

<a name="chaos_003aanswer_002dstring_002dfun"></a><dl>
<dt><a name="index-chaos_003aanswer_002dstring"></a>Function: <strong>chaos:answer-string</strong> <em>conn string</em></dt>
<dd><p><em>conn</em> must be in <code>chaos:rfc-received-state</code>.  An ANS packet containing
the string <em>string</em> will be sent and <em>conn</em> will be removed.
</p></dd></dl>

<a name="chaos_003aanswer_002dfun"></a><dl>
<dt><a name="index-chaos_003aanswer"></a>Function: <strong>chaos:answer</strong> <em>conn pkt</em></dt>
<dd><p><em>conn</em> must be in <code>chaos:rfc-received-state</code>.  <em>pkt</em> is transmitted as
an ANS packet and <em>conn</em> is removed.  Use this function when the answer 
is some binary data rather than a text string.
</p></dd></dl>

<a name="chaos_003afast_002danswer_002dstring_002dfun"></a><dl>
<dt><a name="index-chaos_003afast_002danswer_002dstring"></a>Function: <strong>chaos:fast-answer-string</strong> <em>contact-name string</em></dt>
<dd><p>If a pending RFC exists to <em>contact-name</em>, an ANS containing <em>string</em>
is sent in response to it and <code>t</code> is returned.  Otherwise <code>nil</code> is returned.
This function involves the minimum possible overhead.  No <code>conn</code> is created.
</p></dd></dl>


<a name="Stream-Input-and-Output"></a>
<h3 class="section">23.4 Stream Input and Output</h3>

<a name="chaos_003aopen_002dstream_002dfun"></a><dl>
<dt><a name="index-chaos_003aopen_002dstream"></a>Function: <strong>chaos:open-stream</strong> <em>host contact-name &amp;rest options</em></dt>
<dd><p>Opens a chaosnet connection and returns a stream that does i/o to it.
<em>host</em> is the host to connect to; <em>contact-name</em> is the contact name at that host.
These two arguments are passed along to <code>chaos:connect</code>.
<em>options</em> is a list of alternating keywords and values.
</p><dl compact="compact">
<dt><code>:window-size</code></dt>
<dt><code>:timeout</code></dt>
<dd><p>These two arguments specify two arguments for <code>chaos:connect</code>.
</p></dd>
<dt><code>:error</code></dt>
<dd><p>If the value is non-<code>nil</code>, a failure to connect causes a Lisp error.
Otherwise, it causes a string describing the error to be returned.
</p></dd>
<dt><code>:direction</code></dt>
<dt><code>:characters</code></dt>
<dt><code>:ascii-translation</code></dt>
<dd><p>These three arguments are passed along to <code>chaos:make-stream</code>.
</p></dd>
</dl>
</dd></dl>

<a name="chaos_003amake_002dstream_002dfun"></a><dl>
<dt><a name="index-chaos_003amake_002dstream"></a>Function: <strong>chaos:make-stream</strong> <em>conn &amp;key &amp;optional direction characters ascii-translation</em></dt>
<dd><p>Creates and returns a stream that does i/o on the connection <em>conn</em>,
which should be open as a stream connection.  <em>direction</em> may be
<code>:input</code>, <code>:output</code> or <code>:bidirectional</code>.
</p>
<p>If <em>characters</em> is non-nil (which is the default), the stream reads
and writes 8-bit bytes.  If <em>characters</em> is <code>nil</code>, the stream reads
and writes 16-bit bytes.
</p>
<p>If <em>ascii-translation</em> is non-<code>nil</code>, characters written to the
stream are translated to standard ASCII before they are sent, and
characters read are translated from ASCII to the Lisp machine character
set.
</p></dd></dl>

<dl>
<dt><a name="index-_003aforeign_002dhost-on-chaos_003abasic_002dstream"></a>Method on chaos:basic-stream: <strong>:foreign-host</strong></dt>
<dd><p>Returns the host object for the host at the other end of this stream&rsquo;s connection.
</p></dd></dl>

<dl>
<dt><a name="index-_003aclose-on-chaos_003abasic_002dstream"></a>Method on chaos:basic-stream: <strong>:close</strong> <em>&amp;optional abort-p</em></dt>
<dd><p>Send a CLS packet and remove the connection.  For output connections and bidirectional
connections, the <code>:eof</code> operation is performed first, if
<em>abort-p</em> is <code>nil</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003aforce_002doutput-on-chaos_003abasic_002doutput_002dstream"></a>Method on chaos:basic-output-stream: <strong>:force-output</strong></dt>
<dd><p>Any buffered output is transmitted.  Normally output is accumulated until a
full packet&rsquo;s worth of bytes are available, so that maximum-size packets are
transmitted.
</p></dd></dl>

<dl>
<dt><a name="index-_003afinish-on-chaos_003abasic_002doutput_002dstream"></a>Method on chaos:basic-output-stream: <strong>:finish</strong></dt>
<dd><p>Waits until either all packets have been sent and acknowledged, or the connection ceases
to be open.  If successful, returns <code>t</code>; if the connection goes into a bad state,
returns <code>nil</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003aeof-on-chaos_003abasic_002doutput_002dstream"></a>Method on chaos:basic-output-stream: <strong>:eof</strong></dt>
<dd><p>Forces out any buffered output, sends an EOF packet, and does a <code>:finish</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003aclear_002deof-on-chaos_003abasic_002dinput_002dstream"></a>Method on chaos:basic-input-stream: <strong>:clear-eof</strong></dt>
<dd><p>Allows you to read past an EOF packet on input.  Each <code>:tyi</code> will return
<code>nil</code> or signal the specified eof error until a <code>:clear-eof</code> is done.
</p></dd></dl>

<a name="Packet-Input-and-Output"></a>
<h3 class="section">23.5 Packet Input and Output</h3>

<p>Input and output on a Chaosnet connection can be done at the whole-packet
level, using the functions in this section.  A packet is represented by
a <code>chaos:pkt</code> data structure.  Allocation of <code>pkts</code> is controlled by the system;
each <code>pkt</code> that it gives you must be given back.  There are functions to
convert between <code>pkts</code> and strings.  A <code>pkt</code> is an <code>art-16b</code> array
containing the packet header and data; the leader of a <code>pkt</code>
contains a number of fields used by the system.
</p>
<a name="chaos_003afirst_002ddata_002dword_002din_002dpkt_002dvar"></a><dl>
<dt><a name="index-chaos_003afirst_002ddata_002dword_002din_002dpkt"></a>Variable: <strong>chaos:first-data-word-in-pkt</strong></dt>
<dd><p>This is the index in any <code>pkt</code> of the element that is the first
16-bit word of user data.  (Preceding elements are used to store a
header used by the hardware.)
</p></dd></dl>

<a name="chaos_003apkt_002dopcode_002dfun"></a><dl>
<dt><a name="index-chaos_003apkt_002dopcode"></a>Function: <strong>chaos:pkt-opcode</strong> <em>pkt</em></dt>
<dd><p>Accessor for the opcode of the packet <em>pkt</em>.  To set the opcode, do
</p><div class="lisp">
<pre class="lisp">(setf (chaos:pkt-opcode my-pkt) my-opcode)
</pre></div>
<p>The system provides names for all the opcodes standardly used.  The names useful to the applications programmer appear at the end of this section.
</p></dd></dl>

<a name="chaos_003apkt_002dnbytes_002dfun"></a><dl>
<dt><a name="index-chaos_003apkt_002dnbytes"></a>Function: <strong>chaos:pkt-nbytes</strong> <em>pkt</em></dt>
<dd><p>Accessor for the number-of-data-bytes field of <em>pkt</em>&rsquo;s.
This field says how much of <em>pkt</em>&rsquo;s contects are valid data,
measured in 8-bit bytes.
This field can be set with <code>setf</code> also.
</p></dd></dl>

<a name="chaos_003apkt_002dstring_002dfun"></a><dl>
<dt><a name="index-chaos_003apkt_002dstring"></a>Function: <strong>chaos:pkt-string</strong> <em>pkt</em></dt>
<dd><p>An indirect array that is the data field of <em>pkt</em> as a string of 8-bit bytes.
The length of this string is equal to <code>(chaos:pkt-nbytes <em>pkt</em>)</code>.
If you wish to record the contects of <em>pkt</em> permanently, you must copy this string.
</p></dd></dl>

<a name="chaos_003aset_002dpkt_002dstring_002dfun"></a><dl>
<dt><a name="index-chaos_003aset_002dpkt_002dstring"></a>Function: <strong>chaos:set-pkt-string</strong> <em>pkt &amp;rest strings</em></dt>
<dd><p>Copies the <em>strings</em> into the data field of <em>pkt</em>, concatenating them,
and sets <code>(chaos:pkt-nbytes <em>pkt</em>)</code> accordingly.
</p></dd></dl>

<a name="chaos_003aget_002dpkt_002dfun"></a><dl>
<dt><a name="index-chaos_003aget_002dpkt"></a>Function: <strong>chaos:get-pkt</strong></dt>
<dd><p>Allocates a <code>pkt</code> for use by the user.
</p></dd></dl>

<a name="chaos_003areturn_002dpkt_002dfun"></a><dl>
<dt><a name="index-chaos_003areturn_002dpkt"></a>Function: <strong>chaos:return-pkt</strong> <em>pkt</em></dt>
<dd><p>Returns <em>pkt</em> to the system for reuse.  The packets given to you by <code>chaos:get-pkt</code>,
<code>chaos:get-next-pkt</code> and <code>chaos:simple</code> should be returned to the system in this way
when you are finished with them.
</p></dd></dl>

<a name="chaos_003asend_002dpkt_002dfun"></a><dl>
<dt><a name="index-chaos_003asend_002dpkt"></a>Function: <strong>chaos:send-pkt</strong> <em>conn pkt &amp;optional (opcode <code>chaos:dat-op</code>)</em></dt>
<dd><p>Transmits <em>pkt</em> on <em>conn</em>.  <em>pkt</em> should have been allocated with <code>chaos:get-pkt</code>
and then had its data field and n-bytes filled in.  <em>opcode</em> must be a data opcode
(200 or more) or EOF.  An error is signalled, with condition <code>chaos:not-open-state</code>,
if <em>conn</em> is not open.
</p>
<p>Giving a <code>pkt</code> to <code>chaos:send-pkt</code> constitutes giving it back to the system.
You do not need to call <code>chaos:return-pkt</code>.
</p></dd></dl>

<a name="chaos_003asend_002dstring_002dfun"></a><dl>
<dt><a name="index-chaos_003asend_002dstring"></a>Function: <strong>chaos:send-string</strong> <em>conn &amp;rest strings</em></dt>
<dd><p>Sends a data packet containing the concatenation of <em>strings</em> as its data.
</p></dd></dl>

<a name="chaos_003asend_002dunc_002dpkt_002dfun"></a><dl>
<dt><a name="index-chaos_003asend_002dunc_002dpkt"></a>Function: <strong>chaos:send-unc-pkt</strong> <em>conn pkt &amp;optional pkt-number ack-number</em></dt>
<dd><p>Transmits <em>pkt</em>, an UNC packet, on <em>conn</em>.  The opcode, packet
number, and acknowledge number fields in the packet header are filled in
(the latter two only if the optional arguments are supplied).
</p>
<p>See the AI memo on the chaosnet for more information on using foreign protocols.
</p></dd></dl>

<a name="chaos_003amay_002dtransmit_002dfun"></a><dl>
<dt><a name="index-chaos_003amay_002dtransmit"></a>Function: <strong>chaos:may-transmit</strong> <em>conn</em></dt>
<dd><p>A predicate that returns <code>t</code> if there is any space in the window for
transmitting on <em>conn</em>.  If the value is <code>nil</code>, you may have to wait
if you try to transmit.  If the value is <code>t</code>, you certainly do not have to wait.
</p></dd></dl>

<a name="chaos_003afinish_002dfun"></a><dl>
<dt><a name="index-chaos_003afinish"></a>Function: <strong>chaos:finish</strong> <em>conn &amp;optional (whostate <code>&quot;Net Finish&quot;</code>)</em></dt>
<dd><p>Waits until either all packets have been sent and acknowledged, or the connection ceases
to be open.  If successful, returns <code>t</code>; if the connection goes into a bad state,
returns <code>nil</code>.  <em>whostate</em> is the process state to display in the who-line
while waiting.
</p></dd></dl>

<a name="chaos_003aget_002dnext_002dpkt_002dfun"></a><dl>
<dt><a name="index-chaos_003aget_002dnext_002dpkt"></a>Function: <strong>chaos:get-next-pkt</strong> <em>conn &amp;optional (no-hang-p <code>nil</code>)</em></dt>
<dd><p>Returns the next input packet from <em>conn</em>.  When you are done with the packet you
must give it back to the system with <code>chaos:return-pkt</code>.  This can return
an RFC, CLS, or ANS packet, in addition to data, UNC, or EOF.
If <em>no-hang-p</em> is <code>t</code>, <code>nil</code> will be returned if there are no packets available
or the connection is in a bad state.  Otherwise an error will be signalled if
the connection is in a bad state, with condition name <code>chaos:host-down</code>,
<code>chaos:los-received-state</code>, or <code>chaos:read-on-closed-connection</code>.
If no packets are available and <em>no-hang-p</em> is <code>nil</code>, <code>chaos:get-next-pkt</code>
will wait for packets to come in or the state to change.  The process state
in the who-line is &quot;<code>Chaosnet Input</code>&quot;.
</p></dd></dl>

<a name="chaos_003adata_002davailable_002dfun"></a><dl>
<dt><a name="index-chaos_003adata_002davailable"></a>Function: <strong>chaos:data-available</strong> <em>conn</em></dt>
<dd><p>A predicate that returns <code>t</code> if there any input packets available from <em>conn</em>.
</p></dd></dl>

<p>Here are symbolic names for the opcodes that an applications programmer
needs to know about:
</p>
<a name="chaos_003arfc_002dop_002dvar"></a><dl>
<dt><a name="index-chaos_003arfc_002dop"></a>Variable: <strong>chaos:rfc-op</strong></dt>
<dd><p>This special-purpose opcode is used for requesting a connection.  The
data consists of the contact name terminated by a space character,
followed optionally by additional data whose meaning is up to the server
for that contact name.
</p></dd></dl>

<a name="chaos_003alsn_002dop_002dvar"></a><dl>
<dt><a name="index-chaos_003alsn_002dop"></a>Variable: <strong>chaos:lsn-op</strong></dt>
<dd><p>This special-purpose opcode is used when you ask to listen on a contact
name.  The data is just the contact name.  This packet is never actually
sent over the network, just kept in the chaosnet software and compared
with the contact names in RFC packets that arrive.
</p></dd></dl>

<a name="chaos_003aopn_002dop_002dvar"></a><dl>
<dt><a name="index-chaos_003aopn_002dop"></a>Variable: <strong>chaos:opn-op</strong></dt>
<dd><p>This special-purpose opcode is used by the server process to accept the
request for a connection conveyed by an RFC packet.
Its data serves only internal functions.
</p></dd></dl>

<a name="chaos_003aans_002dop_002dvar"></a><dl>
<dt><a name="index-chaos_003aans_002dop"></a>Variable: <strong>chaos:ans-op</strong></dt>
<dd><p>This special-purpose opcode is used to send a simple reply.  The simple
reply is sent back in place of opening a connection.
</p></dd></dl>

<a name="chaos_003alos_002dop_002dvar"></a><dl>
<dt><a name="index-chaos_003alos_002dop"></a>Variable: <strong>chaos:los-op</strong></dt>
<dd><p>This special-purpose packet is what you will receive if you try to use a
connection that has been broken.  Its data is a message explaining the
situation, which you can print for the user.
</p></dd></dl>

<a name="chaos_003acls_002dop_002dvar"></a><dl>
<dt><a name="index-chaos_003acls_002dop"></a>Variable: <strong>chaos:cls-op</strong></dt>
<dd><p>This special-purpose packet is used to close a connection.  Its data is
a message explaining the reason, and it can be printed for the user.
Note that you cannot count on receiving a CLS packet because it is
not retransmitted if it is lost.  If that happens you will get a
LOS when you try to use the connection (thinking it is still open).
</p>
<p>CLS packets are also used for refusing to open a connection in the
first place.
</p></dd></dl>

<a name="chaos_003aeof_002dop_002dvar"></a><dl>
<dt><a name="index-chaos_003aeof_002dop"></a>Variable: <strong>chaos:eof-op</strong></dt>
<dd><p>This special-purpose opcode is used to indicate the end of the data that
you really want to transmit.  When this packet is acknowledged by the
other process, you know that all the real data was received properly.
You can wait for this with <code>chaos:finish</code>.
The EOF packet carries no data itself.
</p></dd></dl>

<a name="chaos_003adat_002dop_002dvar"></a><dl>
<dt><a name="index-chaos_003adat_002dop"></a>Variable: <strong>chaos:dat-op</strong></dt>
<dd><p>This is opcode 200, which is the normal opcode used for 8-bit user data.
Some protocols use multiple data opcodes in the range 200 through 277,
but simple protocols that do not need to distinguish types of packets
just use opcode 200.
</p></dd></dl>

<a name="Connection-Interrupts"></a>
<h3 class="section">23.6 Connection Interrupts</h3>

<a name="chaos_003ainterrupt_002dfunction_002dfun"></a><dl>
<dt><a name="index-chaos_003ainterrupt_002dfunction"></a>Function: <strong>chaos:interrupt-function</strong> <em>conn</em></dt>
<dd><p>This attribute of a <code>conn</code> is a function to be called when certain
events occur on this connection.  Normally this is <code>nil</code>, which means
not to call any function, but you can use <code>setf</code> to store a function
here.  Since the function is called in the Chaosnet background process,
it should not do any operations that might have to wait for the network,
since that could permanently hang the background process.
</p>
<p>The function&rsquo;s first argument is one of the following symbols, giving the
reason for the &quot;interrupt&quot;.  The function&rsquo;s second argument is <em>conn</em>.
Additional arguments may be present depending on the reason.  The possible
reasons are:
</p><dl compact="compact">
<dt><code>:input</code></dt>
<dd><p>A packet has arrived for the connection when it had no input packets queued.
It is now possible to do <code>chaos:get-next-pkt</code> without having to wait.
There are no additional arguments.
</p>
</dd>
<dt><code>:output</code></dt>
<dd><p>An acknowledgement has arrived for the connection and made space in the window
when formerly it was full.  Additional output packets may now be transmitted
with <code>chaos:send-pkt</code> without having to wait.
There are no additional arguments.
</p>
</dd>
<dt><code>:change-of-state</code></dt>
<dd><p>The state of the connection has changed.  The third argument to the function
is the symbol for the new state.
</p></dd>
</dl>
</dd></dl>

<a name="chaos_003aread_002dpkts_002dfun"></a><dl>
<dt><a name="index-chaos_003aread_002dpkts"></a>Function: <strong>chaos:read-pkts</strong> <em>conn</em></dt>
<dd><p>Some interrupt functions will want to look at the queued input packets of a connection
when they get a <code>:input</code> interrupt.  <code>chaos:read-pkts</code> returns the first packet
available for reading.  Successive packets can be found by following <code>chaos:pkt-link</code>.
</p></dd></dl>

<a name="chaos_003apkt_002dlink_002dfun"></a><dl>
<dt><a name="index-chaos_003apkt_002dlink"></a>Function: <strong>chaos:pkt-link</strong> <em>pkt</em></dt>
<dd><p>Lists of packets in the NCP are threaded together by storing each packet
in the <code>chaos:pkt-link</code> of its predecessor.  The list is terminated with <code>nil</code>.
</p></dd></dl>

<a name="Chaosnet-Errors"></a>
<h3 class="section">23.7 Chaosnet Errors</h3>

<dl>
<dt><a name="index-_0028error_0029-on-sys_003anetwork_002derror"></a>Flavor Condition on sys:network-error: <strong>(<code>error</code>)</strong></dt>
<dd><p>All errors from the chaosnet code use flavors built on this one.
</p></dd></dl>

<a name="Local-Problems"></a>
<h4 class="subsection">23.7.1 Local Problems</h4>

<dl>
<dt><a name="index-_0028sys_003anetwork_002derror-on-sys_003alocal_002dnetwork_002derror"></a>Flavor Condition on sys:local-network-error: <strong>(<code>sys:network-error</code></strong> <em><code>error</code>)</em></dt>
<dd><p>This flavor is used for problems in connection with the chaosnet
that have entirely to do with what is going on in this Lisp machine.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003alocal_002dnetwork_002derror-sys_003anetwork_002derror-error_0029-on-sys_003anetwork_002dresources_002dexhausted"></a>Condition on sys:network-resources-exhausted: <strong>(<code>sys:local-network-error</code> <code>sys:network-error</code> <code>error</code>)</strong></dt>
<dd><p>Signaled when some local resource in the NCP was exhausted.  Most
likely, there are too many chaosnet connections and the connection table
is full.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003alocal_002dnetwork_002derror-sys_003anetwork_002derror-error_0029-on-sys_003aunknown_002daddress"></a>Condition on sys:unknown-address: <strong>(<code>sys:local-network-error</code> <code>sys:network-error</code> <code>error</code>)</strong></dt>
<dd><p>The <em>address</em> argument to <code>chaos:connect</code> or some similar function was not recognizable.
The <code>:address</code> operation on the condition instance returns the address that was supplied.
</p></dd></dl>

<a name="Problems-Involving-Other-Machines_0027-Actions"></a>
<h4 class="subsection">23.7.2 Problems Involving Other Machines&rsquo; Actions</h4>

<dl>
<dt><a name="index-_0028sys_003anetwork_002derror-on-sys_003aremote_002dnetwork_002derror"></a>Flavor Condition on sys:remote-network-error: <strong>(<code>sys:network-error</code></strong> <em><code>error</code>)</em></dt>
<dd><p>This flavor is used for network problems that involve the
actions (or lack of them) of other machines.
It is often useful to test for as a condition name.
</p>
<p>The operations <code>:connection</code> and <code>:foreign-host</code> return the
<code>chaos:conn</code> object and the host object for the foreign host.
</p></dd></dl>

<p>Every instance of <code>sys:remote-network-error</code> is either a
<code>sys:connection-error</code> or a <code>sys:bad-connection-state</code>.
</p>
<dl>
<dt><a name="index-_0028sys_003aremote_002dnetwork_002derror-error_0029-on-sys_003aconnection_002derror"></a>Condition on sys:connection-error: <strong>(<code>sys:remote-network-error</code> <code>error</code>)</strong></dt>
<dd><p>This condition name categorizes failure to complete a connection.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003aremote_002dnetwork_002derror-error_0029-on-sys_003abad_002dconnection_002dstate"></a>Condition on sys:bad-connection-state: <strong>(<code>sys:remote-network-error</code> <code>error</code>)</strong></dt>
<dd><p>This condition name categorizes errors where an existing, valid connection
becomes invalid.  The error is not signaled until you try to use the connection.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003aremote_002dnetwork_002derror-error_0029-on-sys_003ahost_002dnot_002dresponding"></a>Condition on sys:host-not-responding: <strong>(<code>sys:remote-network-error</code> <code>error</code>)</strong></dt>
<dd><p>This condition name categorizes errors where no packets whatever are
received from the foreign host, making it seem likely that that host or
the network is down.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003aconnection_002derror-sys_003ahost_002dnot_002dresponding-sys_003aremote_002dnetwork_002derror-error_0029-on-sys_003ahost_002dnot_002dresponding_002dduring_002dconnection"></a>Condition on sys:host-not-responding-during-connection: <strong>(<code>sys:connection-error</code> <code>sys:host-not-responding</code> <code>sys:remote-network-error</code> <code>error</code>)</strong></dt>
<dd><p>This condition is signaled when a host does not respond while it is
being asked to make a connection.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003abad_002dconnection_002dstate-sys_003ahost_002dnot_002dresponding-sys_003aremote_002dnetwork_002derror-error_0029-on-sys_003ahost_002dstopped_002dresponding"></a>Condition on sys:host-stopped-responding: <strong>(<code>sys:bad-connection-state</code> <code>sys:host-not-responding</code> <code>sys:remote-network-error</code> <code>error</code>)</strong></dt>
<dd><p>This condition is signaled when a host does not respond even though a
connection to it already exists.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003aconnection_002derror-sys_003aremote_002dnetwork_002derror-error_0029-on-sys_003aconnection_002drefused"></a>Condition on sys:connection-refused: <strong>(<code>sys:connection-error</code> <code>sys:remote-network-error</code> <code>error</code>)</strong></dt>
<dd><p>This is signaled when a connection is refused.
</p>
<p>The <code>:reason</code> operation on the condition instance returns the reason
specified in the CLS packet (a string) or <code>nil</code> if no reason was
given.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003abad_002dconnection_002dstate-sys_003aremote_002dnetwork_002derror-error_0029-on-sys_003aconnection_002dclosed"></a>Condition on sys:connection-closed: <strong>(<code>sys:bad-connection-state</code> <code>sys:remote-network-error</code> <code>error</code>)</strong></dt>
<dd><p>This is signaled when you try to send on a connection which has been closed
by the other host.
</p>
<p>The <code>:reason</code> operation on the condition instance returns the reason
specified in the CLS packet (a string) or <code>nil</code> if no reason was
given.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003abad_002dconnection_002dstate-sys_003aremote_002dnetwork_002derror-error_0029-on-sys_003aconnection_002dlost"></a>Condition on sys:connection-lost: <strong>(<code>sys:bad-connection-state</code> <code>sys:remote-network-error</code> <code>error</code>)</strong></dt>
<dd><p>This is signaled when you try to use a connection on which a LOS packet was received.
</p>
<p>The <code>:reason</code> operation on the condition instance returns the reason
specified in the CLS packet (a string) or <code>nil</code> if no reason was
given.
</p></dd></dl>

<dl>
<dt><a name="index-_0028sys_003abad_002dconnection_002dstate-sys_003aremote_002dnetwork_002derror-error_0029-on-sys_003aconnection_002dno_002dmore_002ddata"></a>Condition on sys:connection-no-more-data: <strong>(<code>sys:bad-connection-state</code> <code>sys:remote-network-error</code> <code>error</code>)</strong></dt>
<dd><p>This is signaled when you try to read from a connection which has been
closed by the other host, when there are no packets left to be read.
(It is no error to read from a connection which has been closed, if you
have not yet read all the packets which arrived, including the CLS
packet).
</p>
<p>The <code>:reason</code> operation on the condition instance returns the reason
specified in the CLS packet (a string) or <code>nil</code> if no reason was
given.
</p></dd></dl>

<a name="Information-and-Control"></a>
<h3 class="section">23.8 Information and Control</h3>

<a name="chaos_003ahost_002ddata_002dfun"></a><dl>
<dt><a name="index-chaos_003ahost_002ddata"></a>Function: <strong>chaos:host-data</strong> <em>&amp;optional host</em></dt>
<dd><p><em>host</em> may be a number or a known host name, and defaults to the local host.  Two
values are returned.  The first value is the host name and the second is
the host number.  If the host is a number not in the table, it is asked its name
using the <code>STATUS</code> protocol; if no response is received the name
<code>&quot;Unknown&quot;</code> is returned.
</p></dd></dl>

<a name="chaos_003aprint_002dconn_002dfun"></a><dl>
<dt><a name="index-chaos_003aprint_002dconn"></a>Function: <strong>chaos:print-conn</strong> <em>conn &amp;optional (short <code>t</code>)</em></dt>
<dd><p>Prints everything the system knows about the connection.  If <em>short</em> is <code>nil</code> it
also prints everything the system knows about each queued input and output packet
on the connection.
</p></dd></dl>

<a name="chaos_003aprint_002dpkt_002dfun"></a><dl>
<dt><a name="index-chaos_003aprint_002dpkt"></a>Function: <strong>chaos:print-pkt</strong> <em>pkt &amp;optional (short <code>nil</code>)</em></dt>
<dd><p>Prints everything the system knows about the packet, except its data field.
If <em>short</em> is <code>t</code>, only the first line of the information is printed.
</p></dd></dl>

<a name="chaos_003aprint_002dall_002dpkts_002dfun"></a><dl>
<dt><a name="index-chaos_003aprint_002dall_002dpkts"></a>Function: <strong>chaos:print-all-pkts</strong> <em>pkt &amp;optional (short <code>t</code>)</em></dt>
<dd><p>Calls <code>chaos:print-pkt</code> on <em>pkt</em> and all packets on the threaded list emanating
from it.
</p></dd></dl>

<a name="chaos_003astatus_002dfun"></a><dl>
<dt><a name="index-chaos_003astatus"></a>Function: <strong>chaos:status</strong></dt>
<dd><p>Prints the hardware status.
</p></dd></dl>

<a name="chaos_003areset_002dfun"></a><dl>
<dt><a name="index-chaos_003areset"></a>Function: <strong>chaos:reset</strong></dt>
<dd><p>Resets the hardware and software and turns off the network.
</p></dd></dl>

<a name="chaos_003aassure_002denabled_002dfun"></a><dl>
<dt><a name="index-chaos_003aassure_002denabled"></a>Function: <strong>chaos:assure-enabled</strong></dt>
<dd><p>Turns on the network if it is not already on.  It is normally always on unless
you call one of these functions.
</p></dd></dl>

<a name="chaos_003aenable_002dfun"></a><dl>
<dt><a name="index-chaos_003aenable"></a>Function: <strong>chaos:enable</strong></dt>
<dd><p>Resets the hardware and turns on the network.
</p></dd></dl>

<a name="chaos_003adisable_002dfun"></a><dl>
<dt><a name="index-chaos_003adisable"></a>Function: <strong>chaos:disable</strong></dt>
<dd><p>Resets the hardware and turns off the network.
</p></dd></dl>

<p>The PEEK program has a mode that displays the status of all of the Lisp
machine&rsquo;s chaosnet connections, and various other information, in a
continuously updating fashion.
</p>
<a name="Higher_002dLevel-Protocols"></a>
<h3 class="section">23.9 Higher-Level Protocols</h3>

<p>This section briefly documents some of the higher-level protocols of
the most general interest.  There are quite a few other protocols which
are too specialized to mention here.  All protocols other than the
<code>STATUS</code> protocol are optional and are only implemented by those
hosts that need them.  All hosts are required to implement the
<code>STATUS</code> protocol since it is used for network maintenance.
</p>
<p>The site files tell the Lisp machine which hosts at your site implement
certain higher-level protocols.  See <a href="#site_002dfiles">site-files</a>.
</p>
<a name="Status"></a>
<h4 class="subsection">23.9.1 Status</h4>

<p>All network nodes, even bridges, are required to answer RFC&rsquo;s with contact
name <code>STATUS</code>, returning an ANS packet in a simple transaction.  This
protocol is primarily used for network maintenance.  The answer to a
<code>STATUS</code> request should be generated by the Network Control Program,
rather than by starting up a server process, in order to provide rapid
response.
</p>
<p>The <code>STATUS</code> protocol is used to determine whether a host is up,
to determine whether an operable path through the network exists between
two hosts, to monitor network error statistics, and to debug new Network
Control Programs and new Chaosnet hardware.  The <code>hostat</code> function
on the Lisp machine uses this protocol.
</p>
<p>The first 32 bytes of the ANS contain the name of the node, padded on
the right with zero bytes.  The rest of the packet contains blocks of
information expressed in 16-bit and 32-bit words, low byte first
(PDP-11/Lisp machine style).  The low-order half of a 32-bit word comes
first.  Since ANS packets contain 8-bit data (not 16-bit), machines such
as PDP-10s which store numbers high byte first will have to shuffle the
bytes when using this protocol.  The first 16-bit word in a block is its
identification.  The second 16-bit word is the number of 16-bit words to
follow.  The remaining words in the block depend on the identification.
</p>
<p>This is the only block type currently defined.  All items are optional,
according to the count field, and extra items not defined here may be
present and should be ignored.  Note that items after the first two
are 32-bit words.
</p><dl compact="compact">
<dt><span class="roman">word 0</span></dt>
<dd><p>A number between 400 and 777 octal.  This is 400 plus a subnet number.
This block contains information on this host&rsquo;s direct connection to
that subnet.
</p>
</dd>
<dt><span class="roman">word 1</span></dt>
<dd><p>The number of 16-bit words to follow, usually 16.
</p>
</dd>
<dt><span class="roman">words 2-3</span></dt>
<dd><p>The number of packets received from this subnet.
</p>
</dd>
<dt><span class="roman">words 4-5</span></dt>
<dd><p>The number of packets transmitted to this subnet.
</p>
</dd>
<dt><span class="roman">words 6-7</span></dt>
<dd><p>The number of transmissions to this subnet aborted by collisions or
because the receiver was busy.
</p>
</dd>
<dt><span class="roman">words 8-9</span></dt>
<dd><p>The number of incoming packets from this subnet lost because the
host had not yet read a previous packet out of the interface and consequently
the interface could not capture the packet.
</p>
</dd>
<dt><span class="roman">words 10-11</span></dt>
<dd><p>The number of incoming packets from this subnet with CRC errors.
These were either transmitted wrong or damaged in transmission.
</p>
</dd>
<dt><span class="roman">words 12-13</span></dt>
<dd><p>The number of incoming packets from this subnet that had no CRC
error when received, but did have an error after being read out of
the packet buffer.  This error indicates either a hardware problem with the
packet buffer or an incorrect packet length.
</p>
</dd>
<dt><span class="roman">words 14-15</span></dt>
<dd><p>The number of incoming packets from this subnet that were rejected
due to incorrect length (typically not a multiple of 16 bits).
</p>
</dd>
<dt><span class="roman">words 16-17</span></dt>
<dd><p>The number of incoming packets from this subnet rejected for
other reasons (e.g too short to contain a header, garbage byte-count,
forwarded too many times.)
</p></dd>
</dl>

<p>If the identification is a number between 0 and 377 octal, this is an obsolete
format of block.  The identification is a subnet number and the counts are as
above except that they are only 16 bits instead of 32, and consequently may overflow.
This format should no longer be sent by any hosts.
</p>
<p>Identification numbers of 1000 octal and up are reserved for future use.
</p>
<a name="Telnet-and-Supdup"></a>
<h4 class="subsection">23.9.2 Telnet and Supdup</h4>

<p>The Telnet and Supdup protocols of the Arpanet exist in
identical form in Chaosnet.  These protocols allow access to a
computer system as an interactive terminal from another network node.
</p>
<p>The contact names are <code>TELNET</code> and <code>SUPDUP</code>.  The direct borrowing of
the Telnet and Supdup protocols was eased by their use of 8-bit byte
streams and of only a single connection.  Note that these protocols define
their own character sets, which differ from each other and from the
Chaosnet standard character set.
</p>
<p>For the Telnet protocol, refer to the Arpanet Protocol Handbook.  For
the Supdup protocol, see AI memo 644.
</p>
<p>Chaosnet contains no counterpart of the INR/INS attention-getting feature
of the Arpanet.  The Telnet protocol sends a packet with opcode 201 in
place of the INS signal.  This is a controlled packet and hence does not
provide the &quot;out of band&quot; feature of the Arpanet INS, however it is
satisfactory for the Telnet &quot;interrupt process&quot; and &quot;discard output&quot;
operations on the kinds of hosts attached to Chaosnet.
</p>
<a name="File-Access"></a>
<h4 class="subsection">23.9.3 File Access</h4>

<p>The FILE protocol is primarily used by Lisp machines to access files on
network file servers.  ITS and TOPS-20 are equipped to act as file
servers.  A user end for the file protocol also exists for TOPS-20 and
is used for general-purpose file transfer.  For complete documentation
on the file protocol, see <code>SYS: DOC; FILE TEXT</code>.  The Arpanet file
transfer protocols have not been implemented on the Chaosnet (except
through the Arpanet gateway described below).
</p>
<a name="Mail"></a>
<h4 class="subsection">23.9.4 Mail</h4>

<p>The MAIL protocol is used to transmit inter-user messages through the Chaosnet.
The Arpanet mail protocol was not used because of its complexity and poor
state of documentation.  This simple protocol is by no means the last word
in mail protocols; however, it is adequate for the mail systems we presently
possess.
</p>
<p>The sender of mail connects to contact name <code>MAIL</code> and establishes a stream connection.
It then sends the names of all the recipients to which the mail is to be sent
at (or via) the server host.  The names are sent one to a line and terminated
by a blank line (two carriage returns in a row).  The Lisp Machine character
set is used.  A reply (see below) is immediately returned for each recipient.
A recipient is typically just the name of a user, but it can be a user-atsign-host
sequence or anything else acceptable to the mail system on the server machine.
After sending the recipients, the sender sends the text of the message, terminated
by an EOF.  After the mail has been successfully swallowed, a reply is sent.
After the sender of mail has read the reply, both sides close the connection.
</p>
<p>In the MAIL protocol, a reply is a signal from the server to the user
(or sender) indicating success or failure.  The first character of a reply
is a plus sign for success, a minus sign for permanent failure (e.g no such
user exists), or a percent sign for temporary failure (e.g unable to receive message
because disk is full).  The rest of a reply is a human-readable character string
explaining the situation, followed by a carriage return.
</p>
<p>The message text transmitted through the mail protocol normally contains a header
formatted in the Arpanet standard fashion.  Refer to the Arpanet Protocols Handbook.
</p>
<a name="Send"></a>
<h4 class="subsection">23.9.5 Send</h4>

<p>The SEND protocol is used to transmit an interactive message (requiring
immediate attention) between users.  The sender connects to contact name
<code>SEND</code> at the machine to which the recipient is logged in.  The remainder of
the RFC packet contains the name of the person being sent to.  A stream
connection is opened and the message is transmitted, followed by an EOF.
Both sides close after following the end-of-data protocol described in <a href="#safe_002deof_002dprotocol">safe-eof-protocol</a>.
The fact that the RFC was responded to affirmatively indicates that the
recipient is in fact present and accepting messages.  The message text should begin
with a suitable header, naming the user that sent the message.  The standard
for such headers, not currently adhered to by all hosts, is one line formatted
as in the following example:
</p><div class="lisp">
<pre class="lisp">Moon@MIT-MC 6/15/81 02:20:17
</pre></div>
<p>Automatic reply to the sender can be implemented by searching for the first
&quot;@&quot; and using the SEND protocol to the host following the &quot;@&quot; with the
argument preceding it.
</p>
<a name="Name"></a>
<h4 class="subsection">23.9.6 Name</h4>

<p>The Name/Finger protocol of the Arpanet exists in identical form
on the Chaosnet.  Both Lisp machines and timesharing machines support this
protocol and provide a display of the user(s) currently logged in to them.
</p>
<p>The contact name is <code>NAME</code>, which can be followed by a space and a string of
arguments like the &quot;command line&quot; of the Arpanet protocol.  A stream
connection is established and the &quot;finger&quot; display is output in Lisp
Machine character set, followed by an EOF.
</p>
<p>Lisp Machines also support the FINGER protocol, a simple-transaction version
of the NAME protocol.  An RFC with contact name <code>FINGER</code> is transmitted and
the response is an ANS containing the following items of information separated
by carriage returns: the logged-in user ID, the location of the terminal, the
idle time in minutes or hours-colon-minutes, the user&rsquo;s full name, and
the user&rsquo;s group affiliation.
</p>
<a name="Time"></a>
<h4 class="subsection">23.9.7 Time</h4>

<p>The Time protocol allows a host such as a Lisp machine that has no
long-term timebase to ask the time of day.  An RFC to contact name
<code>TIME</code> evokes an ANS containing the number of seconds since midnight
Greenwich Mean Time, Jan 1, 1900 as a 32-bit number in four 8-bit bytes,
least-significant byte first.
</p>
<a name="Arpanet-Gateway"></a>
<h4 class="subsection">23.9.8 Arpanet Gateway</h4>
<a name="arpanet_002dgateway"></a>
<p>This protocol allows a Chaosnet host to access almost any service on
the Arpanet.  The gateway server runs on each ITS host that is connected
to both networks.  It creates an Arpanet connection and a Chaosnet connection
and forwards data bytes from one to the other.  It also provides for a one-way
auxiliary connection, used for the data connection of the Arpanet File Transfer Protocol.
</p>
<p>The RFC packet contains a contact name of <code>ARPA</code>, a space, the name
of the Arpanet host to be connected to, optionally followed by a space
and the contact-socket number in octal, which defaults to 1 if omitted.
The Arpanet Initial Connection Protocol is used to establish a bi-directional
8-bit connection.
</p>
<p>If a data packet with opcode 201 (octal) is received, an Arpanet INS
signal will be transmitted.  Any data bytes in this packet are transmitted normally.
</p>
<p>If a data packet with opcode 210 (octal) is received, an auxiliary
connection on each network is opened.  The first eight data bytes are
the Chaosnet contact name for the auxiliary connection; the user should
send an RFC with this name to the server.  The next four data bytes are the
Arpanet socket number to be connected to, in the wrong order, most-significant
byte first.  The byte-size of the auxiliary connection is 8 bits.
</p>
<p>The normal closing of an Arpanet connection corresponds to an EOF packet.
Closing due to an error, such as Host Dead, corresponds to a CLS packet.
</p>
<a name="Host-Table"></a>
<h4 class="subsection">23.9.9 Host Table</h4>

<p>The <code>HOSTAB</code> protocol may be used to access tables of host addresses
on other networks, such as the Arpanet.  Servers for this protocol
currently exist for Tenex and TOPS-20.
</p>
<p>The user connects to contact name <code>HOSTAB</code>, undertakes a number of
transactions, then closes the connection.  Each transaction is initiated
by the user transmitting a host name followed by a carriage return.  The
server responds with information about that host, terminated with an EOF,
and is then ready for another transaction.  The server&rsquo;s response
consists of a number of attributes of the host.  Each attribute consists
of an identifying name, a space character, the value of the attribute,
and a carriage return.  Values may be strings (free of carriage returns
and <em>not</em> surrounded by double-quotes) or octal numbers.
Attribute names and most values are in upper case.  There can be more than
one attribute with the same name; for example, a host may have more than
one name or more than one network address.
</p>
<p>The standard attribute names defined now are as follows.  Note that more
are likely to be added in the future.
</p>
<dl compact="compact">
<dt><tt>ERROR</tt></dt>
<dd><p>The value is an error message.  The only error one might expect
to get is &quot;no such host&quot;.
</p>
</dd>
<dt><tt>NAME</tt></dt>
<dd><p>The value is a name of the host.  There may be more than one <code>NAME</code>
attribute; the first one is always the official name, and any additional
names are nicknames.
</p>
</dd>
<dt><tt>MACHINE-TYPE</tt></dt>
<dd><p>The value is the type of machine, such as <code>LISPM</code>, <code>PDP10</code>, etc.
</p>
</dd>
<dt><tt>SYSTEM-TYPE</tt></dt>
<dd><p>The value is the type of software running on the machine,
such as <code>LISPM</code>, <code>ITS</code>, etc.
</p>
</dd>
<dt><tt>ARPA</tt></dt>
<dd><p>The value is an address of the host on the Arpanet, in the form
<em>host</em>/<em>imp</em>.  The two numbers are decimal.
</p>
</dd>
<dt><tt>CHAOS</tt></dt>
<dd><p>The value is an address of the host on Chaosnet, as an octal number.
</p>
</dd>
<dt><tt>DIAL</tt></dt>
<dd><p>The value is an address of the host on Dialnet, as a telephone number.
</p>
</dd>
<dt><tt>LCS</tt></dt>
<dd><p>The value is an address of the host on the LCSnet, as two octal numbers
separated by a slash.
</p>
</dd>
<dt><tt>SU</tt></dt>
<dd><p>The value is an address of the host on the SUnet, in the form
<em>net</em>#<em>host</em>.  The two numbers are octal.
</p>
</dd>
</dl>

<a name="Dover"></a>
<h4 class="subsection">23.9.10 Dover</h4>

<p>A press file may be sent to the Dover printer at MIT by connecting to contact
name <code>DOVER</code> at host <code>AI-CHAOS-11</code>.  This host provides a protocol
translation service that translates from Chaosnet stream protocol to
the <code>EFTP</code> protocol spoken by the Dover printer.  Only one file at
a time can be sent to the Dover, so an attempt to use this service may
be refused by a CLS packet containing the string <code>&quot;BUSY&quot;</code>.
Once the connection has been established, the press file is transmitted
as a sequence of 8-bit bytes in data packets (opcode 200).  It is necessary
to provide packets rapidly enough to keep the Dover&rsquo;s program (Spruce)
from timing out; a packet every five seconds suffices.  Of course, packets
are normally transmitted much more rapidly.
</p>
<p>Once the file has been transmitted, an EOF packet must be sent.
The transmitter must wait for that EOF to be acknowledged, then send a
second one, and then close the connection.  The two EOF&rsquo;s are
necessary to provide the proper connection-closing sequence for the
<code>EFTP</code> protocol.  Once the press file has been transmitted to the
Dover in this way and stored on the Dover&rsquo;s local disk, it will be
processed, prepared for printing, and printed.
</p>
<p>If an error message is returned by the Dover while the press file is
being transmitted, it will be reported back through the Chaosnet as a
LOS containing the text of the error message.  Such errors are
fairly common; the sender of the press file should be prepared to retry
the operation a few times.
</p>
<p>Most programs that send press files to the Dover first wait for the
Dover to be idle, using the Foreign Protocol mechanism of Chaosnet to
check the status of the Dover.  This is optional, but is courteous to
other users since it prevents printing from being held up while
additional files are sent to the Dover and queued on its local disk.
</p>
<p>It would be possible to send to a press file to the Dover using its
<code>EFTP</code> protocol through the Foreign Protocol mechanism, rather than
using the <code>AI-CHAOS-11</code> gateway service.  This is not usually done
because <code>EFTP</code>, which requires a handshake for every packet, tends to
be very slow on a timesharing system.
</p>
<a name="Remote-Disk"></a>
<h4 class="subsection">23.9.11 Remote Disk</h4>

<p>The Remote Disk server exists on Lisp machines to allow other machines
to refer to or modify the contents of the Lisp machine&rsquo;s disk.
Primarily this is used for printing and editing the disk label.
</p>
<p>After first establishing a connection to contact name <code>REMOTE-DISK</code>,
the user process sends commands as packets which contain a line of text,
ending with a <code>Return</code> character.  The text consists of a command name, a
space, and arguments interpreted according to the command.  The server
processing the command may send disk data to the user, or it may read
successive packets and write them to the disk.  It is up to the user to
know how many packets of disk data to read or send after each command.
The commands are:
</p><dl compact="compact">
<dt><code>READ <em>unit</em> <em>block</em> <em>n-blocks</em></code></dt>
<dd><p>Read <em>n-blocks</em> of data from disk <em>unit</em> starting at <em>block</em> and
transmit their contents to the user process.
</p>
</dd>
<dt><code>WRITE <em>unit</em> <em>block</em> <em>n-blocks</em></code></dt>
<dd><p>Read data from the net connection and store it into <em>n-blocks</em> disk
blocks on disk <em>unit</em> starting at <em>block</em>.
</p>
</dd>
<dt><code>SAY <em>text</em></code></dt>
<dd><p><em>text</em>, which is simply all the rest of the line following <code>SAY</code>, is
printed on the screen of the server host as a notification.
</p></dd>
</dl>

<p>Each disk block is transmitted as three packets, the first two
containing the data for 121 (decimal) Lisp machine words, and the third
containing the data for the remaining 14 (decimal) words of the disk
block.  Each packet&rsquo;s data ends with a checksum made by adding together
all the 8-bit bytes of the actual disk data stored in the packet.
</p>
<a name="The-Eval-Server"></a>
<h4 class="subsection">23.9.12 The Eval Server</h4>

<p>The Eval server is available on Lisp machines with contact name
<code>EVAL</code>.  It provides a read-eval-print loop which reads and prints
using the chaosnet connection.  The data consists of text in the ASCII
character set.
</p>
<p>Each time a complete s-expression arrives, the Eval
server reads it, evaluates it and prints the list of values back onto
the network connection, followed by a CRLF.  There is no way for the
user process to tell the end of the output for a particular
s-expression; the usual application is simply to copy all the output to
a user&rsquo;s terminal asynchronously.
</p>
<p>The Eval server is disabled when the Lisp machine is logged in, unless
the user requests to enable it.
</p>
<a name="chaos_003aeval_002dserver_002don_002dfun"></a><dl>
<dt><a name="index-chaos_003aeval_002dserver_002don"></a>Function: <strong>chaos:eval-server-on</strong> <em>mode</em></dt>
<dd><p>Turn the Eval server on this Lisp machine on or off.
<em>mode</em> can be <code>t</code> (on), <code>nil</code> (off), or <code>:notify</code> (on, but
notify the user when a connection is made).
</p></dd></dl>

<a name="Using-Higher-Level-Protocols"></a>
<h3 class="section">23.10 Using Higher Level Protocols</h3>

<a name="qsend_002dfun"></a><dl>
<dt><a name="index-qsend"></a>Function: <strong>qsend</strong> <em>user &amp;optional text</em></dt>
<dd><p>Sends a message to another user.  <code>qsend</code> is different from <code>mail</code> because it
sends the message immediately; it will appear within seconds on the other user&rsquo;s
screen, rather than being saved in her mail file.
</p>
<p><em>user</em> should be a string of the form <code>&quot;<em>username<code>@</code>hostname</em>&quot;</code>;
<em>host</em> is the name of the Lisp Machine or timesharing system the user
is currently logged-in to.  Multiple recipients separated by commas are
also allowed.  <em>text</em> is a string which is the message.  If <em>text</em>
is not specified, you will be prompted to type in a message.
</p>
<p>Unlike <code>mail</code> and <code>bug</code>, <code>qsend</code> does not put up a window to allow
you to compose the message; it just reads it from the input stream.  Use
Converse if you wish to compose sends in the editor.  Converse can be
invoked by typing System-C.  If you have started typing in a message to
<code>qsend</code>, you can switch to Converse by typing <code>Control-Meta-E</code>
(&quot;Edit&quot;).  The text you have typed so far will be transferred into
Converse.
</p>
<p><code>qsend</code> does give you the ability to insert the text of the last
message you received.  Type <code>Control-Meta-Y</code> to do this.
</p></dd></dl>

<a name="reply_002dfun"></a><dl>
<dt><a name="index-reply"></a>Function: <strong>reply</strong> <em>&amp;optional text</em></dt>
<dd><p>Sends <em>text</em> as a message to the last user who sent a message to you.
This is like <code>qsend</code> with an appropriate first argument provided.
</p></dd></dl>

<a name="chaos_003ashout_002dfun"></a><dl>
<dt><a name="index-chaos_003ashout"></a>Function: <strong>chaos:shout</strong> <em>&amp;optional message</em></dt>
<dd><p>Sends <em>message</em> to every Lisp machine at your site.
If you do not specify <em>message</em>, it is read from <code>standard-input</code>.
</p></dd></dl>

<a name="print_002dsends_002dfun"></a><dl>
<dt><a name="index-print_002dsends"></a>Function: <strong>print-sends</strong></dt>
<dd><p>Reprints any messages that have been received.  This is useful if you want to see
a message again.
</p></dd></dl>

<a name="supdup_002dfun"></a><dl>
<dt><a name="index-supdup"></a>Function: <strong>supdup</strong> <em>&amp;optional host</em></dt>
<dd><p><em>host</em> may be a string or symbol, which will be taken as a host name,
or a number, which will be taken as a host number.  If no <em>host</em> is
given, the machine you are logged-in to is assumed.
This function opens a connection to the host
over the Chaosnet using the Supdup protocol, and allows the Lisp
Machine to be used as a terminal for any ITS or TOPS-20 system.
</p>
<p>To give commands to <code>supdup</code>, type the <code>Network</code> key followed by one character.
Type <code>Network</code> followed by <code>Help</code> for documentation.
</p></dd></dl>

<a name="telnet_002dfun"></a><dl>
<dt><a name="index-telnet"></a>Function: <strong>telnet</strong> <em>&amp;optional host simulate-imlac</em></dt>
<dd><p><code>telnet</code> is similar to <code>supdup</code> but uses the Arpanet-standard Telnet
protocol, simulating a printing terminal rather than a display terminal.
</p></dd></dl>

<a name="hostat_002dfun"></a><dl>
<dt><a name="index-hostat"></a>Function: <strong>hostat</strong> <em>&amp;rest hosts</em></dt>
<dd><p>Asks each of the <em>hosts</em> for its status using the <code>STATUS</code> protocol,
and prints the results.  If no hosts are specified, all hosts on the
Chaosnet are asked.  Hosts can be specified either by name or by number.
</p>
<p>For each host, a line is output that either says that the host is not
responding or gives metering information for the host&rsquo;s network
attachments.  If a host is not responding, that usually means that it is down
or there is no such host at that address.  A Lisp Machine can fail to respond
if it is looping inside <code>without-interrupts</code> or paging extremely heavily,
such that it is simply unable to respond within a reasonable amount of time.
</p></dd></dl>

<a name="chaos_003afinger_002dfun"></a><dl>
<dt><a name="index-chaos_003afinger"></a>Function: <strong>chaos:finger</strong> <em>&amp;optional spec (stream <code>standard-output</code>)</em></dt>
<dd><a name="chaos_003awhois_002dfun"></a></dd><dt><a name="index-chaos_003awhois"></a>Function: <strong>chaos:whois</strong> <em>&amp;optional spec (stream <code>standard-output</code>)</em></dt>
<dd><p>Print brief (<code>finger</code>) or verbose (<code>whois</code>) information about a user
or users specified by <em>spec</em>, on <em>stream</em>.  <em>spec</em> can be a user
name, <code>@</code> followed by a host name, or a user name, <code>@</code>, and a host
name.  If there is no host name, the default login host is used.  If
there is no user name, all users on the host are described.
</p></dd></dl>

<a name="chaos_003afinger_002dall_002dlms_002dfun"></a><dl>
<dt><a name="index-chaos_003afinger_002dall_002dlms"></a>Function: <strong>chaos:finger-all-lms</strong> <em>&amp;optional stream print-free return-free hosts</em></dt>
<dd><p>Print a line of information about the user of each Lisp machine in
<em>hosts</em> (the default is all Lisp machines at this site) on <em>stream</em>
(default is <code>standard-output</code>).
</p>
<p>If <em>print-free</em> is non-<code>nil</code>, information on free Lisp machines and
nonresponding Lisp machines is also printed.
</p>
<p>If <em>return-free</em> is non-<code>nil</code>, then this function returns two
values, the first a list of host objects of free Lisp machines, the
second a list of host objects of nonresponding Lisp machines.
</p></dd></dl>

<a name="chaos_003auser_002dlogged_002dinto_002dhost_002dp_002dfun"></a><dl>
<dt><a name="index-chaos_003auser_002dlogged_002dinto_002dhost_002dp"></a>Function: <strong>chaos:user-logged-into-host-p</strong> <em>username host</em></dt>
<dd><p>Returns <code>t</code> if there is a user named <em>username</em> logged in on
<em>host</em> (a host name or host object).
</p></dd></dl>

<a name="chaos_003afind_002dhosts_002dor_002dlispms_002dlogged_002din_002das_002duser_002dfun"></a><dl>
<dt><a name="index-chaos_003afind_002dhosts_002dor_002dlispms_002dlogged_002din_002das_002duser"></a>Function: <strong>chaos:find-hosts-or-lispms-logged-in-as-user</strong> <em>user hosts</em></dt>
<dd><p>Return a list of host objects for hosts on which <em>user</em> is logged in.
All Lisp machines at this site are checked, and so are <em>hosts</em> (which
are presumably non-Lisp machines).
</p></dd></dl>

<a name="tv_003aclose_002dall_002dservers_002dfun"></a><dl>
<dt><a name="index-tv_003aclose_002dall_002dservers"></a>Function: <strong>tv:close-all-servers</strong> <em>reason</em></dt>
<dd><p>Close the connections of all network servers on this Lisp machine,
giving <em>reason</em> (a string) as the reason in the CLS packet.
</p>
<p>Note that PEEK has a mode that displays information on the active
network servers.
</p></dd></dl>

<a name="g_t_0022Packages_0022"></a>
<h2 class="chapter">24 &quot;Packages&quot;</h2>
<a name="index-package"></a>
<a name="package"></a><a name="package_002dchapter"></a>
<p>A Lisp program is a collection of function definitions.
The functions are known by their names, and so each must have its
own name to identify it.  Clearly a programmer must not use the same
name for two different functions.
</p>
<p>The Lisp Machine consists of a huge Lisp environment, in which many
programs must coexist. All of the &quot;operating system&quot;, the compiler, the
editor, and a wide variety of programs are provided in the initial
environment.  Furthermore, every program that the user uses during
his session must be loaded into the same environment.  Each of these
programs is composed of a group of functions; apparently each function
must have its own distinct name to avoid conflicts.  For example, if
the compiler had a function named <code>pull</code>, and the user loaded a program
which had its own function named <code>pull</code>, the compiler&rsquo;s <code>pull</code> would be
redefined, probably breaking the compiler.
</p>
<p>It would not really be possible to prevent these conflicts,
since the programs are written by many different people who could
never get together to hash out who gets the privilege of using
a specific name such as <code>pull</code>.
</p>
<p>Now, if we are to enable two programs to coexist in the Lisp
world, each with its own function <code>pull</code>, then each program must have
its own symbol named &quot;<code>pull</code>&quot;, because there can&rsquo;t be two function
definitions on the same symbol.  This means that separate &quot;name
spaces&quot;&ndash;mappings between names and symbols&ndash;must be provided for
the two programs.  The package system is designed to do just that.
</p>
<p>Under the package system, the author of a program or a group
of closely related programs identifies them together as a &quot;package&quot;.
The package system associates a distinct name space with each package.
</p>
<p>Here is an example: suppose there are two programs named <code>chaos</code>
and <code>arpa</code>, for handling the Chaosnet and Arpanet respectively.  The
author of each program wants to have a function called <code>get-packet</code>,
which reads in a packet from the network (or something).  Also, each
wants to have a function called <code>allocate-pbuf</code>, which allocates the
packet buffer.  Each &quot;get&quot; routine first allocates a packet buffer,
and then reads bits into the buffer; therefore, each version of
<code>get-packet</code> should call the respective version of <code>allocate-pbuf</code>.
</p>
<p>Without the package system, the two programs could not coexist
in the same Lisp environment.  But the package feature can be used to
provide a separate name space for each program.  What is required is
to declare a package named <code>chaos</code> to contain the Chaosnet program, and
another package <code>arpa</code> to hold the Arpanet program.  When the Chaosnet
program is read into the machine, its symbols would be entered in the
<code>chaos</code> package&rsquo;s name space.  So when the Chaosnet program&rsquo;s
<code>get-packet</code> referred to <code>allocate-pbuf</code>, the <code>allocate-pbuf</code> in the <code>chaos</code>
name space would be found, which would be the <code>allocate-pbuf</code> of the
Chaosnet program&ndash;the right one.  Similarly, the Arpanet program&rsquo;s
<code>get-packet</code> would be read in using the <code>arpa</code> package&rsquo;s name space and
would refer to the Arpanet program&rsquo;s <code>allocate-pbuf</code>.
</p>
<p>To understand what is going on here, you should keep in mind
how Lisp reading and loading works.  When a file is gotten into the
Lisp Machine, either by being read or by being fasloaded, the file itself
obviously cannot contain Lisp objects; it contains printed representations
of those objects.  When the reader encounters a printed representation of a symbol,
it calls <code>intern</code> to look up that string in some name space and find
a corresponding symbol.  The package system arranges that the correct
name space is used whenever a file is loaded.
</p>
<a name="g_t_0022The-Organization-of-Name-Spaces_0022"></a>
<h3 class="section">24.1 &quot;The Organization of Name Spaces&quot;</h3>

<p>We could simply let every name space be implemented as one
obarray, e.g one big table of symbols.  The problem with this is
that just about every name space wants to include the whole
Lisp language: <code>car</code>, <code>cdr</code>, and so on should be available to every
program.  We would like to share the main Lisp system between
several name spaces without making many copies.
</p>
<p>Instead of making each name space be one big array,
we arrange packages in a tree.  Each package has a
&quot;superpackage&quot; or &quot;parent&quot;, from which it &quot;inherits&quot; symbols.  Also,
each package has a table, or &quot;obarray&quot;, of its own additional
symbols.  The symbols belonging to a package are simply those in the
package&rsquo;s own obarray, followed by those belonging to the
superpackage.  The root of the tree of packages is the package called
<code>global</code>, which has no superpackage.  <code>global</code> contains <code>car</code> and <code>cdr</code> and
all the rest of the standard Lisp system.  In our example, we might
have two other packages called <code>chaos</code> and <code>arpa</code>, each of which would
have <code>global</code> as its parent.  Here is a picture of the resulting tree
structure:
</p><div class="lisp">
<pre class="lisp">                    global
                       |
          /----------------------------\
          |                            |
        chaos                         arpa
</pre></div>

<p>In order to make the sharing of the <code>global</code> package work, the
<code>intern</code> function is made more complicated than in basic Lisp.  In
addition to the string or symbol to intern, it must be told which
package to do it in.  First it searches for a symbol with the
specified name in the obarray of the specified package.  If nothing is
found there, <code>intern</code> looks at its superpackage, and then at the
superpackage&rsquo;s superpackage, and so on, until the name is found or a
root package such as <code>global</code> is reached.
When <code>intern</code> reaches the root package, and doesn&rsquo;t find the symbol there either,
it decides that there is no symbol known with that name, and adds a
symbol to the originally specified package.
</p>
<p>Since you don&rsquo;t normally want to worry about specifying
packages, <code>intern</code> normally uses the &quot;current&quot; package, which is the
value of the symbol <code>package</code>.  This symbol serves the purpose of the
symbol <code>obarray</code> in Maclisp.
</p>
<p>Here&rsquo;s how that works in the above example.  When the Chaosnet program is read into the Lisp world, the current package would be
the <code>chaos</code> package.  Thus all of the symbols in the Chaosnet program
would be interned on the <code>chaos</code> package.  If there is a reference to
some well known global symbol such as <code>append</code>, <code>intern</code> would look for
&quot;<code>append</code>&quot; on the <code>chaos</code> package, not find it, look for &quot;<code>append</code>&quot; on
<code>global</code>, and find the regular Lisp <code>append</code> symbol, and return that.  If,
however, there is a reference to a symbol that the user made up
himself (say it is called <code>get-packet</code>), the first time he uses it,
<code>intern</code> won&rsquo;t find it on either <code>chaos</code> or <code>global</code>.  So <code>intern</code> will make
a new symbol named <code>get-packet</code>, and install it on the <code>chaos</code> package.
When <code>get-packet</code> is referred to later in the Chaosnet program, <code>intern</code>
will find <code>get-packet</code> on the <code>chaos</code> package.
</p>
<p>When the Arpanet program is read in, the current package is
<code>arpa</code> instead of <code>chaos</code>.  When the Arpanet program refers
to <code>append</code>, it gets the <code>global</code> one; that is, it shares the same one
that the Chaosnet program got.  However, if it refers to <code>get-packet</code>,
it will <em>not</em> get the same one the Chaosnet program got, because
the <code>chaos</code> package is not being searched.  Rather, the <code>arpa</code> and <code>global</code>
packages are getting searched.  So <code>intern</code> will create a new <code>get-packet</code>
and install it on the <code>arpa</code> package.
</p>
<p>So what has happened is that there are two <code>get-packet</code>s: one for
<code>chaos</code> and one for <code>arpa</code>.  The two programs are loaded together without name
conflicts.
</p>
<a name="g_t_0022Shared-Programs_0022"></a>
<h3 class="section">24.2 &quot;Shared Programs&quot;</h3>

<p>Now, a very important feature of the Lisp Machine is that of
&quot;shared programs&quot;; if one person writes a function to, say, print
numbers in Roman numerals, any other function can call it to print
Roman numerals.  This contrasts sharply with PDP-10 system programs,
in which Roman numerals have been independently reimplemented several
times (and the ITS filename parser several dozen times).
</p>
<p>For example, the routines to manipulate a robot arm might be a
separate program, residing in a package named <code>arm</code>.  If we
have a second program called <code>blocks</code> (the blocks world, of course)
which wanted to manipulate the arm, it would want to call functions
which are defined on the <code>arm</code> obarray, and therefore not in <code>blocks</code>&rsquo;s
own name space.  Without special provision, there would be no way for
any symbols not in the <code>blocks</code> name space to be part of any <code>blocks</code>
functions.
</p>
<p>The colon character (&quot;<code>:</code>&quot;) has a special meaning to the Lisp
reader.  When the reader sees a colon preceded by the name of a package,
it will read in the next Lisp object with <code>package</code> bound to that package.
The way <code>blocks</code> would
call a function named <code>go-up</code> defined in <code>arm</code> would be by asking to call
<code>arm:go-up</code>, because <code>go-up</code> would be interned on the <code>arm</code> package.
What <code>arm:go-up</code> means precisely is &quot;the symbol named <code>go-up</code> in
the name space of the package <code>arm</code>.&quot;
</p>
<p>Similarly, if the <code>chaos</code> program wanted to refer to the <code>arpa</code>
program&rsquo;s <code>allocate-pbuf</code> function (for some reason), it would simply
call <code>arpa:allocate-pbuf</code>.
</p>
<p>An important question that should occur at this point is how
the names of packages are associated with their obarrays and other
data.  This is done by means of the &quot;refname-alist&quot; that each package
has.  This alist associates strings called <em>reference names</em> or <em>refnames</em>
with the packages they
name.  Normally, a package&rsquo;s refname-alist contains an entry for each
subpackage, associating the subpackage with its name.  In addition,
every package has its own name defined as a refname, referring to
itself.  However, the user can add any other refnames, associating
them with any packages he likes.  This is useful when multiple versions
of a program are loaded into different packages.  Of course, each
package inherits its superpackage&rsquo;s refnames just as it does symbols.
</p>
<p>In our example, since <code>arm</code> is a subpackage of <code>global</code>, the name
<code>arm</code> is on <code>global</code>&rsquo;s refname-alist, associated with the <code>arm</code> package.
Since <code>blocks</code> is also a subpackage of <code>global</code>, when <code>arm:go-up</code> is seen
the string &quot;<code>arm</code>&quot; is found on <code>global</code>&rsquo;s refname alist.
</p>
<p>When you want to refer to a symbol in a package which you and
your superpackages have no refnames for&ndash;say, a subpackage named <code>foo</code>
of a package named <code>bar</code> that is under <code>global</code>&ndash;you can use
multiple colons.  For example, the symbol <code>finish</code> in that package
<code>foo</code> could be referred to as <code>foo:bar:finish</code>.  What happens here
is that the second name, <code>bar</code>, is interpreted as a refname in the
context of the package <code>foo</code>.  Alternatively, you can give the
<code>foo:bar</code> package a refname directly under <code>global</code>, even though
<code>global</code> is not its superior as a package.  This is usually done by
using <code>myrefname</code> in the package declaration (<a href="#myrefname">myrefname</a>).
</p>
<a name="g_t_0022Declaring-Packages_0022"></a>
<h3 class="section">24.3 &quot;Declaring Packages&quot;</h3>
<a name="declaring_002dpackages"></a><a name="index-declaring-packages"></a>
<a name="index-package-declarations"></a>

<p>Before any package can be referred to or loaded, it must be declared.
This is done with the special form <code>package-declare</code>, which tells the package system
all sorts of things, including the name of the package, the place in the
package hierarchy for the new package to go, its estimated size,
and some of the symbols which belong in it.
</p>
<p>Here is a sample declaration:
</p><div class="lisp">
<pre class="lisp">(package-declare foo global 1000
       ()
       (shadow array-push adjust-array-size))
</pre></div>

<p>What this declaration says is that a package named <code>foo</code> should be
created as an inferior of <code>global</code>, the package which contains advertised
global symbols.  Its obarray should initially be large enough to hold 1000
symbols, though it will grow automatically if that isn&rsquo;t enough.
Unless there is a specific reason to do otherwise, you should make all
of your packages direct inferiors of <code>global</code>.  The size you give is
increased slightly to be a good value for the hashing algorithm used.
</p>
<p>After the size comes the &quot;file-alist&quot;, which is given as <code>()</code>
in the example.  This is an obsolete feature, which is not normally used.
The &quot;system&quot;-defining facilities should be used instead.  See <a href="#system_002dsystem">system-system</a>.
</p>
<p>Finally, the <code>foo</code> package &quot;shadows&quot; <code>array-push</code> and <code>adjust-array-size</code>.
What shadowing means is that the <code>foo</code> package
should have its own versions of those symbols, rather than inheriting
its superpackage&rsquo;s versions.  Symbols by these names will be added to the <code>foo</code>
package even though there are symbols on <code>global</code> already with those names.
This allows the <code>foo</code> package to redefine
those functions for itself without redefining them in the <code>global</code>
package for everyone else.
</p>
<p>Certain other things may be found in the declarations of various internal system
packages.  They are arcane and needed only to compensate for the fact
that parts of those packages are actually loaded before the package
system is.  They should not be needed by any user package.
</p>
<p>Your package declarations should go into separate files containing
only package declarations.  Group them however you like, one to a file
or all in one file.  Such files can be read with <code>load</code>.  It doesn&rsquo;t
matter what package you load them into, so use <code>user</code>, since that has to
be safe.
</p>
<p>If the declaration for a package is read in twice, no harm is done.
If you edit the size to replace it with a larger one, the package will
be expanded.  At the moment, however, there is no way to change the list of
shadowings;  such changes will be ignored.  Also, you can&rsquo;t
change the superpackage.  If you edit the superpackage name and read the
declaration in again, you will create a new, distinct package without
changing the old one.
</p>
<a name="package_002ddeclare_002dfun"></a><dl>
<dt><a name="index-package_002ddeclare"></a>Macro: <strong>package-declare</strong></dt>
<dd><p>The <code>package-declare</code> macro is used to declare a package to the package
system.  Its form is:
</p><div class="lisp">
<pre class="lisp">(package-declare <em>name</em> <em>superpackage</em> <em>size</em>
		 <em>file-alist</em> <em>option-1</em> <em>option-2</em> ...)
</pre></div>
<p>The interpretation of the declaration is complicated; see <a href="#declaring_002dpackages">declaring-packages</a>.
</p></dd></dl>

<a name="describe_002dpackage_002dfun"></a><dl>
<dt><a name="index-describe_002dpackage"></a>Function: <strong>describe-package</strong> <em>package-name</em></dt>
<dd><p><code>(describe-package <em>package-name</em>)</code> is equivalent to
<code>(describe (pkg-find-package <em>package-name</em>))</code>;
that is, it describes the package whose name is <em>package-name</em>.
</p></dd></dl>

<a name="g_t_0022Packages-and-Writing-Code_0022"></a>
<h3 class="section">24.4 &quot;Packages and Writing Code&quot;</h3>

<p>The unsophisticated user need never be aware of the existence of
packages when writing his programs.  He should just load all of his
programs into the package <code>user</code>, which is also what console type-in is
interned in.  Since all the functions that users are likely to need are
provided in the <code>global</code> package, which is <code>user</code>&rsquo;s superpackage, they are
all available.  In this manual, functions that are not on the <code>global</code>
package are documented with colons in their names, so typing the name
the way it is documented will work.
</p>
<p>However, if you are writing a generally useful tool, you should
put it in some package other than <code>user</code>, so that its internal
functions will not conflict with names other users use.  If you are
loading your programs into packages other than <code>user</code>, there are
special constructs that you will need to know about.
</p>
<p>One time that you as the programmer must be aware of the existence of
packages is when you want to use a function or variable in another
package.  To do this, write the name of the package, a colon, and then
the name of the symbol, as in <code>fs:directory-list</code>.  You will
notice that symbols in other packages print out that way, too.
Sometimes you may need to refer to a symbol in a package whose superior
is not <code>global</code>.  When this happens, use multiple colons, as in
<code>foo:bar:ugh</code>, to refer to the symbol <code>ugh</code> in the package named <code>bar</code> which
is under the package named <code>foo</code>.
</p>
<p>Another time that packages intrude is when you use a &quot;keyword&quot;,
for instance, when you check for <code>eq</code>ness against a constant symbol,
or pass a constant symbol to someone else who will check for it using
<code>eq</code>.  This includes using the symbol as either argument to <code>get</code>.
In such cases, the usual convention is that the symbol should reside in
the <code>user</code> package, rather than in the package with which its meaning
is associated.  To make it easy to specify <code>user</code>, a colon before a
symbol, as in <code>:select</code>, is equivalent to specifying <code>user</code> by name,
as in <code>user:select</code>.  Since the <code>user</code> package has no subpackages,
putting symbols into it will not cause name conflicts.
</p>
<p>Why is this convention used?  Well, consider the function
<code>make-array</code>, which takes one required argument followed by
any number of keyword arguments.
For example,
</p><div class="lisp">
<pre class="lisp">(make-array 100 'leader-length 10 'type art-string)
</pre></div>
<p>specifies, after the first required argument, two options with
names <code>leader-length</code> and <code>type</code> and values <code>10</code> and <code>art-string</code>.
The file containing this
function&rsquo;s definition is in the <code>system-internals</code> package, but the
function is available to everyone without the use of a colon prefix
because the symbol <code>make-array</code> is itself inherited from <code>global</code>.
But all the keyword names, such as <code>type</code>, are short and should not have
to exist in <code>global</code>.  However, it would be a shame if all callers of
<code>make-array</code> had to specify <code>system-internals</code>: before the name of
each keyword.  After all, those callers can include programs loaded into
<code>user</code>, which should by rights not have to know about packages at all.
Putting those keywords in the <code>user</code> package solves this problem.
The correct way to type the above form would be
</p><div class="lisp">
<pre class="lisp">(make-array 100 ':leader-length 10 ':type art-string)
</pre></div>

<p>Exactly when should a symbol go in <code>user</code>?  Most symbols known
specially by system functions are in user.  Symbols used as keywords for
arguments by any function should usually be in <code>user</code>, to keep things
consistent.  However, when a program uses a specific property name to
associate its own internal memoranda with symbols passed in from
outside, the property name should belong to the program&rsquo;s package, so
that two programs using the same property name in that way don&rsquo;t
conflict.
</p>
<a name="g_t_0022Shadowing_0022"></a>
<h3 class="section">24.5 &quot;Shadowing&quot;</h3>

<p>Suppose the user doesn&rsquo;t like the system <code>nth</code> function; he
might be a former Interlisp user and expect a completely different
meaning from it.  Were he to say <code>(defun nth ---)</code> in his program
(call it <code>snail</code>) he would clobber the <code>global</code> symbol named
&quot;<code>nth</code>&quot; and affect the &quot;<code>nth</code>&quot; in everyone else&rsquo;s name space.
(Actually, since he would be redefining this function in a different
file from the original definition, he would get a warning and a query.)
</p>
<p>In order to allow the <code>snail</code> package to have its own <code>(defun nth
---)</code> without interfering with the rest of the Lisp environment, it
must &quot;shadow&quot; out the global symbol &quot;<code>nth</code>&quot; by putting a new symbol
named &quot;<code>nth</code>&quot; on its own obarray.  Normally, this is done by writing
<code>(shadow nth)</code> in the declaration of the <code>snail</code> package.  Since
<code>intern</code> looks on the subpackage&rsquo;s obarray before <code>global</code>, it will find
the programmer&rsquo;s own <code>nth</code> and never the global one.  Since the global
one is now impossible to see, we say it has been &quot;shadowed.&quot;
</p>
<p>Having shadowed <code>nth</code>, we may sometimes need to refer to the
global definition.  This can be done by writing <code>global:nth</code>.  This works
because the refname <code>global</code> is defined in the <code>global</code> package as a name
for the <code>global</code> package.  Since <code>global</code> is the superpackage of the
<code>snail</code> package, all refnames defined by <code>global</code>, including <code>&quot;global&quot;</code>,
are available in <code>snail</code>.
</p>
<a name="g_t_0022Packages-and-Interning_0022"></a>
<h3 class="section">24.6 &quot;Packages and Interning&quot;</h3>

<p>The function <code>intern</code> allows you to specify a package as the second
argument.  It can be specified by giving either the package object
itself or a string or symbol that is the name of the
package.  <code>intern</code> returns three values.  The first is the interned symbol.  The
second is <code>t</code> if the symbol is old (was already present, not just added to
the obarray).  The third is the package in which the symbol was actually
found.  This can be either the specified package or one of its
superiors.
</p>
<p>When you don&rsquo;t specify the second argument to <code>intern</code>, the
current package, which is the value of the symbol <code>package</code>, is used.
This happens, in particular, when you call <code>read</code>.  To specify the
package for such functions to use, bind the symbol <code>package</code>
temporarily to the desired package with <code>let</code>.  The function
<code>pkg-find-package</code> may be used to obtain the package with a given
name.  While most functions that use packages will do this themselves,
it is better to do it only once when <code>package</code> is bound.  The function
<code>pkg-goto</code> sets <code>package</code> to a package specified by a string.  This
is unclean if done in a program, but is useful for &quot;putting the
keyboard inside&quot; a package when you are debugging.
</p>
<a name="package_002dvar"></a><dl>
<dt><a name="index-package-1"></a>Variable: <strong>package</strong></dt>
<dd><p>The value of <code>package</code> is the current package.  Many functions such as
<code>read</code> always operate on this package, and other functions such as
<code>intern</code> which accept a package as an optional argument default to
this one.
</p></dd></dl>

<a name="pkg_002dgoto_002dfun"></a><dl>
<dt><a name="index-pkg_002dgoto"></a>Function: <strong>pkg-goto</strong> <em>&amp;optional pkg</em></dt>
<dd><p><em>pkg</em> may be a package or the name of a package.
<em>pkg</em> is made the current package.  It defaults to the <code>user</code> package.
</p></dd></dl>

<a name="pkg_002dbind_002dfun"></a><dl>
<dt><a name="index-pkg_002dbind"></a>Macro: <strong>pkg-bind</strong> <em>pkg body...</em></dt>
<dd><p><em>pkg</em> may be a package or a package name.  The forms of the <em>body</em>
are evaluated sequentially with the variable <code>package</code> bound to the
package named by <em>pkg</em>.
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(pkg-bind &quot;zwei&quot;
	  (read-from-string function-name))
</pre></div>
</dd></dl>

<p>There are actually four forms of the <code>intern</code> function:  regular <code>intern</code>,
<code>intern-soft</code>, <code>intern-local</code>, and <code>intern-local-soft</code>.  <code>-soft</code> means that the
symbol should not be added to the package if there isn&rsquo;t already one;
in that case, all three values are <code>nil</code>.  <code>-local</code> means that the
superpackages should not be searched.  Thus, <code>intern-local</code> can be used to
cause shadowing.  <code>intern-local-soft</code> is right when
you want complete control over what packages to search and when to add symbols.
All four forms of <code>intern</code> return the same three values, except that
the <code>soft</code> forms return <code>nil nil nil</code> when
the symbol isn&rsquo;t found.
</p>
<a name="intern_002dfun"></a><dl>
<dt><a name="index-intern"></a>Function: <strong>intern</strong> <em>string &amp;optional (pkg <code>package</code>)</em></dt>
<dd><p><code>intern</code> searches <em>pkg</em> and its superpackages sequentially, looking
for a symbol whose print-name is equal to <em>string</em>.  If it finds
such a symbol, it returns three values: the symbol, <code>t</code>, and the package
on which the symbol is interned.  If it does not find one, it
creates a new symbol with a print name of <em>string</em>, interns it into the
package <em>pkg</em>,
and returns the new symbol, <code>nil</code>, and <em>pkg</em>.
</p>
<p>If <em>string</em> is not a string but a symbol, <code>intern</code> searches for a symbol
with the same print-name.  If it doesn&rsquo;t find one, it interns
<em>string</em>&ndash;rather than a newly-created symbol&ndash;in <em>pkg</em>
(even if it is also interned in some other package) and returns it.
</p>
<p>Note: <code>intern</code> is sensitive to case; that is, it will consider two
character strings different even if the only difference is one of
upper-case versus lower-case (unlike most string comparisons elsewhere
in the Lisp Machine system).  The reason that symbols get converted
to upper-case when you type them in is that the reader converts
the case of characters in symbols; the characters are converted to
upper-case before <code>intern</code> is ever called.  So if you call <code>intern</code>
with a lower-case <code>&quot;foo&quot;</code> and then with an upper-case <code>&quot;FOO&quot;</code>, you
won&rsquo;t get the same symbol.
</p></dd></dl>

<a name="intern_002dlocal_002dfun"></a><dl>
<dt><a name="index-intern_002dlocal"></a>Function: <strong>intern-local</strong> <em>string &amp;optional (pkg <code>package</code>)</em></dt>
<dd><p><code>intern</code> searches <em>pkg</em> (but <em>not</em> its superpackages), looking
for a symbol whose print-name is equal to <em>string</em>.  If it finds
such a symbol, it returns three values: the symbol, <code>t</code>, and <em>pkg</em>
If it does not find one, it
creates a new symbol with a print name of <em>string</em>, and
returns the new symbol, <code>nil</code>, and <em>pkg</em>.
</p>
<p>If <em>string</em> is not a string but a symbol, and no symbol with that print-name
is already interned in <em>pkg</em>, <code>intern-local</code> interns
<em>string</em>&ndash;rather than a newly-created symbol&ndash;in <em>pkg</em>
(even if it is also interned in some other package) and returns it.
</p></dd></dl>

<a name="intern_002dsoft_002dfun"></a><dl>
<dt><a name="index-intern_002dsoft"></a>Function: <strong>intern-soft</strong> <em>string &amp;optional (pkg <code>package</code>)</em></dt>
<dd><p><code>intern</code> searches <em>pkg</em> and its superpackages sequentially, looking
for a symbol whose print-name is equal to <em>string</em>.  If it finds
such a symbol, it returns three values: the symbol, <code>t</code>, and the package
on which the symbol is interned.  If it does not find one, it returns
<code>nil</code>, <code>nil</code>, and <code>nil</code>.
</p></dd></dl>

<a name="intern_002dlocal_002dsoft_002dfun"></a><dl>
<dt><a name="index-intern_002dlocal_002dsoft"></a>Function: <strong>intern-local-soft</strong> <em>string &amp;optional (pkg <code>package</code>)</em></dt>
<dd><p><code>intern</code> searches <em>pkg</em> (but <em>not</em> its superpackages), looking
for a symbol whose print-name is equal to <em>string</em>.  If it finds
such a symbol, it returns three values: the symbol, <code>t</code>, and <em>pkg</em>
If it does not find one, it returns <code>nil</code>, <code>nil</code>, and <code>nil</code>.
</p></dd></dl>

<a name="symbol_002dpackage_002dcell_002ddiscussion"></a><p>Each symbol remembers which package it belongs to.  While you can
intern a symbol in any number of packages, the symbol will only remember
one:  normally, the first one it was interned in, unless you clobber it.
This package is available as <code>(symbol-package <em>symbol</em>)</code>.
If the value is <code>nil</code>, the symbol believes that it is uninterned.
</p>
<p>The printer also implicitly uses the value of <code>package</code> when
printing symbols.  If slashification is on, the printer tries to print
something such that if it were given back to the reader, the same object would be produced.
If a symbol that is not in the current name space were just printed as
its print name and read back in, the reader would intern it on the wrong
package, and return the wrong symbol.  So the printer figures out the right
colon prefix so that if the symbol&rsquo;s printed representation were read back
in to the same package, it would be interned correctly.  The prefix is
only printed if slashification is on, i.e <code>prin1</code> prints it
and <code>princ</code> does not.
</p>
<a name="remob_002dfun"></a><dl>
<dt><a name="index-remob"></a>Function: <strong>remob</strong> <em>symbol &amp;optional package</em></dt>
<dd><p><code>remob</code> removes <em>symbol</em> from <em>package</em> (the name means &quot;REMove from OBarray&quot;).
<em>symbol</em> itself is unaffected, but <code>intern</code> will no longer find
it on <em>package</em>.  <code>remob</code> is always &quot;local&quot;, in that it removes only from the specified
package and not from any superpackages.  It returns <code>t</code> if the symbol was
found to be removed. <em>package</em> defaults to the contents of the symbol&rsquo;s
package cell, the package it is actually in.  (Sometimes a symbol
can be in other packages also, but this is unusual.)
</p></dd></dl>

<a name="symbol_002dpackage_002dfun"></a><dl>
<dt><a name="index-symbol_002dpackage"></a>Function: <strong>symbol-package</strong> <em>symbol</em></dt>
<dd><p>Returns the contents of <em>symbol</em>&rsquo;s package cell, which is the
package which owns <em>symbol</em>, or <code>nil</code> if <em>symbol</em> is uninterned.
</p></dd></dl>

<a name="package_002dcell_002dlocation_002dfun"></a><dl>
<dt><a name="index-package_002dcell_002dlocation"></a>Function: <strong>package-cell-location</strong> <em>symbol</em></dt>
<dd><p>Returns a locative pointer to <em>symbol</em>&rsquo;s package cell.  It is preferable to write
</p><div class="lisp">
<pre class="lisp">(locf (symbol-package <em>symbol</em>))
</pre></div>
<p>rather than calling this function explicitly.
</p></dd></dl>

<a name="mapatoms_002dfun"></a><dl>
<dt><a name="index-mapatoms"></a>Function: <strong>mapatoms</strong> <em>function &amp;optional (package <code>package</code>) (superiors-p <code>t</code>)</em></dt>
<dd><p><em>function</em> should be a function of one argument.  <code>mapatoms</code> applies
<em>function</em> to all of the symbols in <em>package</em>.  If <em>superiors-p</em> is
<code>t</code>, then the function is also applied to all symbols in <em>package</em>&rsquo;s
superpackages.  Note that the function will be applied to shadowed symbols
in the superpackages, even though they are not in <em>package</em>&rsquo;s name space.
If that is a problem, <em>function</em> can try applying <code>intern</code>
in <em>package</em> on each symbol it gets, and ignore it if it is not <code>eq</code>
to the result of <code>intern</code>; this measure is rarely needed.
</p></dd></dl>

<a name="mapatoms_002dall_002dfun"></a><dl>
<dt><a name="index-mapatoms_002dall"></a>Function: <strong>mapatoms-all</strong> <em>function &amp;optional (package &quot;<code>global</code>&quot;)</em></dt>
<dd><p><em>function</em> should be a function of one argument.
<code>mapatoms-all</code> applies <em>function</em> to all of the symbols
in <em>package</em> and all of <em>package</em>&rsquo;s subpackages.  Since
<em>package</em> defaults to the <code>global</code> package, this
normally gets at all of the symbols in all packages.
It is used by such functions as <code>apropos</code> and <code>who-calls</code> (see <a href="#apropos_002dfun">apropos-fun</a>)
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(mapatoms-all
  (function
    (lambda (x)
      (and (alphalessp 'z x)
           (print x)))))
</pre></div>
</dd></dl>

<a name="pkg_002dcreate_002dpackage_002dfun"></a><dl>
<dt><a name="index-pkg_002dcreate_002dpackage"></a>Function: <strong>pkg-create-package</strong> <em>name &amp;optional (super <code>package</code>) (size <code>200</code>)</em></dt>
<dd><p><code>pkg-create-package</code> creates and returns a new package.  Usually packages are created
by <code>package-declare</code>, but sometimes it is useful to create
a package just to use as a hash table for symbols, or for some other
reason.
</p>
<p>If <em>name</em> is a list, its first element is taken as the package name
and the second as the program name; otherwise, <em>name</em> is taken as both.
In either case, the package name and program name are coerced to strings.
<em>super</em> is the superpackage for this package; it may be <code>nil</code>,
which is useful if you want the package only as a hash table, and don&rsquo;t
want it to interact with the rest of the package system.  <em>size</em> is
the size of the package; as in <code>package-declare</code> it is rounded up
to a &quot;good&quot; size for the hashing algorithm used.
</p></dd></dl>

<a name="pkg_002dkill_002dfun"></a><dl>
<dt><a name="index-pkg_002dkill"></a>Function: <strong>pkg-kill</strong> <em>pkg</em></dt>
<dd><p><em>pkg</em> may be either a package or the name of a package.  The package
should have a superpackage and no subpackages.  <code>pkg-kill</code> takes
the package off its superior&rsquo;s subpackage list and refname alist.
</p></dd></dl>

<a name="pkg_002dfind_002dpackage_002dfun"></a><dl>
<dt><a name="index-pkg_002dfind_002dpackage"></a>Function: <strong>pkg-find-package</strong> <em>x &amp;optional (create-p <code>nil</code>) (under &quot;<code>global</code>&quot;)</em></dt>
<dd><p><code>pkg-find-package</code> tries to interpret <em>x</em> as a package.
Most of the functions whose descriptions say &quot;... may be either
a package or the name of a package&quot; call <code>pkg-find-package</code> to interpret
their package argument.
</p>
<p>If <em>x</em> is a package, <code>pkg-find-package</code> returns it.  Otherwise it
should be a symbol or string, which is taken to be the name of a package.
The name is looked up on the refname alists of <code>package</code> and its
superpackages, the same as if it had been typed as part of a colon prefix.
If this finds the package, it is returned.  Otherwise, <em>create-p</em>
controls what happens.  If <em>create-p</em> is <code>nil</code>, an error is signalled.
If <em>create-p</em> is <code>:find</code>, <code>nil</code> is returned.  If <em>create-p</em> is
<code>:ask</code> the user is asked whether to create it.  Otherwise, a new package
is created, and installed as an inferior of <em>under</em>.
</p></dd></dl>

<p>A package is implemented as a structure, created by <code>defstruct</code>.
The following accessor defsubsts are available on the <code>global</code> package:
</p><dl compact="compact">
<dt><code>pkg-name</code></dt>
<dd><p>The name of the package, as a string.
</p></dd>
<dt><code>pkg-refname-alist</code></dt>
<dd><p>The refname alist of the package, associating strings with packages.
</p></dd>
<dt><code>pkg-super-package</code></dt>
<dd><p>The superpackage of the package.
</p></dd>
</dl>

<a name="g_t_0022Status-Information_0022"></a>
<h3 class="section">24.7 &quot;Status Information&quot;</h3>

<p>The current package&ndash;where your type-in is being interned&ndash;is
always the value of the symbol <code>package</code>.  A package is a named
structure that prints out nicely, so examining the value of
<code>package</code> is the best way to find out what the current package is.
(It is also displayed in the who-line.)
Normally, it should be <code>user</code>, except when inside
compilation or loading of a file belonging to some other package.
</p>
<p>To get more information on the current package or any other, use the
function <code>describe-package</code>.  Specify either a package object or a string
that is a refname for the desired package as the argument.  This will
print out everything except a list of all the symbols in the package.
If you want <em>that</em>, use <code>(mapatoms 'print <em>package</em> nil)</code>.
<code>describe</code> of a package will call <code>describe-package</code>.
</p>
<a name="g_t_0022Packages_002c-Loading_002c-and-Compilation_0022"></a>
<h3 class="section">24.8 &quot;Packages, Loading, and Compilation&quot;</h3>

<p>It&rsquo;s obvious that every file has to be loaded into the right package
to serve its purpose.  It may not be so obvious that every file must be
compiled in the right package, but it&rsquo;s just as true.  Luckily, this
usually happens automatically.
</p>
<p>The system can get the package of a source file from its &quot;file
attribute list&quot; (see <a href="#file_002dattribute_002dlist">file-attribute-list</a>).
For instance, you can put at the front of your file
a line such as
</p><div class="lisp">
<pre class="lisp">; -*- Mode:Lisp; Package:System-Internals -*-
</pre></div>
<p>The compiler puts the package name into the QFASL file for use when it
is loaded.  If a file doesn&rsquo;t have such a package specification in it,
the system loads it into the current package and tells you what it did.
</p>
<a name="g_t_0022Subpackages_0022"></a>
<h3 class="section">24.9 &quot;Subpackages&quot;</h3>

<p>Usually, each independent program occupies one package, which is
directly under <code>global</code> in the hierarchy.  But large programs, such as
Macsyma, are usually made up of a number of sub-programs, which are
maintained by a small number of people.  We would like each
sub-program to have its own name space, since the program as a whole
has too many names for anyone to remember.  So we can make each
sub-program into its own package.  However, this practice requires
special care.
</p>
<p>It is likely that there will be a fair number of functions and
symbols that should be shared by all of the sub-programs of Macsyma.
These symbols should reside in a package named <code>macsyma</code>, which would be
directly under <code>global</code>.
Then each part of <code>macsyma</code> (for instance, <code>sin</code>,
<code>risch</code>, <code>input</code>, and so on) would have its own package, with the <code>macsyma</code>
package as its superpackage.  To do this, first declare the <code>macsyma</code>
package, and then declare the <code>risch</code>, <code>sin</code>, etc. packages, specifying
<code>macsyma</code> as the superpackage for each of them.  This way, each
sub-program gets its own name space.  All of these declarations would probably
be together in a file called something like <code>MACPKG</code>.
</p>
<p>However, to avoid a subtle pitfall, it is
necessary that the <code>macsyma</code> package itself contain no
files, only a set of symbols specified at declaration time.  This
list of symbols is specified using <code>shadow</code> in the declaration of the
<code>macsyma</code> package.  The symbols residing in the <code>macsyma</code> package can
have values and definitions, but these must all be supplied by files
in <code>macsyma</code>&rsquo;s subpackages.  Note that this is exactly the same treatment that <code>global</code>
receives:  all its functions are actually defined in files that are
loaded into <code>system-internals (si), compiler</code>, etc.
</p>
<p>To demonstrate the full power and convenience of
this scheme, suppose there were a second huge program called <code>owl</code> that
also had a subprogram called <code>input</code> (which, presumably, does all of the
<code>input</code>ting for <code>owl</code>), and one called <code>database</code>.  Then a picture of the
hierarchy of packages would look like this:
</p><div class="lisp">
<pre class="lisp">			global
			   |
		/--------------------------------\
		|                                |
	     macsyma		                owl
		|                                |
 -----------------------------           -----------------------
  | | |      |       |       |           |         |       | | |
(others)   risch    sin    input       input   database   (others)
</pre></div>

<p>Now, the <code>risch</code> program and the <code>sin</code> program both do integration, and
so it would be natural for each to have a function called <code>integrate</code>.
From inside <code>sin</code>, <code>sin's</code> <code>integrate</code> would be referred to as &quot;<code>integrate</code>&quot;
(no prefix needed), while <code>risch's</code> would be referred to as
&quot;<code>risch:integrate</code>&quot;.  Similarly, from inside <code>risch</code>, <code>risch's</code> own
<code>integrate</code> would be called &quot;<code>integrate</code>&quot;, whereas <code>sin's</code> would be referred
to as &quot;<code>sin:integrate</code>&quot;.
</p>
<p>If <code>sin</code>&rsquo;s <code>integrate</code> were a recursive function, the implementor would
be referring to it from within <code>sin</code> itself, and would be happy that he
need not type out &quot;<code>sin:integrate</code>&quot; every time; he could just say
&quot;<code>integrate</code>&quot;.
</p>
<p>From inside the <code>macsyma</code> package or any of its other sub-packages,
the two functions would be referred to as &quot;<code>sin:integrate</code>&quot; and as
&quot;<code>risch:integrate</code>&quot;.  From
anywere else in the hierarchy, they would have to be called
&quot;<code>macsyma:sin:integrate</code>&quot; and &quot;<code>macsyma:risch:integrate</code>&quot;.
</p>
<p>Similarly, assume that each of the <code>input</code> packages has a function
called <code>get-line</code>.  From inside <code>macsyma</code> or any of <code>macsyma's</code> subprograms
(other than <code>input</code>), the relevant function would be called
<code>input:get-line</code> and the irrelevant one <code>owl:input:get-line</code>.  The
converse is true for <code>owl</code> and its sub-programs.  Note that there is no
problem arising from the fact that both <code>owl</code> and <code>macsyma</code> have
subprograms of the same name (<code>input</code>).
</p>
<p>You might also want to put Macsyma&rsquo;s <code>get-line</code> function on
the <code>macsyma</code> package.  Then, from anywehere inside Macsyma, the function
would be called <code>get-line</code>; from the <code>owl</code> package and subpackages
it could be referred to as <code>macsyma:get-line</code>.
<a name="myrefname"></a></p>
<p>You can give a second-level subpackage a globally available name
of its own by using <code>myrefname</code> in the package declaration.  For
example,
</p><div class="lisp">
<pre class="lisp">(myrefname global macinput)
</pre></div>
<p>in the declaration of the <code>macsyma:input</code> package would give it the
additional refname <code>macinput</code> that can be used from any package under
<code>global</code>.
</p>
<a name="g_t_0022Initialization-of-the-Package-System_0022"></a>
<h3 class="section">24.10 &quot;Initialization of the Package System&quot;</h3>

<p>This section describes how the package system is initialized
when generating a new software release of the Lisp Machine system;
none of this should affect users.
</p>
<p>When the world begins to be loaded, there is no package system.
There is one &quot;obarray&quot;, whose format is different from that used by the
package system.  When the package system is loaded and initialized, it
is necessary to split the symbols of the old-style obarray up among the
various initial packages.
</p>
<p>The first packages created by initialization are the most important
ones:  <code>global</code>, <code>system</code>, <code>user</code>, and <code>system-internals</code>.  All
of the symbols already present are placed in one of those packages.  By
default, a symbol goes into <code>system-internals</code>.  Only those placed on
special lists go into one of the others.  These lists are the file
<code>SYS: SYS2; GLOBAL LISP</code> of symbols which belong in <code>global</code>, and
the file <code>SYS: SYS2; SYSTEM LISP</code> of symbols which go in <code>system</code>.
</p>
<p>After the four basic packages exist, the package system&rsquo;s
definition of <code>intern</code> is installed, and packages exist.  Then, the
other system packages <code>format</code>, <code>compiler</code>, <code>zwei</code>, etc. are
declared in almost the normal manner.  The exception is that a few of
the symbols present before packages exist really belong in one of these
packages.  Their package declarations contain calls to <code>forward</code> and
<code>borrow</code>, which exist only for this purpose and are meaningful only in
package declarations, and are used to move the symbols as appropriate.
These declarations are kept in the file <code>SYS: SYS; PKGDCL LISP</code>.
</p>
<a name="globalize_002dfun"></a><dl>
<dt><a name="index-globalize"></a>Function: <strong>globalize</strong> <em>symbol &amp;optional (package <code>&quot;global&quot;</code>)</em></dt>
<dd><p>Sometimes it will be discovered that a symbol which ought to be
in <code>global</code> is not there, and the file defining it has already been
loaded, thus mistakenly creating a symbol with that name in some other
package.  Creating a symbol in <code>global</code> will not fix the problem,
since the existing symbol will shadow it.  Worse, functions in other
packages which should have used the global symbol may have shadowed it
in their own packages.
</p>
<p>When this happens, you can
correct the situation by doing <code>(globalize &quot;<em>symbol-name</em>&quot;)</code>.  This
function creates a symbol with the desired name in <code>global</code>, merges
whatever value, function definition, and properties can be found on
symbols of that name together into the new symbol (complaining if
there are conflicts), and forwards those slots of the existing symbols
to the slots of the new one using one-q-forward pointers, so that they
will appear to be one and the same symbol as far as value, function
definition, and property list are concerned.  They cannot all be made
<code>eq</code> to each other, but <code>globalize</code> does the next-best thing:  it takes
an existing symbol from <code>user</code>, if there is one, to put it in <code>global</code>.
Since people who check for <code>eq</code> are normally supposed to specify <code>user</code>
anyway, they will not perceive any effect from moving the symbol from
<code>user</code> into <code>global</code>.
</p>
<p>If <code>globalize</code> is given a symbol instead of a string as
argument, the exact symbol specified is put into <code>global</code>.  You can
use this when a symbol in another package, which should have been
inherited from <code>global</code>, is being checked for with <code>eq</code>&ndash;as long as
there are not <em>two</em> different packages doing so.  Usually, the symbol
is just a function name or a variable, and this problem does not arise.
</p>
<p>If the argument <em>package</em> is specified, then the symbol is
moved into that package from all its subpackages, rather than into
<code>global</code>.
</p></dd></dl>

<a name="g_t_0022Initial-Packages_0022"></a>
<h3 class="section">24.11 &quot;Initial Packages&quot;</h3>

<p>The initially present packages include:
</p>
<dl compact="compact">
<dt><code>global</code></dt>
<dd><p>Contains advertised global functions.
</p></dd>
<dt><code>user</code></dt>
<dd><p>Used for interning the user&rsquo;s type-in.  Contains all keyword symbols.
</p></dd>
<dt><code>sys <span class="roman">or</span> system</code></dt>
<dd><p>Contains internal global symbols used by various system programs.
<code>global</code> is for symbols global to the Lisp language, while <code>system</code>
is for symbols global to the Lisp Machine operating system.
</p></dd>
<dt><code>si <span class="roman">or</span> system-internals</code></dt>
<dd><p>Contains subroutines of many advertised
system functions.  <code>si</code> is a subpackage of <code>sys</code>.
</p></dd>
<dt><code>compiler</code></dt>
<dd><p>Contains the compiler.  <code>compiler</code> is a subpackage
of <code>sys</code>.
</p></dd>
<dt><code>fs <span class="roman">or</span> file-system</code></dt>
<dd><p>Contains the code that deals with pathnames and accessing files.
</p></dd>
<dt><code>eh <span class="roman">or</span> dbg</code></dt>
<dd><p>Contains the error handler and the debugger.
</p></dd>
<dt><code>cc <span class="roman">or</span> cadr</code></dt>
<dd><p>Contains the program that is used for debugging another machine.
</p></dd>
<dt><code>zwei</code></dt>
<dd><p>Contains the editor.
</p></dd>
<dt><code>chaos</code></dt>
<dd><p>Contains the Chaosnet controller.
</p></dd>
<dt><code>tv</code></dt>
<dd><p>Contains the window system.
</p></dd>
<dt><code>format</code></dt>
<dd><p>Contains the function <code>format</code> and its associated subfunctions.
</p></dd>
</dl>

<p>There are quite a few others, but it would be pointless to list them all.
</p>
<p>Packages that are used for special sorts of data:
</p><dl compact="compact">
<dt><code>fonts</code></dt>
<dd><p>Contains the names of all fonts.
</p></dd>
<dt><code>format</code></dt>
<dd><p>Contains the keywords for <code>format</code>, as well as the code.
</p></dd>
</dl>

<p>Here is a picture depicting the initial package hierarchy:
</p><div class="lisp">
<pre class="lisp">                           global
                             |    
       /------------------------------------------\
       |     |          |          |       |      |
     user  zwei      system      format  fonts   (etc)
                        |
                /----------------------------------\
                |          |     |     |    |      |
         system-internals  eh  chaos  cadr  fs  compiler
</pre></div>


<a name="g_t_0022Multiple-Instantiations-of-a-Program_0022"></a>
<h3 class="section">24.12 &quot;Multiple Instantiations of a Program&quot;</h3>

<p>This isn&rsquo;t finished yet, which is why we don&rsquo;t say how to do
any of this.
</p>
<p>Suppose a maintainer of ZWEI (the Lisp Machine editor) has
made some changes to ZWEI, and would like to debug them.  He has a
problem: if he reads in the new version, which presumably may be full
of bugs, then he will not be able to do any editing!  This would be
annoying, since the editor is very useful.
</p>
<p>We would like both the regular and the experimental versions
of the editor to <em>both</em> be loaded into the Lisp world.  In order for two
definitions of each editor function to coexist, we need to load the
new version into a separate package, which must have a different name
(not named &quot;<code>zwei</code>&quot;, like the package the original editor is in).  If
the test version&rsquo;s package is called &quot;<code>test-zwei</code>&quot;, then the user can
try it by calling <code>(test-zwei:ed)</code>, and edit it using <code>(ed)</code>.
</p>
<p>However, there is a problem to be faced.  The editor redefines
a few entry-point functions (<code>ed</code>, <code>edprop</code>, etc) which reside in <code>global</code>.
If the test editor redefined them, the whole point of the separate
package would be lost.  So, the <code>test-zwei</code> package must <code>shadow</code> all these
symbols.
</p>
<p>Further complications are needed to make it possible to test
one program using another instead of by hand.  Suppose that there is a
program named <code>random</code> residing in its own package, and containing a
function named <code>number</code>.  Suppose that we have a debugged program <code>dp</code>
(Dissociated Press) which uses <code>random:number</code>.  And now, we have
written a new version of <code>random</code> and want to test it using <code>dp</code>, without
installing it and breaking system tools which use <code>random</code>.  What we
want to do is to load in a test version of <code>random</code>, <code>test-random</code>, and
also a <code>test-dp</code> which will refer to it, to test it with.
</p>
<p>This can be done if we can make the <code>test-dp</code> package
take references to <code>random</code> as references to the <code>test-random</code>
package.  All this takes is
an entry on <code>test-dp</code>&rsquo;s refname-alist, associating the name &quot;<code>random</code>&quot;
with the <code>test-random</code> package.  Then, when <code>random:number</code> is seen in the
course of reading in the old <code>dp</code> program into <code>test-dp</code>,
<code>test-random:number</code> will actually be used.  Note that normally <code>test-dp</code>
wouldn&rsquo;t have an entry on its own refname-alist for &quot;<code>random</code>&quot;;  it
would inherit the association from <code>global</code>.  We are actually
&quot;shadowing&quot; in <code>test-dp</code> the definition of &quot;<code>random</code>&quot; as a package refname
which is present in <code>global</code>.  Here is what we will get.
</p><div class="lisp">
<pre class="lisp">                            global  [random -&gt; random]
                               |
      /-----------------------------------------------\
      |        |                      |               |
     dp  =&gt;  random                test-dp  =&gt;      test-random
                           [random -&gt; test-random]
</pre></div>
<p>(&quot;=&gt;&quot; indicates who calls whom;  &quot;-&gt;&quot; indicates a refname).
</p>
<p>So far, every package has had its own name as a refname for
itself.  A test package, however, shouldn&rsquo;t have its actual name as a
refname for itself, but the name its program expects:  &quot;<code>random</code>&quot;, not
&quot;<code>test-random</code>&quot;.  This is necessary to handle test packages with
subpackages right, together with shadowing.  In fact every package has
a &quot;program name&quot; as well as a &quot;name&quot;.  For ordinary packages, they are
the same, but for a test package, the program name is identical to
that of the original package.
</p>
<p>Suppose we have the Macsyma program with all of its sub-packages as
described above. Further assume that the <code>input</code> sub-program&rsquo;s author
has his own symbol named <code>simp</code>, and he calls <code>macsyma:simp</code>
in various places to get the
one in the <code>macsyma</code> package.  Now, say someone wants to load an
experimental <code>macsyma</code> into the machine: he would name the new obarray
<code>test-macsyma</code> or something.  In order to assure that the reference to
<code>macsyma:simp</code> is properly resolved, the refname-alist of <code>test-macsyma</code>
must contain <code>test-macsyma</code> under the name <code>macsyma</code>.  This, finally,
is the reason why each package has a reference to itself on its refname-alist.
</p>
<a name="Maintaining-Large-Systems"></a>
<h2 class="chapter">25 Maintaining Large Systems</h2>
<a name="system_002dsystem"></a><a name="index-system"></a>
<a name="system_002dchapter"></a>
<p>When a program gets large, it is often desirable to split it up into
several files.  One reason for this is to help keep the parts of the
program organized, to make things easier to find.  It&rsquo;s also useful to
have the program broken into small pieces that are more convenient to
edit and compile.  It is particularly important to avoid the need to
recompile all of a large program every time any piece of it changes; if
the program is broken up into many files, only the files that have
changes in them need to be recompiled.
</p>
<p>The apparent drawback to splitting up a program is that more commands
are needed to manipulate it.  To load the program, you now have to load
several files separately, instead of just loading one file.  To compile
it, you have to figure out which files need compilation, by seeing
which have been edited since they were last compiled, and then you have
to compile those files.
</p>
<p>What&rsquo;s even more complicated is that files can have interdependencies.
You might have a file called <code>DEFS</code> that contains some macro
definitions (or flavor or structure definitions), and functions in
other files might use those macros.  This means that in order to
compile any of those other files, you must first load the file <code>DEFS</code>
into the Lisp environment so that the macros will be defined and can
be expanded at compile time.  You have to remember this whenever you
compile any of those files.  Furthermore, if <code>DEFS</code> has changed, other
files of the program may need to be recompiled because the macros
may have changed and need to be re-expanded.
</p>
<p>This chapter describes the <em>system</em> facility, which takes care of all
these things for you.  The way it works is that you define a set of
files to be a <em>system</em>, using the <code>defsystem</code> special form,
described below.  This system definition says which files make up the
system, which ones depend on the presence of others, and so on.  You
put this system definition into its own little file, and then all you
have to do is load that file and the Lisp environment will know about
your system and what files are in it.  You can then use the
<code>make-system</code> function (see <a href="#make_002dsystem_002dfun">make-system-fun</a>) to load in all the
files of the system, recompile all the files that need compiling,
and so on.
</p>
<p>The system facility is very general and extensible.  This chapter
explains how to use it and how to extend it.  This chapter also
explains the <em>patch</em> facility, which lets you conveniently update a
large program with incremental changes.
</p>
<a name="Defining-a-System"></a>
<h3 class="section">25.1 Defining a System</h3>

<a name="defsystem_002dfun"></a><dl>
<dt><a name="index-defsystem"></a>Special Form: <strong>defsystem</strong> <em>name (keyword args...)...</em></dt>
<dd><p>Defines a system named <em>name</em>.  The options
selected by the keywords are explained in detail later.  In general,
they fall into two categories: properties of the system and
<em>transformations</em>.  A transformation is an operation such as compiling
or loading that takes one or more files and does something to them.
The simplest system is a set of files and a transformation to be
performed on them.
</p></dd></dl>

<p>Here are a few examples.
</p><div class="lisp">
<pre class="lisp">(defsystem mysys
  (:compile-load (&quot;AI: GEORGE; PROG1&quot; &quot;AI: GEORG2; PROG2&quot;)))

(defsystem zmail
  (:name &quot;ZMail&quot;)
  (:pathname-default &quot;AI: ZMAIL;&quot;)
  (:package zwei)
  (:module defs &quot;DEFS&quot;)
  (:module mult &quot;MULT&quot; :package tv)
  (:module main (&quot;TOP&quot; &quot;COMNDS&quot; &quot;MAIL&quot; &quot;USER&quot; &quot;WINDOW&quot;
		 &quot;FILTER&quot; mult &quot;COMETH&quot;))
  (:compile-load defs)
  (:compile-load main (:fasload defs)))

(defsystem bar
  (:module reader-macros &quot;RDMAC&quot;)
  (:module other-macros &quot;MACROS&quot;)
  (:module main-program &quot;MAIN&quot;)
  (:compile-load reader-macros)
  (:compile-load other-macros (:fasload reader-macros))
  (:compile-load main-program (:fasload reader-macros
					other-macros)))
</pre></div>

<p>The first example defines a new <em>system</em> called <code>mysys</code>, which
consists of two files, both of which are to be compiled and loaded.  The
second example is somewhat more complicated.  What all the options mean
will be specified shortly, but the primary difference is that there is a
file <code>DEFS</code> which must be loaded before the rest of the files
(<code>main</code>) can be compiled.  The final example has two levels of dependency.
<code>reader-macros</code> must be compiled and loaded before <code>other-macros</code> can be
compiled.  Both <code>reader-macros</code> and <code>other-macros</code> must then be loaded before
<code>main-program</code> can be compiled.
</p>
<p>The <code>defsystem</code> options other than transformations are:
</p><dl compact="compact">
<dt><code>:name</code></dt>
<dd><p>Specifies a &quot;pretty&quot; version of the name for the system, for use in printing.
</p>
</dd>
<dt><code>:short-name</code></dt>
<dd><p>Specified an abbreviated name used in constructing disk label comments
and in patch file names for some file systems.
</p>
</dd>
<dt><code>:component-systems</code></dt>
<dd><p>Specifies the names of other systems used to make up this system.
Performing an operation on a system with component systems is equivalent
to performing the same operation on all the individual systems.  The format
is <code>(:component-systems <em>names</em>...)</code>.
</p>
</dd>
<dt><code>:package</code></dt>
<dd><p>Specifies the package in which transformations are performed.  A package
specified here will override one in the <code>-*-</code> line of the file in question.
</p>
</dd>
<dt><code>:pathname-default</code></dt>
<dd><p>Gives a local default within the definition of the system for strings to be
parsed into pathnames.  Typically this specifies the directory, when all the
files of a system are on the same directory.
</p>
</dd>
<dt><code>:warnings-pathname-default</code></dt>
<dd><p>Gives a default for the file to use to store compiler warnings in,
when <code>make-system</code> is used with the <code>:batch</code> option.
</p>
</dd>
<dt><code>:patchable</code></dt>
<dd><p>Makes the system be a patchable system (see <a href="#patch_002dfacility">patch-facility</a>).  An optional
argument specifies the directory to put patch files in.  The default is
the <code>:pathname-default</code> of the system.
</p>
</dd>
<dt><code>:initial-status</code></dt>
<dd><p>Specifies what the status of the system should be when <code>make-system</code> is used
to create a new major version.  The default is <code>:experimental</code>.  See
<a href="#patch_002dsystem_002dstatus">patch-system-status</a> for further details.
</p>
</dd>
<dt><code>:not-in-disk-label</code></dt>
<dd><p>Make a patchable system not appear in the disk label comment.  This
should probably never be specified for a user system.  It is used by
patchable systems internal to the main Lisp system, to avoid cluttering up
the label.
</p>
</dd>
<dt><code>:default-binary-file-type</code></dt>
<dd><p>Specifies the file type to use for compiled Lisp files.  The value you
specify should be a string.  If you do not specify this, the standard file
type <code>&quot;QFASL&quot;</code> is used.
</p>
</dd>
<dt><code>:module</code></dt>
<dd><a name="index-module"></a>
<p>Allows assigning a name to a set of files within the system.  This name
can then be used instead of repeating the filenames.  The format is
<code>(:module <em>name</em> <em>files</em> <em>options</em>...)</code>.  <em>files</em> is usually
a list of filenames (strings).  In general, it is a
<em>module-specification</em>, which can be any of the following:
</p><dl compact="compact">
<dt><span class="roman">a string</span></dt>
<dd><p>This is a file name.
</p>
</dd>
<dt><span class="roman">a symbol</span></dt>
<dd><p>This is a module name.  It stands for all of the files which are in that module
of this system.
</p>
</dd>
<dt><span class="roman">an <em>external module component</em></span></dt>
<dd><p>This is a list of the form <code>(<em>system-name</em> <em>module-names</em>...)</code>,
to specify modules in another system.  It stands for all of the files which
are in all of those modules.
</p>
</dd>
<dt><span class="roman">a list of <em>module components</em></span></dt>
<dd><p>A module component is any of the above, or the following:
</p>
</dd>
<dt><span class="roman">a list of file names</span></dt>
<dd><p>This is used in the case where the names of the input and output files
of a transformation are not related according to the standard naming
conventions, for example when a QFASL file has a different name or
resides on a different directory than the source file.  The file names
in the list are used from left to right, thus the first name is the
source file.  Each file name after the first in the list is defaulted
from the previous one in the list.
</p>
<p>To avoid syntactic ambiguity, this is allowed as a module component but not
as a module specification.
</p></dd>
</dl>

<p>The currently defined options for the <code>:module</code> clause are
</p><dl compact="compact">
<dt><code>:package</code></dt>
<dd><p>Overrides any package specified for the whole system for transformations performed
on just this module.
</p></dd>
</dl>

<p>In the second <code>defsystem</code> example above, there are three modules.  Each of the
first two has only one file, and the third one (<code>main</code>) is made
up both of files and another module.  To take examples of the other
possibilities,
</p><div class="lisp">
<pre class="lisp">(:module prog ((&quot;AI: GEORGE; PROG&quot; &quot;AI: GEORG2; PROG&quot;)))
(:module foo (defs (zmail defs)))
</pre></div>
<p>The <code>prog</code> module consists of one file, but it lives in two
directories, <code>GEORGE</code> and <code>GEORG2</code>.  If this were a Lisp program,
that would mean that the file <code>&quot;AI: GEORGE; PROG &gt;&quot;</code> would be compiled
into <code>&quot;AI: GEORG2; PROG QFASL&quot;</code>.  The <code>foo</code> module consists of two
other modules the <code>defs</code> module in the same system, and the <code>defs</code>
module in the <code>zmail</code> system.  It is not generally useful to
compile files that belong to other systems; thus this <code>foo</code> module
would not normally be the subject of a transformation.
However, <em>dependencies</em> (defined below) use modules and
need to be able to refer to (depend on) modules of other systems.
</p></dd>
</dl>

<a name="si_003aset_002dsystem_002dsource_002dfile_002dfun"></a><dl>
<dt><a name="index-si_003aset_002dsystem_002dsource_002dfile"></a>Function: <strong>si:set-system-source-file</strong> <em>system-name filename</em></dt>
<dd><p>This function specifies which file contains the <code>defsystem</code> for the
system <em>system-name</em>.  <em>filename</em> can be a pathname object or a
string.
</p>
<p>Sometimes it is useful to say where the
definition of a system can be found without taking time to load that
file.  If <code>make-system</code> is ever used on that system, the file whose
name has been specified will be loaded automatically.
</p></dd></dl>

<a name="Transformations"></a>
<h3 class="section">25.2 Transformations</h3>

<a name="index-transformation"></a>
<p>Transformations are of two types, simple and complex.  A simple
transformation is a single operation on a file, such as compiling it or
loading it.  A complex transformation takes the output from one
transformation and performs another transformation on it, such as
loading the results of compilation.
</p>
<p>The general format of a simple transformation is
<code>(<em>name</em> <em>input</em> <em>dependencies</em> <em>condition</em>)</code>.
<em>input</em> is usually a module specification or another transformation whose output is used.
The transformation <em>name</em> is to be performed on all the files in the module, or
all the output files of the other transformation.
</p>
<p><em>dependencies</em> and <em>condition</em> are optional.
</p>
<a name="index-dependency"></a>
<p><em>dependencies</em> is a <em>transformation specification</em>, either a list
<code>(<em>transformation-name</em> <em>module-names</em>...)</code> or a list of such lists.
A <em>module-name</em> is either a symbol that is the name of a module in the current system,
or a list <code>(<em>system-name</em> <em>module-names</em>...)</code>.  A dependency declares that
all of the indicated transformations must be performed on the indicated modules
before the current transformation itself can take place.  Thus in
the zmail example above,  the <code>defs</code> module must have the <code>:fasload</code>
transformation performed on it before the <code>:compile</code> transformation
can be performed on <code>main</code>.
</p>
<p>The dependency has to be a tranformation that is explicitly specified
as a transformation in the system definition, not just an action
that might be performed by anything.  That is, if you have
a dependency <code>(:fasload foo)</code>, it means that <code>(fasload foo)</code> is
a tranformation of your system and you depend on that tranformation;
it does not simply mean that you depend on <code>foo</code>&rsquo;s being loaded.
Furthermore, it doesn&rsquo;t work if <code>(:fasload foo)</code> is an implicit
piece of another tranformation.  For example, the following is
correct and will work:
</p><div class="lisp">
<pre class="lisp">(defsystem foo
  (:module foo &quot;FOO&quot;)
  (:module bar &quot;BAR&quot;)
  (:compile-load (foo bar)))
</pre></div>
<p>but this doesn&rsquo;t work:
</p><div class="lisp">
<pre class="lisp">(defsystem foo
  (:module foo &quot;FOO&quot;)
  (:module bar &quot;BAR&quot;)
  (:module blort &quot;BLORT&quot;)
  (:compile-load (foo bar))
  (:compile-load blort (:fasload foo)))
</pre></div>
<p>because <code>foo</code>&rsquo;s <code>:fasload</code> is not mentioned explicitly (i.e at
top level) but is only implicit in the <code>(:compile-load (foo bar))</code>.  One
must instead write: 
</p><div class="lisp">
<pre class="lisp">(defsystem foo
  (:module foo &quot;FOO&quot;)
  (:module bar &quot;BAR&quot;)
  (:module blort &quot;BLORT&quot;)
  (:compile-load foo)
  (:compile-load bar)
  (:compile-load blort (:fasload foo)))
</pre></div>

<p><em>condition</em> is a predicate which specifies when the transformation
should take place.  Generally it defaults according to the type of the
transformation.  Conditions are discussed further on
<a href="#transformation_002dcondition_002ddiscussion">transformation-condition-discussion</a>.
</p>
<p>The defined simple transformations are:
</p><dl compact="compact">
<dt><code>:fasload</code></dt>
<dd><p>Calls the <code>fasload</code> function to load the indicated files, which must
be QFASL files whose pathnames have canonical type <code>:bin</code> (see
<a href="#canonical_002dtypes">canonical-types</a>).  The <em>condition</em> defaults to
<code>si:file-newer-than-installed-p</code>, which is <code>t</code> if a newer version of
the file exists on the file computer than was read into the current
environment.
</p>
</dd>
<dt><code>:readfile</code></dt>
<dd><p>Calls the <code>readfile</code> function to read in the indicated files, whose
names must have canonical type <code>:lisp</code>.  Use this for files that are
not to be compiled.  <em>condition</em> defaults to
<code>si:file-newer-than-installed-p</code>.
</p>
</dd>
<dt><code>:compile</code></dt>
<dd><p>Calls the <code>qc-file</code> function to compile the indicated files, whose names
must have canonical type <code>:lisp</code>.  <em>condition</em> defaults to
<code>si:file-newer-than-file-p</code>, which returns <code>t</code> if the source file
has been written more recently than the binary file.
</p></dd>
</dl>

<p>A special simple transformation is
</p><dl compact="compact">
<dt><code>:do-components</code></dt>
<dd><p><code>(:do-components <em>dependencies</em>)</code> inside a system with component
systems will cause the <em>dependencies</em> to be done before anything in
the component systems.  This is useful when you have a module of macro
files used by all of the component systems.
</p></dd>
</dl>

<p>The defined complex transformations are
</p><dl compact="compact">
<dt><code>:compile-load</code></dt>
<dd><p><code>(:compile-load <em>input</em> <em>compile-dependencies</em> <em>load-dependencies</em>
<em>compile-condition</em> <em>load-condition</em>)</code> is the same as <code>(:fasload (:compile
<em>input</em> <em>compile-dependencies</em> <em>compile-condition</em>) <em>load-dependencies</em>
<em>load-condition</em>)</code>.  This is the most commonly-used transformation.
Everything after <em>input</em> is optional.
</p>
</dd>
<dt><code>:compile-load-init</code></dt>
<dd><p>See <a href="#compile_002dload_002dinit_002dtransformation">compile-load-init-transformation</a>.
</p></dd>
</dl>

<p>As was explained above, each filename in an input specification can
in fact be a list of strings when the source file of a program
differs from the binary file in more than just the file type.  In fact, every
filename is treated as if it were an infinite list of filenames with
the last filename, or in the case of a single string the only filename,
repeated forever at the end.  Each simple transformation takes some
number of input filename arguments and some number of output filename
arguments.  As transformations are performed, these arguments are taken
from the front of the filename list.  The input arguments are actually
removed and the output arguments left as input arguments to the next
higher transformation.  To make this clearer, consider the <code>prog</code>
module above having the <code>:compile-load</code> transformation performed on
it.  This means that <code>prog</code> is given as the input to the <code>:compile</code>
transformation and the output from this transformation is given as the
input to the <code>:fasload</code> transformation.  The <code>:compile</code>
transformation takes one input filename argument, the name of a Lisp
source file, and one output filename argument, the name of the QFASL
file.  The <code>:fasload</code> transformation takes one input filename
argument, the name of a QFASL file, and no output filename arguments.
So, for the first and only file in the <code>prog</code> module, the filename
argument list looks like <code>(&quot;AI: GEORGE; PROG&quot; &quot;AI: GEORG2; PROG&quot; &quot;AI:
GEORG2; PROG&quot; ...)</code>.  The <code>:compile</code> transformation is given
arguments of <code>&quot;AI: GEORGE; PROG&quot;</code> and <code>&quot;AI: GEORG2; PROG&quot;</code> and the
filename argument list which it outputs as the input to the <code>:fasload</code>
transformation is <code>(&quot;AI: GEORG2; PROG&quot; &quot;AI: GEORG2; PROG&quot; ...)</code>.  The <code>:fasload</code>
transformation then is given its one argument of <code>&quot;AI: GEORG2; PROG&quot;</code>.
</p>
<p>Note that dependencies are not &quot;transitive&quot; or &quot;inherited&quot;.  For example, if
module <code>a</code> depends on macros defined in module <code>b</code>, and therefore needs
<code>b</code> to be loaded in order to compile, and <code>b</code> has a similar dependency
on <code>c</code>, <code>c</code> will not be loaded during compilation of <code>a</code>.  Transformations
with these dependencies would be written
</p><div class="lisp">
<pre class="lisp">(:compile-load a (:fasload b))
(:compile-load b (:fasload c))
</pre></div>
<p>To say that compilation of <code>a</code> depends on both <code>b</code> and <code>c</code>, you
would instead write
</p><div class="lisp">
<pre class="lisp">(:compile-load a (:fasload b c))
(:compile-load b (:fasload c))
</pre></div>
<p>If in addition <code>a</code> depended on <code>c</code> (but not <code>b</code>) during loading
(perhaps <code>a</code> contains <code>defvar</code>s whose initial values depend on functions
or special variables defined in <code>c</code>) you would write the transformations
</p><div class="lisp">
<pre class="lisp">(:compile-load a (:fasload b c) (:fasload c))
(:compile-load b (:fasload c))
</pre></div>

<a name="Making-a-System"></a>
<h3 class="section">25.3 Making a System</h3>

<a name="make_002dsystem_002dfun"></a><dl>
<dt><a name="index-make_002dsystem"></a>Function: <strong>make-system</strong> <em>name &amp;rest keywords</em></dt>
<dd><p>The <code>make-system</code> function does the actual work of compiling and
loading.  In the example above, if <code>PROG1</code> and <code>PROG2</code> have both
been compiled recently, then
</p><div class="lisp">
<pre class="lisp">(make-system 'mysys)
</pre></div>
<p>will load them as necessary.  If either one might also need to be compiled, then
</p><div class="lisp">
<pre class="lisp">(make-system 'mysys ':compile)
</pre></div>
<p>will do that first as necessary.
</p>
<p>The very first thing <code>make-system</code> does is check whether the file
which contains the <code>defsystem</code> for the specified system has changed
since it was loaded.  If so, it offers to load the latest version, so
that the remainder of the <code>make-system</code> can be done using the latest
system definition.  (This only happens if the filetype of that file is
<code>LISP</code>.)  After loading this file or not, <code>make-system</code> goes on to
process the files that compose the system.
</p>
<p>If the system name is not recognized, <code>make-system</code> offers to load the file
<code>SYS: SITE; <em>system-name</em> SYSTEM</code>, in the hope that that will contain a system definition.
</p>
<p><code>make-system</code> lists what transformations it is going to perform on what files,
asks the user for confirmation, then performs the transformations.  Before each
transformation a message is printed listing the transformation being performed,
the file it is being done to, and the package.  This behavior can be altered
by <em>keywords</em>.
</p></dd></dl>

<p>These are the keywords recognized by the <code>make-system</code> function and
what they do.
</p><dl compact="compact">
<dt><code>:noconfirm make-system</code></dt>
<dd><p>Assumes a yes answer for all questions that would otherwise be asked of the user.
</p>
</dd>
<dt><code>:selective make-system</code></dt>
<dd><p>Asks the user whether or not to perform each transformation that appears to
be needed for each file.
</p>
</dd>
<dt><code>:silent make-system</code></dt>
<dd><p>Avoids printing out each transformation as it is performed.
</p>
</dd>
<dt><code>:reload make-system</code></dt>
<dd><p>Bypasses the specified conditions for performing a transformation.  Thus files are
compiled even if they haven&rsquo;t changed and loaded even if they aren&rsquo;t newer than the
installed version.
</p>
</dd>
<dt><code>:noload make-system</code></dt>
<dd><p>Does not load any files except those required by dependencies.  For use in
conjunction with the <code>:compile</code> option.
</p>
</dd>
<dt><code>:compile make-system</code></dt>
<dd><p>Compiles files also if need be.  The default is to load but not compile.
</p>
</dd>
<dt><code>:recompile make-system</code></dt>
<dd><p>This is equivalent to a combination of <code>:compile</code> and <code>:reload</code>:
it specifies compilation of all files, even those whose sources have
not changed since last compiled.
</p>
</dd>
<dt><code>:no-increment-patch make-system</code></dt>
<dd><p>When given along with the <code>:compile</code> option, disables the automatic
incrementing of the major system version that would otherwise take
place.  See <a href="#patch_002dfacility">patch-facility</a>.
</p>
</dd>
<dt><code>:increment-patch make-system</code></dt>
<dd><p>Increments a patchable system&rsquo;s major version without doing any
compilations.  See <a href="#patch_002dfacility">patch-facility</a>.
</p>
</dd>
<dt><code>:no-reload-system-declaration make-system</code></dt>
<dd><p>Turns off the check for whether the file containing the <code>defsystem</code>
nhas been changed.  This file will be loaded only if it has never been
loaded before.
</p>
</dd>
<dt><code>:batch make-system</code></dt>
<dd><p>Allows a large compilation to be done unattended.  It acts
like <code>:noconfirm</code> with regard to questions, turns off more-processing and
fdefine-warnings (see <code>inhibit-fdefine-warnings</code>,
<a href="#inhibit_002dfdefine_002dwarnings_002dvar">inhibit-fdefine-warnings-var</a>), and saves the compiler warnings in
an editor buffer and a file
(it asks you for the name).
</p>
</dd>
<dt><code>:defaulted-batch make-system</code></dt>
<dd><p>This is like <code>:batch</code> except that it uses the default for the pathname
to store warnings in and does not ask the user to type a pathname.
</p>
</dd>
<dt><code>:print-only make-system</code></dt>
<dd><p>Just prints out what transformations would be performed; does not actually do any
compiling or loading.
</p>
</dd>
<dt><code>:noop make-system</code></dt>
<dd><p>Is ignored.  This is useful mainly for programs that call <code>make-system</code>,
so that such programs can include forms like
</p><div class="lisp">
<pre class="lisp">(make-system 'mysys (if compile-p ':compile ':noop))
</pre></div>
</dd>
</dl>

<a name="Adding-New-Keywords-to-make_002dsystem"></a>
<h3 class="section">25.4 Adding New Keywords to make-system</h3>

<p><code>make-system</code> keywords are defined as functions on the
<code>si:make-system-keyword</code> property of the keyword.  The functions are
called with no arguments.  Some of the relevant variables they can use
are
</p>
<a name="si_003a_002asystem_002dbeing_002dmade_002a_002dvar"></a><dl>
<dt><a name="index-si_003a_002asystem_002dbeing_002dmade_002a"></a>Variable: <strong>si:*system-being-made*</strong></dt>
<dd><p>The internal data structure that represents the system being made.
</p></dd></dl>

<a name="si_003a_002amake_002dsystem_002dforms_002dto_002dbe_002devaled_002dbefore_002a_002dvar"></a><dl>
<dt><a name="index-si_003a_002amake_002dsystem_002dforms_002dto_002dbe_002devaled_002dbefore_002a"></a>Variable: <strong>si:*make-system-forms-to-be-evaled-before*</strong></dt>
<dd><p>A list of forms that are evaluated before the transformations are performed.
</p></dd></dl>

<a name="si_003a_002amake_002dsystem_002dforms_002dto_002dbe_002devaled_002dafter_002a_002dvar"></a><dl>
<dt><a name="index-si_003a_002amake_002dsystem_002dforms_002dto_002dbe_002devaled_002dafter_002a"></a>Variable: <strong>si:*make-system-forms-to-be-evaled-after*</strong></dt>
<dd><p>A list of forms that are evaluated after the transformations have been performed.
Transformations can push entries here too.
</p></dd></dl>

<a name="si_003a_002amake_002dsystem_002dforms_002dto_002dbe_002devaled_002dfinally_002a_002dvar"></a><dl>
<dt><a name="index-si_003a_002amake_002dsystem_002dforms_002dto_002dbe_002devaled_002dfinally_002a"></a>Variable: <strong>si:*make-system-forms-to-be-evaled-finally*</strong></dt>
<dd><p>A list of forms that are evaluated by an <code>unwind-protect</code> when the
body of <code>make-system</code> is exited, whether it is completed or not.
Closing the batch warnings file is done here.  Unlike the
<code>si:*make-system-forms-to-be-evaled-after*</code> forms, these forms are
evaluated outside of the &quot;compiler warnings context&quot;.
</p></dd></dl>

<a name="si_003a_002aquery_002dtype_002a_002dvar"></a><dl>
<dt><a name="index-si_003a_002aquery_002dtype_002a"></a>Variable: <strong>si:*query-type*</strong></dt>
<dd><p>Controls how questions are asked.  Its normal value is <code>:normal</code>.
<code>:noconfirm</code> means no questions will be asked and <code>:selective</code>
asks a question for each individual file transformation.
</p></dd></dl>

<a name="si_003a_002asilent_002dp_002a_002dvar"></a><dl>
<dt><a name="index-si_003a_002asilent_002dp_002a"></a>Variable: <strong>si:*silent-p*</strong></dt>
<dd><p>If <code>t</code>, no messages are printed out.
</p></dd></dl>

<a name="si_003a_002abatch_002dmode_002dp_002a_002dvar"></a><dl>
<dt><a name="index-si_003a_002abatch_002dmode_002dp_002a"></a>Variable: <strong>si:*batch-mode-p*</strong></dt>
<dd><p>If <code>t</code>, <code>:batch</code> was specified.
</p></dd></dl>

<a name="si_003a_002aredo_002dall_002a_002dvar"></a><dl>
<dt><a name="index-si_003a_002aredo_002dall_002a"></a>Variable: <strong>si:*redo-all*</strong></dt>
<dd><p>If <code>t</code>, all transformations are performed, regardless of the condition functions.
</p></dd></dl>

<a name="si_003a_002atop_002dlevel_002dtransformations_002a_002dvar"></a><dl>
<dt><a name="index-si_003a_002atop_002dlevel_002dtransformations_002a"></a>Variable: <strong>si:*top-level-transformations*</strong></dt>
<dd><p>A list of the names of transformations that will be performed, such as
<code>(:fasload :readfile)</code>.
</p></dd></dl>

<a name="si_003a_002afile_002dtransformation_002dfunction_002a_002dvar"></a><dl>
<dt><a name="index-si_003a_002afile_002dtransformation_002dfunction_002a"></a>Variable: <strong>si:*file-transformation-function*</strong></dt>
<dd><p>The actual function that gets called with the list of transformations that need to be
performed.  The default is <code>si:do-file-transformations</code>.
</p></dd></dl>

<a name="si_003adefine_002dmake_002dsystem_002dspecial_002dvariable_002dfun"></a><dl>
<dt><a name="index-si_003adefine_002dmake_002dsystem_002dspecial_002dvariable"></a>Special Form: <strong>si:define-make-system-special-variable</strong> <em>variable value [defvar-p]</em></dt>
<dd><p>Causes <em>variable</em> to be bound to <em>value</em> during the body of the call to <code>make-system</code>.
This allows you to define new variables similar to those listed above.
<em>value</em> is evaluated on entry to <code>make-system</code>.
If <em>defvar-p</em> is specified as (or defaulted to) <code>t</code>, <em>variable</em>
is defined with <code>defvar</code>.  It is not given an initial value.
If <em>defvar-p</em> is specified as <em>nil</em>,
<em>variable</em> belongs to some other program and is not <code>defvar</code>&rsquo;ed here.
</p></dd></dl>

<p>The following simple example adds a new keyword to <code>make-system</code>
called <code>:just-warn</code>, which means that <code>fdefine</code> warnings (see
<a href="#fdefine_002dfun">fdefine-fun</a>) regarding  functions being overwritten should be printed
out, but the user should not be queried.
</p><div class="lisp">
<pre class="lisp">(si:define-make-system-special-variable
   inhibit-fdefine-warnings inhibit-fdefine-warnings nil)

(defun (:just-warn si:make-system-keyword) ()
  (setq inhibit-fdefine-warnings ':just-warn))
</pre></div>
<p>(See the description of the <code>inhibit-fdefine-warnings</code> variable, on
<a href="#inhibit_002dfdefine_002dwarnings_002dvar">inhibit-fdefine-warnings-var</a>.)
</p>
<p><code>make-system</code> keywords can do something directly when called, or they
can have their effect by pushing a form to be evaluated onto
<code>si:*make-system-forms-to-be-evaled-after*</code> or one of the other two similar lists.
In general, the only
useful thing to do is to set some special variable defined by
<code>si:define-make-system-special-variable</code>.  In addition to the ones
mentioned above, user-defined transformations may have their behavior
controlled by new special variables, which can be set by new keywords.
If you want to get at the list of transformations to be performed, for
example, the right way is to set
<code>si:*file-transformation-function*</code> to a new function, which then
can call <code>si:do-file-transformations</code> with a possibly modified
list.  That is how the <code>:print-only</code> keyword works.
</p>
<a name="Adding-New-Options-for-defsystem"></a>
<h3 class="section">25.5 Adding New Options for defsystem</h3>

<p>Options to <code>defsystem</code> are defined as macros on the
<code>si:defsystem-macro</code> property of the option keyword.  Such a macro can
expand into an existing option or transformation, or it can have side effects
and return <code>nil</code>.  There are several variables they can use; the only one
of general interest is
</p>
<a name="si_003a_002asystem_002dbeing_002ddefined_002a_002dvar"></a><dl>
<dt><a name="index-si_003a_002asystem_002dbeing_002ddefined_002a"></a>Variable: <strong>si:*system-being-defined*</strong></dt>
<dd><p>The internal data structure that represents the system that is currently being constructed.
</p></dd></dl>

<a name="si_003adefine_002ddefsystem_002dspecial_002dvariable_002dfun"></a><dl>
<dt><a name="index-si_003adefine_002ddefsystem_002dspecial_002dvariable"></a>Special Form: <strong>si:define-defsystem-special-variable</strong> <em>variable value</em></dt>
<dd><p>Causes <em>value</em> to be evaluated and <em>variable</em> to be bound to the
result during the expansion of the <code>defsystem</code> special form.  This
allows you to define new variables similar to the one listed above.
</p></dd></dl>

<a name="si_003adefine_002dsimple_002dtransformation_002dfun"></a><dl>
<dt><a name="index-si_003adefine_002dsimple_002dtransformation"></a>Special Form: <strong>si:define-simple-transformation</strong></dt>
<dd><p>This is the most convenient way to define a new simple transformation.
The form is
</p><div class="lisp">
<pre class="lisp">(si:define-simple-transformation <em>name</em> <em>function</em>
	<em>default-condition</em> <em>input-file-types</em> <em>output-file-types</em>
        <em>pretty-names</em> <em>compile-like</em> <em>load-like</em>)
</pre></div>
<p>For example,
</p><div class="lisp">
<pre class="lisp">(si:define-simple-transformation :compile si:qc-file-1
	si:file-newer-than-file-p (&quot;LISP&quot;) (&quot;QFASL&quot;))
</pre></div>
<p><em>input-file-types</em> and <em>output-file-types</em> are how a transformation
specifies how many input filenames and output filenames it should
receive as arguments, in this case one of each.  They also, obviously, specify
the default file type for these pathnames.
The <code>si:qc-file-1</code> function is mostly like <code>qc-file</code>, except for its interface to
packages.  It takes input-file and output-file arguments.
</p>
<p><em>pretty-names</em>, <em>compile-like</em>, and <em>load-like</em> are optional.
</p>
<p><em>pretty-names</em> specifies how messages printed for the user should print
the name of the transformation.  It can be a list of the
imperative (&quot;Compile&quot;), the present participle (&quot;Compiling&quot;), and
the past participle (&quot;compiled&quot;).  Note that the past participle is not
capitalized, because when used it does not come at the beginning of a sentence.
<em>pretty-names</em> can be just a string, which is taken to be the imperative,
and the system will conjugate the participles itself.  If <em>pretty-names</em>
is omitted or <code>nil</code> it defaults to the name of the transformation.
</p>
<p><em>compile-like</em> and <em>load-like</em> say when the transformation should be performed.
Compile-like transformations are performed when the <code>:compile</code>
keyword is given to <code>make-system</code>.
Load-like transformations are performed unless the <code>:noload</code>
keyword is given to <code>make-system</code>.
By default <em>compile-like</em> is <code>t</code> but <em>load-like</em> is <code>nil</code>.
</p></dd></dl>

<p>Complex transformations are defined as normal macro expansions, for example,
</p><div class="lisp">
<pre class="lisp">(defmacro (:compile-load si:defsystem-macro)
		(input &amp;optional com-dep load-dep
				 com-cond load-cond)
  `(:fasload (:compile ,input ,com-dep ,com-cond)
	     ,load-dep ,load-cond))
</pre></div>

<a name="More-Esoteric-Transformations"></a>
<h3 class="section">25.6 More Esoteric Transformations</h3>

<p>It is sometimes useful to specify a transformation upon which something
else can depend, but which is performed not by default, but rather only
when requested because of that dependency.  The transformation
nevertheless occupies a specific place in the hierarchy.  The <code>:skip</code>
<code>defsystem</code> macro allows specifying a transformation of this type.
For example, suppose there is a special compiler for the read table
which is not ordinarily loaded into the system.  The compiled version
should still be kept up to date, and it needs to be loaded if ever the
read table needs to be recompiled.
</p><div class="lisp">
<pre class="lisp">(defsystem reader
  (:pathname-default &quot;AI: LMIO;&quot;)
  (:package system-internals)
  (:module defs &quot;RDDEFS&quot;)
  (:module reader &quot;READ&quot;)
  (:module read-table-compiler &quot;RTC&quot;)
  (:module read-table &quot;RDTBL&quot;)
  (:compile-load defs)
  (:compile-load reader (:fasload defs))
  (:skip :fasload (:compile read-table-compiler))
  (:rtc-compile-load read-table (:fasload read-table-compiler)))
</pre></div>
<p>Assume that there is a complex transformation <code>:rtc-compile-load</code>,
which is like <code>:compile-load</code> except that is is built on a
transformation called something like <code>:rtc-compile</code>, which uses the
read table compiler rather than the Lisp compiler.  In the above
system, then, if the <code>:rtc-compile</code> transformation is to be performed,
the <code>:fasload</code> transformation must be done on <code>read-table-compiler</code>
first, that is the read table compiler must be loaded if the read table
is to be recompiled.  If you say <code>(make-system 'reader ':compile)</code>,
then the <code>:compile</code> transformation will still happen on the
<code>read-table-compiler</code> module, compiling the read table compiler if
need be.  But if you say <code>(make-system 'reader)</code>, the reader and the
read table will be loaded, but the <code>:skip</code> keeps this from happening
to the read table compiler.
</p>
<a name="transformation_002dcondition_002ddiscussion"></a><p>So far nothing has been said about what can be given as a <em>condition</em>
for a transformation except for the default functions, which check for
conditions such as a source file being newer than the binary.  In
general, any function that takes the same arguments as the
transformation function (e.g <code>qc-file</code>) and returns <code>t</code> if the
transformation needs to be performed, can be in this place as a symbol,
including for example a closure.  To take an example, suppose there is a
file that contains <code>compile-flavor-methods</code> for a system and that
should therefore be recompiled if any of the flavor method definitions
change.  In this case, the condition function for compiling that file
should return <code>t</code> if either the source of that file itself or any of
the files that define the flavors have changed.  This is what the
<code>:compile-load-init</code> complex transformation is for.  It is defined
like this:
</p><div class="lisp">
<pre class="lisp"><a name="compile_002dload_002dinit_002dtransformation"></a>(defmacro (:compile-load-init si:defsystem-macro)
		(input add-dep &amp;optional com-dep load-dep
		 &amp;aux function)
  (setq function (let-closed ((*additional-dependent-modules*
			       add-dep))
		   'compile-load-init-condition))
  `(:fasload (:compile ,input ,com-dep ,function) ,load-dep))

(defun compile-load-init-condition (source-file qfasl-file)
  (or (si:file-newer-than-file-p source-file qfasl-file)
      (local-declare ((special *additional-dependent-modules*))
	(si:other-files-newer-than-file-p
			*additional-dependent-modules*
			qfasl-file))))
</pre></div>
<p>The condition function that will be generated when this macro is used
returns <code>t</code> either if <code>si:file-newer-than-file-p</code> would with those
arguments, or if any of the other files in <code>add-dep</code>, which presumably
is a <em>module specification</em>, are newer than the QFASL file.  Thus
the file (or module) to which the <code>:compile-load-init</code> transformation
applies will be compiled if it or any of the source files it depends on has
been changed, and will be loaded under the normal conditions.  In most
(but not all cases), <code>com-dep</code> will be a <code>:fasload</code> transformation
of the same files as <code>add-dep</code> specifies, so that all the files this
one depends on will be loaded before compiling it.
</p>
<a name="The-Patch-Facility"></a>
<h3 class="section">25.7 The Patch Facility</h3>
<a name="patch_002dfacility"></a><a name="index-patch"></a>
<a name="index-system-maintenance"></a>

<p>The patch facility allows a system maintainer to manage new releases of a
large system and issue patches to correct bugs.  It is designed to be
used to maintain both the Lisp Machine system itself and applications
systems that are large enough to be loaded up and saved on a disk
partition.
</p>
<p>When a system of programs is very large, it needs to be maintained.
Often problems are found and need to be fixed, or other little changes
need to be made.  However, it takes a long time to load up all of the
files that make up such a system, and so rather than having every user
load up all the files every time he wants to use the system, usually the
files just get loaded once into a Lisp world, which is then saved away
on a disk partition.  Users then use this disk partition, copies of
which may appear on many machines.  The problem is that since the users
don&rsquo;t load up the system every time they want to use it, they don&rsquo;t get
all the latest changes.
</p>
<p>The purpose of the patch system is to solve this problem.  A <em>patch</em> file
is a little file that, when you load it, updates
the old version of the system into the new version of the system.  Most
often, patch files just contain new function definitions; old functions
are redefined to do their new thing.  When you want to use a system, you
first use the Lisp environment saved on the disk, and then you load all
the latest patches.  Patch files are very small, so loading them doesn&rsquo;t
take much time.  You can even load the saved environment, load up the
latest patches, and then save it away, to save future users the trouble
of even loading the patches.  (Of course, new patches may be made
later, and then these will have to be loaded if you want to get the
very latest version.)
</p>
<p>For every system, there is a series of patches that have been made to
that system.  To get the latest version of the system, you load each
patch file in the series, in order.  Sooner or later, the maintainer of a
system will want to stop building more and more patches, and recompile
everything, starting afresh.  A complete recompilation is also necessary when
a system is changed in a far-reaching way, that can&rsquo;t be done with a
small patch; for example, if you completely reorganize a program, or
change a lot of names or conventions, you might need to completely
recompile it to make it work again.  After a complete recompilation has
been done, the old patch files are no longer suitable to use; loading
them in might even break things.
</p>
<p>The way all this is kept track of is by labelling each version of a
system with a two-part number.  The two parts are called the <em>major
version number</em> and the <em>minor version number</em>.  The minor version
number is increased every time a new patch is made; the patch is
identified by the major and minor version number together.  The major
version number is increased when the program is completely recompiled,
and at that time the minor version number is reset to zero.  A complete
system version is identified by the major version number, followed by
a dot, followed by the minor version number.  Thus, patch <code>93.9</code>
is for major version 93 and minor version 9; it is followed by patch
<code>93.10</code>.
</p>
<p>To clarify this, here is a typical scenario.  A new system is created;
its initial version number is <code>1.0</code>.  Then a patch file is created;
the version of the program that results from loading the first patch
file into version <code>1.0</code> is called <code>1.1</code>.  Then another patch file
might be created, and loading that patch file into system <code>1.1</code>
creates version <code>1.2</code>.  Then the entire system is recompiled, creating
version <code>2.0</code> from scratch.  Now the two patch files are irrelevant,
because they fix old software; the changes that they reflect are
integrated into system <code>2.0</code>.
</p>
<p>Note that the second patch file should only be loaded into system
<code>1.1</code> in order to create system <code>1.2</code>; you shouldn&rsquo;t load it into
<code>1.0</code> or any other system besides <code>1.1</code>.  It is important that all
the patch files be loaded in the proper order, for two reasons.  First,
it is very useful that any system numbered <code>1.1</code> be exactly the same
software as any other system numbered <code>1.1</code>, so that if somebody
reports a bug in version <code>1.1</code>, it is clear just which software is
being complained about.  Secondly, one patch might patch another patch;
loading them in some other order might have the wrong effect.
</p>
<p>The patch facility keeps track of all the patch
files that exist, remembering which version each one creates.  There
is a separate numbered sequence of patch files for each major version
of each system.  All of them are stored in the file system, and the
patch facility keeps track of where they all are.  In addition to the
patch files themselves, there are &quot;patch directory&quot; files that contain
the patch facility&rsquo;s data base by which it keeps track of what minor
versions exist for a major version, and what the last major version
of a system is.  These files and how to make them are described below.
</p>
<p>In order to use the patch facility, you must define your system with
<code>defsystem</code> (see <a href="#system_002dsystem">system-system</a>) and declare it as patchable with the
<code>:patchable</code> option.  When you load your system (with <code>make-system</code>,
see <a href="#make_002dsystem_002dfun">make-system-fun</a>), it is added to the list of all systems present in
the world.  The patch facility keeps track of which version of each
patchable system is present and where the data about that system reside in
the file system.  This information can be used to update the Lisp world
automatically to the latest versions of all the systems it contains.  Once
a system is present, you can ask for the latest patches to be loaded, ask
which patches are already loaded, and add new patches.
</p>
<p>You can also load in patches or whole new systems and then save the
entire Lisp environment away in a disk partition.  This is explained on
<a href="#disk_002dpartition">disk-partition</a>.
</p>
<p>When a Lisp Machine is booted, it prints out a line of information
telling you what systems are present, and which version of each
system is loaded.  This information is returned by the function
<code>si:system-version-info</code>.  It is followed by a text string containing
any additional information that was requested by whomever created
the current disk partition (see <code>disk-save</code>, <a href="#disk_002dsave_002dfun">disk-save-fun</a>).
</p>
<a name="print_002dsystem_002dmodifications_002dfun"></a><dl>
<dt><a name="index-print_002dsystem_002dmodifications"></a>Function: <strong>print-system-modifications</strong> <em>&amp;rest system-names</em></dt>
<dd><p>With no arguments, this lists all the systems present in this world and, for
each system, all the patches that have been loaded into this world.  For each patch
it shows the major version number (which will always be the same since
a world can only contain one major version), the minor version number,
and an explanation of what the patch does, as typed in by the person who
made the patch.
</p>
<p>If <code>print-system-modifications</code> is called with arguments, only the
modifications to the systems named are listed.
</p></dd></dl>

<a name="si_003aget_002dsystem_002dversion_002dfun"></a><dl>
<dt><a name="index-si_003aget_002dsystem_002dversion"></a>Function: <strong>si:get-system-version</strong> <em>&amp;optional system</em></dt>
<dd><p>Returns two values, the major and minor version numbers of the version
of <em>system</em> currently loaded into the machine, or <code>nil</code> if that
system is not present.  <em>system</em> defaults to <code>&quot;System&quot;</code>.
</p></dd></dl>

<a name="si_003asystem_002dversion_002dinfo_002dfun"></a><dl>
<dt><a name="index-si_003asystem_002dversion_002dinfo"></a>Function: <strong>si:system-version-info</strong> <em>&amp;optional (brief-p <code>nil</code>)</em></dt>
<dd><p>This returns a string giving information about which systems and what
versions of the systems are loaded into the machine, and what microcode
version is running.  A typical string for it to produce is:
</p><div class="lisp">
<pre class="lisp">&quot;System 91.31, ZMail 48.5, Daedalus 1.4, microcode 204&quot;
</pre></div>
<p>If <em>brief-p</em> is <code>t</code>, it uses short names, suppresses the microcode
version, any systems which should not appear in the disk label comment,
the name <code>System</code>, and the commas:
</p><div class="lisp">
<pre class="lisp">&quot;91.31 Daed 1.4&quot;
</pre></div>
</dd></dl>

<a name="Defining-a-System-1"></a>
<h4 class="subsection">25.7.1 Defining a System</h4>

<p>In order to use the patch facility, you must declare your system as
patchable by giving the <code>:patchable</code> option to <code>defsystem</code> (see
<a href="#system_002dsystem">system-system</a>).  The major version of your system in the file system
will be incremented whenever <code>make-system</code> is used to compile it.
Thus a major version is associated with a set of QFASL files.
The major version of your system that is remembered as having been loaded into the
Lisp environment will be set to the major version in the file system
whenever <code>make-system</code> is used to load your system and the
major version in the file system is greater than what you had loaded before.
</p>
<p>After loading your system, you can save it with the <code>disk-save</code>
function (see <a href="#disk_002dsave_002dfun">disk-save-fun</a>).  <code>disk-save</code> will ask you for any
additional information you want printed as part of the greeting when the
machine is booted.  This is in addition to the names and versions of all
the systems present in this world.  If the system version will not fit
in the 16-character field allocated in the disk label, <code>disk-save</code>
will ask you to type in an abbreviated form.
</p>
<a name="Patch-files"></a>
<h4 class="subsection">25.7.2 Patch files</h4>

<p>The patch system will maintain several different types of files in
the directory associated with your system.  This directory is specified
to <code>defsystem</code> via either the <code>:patchable</code> option or the <code>:pathname-default</code>
option.  These files are maintained automatically,
but so that you will know what they are and when they are obsolete (because
they are associated with an obsolete version of your system), they are described here.
</p>
<p>The file that tells the system&rsquo;s current major version has a name of
the form <code>AI: MYDIR; PATCH (PDIR)</code> (on Tops-20,
<code>OZ:PS:&lt;MYDIR&gt; PATCH.DIRECTORY</code>), where the host, device, and
directory (<code>AI:MYDIR;</code> or <code>OZ:PS:&lt;MYDIR&gt;</code> in this example) come
from the system definition as explained above.
</p>
<p>For each major version of the system, there is a <em>patch directory file</em>,
of the form <code>AI: MYDIR; PAT259 (PDIR)</code>, which describes the individual
patches for that version, where 259 is the major version number in this
example.  (On Tops-20, this is <code>OZ:PS:&lt;MYDIR&gt; PATCH-259.DIRECTORY</code>).
</p>
<p>Then for each minor version of the system, the source of the patch file
itself has a name of the form <code>AI: MYDIR; P59.69 &gt;</code>, for minor version 69
of major version 259.  Note that <code>259</code> has been truncated to <code>59</code> to
fit into six characters for ITS.  On Tops-20 this would be
<code>OZ:PS:&lt;MYDIR&gt; PATCH-259-69.LISP</code>.  Patch files get compiled, so there
will also be files like <code>AI: MYDIR; P59.69 QFASL</code> (on Tops-20,
<code>OZ:PS:&lt;MYDIR&gt; PATCH-259-69.QFASL</code>).
</p>
<p>If the <code>:patchable</code> option to <code>defsystem</code> is given an argument, telling
it to put the patch files in a different directory than the one which holds
the other files of the system, then a slightly different set of file name
conventions are used.
</p>
<p>On ITS, the file that tells the current major version is of the form <code>AI:
PATDIR; <em>system</em> (PDIR)</code>, where <em>system</em> is the name of the system
and <code>PATDIR</code> is the directory specified in the <code>:patchable</code> option to <code>defsystem</code>.
The patch directory file for major version <em>nnn</em> is of the form <code>AI:
PATDIR; <em>sysnnn</em> (PDIR)</code>, where <em>sys</em> is the short name specified
with the <code>:short-name</code> option to <code>defsystem</code>.  A patch file has a
name of the form <code>AI: PATDIR; <em>nnn</em>.<em>mm</em></code>; note that the major
version is truncated to three digits instead of two.  In this set of file name
conventions, the patch files don&rsquo;t all fall together in alphabetical order,
as they do in the first set.
</p>
<p>On TOPS-20, the file names take the forms <code>OZ:PS:&lt;PATDIR&gt;<em>system</em>.PATCH-DIRECTORY</code>,
<code>OZ:PS:&lt;PATDIR&gt;<em>system</em>-<em>nnn</em>.PATCH-DIRECTORY</code>, and
<code>OZ:PS:&lt;PATDIR&gt;<em>system</em>-<em>nnn</em>-<em>mmm</em>.LISP</code> (or <code>.QFASL</code>).  These file name
conventions allow the patches for multiple systems to coexist in the same directory.
</p>
<a name="Loading-Patches"></a>
<h4 class="subsection">25.7.3 Loading Patches</h4>

<a name="load_002dpatches_002dfun"></a><dl>
<dt><a name="index-load_002dpatches"></a>Function: <strong>load-patches</strong> <em>&amp;rest options</em></dt>
<dd><p>This function is used to bring the current world up to the latest minor
version of whichever major version it is, for all systems present, or
for certain specified systems.  If there are any patches
available, <code>load-patches</code> will offer to read them in. 
With no arguments, <code>load-patches</code> updates all the systems present in
this world.
</p>
<p><em>options</em> is a list of keywords.  Some keywords are followed by an argument.
The following options are accepted:
</p><dl compact="compact">
<dt><code>:systems <em>list</em></code></dt>
<dd><a name="index-_003asystems-load_002dpatches"></a>
<p><em>list</em> is a list of names of systems to be brought up to date.  If this
option is not specified, all systems are processed.
</p>
</dd>
<dt><code>:verbose</code></dt>
<dd><p>Prints an explanation of what is being done.  This is the default.
</p>
</dd>
<dt><code>:selective</code></dt>
<dd><p>For each patch, says what it is and then ask the user whether or not to load it.
This is the default.  If the user answers <code>P</code>, selective mode is turned off for
any remaining patches to the current system.
</p>
</dd>
<dt><code>:noselective</code></dt>
<dd><p>Turns off <code>:selective</code>.
</p>
</dd>
<dt><code>:silent</code></dt>
<dd><p>Turns off both <code>:selective</code> and <code>:verbose</code>.  In <code>:silent</code> mode all necessary
patches are loaded without printing anything and without querying the user.
</p>
</dd>
<dt><code>:force-unfinished</code></dt>
<dd><p>Loads patches that have not been finished yet, if they have been
compiled.  This is useful for testing a patch before releasing it to all
the users.
</p></dd>
</dl>

<p><code>load-patches</code> returns <code>t</code> if any patches were loaded.
</p></dd></dl>

<p>Currently <code>load-patches</code> is not called automatically, but the system
may be changed to offer to load patches when the user logs in, in order
to keep things up to date.
</p>
<a name="Making-Patches"></a>
<h4 class="subsection">25.7.4 Making Patches</h4>

<p>There are two editor commands that are used to create patch files.
During a typical maintenance session on a system you will make several
edits to its source files.  The patch system can be used to copy these
edits into a patch file so that they can be automatically incorporated
into the system to create a new minor version.  Edits in a patch file
can be modified function definitions, new functions, modified
<code>defvar</code>&rsquo;s and <code>defconst</code>&rsquo;s, or arbitrary forms to be evaluated, even including
<code>load</code>&rsquo;s of new files.
</p>
<p><code>Meta-X Add Patch</code> adds the region (if there is one) or the current
&quot;defun&quot; to the patch file currently being constructed.  The first time you
give this command it will ask you what system you are patching, allocate
a new minor version number, and start constructing the patch file for that
version.  If you change a function, you should recompile it, test it,
then once it works use <code>Add Patch</code> to put it in the patch file.
</p>
<p>The patch file being constructed is in an editor buffer.  If you mistakenly
<code>Add Patch</code> something that doesn&rsquo;t work, you can select the buffer containing
the patch file and delete it.  Then later you can <code>Add Patch</code> the corrected
version.
</p>
<p>While you are making your patch file, the minor version number that has
been allocated for you is reserved so that nobody else can use it.  This
way if two people are patching a system at the same time, they will not
both get the same minor version number.
</p>
<p>After making and testing all of your patches, use <code>Meta-X Finish Patch</code> to
install the patch file so that other users can load it.  This will compile
the patch file if you have not done so yourself (patches are always compiled).
It will ask you for a comment describing the reason for the patch; <code>load-patches</code>
and <code>print-system-modifications</code> print these comments.
</p>
<p>After finishing your patch, if you do another <code>Add Patch</code> it will
ask you which system again and start a new minor version.  Note that you
can be putting together patches only for one system at a time.
</p>
<p>You can start a patch without adding anything to it with the <code>Meta-X
Start Patch</code> command.  This does everything that <code>Add Patch</code> does except
put text into the patch file.
</p>
<p>If you start to make a patch and change your mind, use the command
<code>Meta-X Cancel Patch</code>.  This will delete the record that says that this
patch is being worked on.  It will also tell the editor that you are not
editing a patch.
</p>
<p>If you wish to defer finishing the patch until a later session, you
should just save the editor buffer that contains the patch file.  In
the next session, use the command <code>Meta-X Resume Patch</code> to reselect that
patch.  You will have to specify the minor version number of the patch
you wish to resume (it would be wrong to assume that your patch is the
last one, since someone else might have started one).  Once you have
done this, you are again in a position to use <code>Add Patch</code> or <code>Finish Patch</code>
or <code>Cancel Patch</code> on this patch.
</p>
<p>You can undo a finished patch by using <code>Resume Patch</code> and then <code>Cancel
Patch</code>.
</p>
<a name="System-Status"></a>
<h4 class="subsection">25.7.5 System Status</h4>
<a name="patch_002dsystem_002dstatus"></a><a name="index-status_002c-of-a-patchable-system"></a>

<p>The patch system has the concept of the &quot;status&quot; of a major version of a system.
The status is displayed when the system version is displayed, in places such
as the system greeting message and the disk partition comment.  This status
allows users of the system to know what is going on.  The status of a system
changes as patches are made to it.
</p>
<p>The status is one of the following keywords:
</p><dl compact="compact">
<dt><code>:experimental</code></dt>
<dd><p>The system has been built but has not yet been fully debugged and released to users.
This is the default status when a new major version is created, unless it is
overridden with the <code>:initial-status</code> option to <code>defsystem</code>.
</p>
</dd>
<dt><code>:released</code></dt>
<dd><p>The system is released for general use.  This status produces no extra text
in the system greeting and the disk partition comment.
</p>
</dd>
<dt><code>:obsolete</code></dt>
<dd><p>The system is no longer supported.
</p>
</dd>
<dt><code>:broken</code></dt>
<dd><p>This is like <code>:experimental</code>, but is used when the system was thought incorrectly
to have been debugged, and hence was <code>:released</code> for a while.
</p></dd>
</dl>

<a name="si_003aset_002dsystem_002dstatus_002dfun"></a><dl>
<dt><a name="index-si_003aset_002dsystem_002dstatus"></a>Function: <strong>si:set-system-status</strong> <em>system status &amp;optional major-version</em></dt>
<dd><p>Changes the status of a system.  <em>system</em> is the name of the system.
<em>major-version</em> is the number of the major version to be changed; if unsupplied
it defaults to the version currently loaded into the Lisp world.
<em>status</em> should be one of the keywords above.
</p></dd></dl>

<a name="Processes"></a>
<h2 class="chapter">26 Processes</h2>
<a name="index-process"></a>
<a name="index-multiprocessing"></a>
<a name="process"></a><a name="index-wait"></a>
<a name="process_002dchapter"></a>
<p>The Lisp Machine supports <em>multi-processing</em>;  several computations
can be executed concurrently by placing each in a separate
<em>process</em>.  A process is like a processor, simulated by software.
Each process has its own program counter, its own stack of function
calls and its own special-variable binding environment in which to
execute its computation.  (This is implemented with stack groups; see
<a href="#stack_002dgroup">stack-group</a>.)
</p>
<p>If all the processes are simply trying to compute, the machine time-slices
between them.  This is not a particularly efficient mode of operation
since dividing the finite memory and processor power of the machine
among several processes certainly cannot increase the available power
and in fact wastes some of it in overhead.  The way processes are normally
used is different; there can be several on-going computations, but at
a given moment only one or two processes will be trying to run.  The rest
will be either <em>waiting</em> for some event to occur, or
<em>stopped</em>, that is, not allowed to compete for resources.
</p>
<a name="index-process-wait-function"></a>
<p>A process waits for an event by means of the <code>process-wait</code> primitive,
which is given a predicate function which defines the event being waited
for.  A module of the system called the process scheduler periodically
calls that function.  If it returns <code>nil</code> the process continues to wait;
if it returns <code>t</code> the process is made runnable and its call to
<code>process-wait</code> returns, allowing the computation to proceed.
</p>
<a name="index-run-reason"></a>
<a name="index-arrest-reason"></a>
<a name="index-active-process"></a>
<p>A process may be <em>active</em> or <em>stopped</em>.  Stopped processes are
never allowed to run; they are not considered by the scheduler, and so
will never become the current process until they are made active again.
The scheduler continually tests the waiting functions of all the active
processes, and those which return non-<code>nil</code> values are allowed to run.
When you first create a process with <code>make-process</code>, it is inactive.
</p>
<p>A process has two sets of Lisp objects associated with it, called its
<em>run reasons</em> and its <em>arrest reasons</em>.  These sets are implemented
as lists.  Any kind of object can be in these sets; typically keyword
symbols and active objects such as windows and other processes are
found.  A process is considered <em>active</em> when it has at least one run
reason and no arrest reasons.  A process that is not active is
<em>stopped</em>, is not referenced by the processor scheduler, and does not
compete for machine resources.
</p>
<p>To get a computation to happen in another process, you must first create
a process, then say what computation you want to happen in that
process.  The computation to be executed by a process is specified as an
<em>initial function</em> and a list of arguments to that
function.  When the process starts up it applies the function to the
arguments.  In some cases the initial function is written so that it
never returns, while in other cases it performs a certain computation
and then returns, which stops the process.
</p>
<p>To <em>reset</em> a process means to throw (see <code>*throw</code>, <a href="#g_t_002athrow_002dfun">*throw-fun</a>)
out of its entire computation, then force it to call its initial
function again.  Resetting a process clears its waiting condition, and
so if it is active it will become runnable.  To <em>preset</em> a function
is to set up its initial function (and arguments) and then reset it.
This is how you start up a computation in a process.
</p>
<p>All processes in a Lisp Machine run in the same virtual address space,
sharing the same set of Lisp objects.  Unlike other systems that have
special restricted mechanisms for inter-process communication, the
Lisp Machine allows processes to communicate in arbitrary ways through
shared Lisp objects.  One process can inform another of an event simply
by changing the value of a global variable.  Buffers containing messages
from one process to another can be implemented as lists or arrays.
The usual mechanisms of atomic operations, critical sections, and
interlocks are provided
(see <code>store-conditional</code> [<a href="#store_002dconditional_002dfun">store-conditional-fun</a>],
<code>without-interrupts</code> [<a href="#without_002dinterrupts_002dfun">without-interrupts-fun</a>],
and <code>process-lock</code> [<a href="#process_002dlock_002dfun">process-lock-fun</a>]).
</p>
<p>A process is a Lisp object, an instance of one of several flavors
of process (see <a href="#flavor">flavor</a>).  The remainder of this chapter describes
the operations defined on processes, the functions you can apply to
a process, and the functions and variables a program running in a process
can use to manipulate its process.
</p>
<a name="The-Scheduler"></a>
<h3 class="section">26.1 The Scheduler</h3>

<a name="scheduler"></a><a name="index-scheduler"></a>
<p>At any time there is a set of <em>active processes</em>; as described
above, these are all the processes that are not stopped.  Each active
process is either currently running, trying to run, or waiting for some
condition to become true.  The active processes are managed by a special
stack group called the <em>scheduler</em>, which repeatedly cycles through
the active processes, determining for each process whether it is ready
to be run or waiting.  The scheduler determines whether a process is
ready to run by applying the process&rsquo;s <em>wait-function</em> to its
<em>wait-argument-list</em>.  If the wait-function returns a non-<code>nil</code>
value, then the process is ready to run; otherwise, it is waiting.  If
the process is ready to run, the scheduler resumes the current stack
group of the process.
</p>
<p>When a process&rsquo;s wait-function returns non-<code>nil</code>, the
scheduler will resume its stack group and let it proceed.  The process
is now the <em>current process</em>, that is, the one process that is
running on the machine.  The scheduler sets the variable
<code>current-process</code> to it.  It will remain the current process and
continue to run until either it decides to wait, or a <em>sequence
break</em> occurs.  In either case, the scheduler stack group will be
resumed and it will continue to cycle through the active processes.
This way, each process that is ready to run will get its share of time
in which to execute.
</p>
<p>A process can wait for some condition to become true by calling
<code>process-wait</code> (see <a href="#process_002dwait_002dfun">process-wait-fun</a>),
which will set up its wait-function and wait-argument-list accordingly
and resume the scheduler stack group.  A process can also wait for
just a moment by calling <code>process-allow-schedule</code>
(see <a href="#process_002dallow_002dschedule_002dfun">process-allow-schedule-fun</a>), which resumes the scheduler stack
group but leaves the process runnable; it will run again as soon as all
other runnable processes have had a chance.
</p>
<p>A sequence break is a kind of interrupt that is generated by the Lisp
system for any of a variety of reasons; when it occurs, the scheduler
is resumed.  The function <code>si:sb-on</code> (see <a href="#si_003asb_002don_002dfun">si:sb-on-fun</a>) can be used
to control when sequence breaks occur.  The default is to sequence
break once a second.  Thus if a process runs continuously without
waiting, it will be forced to return control to the scheduler once
a second so that any other runnable processes will get their turn.
</p>
<p>The system does not generate a sequence break when a page fault occurs;
thus time spent waiting for a page to come in from the disk is &quot;charged&quot;
to a process the same as time spent computing, and cannot be used by
other processes.  It is done this way for the sake of simplicity; this
allows the whole implementation of the process system to reside in
ordinary virtual memory, so that it does not have to worry specially
about paging.  The performance penalty is small since Lisp Machines are
personal computers, not multiplexed among a large number of processes.
Usually only one process at a time is runnable.
</p>
<p>A process&rsquo;s wait function is free to touch any data structure it likes
and to perform any computation it likes.  Of course, wait functions
should be kept simple, using only a small amount of time and touching
only a small number of pages, or system performance will be impacted
since the wait function will consume resources even when its process is
not running.  If a wait function gets an error, the error will occur
inside the scheduler.  All scheduling will come to a halt and the user will
be thrown into the error handler.  Wait functions should be written in such
a way that they cannot get errors.  Note that <code>process-wait</code> calls the wait
function once before giving it to the scheduler, so an error due simply to
bad arguments will not occur inside the scheduler.
</p>
<p>Note well that a process&rsquo;s wait function is executed inside the scheduler
stack-group, <em>not</em> inside the process.  This means that a wait function
may not access special variables bound in the process.  It is allowed
to access global variables.  It can access variables bound by a process
through the closure mechanism (<a href="#closure">closure</a>), but more commonly any values
needed by the wait function are passed to it as arguments.
</p>

<a name="current_002dprocess_002dvar"></a><dl>
<dt><a name="index-current_002dprocess"></a>Variable: <strong>current-process</strong></dt>
<dd><p>The value of <code>current-process</code> is the process that is currently
executing, or <code>nil</code> while the scheduler is running.  When the
scheduler calls a process&rsquo;s wait-function, it binds <code>current-process</code>
to the process so that the wait-function can access its process.
</p></dd></dl>

<a name="without_002dinterrupts_002dfun"></a><dl>
<dt><a name="index-without_002dinterrupts"></a>Special Form: <strong>without-interrupts</strong> <em>body...</em></dt>
<dd><p>The <em>body</em> forms are evaluated with
<code>inhibit-scheduling-flag</code> bound to <code>t</code>.  This is the recommended
way to lock out multi-processing over a small critical section of code
to prevent timing errors.  In other words the body is an
<em>atomic operation</em>.  The value(s) of a <code>without-interrupts</code> is/are
the value(s) of the last form in the body.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(without-interrupts
  (push item list))

(without-interrupts
  (cond ((memq item list)
	 (setq list (delq item list))
	 t)
	(t nil)))
</pre></div>
</dd></dl>

<a name="inhibit_002dscheduling_002dflag_002dvar"></a><dl>
<dt><a name="index-inhibit_002dscheduling_002dflag"></a>Variable: <strong>inhibit-scheduling-flag</strong></dt>
<dd><p>The value of <code>inhibit-scheduling-flag</code> is normally <code>nil</code>.  If it is
<code>t</code>, sequence breaks are deferred until <code>inhibit-scheduling-flag</code>
becomes <code>nil</code> again.  This means that no process other than the current
process can run.
</p></dd></dl>

<a name="process_002dwait_002dfun"></a><dl>
<dt><a name="index-process_002dwait"></a>Function: <strong>process-wait</strong> <em>whostate function &amp;rest arguments</em></dt>
<dd><p>This is the primitive for waiting.  The current process waits until the
application of <em>function</em> to <em>arguments</em> returns non-<code>nil</code>
(at which time <code>process-wait</code> returns).  Note that <em>function</em> is applied
in the environment of the scheduler, not the environment of the <code>process-wait</code>,
so bindings in effect when <code>process-wait</code> was called will <em>not</em> be
in effect when <em>function</em> is applied.  Be careful when using any free
references in <em>function</em>.  <em>whostate</em> is a string containing a brief
description of the reason for waiting.  If the who-line at the bottom
of the screen is looking at this process, it will show <em>whostate</em>.
</p><div class="lisp">
<pre class="lisp">Examples:
</pre><pre class="lisp">(process-wait &quot;sleep&quot;
	#'(lambda (now)
             (&gt; (time-difference (time) now) 100.))
	(time))

(process-wait &quot;Buffer&quot;
	#'(lambda (b) (not (zerop (buffer-n-things b))))
	the-buffer)
</pre></div>
</dd></dl>

<a name="process_002dsleep_002dfun"></a><dl>
<dt><a name="index-process_002dsleep"></a>Function: <strong>process-sleep</strong> <em>interval</em></dt>
<dd><p>This simply waits for <em>interval</em> sixtieths of a second, and then returns.
It uses <code>process-wait</code>.
</p></dd></dl>

<a name="process_002dwait_002dwith_002dtimeout_002dfun"></a><dl>
<dt><a name="index-process_002dwait_002dwith_002dtimeout"></a>Function: <strong>process-wait-with-timeout</strong> <em>whostate interval function &amp;rest arguments</em></dt>
<dd><p>This is like <code>process-wait</code> except that if <em>interval</em> sixtieths of a
second go by and the application of <em>function</em> to <em>arguments</em> is
still returning <code>nil</code>, then <code>process-wait-with-timeout</code> returns
anyway.  The value returned is the value of applying <em>function</em> to
<em>arguments</em>; thus, it is non-<code>nil</code> if the wait condition actually
occurred, <code>nil</code> for a time-out.
</p></dd></dl>

<a name="process_002dallow_002dschedule_002dfun"></a><dl>
<dt><a name="index-process_002dallow_002dschedule"></a>Function: <strong>process-allow-schedule</strong></dt>
<dd><p>This function simply waits momentarily; all other processes will get a
chance to run before the current process runs again.
</p></dd></dl>

<a name="sys_003ascheduler_002dstack_002dgroup_002dvar"></a><dl>
<dt><a name="index-sys_003ascheduler_002dstack_002dgroup"></a>Variable: <strong>sys:scheduler-stack-group</strong></dt>
<dd><p>This is the stack group in which the scheduler executes.
</p></dd></dl>

<a name="sys_003aclock_002dfunction_002dlist_002dvar"></a><dl>
<dt><a name="index-sys_003aclock_002dfunction_002dlist"></a>Variable: <strong>sys:clock-function-list</strong></dt>
<dd><p>This is a list of functions to be called by the scheduler 60 times a second.
Each function is passed one argument, the number of 60ths of a second
since the last time that the functions on this list were called.
These functions implement various
system overhead operations such as blinking the blinking cursor
on the screen.  Note that these functions are called inside the
scheduler, just as are the functions of simple processes (see <a href="#simple_002dprocess">simple-process</a>).
The scheduler calls these functions as often as possible, but never
more often than 60 times a second.  That is, if there are no processes
ready to run, the scheduler will call the functions 60 times a second,
assuming that, all together, they take less than 1/60 second to run.
If there are processes continually ready to run, then the scheduler will call 
these functions as often as it can; usually this is once a second, since
usually the scheduler gets control only once a second.
</p></dd></dl>

<a name="sys_003aactive_002dprocesses_002dvar"></a><dl>
<dt><a name="index-sys_003aactive_002dprocesses"></a>Variable: <strong>sys:active-processes</strong></dt>
<dd><p>This is the scheduler&rsquo;s data-structure.  It is a list of lists, where
the car of each element is an active process or <code>nil</code> and the cdr is information
about that process.
</p></dd></dl>

<a name="sys_003aall_002dprocesses_002dvar"></a><dl>
<dt><a name="index-sys_003aall_002dprocesses"></a>Variable: <strong>sys:all-processes</strong></dt>
<dd><p>This is a list of all the processes in existence.  It is mainly for
debugging.
</p></dd></dl>

<a name="si_003ainitial_002dprocess_002dvar"></a><dl>
<dt><a name="index-si_003ainitial_002dprocess"></a>Variable: <strong>si:initial-process</strong></dt>
<dd><p>This is the process in which the system starts up when it is booted.
</p></dd></dl>

<a name="si_003asb_002don_002dfun"></a><dl>
<dt><a name="index-si_003asb_002don"></a>Function: <strong>si:sb-on</strong> <em>&amp;optional when</em></dt>
<dd><p><code>si:sb-on</code> controls what events cause a sequence break, i.e when
re-scheduling occurs.  The following keywords are names of events
which can cause a sequence break.
</p><dl compact="compact">
<dt><code>:clock</code></dt>
<dd><p>This event happens periodically based on a clock.  The default period
is one second.  See <code>sys:%tv-clock-rate</code>, <a href="#sys_003a_0025tv_002dclock_002drate_002dmeter">sys:%tv-clock-rate-meter</a>.
</p></dd>
<dt><code>:keyboard</code></dt>
<dd><p>Happens when a character is received from the keyboard.
</p></dd>
<dt><code>:chaos</code></dt>
<dd><p>Happens when a packet is received from the Chaosnet,
or transmission of a packet to the Chaosnet is completed.
</p></dd>
</dl>

<p>Since the keyboard and Chaosnet are heavily buffered, there is no
particular advantage to enabling the <code>:keyboard</code> and <code>:chaos</code> events,
unless the <code>:clock</code> event is disabled.
</p>
<p>With no argument, <code>si:sb-on</code> returns a list
of keywords for the currently enabled events.
</p>
<p>With an argument, the set of enabled events is changed.  The argument
can be a keyword, a list of keywords, <code>nil</code> (which disables sequence
breaks entirely since it is the empty list), or a number, which is the
internal mask, not documented here.
</p></dd></dl>


<a name="Locks"></a>
<h3 class="section">26.2 Locks</h3>
<a name="index-_0022lock_0022"></a>

<p>A <em>lock</em> is a software construct used for synchronization
of two processes.  A lock is either held by some process, or is free.
When a process tries to seize a lock, it waits until the lock is free,
and then it becomes the process holding the lock.  When it is finished,
it unlocks the lock, allowing some other process to seize it.
A lock protects some resource or data structure so that only one
process at a time can use it.
</p>
<p>In the Lisp Machine, a lock is a locative pointer to a cell.
If the lock is free, the cell contains <code>nil</code>; otherwise it contains
the process that holds the lock.  The <code>process-lock</code> and <code>process-unlock</code>
functions are written in such a way as to guarantee that two processes
can never both think that they hold a certain lock; only one process
can ever hold a lock at one time.
</p>
<a name="process_002dlock_002dfun"></a><dl>
<dt><a name="index-process_002dlock"></a>Function: <strong>process-lock</strong> <em>locative &amp;optional (lock-value <code>current-process</code>) (whostate <code>&quot;Lock&quot;</code>)</em></dt>
<dd><p>This is used to seize the lock that <em>locative</em> points to.
If necessary, <code>process-lock</code> will wait until the lock becomes free.
When <code>process-lock</code> returns, the lock has been seized.  <em>lock-value</em>
is the object to store into the cell specified by <em>locative</em>, and
<em>whostate</em> is passed on to <code>process-wait</code>.
</p></dd></dl>

<a name="process_002dunlock_002dfun"></a><dl>
<dt><a name="index-process_002dunlock"></a>Function: <strong>process-unlock</strong> <em>locative &amp;optional (lock-value <code>current-process</code>)</em></dt>
<dd><p>This is used to unlock the lock that <em>locative</em> points to.
If the lock is free or was locked by some other process, an
error is signaled.  Otherwise the lock is unlocked.  <em>lock-value</em>
must have the same value as the <em>lock-value</em> parameter to the matching
call to <code>process-lock</code>, or else an error is signalled.
</p></dd></dl>

<p>It is a good idea to use <code>unwind-protect</code> to make sure that
you unlock any lock that you seize.  For example, if you write
</p><div class="lisp">
<pre class="lisp">(unwind-protect
   (progn (process-lock lock-3)
	  (function-1)
	  (function-2))
   (process-unlock lock-3))
</pre></div>
<p>then even if <code>function-1</code> or <code>function-2</code> does a <code>*throw</code>,
<code>lock-3</code> will get unlocked correctly.  Particular programs that use
locks often define special forms that package this <code>unwind-protect</code>
up into a convenient stylistic device.
</p>
<p>A higher level locking construct is <code>with-lock</code>:
</p>
<a name="with_002dlock_002dfun"></a><dl>
<dt><a name="index-with_002dlock"></a>Special Form: <strong>with-lock</strong> <em>(lock options...) body...</em></dt>
<dd><p>Executes the <em>body</em> with <em>lock</em> locked.
<em>lock</em> should actually be an expression whose value would be the
status of the lock; it is used inside <code>locf</code> to get a locative
pointer with which the locking and unlocking are done.
</p>
<p>It is OK for one process to lock a lock multiple times, recursively,
using <code>with-lock</code>.
</p>
<p>The <em>options</em> are alternating keywords and values.  The values
should be literally <code>t</code> or <code>nil</code>; they are interpreted at
macro expansion time, not at run time.  Only one keyword is allowed:
</p><dl compact="compact">
<dt><code>:norecursive</code></dt>
<dd><p>If the <em>value</em> is <code>t</code>, multiple recursive locking is an error.
</p></dd>
</dl>
</dd></dl>

<p>A lower level construct which can be used to implement atomic
operations, and is used in the implementation of <code>process-lock</code>,
is <code>store-conditional</code>.
</p>
<a name="store_002dconditional_002dfun"></a><dl>
<dt><a name="index-store_002dconditional"></a>Function: <strong>store-conditional</strong> <em>location oldvalue newvalue</em></dt>
<dd><p>This stores <em>newvalue</em> into <em>location</em> iff <em>location</em> currently
contains <em>oldvalue</em>.  The value is <code>t</code> iff the cell was changed.
</p>
<p>If <em>location</em> is a list, the cdr of the list is tested and stored
in.  This is in accord with the general principle of how to access the
contents of a locative properly, and makes 
<code>(store-conditional (locf (cdr x)) ...)</code> work.
</p></dd></dl>

<p>An even lower-level construct is the subprimitive
<code>%store-conditional</code>, which is like <code>store-conditional</code> with no
error checking.
</p>
<a name="Creating-a-Process"></a>
<h3 class="section">26.3 Creating a Process</h3>

<p>There are two ways of creating a process.  One is to create a permanent
process which you will hold on to and manipulate as desired.  The other
way is to say simply, &quot;call this function on these arguments in another
process, and don&rsquo;t bother waiting for the result.&quot;  In the latter case
you never actually use the process itself as an object.
</p>
<a name="make_002dprocess_002dfun"></a><dl>
<dt><a name="index-make_002dprocess"></a>Function: <strong>make-process</strong> <em>name &amp;rest options</em></dt>
<dd><p>Creates and returns a process named <em>name</em>.  The process will not be
capable of running until it has been reset or preset in order to initialize
the state of its computation.
</p>
<p>The <em>options</em> are alternating keywords and values that allow you to
specify things about the process; however, no options are necessary if
you aren&rsquo;t doing anything unusual.  The following options are allowed:
</p><dl compact="compact">
<dt><code>:simple-p</code></dt>
<dd><p>Specifying <code>t</code> here gives you a simple process (see <a href="#simple_002dprocess">simple-process</a>).
</p></dd>
<dt><code>:flavor</code></dt>
<dd><p>Specifies the flavor of process to be created.  See <a href="#process_002dflavors">process-flavors</a>, for
a list of all the flavors of process supplied by the system.
</p></dd>
<dt><code>:stack-group</code></dt>
<dd><p>The stack group the process is to use.  If this option is not specified,
a stack group will be created according to the relevant options below.
</p></dd>
<dt><code>:warm-boot-action</code></dt>
<dd><p>What to do with the process when the machine is booted.
See <a href="#si_003aprocess_002dwarm_002dboot_002daction_002dmethod">si:process-warm-boot-action-method</a>.
</p></dd>
<dt><code>:quantum</code></dt>
<dd><p>See <a href="#si_003aprocess_002dquantum_002dmethod">si:process-quantum-method</a>.
</p></dd>
<dt><code>:priority</code></dt>
<dd><p>See <a href="#si_003aprocess_002dpriority_002dmethod">si:process-priority-method</a>.
</p></dd>
<dt><code>:run-reasons</code></dt>
<dd><p>Lets you supply an initial run reason.  The default is <code>nil</code>.
</p></dd>
<dt><code>:arrest-reasons</code></dt>
<dd><p>Lets you supply an initial arrest reason.  The default is <code>nil</code>.
</p></dd>
<dt><code>:sg-area</code></dt>
<dd><p>The area in which to create the stack group.  The default is
the value of <code>default-cons-area</code>.
</p></dd>
<dt><code>:regular-pdl-area</code></dt>
<dt><code>:special-pdl-area make-process</code></dt>
<dt><code>:regular-pdl-size make-process</code></dt>
<dt><code>:special-pdl-size make-process</code></dt>
<dd><p>These are passed on to <code>make-stack-group</code>, <a href="#make_002dstack_002dgroup_002dfun">make-stack-group-fun</a>.
</p></dd>
<dt><code>:swap-sv-on-call-out</code></dt>
<dt><code>:swap-sv-of-sg-that-calls-me make-process</code></dt>
<dt><code>:trap-enable make-process</code></dt>
<dd><p>Specify those attributes of the stack group.  You don&rsquo;t want to use
these.
</p></dd>
</dl>

<p>If you specify <code>:flavor</code>, there can be additional options provided
by that flavor.
</p></dd></dl>

<p>The following three functions allow you to call a function and have its
execution happen asynchronously in another process.  This can be used
either as a simple way to start up a process that will run &quot;forever&quot;, or
as a way to make something happen without having to wait for it
complete.  When the function returns, the process is returned to a pool
of free processes for reuse.  The only difference between these three
functions is in what happens if the machine is booted while the process
is still active.
</p>
<p>Normally the function to be run should not do any I/O to the terminal.
Refer to <a href="#sg_002dterminal_002dio_002dissues">sg-terminal-io-issues</a> for a discussion of the issues.
</p>
<a name="process_002drun_002dfunction_002dfun"></a><dl>
<dt><a name="index-process_002drun_002dfunction"></a>Function: <strong>process-run-function</strong> <em>name-or-options function &amp;rest args</em></dt>
<dd><p>Creates a process, presets it so it will apply
<em>function</em> to <em>args</em>, and starts it running.
</p>
<p><em>name-or-keywords</em> can be either a string specifying a name for
the process or a list of alternating keywords and values that can
specify the name and various other parameters.
</p><dl compact="compact">
<dt><code>:name</code></dt>
<dd><p>This keyword should be followed by a string which specifies the name
of the process.  The default is &quot;Anonymous&quot;.
</p></dd>
<dt><code>:restart-after-reset</code></dt>
<dd><p>This keyword says what to do to the process if it is reset.  <code>nil</code>
means the process should be killed; anything else means the process
should be restarted.  <code>nil</code> is the default.
</p></dd>
<dt><code>:warm-boot-action</code></dt>
<dd><p>What to do with the process when the machine is booted.
See <a href="#si_003aprocess_002dwarm_002dboot_002daction_002dmethod">si:process-warm-boot-action-method</a>.
</p></dd>
<dt><code>:restart-after-boot</code></dt>
<dd><p>This is a simpler way of saying what to do with the process when the
machine is booted.  If the <code>:warm-boot-action</code> keyword is not
supplied or its value is <code>nil</code>, then this keyword&rsquo;s value is used
instead.  <code>nil</code> means the process should
be killed; anything else means the process should be restarted.
<code>nil</code> is the default.
</p></dd>
<dt><code>:quantum</code></dt>
<dd><p>See <a href="#si_003aprocess_002dquantum_002dmethod">si:process-quantum-method</a>.
</p></dd>
<dt><code>:priority</code></dt>
<dd><p>See <a href="#si_003aprocess_002dpriority_002dmethod">si:process-priority-method</a>.
</p></dd>
</dl>
</dd></dl>

<a name="process_002drun_002drestartable_002dfunction_002dfun"></a><dl>
<dt><a name="index-process_002drun_002drestartable_002dfunction"></a>Function: <strong>process-run-restartable-function</strong> <em>name-or-keywords function &amp;rest args</em></dt>
<dd><p>This is the same as <code>process-run-function</code> except that the default is that
the process will be restarted if reset or after a warm boot.
You can get the same effect by using <code>process-run-function</code> with
appropriate keywords.
</p></dd></dl>

<a name="Process-Generic-Operations"></a>
<h3 class="section">26.4 Process Generic Operations</h3>

<p>These are the operations that are defined on all flavors of process.
Certain process flavors may define additional operations.  Not all possible
operations are listed here, only those &quot;of interest to the user&quot;.
</p>
<a name="Process-Attributes"></a>
<h4 class="subsection">26.4.1 Process Attributes</h4>

<dl>
<dt><a name="index-_003aname-on-si_003aprocess"></a>Method on si:process: <strong>:name</strong></dt>
<dd><p>Returns the name of the process, which was the first argument to <code>make-process</code>
or <code>process-run-function</code> when the process was created.  The name is
a string that appears in the printed-representation of the process, stands for
the process in the who-line and the <code>peek</code> display, etc.
</p></dd></dl>

<dl>
<dt><a name="index-_003astack_002dgroup-on-si_003aprocess"></a>Method on si:process: <strong>:stack-group</strong></dt>
<dd><p>Returns the stack group currently executing on behalf of this process.
This can be different from the initial-stack-group if the process contains
several stack groups that coroutine among themselves,
or if the process is in the error-handler, which runs in its own stack group.
</p>
<p>Note that the stack-group of a <em>simple</em> process (see <a href="#simple_002dprocess">simple-process</a>)
is not a stack group at all, but a function.
</p></dd></dl>

<dl>
<dt><a name="index-_003ainitial_002dstack_002dgroup-on-si_003aprocess"></a>Method on si:process: <strong>:initial-stack-group</strong></dt>
<dd><p>Returns the stack group the initial-function is called in when the process starts up
or is reset.
</p></dd></dl>

<dl>
<dt><a name="index-_003ainitial_002dform-on-si_003aprocess"></a>Method on si:process: <strong>:initial-form</strong></dt>
<dd><p>Returns the initial &quot;form&quot; of the process.
This isn&rsquo;t really a Lisp form; it is a cons whose car is the initial-function
and whose cdr is the list of arguments to which that function is applied
when the process starts up or is reset.
</p>
<p>In a simple process (see <a href="#simple_002dprocess">simple-process</a>), the initial form is a list of one
element, the process&rsquo;s function.
</p>
<p>To change the initial form, use the <code>:preset</code> operation (see <a href="#si_003aprocess_002dpreset_002dmethod">si:process-preset-method</a>).
</p></dd></dl>

<dl>
<dt><a name="index-_003await_002dfunction-on-si_003aprocess"></a>Method on si:process: <strong>:wait-function</strong></dt>
<dd><p>Returns the process&rsquo;s current wait-function, which is the predicate used
by the scheduler to determine if the process is runnable.  This is
<code>#'true</code> if the process is running, and <code>#'false</code> if the process has
no current computation (for instance, if it has just been created, its
initial function has returned, or the process has been &quot;flushed&quot; (see
<a href="#flushed_002dprocess">flushed-process</a>).
</p></dd></dl>

<dl>
<dt><a name="index-_003await_002dargument_002dlist-on-si_003aprocess"></a>Method on si:process: <strong>:wait-argument-list</strong></dt>
<dd><p>Returns the arguments to the process&rsquo;s current wait-function.  This will
frequently be the <code>&amp;rest</code> argument to <code>process-wait</code> in the
process&rsquo;s stack, rather than a true list.  The system always uses it in
a safe manner, i.e it forgets about it before <code>process-wait</code> returns.
</p></dd></dl>

<dl>
<dt><a name="index-_003awhostate-on-si_003aprocess"></a>Method on si:process: <strong>:whostate</strong></dt>
<dd><p>Returns a string that is the state of the process to go in the who-line at
the bottom of the screen.  This is <code>&quot;run&quot;</code> if the process is running or
trying to run, otherwise the reason why the process is waiting.  If the
process is stopped, then this whostate string is ignored and the who-line
displays <code>arrest</code> if the process is arrested or <code>stop</code> if the process has
no run reasons.
</p></dd></dl>

<dl>
<dt><a name="index-_003aquantum-on-si_003aprocess"></a>Method on si:process: <strong>:quantum</strong></dt>
<dt><a name="index-_003aset_002dquantum-on-si_003aprocess"></a>Method on si:process: <strong>:set-quantum</strong> <em>60ths</em></dt>
<dd><p>Return or change the number of 60ths of a second this process is allowed to
run without waiting before the scheduler will run someone else.  The quantum
defaults to 1 second.
</p></dd></dl>

<a name="si_003aprocess_002dquantum_002dmethod"></a><dl>
<dt><a name="index-_003aquantum_002dremaining-on-si_003aprocess"></a>Method on si:process: <strong>:quantum-remaining</strong></dt>
<dd><p>Returns the amount of time remaining for this process to run, in 60ths of a second.
</p></dd></dl>

<a name="si_003aprocess_002dpriority_002dmethod"></a><dl>
<dt><a name="index-_003apriority-on-si_003aprocess"></a>Method on si:process: <strong>:priority</strong></dt>
<dt><a name="index-_003aset_002dpriority-on-si_003aprocess"></a>Method on si:process: <strong>:set-priority</strong> <em>priority-number</em></dt>
<dd><p>Return or change the priority of this process.  The larger the number, the
more this process gets to run.  Within a priority level the scheduler runs all
runnable processes in a round-robin fashion.  Regardless of priority a process
will not run for more than its quantum.  The default priority is 0, and no
normal process uses other than 0.
</p></dd></dl>

<a name="si_003aprocess_002dwarm_002dboot_002daction_002dmethod"></a><dl>
<dt><a name="index-_003awarm_002dboot_002daction-on-si_003aprocess"></a>Method on si:process: <strong>:warm-boot-action</strong></dt>
<dt><a name="index-_003aset_002dwarm_002dboot_002daction-on-si_003aprocess"></a>Method on si:process: <strong>:set-warm-boot-action</strong> <em>action</em></dt>
<dd><p>Returns or changes the process&rsquo;s warm-boot-action, which controls what
happens if the machine is booted while this process is active.
(Contrary to the name, this applies to both cold and warm booting.) This
can be <code>nil</code> or <code>:flush</code>, which means to &quot;flush&quot; the process (see
<a href="#flushed_002dprocess">flushed-process</a>), or can be a function to call.  The default is
<code>si:process-warm-boot-delayed-restart</code>, which resets the process,
causing it to start over at its initial function.  You can also use
<code>si:process-warm-boot-reset</code>, which throws out of the process&rsquo;
computation and kills the process, or <code>si:process-warm-boot-restart</code>,
which is like the default but restarts the process at an earlier stage
of system reinitialization.  This is used for processes like the
keyboard process and chaos background process, which are needed for
reinitialization itself.
</p>
</dd></dl>

<dl>
<dt><a name="index-_003asimple_002dp-on-si_003aprocess"></a>Method on si:process: <strong>:simple-p</strong></dt>
<dd><p>Returns <code>nil</code> for a normal process, <code>t</code> for a simple process.
See <a href="#simple_002dprocess">simple-process</a>.
</p></dd></dl>


<a name="Run-and-Arrest-Reasons"></a>
<h4 class="subsection">26.4.2 Run and Arrest Reasons</h4>

<dl>
<dt><a name="index-_003arun_002dreasons-on-si_003aprocess"></a>Method on si:process: <strong>:run-reasons</strong></dt>
<dd><p>Returns the list of run reasons, which are the reasons why this process should
be active (allowed to run).
</p></dd></dl>

<dl>
<dt><a name="index-_003arun_002dreason-on-si_003aprocess"></a>Method on si:process: <strong>:run-reason</strong> <em>object</em></dt>
<dd><p>Adds <em>object</em> to the process&rsquo;s run reasons.  This can activate the process.
</p></dd></dl>

<dl>
<dt><a name="index-_003arevoke_002drun_002dreason-on-si_003aprocess"></a>Method on si:process: <strong>:revoke-run-reason</strong> <em>object</em></dt>
<dd><p>Removes <em>object</em> from the process&rsquo;s run reasons.  This can stop the process.
</p></dd></dl>

<dl>
<dt><a name="index-_003aarrest_002dreasons-on-si_003aprocess"></a>Method on si:process: <strong>:arrest-reasons</strong></dt>
<dd><p>Returns the list of arrest reasons, which are the reasons why this process
should be inactive (forbidden to run).
</p></dd></dl>

<dl>
<dt><a name="index-_003aarrest_002dreason-on-si_003aprocess"></a>Method on si:process: <strong>:arrest-reason</strong> <em>object</em></dt>
<dd><p>Adds <em>object</em> to the process&rsquo;s arrest reasons.  This can stop the process.
</p></dd></dl>

<dl>
<dt><a name="index-_003arevoke_002darrest_002dreason-on-si_003aprocess"></a>Method on si:process: <strong>:revoke-arrest-reason</strong> <em>object</em></dt>
<dd><p>Removes <em>object</em> from the process&rsquo;s arrest reasons.  This can activate
the process.
</p></dd></dl>

<dl>
<dt><a name="index-_003aactive_002dp-on-si_003aprocess"></a>Method on si:process: <strong>:active-p</strong></dt>
<dt><a name="index-_003arunnable_002dp-on-si_003aprocess"></a>Method on si:process: <strong>:runnable-p</strong></dt>
<dd><p>These two operations are the same.  <code>t</code> is returned if the process is
active, i.e it can run if its wait-function allows.  <code>nil</code> is returned
if the process is stopped.
</p></dd></dl>

<a name="Bashing-the-Process"></a>
<h4 class="subsection">26.4.3 Bashing the Process</h4>

<a name="si_003aprocess_002dpreset_002dmethod"></a><dl>
<dt><a name="index-_003apreset-on-si_003aprocess"></a>Method on si:process: <strong>:preset</strong> <em>function &amp;rest args</em></dt>
<dd><p>Sets the process&rsquo;s initial function to <em>function</em> and initial arguments
to <em>args</em>.  The process is then reset so that it will throw out of
any current computation and start itself up by <code>apply</code>ing <em>function</em> to <em>args</em>.
A <code>:preset</code> operation on a stopped process
will return immediately, but will not activate the process; hence the
process will not really apply <em>function</em> to <em>args</em> until it is activated later.
</p></dd></dl>

<dl>
<dt><a name="index-_003areset-on-si_003aprocess"></a>Method on si:process: <strong>:reset</strong> <em>&amp;optional no-unwind kill</em></dt>
<dd><p>Forces the process to throw out of its present computation and apply its
initial function to its initial arguments, when it next runs.  The
throwing out is skipped if the process has no present computation (e.g
it was just created), or if the <em>no-unwind</em> option so specifies.  The
possible values for <em>no-unwind</em> are:
</p><dl compact="compact">
<dt><code>:unless-current</code></dt>
<dt><code>nil</code></dt>
<dd><p>Unwind unless the stack group to be unwound is the one we are currently
executing in, or belongs to the current process.
</p>
</dd>
<dt><code>:always</code></dt>
<dd><p>Unwind in all cases.  This may cause the operation to throw through its
caller instead of returning.
</p>
</dd>
<dt><code>t</code></dt>
<dd><p>Never unwind.
</p></dd>
</dl>

<p>If <em>kill</em> is <code>t</code>, the process is to be killed after unwinding it.
This is for internal use by the <code>:kill</code> operation only.
</p>
<p>A <code>:reset</code> operation on a stopped process
will return immediately, but will not activate the process; hence the
process will not really get reset until it is activated later.
</p></dd></dl>

<dl>
<dt><a name="index-_003aflush-on-si_003aprocess"></a>Method on si:process: <strong>:flush</strong></dt>
<dd><a name="flushed_002dprocess"></a><p>Forces the process to wait forever.  A process may not <code>:flush</code> itself.
Flushing a process is different from stopping it, in that it is still active
and hence if it is reset or preset it will start running again.
</p></dd></dl>

<dl>
<dt><a name="index-_003akill-on-si_003aprocess"></a>Method on si:process: <strong>:kill</strong></dt>
<dd><p>Gets rid of the process.  It is reset, stopped,
and removed from <code>sys:all-processes</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003ainterrupt-on-si_003aprocess"></a>Method on si:process: <strong>:interrupt</strong> <em>function &amp;rest args</em></dt>
<dd><p>Forces the process to <code>apply</code> <em>function</em> to <em>args</em>.  When <em>function</em> returns,
the process will continue the interrupted computation.  If the process is waiting,
it wakes up, calls <em>function</em>, then waits again when <em>function</em> returns.
</p>
<p>If the process is stopped it will not <code>apply</code> <em>function</em> to <em>args</em> 
immediately, but will later when it is activated.  Normally the <code>:interrupt</code> operation
returns immediately, but if the process&rsquo;s stack group is in an unusual internal
state it may have to wait for it to get out of that state.
</p></dd></dl>

<a name="Process-Flavors"></a>
<h3 class="section">26.5 Process Flavors</h3>
<a name="process_002dflavors"></a>
<p>These are the flavors of process provided by the system.  It is possible for users
to define additional flavors of their own.
</p>
<dl>
<dt><a name="index-si_003aprocess-on-"></a>Flavor on : <strong>si:process</strong></dt>
<dd><p>This is the standard default kind of process.
</p></dd></dl>

<dl>
<dt><a name="index-si_003asimple_002dprocess-on-"></a>Flavor on : <strong>si:simple-process</strong></dt>
<dd><a name="simple_002dprocess"></a><a name="index-simple-process"></a>
<p>A simple process is not a process in the conventional sense.  It has no
stack group of its own; instead of having a stack group that gets
resumed when it is time for the process to run, it has a function that
gets called when it is time for the process to run.  When the
wait-function of a simple process becomes true, and the scheduler
notices it, the simple process&rsquo;s function is called in the scheduler&rsquo;s
own stack group.  Since a simple process does not have any stack group
of its own, it can&rsquo;t save control state in between calls; any state
that it saves must be saved in data structure.
</p>
<p>The only advantage of simple processes over normal processes is that
they use up less system overhead, since they can be scheduled without
the cost of resuming stack-groups.  They are intended as a special,
efficient mechanism for certain purposes.  For example, packets received
from the Chaosnet are examined and distributed to the proper receiver by
a simple process that wakes up whenever there are any packets in the
input buffer.  However, they are harder to use, because you can&rsquo;t save
state information across scheduling.  That is, when the simple process
is ready to wait again, it must return; it can&rsquo;t call <code>process-wait</code>
and continue to do something else later.  In fact, it is an error to
call <code>process-wait</code> from inside a simple process.  Another drawback
to simple processes is that if the function signals an error, the scheduler
itself will be broken and multiprocessing will stop; this situation can
be hard to repair.  Also, while a simple process is running, no other
process will be scheduled; so simple processes should never run for a long
time without returning.
</p>
<p>Asking for the stack group of a simple process does not signal an error,
but returns the process&rsquo;s function instead.
</p>
<p>Since a simple process cannot call <code>process-wait</code>, it needs some other
way to specify its wait-function.  To set the wait-function of a simple
process, use <code>si:set-process-wait</code> (see below).  So, when a simple
process wants to wait for a condition, it should call
<code>si:set-process-wait</code> to specify the condition, then return.
</p></dd></dl>

<a name="si_003aset_002dprocess_002dwait_002dfun"></a><dl>
<dt><a name="index-si_003aset_002dprocess_002dwait"></a>Function: <strong>si:set-process-wait</strong> <em>simple-process wait-function wait-argument-list</em></dt>
<dd><p>Sets the <em>wait-function</em> and <em>wait-argument-list</em> of <em>simple-process</em>.
See the description of the <code>si:simple-process</code> flavor (above) for
more information.
</p></dd></dl>



<a name="Other-Process-Functions"></a>
<h3 class="section">26.6 Other Process Functions</h3>

<a name="process_002denable_002dfun"></a><dl>
<dt><a name="index-process_002denable"></a>Function: <strong>process-enable</strong> <em>process</em></dt>
<dd><p>Activates <em>process</em> by revoking all its run and arrest reasons,
then giving it a run reason of <code>:enable</code>.
</p></dd></dl>

<a name="process_002dreset_002dand_002denable_002dfun"></a><dl>
<dt><a name="index-process_002dreset_002dand_002denable"></a>Function: <strong>process-reset-and-enable</strong> <em>process</em></dt>
<dd><p>Resets <em>process</em>, then enables it.
</p></dd></dl>

<a name="process_002ddisable_002dfun"></a><dl>
<dt><a name="index-process_002ddisable"></a>Function: <strong>process-disable</strong> <em>process</em></dt>
<dd><p>Stops <em>process</em> by revoking all its run reasons.  Also revokes
all its arrest reasons.
</p></dd></dl>

<p>The remaining functions in this section are obsolete, since they simply
duplicate what can be done by sending a message.  They are documented here
because their names are in the <code>global</code> package.
</p>
<a name="process_002dpreset_002dfun"></a><dl>
<dt><a name="index-process_002dpreset"></a>Function: <strong>process-preset</strong> <em>process function &amp;rest args</em></dt>
<dd><p>Sends a <code>:preset</code> message.
</p></dd></dl>

<a name="process_002dreset_002dfun"></a><dl>
<dt><a name="index-process_002dreset"></a>Function: <strong>process-reset</strong> <em>process</em></dt>
<dd><p>Sends a <code>:reset</code> message.
</p></dd></dl>

<a name="process_002dname_002dfun"></a><dl>
<dt><a name="index-process_002dname"></a>Function: <strong>process-name</strong> <em>process</em></dt>
<dd><p>Gets the name of a process, like the <code>:name</code> operation.
</p></dd></dl>

<a name="process_002dstack_002dgroup_002dfun"></a><dl>
<dt><a name="index-process_002dstack_002dgroup"></a>Function: <strong>process-stack-group</strong> <em>process</em></dt>
<dd><p>Gets the current stack group of a process, like the <code>:stack-group</code> operation.
</p></dd></dl>

<a name="process_002dinitial_002dstack_002dgroup_002dfun"></a><dl>
<dt><a name="index-process_002dinitial_002dstack_002dgroup"></a>Function: <strong>process-initial-stack-group</strong> <em>process</em></dt>
<dd><p>Gets the initial stack group of a process, like the <code>:initial-stack-group</code> operation.
</p></dd></dl>

<a name="process_002dinitial_002dform_002dfun"></a><dl>
<dt><a name="index-process_002dinitial_002dform"></a>Function: <strong>process-initial-form</strong> <em>process</em></dt>
<dd><p>Gets the initial &quot;form&quot; of a process, like the <code>:initial-form</code> operation.
</p></dd></dl>

<a name="process_002dwait_002dfunction_002dfun"></a><dl>
<dt><a name="index-process_002dwait_002dfunction"></a>Function: <strong>process-wait-function</strong> <em>process</em></dt>
<dd><p>Gets the current wait-function of a process, like the <code>:wait-function</code> operation.
</p></dd></dl>

<a name="process_002dwait_002dargument_002dlist_002dfun"></a><dl>
<dt><a name="index-process_002dwait_002dargument_002dlist"></a>Function: <strong>process-wait-argument-list</strong> <em>p</em></dt>
<dd><p>Gets the arguments to the current wait-function of a process, like the
<code>:wait-argument-list</code> operation.
</p></dd></dl>

<a name="process_002dwhostate_002dfun"></a><dl>
<dt><a name="index-process_002dwhostate"></a>Function: <strong>process-whostate</strong> <em>p</em></dt>
<dd><p>Gets the current who-line state string of a process, like the <code>:whostate</code> operation.
</p></dd></dl>

<a name="Errors-and-Debugging"></a>
<h2 class="chapter">27 Errors and Debugging</h2>
<a name="index-error-system"></a>
<a name="index-handling-errors"></a>
<a name="error_002dchapter"></a>
<p>The first portion of this chapter explains how programs
can handle errors, by means of condition handlers.  It also explains how
a program can signal an error if it detects something it doesn&rsquo;t like.
</p>
<p>The second explains how users can handle errors, by means of an interactive debugger;
that is, it explains how to recover if you do something wrong.
A new user of the Lisp Machine, or someone who just wants to know how
to deal with errors and not how to cause them, should ignore the first
section and skip ahead to <a href="#debugger">debugger</a>.
</p>
<p>The remaining sections describe some other debugging facilities.
Anyone who is going to be writing programs for the Lisp Machine should
familiarize himself with these.
</p>
<p>The <em>trace</em> facility provides the ability to perform certain
actions at the time a function is called or at the time it returns.  The
actions may be simple typeout, or more sophisticated debugging functions.
</p>
<p>The <em>advise</em> facility is a somewhat similar facility for modifying
the behavior of a function.
</p>
<p>The <em>breakon</em> facility allows you to cause the debugger to be
entered when a certain function is called.  You can then use the debugger&rsquo;s
stepping commands to step to the next function call or return.
</p>
<p>The <em>step</em> facility allows the evaluation of a form to be
intercepted at every step so that the user may examine just what is happening
throughout the execution of the form.  Stepping works only on interpreted code.
</p>
<p>The <em>MAR</em> facility provides the ability to cause a trap
on any memory reference to a word (or a set of words) in memory.  If
something is getting clobbered by agents unknown, this can help track
down the source of the clobberage.
</p>
<a name="Conditions"></a>
<h3 class="section">27.1 Conditions</h3>
<a name="condition"></a><a name="index-condition-names"></a>
<a name="index-conditions"></a>
<a name="index-condition-instances"></a>

<p>Programmers often want to control what action is taken by their programs
when errors or other exceptional situations occur.  Usually different situations
are handled in different ways, and in order to express what kind of handling
each situation should have, each situation must have an associated name.  In
Zetalisp, noteworthy events are represented by objects called <em>condition instances</em>.
When an event occurs, a condition instance is created; it is then <em>signaled</em>, and a
<em>handler</em> for that condition may be invoked.
</p>
<p>When a condition is signalled, the system (essentially) searches
up the stack of nested function invocations looking for a handler
established to handle that condition.  The handler is a function that
gets called to deal with the condition.  The condition mechanism itself
is just a convenient way for finding an appropriate handler function
for a particular exceptional situation.
</p>
<p>When a condition is signaled, a <em>condition instance</em> is created to represent the
event and hold information about it.  This information includes <em>condition
names</em> then classify the condition and any other data that is likely to be of
interest to condition handlers.  A condition instance is immutable once it has
been created.  Some conditions are <em>errors</em>, which means that the debugger is
invoked if they are signaled and not handled.
</p>
<p>Condition instances are flavor instances.  The flavor <code>condition</code> is the
base flavor from which all flavors of condition are built.  Several
operations that are defined on condition instances are described below.
The flavor <code>error</code>, which is built on <code>condition</code>, is the base flavor for all kinds of
conditions which are errors. 
</p>
<p>A <em>condition name</em> is a symbol then is used to identify a category of conditions.
Each condition instance possesses one or more condition names.  Each condition
handler specifies one or more condition names that it should apply to.  A
handler applies to a condition if they have any condition names in common.
This is the sole purpose of condition names: to match condition instances with
their handlers.  The meaning of every condition name signaled by the system is
described in this manual.  The condition name index is a directory for them.
Conditions then are errors possess the condition name <code>error</code>.
</p>
<p>In PL/I, CLU, ADA and most other systems that provide named conditions, each
condition has only one name.  That is to say, the categories identified by
condition names are disjoint.  In Zetalisp, each condition instance can have
multiple condition names, which means that the categories identified by
condition names can overlap and be subdivided.
</p>
<p>For example, among the condition names defined by the system are <code>condition</code>,
<code>error</code>, <code>sys:arithmetic-error</code>, <code>sys:negative-sqrt</code> and <code>sys:divide-by-zero</code>.
<code>condition</code> is a condition name that all condition instances posess.  <code>error</code>
identifies the category of conditions then are considered errors.
<code>sys:arithmetic-error</code> identifies the category of errors that pertain to arithmetic
operations.  <code>sys:negative-sqrt</code> and <code>sys:divide-by-zero</code> are the most specific level
of categorization.  So, the condition signaled when you evaluate <code>(sqrt -1)</code> will
possess condition names <code>sys:negative-sqrt</code>, <code>sys:arithmetic-error</code>, <code>error</code> and
<code>condition</code>, while the one signaled if you evaluate <code>(// 1 0)</code> will possess condition
names <code>sys:divide-by-zero</code>, <code>sys:arithmetic-error</code>, <code>error</code> and <code>condition</code>.  In this
example, the categories fall into a strict hierarchy, but this does not need to be
the case.
</p>
<p>Condition names are documented throughout the manual, with definitions like this:
</p>
<dl>
<dt><a name="index-_0028sys_003aarithmetic_002derror-on-sys_003adivide_002dby_002dzero"></a>Flavor Condition on sys:divide-by-zero: <strong>(<code>sys:arithmetic-error</code></strong> <em><code>error</code>)</em></dt>
<dd><p>The condition name <code>sys:divide-by-zero</code> is always accompanied by
<code>sys:arithmetic-error</code> and <code>error</code> (that is, it categorizes a subset of those categories).
The presence of <code>error</code> implies that all <code>sys:divide-by-zero</code> conditions are errors.
</p></dd></dl>

<p>The condition instance also records additional information about the event.
The condition instance signaled by <code>sqrt</code> records the number that <code>sqrt</code> was
applied to, and handles the <code>:number</code> operation by returning this number.  The
condition instance signaled by dividing by zero handles the <code>:function</code> operation
by returning the function that did the division (it might be <code>truncate</code>, <code>floor</code>,
<code>ceiling</code> or <code>round</code>, as well as <code>//</code>).  In general, for each condition name there are
conventions saying what additional information is provided and what operations
to use to obtain it.
</p>
<p>The flavor of the condition instance is always one of the condition names, and so
are its component flavors (with a few exceptions; <code>si:vanilla-flavor</code> and some
other flavor components are omitted, since they are not useful categories for
condition handlers to specify).  In our example, the flavor of the condition is
<code>sys:arithmetic-error</code>, and its components include <code>error</code> and <code>condition</code>.
Condition names require new flavors only when they require significantly
different handling by the error system; you will understand in detail after
finishing this section.
</p>
<a name="condition_002dtypep_002dfun"></a><dl>
<dt><a name="index-condition_002dtypep"></a>Function: <strong>condition-typep</strong> <em>condition-instance condition-name</em></dt>
<dd><p>Returns <code>t</code> if <em>condition-instance</em> possesses condition name <em>condition-name</em>.
</p></dd></dl>

<a name="errorp_002dfun"></a><dl>
<dt><a name="index-errorp"></a>Function: <strong>errorp</strong> <em>object</em></dt>
<dd><p>Returns <code>t</code> if <em>object</em> is a condition instance and its flavor incorporates <code>error</code>.
This is normally equivalent to <code>(typep <em>object</em> ':error)</code>.  Some functions such as
<code>open</code> optionally return the condition instance rather than signaling it, if an error
occurs.  <code>errorp</code> is useful in testing the value returned.
</p></dd></dl>

<dl>
<dt><a name="index-_003acondition_002dnames-on-condition"></a>Method on condition: <strong>:condition-names</strong></dt>
<dd><p>Returns a list of all the condition names possesses by this condition instance.
</p></dd></dl>

<a name="Handling-Conditions"></a>
<h3 class="section">27.2 Handling Conditions</h3>
<a name="index-condition-handlers"></a>
<a name="condition_002dhandlers"></a>
<p>A condition handler is a function that is associated with certain
condition names (categories of conditions).  The variable
<code>eh:condition-handlers</code> contains a list of the handlers that are current;
handlers are established using special forms which bind this variable.  When a condition is
signaled, this list is scanned and all the handlers which apply are called,
one by one, until one of the handlers either throws or returns non-<code>nil</code>.
</p>
<p>Since each new handler is pushed onto the front of <code>eh:condition-handlers</code>, the
innermost-established handler gets the first chance to handle the condition.
When the handler is run, <code>eh:condition-handlers</code> is bound so that the running
handler (and all the ones that were established farther in) are not in effect.  This
avoids the danger of infinite recursion due to an error in a handler invoking the
same handler.
</p>
<p>One thing a handler can do is throw to a tag.  Often the <code>*catch</code> for this
tag is right next to the place where the handler is established, but this
does not have to be so.  A simple handler that applies to all errors and just
throws to a tag is established using <code>ignore-errors</code>.
</p>
<a name="ignore_002derrors_002dfun"></a><dl>
<dt><a name="index-ignore_002derrors"></a>Special Form: <strong>ignore-errors</strong> <em>body...</em></dt>
<dd><p>Any error within the execution of <em>body</em> causes control to return from the
<code>ignore-errors</code> form.  In this case, the first value is <code>nil</code> and the second is non-<code>nil</code>.
If there is no error inside <em>body</em>, the values of the last form in the <em>body</em> are
returned from the <code>ignore-errors</code> form.
</p></dd></dl>

<p>The handler can also ask to proceed from the condition.  This is done by
returning a non-<code>nil</code> value.  See the section on proceeding, <a href="#proceeding">proceeding</a>, for
more information.
</p>
<p>The handler can also decline to handle the condition, by returning <code>nil</code>.
Then the next applicable handler is called, and so on until either some
handler does handle the condition or there are no more handlers.
</p>
<p>The handler function is called in the environment where the condition
was signaled, and in the same stack group.  All special variables have the
values they had at the place where the signaling was done, and all catch
tags that were available at the point of signaling may be thrown to.
</p>
<p>The handler receives the condition instance as its first argument.  When
establishing the handler, you can also provide additional arguments to
pass to the handler when it is called.  This allows the same function to
be used in varying circumstances.
</p>
<p>A second list of handlers is called <code>eh:condition-default-handlers</code>.  This list is
scanned after all of <code>eh:condition-handlers</code> has been used up; that is the only
difference between the two lists.  The handlers work the same way.
</p>
<p>The fundamental means of establishing a condition handler is the special
form <code>condition-bind</code>.
</p>
<a name="condition_002dbind_002dfun"></a><dl>
<dt><a name="index-condition_002dbind"></a>Special Form: <strong>condition-bind</strong> <em>(handlers...) body...</em></dt>
<dd><a name="condition_002dbind_002ddefault_002dfun"></a></dd><dt><a name="index-condition_002dbind_002ddefault"></a>Special Form: <strong>condition-bind-default</strong> <em>(handlers...) body...</em></dt>
<dd><p>A <code>condition-bind</code> form looks like this:
</p><div class="lisp">
<pre class="lisp">(condition-bind ((<em>conditions</em> <em>handler-form</em> <em>additional-arg-forms</em>...)
                (<em>conditions</em> <em>handler-form</em> <em>additional-arg-forms</em>...))
  <em>body</em>...)
</pre></div>

<p>The purpose is to execute <em>body</em> with one or more condition handlers
established.
</p>
<p>Each list of conditions and handler-form establishes one handler.
<em>conditions</em> is a condition name or a list of condition names to which the
handler should apply.  It is <em>not</em> evaluated.  <em>handler-form</em> is evaluated to
produce the function that is the actual handler.  The
<em>additional-arg-forms</em> are evaluated, on entry to the <code>condition-bind</code>, to
produce additional arguments that will be passed to the handler
function when it is called.  The arguments to the handler function will
be the condition instance being signaled, followed by the values of any
<em>additional-arg-forms</em>.
</p>
<p><em>conditions</em> can be <code>nil</code>; then the handler will apply to all conditions that
are signaled.  In this case it is up to the handler function to decide whether to
do anything.  It is important for the handler to refrain from handling
certain conditions that are used for debugging, such as <code>break</code> and
<code>si:call-trap</code>.  The <code>:debugging-condition-p</code> operation on condition
instances will return non-<code>nil</code> for these conditions.  Certain other
conditions such as <code>sys:virtual-memory-overflow</code> should be handled only
with great care.  The <code>:dangerous-condition-p</code> operation returns non-<code>nil</code>
for these conditions.
</p>
<p><code>condition-bind-default</code> is like <code>condition-bind</code> but establishes a <em>default</em> <em>handler</em>
instead of an ordinary handler.  Default handlers work like ordinary handlers, but
they are tried in a different order: first all the applicable ordinary handlers are
given a chance to handle the condition, and then the default handlers get their
chance.  A more flexible way of doing things like this is described under
<code>signal-condition</code> (<a href="#signal_002dcondition_002dfun">signal-condition-fun</a>).
</p></dd></dl>

<p>Condition handlers that simply throw to the function that established
them are very common, so there are special constructs provided for
defining them.
</p>
<a name="condition_002dcase_002dfun"></a><dl>
<dt><a name="index-condition_002dcase"></a>Special Form: <strong>condition-case</strong> <em>(variables...) body-form clauses...</em></dt>
<dd><div class="lisp">
<pre class="lisp">(condition-case (<em>variable</em>)
    <em>body-form</em>
  (<em>condition-names</em> <em>forms</em>...)
  (<em>condition-names</em> <em>forms</em>...)
  ...)
</pre></div>
<p><em>body-form</em> is executed with a condition handler established that will
throw back to the <code>condition-case</code> if any of the specified condition names
is signaled.
</p>
<p>Each list starting with some condition names is a <em>clause</em>, and specifies
what to do if one of those condition names is signaled.  <em>condition-names</em>
is either a condition name or a list of condition names; it is not
evaluated.
</p>
<p>Once the handler per se has done the throw, the clauses are tested in
order until one is found that applies.  This is almost like a <code>selectq</code>,
except that the signaled condition can have several condition names, so
the first clause that matches any of them gets to run.  The forms in the
clause are executed with <em>variable</em> bound to the condition instance that
was signaled.  The values of the last form in the clause are returned
from the <code>condition-case</code> form.
</p>
<p>If none of the specified conditions is signaled during the execution of
<em>body-form</em> (or if other handlers, established within <em>body-form</em>, handle
them), then the values of <em>body-form</em> are returned from the
<code>condition-case</code> form.
</p>
<p><em>variable</em> may be omitted if it is not used.
</p>
<p>It is also possible to have a clause starting with <code>:no-error</code> in place of a
condition name.  This clause is executed if <em>body-form</em> finishes normally.
Instead of just one <em>variable</em> there can be several variables; during the
execution of the <code>:no-error</code> clause, these are bound to the values returned
by <em>body-form</em>.  The values of the last form in the clause become the
values of the <code>condition-case</code> form.
</p>
<p>Here is an example:
</p><div class="lisp">
<pre class="lisp">(condition-case ()
    (print foo)
  (error (format t &quot; &lt;&lt;Error in printing&gt;&gt;&quot;)))
</pre></div>
</dd></dl>

<a name="condition_002dcall_002dfun"></a><dl>
<dt><a name="index-condition_002dcall"></a>Special Form: <strong>condition-call</strong> <em>([variable]) body-form clauses...</em></dt>
<dd><p><code>condition-call</code> is an extension of <code>condition-case</code> that allows you to
give each clause an arbitrary conditional expression instead of just a list
of condition names.  It looks like this:
</p><div class="lisp">
<pre class="lisp">(condition-call (<em>variable</em>)
    <em>body-form</em>
  (<em>predicate</em> <em>forms</em>...)
  (<em>predicate</em> <em>forms</em>...)
  ...)
</pre></div>
<p>The difference between this and <code>condition-case</code> is the <em>predicate</em> in
each clause.  The clauses in a <code>condition-call</code> resemble the clauses of a
<code>cond</code> rather than those of a <code>selectq</code>.
</p>
<p>When a condition is signaled, each <em>predicate</em> is executed while still
within the environment of the signaling (that is, within the actual
handler function).  <em>predicate</em> may refer to <em>variable</em> to see the condition
instance.  If any <em>predicate</em> returns non-<code>nil</code>, then the handler throws to the
<code>condition-call</code> and the corresponding clause&rsquo;s <em>forms</em> are executed.  If
every <em>predicate</em> returns <code>nil</code>, the condition is not handled by this handler.
</p>
<p>In fact, each <em>predicate</em> is computed a second time after the throw has
occurred in order to decide which clause to execute.  The code for the
<em>predicate</em> is copied in two different places, once into the handler
function to decide whether to throw, and once in a <code>cond</code> which follows
the catch.
</p>
<p><em>variable</em> may be omitted if it is not used; but it is unlikely that you will
not need to use it.
</p>
<p>Example:
</p><div class="lisp">
<pre class="lisp">(condition-call (instance)
    (do-it)
  ((and (condition-typep instance 'fs:file-error)
        (not (condition-typep instance 'fs:no-more-room)))
   (compute-what-to-return)))
</pre></div>
<p>The condition name <code>fs:no-more-room</code> is a subcategory of
<code>fs:file-error</code>; thus, this will handle all file errors <em>except</em> for
<code>fs:no-more-room</code>.
</p></dd></dl>

<p>Each of the four condition handler establishing special forms has a
conditional version that decides at run time whether to establish the
handlers.
</p>
<a name="condition_002dbind_002dif_002dfun"></a><dl>
<dt><a name="index-condition_002dbind_002dif"></a>Special Form: <strong>condition-bind-if</strong> <em>cond-form (handlers...) body...</em></dt>
<dd><div class="lisp">
<pre class="lisp">(condition-bind-if <em>cond-form</em>
                   ((<em>conditions</em> <em>handler-form</em> <em>additional-arg-forms</em>...)
                    (<em>conditions</em> <em>handler-form</em> <em>additional-arg-forms</em>...))
  <em>body</em>...)
</pre></div>
<p>begins by executing <em>cond-form</em>.  If it returns non-<code>nil</code>, then all proceeds
as for a regular <code>condition-bind</code>.  If <em>cond-form</em> returns <code>nil</code>, then the <em>body</em>
is still executed but without the condition handler.
</p></dd></dl>

<a name="condition_002dcase_002dif_002dfun"></a><dl>
<dt><a name="index-condition_002dcase_002dif"></a>Special Form: <strong>condition-case-if</strong> <em>cond-form (variables...) body-form clauses...</em></dt>
<dd><div class="lisp">
<pre class="lisp">(condition-case-if <em>cond-form</em> (<em>variable</em>)
    <em>body-form</em>
  (<em>condition-names</em> <em>forms</em>...)
  (<em>condition-names</em> <em>forms</em>...)
  ...)
</pre></div>
<p>begins by executing <em>cond-form</em>.  If it returns non-<code>nil</code>, then all proceeds
as for a regular <code>condition-case</code>.  If <em>cond-form</em> returns <code>nil</code>, then the
<em>body-form</em> is still executed but without the condition handler.
<em>body-form</em>&rsquo;s values are returned, or, if there is a <code>:no-error</code> clause, it is
executed and its values returned.
</p></dd></dl>

<a name="condition_002dcall_002dif_002dfun"></a><dl>
<dt><a name="index-condition_002dcall_002dif"></a>Special Form: <strong>condition-call-if</strong> <em>cond-form ([variable]) body-form clauses...</em></dt>
<dd><div class="lisp">
<pre class="lisp">(condition-call-if <em>cond-form</em> (<em>variable</em>)
    <em>body-form</em>
  (<em>predicate</em> <em>forms</em>...)
  (<em>predicate</em> <em>forms</em>...)
  ...)
</pre></div>
<p>begins by executing <em>cond-form</em>.  If it returns non-<code>nil</code>, then everything proceeds
as for a regular <code>condition-call</code>.  If <em>cond-form</em> returns <code>nil</code>, then the
<em>body-form</em> is still executed but without the condition handler.
In that case, <em>body-form</em>&rsquo;s values are always returned.
</p></dd></dl>

<a name="condition_002dbind_002ddefault_002dif_002dfun"></a><dl>
<dt><a name="index-condition_002dbind_002ddefault_002dif"></a>Special Form: <strong>condition-bind-default-if</strong> <em>cond-form (handlers...) body...</em></dt>
<dd><p>This is used just like <code>condition-bind-if</code>, but establishes a default handler
instead of an ordinary handler.
</p></dd></dl>

<a name="eh_003acondition_002dhandlers_002dvar"></a><dl>
<dt><a name="index-eh_003acondition_002dhandlers"></a>Variable: <strong>eh:condition-handlers</strong></dt>
<dd><p>This is the list of established condition handlers.  Each element looks
like this:
</p><div class="lisp">
<pre class="lisp">(<em>condition-names</em> <em>function</em> <em>additional-arg-values</em>...)
</pre></div>
<p><em>condition-names</em> is a condition name or a list of condition names, or <code>nil</code>
which means all conditions.
</p>
<p><em>function</em> is the actual handler function.
</p>
<p><em>additional-arg-values</em> are additional arguments to be passed to the
<em>function</em> when it is called.  <em>function</em>&rsquo;s first argument is always the
condition instance.
</p>
<p>Both the links of the value of <code>eh:condition-handlers</code> and the elements
are usually created with <code>with-stack-list</code>, so copy them if you want to
save them for any period of time.
</p></dd></dl>

<a name="eh_003acondition_002ddefault_002dhandlers_002dvar"></a><dl>
<dt><a name="index-eh_003acondition_002ddefault_002dhandlers"></a>Variable: <strong>eh:condition-default-handlers</strong></dt>
<dd><p>This is the list of established default condition handlers.  The data
format is the same as that of <code>eh:condition-handlers</code>.
</p></dd></dl>

<a name="Standard-Condition-Flavors"></a>
<h3 class="section">27.3 Standard Condition Flavors</h3>

<dl>
<dt><a name="index-condition-on-"></a>Flavor on : <strong>condition</strong></dt>
<dd><p>The flavor <code>condition</code> is the base flavor of all conditions, and provides a default
definition of all the operations described in this chapter.
</p>
<p><code>condition</code> incorporates <code>si:property-list-mixin</code>, which defines operations
<code>:get</code> and <code>:plist</code>.  Each property name on the property list is also an operation
name, so that sending the <code>:foo</code> message is equivalent to
<code>(send instance ':get ':foo)</code>.
</p>
<p><code>condition</code> also provides two instance variables, <code>eh:format-string</code> and <code>eh:format-args</code>.
<code>condition</code>&rsquo;s method for the the <code>:report</code> operation passes these to <code>format</code> to print
the error message.
</p></dd></dl>

<dl>
<dt><a name="index-error-on-"></a>Flavor on : <strong>error</strong></dt>
<dd><p>The flavor <code>error</code> makes a condition an error condition.  <code>errorp</code> returns <code>t</code> for such
conditions, and the debugger is entered if they are signaled and not otherwise
handled.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003ano_002daction_002dmixin-on-"></a>Flavor on : <strong>sys:no-action-mixin</strong></dt>
<dd><p>This mixin provides a definition of the proceed type <code>:no-action</code>.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003aproceed_002dwith_002dvalue_002dmixin-on-"></a>Flavor on : <strong>sys:proceed-with-value-mixin</strong></dt>
<dd><p>This mixin provides a definition of the proceed type <code>:new-value</code>.
</p></dd></dl>

<dl>
<dt><a name="index-ferror-on-"></a>Flavor on : <strong>ferror</strong></dt>
<dd><p>This flavor is a mixture of <code>error</code>, <code>sys:no-action-mixin</code> and
<code>sys:proceed-with-value-mixin</code>.  It is the flavor used by default by the functions
<code>ferror</code> and <code>cerror</code>, and is often convenient for users to instantiate.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003awarning-on-"></a>Flavor on : <strong>sys:warning</strong></dt>
<dd><p>This flavor is a mixture of <code>sys:no-action-mixin</code> and <code>condition</code>.
</p></dd></dl>

<dl>
<dt><a name="index-sys_003abad_002darray_002dmixin-on--1"></a>Flavor on : <strong>sys:bad-array-mixin</strong></dt>
<dd><p>This mixin provides a definition of the proceed type <code>:new-array</code>.
</p></dd></dl>

<a name="Condition-Operations"></a>
<h3 class="section">27.4 Condition Operations</h3>

<p>Every condition instance can be asked to print an <em>error message</em> which describes
the circumstances that led to the signaling of the condition.  The easiest way
to print one is to print the condition instance without slashification (<code>princ</code>, or
<code>format</code> operation <code>~A</code>).  This actually uses the <code>:report</code> operation, which
implements the printing of an error message.  When a condition instance is
printed with slashification, it uses the <code>#leftHorseshoe</code> syntax so that it can be read back in.
</p>
<dl>
<dt><a name="index-_003areport-on-condition"></a>Method on condition: <strong>:report</strong> <em>stream</em></dt>
<dd><p>Prints on <em>stream</em> the condition&rsquo;s error message, a description of the circumstances
for which the condition instance was signaled.  The output should neither start
nor end with a carriage return.
</p>
<p>If you are defining a new flavor of condition and wish to change the way the
error message is printed, this is the operation to redefine.  All others use this
one.
</p></dd></dl>

<dl>
<dt><a name="index-_003areport_002dstring-on-condition"></a>Method on condition: <strong>:report-string</strong></dt>
<dd><p>Returns a string containing the text that the <code>:report</code> operation would
print.
</p></dd></dl>

<p>Operations provided specifically for condition handlers to use:
</p>
<dl>
<dt><a name="index-_003adangerous_002dcondition_002dp-on-condition"></a>Method on condition: <strong>:dangerous-condition-p</strong></dt>
<dd><p>Returns <code>t</code> if the condition instance is one of those that indicate events
that are considered extremely dangerous, such as running out of memory.
Handlers that normally handle all conditions might want to
make an exception for these.
</p></dd></dl>

<dl>
<dt><a name="index-_003adebugging_002dcondition_002dp-on-condition"></a>Method on condition: <strong>:debugging-condition-p</strong></dt>
<dd><p>Returns <code>t</code> if the condition instance is one of those that are signaled as
part of debugging, such as <code>break</code>, which is signaled when you type
<code>Meta-Break</code>.  These conditions are not errors, although they
will normally enter the debugger; this serves to prevent most condition
handlers from handling them.  But any condition handler which is
written to handle <em>all</em> conditions should probably make a specific
exception for these.
</p></dd></dl>

<p>See also the operations <code>:proceed-types</code> and <code>:proceed-type-p</code>, which have to do
with proceeding (<a href="#proceeding">proceeding</a>).
</p>
<a name="Condition-Operations-for-the-Debugger"></a>
<h4 class="subsection">27.4.1 Condition Operations for the Debugger</h4>

<p>Some operations are intended for the debugger to use.  They are documented
because some flavors of condition redefine them so as to cause the debugger to
behave differently.  This section is of interest only to advanced users.
</p>
<dl>
<dt><a name="index-_003aprint_002derror_002dmessage-on-condition"></a>Method on condition: <strong>:print-error-message</strong> <em>stack-group brief-flag stream</em></dt>
<dd><p>This operation is used by the debugger to print a complete error message.  This
is done primarily using the <code>:report</code> operation.
</p>
<p>Certain flavors of condition define a <code>:after</code> <code>:print-error-message</code> method which,
when <em>brief-flag</em> is <code>nil</code>, prints additional helpful information which is not part of
the error message per se.  Often this requires access to the stack group in
addition to the data in the condition instance.  The method can assume that if
<em>brief-flag</em> is <code>nil</code> then <em>stack-group</em> is not the one which is executing.
</p>
<p>For example, the condition signaled when you call
an undefined function will check for the case of calling a function such as <code>bind</code>
that is meaningful only in compiled code; if that is what happened, it will search
the stack to look for the name of the function in which the call appears.  This is
information that is not considered crucial to the error itself, and is therefore
not recorded in the condition instance.
</p></dd></dl>

<dl>
<dt><a name="index-_003amaybe_002dclear_002dinput-on-condition"></a>Method on condition: <strong>:maybe-clear-input</strong> <em>stream</em></dt>
<dd><p>This operation is used on entry to the debugger to discard input.
Certain condition flavors, used by stepping redefine this operation to do nothing,
so that the input will not be discarded.
</p></dd></dl>

<dl>
<dt><a name="index-_003abug_002dreport_002drecipient_002dsystem-on-condition"></a>Method on condition: <strong>:bug-report-recipient-system</strong></dt>
<dd><p>The value returned by this operation is used to determine what address to mail
bug reports to, when the debugger <code>Control-M</code> command is used.
By default, it returns <code>&quot;LISPM&quot;</code>.  The value is passed to the function <code>bug</code>.
</p></dd></dl>

<dl>
<dt><a name="index-_003abug_002dreport_002ddescription-on-condition"></a>Method on condition: <strong>:bug-report-description</strong> <em>stream &amp;optional numeric-arg</em></dt>
<dd><p>This operation is used by the <code>Control-M</code> command to print on <em>stream</em> the
information that should go in the bug report.  <em>numeric-arg</em> is the numeric
argument, if any, that the user gave to the <code>Control-M</code> command.
</p></dd></dl>

<dl>
<dt><a name="index-_003afind_002dcurrent_002dframe-on-condition"></a>Method on condition: <strong>:find-current-frame</strong> <em>stack-group</em></dt>
<dd><p>Returns the stack indices of the stack frames that the debugger should operate
on.
</p>
<p>The first value is the frame &quot;at which the error occurred.&quot;  This is not the
innermost stack frame; it is outside the calls to such functions as <code>ferror</code> and
<code>signal-condition</code> which were used to signal the error.
</p>
<p>The second value is the initial value for the debugger command loop&rsquo;s current
frame.
</p>
<p>The third value is the innermost frame that the debugger should be willing to let the
user see.  By default this is the innermost active frame, but it is safe to use
an open but not active frame within it.
</p>
<p>The fourth value, if non-<code>nil</code>, tells the debugger to consider the innermost frame
to be &quot;interesting&quot;.  Normally, frames that are part of the interpreter (calls to
<code>*eval</code>, <code>si:apply-lambda</code>, <code>prog</code>, <code>cond</code>, etc.) are considered uninteresting.
</p>
<p>This is a flavor operation so that certain flavors of condition can redefine it.
</p></dd></dl>

<dl>
<dt><a name="index-_003adebugger_002dcommand_002dloop-on-condition"></a>Method on condition: <strong>:debugger-command-loop</strong> <em>stack-group &amp;optional error-object</em></dt>
<dd><p>Enters the debugger command loop.  The initial error message and backtrace have
already been printed.  This message is sent in an error handler stack group;
<em>stack-group</em> is the stack group in which the condition was signaled.  <em>error-object</em>
is the condition object which was signaled; it defaults to the one the message is
sent to.
</p>
<p>This operation uses <code>:or</code> method combination (see <a href="#method_002dcombination">method-combination</a>).
Some condition flavors add methods that perform some other sort of
processing or enter a different command loop.  For example, unbound variable
errors look for look-alike symbols in other packages at this point.  If the added
method returns <code>nil</code>, the original method that enteres the usual debugger
command loop is called.
</p></dd></dl>

<a name="Signaling-Conditions"></a>
<h3 class="section">27.5 Signaling Conditions</h3>
<a name="index-signaling-conditions"></a>

<p>Signaling a condition has two steps, creating a condition instance and signaling
the instance.  There are convenience interface functions that combine the two
steps.  You can also do them separately.  If you just want to signal an error and
do not want to worry much about condition handling, the function <code>ferror</code> is all
you need to know.
</p>
<a name="Convenience-Functions-for-Signaling"></a>
<h4 class="subsection">27.5.1 Convenience Functions for Signaling</h4>

<a name="ferror_002dfun"></a><dl>
<dt><a name="index-ferror"></a>Function: <strong>ferror</strong> <em>&amp;rest make-condition-arguments</em></dt>
<dd><p><code>ferror</code> creates a condition instance using <code>make-condition</code> and then signals it
with <code>signal-condition</code>, specifying no local proceed types, and with <code>t</code> as the
<em>use-debugger</em> argument so the debugger is always entered if the condition is not
otherwise handled.
</p>
<p>The first argument to <code>ferror</code> is always a signal name (often <code>nil</code>).  The second
argument is usually a format string and the remaining arguments are additional
arguments for <code>format</code>; but this is under the control of the definition of the
signal name.  Example:
</p><div class="lisp">
<pre class="lisp">(ferror 'sys:negative-sqrt
        &quot;You cannot take the square root of ~S.&quot; number)
</pre></div>
<p>For compatibility with the Symbolics system, if the first argument to <code>ferror</code> is a
string, then a signal name of <code>nil</code> is assumed.  The arguments to <code>ferror</code> are passed
on to <code>make-condition</code> with an additional <code>nil</code> preceding them.
</p>
<p>If you prefer, you can use the formatted output functions
(<a href="#format_003aoutfmt_002dfun">format:outfmt-fun</a>) to generate the error message.  Here is an example,
though in a simple case like this using <code>format</code> is easier:
</p><div class="lisp">
<pre class="lisp">(ferror 'sys:negative-sqrt
  (format:outfmt &quot;You cannot take the square root of &quot;
                 (prin1 number) &quot;.&quot;)
  number)
</pre></div>
<p>In this case, arguments past the second one are not used for printing the error
message, but the signal name may still expect them to be present so it can put
them in the condition instance.
</p></dd></dl>

<a name="cerror_002dfun"></a><dl>
<dt><a name="index-cerror"></a>Function: <strong>cerror</strong> <em>proceed-type ignore signal-name &amp;rest signal-name-arguments</em></dt>
<dd><p>Creates a condition instance, by passing the <em>signal-name</em> and
<em>signal-name-arguments</em> to <code>make-condition</code>, and then signals it.
If <em>proceed-type</em> is non-<code>nil</code> then it is provided to
<code>signal-condition</code> as a proceed type.  For compatibility with old
uses of <code>cerror</code>, if <em>proceed-type</em> is <code>t</code>, <code>:new-value</code> is
provided as the proceed type.  If <em>proceed-type</em> is <code>:yes</code>,
<code>:no-action</code> is provided as the proceed type.
</p>
<p>The second argument to <code>cerror</code> is not used and is present for historical
compatibility.  It may be given a new meaning in the future.
</p>
<p>If a condition handler or the debugger decides to proceed, the second value it
returns becomes the value of <code>cerror</code>.
</p></dd></dl>

<a name="check_002darg_002dfun"></a><dl>
<dt><a name="index-check_002darg"></a>Macro: <strong>check-arg</strong> <em>var-name predicate description [type-symbol]</em></dt>
<dd><a name="index-argument-checking"></a>
<p>The <code>check-arg</code> form is useful for checking arguments
to make sure that they are valid.  A simple example is:
</p><div class="lisp">
<pre class="lisp">(check-arg foo stringp &quot;a string&quot;)
</pre></div>
<p><code>foo</code> is the name of an argument whose value should be a string.
<code>stringp</code> is a predicate of one argument, which returns <code>t</code>
if the argument is a string.  <code>&quot;a string&quot;</code> is an English description
of the correct type for the variable.
</p>
<p>The general form of <code>check-arg</code> is
</p><div class="lisp">
<pre class="lisp">(check-arg <em>var-name</em>
           <em>predicate</em>
           <em>description</em>
	   <em>type-symbol</em>)
</pre></div>
<p><em>var-name</em> is the name of the variable
whose value is of the wrong type.  If the error is proceeded, this variable will
be <code>setq</code>&rsquo;ed to a replacement value.  <em>predicate</em> is a test for whether the
variable is of the correct type.  It can be either a symbol whose function definition
takes one argument and returns non-<code>nil</code> if the type is correct, or it can be a non-atomic
form that is evaluated to check the type and that presumably contains a reference to
the variable <em>var-name</em>.  <em>description</em> is a string that expresses <em>predicate</em>
in English, to be used in error messages.  <em>type-symbol</em> is a symbol that
is used by condition handlers to determine what type of argument was expected.
It may be omitted if it is to be the same as <em>predicate</em>, which must be a symbol
in that case.
</p>
<p>The use of the <em>type-symbol</em> is not really well-defined yet, but the intention
is that if it is <code>numberp</code> (for example), the
condition handlers can tell that a number needed, and might may to
convert the actual supplied value to a number and proceed.
</p>
<p>[We need to establish a conventional way of &quot;registering&quot; the
type-symbols to be used for various expected types.  It might as well
be in the form of a table right here.]
</p>
<p>The <em>predicate</em> is usually a symbol such as <code>fixp</code>, <code>stringp</code>,
<code>listp</code>, or <code>closurep</code>, but when there isn&rsquo;t any convenient predefined
predicate, or when the condition is complex, it can be a form.  In this case
you should supply a <em>type-symbol</em> that encodes the type.  For example:
</p><div class="lisp">
<pre class="lisp">(check-arg a
           (and (numberp a) (lessOrEqual a 10.) (&gt; a 0.))
           &quot;a number from one to ten&quot;
           one-to-ten)
</pre></div>
<p>If this error got to the debugger, the message
</p><div class="lisp">
<pre class="lisp">The argument a was 17, which is not a number from one to ten.
</pre></div>
<p>would be printed.
</p>
<p>In general, what constitutes a valid argument is specified in three
ways in a <code>check-arg</code>.  <em>description</em> is human-understandable,
<em>type-symbol</em> is program-understandable, and <em>predicate</em> is
executable.  It is up to the user to ensure that these three
specifications agree.
</p>
<p><code>check-arg</code> uses <em>predicate</em> to determine whether the value of the variable is of the
correct type.  If it is not, <code>check-arg</code> signals the <code>sys:wrong-type-argument</code>
condition (see <a href="#sys_003awrong_002dtype_002dargument_002dcondition">sys:wrong-type-argument-condition</a>).  If a handler proceeds,
using proceed type <code>:new-value</code>, the variable is set to the value proceeded with,
and <code>check-arg</code> starts over, checking the type again.
</p></dd></dl>

<a name="check_002darg_002dtype_002dfun"></a><dl>
<dt><a name="index-check_002darg_002dtype"></a>Macro: <strong>check-arg-type</strong> <em>var-name type-name [description]</em></dt>
<dd><p>This is a useful variant of the <code>check-arg</code> form.  A simple example
is:
</p><div class="lisp">
<pre class="lisp">(check-arg foo :number)
</pre></div>
<p><code>foo</code> is the name of an argument whose value should be a number.
<code>:number</code> is a value that is passed as a second argument to <code>typep</code>
(see <a href="#typep_002dfun">typep-fun</a>); that is, it is a symbol that specifies a data type.
The English form of the type name, which gets put into the error message,
is found automatically.
</p>
<p>The general form of <code>check-arg-type</code> is:
</p><div class="lisp">
<pre class="lisp">(check-arg-type <em>var-name</em>
                <em>type-name</em>
                <em>description</em>)
</pre></div>
<p><em>var-name</em> is the name of the variable whose value is of the wrong
type.  If the error is proceeded this variable will be <code>setq</code>&rsquo;ed to a
replacement value.  <em>type-name</em> describes the type that the
variable&rsquo;s value ought to have.  It can be exactly those things
acceptable as the second argument to <code>typep</code>.  <em>description</em> is a
string that expresses <em>predicate</em> in English, to be used in error
messages.  It is optional.  If it is omitted, and <em>type-name</em> is one
of the keywords accepted by <code>:typep</code>, which describes a basic Lisp
data type, then the right <em>description</em> will be provided correctly.
If it is omitted and <em>type-name</em> describes some other data type, then
the description will be the word &quot;a&quot; followed by the printed
representation of <em>type-name</em> in lower-case.
</p></dd></dl>

<p>The remaining signaling functions are provided for compatibility only.
</p>
<a name="error_002dfun"></a><dl>
<dt><a name="index-error"></a>Function: <strong>error</strong> <em>&amp;rest make-condition-arguments</em></dt>
<dd><p><code>error</code> exists for compatibility with Maclisp and the Symbolics version of Zetalisp.
It takes arguments in three patterns:
</p><div class="lisp">
<pre class="lisp">(error <em>string</em> <em>object</em> [<em>interrupt</em>])
</pre></div>
<p>which is used in Maclisp, and
</p><div class="lisp">
<pre class="lisp">(error <em>condition-instance</em>)
(error <em>flavor-name</em> <em>init-options</em>...)
</pre></div>
<p>which are used by Symbolics.  (In fact, the arguments to <code>error</code> are simply passed
along to <code>make-condition</code> if they do not appear to fit the Maclisp pattern).
</p>
<p>If the Maclisp argument pattern is not used, then there is no difference between
<code>error</code> and <code>ferror</code>.
</p></dd></dl>

<a name="fsignal_002dfun"></a><dl>
<dt><a name="index-fsignal"></a>Function: <strong>fsignal</strong> <em>format-string &amp;rest format-args</em></dt>
<dd><p>This function is for Symbolics compatibility only, and is equivalent to
</p><div class="lisp">
<pre class="lisp">(cerror ':no-action nil nil <em>format-string</em> <em>format-args</em>...)
</pre></div>
</dd></dl>

<a name="signal_002dfun"></a><dl>
<dt><a name="index-signal"></a>Function: <strong>signal</strong> <em>signal-name &amp;rest remaining-make-condition-arguments</em></dt>
<dd><p>The <em>signal-name</em> and <em>remaining-make-condition-arguments</em> are passed to
<code>make-condition</code>, and the result is signaled with <code>signal-condition</code>.
</p>
<p>If the <em>remaining-make-condition-arguments</em> are keyword arguments and
<code>:proceed-types</code> is one of the keywords, the associated value is used as the list of
proceed types.  In particular, if <em>signal-name</em> is actually a condition instance, so
that the remaining arguments will be ignored by <code>make-condition</code>, it works to
specify the proceed types this way.
</p>
<p>If the proceed types are not specified, a list of all the proceed types that the
condition instance knows how to prompt the user about is used by default.
</p></dd></dl>

<a name="errset_002dfun"></a><dl>
<dt><a name="index-errset"></a>Special Form: <strong>errset</strong> <em>form [flag]</em></dt>
<dd><p>The <code>errset</code> special form catches errors during
the evaluation of <em>form</em>.  If an error occurs, the usual error message
is printed unless <em>flag</em> is <code>nil</code>.  Then control is thrown and the errset-form
returns <code>nil</code>.  <em>flag</em> is evaluated first and is optional, defaulting to <code>t</code>.
If no error occurs, the value of the errset-form is a list of one element,
the value of <em>form</em>.
</p>
<p><code>errset</code> is implemented in an ad-hoc fashion, which is still supported so that old
compiled code will continue to run.  It may be changed in the future to compile
using <code>condition-case</code>.  Meanwhile, many uses of <code>errset</code> or <code>errset</code>-like constructs
really ought to be checking for more specific conditions instead.
</p></dd></dl>

<a name="catch_002derror_002dfun"></a><dl>
<dt><a name="index-catch_002derror"></a>Special Form: <strong>catch-error</strong> <em>form [flag]</em></dt>
<dd><p><code>catch-error</code> is a variant of <code>errset</code>.  This special form
catches errors during the evaluation of
<em>form</em> and returns two values.  Normally the first value is the value of
<em>form</em> and the second value is <code>nil</code>.  If an error occurs, the usual
error message is printed unless <em>flag</em> is <code>nil</code>, and then control is thrown
out of the <code>catch-error</code> form, which returns two values, first <code>nil</code> and second a
non-<code>nil</code> value that indicates the occurrence of an error.  <em>flag</em> is
evaluated first and is optional, defaulting to <code>t</code>.
</p></dd></dl>

<a name="errset_002dvar"></a><dl>
<dt><a name="index-errset-1"></a>Variable: <strong>errset</strong></dt>
<dd><p>If this variable is non-<code>nil</code>, <code>errset</code> forms are not allowed to trap errors.
The debugger is entered just as if there were no errset.  This is intended mainly
for debugging.  The initial value of <code>errset</code> is <code>nil</code>.
</p></dd></dl>

<a name="err_002dfun"></a><dl>
<dt><a name="index-err"></a>Special Form: <strong>err</strong></dt>
<dd><p>This is for Maclisp compatibility only and should not be used.
</p>
<p><code>(err)</code> is a dumb way to cause an error.  If executed inside an errset,
that errset returns <code>nil</code>, and no message is printed.
Otherwise an unseen throw-tag error occurs.
</p>
<p><code>(err <em>form</em>)</code> evaluates <em>form</em> and causes the containing errset
to return the result.  If executed when not inside an errset, an unseen
throw-tag error occurs.
</p>
<p><code>(err <em>form</em> <em>flag</em>)</code>, which exists in Maclisp, is not supported.
</p></dd></dl>

<a name="Creating-Condition-Instances"></a>
<h4 class="subsection">27.5.2 Creating Condition Instances</h4>

<p>You can create a condition instance quite satisfactorily with <code>make-instance</code> if
you know which instance variables to initialize.  For example,
</p><div class="lisp">
<pre class="lisp">(make-instance 'ferror ':condition-names '(foo)
               ':format-string &quot;~S loses.&quot;
               ':format-args losing-object)
</pre></div>
<p>creates an instance of <code>ferror</code> just like the one that would be signaled if you do
</p><div class="lisp">
<pre class="lisp">(ferror 'foo &quot;~S loses.&quot; losing-object)
</pre></div>

<p>Note that the flavor name and its components&rsquo; names are added in automatically
to whatever you specify for the <code>:condition-names</code> keyword.
</p>
<a name="index-signal-names"></a>
<p>Direct use of <code>make-instance</code> is cumbersome, however, and it is usually handier
to define a <em>signal</em> <em>name</em> with <code>defsignal</code> or <code>defsignal-explicit</code> and then create the
instance with <code>make-condition</code>.
<a name="signal_002dname"></a></p>
<p>A signal name is a sort of abbreviation for all the things that are always the same
for a certain sort of condition: the flavor to use, the condition names, and what
arguments are expected.  In addition, it allows you to use a positional syntax for
the arguments, which is usually more convenient than a keyword syntax in
simple use.
</p>
<p>Here is a typical <code>defsignal</code>:
</p><div class="lisp">
<pre class="lisp">(defsignal series-not-convergent sys:arithmetic-error (series)
  &quot;Signaled by limit extractor when SERIES does not converge.&quot;)
</pre></div>
<p>This defines a signal name <code>series-not-convergent</code>, together with the name of the
flavor to use (<code>sys:arithmetic-error</code>, whose meaning is being stretched a little),
an interpretation for the arguments (<code>series</code>, which will be explained below),
and a documentation string.  The documentation string is not used in printing
the error message; it is documentation for the signal name.
</p>
<p><code>series-not-convergent</code> could then be used to signal an error, or just to create a
condition instance, like this:
</p><div class="lisp">
<pre class="lisp">(ferror 'series-not-convergent
        &quot;The series ~S went to infinity.&quot; myseries)

(make-condition 'series-not-convergent
                &quot;The series ~S went to infinity.&quot; myseries)
</pre></div>

<p>The list <code>(series)</code> in the <code>defsignal</code> is a list of implicit instance variable
names.  They are matched against arguments to <code>make-condition</code> following the
format string, and each implicit instance variable name becomes an operation
defined on the condition instance to return the corresponding argument.  (You
can imagine that <code>:gettable-instance-variables</code> is in effect for all the implicit
instance variables.)  In this example, sending a <code>:series</code> message to the condition
instance will return the value specified via <code>myseries</code> when the condition was
signaled.  The implicit instance variables are actually implemented using the
condition instance&rsquo;s property list.
</p>
<p>Thus, <code>defsignal</code> spares you the need to create a new flavor merely in
order to remember a particular datum about the condition.
</p>
<a name="defsignal_002dfun"></a><dl>
<dt><a name="index-defsignal"></a>Special Form: <strong>defsignal</strong> <em>signal-name (flavor condition-names...) implicit-instance-variables documentation extra-init-keyword-forms</em></dt>
<dd><p>Defines <em>signal-name</em> to create an instance of <em>flavor</em> with condition names
<em>condition-names</em>, and implicit instance variable whose names are taken from the list
<em>implicit-instance-variables</em> and whose values are taken from the <code>make-condition</code> arguments
following the format string.
</p>
<p>Instead of a list <code>(<em>flavor</em></code> <em>condition-names<code>...)</code></em> there may appear just a flavor name.
This is equivalent to using <em>signal-name</em> as the sole condition name.
</p>
<p>The<em> extra-init-keyword-forms</em> are forms to be evaluated to produce additional
keyword arguments to pass to <code>make-instance</code>.  These can be used to initialize
other instance variables that particular flavors may have.  These expressions can
refer to the <em>implicit-instance-variables</em>.
</p></dd></dl>

<a name="defsignal_002dexplicit_002dfun"></a><dl>
<dt><a name="index-defsignal_002dexplicit"></a>Special Form: <strong>defsignal-explicit</strong> <em>signal-name (flavor condition-names...) signal-arglist documentation init-keyword-forms...</em></dt>
<dd><p>Like <code>defsignal</code>, <code>defsignal-explicit</code> defines a signal name.  This signal name is
used the same way, but the way it goes about creating the condition instance is
different.
</p>
<p>First of all, there is no list of implicit instance variables.  Instead, <em>signal-arglist</em> is
a lambda list which is matched up against all the arguments to <code>make-condition</code>
except for the signal-name itself.  The variables bound by the lambda list can
be used in the <em>init-keyword-forms</em>, which are evaluated to get arguments to pass
to <code>make-instance</code>.  For example:
</p><div class="lisp">
<pre class="lisp">(defsignal-explicit mysignal-3 
           (my-error-flavor mysignal-3 my-signals-category)
           (format-string losing-object &amp;rest format-args)
  &quot;The third kind of thing I like to signal.&quot;
  ':format-string format-string
  ':format-args (cons losing-object (copylist format-args))
  ':losing-object-name (send losing-object ':name))
</pre></div>
<p>Since implicit instance variables are really just properties on the property list of
the instance, you can create them by using init keyword <code>:property-list</code>.  The
contents of the property list determines what implicit instance variables there
will be and their values.
</p></dd></dl>

<a name="make_002dcondition_002dfun"></a><dl>
<dt><a name="index-make_002dcondition"></a>Function: <strong>make-condition</strong> <em>signal-name &amp;rest arguments</em></dt>
<dd><p><code>make-condition</code> is the fundamental way that condition instances are created.
The <em>signal-name</em> says how to interpret the <em>arguments</em> and come up with a flavor
and values for its instance variables.  The handling of the <em>arguments</em> is
entirely determined by the <em>signal-name</em>.
</p>
<p>If <em>signal-name</em> is a condition instance, <code>make-condition</code> returns it.
It is not useful to call <code>make-condition</code> this way explicitly, but this allows
condition instances to be passed to the convenience functions <code>error</code> and <code>signal</code>
which call <code>make-condition</code>.
</p>
<p>If the <em>signal-name</em> was defined with <code>defsignal</code> or <code>defsignal-explicit</code>, then that
definition specifies exactly how to interpret the <em>arguments</em> and create the
instance.  In general, if the <em>signal-name</em> has an <code>eh:make-condition-function</code>
property (which is how <code>defsignal</code> works), this property is a function to which
the <em>signal-name</em> and <em>arguments</em> are passed, and it does the work.
</p>
<p>Alternatively, the <em>signal-name</em> can be the name of a flavor.  Then the <em>arguments</em>
are passed to <code>make-instance</code>, which interprets them as init keywords and values.
This mode is not really recommended and exists for compatibility with
Symbolics software.
</p>
<p>If the <em>signal-name</em> has no <code>eh:make-condition-function</code> property and is not a
flavor name, then a trivial <code>defsignal</code> is assumed as a default.  It looks like this:
</p><div class="lisp">
<pre class="lisp">(defsignal <em>signal-name</em> ferror ())
</pre></div>
<p>So the value is an instance of <code>ferror</code>, with the <em>signal-name</em> as a condition name,
and the <em>arguments</em> are interpreted as a format string and args for it.
</p>
<p>The <em>signal-name</em> <code>nil</code> actually has a definition of this form.  <code>nil</code> is frequently used
as a signal name in the function <code>ferror</code> when there is no desire to use any
condition name in particular.
</p></dd></dl>

<a name="Signaling-a-Condition-Instance"></a>
<h4 class="subsection">27.5.3 Signaling a Condition Instance</h4>

<p>Once you have a condition instance, you are ready to invoke the condition
handling mechanism by signaling it.  A condition instance can be signaled any number
of times, in any stack groups.
</p>
<a name="signal_002dcondition_002dfun"></a><dl>
<dt><a name="index-signal_002dcondition"></a>Function: <strong>signal-condition</strong> <em>condition-instance &amp;optional proceed-types invoke-debugger ucode-error-status inhibit-resume-handlers</em></dt>
<dd><p>Invoke the condition handling mechanism on <em>condition-instance</em>.
The list of <em>proceed-types</em> says which proceed types (among those conventionally
defined for the type of condition you have signaled) you are prepared to
implement, should a condition handler return one (see &quot;proceeding&quot;).
These are in addition to any proceed types implemented nonlocally by
<code>condition-resume</code> special forms.
</p>
<p><code>signal-condition</code> returns to its caller only if it decides to proceed using
one of the <em>proceed-types</em>, or if the condition is not an error and there are no
nonlocal proceed types to be used, or if <em>inhibit-resume-handlers</em> is non-<code>nil</code>.
</p>
<p><em>ucode-error-status</em> is used for internal purposes in signaling errors detected by
the microcode.
</p></dd></dl>

<p><code>signal-condition</code> tries various possible handlers for the condition.  Each handler
that is tried can terminate the act of signaling by throwing out of
<code>signal-condition</code>, or it can specify a way to proceed from the signal.  The
handler can also decline to handle the condition, and then the next possible
handler is tried.
</p>
<p>First <code>eh:condition-handlers</code> is scanned for handlers that are applicable
(according to the condition names they specify) to this condition instance.
After this list is exhausted, <code>eh:condition-default-handlers</code> is scanned the
same way.
</p>
<p>Finally, if <em>invoke-debugger</em> is non-<code>nil</code>, the debugger is the handler of last resort.
With the debugger, the user can ask to throw or to proceed.  The default value
of <em>invoke-debugger</em> is non-<code>nil</code> if the <em>condition-instance</em> is an error.
</p>
<p>It is possible for all handlers to decline the condition, if the debugger is not
among the handlers tried.  (The debugger cannot &quot;decline to handle the
condition&quot;.)  In this circumstance, <code>signal-condition</code> proceeds using the first
proceed type on the list of available ones, provided it is a nonlocal proceed type.
If it is a local proceed type, or if there are no proceed types, <code>signal-condition</code>
just returns <code>nil</code>.  (It would be slightly simpler to proceed using the first proceed
type whether it is local or not.  But in the case of a local proceed type, this
would just mean returning the proceed type instead of <code>nil</code>.  It is considered
slightly more useful to return <code>nil</code>, allowing the signaler to distinguish the case of
a condition not handled.  The signaler knows which proceed types it specified,
and can easily consider <code>nil</code> as equivalent to the first of them.)
</p>
<p>Otherwise, by this stage, a proceed type has been chosen from the available list.
If the proceed type was among those specified by the caller of <code>signal-condition</code>,
then proceeding consists simply of returning to that caller.  The chosen proceed
type is the first value, and arguments (returned by the handler along with the
proceed type) may follow it.  If the proceed type was implemented nonlocally
with <code>condition-resume</code> (see <a href="#condition_002dresume_002dfun">condition-resume-fun</a>), then the associated
proceed handler function on <code>eh:condition-resume-handlers</code> is called.
</p>
<p>If <em>inhibit-resume-handlers</em> is non-<code>nil</code>, resume handlers are not invoked.  If a
handler returns a nonlocal proceed type, <code>signal-condition</code> just returns to its caller
as if the proceed type were local.  If the condition is not handled,
<code>signal-condition</code> returns <code>nil</code>.
</p>
<p>The purpose of <code>condition-bind-default</code> is so that you can define a
handler that will handle an error only if it is not handled by any of the callers&rsquo; handlers.
A more flexible technique for doing this sort of thing is to make the condition
handler signal the same condition instance recursively by calling
<code>signal-condition</code>, like this:
</p><div class="lisp">
<pre class="lisp">(multiple-value-list 
  (signal-condition <em>condition-instance</em>
                    eh:condition-proceed-types nil nil t))
</pre></div>
<p>This passes along the same list of proceed types specified by the original
signaler, prevents the debugger from being called, and prevents resume handlers
from being run.  If the first value <code>signal-condition</code> returns is non-<code>nil</code>, one of
the outer handlers has handled the condition; your handler&rsquo;s simplest option is to
return those same values so that the other handler has its way (but you could
also examine them and return modified values).  Otherwise, you go on to handle
the condition in your default manner.
</p>
<a name="eh_003atrace_002dconditions_002dvar"></a><dl>
<dt><a name="index-eh_003atrace_002dconditions"></a>Variable: <strong>eh:trace-conditions</strong></dt>
<dd><p>This variable may be set to a list of condition names to be <em>traced</em>.
Whenever a condition possessing a traced condition name is signaled,
an error is signaled to report the fact.  (Tracing of conditions is turned off when
this error is signaled).  Proceeding with proceed type <code>:no-action</code> causes the
signaling of the original condition to continue.
</p>
<p>If <code>eh:trace-conditions</code> is <code>t</code>, all conditions are traced.
</p></dd></dl>

<a name="Proceeding"></a>
<h3 class="section">27.6 Proceeding</h3>
<a name="index-proceed-types"></a>
<a name="proceeding"></a>
<p>Both condition handlers and the user (through the debugger) have the
option of proceeding certain conditions.
</p>
<p>Each condition name can define, as a convention, certain <em>proceed types</em>, which are
keywords that signify a certain conceptual way to proceed.  For example,
condition name <code>sys:wrong-type-argument</code> defines the proceed type
<code>:argument-value</code> which means, &quot;Here is a new value to use as the argument.&quot;
</p>
<p>Each signaler may or may not implement all the proceed types which are
meaningful in general for the condition names being signaled.  For example, it is
futile to proceed from a <code>sys:wrong-type-argument</code> error with <code>:argument-value</code>
unless the signaler knows how to take the associated value and store it into the
argument, or do something else that fits the conceptual specifications of
<code>:argument-value</code>.  For some signalers, it may not make sense to do this at all.
Therefore, one of the arguments to <code>signal-condition</code> is a list of the proceed
types that this particular signaler knows how to handle.
</p>
<p>In addition to the proceed types specified by the individual signaler, other
proceed types can be provided nonlocally; they are implemented by a <em>resume
handler</em> which is in effect through a dynamic scope.  See below,
<a href="#nonlocal_002dproceed">nonlocal-proceed</a>.
</p>
<p>A condition handler can use the operations <code>:proceed-types</code> and <code>:proceed-type-p</code>
on the condition instance to find out which proceed types are available.  It can
request to proceed by returning one of the available proceed types as a value.
This value is returned from <code>signal-condition</code>, and the condition&rsquo;s signaler can
take action as appropriate.
</p>
<p>If the handler returns more than one value, the remaining values are
considered <em>arguments</em> of the proceed type.  The meaning of the
arguments to a proceed type, and what sort of arguments are expected,
are part of the conventions associated with the condition name that
gives the proceed type its meaning.  For example, the <code>:argument-value</code>
proceed type for <code>sys:wrong-type-argument</code> errors conventionally takes
one argument, which is the new value to use.  All the values returned by
the handler are returned by <code>signal-condition</code> to the signaler.
</p>
<p>Here is an example of a condition handler that proceeds from
<code>sys:wrong-type-argument</code> errors.  It makes any atom effectively equivalent to
<code>nil</code> when used in <code>car</code> or any other function that expects a list.  The handler uses
the <code>:description</code> operation, which on <code>sys:wrong-type-argument</code> condition
instances returns a keyword describing the data type that was desired.
</p><div class="lisp">
<pre class="lisp">(condition-bind
    ((sys:wrong-type-argument
	 #'(lambda (condition)
	       (if (eq (send condition ':description) ':cons)
		   (values ':argument-value nil)))))
<em>  body</em>...)
</pre></div>
<p>Here the argument to the <code>:argument-value</code> proceed type is <code>nil</code>.
</p>
<dl>
<dt><a name="index-_003aproceed_002dtypes-on-condition"></a>Method on condition: <strong>:proceed-types</strong></dt>
<dd><p>Returns a list of the proceed types available for this condition instance.
This operation should be used only within the signaling of the condition
instance, as it refers to the special variable in which <code>signal-condition</code>
stores its second argument.
</p></dd></dl>

<dl>
<dt><a name="index-_003aproceed_002dtype_002dp-on-condition"></a>Method on condition: <strong>:proceed-type-p</strong> <em>proceed-type</em></dt>
<dd><p><code>t</code> if <em>proceed-type</em> is one of the proceed types available for this condition instance.
This operation should be used only within the signaling of the condition
instance, as it refers to the special variable in which <code>signal-condition</code>
stores its second argument.
</p></dd></dl>

<a name="Proceeding-and-the-Debugger"></a>
<h4 class="subsection">27.6.1 Proceeding and the Debugger</h4>

<p>If the condition invokes the debugger, then the user has the
opportunity to proceed.  This too uses a proceed type.  When the
debugger is entered, each of the available proceed types is assigned a
command character starting with <code>Super-A</code>.  Each character becomes a
command to proceed using the corresponding proceed type.
</p>
<p>Three additional facilities are required to make it convenient for the
user to proceed using the debugger.  Each is provided by methods
defined on condition flavors.  When you define a new condition flavor,
you must provide methods to implement these facilities.
</p><dl compact="compact">
<dt><span class="roman">Documentation:</span></dt>
<dd><p>It must be possible to tell the user what each proceed type is <em>for</em>.
</p></dd>
<dt><span class="roman">Prompting for arguments:</span></dt>
<dd><p>The user must be asked for the arguments for the proceed type.
Each proceed type may have different arguments to ask for.
</p></dd>
<dt><span class="roman">Not always the same proceed types:</span></dt>
<dd><p>Usually the user can choose among the same set of proceed types that a
handler can, but sometimes it is useful to provide the user with a
few extra ones, or to suppress some of them for him.
</p></dd>
</dl>

<p>These three facilities are provided by methods defined on condition
flavors.  Each proceed type that is provided by signalers should be
accompanied by suitable methods.  This means that you must normally
define a new flavor if you wish to use a new proceed type.
</p>
<p>The <code>:document-proceed-type</code> operation is supposed to print
documentation of what a proceed type is for.  For example, when sent to
a condition instance describing an unbound-variable error, if the
proceed type specified is <code>:new-value</code>, the text printed will be something
like &quot;Proceed, reading a value to use instead.&quot;
</p>
<dl>
<dt><a name="index-_003adocument_002dproceed_002dtype-on-condition"></a>Method on condition: <strong>:document-proceed-type</strong> <em>proceed-type stream</em></dt>
<dd><p>Prints on <em>stream</em> a description of the purpose of proceed type <em>proceed-type</em>.  This
operation uses <code>:case</code> method combination (see <a href="#method_002dcombination">method-combination</a>), to
make it convenient to define the way to document an individual proceed type.
The string printed should start with a third person singular verb form, in lower
case, and end with a period.
</p>
<p>As a last resort, if the condition instance has a <code>:case</code> method for
<code>:proceed-asking-user</code> with <em>proceed-type</em> as the suboperation, and this
method has a documentation string, it is printed.  This is in fact the
usual way that a proceed type is documented.
</p></dd></dl>

<p>The <code>:proceed-asking-user</code> operation is supposed to ask for suitable
arguments to pass with the proceed type.  Sending <code>:proceed-asking-user</code>
to an instance of <code>sys:unbound-variable</code> with argument <code>:new-value</code> would
read and evaluate one expression, prompting appropriately.
</p>
<dl>
<dt><a name="index-_003aproceed_002dasking_002duser-on-condition"></a>Method on condition: <strong>:proceed-asking-user</strong> <em>proceed-type cont read-object-fn</em></dt>
<dd><p>The method for <code>:proceed-asking-user</code> embodies the knowledge of how to
prompt for and read the additional arguments that go with <em>proceed-type</em>.
</p>
<p><code>:case</code> method combination is used (see <a href="#method_002dcombination">method-combination</a>), making it
possible to define the handling of each proceed type individually in a separate
function.  The documentation string of the <code>:case</code> method for a proceed type is
also used as the default for <code>:document-proceed-type</code> on that proceed type.
</p>
<p>The method for <code>:proceed-asking-user</code> should read values by calling
<em>read-object-fn</em>, using a calling sequence like that of <code>prompt-and-read</code>.
The <em>read-object-fn</em> may or may not actually use <code>prompt-and-read</code>.
After reading the appropriate number and sort of values to go with the
particular proceed type, the method should call the continuation <em>cont</em>
with a proceed type and suitable arguments (presumably based on what
the user typed).  The proceed type passed to <em>cont</em> need not be the same
as the one given to <code>:proceed-asking-user</code>; it should be one of the
proceed types available for handlers to use.
</p></dd></dl>

<p>Here is how <code>sys:proceed-with-value-mixin</code> provides for the proceed type
<code>:new-value</code>:
</p><div class="lisp">
<pre class="lisp">(defmethod (proceed-with-value-mixin 
		 :case :proceed-asking-user :new-value)
	   (continuation read-object-function)
  &quot;Proceeds, reading a value to use instead.&quot;
  (funcall continuation ':new-value
	   (funcall read-object-function
		    ':eval-read
		    &quot;~&amp;Form whose value to use instead: &quot;)))
</pre></div>
<p>Note the documentation string, which is provided for the sake of
the <code>:document-proceed-type</code> operation.
</p>
<p>The <code>:user-proceed-types</code> operation is given the list of proceed types
actually available and is supposed to return the list of proceed types to
offer to the user.  By default, this operation returns its argument: all
proceed types are available to the user through the debugger.
</p>
<p>For example, the condition name <code>sys:unbound-variable</code> conventionally
defines the proceed types <code>:new-value</code> and <code>:no-action</code>.  The first
specifies a new value; the second attempts to use the variable&rsquo;s current
value and gets another error if the variable is still unbound.  These are
clean operations for handlers to use.  But it is more convenient for the
user to be offered only one choice, which will use the variable&rsquo;s new
value if it is bound now, but otherwise ask for a new value.  This is
implemented with a <code>:user-proceed-types</code> method that replaces the two
proceed types with a single one.
</p>
<p>Or, you might wish to offer the user two different proceed types
that differ only in how they ask the user for additional information.
For handlers, there would be only one proceed type.
</p>
<dl>
<dt><a name="index-_003auser_002dproceed_002dtypes-on-condition"></a>Method on condition: <strong>:user-proceed-types</strong> <em>proceed-types</em></dt>
<dd><p>Assuming that <em>proceed-types</em> is the list of proceed types available for
condition handlers to return, this operation returns the list of
proceed types that the debugger should offer to the user.
</p>
<p>Only the proceed types offered to the user need to be handled
by <code>:document-proceed-type</code> and <code>:proceed-asking-user</code>.
</p>
<p>The flavor <code>condition</code> itself defines this to return its argument.
Other condition flavors may redefine this to filter the argument
in some appropriate fashion.
</p>
<p><code>:pass-on</code> method combination is used (see <a href="#method_002dcombination">method-combination</a>), so
that if multiple mixins define methods for <code>:user-proceed-types</code>, each method
will get a chance to add or remove proceed types.  The methods should not
actually modify the argument, but should cons up a new list in which certain
keywords are added or removed according to the other keywords that are there.
</p>
<p>Elements should be removed only if they are specifically recognized.
This is to say, the method should make sure that any unfamiliar elements
present in the argument are also present in the value.  Arranging to omit
certain specific proceed types is legitimate; returning only
the intersection with a constant list is not legitimate.
</p></dd></dl>

<p>Here is an example of nontrivial use of <code>:user-proceed-types</code>:
</p><div class="lisp">
<pre class="lisp">(defflavor my-error () (error))

(defmethod (my-error :user-proceed-types) (proceed-types)
  (if (memq ':foo proceed-types)
      (cons ':foo-two-args proceed-types)
    proceed-types))

(defmethod (my-error :case :proceed-asking-user :foo) 
	       (cont read-object-fn)
  &quot;Proceeds, reading a value to foo with.&quot;
  (funcall cont ':foo
	   (funcall read-object-fn ':eval-read
		    &quot;Value to foo with: &quot;)))

(defmethod (my-error :case :proceed-asking-user :foo-two-args)
	       (cont read-object-fn)
  &quot;Proceeds, reading two values to foo with.&quot;
  (funcall cont ':foo
	   (funcall read-object-fn ':eval-read
		    &quot;Value to foo with: &quot;)
	   (funcall read-object-fn ':eval-read
		    &quot;Value to foo some more with: &quot;)))
</pre></div>

<p>In this example, if the signaler provides the proceed type <code>:foo</code>, then it is
described for the user as &quot;proceeds, reading a value to foo with&quot;; and if
the user specifies that proceed type, he will be asked for a single value,
which will be used as the argument when proceeding.  In addition, the
user will be offered the proceed type <code>:foo-two-args</code>, which has its own
documentation and which reads two values.  But for condition handlers
there is really only one proceed type, <code>:foo</code>.  <code>:foo-two-args</code> is just an
alternate interface for the user to proceed type <code>:foo</code>, and this is why the
<code>:user-proceed-types</code> method offers <code>:foo-two-args</code> only if the signaler
will accept <code>:foo</code>.
</p>
<a name="How-Signalers-Provide-Proceed-Types"></a>
<h4 class="subsection">27.6.2 How Signalers Provide Proceed Types</h4>

<p>Each condition name defines a conceptual meaning for certain
proceed types, but this does not mean that all of those proceed types
may be used every time the condition is signaled.  The signaler must
specifically implement the proceed types in order to make them do what
they are conventionally supposed to do.  For some signalers it may be
difficult to do, or may not even make sense.  For example, it is no use
having a proceed type <code>:store-new-value</code> if the signaler does not have a
suitable place to store, permanently, the argument the handler supplies.
</p>
<p>Therefore, we require each signaler to specify just which proceed types
it implements.  Unless the signaler explicitly specifies proceed types
one way or another, no proceed types are allowed (except for nonlocal ones,
described in the following section).
</p>
<p>One way to specify the proceed types allowed is to call <code>signal-condition</code> and
pass the list of proceed types as the second argument.
</p>
<p>Another way that is less general but more convenient is
<code>signal-proceed-case</code>.
</p>
<a name="signal_002dproceed_002dcase_002dfun"></a><dl>
<dt><a name="index-signal_002dproceed_002dcase"></a>Special Form: <strong>signal-proceed-case</strong> <em>((variables...) make-condition-arguments...) clauses...</em></dt>
<dd><p><code>signal-proceed-case</code> is a convenient special form for signaling a
condition and providing proceed types.  Each clause specifies a
proceed type to provide, and also contains code to be run if a handler
should proceed with that proceed type.
</p>
<div class="lisp">
<pre class="lisp">(signal-proceed-case ((<em>argument</em>-<em>vars...</em>)
                     <em>signal-name</em> <em>signal-name-arguments</em>...)
  (<em>proceed-type</em> <em>forms</em>...)
  (<em>proceed-type</em> <em>forms</em>...)
  ...)
</pre></div>

<p>A condition-object is created with <code>make-condition</code> using the
<em>signal-name</em> and <em>signal-name-arguments</em>; then it is signaled giving a list
of the proceed types from all the clauses as the list of proceed types
allowed.
</p>
<p>The variables <em>argument-vars</em> are bound to the values
returned by <code>signal-condition</code>, except for the first value, which is tested
against the <em>proceed-type</em> from each clause, using a <code>selectq</code>.  The clause that
matches is executed.
</p></dd></dl>

<div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp">(defsignal my-wrong-type-arg 
           (eh:wrong-type-argument-error sys:wrong-type-argument)
  (old-value arg-name description)
  &quot;Wrong type argument from my own code.&quot;)


(signal-proceed-case
	 ((newarg)
	  'my-wrong-type-arg
	  &quot;The argument ~A was ~S, which is not a cons.&quot;
	  'foo foo 'cons)
  (:argument-value (car newarg)))
</pre></div>
<p>The signal name <code>my-wrong-type-arg</code> creates errors with condition name
<code>sys:wrong-type-argument</code>.  The <code>signal-proceed-case</code> shown signals such an
error, and handles the proceed type <code>:argument-value</code>.  If a handler proceeds
using that proceed type, the handler&rsquo;s value is put in <code>newarg</code>, and then its car is
returned from the <code>signal-proceed-case</code>.
</p>
<a name="Nonlocal-Proceed-Types"></a>
<h4 class="subsection">27.6.3 Nonlocal Proceed Types</h4>
<a name="nonlocal_002dproceed"></a>
<p>When the caller of <code>signal-condition</code> specifies proceed types, these are called
<em>local proceed types</em>.  They are implemented at the point of signaling.  There are
also <em>nonlocal proceed types</em>, which are in effect for all conditions (with
appropriate condition names) signaled during the execution of the body of the
establishing special form.
</p>
<p>The most general form for establishing a resume handler is <code>condition-resume</code>.
For example, in
</p><div class="lisp">
<pre class="lisp">(condition-resume
    '(fs:file-error :retry-open t
		    (&quot;proceeds, opening the file again.&quot;)
		    (lambda (ignore) (*throw 'tag nil)))
  (do-forever
    (*catch 'tag (return (open pathname)))))
</pre></div>
<p>the proceed type <code>:retry-open</code> is available for all <code>fs:file-error</code> conditions signaled
within the call to <code>open</code>.
</p>
<a name="condition_002dresume_002dfun"></a><dl>
<dt><a name="index-condition_002dresume"></a>Special Form: <strong>condition-resume</strong> <em>handler-form &amp;body body</em></dt>
<dd><a name="condition_002dresume_002dif_002dfun"></a></dd><dt><a name="index-condition_002dresume_002dif"></a>Special Form: <strong>condition-resume-if</strong> <em>cond-form handler-form &amp;body body</em></dt>
<dd><p>Executes <em>body</em> with a resume handler in effect for a nonlocal proceed type according to
the value of <em>handler-form</em>.  For <code>condition-resume-if</code>, the resume handler is in
effect only if <em>cond-form</em>&rsquo;s value is non-<code>nil</code>.
</p>
<p>The value of the <em>handler-form</em> should be a list with at least five elements:
</p><div class="lisp">
<pre class="lisp">(<em>condition-names</em> <em>proceed-type</em> <em>predicate</em> <em>format-string-and-args</em> 
 <em>handler-function</em> <em>additional-args</em>)
</pre></div>

<p><em>condition-names</em> is a condition name or a list of them.  The resume handler
applies to those conditions only.
</p>
<p><em>proceed-type</em> is the proceed type implemented by this resume handler.
</p>
<p><em>predicate</em> is either <code>t</code> or a function that is applied to a condition instance and
determines whether the resume handler is in effect for that condition instance.
</p>
<p><em>format-string-and-args</em> is a list of a string and additional arguments that can be
passed to <code>format</code> to print a description of what this proceed type is for.
</p>
<p><em>handler-function</em> is the function called to do the work of proceeding, once this
proceed type has been returned by a condition handler or the debugger.
Its arguments are the condition instance and the <em>additional-args</em>.
</p></dd></dl>

<p>For condition handlers there is no distinction between local and nonlocal
proceed types.  They are both included in the list of available proceed types
returned by the <code>:proceed-types</code> operation (all the local proceed types come
first), and the condition handler selects one by returning the proceed type and
any conventionally associated arguments.  The debugger&rsquo;s <code>:user-proceed-types</code>,
<code>:document-proceed-type</code> and <code>:proceed-asking-user</code> operations are also used the
same way.
</p>
<p>The difference comes after the handler or the debugger returns
to <code>signal-condition</code>.  If the proceed type is a local one (one of those in the
second argument to <code>signal-condition</code>), <code>signal-condition</code> simply returns.
If the proceed type is not there, <code>signal-condition</code> looks for the <em>handler-function</em>
associated with the proceed type, and calls it.  The arguments to the handler
function are the condition instance, the <em>additional-args</em> specified in the resume
handler, and any arguments returned by the condition handler in addition to
the proceed type.  The handler function is supposed to do a throw.  If it returns
to <code>signal-condition</code>, an error is signaled.
</p>
<p>You are allowed to use &quot;anonymous&quot; nonlocal proceed types, which have no
conventional meaning and are not specially known to the
<code>:document-proceed-type</code> and <code>:proceed-asking-user</code> operations.  The anonymous
proceed type need not even be a symbol, and in practice they are frequently
lists consed at run time (often using <code>with-stack-list</code>) to make sure they are all
distinct.  The default definition of <code>:proceed-asking-user</code> handles an anonymous
proceed type by simply calling the continuation passed to it, reading no
arguments.  The default definition of <code>:document-proceed-type</code> handles
anonymous proceed types by passing <code>format</code> the <em>format-string-and-args</em> list
found in the resume handler (this is what that list is for).
</p>
<p>Anonymous proceed types are treated like other proceed types
except as noted above.  Proceed types that are lists are treated a little bit
specially.  For one thing, they are all put at the end of the list returned by the
<code>:proceed-types</code> operation.  For another, the debugger command <code>Control-C</code> or
<code>Resume</code>, which normally proceeds using the first proceed type on that list, will
not operate at all if that proceed type is a list.
</p>
<p>Anonymous proceed types are usually created with some variant of <code>error-restart</code>.
</p>
<a name="error_002drestart_002dfun"></a><dl>
<dt><a name="index-error_002drestart"></a>Special Form: <strong>error-restart</strong> <em>(condition-names format-string format-args...) body...</em></dt>
<dd><a name="error_002drestart_002dloop_002dfun"></a></dd><dt><a name="index-error_002drestart_002dloop"></a>Special Form: <strong>error-restart-loop</strong></dt>
<dd><a name="catch_002derror_002drestart_002dfun"></a></dd><dt><a name="index-catch_002derror_002drestart"></a>Special Form: <strong>catch-error-restart</strong></dt>
<dd><a name="catch_002derror_002drestart_002dif_002dfun"></a></dd><dt><a name="index-catch_002derror_002drestart_002dif"></a>Special Form: <strong>catch-error-restart-if</strong> <em>cond-form (condition-names format-string format-args...) body...</em></dt>
<dd><p>Executes body with an anonymous resume handler for <em>condition-names</em>.
<em>condition-names</em> is either a single condition name or a list of them, or <code>nil</code>
meaning all conditions; it is not evaluated.
</p>
<p><em>format-string</em> and the <em>format-args</em>, all of which are evaluated, are used by the
<code>:document-proceed-type</code> operation to describe the anonymous proceed type.
</p>
<p>If the proceed type is used for proceeding, the automatically generated resume
handler function does a throw back to the <code>error-restart</code> and the body is
executed again from the beginning.  If body returns, the values of the last form
in it are returned from the <code>error-restart</code> form.
</p>
<p><code>error-restart-loop</code> is like <code>error-restart</code> except that it loops to the beginning of
body even if body completes normally.  It is like enclosing an <code>error-restart</code> in a
<code>do-forever</code>.
</p>
<p><code>catch-error-restart</code> is like <code>error-restart</code> except that it never loops back to the
beginning.  If the anonymous proceed type is used for proceeding, the
<code>catch-error-restart</code> form returns with <code>nil</code> as the first value and a non-<code>nil</code> second
value.
</p>
<p><code>catch-error-restart-if</code> is like <code>catch-error-restart</code> except that the resume
handler is only in effect if the value of the <em>cond-form</em> is non-<code>nil</code>.
</p>
<p>All of these variants of <code>error-restart</code> can be written in terms of
<code>condition-resume-if</code>.
</p></dd></dl>

<p><code>error-restart</code> forms often specify <code>(error sys:abort)</code> as the <em>condition-names</em>.
The presence of <code>error</code> causes them to be listed (and assigned command
characters) by the debugger, for all errors, and the presence of <code>sys:abort</code> causes
the <code>Abort</code> key to use them.  These forms are typically used by any sort of
command loop, so that aborting within the command loop returns to it and reads
another command.  <code>error-restart-loop</code> is often right for simple command loops.
<code>catch-error-restart</code> is useful when aborting should terminate execution rather
than retry, or with an explicit conditional to test whether a throw was done.
</p>
<a name="eh_003ainvoke_002dresume_002dhandler_002dfun"></a><dl>
<dt><a name="index-eh_003ainvoke_002dresume_002dhandler"></a>Function: <strong>eh:invoke-resume-handler</strong> <em>condition-instance proceed-type &amp;rest args</em></dt>
<dd><p>Invokes the innermost applicable resume handler for <em>proceed-type</em>.
Applicability of a resume handler is determined by matching its condition names
against those possessed by <em>condition-instance</em> and by applying its predicate, if not
<code>t</code>, to <em>condition-instance</em>.
</p>
<p>If <em>proceed-type</em> is <code>nil</code>, the innermost applicable resume handler is invoked
regardless of its proceed type.  However, in this case, the scan stops if <code>t</code> is
encountered as an element of <code>eh:condition-resume-handlers</code>.
</p></dd></dl>

<a name="eh_003acondition_002dresume_002dhandlers_002dvar"></a><dl>
<dt><a name="index-eh_003acondition_002dresume_002dhandlers"></a>Variable: <strong>eh:condition-resume-handlers</strong></dt>
<dd><p>The current list of resume handlers for nonlocal proceed types.
<code>condition-resume</code> works by binding this variable.  Elements are usually lists
that have the format described above under <code>condition-resume</code>.  The symbol <code>t</code>
is also meaningful as an element of this list.  It terminates the scan for a resume
handler when it is made by <code>signal-condition</code> for a condition that was not
handled.  <code>t</code> is pushed onto the list by break loops and the debugger to shield the
evaluation of your type-in from automatic invocation of resume handlers
established outside the break loop or the error.
</p>
<p>The links of this list, and its elements, are often created with <code>with-stack-list</code>.
so be careful if you try to save the value outside the context in which you
examine it.
</p></dd></dl>

<dl>
<dt><a name="index-_0028condition_0029-on-sys_003aabort"></a>Condition on sys:abort: <strong>(<code>condition</code>)</strong></dt>
<dd><p>This condition is signaled by the <code>Abort</code> key; it is how that key is implemented.
Most command loops use some version of <code>error-restart</code> to set up a resume
handler for <code>sys:abort</code> so that it will return to the innermost command loop if (as
is usually the case) no handler handles it.  These resume handlers usually apply
to <code>error</code> as well as <code>sys:abort</code>, so that the debugger will offer a specific command
to return to the command loop.
</p></dd></dl>


<a name="The-Debugger"></a>
<h3 class="section">27.7 The Debugger</h3>
<a name="index-debugger"></a>
<a name="debugger"></a>
<p>When an error condition is signalled and no handlers decide to
handle the error, an interactive debugger is entered to allow the user to
look around and see what went wrong, and to help him continue the program
or abort it.  This section describes how to use the debugger.
</p>
<a name="Entering-the-Debugger"></a>
<h4 class="subsection">27.7.1 Entering the Debugger</h4>

<p>There are two kinds of errors; those generated by the Lisp Machine&rsquo;s
microcode, and those generated by Lisp programs (by using <code>ferror</code> or
related functions).  When there
is a microcode error, the debugger prints out a message such as the following:
</p><div class="lisp">
<pre class="lisp">&gt;&gt;TRAP 5543 (TRANS-TRAP)
The symbol FOOBAR is unbound.
While in the function *EVAL leftArrow SI:LISP-TOP-LEVEL1
</pre></div>

<p>The first line of this error message indicates entry to
the debugger and contains some mysterious internal microcode information:
the micro program address, the microcode trap name and parameters, and a microcode backtrace.
Users can ignore this line in most cases.  The second line contains a description
of the error in English.  The third line indicates where the error
happened by printing a very abbreviated &quot;backtrace&quot; of the stack (see
below); in the example, it is saying that the error was signalled inside the
function <code>*eval</code>, which was called by <code>si:lisp-top-level1</code>.
</p>
<p>Here is an example of an error from Lisp code:
</p><div class="lisp">
<pre class="lisp">&gt;&gt;ERROR: The argument X was 1, which is not a symbol,
While in the function FOO leftArrow *EVAL leftArrow SI:LISP-TOP-LEVEL1
</pre></div>

<p>Here the first line contains the English description of the
error message, and the second line contains the abbreviated backtrace.
<code>foo</code> signalled the error by calling <code>ferror</code>; however, <code>ferror</code>
is censored out of the backtrace.
</p>
<p>After the debugger&rsquo;s initial message, it prints the function that
got the error and its arguments.  Then it prints a list of commands you
can use to proceed from the error, or to abort to various command loops.  The
possibilities depend on the kind of error and where it happened, so the
list is different each time; that is why the debugger prints it.  The
commands in the list all start with <code>Super-A</code>, <code>Super-B</code> and continue as far
as is necessary.
</p>
<a name="eh_003a_002ainhibit_002ddebugger_002dproceed_002dprompt_002a_002dvar"></a><dl>
<dt><a name="index-eh_003a_002ainhibit_002ddebugger_002dproceed_002dprompt_002a"></a>Variable: <strong>eh:*inhibit-debugger-proceed-prompt*</strong></dt>
<dd><p>If this is non-<code>nil</code>, the list of <code>Super</code> commands is not printed
when the debugger is entered.  Type <code>Help X</code> to see the list.
</p></dd></dl>

<a name="debug_002dio_002dvar_002d1"></a><dl>
<dt><a name="index-debug_002dio-1"></a>Variable: <strong>debug-io</strong></dt>
<dd><p>The debugger uses this stream for its I/O.  Normally, the value is a
synonym stream which indirects to the value of <code>terminal-io</code>.
</p>
<p>The value of this variable in the stack group in which the error was
signaled is the one that counts.
</p></dd></dl>

<p>The debugger can be manually entered either by causing an error
(e.g by typing a ridiculous symbol name such as <code>ahsdgf</code> at the Lisp
read-eval-print loop) or by typing the <code>Break</code> key with the <code>Meta</code> shift
held down while the program is reading from the terminal.  Typing the <code>Break</code>
key with both <code>Control</code> and <code>Meta</code> held down will force the program
into the debugger immediately, even if it is running.  If the <code>Break</code>
key is typed without <code>Meta</code>, it puts you into a read-eval-print loop
using the <code>break</code> function (see <a href="#break_002dfun">break-fun</a>) rather into the debugger.
</p>
<a name="eh_002dfun"></a><dl>
<dt><a name="index-eh"></a>Function: <strong>eh</strong> <em>process</em></dt>
<dd><p>Stops <em>process</em> and calls the debugger on it so that you can look at its
current state.  Exit the debugger with the <code>Control-Z</code> command and <code>eh</code>
will release the process and return.  <em>process</em> can be a window, in which
case the window&rsquo;s process will be used.
</p>
<p>If <em>process</em> is not a process but a stack group, the current state of the
stack group will be examined.  The caller should ensure that no one tries
to resume that stack group while the debugger is looking at it.
</p></dd></dl>

<a name="How-to-Use-the-Debugger"></a>
<h4 class="subsection">27.7.2 How to Use the Debugger</h4>

<p>Once inside the debugger, the user may give a wide variety
of commands.  This section describes how to give the commands, then
explains them in approximate order of usefulness.  A summary is provided
at the end of the listing.
</p>
<p>When the debugger is waiting for a command, it prompts
with an arrow:
</p>
<div class="lisp">
<pre class="lisp"><code> rightArrow</code>
</pre></div>

<p>If the error took place in the evaluation of an expression that you
typed at the debugger, you are in a second (or deeper) level error.
The number of arrows in the prompt indicates the depth.
</p>
<p>The debugger will also warn you about certain unusual circumstances that
may cause paradoxical results.  If <code>default-cons-area</code> is anything except
<code>working-storage-area</code>, a message to that effect is printed.
If <code>base</code> and <code>ibase</code> are not the same, a message is printed.
</p>
<p>At this point, you may type either a Lisp expression or a
command; a <code>Control</code> or <code>Meta</code> character is interpreted as a command,
whereas most normal characters are interpreted as the first character of
an expression.  If you type the <code>Help</code> key or the <code>?</code> key, you will
get some introductory help with the debugger.
</p>
<p>If you type a Lisp expression, it will be interpreted as a Lisp form
and will be evaluated in the context of the function which got the
error.  That is, all bindings which were in effect at the time of the
error will be in effect when your form is evaluated, with certain
exceptions explained below.  The result of the evaluation will be
printed, and the debugger will prompt again with an arrow.  If, during
the typing of the form, you change your mind and want to get back to the
debugger&rsquo;s command level, type the <code>Abort</code> key or a <code>Control-G</code>; the debugger will respond
with an arrow prompt.  In fact, at any time that typein is expected from
you, while you are in the debugger, you may type <code>Abort</code> or <code>Control-G</code> to flush
what you are doing and get back to command level.  This
<code>read-eval-print</code> loop maintains the values of <code>+</code>, <code>*</code>, and
<code>-</code> just as the top-level one does.
</p>
<p>If an error occurs in the evaluation of the Lisp expression you type,
you will get into a second invocation of the debugger, looking at the
new error.  The prompt will be &quot;<code>rightArrowrightArrow</code>&quot;.  You can abort the
computation and get back to the first error by typing the <code>Abort</code>
key (see below).  However, if the error is trivial the abort will be
done automatically and the original error message will be reprinted.
</p>
<p>Various debugger commands ask for Lisp objects, such as an
object to return or the name of a catch-tag.  Whenever it tries to get
a Lisp object from you, it expects you to type in a <em>form</em>; it will
evaluate what you type in.  This provides greater generality, since
there are objects to which you might want to refer that cannot be
typed in (such as arrays).  If the form you type is non-trivial (not
just a constant form), the debugger will show you the result of
the evaluation, and ask you if it is what you intended.  It expects a <code>Y</code>
or <code>N</code> answer (see the function <code>y-or-n-p</code>, <a href="#y_002dor_002dn_002dp_002dfun">y-or-n-p-fun</a>), and if you answer negatively
it will ask you for another form.  To quit out of the command, just type
<code>Abort</code> or <code>Control-G</code>.
</p>

<p>Note that the variable bindings are those in effect at the point of
error, <em>not</em> those of the current frame being looked at.  The <code>Meta-S</code>
and <code>Control-Meta-S</code> commands allow you to look at the bindings in effect
at the current frame.  A few variables are rebound by the debugger itself,
so you you must use <code>Meta-S</code> to find the values they had at the point of error:
</p>
<dl compact="compact">
<dt><code>terminal-io</code></dt>
<dd><p><code>terminal-io</code> is rebound to the stream the debugger is using.
</p>
</dd>
<dt><code>standard-input</code></dt>
<dt><code>standard-output</code></dt>
<dd><p><code>standard-input</code> and <code>standard-output</code> are rebound to be synonymous with
<code>terminal-io</code>.
</p>
</dd>
<dt><code>+</code></dt>
<dt><code>*</code></dt>
<dd><p><code>+</code> and <code>*</code> are rebound to the debugger&rsquo;s previous form and
previous value.  When the debugger is first entered, <code>+</code> is the last
form typed, which is typically the one that caused the error, and
<code>*</code> is the value of the <em>previous</em> form.
</p>
</dd>
<dt><code>evalhook</code></dt>
<dt><code>si:applyhook</code></dt>
<dd><p>These variables (see <a href="#evalhook_002dvar">evalhook-var</a>) are rebound to <code>nil</code>, turning off
the <code>step</code> facility if it was in use when the error occurred.
</p>
</dd>
<dt><code>eh:condition-handlers</code></dt>
<dt><code>eh:condition-default-handlers</code></dt>
<dd><p>These are rebound to <code>nil</code>,
so that errors occurring within forms you type while in the debugger do not
magically resume execution of the erring program.
</p>
</dd>
<dt><code>eh:condition-resume-handlers</code></dt>
<dd><p>To prevent resume handlers established outside the error from being invoked
automatically by deeper levels of error, this variable is rebound to a new value,
which has an element <code>t</code> added in the front.
</p></dd>
</dl>

<a name="g_t_0022Debugger-Commands_0022"></a>
<h4 class="subsection">27.7.3 &quot;Debugger Commands&quot;</h4>

<p>All debugger commands are single characters, usually with the <code>Control</code> or
<code>Meta</code> bits.  The single most useful command is <code>Abort</code> (or <code>Control-Z</code>),
which exits from the debugger and throws out of the computation that got
the error.  This is the <code>Abort</code> key, not a 5-letter command.  Often you are not
interested in using the debugger at all and just want to get back to
Lisp top level; so you can do this in one character.  
</p>
<p>If the error happened while you were innocently using a system utility
such as the editor, then it represents a bug in the system.  Report the
bug using the debugger command <code>Control-M</code>.  This gives you an editor
preinitialized with the error message and a backtrace.  You should type
in a <em>precise</em> description of what you did that led up to the problem,
then send the message by typing <code>End</code>.  Be as complete as possible,
and always give the exact commands you typed, exact filenames, etc.
rather then general descriptions, as much as possible.  The person who
investigates the bug report will have to try to make the problem happen
again; if he does not know where to find <em>your</em> file, he will have a
difficult time.
</p>
<p>The <code>Abort</code> command signals the <code>sys:abort</code> condition, returning
control to the most recent command loop.
This can be Lisp top level, a <code>break</code>, or the debugger command loop
associated with another error.  Typing <code>Abort</code> multiple times will throw
back to successively older read-eval-print or command loops until top level
is reached.  Typing <code>Meta-Abort</code>, on the other hand, will always throw
to top level.  <code>Meta-Abort</code> is not a debugger command, but a system
command that is always available no matter what program you are in.
</p>
<p>Note that typing <code>Abort</code> in the middle of typing a form to be evaluated
by the debugger aborts that form and returns to the debugger&rsquo;s command level,
while typing <code>Abort</code> as a debugger command returns out of the debugger
and the erring program, to the <em>previous</em> command level.
Typing <code>Abort</code> after entering a numeric argument just discards the argument.
</p>
<p>Self-documentation is provided by the <code>Help</code> or <code>?</code> command,
which types out some documentation on the debugger commands, including any
special commands that apply to the particular error currently being handled.
</p>
<p>Often you want to try to proceed from the error.  When the debugger is
entered, it prints a table of commands you can use to proceed, or abort
to various levels.  The commands are <code>Super-A</code>, <code>Super-B</code>, and so on.  How
many there are and what they do is different each time there is an
error, but the table says what each one is for.  If you want to see the
table again, type <code>Help</code> followed by X.
</p>
<p>The <code>Resume</code> (or <code>Control-C</code>) command is usually synonymous with
<code>Super-A</code>.  But <code>Resume</code> only proceeds, never aborts.  If there is no
way to proceed, just ways to abort, then <code>Resume</code> will not do anything.
</p>
<p>The debugger knows about a current stack frame, and there
are several commands that use it.  The initially current stack frame
is the one which signalled the error, either the one which got the microcode-detected
error or the one which called <code>ferror</code>, <code>cerror</code>, or <code>error</code>.
When the debugger starts it up it shows you this frame in the following format:
</p><div class="lisp">
<pre class="lisp">FOO:
   Arg 0 (X): 13
   Arg 1 (Y): 1
</pre></div>
<p>and so on.  This means that <code>foo</code> was called
with two arguments, whose names (in the Lisp source code) are <code>x</code> and <code>y</code>.
The current values of <code>x</code> and <code>y</code> are <code>13</code> and <code>1</code> respectively.  These
may not be the original arguments if <code>foo</code> happens to <code>setq</code> its argument variables.
</p>
<p>The <code>Clear-Screen</code> (or <code>Control-L</code>) command clears the screen, retypes
the error message that was initially printed when the debugger was
entered, and prints out a description of the current frame, in the
above format.
</p>
<p>Several commands are provided to allow you to examine the Lisp control
stack and to make frames current other than the one that got the error.
The control stack (or &quot;regular pdl&quot;) keeps a record of all functions currently
active.  If you call <code>foo</code> at Lisp&rsquo;s top level, and it calls <code>bar</code>,
which in turn calls <code>baz</code>, and <code>baz</code> gets an error, then a
backtrace (a backwards trace of the stack) would show all of this
information.  The debugger has two backtrace commands.  <code>Control-B</code>
simply prints out the names of the functions on the stack; in the above
example it would print
</p><div class="lisp">
<pre class="lisp">BAZ leftArrow BAR leftArrow FOO leftArrow SI:*EVAL
 leftArrow SI:LISP-TOP-LEVEL1 leftArrow SI:LISP-TOP-LEVEL
</pre></div>
<p>The arrows indicate the direction of calling.  The <code>Meta-B</code> command prints
a more extensive backtrace, indicating the names of the arguments to the functions
and their current values; for the example above it might look like:
</p><div class="lisp">
<pre class="lisp">BAZ:
   Arg 0 (X): 13
   Arg 1 (Y): 1

BAR:
   Arg 0 (ADDEND): 13

FOO:
   Arg 0 (FROB): (A B C . D)
</pre></div>
<p>and so on.
</p>
<p>Moving around in the stack:
</p>
<p>The <code>Control-N</code> command moves &quot;down&quot; to the &quot;next&quot; frame (that is, it
changes the current frame to be the frame that called it), and prints
out the frame in this same format.  <code>Control-P</code> moves &quot;up&quot; to the
&quot;previous&quot; frame (the one that this one called), and prints out the
frame in the same format.  <code>Meta-&lt;</code> moves to the top of the stack, and
<code>Meta-&gt;</code> to the bottom; both print out the new current frame.  <code>Control-S</code>
asks you for a string and searches the stack for a frame whose
executing function&rsquo;s name contains that string.  That frame becomes
current and is printed out.  These commands are easy to remember since
they are analogous to editor commands.
</p>
<p>The <code>Control-Meta-N</code>, <code>Control-Meta-P</code>, and <code>Control-Meta-B</code> commands are
like the corresponding <code>Control</code> commands but don&rsquo;t censor the stack.
When running interpreted code, the debugger usually tries to skip
over frames that belong to functions of the interpreter, such as
<code>*eval</code>, <code>prog</code>, and <code>cond</code>, and only show &quot;interesting&quot;
functions.  <code>Control-Meta-N</code>, <code>Control-Meta-P</code>, and <code>Control-Meta-B</code> show
everything.  They also show frames that are not yet active; that is,
frames whose arguments are still being computed for functions that are
going to be called.  The <code>Control-Meta-U</code> command goes up the stack
to the next interesting function and makes that the current frame.
</p>
<p><code>Meta-L</code> prints out the current frame in &quot;full screen&quot; format, which shows
the arguments and their values, the local variables and their values,
and the machine code with an arrow pointing to the next instruction to
be executed.  Refer to <a href="#understanding_002dcompiled_002dcode">understanding-compiled-code</a> for help in reading
this machine code.
</p>
<p>Commands such as <code>Control-N</code> and <code>Control-P</code>, which are meaningful
to repeat, take a prefix numeric argument and repeat that many types.
The numeric argument is typed by using <code>Control</code> or <code>Meta</code> and the number
keys, as in the editor.  Some other commands such as <code>Control-M</code> also
use the numeric argument.
</p>
<p>Resuming execution:
</p>
<p><code>Meta-C</code> is similar to <code>Control-C</code>, but in the case of an unbound
variable or undefined function, actually <code>setq</code>s the variable or
defines the function, so that the error will not happen again.
<code>Control-C</code> (or <code>Resume</code>) provides a replacement value but does not
actually change the variable.  <code>Meta-C</code> proceeds using the proceed type
<code>:store-new-value</code>, and is available only if that proceed type is
provided.
</p>
<p><code>Control-R</code> is used to return a value from the current frame; the frame
that called that frame continues running as if the function of the current frame
had returned.  This command prompts you for a form, which it will evaluate;
it returns the resulting value, possibly after confirming it with you.
</p>
<p>The <code>Control-T</code> command does a <code>*throw</code> to a given tag with a given value; you
are prompted for the tag and the value.
</p>
<p><code>Control-Meta-R</code> is a variation of <code>Control-R</code>; it starts the current frame over with
the same function and arguments.  If the function has been redefined in the meantime
(perhaps you edited it and fixed its bug) the new definition is used.  <code>Control-Meta-R</code>
asks for confirmation before doing it.
</p>
<p>Stepping through function calls and returns:
</p>
<p>You can request a trap to the debugger on exit from a particular frame,
or the next time a function is called.
</p>
<p>Each stack frame has a &quot;trap on exit&quot; bit.  The <code>Control-X</code> command
toggles this bit.  The <code>Meta-X</code> command sets the bit to cause a trap
for the current frame and all outer frames.  If a program is in an
infinite loop, this is a good way to find out how far back on the stack
the loop is taking place.  The <code>Control-Meta-X</code> command clears the
trap-on-exit bit for the current frame and outer frames.
</p>
<p>The <code>Control-D</code> command proceeds like <code>Control-C</code> but requests a
trap the next time a function is called.  The <code>Meta-D</code> command toggles
the trap-on-next-call bit for the erring stack group.  It is useful if
you wish to set the bit and then resume execution with something other
than <code>Control-C</code>.  The function <code>breakon</code> is used to request a trap
on calling a particular function.  Trapping on entry to a frame
automatically sets the trap-on-exit bit for that frame; use
<code>Control-X</code> to clear it if you do not want another trap.
</p>
<p>Transfering to other systems:
</p>
<p><code>Control-E</code> puts you into the editor, looking at the source code for the
function in the current frame.  This is useful when you have found the function
that caused the error and needs to be fixed.  The editor command <code>Control-Z</code>
will return to the debugger, if it is still there.
</p>
<p><code>Control-M</code> puts you into the editor to mail a bug report.  The error message
and a backtrace are put into the editor buffer for you.  A numeric argument
says how many frames to include in the backtrace.
</p>
<p><code>Control-Meta-W</code> calls the window debugger, a display-oriented
debugger.  It is not documented in this manual, but should be usable
without further documentation.
</p>
<p>Examining and setting the arguments, local variables, and values:
</p>
<p><code>Control-Meta-A</code> takes a numeric argument, <em>n</em>, and prints out the
value of the <em>n</em>th argument of the current frame.  It leaves <code>*</code> set
to the value of the argument, so that you can use the Lisp
<code>read-eval-print</code> loop to examine it.  It also leaves <code>+</code> set to a
locative pointing to the argument on the stack, so that you can change
that argument (by calling <code>rplacd</code> on the locative).
<code>Control-Meta-L</code> is similar, but refers to the <em>n</em>th local variable
of the frame.  <code>Control-Meta-V</code> refers to the <em>n</em>th value this frame
has returned (in a trap-on-exit).  <code>Control-Meta-F</code> refers to the
function executing in the frame; it ignores its numeric argument and
doesn&rsquo;t allow you to change the function.
</p>
<p>Another way to examine and set the arguments, locals and values of a
frame is with the functions <code>eh-arg</code>, <code>eh-loc</code>, <code>eh-val</code> and
<code>eh-fun</code>.  Use these functions in expressions you evaluate inside
the debugger, and they refer to the arguments, locals, values and
function, respectively, of the debugger&rsquo;s current frame.
</p>
<a name="eh_002darg_002dfun"></a><dl>
<dt><a name="index-eh_002darg"></a>Function: <strong>eh-arg</strong> <em>arg-number-or-name</em></dt>
<dd><p>When used in an expression evaluated in the debugger, <code>eh-arg</code>
returns the value of the specifed argument in the debugger&rsquo;s
current frame.  Argument names are compared ignoring packages; only
the pname of the symbol you supply is relevant.  <code>eh-arg</code> can appear
in <code>setf</code> and <code>locf</code> to set an argument or get its location.
</p></dd></dl>

<a name="eh_002dloc_002dfun"></a><dl>
<dt><a name="index-eh_002dloc"></a>Function: <strong>eh-loc</strong> <em>local-number-or-name</em></dt>
<dd><p><code>eh-loc</code> is just like <code>eh-arg</code> but accesses the current frame&rsquo;s
locals instead of its arguments.
</p></dd></dl>

<a name="eh_002dval_002dfun"></a><dl>
<dt><a name="index-eh_002dval"></a>Function: <strong>eh-val</strong> <em>&amp;optional value-number-or-name</em></dt>
<dd><p><code>eh-val</code> is used in an expression evaluated in the debugger
when the current frame is returning multiple values, to examine those
values.  This is only useful if the function has already begun to
return some values (as in a trap-on-exit), since otherwise they are
all <code>nil</code>.  If a name is specified, it is looked for in the function&rsquo;s
<code>:values</code> or <code>:return-list</code> declaration, if any.
</p>
<p><code>eh-val</code> can be used with <code>setf</code> and <code>locf</code>.  You can make a
frame return a specific sequence of values by setting all but the last
value with <code>eh-val</code> and doing <code>Control-R</code> to return the last value.
</p>
<p><code>eh-val</code> with no argument returns a list of all the
values this frame is returning.
</p></dd></dl>

<a name="eh_002dfun_002dfun"></a><dl>
<dt><a name="index-eh_002dfun"></a>Function: <strong>eh-fun</strong></dt>
<dd><p><code>eh-fun</code> can be called in an expression being evalued inside the
debugger to return the function-object being called in the
current frame.  It can be used with <code>setf</code> and <code>locf</code>.
</p></dd></dl>

<a name="g_t_0022Summary-of-Commands_0022"></a>
<h4 class="subsection">27.7.4 &quot;Summary of Commands&quot;</h4>

<dl compact="compact">
<dt><code>Control-A</code></dt>
<dd><p>Print argument list of function in current frame.
</p></dd>
<dt><code>Control-Meta-A</code></dt>
<dd><p>Examine or change the <em>n</em>th argument of the current frame.
</p></dd>
<dt><code>Control-B</code></dt>
<dd><p>Print brief backtrace.
</p></dd>
<dt><code>Meta-B</code></dt>
<dd><p>Print longer backtrace.
</p></dd>
<dt><code>Control-Meta-B</code></dt>
<dd><p>Print longer backtrace with no censoring of interpreter functions.
</p></dd>
<dt><code>Control-C <span class="roman">or</span> Resume</code></dt>
<dd><p>Attempt to continue, using the first proceed type on the list
of available ones for this error.
</p></dd>
<dt><code>Meta-C</code></dt>
<dd><p>Attempt to continue, <code>setq</code>ing the unbound variable or otherwise
&quot;permanently&quot; fixing the error.  This uses the proceed type
<code>:store-new-value</code>, and is available only if that proceed type is.
</p></dd>
<dt><code>Control-D</code></dt>
<dd><p>Attempt to continue like Control-C, but trap on the next function call.
</p></dd>
<dt><code>Meta-D</code></dt>
<dd><p>Toggle the flag that causes a trap on the next function call after
you continue or otherwise exit the debugger.
</p></dd>
<dt><code>Control-E</code></dt>
<dd><p>Edit the source code for the function in the current frame.
</p></dd>
<dt><code>Control-Meta-F</code></dt>
<dd><p>Set <code>*</code> to the function in the current frame.
</p></dd>
<dt><code>Control-G <span class="roman">or</span> Abort</code></dt>
<dd><p>Quit to command level.  This is not a command, but something you can type to escape from
typing in a form.
</p></dd>
<dt><code>Control-L <span class="roman">or</span> Clear-Screen</code></dt>
<dd><p>Redisplay error message and current frame.
</p></dd>
<dt><code>Meta-L</code></dt>
<dd><p>Full-screen typeout of current frame.
</p></dd>
<dt><code>Control-Meta-L</code></dt>
<dd><p>Get local variable <em>n</em>.
</p></dd>
<dt><code>Control-M</code></dt>
<dd><p>Send a bug report containing the error message
and a backtrace of <em>n</em> frames (default is 3).
</p></dd>
<dt><code>Control-N <span class="roman">or</span> Line</code></dt>
<dd><p>Move to next frame.  With argument, move down <em>n</em> frames.
</p></dd>
<dt><code>Meta-N</code></dt>
<dd><p>Move to next frame with full-screen typeout.  With argument, move down <em>n</em> frames.
</p></dd>
<dt><code>Control-Meta-N</code></dt>
<dd><p>Move to next frame even if it is &quot;uninteresting&quot; or still accumulating
arguments.  With argument, move down <em>n</em> frames.
</p></dd>
<dt><code>Control-P <span class="roman">or</span> Return</code></dt>
<dd><p>Move to previous frame.  With argument, move up <em>n</em> frames.
</p></dd>
<dt><code>Meta-P</code></dt>
<dd><p>Move to previous frame with full-screen typeout.  With argument, move up <em>n</em> frames.
</p></dd>
<dt><code>Control-Meta-P</code></dt>
<dd><p>Move to previous frame even if it is &quot;uninteresting&quot; or still
accumulating arguments.  With argument, move up <em>n</em> frames.
</p></dd>
<dt><code>Control-R</code></dt>
<dd><p>Return a value from the current frame.
</p></dd>
<dt><code>Meta-R</code></dt>
<dd><p>Return multiple values from the current frame (doesn&rsquo;t work currently).
</p></dd>
<dt><code>Control-Meta-R</code></dt>
<dd><p>Reinvoke the function in the current frame (throw back to it and start it over
at its beginning.)
</p></dd>
<dt><code>Control-S</code></dt>
<dd><p>Search for a frame containing a specified function.
</p></dd>
<dt><code>Meta-S</code></dt>
<dd><p>Reads the name of a special variable and returns that variable&rsquo;s value
in the current frame.  Instance variables of <code>self</code> may also be
specified even if not special.
</p></dd>
<dt><code>Control-Meta-S</code></dt>
<dd><p>Prints a list of special variables bound by the current frame and the
values they are bound to by the frame.  If the frame binds <code>self</code>, all
the instance variables of self are listed even if not special.
</p></dd>
<dt><code>Control-T</code></dt>
<dd><p>Throw a value to a tag.
</p></dd>
<dt><code>Control-Meta-U</code></dt>
<dd><p>Move up the stack to the previous &quot;interesting&quot; frame.
</p></dd>
<dt><code>Control-X</code></dt>
<dd><p>Toggle the flag in the current frame that causes a trap on exit or throw through
that frame.
</p></dd>
<dt><code>Meta-X</code></dt>
<dd><p>Set the flag causing a trap on exit or throw through the frame
for the current frame and all the frames outside of it.
</p></dd>
<dt><code>Control-Meta-X</code></dt>
<dd><p>Clear the flag causing a trap on exit or throw through the frame
for the current frame and all the frames outside of it.
</p></dd>
<dt><code>Control-Meta-W</code></dt>
<dd><p>Call the window-oriented debugger.
</p></dd>
<dt><code>Control-Z <span class="roman">or</span> Abort</code></dt>
<dd><p>Abort the computation and throw back to the most recent
<code>break</code> or debugger, to the program&rsquo;s &quot;command level&quot;,
or to Lisp top level.
</p></dd>
<dt><code>? <span class="roman">or</span> Help</code></dt>
<dd><p>Print a help message.
</p></dd>
<dt><code>Meta-&lt;</code></dt>
<dd><p>Go to top of stack.
</p></dd>
<dt><code>Meta-&gt;</code></dt>
<dd><p>Go to bottom of stack.
</p></dd>
<dt><code>Control-0 <span class="roman">through</span> Control-Meta-9</code></dt>
<dd><p>Numeric arguments to the following command are specified by typing a decimal number
with <code>Control</code> and/or <code>Meta</code> held down.
</p></dd>
<dt><code>Super-A<span class="roman">, etc.</span></code></dt>
<dd><p>The commands <code>Super-A</code>, <code>Super-B</code>, etc. are assigned to all the available
proceed types for this error.  The assignments are different each time
the debugger is entered, so it prints a list of them when it starts up.
</p></dd>
</dl>

<a name="Deexposed-Windows-and-Background-Processes"></a>
<h4 class="subsection">27.7.5 Deexposed Windows and Background Processes</h4>

<p>If the debugger is entered in a window that is not exposed, a
notification is used to inform you that it has happened.  The
notification appears either as a brief message printed inside square
brackets, or as a small window that pops up with a brief message.  The
notification reminds you that you can select the window in which the
error happened by typing <code>Terminal 0 S</code>.
</p>
<p>If the debugger is entered in a process that has no window or other suitable stream to
type out on, the window system tries to assign it a &quot;background window&quot; and
print a notification to tell you it is there.  If the window system is in a clean
state at the moment, this can be done, and you can then type <code>Terminal 0 S</code> to
select the background window.
</p>
<p>However, if the window system cannot notify you, because windows on the
screen are locked, it can still inform you of the error.  The who-line
displays a string containing flashing asterisks that tells you there are
errors in the background.
</p>
<p>At this time you can either try using <code>Terminal Control-Clear-Input</code> to unlock
the locks and allow the notification to be printed normally, or you can elect to
handle the error using the cold-load stream by typing <code>Terminal Call</code>.  This
command normally enters a break-loop that uses the cold-load stream, but if
there are any background errors, it offers to enter the debugger to handle them.
</p>
<a name="Tracing-Function-Execution"></a>
<h3 class="section">27.8 Tracing Function Execution</h3>
<a name="index-tracing-function-execution"></a>
<a name="trace"></a>
<p>The trace facility allows the user to <em>trace</em> some functions.
When a function is traced, certain special actions will be taken when it is
called and when it returns.  The default tracing action is to print a message when the
function is called, showing its name and arguments, and another message when
the function returns, showing its name and value(s).
</p>
<p>The trace facility is closely compatible with Maclisp.  One invokes
it through the <code>trace</code> and <code>untrace</code> special forms, whose syntax is described
below.  Alternatively, you can use the trace system by clicking <code>Trace</code>
in the system menu, or by using the <code>Meta-X Trace</code> command in the editor.
This allows you to select the trace options from a menu instead of having
to remember the following syntax.
</p>
<a name="trace_002dfun"></a><dl>
<dt><a name="index-trace"></a>Special Form: <strong>trace</strong></dt>
<dd><p>A <code>trace</code> form looks like:
</p><div class="lisp">
<pre class="lisp">(trace <em>spec-1</em> <em>spec-2</em> ...)
</pre></div>

<p>Each <em>spec</em> can take any of the following forms:
</p><dl compact="compact">
<dt><span class="roman">a symbol</span></dt>
<dd><p>This is a function name, with no options.  The function will be traced in the
default way, printing a message each time it is called and each time it returns.
</p>
</dd>
<dt><span class="roman">a list <code>(<em>function-name</em> <em>option-1</em> <em>option-2</em> ...)</code></span></dt>
<dd><p><em>function-name</em> is a symbol and the <em>options</em> control how it is to be
traced.  The various options are listed below.  Some options take arguments,
which should be given immediately following the option name.
</p>
</dd>
<dt><span class="roman">a list <code>(:function <em>function-spec</em> <em>option-1</em> <em>option-2</em> ...)</code></span></dt>
<dd><p>This is like the previous form except that <em>function-spec</em> need not be a symbol
(see <a href="#function_002dspec">function-spec</a>).
It exists because if <em>function-name</em> was a list in the previous form, it
would instead be interpreted as the following form:
</p>
</dd>
<dt><span class="roman">a list <code>((<em>function-1</em> <em>function-2</em>...) <em>option-1</em> <em>option-2</em> ...)</code></span></dt>
<dd><p>All of the functions are traced with the same options.  Each <em>function</em> can
be either a symbol or a general function-spec.
</p></dd>
</dl>
</dd></dl>

<p>The following <code>trace</code> options exist:
</p><dl compact="compact">
<dt><code>:break <em>pred</em></code></dt>
<dd><a name="index-_003abreak-trace"></a>
<p>Causes a breakpoint to be entered after printing
the entry trace information but before applying the traced function to its
arguments, if and only if <em>pred</em> evaluates to non-<code>nil</code>.  During the
breakpoint, the symbol <code>arglist</code> is bound to a list of the arguments
of the function.
</p>
</dd>
<dt><code>:exitbreak <em>pred</em></code></dt>
<dd><a name="index-_003aexitbreak-trace"></a>
<p>This is just like <code>break</code> except that the
breakpoint is entered after the function has been executed and the exit trace information
has been printed, but before control returns.    During the
breakpoint, the symbol <code>arglist</code> is bound to a list of the arguments
of the function, and the symbol <code>values</code> is bound to a list of
the values that the function is returning.
</p>
</dd>
<dt><code>:error</code></dt>
<dd><a name="index-_003aerror-trace"></a>
<p>Causes the error handler to be called when the function is entered.  Use
<code>Resume</code> (or Control-C) to continue execution of the function.  If this option
is specified, there is no printed trace output other than the error message
printed by the error handler.  This is semi-obsolete, as <code>breakon</code> is
more convenient and does more exactly the right thing.
</p>
</dd>
<dt><code>:step</code></dt>
<dd><a name="index-_003astep-trace"></a>
<p>Causes the function to be single-stepped whenever it is called.
See the documentation on the step facility, <a href="#stepper_002dsection">stepper-section</a>.
</p>
</dd>
<dt><code>:entrycond <em>pred</em></code></dt>
<dd><a name="index-_003aentrycond-trace"></a>
<p>Causes trace information to be printed on function
entry only if <em>pred</em> evaluates to non-<code>nil</code>.
</p>
</dd>
<dt><code>:exitcond <em>pred</em></code></dt>
<dd><a name="index-_003aexitcond-trace"></a>
<p>Causes trace information to be printed on function
exit only if <em>pred</em> evaluates to non-<code>nil</code>.
</p>
</dd>
<dt><code>:cond <em>pred</em></code></dt>
<dd><a name="index-_003acond-trace"></a>
<p>This specifies both <code>:exitcond</code> and <code>:entrycond</code>
together.
</p>
</dd>
<dt><code>:wherein <em>function</em></code></dt>
<dd><a name="index-_003awherein-trace"></a>
<p>Causes the function to be traced only when called, directly or indirectly,
from the specified function <em>function</em>.  One can give several trace specs to
<code>trace</code>, all specifying the same function but with different <code>wherein</code>
options, so that the function is traced in different ways when called from
different functions.
</p>
<p>This is different from <code>advise-within</code>, which only affects the function
being advised when it is called directly from the other function.  The <code>trace</code>
<code>:wherein</code> option means that when the traced function is called, the special
tracing actions occur if the other function is the caller of this function,
or its caller&rsquo;s caller, or its caller&rsquo;s caller&rsquo;s caller, etc.
</p>
</dd>
<dt><code>:argpdl <em>pdl</em></code></dt>
<dd><a name="index-_003aargpdl-trace"></a>
<p>This specifies a symbol <em>pdl</em>, whose value is
initially set to <code>nil</code> by <code>trace</code>.  When the function is traced, a
list of the current recursion level for the function, the function&rsquo;s
name, and a list of arguments is consed onto the <em>pdl</em> when the
function is entered, and cdr&rsquo;ed back off when the function is exited.
The <em>pdl</em> can be inspected from within a breakpoint, for example, and
used to determine the very recent history of the function. This option
can be used with or without printed trace output.  Each function can be
given its own pdl, or one pdl may serve several functions.
</p>
</dd>
<dt><code>:entryprint <em>form</em></code></dt>
<dd><a name="index-_003aentryprint-trace"></a>
<p>The <em>form</em> is evaluated and the value is included in the trace message
for calls to the function.  You can give this option more than once, and
all the values will appear, preceded by <code>\\</code>.
</p>
</dd>
<dt><code>:exitprint <em>form</em></code></dt>
<dd><a name="index-_003aexitprint-trace"></a>
<p>The <em>form</em> is evaluated and the value is included in the trace message
for returns from the function.  You can give this option more than once, and
all the values will appear, preceded by <code>\\</code>.
</p>
</dd>
<dt><code>:print <em>form</em></code></dt>
<dd><a name="index-_003aprint-trace"></a>
<p>The <em>form</em> is evaluated and the value is included in the trace messages
for both calls to and returns from the function.  You can give this option more than once, and
all the values will appear, preceded by <code>\\</code>.
</p>
</dd>
<dt><code>:entry <em>list</em></code></dt>
<dd><a name="index-_003aentry-trace"></a>
<p>This specifies a list of arbitrary forms whose
values are to be printed along with the usual entry-trace.  The list of
resultant values, when printed, is preceded by <code>\\</code> to separate it
from the other information.
</p>
</dd>
<dt><code>:exit <em>list</em></code></dt>
<dd><a name="index-_003aexit-trace"></a>
<p>This is similar to <code>entry</code>, but specifies expressions
whose values are printed with the exit-trace.  Again, the list of
values printed is preceded by <code>\\</code>.
</p>
</dd>
<dt><code>:arg  :value  :both  nil</code></dt>
<dd><a name="index-_003aarg-trace"></a>
<a name="index-_003avalue-trace"></a>
<a name="index-_003aboth-trace"></a>
<p>These specify which of the usual trace
printouts should be enabled.  If <code>:arg</code> is specified, then on function
entry the name of the function and the values of its arguments will be
printed.  If <code>:value</code> is specified, then on function exit the returned
value(s) of the function will be printed.  If <code>:both</code> is specified,
both of these will be printed.  If <code>nil</code> is specified, neither will
be printed.  If none of these four options are specified the default is
to <code>:both</code>.  If any further <em>options</em> appear after one of these,
they will not be treated as options!  Rather, they will be considered to
be arbitrary forms whose values are to be printed on entry and/or exit
to the function, along with the normal trace information. The values
printed will be preceded by a <code>//</code>, and follow any values specified
by <code>:entry</code> or <code>:exit</code>.  Note that since these options &quot;swallow&quot; all
following options, if one is given it should be the last option
specified.
</p></dd>
</dl>

<a name="index-arglist-1"></a>
<p>If the variable <code>arglist</code> is used in any of the expressions given for
the <code>:cond</code>, <code>:break</code>, <code>:entry</code>, or <code>:exit</code> options, or after the <code>:arg</code>,
<code>:value</code>, <code>:both</code>, or <code>nil</code> option, when those expressions are evaluated
the value of <code>arglist</code> will be bound to a list of the arguments
given to the traced function.  Thus 
</p><div class="lisp">
<pre class="lisp">(trace (foo :break (null (car arglist))))
</pre></div>
<p>would cause a break in <code>foo</code> if and only if the first
argument to <code>foo</code> is <code>nil</code>.
If the <code>:break</code> or <code>:error</code> option is used, the variable <code>arglist</code> will be valid inside
the break-loop.  If you <code>setq</code> <code>arglist</code>, the arguments seen by the function will
change.
<code>arglist</code> should perhaps have a colon, but it can be omitted because this is
the name of a system function and therefore global.
</p>
<a name="index-values-1"></a>
<p>Similarly, the variable <code>values</code> will
be a list of the resulting values of the traced function.  For obvious
reasons, this should be used only with the <code>:exit</code> option.
If the <code>:exitbreak</code> option is used, the variables <code>values</code> and <code>arglist</code> 
are valid inside the break-loop.  If you <code>setq</code> <code>values</code>, the values returned
by the function will change.
<code>values</code> should perhaps have a colon, but it can be omitted because this is
the name of a system function and therefore global.
</p>
<p>The trace specifications may be &quot;factored&quot;, as explained above.  For example,
</p><div class="lisp">
<pre class="lisp">(trace ((foo bar) :break (bad-p arglist) :value))
<span class="roman">is equivalent to</span>
(trace (foo :break (bad-p arglist) :value)
       (bar :break (bad-p arglist) :value))
</pre></div>
<p>Since a list as a function name is interpreted as a list of
functions, non-atomic function names (see <a href="#function_002dspec">function-spec</a>)
are specified as follows:
</p><div class="lisp">
<pre class="lisp">(trace (:function (:method flavor :message) :break t))
</pre></div>

<p><code>trace</code> returns as its value a list of names of all functions it traced.  If
called with no arguments, as just <code>(trace)</code>, it returns a list of all the
functions currently being traced.
</p>
<p>If you attempt to trace a function already being traced, <code>trace</code> calls
<code>untrace</code> before setting up the new trace.
</p>
<p>Tracing is implemented with encapsulation (see <a href="#encapsulate">encapsulate</a>), so if the
function is redefined (e.g with <code>defun</code> or by loading it from a QFASL file)
the tracing will be transferred from the old definition to the new definition.
</p>
<p>Tracing output is printed on the stream that is the value of <code>trace-output</code>.
This is synonymous with <code>terminal-io</code> unless you change it.
</p>
<a name="untrace_002dfun"></a><dl>
<dt><a name="index-untrace"></a>Special Form: <strong>untrace</strong></dt>
<dd><p><code>untrace</code> is used to undo the effects of <code>trace</code> and restore functions to
their normal, untraced state.  <code>untrace</code> will take multiple specifications,
e.g <code>(untrace foo quux fuphoo)</code>.  Calling <code>untrace</code> with no arguments
will untrace all functions currently being traced.
</p></dd></dl>

<p>Unlike Maclisp, if there is an error <code>trace</code> (or <code>untrace</code>) will
invoke
the error system and give an English message, instead of returning
lists with question marks in them.  Also, the <code>remtrace</code> function
is not provided, since it is unnecessary.
</p>
<a name="trace_002dcompile_002dflag_002dvar"></a><dl>
<dt><a name="index-trace_002dcompile_002dflag"></a>Variable: <strong>trace-compile-flag</strong></dt>
<dd><p>If the value of <code>trace-compile-flag</code> is non-<code>nil</code>, the functions
created by <code>trace</code> will get compiled, allowing you to trace special
forms such as <code>cond</code> without interfering with the execution of the
tracing functions.  The default value of this flag is <code>nil</code>.
</p></dd></dl>

<p>You can also cause the tracing of a particular function to be compiled
by calling <code>compile-encapsulations</code>.  Set
<code>compile-encapsulations-flag</code> non-<code>nil</code> does what
<code>trace-compile-flag</code> does, and more; it makes all kinds of
encapsulations be compiled.  See <a href="#compile_002dencapsulations_002dfun">compile-encapsulations-fun</a>.
</p>
<a name="Breakon"></a>
<h3 class="section">27.9 Breakon</h3>

<p>The function <code>breakon</code> allows you to request that the debugger be
entered whenever a certain function is called.
</p>
<a name="breakon_002dfun"></a><dl>
<dt><a name="index-breakon"></a>Function: <strong>breakon</strong> <em>function-spec &amp;optional condition-form</em></dt>
<dd><p>Encapsulate the definition of <em>function-spec</em> so that a trap-on-call
occurs when it is called.  This enters the debugger.  A
trap-on-exit will occur when the stack frame is exited.
</p>
<p>If <em>condition-form</em> is non-<code>nil</code>, its value should be a form to be
evaluated each time <em>function-spec</em> is called. The trap occurs only if
<em>condition-form</em> evaluates to non-<code>nil</code>.  Omitting the
<em>condition-form</em> is equivalent to supplying <code>t</code>.  If <code>breakon</code> is
called more than once for the same <em>function-spec</em> and different
<em>condition-form</em>s, the trap occurs if any of the conditions is true.
</p></dd></dl>

<p>Condition breakons are useful for causing the trap to occur only in a
certain stack group.  This sometimes allows debugging of calls functions
that are being used frequently in background processes.
</p><div class="lisp">
<pre class="lisp">(breakon 'foo `(eq current-stack-group ',current-stack-group))
</pre></div>

<p>If you wish to trap on calls to <code>foo</code> when called from the execution of
<code>bar</code>, you can use <code>(si:function-active-p 'bar)</code> as the condition.
If you want to trap only calls made directly from <code>bar</code>, the thing to
do is
</p><div class="lisp">
<pre class="lisp">(breakon '(:within bar foo))
</pre></div>
<p>rather than a conditional breakon.
</p>
<p>Another useful form of conditional breakon allows you to control
trapping from the keyboard:
</p><div class="lisp">
<pre class="lisp">(breakon 'foo '(tv:key-state ':mode-lock))
</pre></div>
<p>The trap will occur only when the <code>Mode-Lock</code> key is down.  This key
is not normally used for much else.  With this technique, you can
successfully trap on functions used by the debugger!
</p>
<a name="unbreakon_002dfun"></a><dl>
<dt><a name="index-unbreakon"></a>Function: <strong>unbreakon</strong> <em>function-spec &amp;optional conditional-form</em></dt>
<dd><p>Remove the <code>breakon</code> set on <em>function-spec</em>.  If
<em>conditional-form</em> is specified, remove only that condition.  Breakons
with other conditions are not removed.
</p>
<p>With no arguments, <code>unbreakon</code> removes all breakons from all
functions.
</p></dd></dl>

<a name="eh_003abreakon_002dfunctions_002dvar"></a><dl>
<dt><a name="index-eh_003abreakon_002dfunctions"></a>Variable: <strong>eh:breakon-functions</strong></dt>
<dd><p>A list of all function specs on which breakons currently exist.
</p></dd></dl>

<p>To cause the encapsulation which implements the breakon to be compiled,
call <code>compile-encapsulations</code> or set <code>compile-encapsulations-flag</code>
non-<code>nil</code>.  See <a href="#compile_002dencapsulations_002dfun">compile-encapsulations-fun</a>.  This may eliminate
some of the problems that occur if you breakon a function such as
<code>prog</code> that is used by the evaluator.  (A conditional to trap only in
one stack group will help here also.)
</p>
<a name="Advising-a-Function"></a>
<h3 class="section">27.10 Advising a Function</h3>
<a name="advise"></a><a name="index-advice-to-functions"></a>

<p>To advise a function is to tell it to do something extra in addition to its
actual definition.  It is done by means of the function <code>advise</code>.  The
something extra is called a piece of advice, and it can be done before, after,
or around the definition itself.  The advice and the definition are independent,
in that changing either one does not interfere with the other.  Each function
can be given any number of pieces of advice.
</p>
<p>Advising is fairly similar to tracing, but its purpose is different.  Tracing is
intended for temporary changes to a function to give the user information about
when and how the function is called and when and with what value it returns.
Advising is intended for semi-permanent changes to what a function actually
does.  The differences between tracing and advising are motivated by this
difference in goals.
</p>
<p>Advice can be used for testing out a change to a function in a way
that is easy to retract.  In this case, you would call <code>advise</code> from
the terminal.  It can also be used for customizing a
function that is part of a program written by someone else.  In this
case you would be likely to put a call to <code>advise</code> in one of your
source files or your login init file (see <a href="#login_002dfun">login-fun</a>), rather than modifying the other
person&rsquo;s source code.
</p>
<p>Advising is implemented with encapsulation (see <a href="#encapsulate">encapsulate</a>), so if the
function is redefined (e.g with <code>defun</code> or by loading it from a QFASL file)
the advice will be transferred from the old definition to the new definition.
</p>
<a name="advise_002dfun"></a><dl>
<dt><a name="index-advise"></a>Special Form: <strong>advise</strong></dt>
<dd><p>A function is advised by the special form
</p><div class="lisp">
<pre class="lisp">(advise <em>function</em> <em>class</em> <em>name</em> <em>position</em>
  <em>form1</em> <em>form2</em>...)
</pre></div>
<p>None of this is evaluated.  <em>function</em> is the function to put the advice on.
It is usually a symbol, but any function spec is allowed (see <a href="#function_002dspec">function-spec</a>).
The <em>forms</em> are the advice; they get evaluated when the function is called.
<em>class</em> should be either <code>:before</code>, <code>:after</code>, or <code>:around</code>, and says
when to execute the advice (before, after, or around the execution of the
definition of the function).  The meaning of <code>:around</code> advice is explained a
couple of sections below.
</p>
<p><em>name</em> is used to keep track of multiple pieces of advice on the same
function.  <em>name</em> is an arbitrary symbol that is remembered as the
name of this particular piece of advice.  If you have no name in mind,
use <code>nil</code>; then we say the piece of advice is anonymous.  A given
function and class can have any number of pieces of anonymous advice,
but it can have only one piece of named advice for any one name.  If
you try to define a second one, it replaces the first.  Advice for
testing purposes is usually anonymous.  Advice used for customizing
someone else&rsquo;s program should usually be named so that multiple
customizations to one function have separate names.  Then, if you
reload a customization that is already loaded, it does not get put on
twice.
</p>
<p><em>position</em> says where to put this piece of advice in relation to
others of the same class already present on the same function.  If
<em>position</em> is <em>nil</em>, the new advice goes in the default position: it
usually goes at the beginning (where it is executed before the other
advice), but if it is replacing another piece of advice with the same
name, it goes in the same place that the old piece of advice was in.
</p>
<p>If you wish to specify the position, <em>position</em> can be the numerical index of
which existing piece of advice to insert this one before.  Zero means
at the beginning; a very large number means at the end.  Or,
<em>position</em> can be the name of an existing piece of advice of the same
class on the same function; the new advice is inserted before that
one.
</p>
<div class="lisp">
<pre class="lisp"><span class="roman">For example,</span>
</pre><pre class="lisp">(advise factorial :before negative-arg-check nil
  (if (minusp (first arglist))
      (ferror nil &quot;factorial of negative argument&quot;)))
</pre></div>
<p>This modifies the factorial function so that if it is called with a negative argument
it signals an error instead of running forever.
</p></dd></dl>

<a name="unadvise_002dfun"></a><dl>
<dt><a name="index-unadvise"></a>Special Form: <strong>unadvise</strong></dt>
<dd><div class="lisp">
<pre class="lisp">(unadvise <em>function</em> <em>class</em> <em>position</em>)
</pre></div>
<p>removes pieces of advice.  None of its &quot;arguments&quot; are evaluated.  <em>function</em>
and <em>class</em> have the same meaning as they do in the function <code>advise</code>.
<em>position</em> specifies which piece of advice to remove.  It can be the numeric
index (zero means the first one) or it can be the name of the piece of advice.
</p>
<p><code>unadvise</code> can remove more than one piece of advice if some of its arguments
are missing.  If <em>position</em> is missing or <code>nil</code>, then all advice of the specified class
on the specified function is removed.  If <em>class</em> is missing or <code>nil</code> as well, then all
advice on the specified function is removed.  <code>(unadvise)</code> removes all advice
on all functions, since <em>function</em> is not specified.
</p></dd></dl>

<p>The following are the primitive functions for adding and removing advice.
Unlike the above special forms, these are functions and can be conveniently
used by programs.  <code>advise</code> and <code>unadvise</code> are actually macros that
expand into calls to these two.
</p>
<a name="si_003aadvise_002d1_002dfun"></a><dl>
<dt><a name="index-si_003aadvise_002d1"></a>Function: <strong>si:advise-1</strong> <em>function class name position forms</em></dt>
<dd><p>Adds advice.  The arguments have the same meaning as in <code>advise</code>.
Note that the <em>forms</em> argument is <em>not</em> a <code>&amp;rest</code> argument.
</p></dd></dl>

<a name="si_003aunadvise_002d1_002dfun"></a><dl>
<dt><a name="index-si_003aunadvise_002d1"></a>Function: <strong>si:unadvise-1</strong> <em>function &amp;optional class position</em></dt>
<dd><p>Removes advice.  If <em>class</em> or <em>position</em> is <code>nil</code> or unspecified,
all classes of advice or advice at all positions are removed.
</p></dd></dl>

<p>You can find out manually what advice a function has with <code>grindef</code>, which
grinds the advice on the function as forms that are calls to
<code>advise</code>.  These are in addition to the definition of the function.
</p>
<p>To poke around in the advice structure with a program, you must work
with the encapsulation mechanism&rsquo;s primitives.  See <a href="#encapsulate">encapsulate</a>.
</p>
<p>To cause the advice to be compiled, call <code>compile-encapsulations</code> or
set <code>compile-encapsulations-flag</code> non-<code>nil</code>.  See
<a href="#compile_002dencapsulations_002dfun">compile-encapsulations-fun</a>.
</p>
<a name="si_003aadvised_002dfunctions_002dvar"></a><dl>
<dt><a name="index-si_003aadvised_002dfunctions"></a>Variable: <strong>si:advised-functions</strong></dt>
<dd><p>A list of all functions which have been advised.
</p></dd></dl>

<a name="Designing-the-Advice"></a>
<h4 class="subsection">27.10.1 Designing the Advice</h4>

<p>For advice to interact usefully with the definition and intended
purpose of the function, it must be able to interface to the data flow
and control flow through the function.  We provide conventions for
doing this.
</p>
<p>The list of the arguments to the function can be found in the variable
<code>arglist</code>.  <code>:before</code> advice can replace this list, or an element of it, to
change the arguments passed to the definition itself.  If you replace
an element, it is wise to copy the whole list first with
</p><div class="lisp">
<pre class="lisp">(setq arglist (copylist arglist))
</pre></div>
<p>After the function&rsquo;s definition has been executed, the list of the
values it returned can be found in the variable <code>values</code>.  <code>:after</code> advice
can set this variable or replace its elements to cause different
values to be returned.
</p>
<p>All the advice is executed within a <code>prog</code>, so any piece of advice can
exit the entire function with <code>return</code>.  The arguments of the <code>return</code>
will be returned as the values of the function.  No further advice
will be executed.  If a piece of <code>:before</code> advice does this, then the
function&rsquo;s definition will not even be called.
</p>
<a name="g_t_003aaround-Advice"></a>
<h4 class="subsection">27.10.2 :around Advice</h4>

<p>A piece of <code>:before</code> or <code>:after</code> advice is executed entirely before or
entirely after the definition of the function.  <code>:around</code> advice is wrapped
around the definition; that is, the call to the original definition of
the function is done at a specified place inside the piece of <code>:around</code>
advice.  You specify where by putting the symbol <code>:do-it</code> in that place.
</p>
<p>For example, <code>(+ 5 :do-it)</code> as a piece of <code>:around</code> advice would add <code>5</code> to
the value returned by the function.  This could also be done by
<code>(setq values (list (+ 5 (car values))))</code> as <code>:after</code> advice.
</p>
<p>When there is more than one piece of <code>:around</code> advice, the pieces are stored
in a sequence just like <code>:before</code> and <code>:after</code> advice.  Then, the first
piece of advice in the sequence is the one started first.  The second
piece is substituted for <code>:do-it</code> in the first one.  The third one is
substituted for <code>:do-it</code> in the second one.  The original definition is
substituted for <code>:do-it</code> in the last piece of advice.
</p>
<p><code>:around</code> advice can access <code>arglist</code>, but <code>values</code> is not set up until the
outermost <code>:around</code> advice returns.  At that time, it is set to the
value returned by the <code>:around</code> advice.  It is reasonable for the advice to
receive the values of the <code>:do-it</code> (e.g with <code>multiple-value-list</code>) and
fool with them before returning them (e.g with <code>values-list</code>).
</p>
<p><code>:around</code> advice can <code>return</code> from the <code>prog</code> at any time, whether the
original definition has been executed yet or not.  It can also override
the original definition by failing to contain <code>:do-it</code>.  Containing two
instances of <code>:do-it</code> may be useful under peculiar circumstances.  If you
are careless, the original definition may be called twice, but
something like
</p><div class="lisp">
<pre class="lisp">(if (foo) (+ 5 :do-it) (* 2 :do-it))
</pre></div>
<p>will certainly work reasonably.
</p>
<a name="Advising-One-Function-Within-Another"></a>
<h4 class="subsection">27.10.3 Advising One Function Within Another</h4>

<p>It is possible to advise the function <code>foo</code> only for when it is called
directly from a specific other function <code>bar</code>.  You do this by advising
the function specifier <code>(:within bar foo)</code>.  That works by finding all
occurrences of <code>foo</code> in the definition of <code>bar</code> and replacing them with
<code>altered-foo-within-bar</code>.  This can be done even if <code>bar</code>&rsquo;s definition is
compiled code.  The symbol <code>altered-foo-within-bar</code> starts off with the
symbol <code>foo</code> as its definition;
then the symbol <code>altered-foo-within-bar</code>, rather than <code>foo</code> itself,
is advised.  The system remembers that <code>foo</code>
has been replaced inside <code>bar</code>, so that if you change the definition of
<code>bar</code>, or advise it, then the replacement is propagated to the new
definition or to the advice.  If you remove all the advice on <code>(:within
bar foo)</code>, so that its definition becomes the symbol <code>foo</code> again, then
the replacement is unmade and everything returns to its original
state.
</p>
<p><code>(grindef bar)</code> will print <code>foo</code> where it originally appeared, rather than
<code>altered-foo-within-bar</code>, so the replacement will not be seen.  Instead,
<code>grindef</code> will print out calls to <code>advise</code> to describe all the advice that
has been put on <code>foo</code> or anything else within <code>bar</code>.
</p>
<p>An alternate way of putting on this sort of advice is to use
<code>advise-within</code>.
</p>
<a name="advise_002dwithin_002dfun"></a><dl>
<dt><a name="index-advise_002dwithin"></a>Special Form: <strong>advise-within</strong></dt>
<dd><div class="lisp">
<pre class="lisp">(advise-within <em>within-function</em> <em>function-to-advise</em>
	       <em>class</em> <em>name</em> <em>position</em>
	<em>forms...</em>)
</pre></div>
<p>advises <em>function-to-advise</em> only when called directly from the function
<em>within-function</em>.  The other arguments mean the same thing as with
<code>advise</code>.  None of them are evaluated.
</p></dd></dl>

<p>To remove advice from <code>(:within bar foo)</code>, you can use <code>unadvise</code> on that
function specifier.  Alternatively, you can use <code>unadvise-within</code>.
</p>
<a name="unadvise_002dwithin_002dfun"></a><dl>
<dt><a name="index-unadvise_002dwithin"></a>Special Form: <strong>unadvise-within</strong></dt>
<dd><div class="lisp">
<pre class="lisp">(unadvise-within <em>within-function</em> <em>function-to-advise</em> <em>class</em> <em>position</em>)
</pre></div>
<p>removes advice
that has been placed on <code>(:within <em>within-function</em> <em>function-to-advise</em>)</code>.
The arguments <em>class</em> and <em>position</em> are
interpereted as for <code>unadvise</code>.  For example, if those two are omitted,
then all advice placed on <em>function-to-advise</em> within
<em>within-function</em> is removed.  Additionally, if <em>function-to-advise</em>
is omitted, all advice on any function within <em>within-function</em> is
removed.  If there are no arguments, than all advice on one function
within another is removed.  Other pieces of advice, which have been
placed on one function and not limited to within another, are not
removed.
</p>
<p><code>(unadvise)</code> removes absolutely all advice, including advice for one
function within another.
</p></dd></dl>

<p>The function versions of <code>advise-within</code> and <code>unadvise-within</code> are
called <code>si:advise-within-1</code> and <code>si:unadvise-within-1</code>.  <code>advise-within</code> and
<code>unadvise-within</code> are macros that expand into calls to the other two.
</p>

<a name="Stepping-Through-an-Evaluation"></a>
<h3 class="section">27.11 Stepping Through an Evaluation</h3>
<a name="stepper_002dsection"></a><a name="index-stepping-through-evaluation"></a>

<p>The Step facility gives you the ability to follow every step of
the evaluation of a form, and examine what is going on.  It is
analogous to a single-step proceed facility often found in
machine-language debuggers.  If your program is doing something
strange, and it isn&rsquo;t obvious how it&rsquo;s getting into its strange state,
then the stepper is for you.
</p>
<p>There are two ways to enter the stepper.  One is by use of the
<code>step</code> function.
</p>
<a name="step_002dfun"></a><dl>
<dt><a name="index-step"></a>Function: <strong>step</strong> <em>form</em></dt>
<dd><p>This evaluates <em>form</em> with single stepping.  It returns
the value of <em>form</em>.
</p></dd></dl>

<p>For example, if you have a function named <code>foo</code>, and typical arguments
to it might be <code>t</code> and <code>3</code>, you could say
</p><div class="lisp">
<pre class="lisp">(step '(foo t 3))
</pre></div>
<p>and the form <code>(foo t 3)</code> will be evaluated with single stepping.
</p>
<p>The other way to get into the stepper is to use the <code>:step</code> option 
of <code>trace</code> (see <a href="#trace_002dfun">trace-fun</a>).  If a function is traced with the <code>:step</code> option, then
whenever that function is called it will be single stepped.
</p>
<p>Note that any function to be stepped must be interpreted; that is, it
must be a lambda-expression.  Compiled code cannot be stepped by the stepper.
</p>
<p>When evaluation is proceeding with single stepping, before any
form is evaluated, it is (partially) printed out, preceded by a forward
arrow (<code>rightArrow</code>) character When a macro is expanded, the expansion is
printed out preceded by a double arrow (<code>doubleArrow</code>) character.  When a form
returns a value, the form and the values are printed out preceded by a
backwards arrow (<code>leftArrow</code>) character; if there is more than one value
being returned, an and-sign (<code>andSign</code>) character is printed between the
values.  When the stepper has evaluated the args to a form and is about
to apply the function, it prints a lambda (<code></code>) because entering the
lambda is the next thing to be done.
</p>
<p>Since the forms may be very long, the stepper does not print all
of a form; it truncates the printed representation after a certain number
of characters.  Also, to show the recursion pattern of who calls whom in
a graphic fashion, it indents each form proportionally to its level
of recursion.
</p>
<p>After the stepper prints any of these things, it waits for a
command from the user.  There are several commands to tell the stepper
how to proceed, or to look at what is happening. The commands are:
</p><dl compact="compact">
<dt><span class="roman"><code>Control-N</code> (Next)</span></dt>
<dd><p>Step to the Next thing.  The stepper continues until the next thing
to print out, and it accepts another command.
</p>
</dd>
<dt><span class="roman"><code>Space</code></span></dt>
<dd><p>Go to the next thing at this level.  In other words, continue to
evaluate at this level, but don&rsquo;t step anything at lower levels.  This is a good
way to skip over parts of the evaluation that don&rsquo;t interest you.
</p>
</dd>
<dt><span class="roman"><code>Control-A</code> (Args)</span></dt>
<dd><p>Skip over the evaluation of the arguments of this form, but pause in the stepper
before calling the function that is the car of the form.
</p>
</dd>
<dt><span class="roman"><code>Control-U</code> (Up)</span></dt>
<dd><p>Continue evaluating until we go up one level.  This is like
the space command, only more so; it skips over anything on the current level
as well as lower levels.
</p>
</dd>
<dt><span class="roman"><code>Control-X</code> (eXit)</span></dt>
<dd><p>Exit; finish evaluating without any more stepping.
</p>
</dd>
<dt><span class="roman"><code>Control-T</code> (Type)</span></dt>
<dd><p>Retype the current form in full (without truncation).
</p>
</dd>
<dt><span class="roman"><code>Control-G</code> (Grind)</span></dt>
<dd><p>Grind (i.e prettyprint) the current form.
</p>
</dd>
<dt><span class="roman"><code>Control-E</code> (Editor)</span></dt>
<dd><p>Switch windows, to the editor.
</p>
</dd>
<dt><span class="roman"><code>Control-B</code> (Breakpoint)</span></dt>
<dd><p>Breakpoint.  This command puts you into a breakpoint (i.e
a read-eval-print loop) from which you can examine the values of
variables and other aspects of the current environment.  From
within this loop, the following variables are available:
</p><dl compact="compact">
<dt><code>step-form</code></dt>
<dd><p>which is the current form.
</p></dd>
<dt><code>step-values</code></dt>
<dd><p>which is the list of returned values.
</p></dd>
<dt><code>step-value</code></dt>
<dd><p>which is the first returned value.
</p></dd>
</dl>
<p>If you change the values of these variables, you will affect execution.
</p>
</dd>
<dt><span class="roman"><code>Control-L</code></span></dt>
<dd><p>Clear the screen and redisplay the last 10. pending forms (forms
that are being evaluated).
</p>
</dd>
<dt><span class="roman"><code>Meta-L</code></span></dt>
<dd><p>Like Control-L, but doesn&rsquo;t clear the screen.
</p>
</dd>
<dt><span class="roman"><code>Control-Meta-L</code></span></dt>
<dd><p>Like Control-L, but redisplays all pending forms.
</p>
</dd>
<dt><span class="roman"><code>?</code> or <code>Help</code></span></dt>
<dd><p>Prints documentation on these commands.
</p></dd>
</dl>
<p>It is strongly suggested that you write some little function
and try the stepper on it.  If you get a feel for what the stepper does
and how it works, you will be able to tell when it is the right thing to use
to find bugs.
</p>
<a name="g_t_0022Evalhook_0022"></a>
<h3 class="section">27.12 &quot;Evalhook&quot;</h3>

<a name="evalhook_002dsection"></a>
<p>The <code>evalhook</code> facility provides a &quot;hook&quot; into the evaluator; it is a
way you can get a Lisp form of your choice to be executed whenever the
evaluator is called.  The stepper uses <code>evalhook</code>, and usually it is
the only thing that ever needs to.  However, if you want to write your
own stepper or something similar, this is the primitive facility that
you can use to do so.  The way this works is a bit hairy, but unless
you need to write your own stepper you don&rsquo;t have to worry about it.
</p>
<a name="evalhook_002dvar"></a><dl>
<dt><a name="index-evalhook-1"></a>Variable: <strong>evalhook</strong></dt>
<dd><p>If the value of <code>evalhook</code> is non-<code>nil</code>, then special things
happen in the evaluator.  When a form (any form, even a number or
a symbol) is to be evaluated,
<code>evalhook</code> is bound to <code>nil</code> and the function that
was <code>evalhook</code>&rsquo;s value is applied to one argument&ndash;the form that was trying
to be evaluated.  The value it returns is then returned from the evaluator.
</p></dd></dl>

<a name="si_003aapplyhook_002dvar"></a><dl>
<dt><a name="index-si_003aapplyhook"></a>Variable: <strong>si:applyhook</strong></dt>
<dd><p>If the value of <code>si:applyhook</code> is non-<code>nil</code>, it is used rather than
<code>apply</code> the next time the interpreter is about to apply a function to
its evaluated arguments.
</p></dd></dl>

<p>When either the evalhook or the applyhook is called, both variables are
bound to <code>nil</code>.  They are also rebound to <code>nil</code> by <code>break</code> and by
the debugger, and <code>setq</code>&rsquo;ed to <code>nil</code> when errors are dismissed
by throwing to the Lisp top level loop.  This provides the ability to
escape from this mode if something bad happens.
</p>
<p>In order not to impair the efficiency of the Lisp interpreter,
several restrictions are imposed on the evalhook and applyhook.
They apply only to evaluation&ndash;whether in a read-eval-print loop,
internally in evaluating arguments in forms, or by explicit use
of the function <code>eval</code>.  They <em>do not</em> have any effect
on compiled function references, on use of the function <code>apply</code>,
or on the &quot;mapping&quot; functions.
(In Zetalisp, as opposed to Maclisp, it is not
necessary to do <code>(*rset t)</code> or <code>(sstatus evalhook t)</code>.
Also, Maclisp&rsquo;s special-case check for <code>store</code> is not implemented.)
</p>
<a name="evalhook_002dfun"></a><dl>
<dt><a name="index-evalhook"></a>Function: <strong>evalhook</strong> <em>form evalhook &amp;optional applyhook</em></dt>
<dd><p><code>evalhook</code> is a function that helps
exploit the <code>evalhook</code> feature.  The <em>form</em> is evaluated
with <code>evalhook</code> lambda-bound to the function <em>evalhook</em>,
and with <code>si:applyhook</code> lambda-bound to the function <em>applyhook</em>.
The checking of the hooks is bypassed in the evaluation
of <em>form</em> itself, but not in any subsidiary evaluations,
for instance of arguments in the <em>form</em>.
This is like a &quot;one-instruction proceed&quot; in a machine-language
debugger.  
</p><div class="lisp">
<pre class="lisp">Example:
</pre><pre class="lisp"><span class="roman">;; This function evaluates a form while printing debugging information.</span>
(defun hook (x)
   (terpri)
   (evalhook x 'hook-function))

<span class="roman">;; Notice how this function calls <code>evalhook</code> to evaluate the form <code>f</code>,</span>
<span class="roman">;; so as to hook the sub-forms.</span>
(defun hook-function (f)
   (let ((v (evalhook f 'hook-function)))
     (format t &quot;form: ~s~%value: ~s~%&quot; f v)
     v))

<span class="roman">;; This isn&rsquo;t a very good program, since if <code>f</code> uses multiple</span>
<span class="roman">;; values, it will not work.</span>
</pre></div>

<p>The following output might be seen from <code>(hook '(cons (car '(a . b)) 'c))</code>:
</p><div class="lisp">
<pre class="lisp">form: (quote (a . b))
value: (a . b)
form: (car (quote (a . b)))
value: a
form: (quote c)
value: c
(a . c)
</pre></div>
</dd></dl>

<a name="g_t_0022The-MAR_0022"></a>
<h3 class="section">27.13 &quot;The MAR&quot;</h3>
<a name="index-MAR"></a>
<a name="mar"></a>
<p>The MAR facility allows any word or contiguous set of words to
be monitored constantly, and can cause an error if the words are
referenced in a specified manner.  The name MAR is from the similar
device on the ITS PDP-10&rsquo;s; it is an acronym for &quot;Memory Address
Register&quot;.  The MAR checking is done by the Lisp Machine&rsquo;s memory
management hardware, so the speed of general execution is not
significantly slowed down when the MAR is enabled.  However, the speed
of accessing pages of memory containing the locations being checked is
slowed down somewhat, since every reference involves a microcode trap.
</p>
<p>These are the functions that control the MAR:
</p>
<a name="set_002dmar_002dfun"></a><dl>
<dt><a name="index-set_002dmar"></a>Function: <strong>set-mar</strong> <em>location cycle-type &amp;optional n-words</em></dt>
<dd><p>The <code>set-mar</code> function clears any previous setting of the
MAR, and sets the MAR on <em>n-words</em> words, starting at <em>location</em>.
<em>location</em> may be any object.  Often it will be a locative pointer
to a cell, probably created with the <code>locf</code> special form.
<em>n-words</em> currently defaults to 1,
but eventually it may default to the size of the object.
<em>cycle-type</em> says under what conditions to trap.  <code>:read</code> means that
only reading the location should cause an error, <code>:write</code> means that
only writing the location should, <code>t</code> means that both should.
To set the MAR to detect <code>setq</code> (and binding) of the variable <code>foo</code>, use
</p><div class="lisp">
<pre class="lisp">(set-mar (value-cell-location 'foo) ':write)
</pre></div>
</dd></dl>

<a name="clear_002dmar_002dfun"></a><dl>
<dt><a name="index-clear_002dmar"></a>Function: <strong>clear-mar</strong></dt>
<dd><p>This turns off the MAR.  Warm-booting the machine disables the
MAR but does not turn it off, i.e references to the MARed pages
are still slowed down.  <code>clear-mar</code> does not currently speed
things back up until the next time the pages are swapped out;
this may be fixed some day.
</p></dd></dl>

<a name="mar_002dmode_002dfun"></a><dl>
<dt><a name="index-mar_002dmode"></a>Function: <strong>mar-mode</strong></dt>
<dd><p><code>(mar-mode)</code> returns a symbol indicating the current state of
the MAR.  It returns one of:
</p><dl compact="compact">
<dt><code>nil</code></dt>
<dd><p>The MAR is not set.
</p></dd>
<dt><code>:read</code></dt>
<dd><p>The MAR will cause an error if there is a read.
</p></dd>
<dt><code>:write</code></dt>
<dd><p>The MAR will cause an error if there is a write.
</p></dd>
<dt><code>t</code></dt>
<dd><p>The MAR will cause an error if there is any reference.
</p></dd>
</dl>
</dd></dl>

<p>Note that using the MAR makes the pages on which it is set
somewhat slower to access, until the next time they are
swapped out and back in again after the MAR is shut off.
Also, use of the MAR currently breaks the read-only feature
if those pages were read-only.
</p>
<p>Proceeding from a MAR break allows the memory reference that got an error
to take place, and continues the program with the MAR still effective.  When
proceeding from a write, you have the choice of whether to allow the
write to take place or to inhibit it, leaving the location with its old
contents.
</p>
<dl>
<dt><a name="index-_0028condition_0029-on-sys_003amar_002dbreak"></a>Condition on sys:mar-break: <strong>(<code>condition</code>)</strong></dt>
<dd><p>This is the condition, not an error, signaled by a MAR break.
</p>
<p>The condition instance supports these operations:
</p><dl compact="compact">
<dt><code>:object</code></dt>
<dd><p>The object one of whose words was being referenced.
</p>
</dd>
<dt><code>:offset</code></dt>
<dd><p>The offset within the object of the word being referenced.
</p>
</dd>
<dt><code>:value</code></dt>
<dd><p>The value read, or to be written.
</p>
</dd>
<dt><code>:direction</code></dt>
<dd><p>Either <code>:read</code> or <code>:write</code>.
</p></dd>
</dl>

<p>The proceed type <code>:no-action</code> simply proceeds, continuing with the
interrupted program as if the MAR had not been set.  If the trap was due
to writing, the proceed type <code>:proceed-no-write</code> is also provided, and
causes the program to proceed but does not store the value in the memory
location.
</p></dd></dl>

<p>Most&ndash;but not all&ndash;write operations first do a read.  <code>setq</code> and
<code>rplaca</code> are examples.  This means that if the MAR is in <code>:read</code>
mode it will catch writes as well as reads; however, they will trap
during the reading phase, and consequently the data to be written will
not be displayed.  This also means that setting the MAR to <code>t</code> mode
causes most writes to trap twice, first for a read and then again for a
write.  So when the MAR says that it trapped because of a read, this
means a read at the hardware level, which may not look like a read in
your program.
</p>
<a name="Variable-Monitoring"></a>
<h3 class="section">27.14 Variable Monitoring</h3>
<a name="index-monitoring-the-value-of-a-variable"></a>

<a name="monitor_002dvariable_002dfun"></a><dl>
<dt><a name="index-monitor_002dvariable"></a>Function: <strong>monitor-variable</strong> <em>var &amp;optional current-value-cell-only-p monitor-function</em></dt>
<dd><p>Calls a given function just after a given special variable is <code>setq</code>&rsquo;ed
(by compiled code or otherwise).  Does not trigger on binding of the
variable.  The function is given both the old and new values as arguments.
It does not get the name of the variable as an argument, so it is usually
necessary to use a closure as <em>monitor-function</em> in order to remember
this.  The old value will be <code>nil</code> if the variable had been unbound.
</p>
<p>The default monitoring function just prints the symbol and the old and new
values.  This behavior can be changed by specifying the
<em>monitor-function</em> argument.
</p>
<p>Normally this feature applies to all <code>setq</code>&rsquo;s, but if
<em>current-value-cell-only-p</em> is specified non-<code>nil</code>, it applies only to
those <code>setq</code>&rsquo;s which would alter the variable&rsquo;s currently active value
cell.  This is only relevant when <em>var</em> is subject to a closure.
</p>
<p>Don&rsquo;t try to use this with variables that are forwarded to A memory
(e.g <code>inhibit-scheduling-flag</code>).
</p></dd></dl>

<a name="unmonitor_002dvariable_002dfun"></a><dl>
<dt><a name="index-unmonitor_002dvariable"></a>Function: <strong>unmonitor-variable</strong> <em>&amp;optional var</em></dt>
<dd><p>If <em>var</em> is being monitored, it is restored to normal.  If no <em>var</em> is specified,
all variables that have been monitored are unmonitored.
</p></dd></dl>


<a name="How-to-Read-Assembly-Language"></a>
<h2 class="chapter">28 How to Read Assembly Language</h2>
<a name="index-machine-code"></a>
<a name="index-compiled-code"></a>
<a name="macro_002dcode"></a><a name="code_002dchapter"></a><a name="understanding_002dcompiled_002dcode"></a>
<p>Sometimes it is useful to study the machine language code produced by
the Lisp Machine&rsquo;s compiler, usually in order to analyze an error, or
sometimes to check for a suspected compiler problem.  This chapter
explains how the Lisp Machine&rsquo;s instruction set works and how to
understand what code written in that instruction set is doing.
Fortunately, the translation between Lisp and this instruction set is
very simple; after you get the hang of it, you can move back and forth
between the two representations without much trouble.  The following
text does not assume any special knowledge about the Lisp Machine,
although it sometimes assumes some general computer science background
knowledge.
</p>
<a name="Introduction"></a>
<h3 class="section">28.1 Introduction</h3>

<p>Nobody looks at machine language code by trying to interpret octal
numbers by hand.  Instead, there is a program called the Disassembler
which converts the numeric representation of the instruction set into a
more readable textual representation.  It is called the Disassembler
because it does the opposite of what an Assembler would do; however,
there isn&rsquo;t actually any assembler that accepts this input format, since
there is never any need to manually write assembly language for the Lisp
Machine.
</p>
<p>The simplest way to invoke the Disassembler is with the Lisp function
<code>disassemble</code>.  Here is a simple example.  Suppose we type:
</p>
<div class="lisp">
<pre class="lisp">(defun foo (x)
  (assq 'key (get x 'propname)))

(compile 'foo)

(disassemble 'foo)
</pre></div>

<p>This defines the function <code>foo</code>, compiles it, and invokes the Disassembler
to print out the textual representation of the result of the compilation.
Here is what it looks like:
</p>
<div class="lisp">
<pre class="lisp">22 MOVE D-PDL FEF|6           ;'KEY
23 MOVE D-PDL ARG|0           ;X
24 MOVE D-PDL FEF|7           ;'PROPNAME
25 (MISC) GET D-PDL
26 (MISC) ASSQ D-RETURN
</pre></div>

<p>The Disassembler is also used by the Error Handler and the Inspector.
When you see stuff like the above while using one of these programs, it
is disassembled code, in the same format as the <code>disassemble</code> function
uses.  Inspecting a compiled code object shows the disassembled code.
</p>
<p>Now, what does this mean?  Before we get started, there is just a little
bit of jargon to learn.
</p>
<p>The acronym PDL stands for Push Down List, and means the same thing as
Stack: a last-in first-out memory.  The terms PDL and stack will be used
interchangeably.  The Lisp Machine&rsquo;s architecture is rather typical of
&quot;stack machines&quot;; there is a stack that most instructions deal with, and
it is used to hold values being computed, arguments, and local
variables, as well as flow-of-control information.  An important use of
the stack is to pass arguments to instructions, though not all
instructions take their arguments from the stack.
</p>
<p>The acronym &quot;FEF&quot; stands for Function Entry Frame.  A FEF is a compiled
code object produced by the compiler.  After the <code>defun</code> form above
was evaluated, the function cell of the symbol <code>foo</code> contained a
lambda expression.  Then we compiled the function <code>foo</code>, and the
contents of the function cell were replaced by a &quot;FEF&quot; object.  The
printed representation of the &quot;FEF&quot; object for <code>foo</code> looks like this:
</p>
<div class="lisp">
<pre class="lisp">#&lt;DTP-FEF-POINTER 11464337 FOO&gt;
</pre></div>

<p>The FEF has three parts (this is a simplified explanation): a header
with various fixed-format fields; a part holding constants and invisible
pointers, and the main body, holding the machine language instructions.
The first part of the FEF, the header, is not very interesting and is
not documented here (you can look at it with <code>describe</code> but it won&rsquo;t
be easy to understand).  The second part of the FEF holds various
constants referred to by the function; for example, our function <code>foo</code>
references two constants (the symbols <code>key</code> and <code>propname</code>), and so
(pointers to) those symbols are stored in the FEF.  This part of the FEF
also holds invisible pointers to the value cells of all symbols that the
function uses as variables, and invisible pointers to the function cells
of all symbols that the function calls as functions.  The third part of
the FEF holds the machine language code itself.
</p>
<p>Now we can read the disassembled code.  The first instruction looked
like this:
</p>
<div class="lisp">
<pre class="lisp">22 MOVE D-PDL FEF|6           ;'KEY
</pre></div>

<p>This instruction has several parts.  The <code>22</code> is the address of this
instruction.  The Disassembler prints out the address of each
instruction before it prints out the instruction, so that you can
interpret branching instructions when you see them (we haven&rsquo;t seen one
of these yet, but we will later).  The <code>MOVE</code> is an opcode: this is a
<code>MOVE</code> instruction, which moves a datum from one place to another.  The
<code>D-PDL</code> is a destination specification.  The <code>D</code> stands for
&quot;Destination&quot;, and so <code>D-PDL</code> means &quot;Destination-PDL&quot;: the destination
of the datum being moved is the PDL.  This means that the
result will be pushed onto the PDL, rather than just moved to the top;
this instruction is pushing a datum onto the stack.  The next field of
the instruction is <code>FEF|6</code>.  This is an <em>address</em>, and it specifies
where the datum is coming from.  The vertical bar serves to separate the
two parts of the address.  The part before the vertical bar can be
thought of as a <em>base register</em>, and the part after the bar can be
thought of as being an offset from that register.  <code>FEF</code> as a base
register means the address of the FEF that we are disassembling, and so
this address means the location six words into the FEF.  So what this
instruction does is to take the datum located six words into the FEF,
and push it onto the PDL.  The instruction is followed by a &quot;comment&quot;
field, which looks like <code>;'KEY</code>.  This is not a comment that any person
wrote; the disassembler produces these to explain what is going on.  The
semicolon just serves to start the comment, the way semicolons in Lisp
code do.  In this case, the body of the comment, <code>'KEY</code>, is telling us
that the address field (<code>FEF|6</code>) is addressing a constant (that is what
the single-quote in <code>'KEY</code> means), and that the printed representation
of that constant is <code>KEY</code>.  With the help of this &quot;comment&quot; we finally
get the real story about what this instruction is doing: it is pushing
(a pointer to) the symbol <code>key</code> onto the stack.
</p>
<p>The next instruction looks like this:
</p>
<div class="lisp">
<pre class="lisp">23 MOVE D-PDL ARG|0           ;X
</pre></div>

<p>This is a lot like the previous instruction; the only difference is that
a different &quot;base register&quot; is being used in the address.  The <code>ARG</code>
&quot;base register&quot; is used for addressing your arguments: <code>ARG|0</code> means
that the datum being addressed is the zeroth argument.  Again, the
&quot;comment&quot; field explains what that means: the value of X (which was the
zeroth argument) is being pushed onto the stack.
</p>
<p>The third instruction is just like the first one; it pushes the symbol
<code>propname</code> onto the stack.
</p>
<p>The fourth instruction is something new:
</p>
<div class="lisp">
<pre class="lisp">25 (MISC) GET D-PDL
</pre></div>

<p>The first thing we see here is <code>(MISC)</code>.  This means that this is one of
the so-called <em>miscellaneous</em> instructions.  There are quite a few of
these instructions.  With some exceptions, each miscellaneous
instruction corresponds to a Lisp function and has the same name as that
Lisp function.  If a Lisp function has a corresponding miscellaneous
instruction, then that function is hand-coded in Lisp Machine microcode.
</p>
<p>Miscellaneous instructions only have a destination field; they don&rsquo;t
have any address field.  The inputs to the instruction come from the
stack: the top <em>n</em> elements on the stack are used as inputs to the
instruction and popped off the stack, where <em>n</em> is the number of arguments
taken by the function.  The result of the function is stored wherever
the destination field says.  In our case, the function being executed is
<code>get</code>, a Lisp function of two arguments.  The top two values will be
popped off the stack and used as the arguments to <code>get</code> (the value
pushed first is the first argument, the value pushed second is the
second argument, and so on).  The result of the call to <code>get</code> will be
sent to the destination <code>D-PDL</code>; that is, it will be pushed onto the stack.
(In case you were wondering about how we handle optional arguments and
multiple-value returns, the answer is very simple: functions that use
either of those features cannot be miscellaneous instructions!  If you
are curious as to what functions are hand-microcoded and thus available
as miscellaneous instructions, you can look at the <code>defmic</code> forms in the
file <code>SYS: SYS; DEFMIC LISP</code>.)
</p>
<p>The fifth and last instruction is similar to the fourth:
</p>
<div class="lisp">
<pre class="lisp">26 (MISC) ASSQ D-RETURN
</pre></div>

<p>What is new here is the new value of the destination field.  This one is
called <code>D-RETURN</code>, and it can be used anywhere destination
fields in general can be used (like in <code>MOVE</code> instructions).  Sending
something to &quot;Destination-Return&quot; means that this value should be the
returned value of the function, and that we should return from this
function.  This is a bit unusual in instruction sets; rather than having
a &quot;return&quot; instruction, we have a destination that, when stored into,
returns from the function.  What this instruction does, then, is to
invoke the Lisp function <code>assq</code> on the top two elements of the stack
and return the result of <code>assq</code> as the result of this function.
</p>
<p>Now, let&rsquo;s look at the program as a whole and see what it did:
</p>
<div class="lisp">
<pre class="lisp">22 MOVE D-PDL FEF|6           ;'KEY
23 MOVE D-PDL ARG|0           ;X
24 MOVE D-PDL FEF|7           ;'PROPNAME
25 (MISC) GET D-PDL
26 (MISC) ASSQ D-RETURN
</pre></div>

<p>First it pushes the symbol <code>key</code>.  Then it pushes the value of <code>x</code>.
Then it pushes the symbol <code>propname</code>.  Then it invokes <code>get</code>, which
pops the value of <code>x</code> and the symbol <code>propname</code> off the stack and
uses them as arguments, thus doing the equivalent of evaluating the form
<code>(get x 'propname)</code>.  The result is left on the stack; the stack now
contains the result of the <code>get</code> on top, and the symbol <code>key</code>
underneath that.  Next, it invokes <code>assq</code> on these two values, thus
doing the equivalent of evaluating <code>(assq 'key (get x 'propname))</code>.
Finally, it returns the value produced by <code>assq</code>.  Now, the original
Lisp program we compiled was:
</p>
<div class="lisp">
<pre class="lisp">(defun foo (x)
  (assq 'key (get x 'propname)))
</pre></div>

<p>We can see that the code produced by the compiler is correct: it will do
the same thing as the function we defined will do.
</p>
<p>In summary, we have seen two kinds of instructions so far: the <code>MOVE</code>
instruction, which takes a destination and an address, and two of the
large set of miscellaneous instructions, which take only a destination,
and implicitly get their inputs from the stack.  We have seen two
destinations (<code>D-PDL</code> and <code>D-RETURN</code>), and two forms of address (<code>FEF</code>
addressing and <code>ARG</code> addressing).
</p>
<a name="A-More-Advanced-Example"></a>
<h3 class="section">28.2 A More Advanced Example</h3>

<p>Here is a more complex Lisp function, demonstrating local variables,
function calling, conditional branching, and some other new
instructions.
</p>
<div class="lisp">
<pre class="lisp">(defun bar (y)
  (let ((z (car y)))
    (cond ((atom z)
	   (setq z (cdr y))
	   (foo y))
	  (t
	   nil))))
</pre></div>

<p>The disassembled code looks like this:
</p>
<div class="lisp">
<pre class="lisp">20 CAR D-PDL ARG|0            ;Y
21 POP LOCAL|0                ;Z
22 MOVE D-IGNORE LOCAL|0      ;Z
23 BR-NOT-ATOM 30
24 CDR D-PDL ARG|0            ;Y
25 POP LOCAL|0                ;Z
26 CALL D-RETURN FEF|6        ;#'FOO
27 MOVE D-LAST ARG|0          ;Y
30 MOVE D-RETURN 'NIL
</pre></div>

<p>The first instruction here is a <code>CAR</code> instruction.  It has the same
format as <code>MOVE</code>: there is a destination and an address.  The <code>CAR</code>
instruction reads the datum addressed by the address, takes the car of
it, and stores the result into the destination.   In our example, the
first instruction addresses the zeroth argument, and so it computes
<code>(car y)</code>; then it pushes the result onto the stack.
</p>
<p>The next instruction is something new: the <code>POP</code> instruction.  It has an
address field, but it uses it as a destination rather than as a source.
The <code>POP</code> instruction pops the top value off the stack, and stores that
value into the address specified by the address field.  In our example,
the value on the top of the stack is popped off and stored into address
<code>LOCAL|0</code>.  This is a new form of address; it means the zeroth local
variable.  The ordering of the local variables is chosen by the
compiler, and so it is not fully predictable, although it tends to be
by order of appearance in the code; fortunately you never have to look
at these numbers, because the &quot;comment&quot; field explains what is going on.
In this case, the variable being addressed is <code>z</code>.  So this instruction
pops the top value on the stack into the variable <code>z</code>.  The first two
instructions work together to take the car of <code>y</code> and store it into
<code>z</code>, which is indeed the first thing the function <code>bar</code> ought to do.
(If you have two local variables with the same name, then the &quot;comment&quot;
field won&rsquo;t tell you which of the two you&rsquo;re talking about; you&rsquo;ll have
to figure that out yourself.  You can tell two local variables with
the same name apart by looking at the number in the address.)
</p>
<p>The next instruction is a familiar <code>MOVE</code> instruction, but it uses a
new destination: <code>D-IGNORE</code>.  This means that the datum being
addressed isn&rsquo;t moved anywhere.  If so, then why bother doing this
instruction?  The reason is that there is conceptually a set of
<em>indicator</em> bits, as in the PDP-11.  Every instruction that moves or
produces a datum sets the &quot;indicator&quot; bits from that datum so that
following instructions can test them.  So the reason that the <code>MOVE</code>
instruction is being done is so that someone can test the &quot;indicators&quot;
set up by the value that was moved, namely the value of <code>z</code>.
</p>
<p>All instructions except the branch instructions set the &quot;indicator&quot; bits
from the result produced and/or stored by that instruction.  (In fact,
the <code>POP</code> in instruction 21 set the &quot;indicators&quot; properly, and so the
<code>MOVE</code> at instruction 22 is superfluous and the compiler would
eliminate it.)
</p>
<p>The next instruction is a conditional branch; it changes the flow of
control, based on the values in the &quot;indicator&quot; bits.  The instruction
is <code>BR-NOT-ATOM 30</code>, which means &quot;Branch, if the quantity was not an
atom, to location 30; otherwise proceed with execution&quot;.  If <code>z</code> was an
atom, the Lisp Machine branches to location 30, and execution proceeds
there.  (As you can see by skipping ahead, location 30 just contains a
<code>MOVE</code> instruction, which will cause the function to return <code>nil</code>.)
</p>
<p>If <code>z</code> is not an atom, the program keeps going, and the <code>CDR</code>
instruction is next.  This is just like the <code>CAR</code> instruction except
that it takes the cdr; this instruction pushes the value of <code>(cdr y)</code>
onto the stack.  The next one pops that value off into the variable <code>z</code>.
</p>
<p>There are just two more instructions left.  These two instructions will
be our first example of how function calling is compiled.  It is the
only really tricky thing in the instruction set.  Here is how it works
in our example:
</p>
<div class="lisp">
<pre class="lisp">26 CALL D-RETURN FEF|6        ;#'FOO
27 MOVE D-LAST ARG|0          ;Y
</pre></div>

<p>The form being compiled here is <code>(foo y)</code>.  This means we are applying
the function which is in the function cell of the symbol <code>foo</code>, and
passing it one argument, the value of <code>y</code>.  The way function calling
works is in the following three steps.  First of all, there is a <code>CALL</code>
instruction that specifies the function object being applied to
arguments.  This creates a new stack frame on the stack, and stores the
function object there.  Secondly, all the arguments being passed except
the last one are pushed onto the stack.  Thirdly and lastly, the last
argument is sent to a special destination, called <code>D-LAST</code>,
meaning &quot;this is the last argument&quot;.  Storing to this destination is
what actually calls the function, <em>not</em> the <code>CALL</code> instruction itself.
</p>
<p>There are two things you might wonder about this.  First of all, when
the function returns, what happens to the returned value?  Well, this is
what we use the destination field of the <code>CALL</code> instruction for.  The
destination of the <code>CALL</code> is not stored into at the time the <code>CALL</code>
instruction is executed; instead, it is saved on the stack along with
the function operation (in the stack frame created by the <code>CALL</code>
instruction).  Then, when the function actually returns, its result is
stored into that destination.
</p>
<p>The other question is what happens when there isn&rsquo;t any last argument;
that is, when there is a call with no arguments at all?  This is handled
by a special instruction called <code>CALL0</code>.  The address of <code>CALL0</code>
addresses the function object to be called; the call takes place
immediately and the result is stored into the destination specified by
the destination field of the <code>CALL0</code> instruction.
</p>
<p>So, let&rsquo;s look at the two-instruction sequence above.  The first
instruction is a <code>CALL</code>; the function object it specifies is at <code>FEF|6</code>,
which the comment tells us is the contents of the function cell of <code>foo</code>
(the FEF contains an invisible pointer to that function cell).  The
destination field of the <code>CALL</code> is <code>D-RETURN</code>, but we aren&rsquo;t going to
store into it yet; we will save it away in the stack frame and use it
later.  So the function doesn&rsquo;t return at this point, even though it
says <code>D-RETURN</code> in the instruction; this is the tricky part.
</p>
<p>Next we have to push all the arguments except the last one.  Well,
there&rsquo;s only one argument, so nothing needs to be done here.  Finally,
we move the last argument (that is, the only argument: the value of <code>y</code>)
to <code>D-LAST</code>, using the <code>MOVE</code> instruction.  Moving to <code>D-LAST</code> is what
actually invokes the function, so at this point the function <code>foo</code> is
invoked.  When it returns, its result is sent to the destination stored
in the stack frame: <code>D-RETURN</code>.  Therefore, the value returned by the
call to <code>foo</code> will be returned as the value of the function <code>bar</code>.  Sure
enough, this is what the original Lisp code says to do.
</p>
<p>When the compiler pushes arguments to a function call, it sometimes does
it by sending the values to a destination called <code>D-NEXT</code> (meaning the
&quot;next&quot; argument).  This is exactly the same as <code>D-PDL</code> when producing
a compiled function.  The distinction is important when the compiler
output is passed to the microcompiler to generate microcode.
</p>
<p>Here is another example to illustrate function calling.  This Lisp
function calls one function on the results of another function.
</p>
<div class="lisp">
<pre class="lisp">(defun a (x y)
  (b (c x y) y))
</pre></div>

<p>The disassembled code looks like this:
</p>
<div class="lisp">
<pre class="lisp">22 CALL D-RETURN FEF|6        ;#'B
23 CALL D-PDL FEF|7           ;#'C
24 MOVE D-PDL ARG|0           ;X
25 MOVE D-LAST ARG|1          ;Y
26 MOVE D-LAST ARG|1          ;Y
</pre></div>

<p>The first instruction starts off the call to the function <code>b</code>.  The
destination field is saved for later: when this function returns, we
will return its result as <code>a</code>&rsquo;s result.  Next, the call to <code>c</code> is
started.  Its destination field, too, is saved for later; when <code>c</code>
returns, its result should be pushed onto the stack, so that it will be
the next argument to <code>b</code>.  Next, the first and second arguments to
<code>c</code> are passed; the second one is sent to <code>D-LAST</code> and so the
function <code>c</code> is called.  Its result, as we said, will be pushed onto
the stack, and thus become the first argument to <code>b</code>.  Finally, the
second argument to <code>b</code> is passed, by storing in <code>D-LAST</code>; <code>b</code> gets
called, and its result is sent to <code>D-RETURN</code> and is returned from
<code>a</code>.
</p>
<a name="The-Rest-of-the-Instructions"></a>
<h3 class="section">28.3 The Rest of the Instructions</h3>

<p>Now that we&rsquo;ve gotten some of the feel for what is going on, I will
start enumerating the instructions in the instruction set.  The
instructions fall into four classes.  Class I instructions have both a
destination and an address.  Class II instructions have an address, but
no destination.  Class III instructions are the branch instructions,
which contain a branch address rather than a general base-and-offset
address.  Class IV instructions have a destination, but no address;
these are the miscellaneous instructions.
</p>
<p>We have already seen just about all the Class I instructions.  There are
nine of them in all: <code>MOVE</code>, <code>CALL</code>, <code>CALL0</code>, <code>CAR</code>, <code>CDR</code>, <code>CAAR</code>,
<code>CADR</code>, <code>CDAR</code>, and <code>CDDR</code>.  <code>MOVE</code> just moves a datum from an address
to a destination; the <code>CxR</code> and <code>CxxR</code> instructions are the same but
perform the function on the value before sending it to the destination;
<code>CALL</code> starts off a call to a function with some arguments; <code>CALL0</code>
performs a call to a function with no arguments.
</p>
<p>We&rsquo;ve seen most of the possible forms of address.  So far we have seen
the <code>FEF</code>, <code>ARG</code>, and <code>LOCAL</code> base registers.  There are two other
kinds of addresses.  One uses a &quot;constant&quot; base register, which
addresses a set of standard constants: <code>NIL</code>, <code>T</code>, <code>0</code>, <code>1</code>, and
<code>2</code>.  The disassembler doesn&rsquo;t even bother to print out
<code>CONSTANT|<em>n</em></code>, since the number <em>n</em> would not be even slightly
interesting; it just prints out <code>'NIL</code> or <code>'1</code> or whatever.  The
other kind of address is a special one printed as <code>PDL-POP</code>, which
means that to read the value at this address, an object should be popped
off the top of the stack.
</p>
<p>There is a higher number of Class II instructions.  The only one we&rsquo;ve
seen so far is <code>POP</code>, which pops a value off the stack and stores it
into the specified address.  There is another instruction called <code>MOVEM</code>
(from the PDP-10 opcode name, meaning MOVE to Memory), which stores the
top element of the stack into the specified address, but doesn&rsquo;t pop it
off the stack.
</p>
<p>Then there are seven Class II instructions to implement heavily-used
two-argument functions: <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>LOGAND</code>, <code>LOGXOR</code>, and
<code>LOGIOR</code>.  These instructions take their first argument from the top of
the stack (popping them off) and their second argument from the
specified address, and they push their result on the stack.  Thus the
stack level does not change due to these instructions.
</p>
<p>Here is a small function that shows some of these new things:
</p>
<div class="lisp">
<pre class="lisp">(defun foo (x y)
  (setq x (logxor y (- x 2))))
</pre></div>

<p>The disassembled code looks like this:
</p>
<div class="lisp">
<pre class="lisp">16 MOVE D-PDL ARG|1           ;Y
17 MOVE D-PDL ARG|0           ;X
20 - '2
21 LOGXOR PDL-POP
22 MOVEM ARG|0                ;X
23 MOVE D-RETURN PDL-POP
</pre></div>

<p>Instructions 20 and 21 use two of the new Class II instructions: the <code>-</code>
and <code>LOGXOR</code> instructions.  Instructions 21 and 23 use the <code>PDL-POP</code>
address type, and instruction 20 uses the &quot;constant&quot; base register to
get to a fixnum <code>2</code>.  Finally, instruction 22 uses the <code>MOVEM</code>
instruction; the compiler wants to use the top value of the stack to
store it into the value of <code>x</code>, but it doesn&rsquo;t want to pop it off the
stack because it has another use for it: to return it from the function.
</p>
<p>Another four Class II instructions implement some commonly used
predicates: <code>=</code>, <code>&gt;</code>, <code>&lt;</code>, and <code>EQ</code>.  The two arguments come from the
top of the stack and the specified address; the stack is popped, the
predicate is applied to the two objects, and the result is left in the
&quot;indicators&quot; so that a branch instruction can test it, and branch based
on the result of the comparison.  These instructions remove the top
item on the stack and don&rsquo;t put anything back, unlike the previous set,
which put their results back on the stack.
</p>
<p>Next, there are four Class II instructions to read, modify, and write a
quantity in ways that are common in Lisp code.  These instructions are
called <code>SETE-CDR</code>, <code>SETE-CDDR</code>, <code>SETE-1+</code>, and <code>SETE-1-</code>.  The <code>SETE-</code>
means to set the addressed value to the result of applying the specified
one-argument function to the present value.  For example, <code>SETE-CDR</code>
means to read the value addressed, apply <code>cdr</code> to it, and store the
result back in the specified address.  This is used when compiling
<code>(setq x (cdr x))</code>, which commonly occurs in loops; the other functions
are used frequently in loops, too.
</p>
<p>There are two instructions used to bind special variables.  The first is
<code>BIND-NIL</code>, which binds the cell addressed by the address field to
<code>nil</code>; the second is <code>BIND-POP</code>, which binds the cell to an object
popped off the stack rather than <code>nil</code>.  The latter instruction pops a
value off the stack; the former does not use the stack at all.
</p>
<p>There are two instructions to store common values into addressed cells.
<code>SET-NIL</code> stores <code>nil</code> into the cell specified by the address field;
<code>SET-ZERO</code> stores <code>0</code>.  Neither instruction uses the stack at all.
</p>
<p>Finally, the <code>PUSH-E</code> instruction creates a locative pointer to the cell
addressed by the specified address, and pushes it onto the stack.  This
is used in compiling <code>(value-cell-location 'z)</code> where <code>z</code> is an
argument or a local variable, rather than a symbol (special variable).
</p>
<p>Those are all of the Class II instructions.  Here is a contrived
example that uses some of the ones we haven&rsquo;t seen, just to show
you what they look like:
</p>
<div class="lisp">
<pre class="lisp">(declare (special *foo* *bar*))

(defun weird (x y)
  (cond ((= x y)
	 (let ((*foo* nil) (*bar* 5))
	   (setq x (cdr x)))
	 nil)
	(t
	 (setq x nil)
	 (caar (value-cell-location 'y)))))
</pre></div>

<p>The disassembled code looks like this:
</p>
<div class="lisp">
<pre class="lisp">24 MOVE D-PDL ARG|0           ;X
25 = ARG|1                    ;Y
26 BR-NIL 35
27 BIND-NIL FEF|6             ;*FOO*
30 MOVE D-PDL FEF|8           ;'5
31 BIND-POP FEF|7             ;*BAR*
32 SETE-CDR ARG|0             ;X
33 (MISC) UNBIND 2 bindings 
34 MOVE D-RETURN 'NIL
35 SET-NIL ARG|0              ;X
36 PUSH-E ARG|1               ;Y
37 CAAR D-RETURN PDL-POP
</pre></div>

<p>Instruction 25 is an <code>=</code> instruction; it numerically compares the top of the
stack, <code>x</code>, with the addressed quantity, <code>y</code>.  The <code>x</code> is
popped off the stack, and the indicators are set to the result of the
equality test.  Instruction 26 checks the indicators, branching to 35 if
the result of the call to <code>=</code> was NIL; that is, the machine will
branch to 35 if the two values were not equal.  Instruction 27 binds
<code>*foo*</code> to <code>nil</code>; instructions 30 and 31 bind <code>*bar*</code> to <code>5</code>.
Instruction 32 demonstrates the use of <code>SETE-CDR</code> to compile <code>(setq x
(cdr x))</code>, and instruction 35 demonstrates the use of <code>SET-NIL</code> to
compile <code>(setq x nil)</code>.  Instruction 36 demonstrates the use of
<code>PUSH-E</code> to compile <code>(value-cell-location 'y)</code>.
</p>
<p>The next class of instructions, Class III, are the branching
instructions.  These have neither addresses nor destinations of the
usual sort.  Instead, they have branch-addresses; they say where to
branch, if the branch is going to happen.  There are several
instructions, differing in the conditions under which they branch
and whether they pop the stack.  Branch-addresses are stored internally
as self-relative addresses, to make Lisp Machine code relocatable, but
the disassembler does the addition for you and prints out FEF-relative
addresses so that you can easily see where the branch is going to.
</p>
<p>The branch instructions we have seen so far decide whether to branch on
the basis of the &quot;nil indicator&quot;, that is, whether the last value dealt
with was <code>nil</code> or non-<code>nil</code>.  <code>BR-NIL</code> branches if it was <code>nil</code>, and
<code>BR-NOT-NIL</code> branches if it was not <code>nil</code>.  There are two more
instructions that test the result of the <code>atom</code> predicate on the last
value dealt with.  <code>BR-ATOM</code> branches if the value was an atom (that is,
if it was anything besides a cons). and <code>BR-NOT-ATOM</code> branches if the
value was not an atom (that is, if it was a cons).  The <code>BR</code> instruction
is an unconditional branch (it always branches).
</p>
<p>None of the above branching instructions deal with the stack.  There are
two more instructions called <code>BR-NIL-POP</code> and <code>BR-NOT-NIL-POP</code>, which
are the same as <code>BR-NIL</code> and <code>BR-NOT-NIL</code> except that if the branch is
not done, the top value on the stack is popped off the stack.  These are
used for compiling <code>and</code> and <code>or</code> special forms.
</p>
<p>Finally, there are the Class IV instructions, most of which are
miscellaneous hand-microcoded Lisp functions. The file <code>SYS: SYS;
DEFMIC LISP</code> has a list of all the miscellaneous instructions.  Most
correspond to Lisp functions, including the subprimitives, although some
of these functions are very low level internals that may not be
documented anywhere (don&rsquo;t be disappointed if you don&rsquo;t understand all
of them).  Please do not look at this file in hopes of finding obscure
functions that you think you can use to speed up your programs; in fact,
the compiler automatically uses these things when it can, and directly
calling weird internal functions will only serve to make your code hard
to read, without making it any faster.  In fact, we don&rsquo;t guarantee that
calling undocumented functions will continue to work in the future.
</p>
<p>The <code>DEFMIC</code> file can be useful for determining if a given function is in
microcode, although the only definitive way to tell is to compile some
code that uses it and look at the results, since sometimes the compiler
converts a documented function with one name into an undocumented one
with another name.
</p>

<a name="Function-Entry"></a>
<h3 class="section">28.4 Function Entry</h3>

<p>When a function is first entered in the Lisp Machine, interesting things
can happen because of the features that are invoked by use of the
various &quot;<code>&amp;</code>&quot; keywords.  The microcode performs various services when
a function is entered, even before the first instruction of the function
is executed.  These services are called for by various fields of the
header portion of the FEF, including a list called the <em>Argument
Descriptor List</em>, or <em>ADL</em>.  We won&rsquo;t go into the detailed format of
any of this, as it is complex and the details are not too interesting.
Disassembling a function that makes use of the ADL prints a summary of
what the ADL says to do, before the beginning of the code.
</p>
<p>The function-entry services include the initialization of unsupplied
optional arguments and of <code>&amp;AUX</code> variables.  The ADL
has a little instruction set of its own, and if the form that computes
the initial value is something simple, such as a constant or a
variable, then the ADL can handle things itself.  However, if things get
too complicated, instructions are needed, and the compiler generates
some instructions at the front of the function to initialize the
unsupplied variables.  In this case, the ADL specifies several different
starting addresses for the function, depending on which optional arguments
have been supplied and which have been omitted.  If all the optional
arguments are supplied, then the ADL starts the function off after all
the instructions that would have initialized the optional arguments;
since the arguments were supplied, their values should not be set, and
so all these instructions are skipped over.  Here&rsquo;s an example:
</p>
<div class="lisp">
<pre class="lisp">(declare (special *y*))

(defun foo (&amp;optional (x (car *y*)) (z (* x 3)))
  (cons x z)
</pre></div>

<p>The disassembled code looks like this:
</p>
<div class="lisp">
<pre class="lisp">Arg 0 (X) is optional, local,
  initialized by the code up to pc 34.
Arg 1 (Z) is optional, local,
  initialized by the code up to pc 37.

32 CAR D-PDL FEF|6            ;*Y*
33 POP ARG|0                  ;X
34 MOVE D-PDL ARG|0           ;X
35 * FEF|11                   ;'3
36 POP ARG|1                  ;Z
37 MOVE D-PDL ARG|0           ;X
40 MOVE D-PDL ARG|1           ;Z
41 (MISC) CONS D-RETURN
</pre></div>

<p>If no arguments are supplied, the function will be started at
instruction 32; if only one argument is supplied, it will be started at
instruction 34; if both arguments are supplied, it will be started at
instruction 37.
</p>
<p>The thing to keep in mind here is that when there is initialization of
variables, you may see it as code at the beginning of the function, or
you may not, depending upon whether it is too complex for the ADL to handle.
This is true of <code>&amp;aux</code> variables as well as unsupplied <code>&amp;optional</code>
arguments.
</p>
<p>When there is a <code>&amp;rest</code> argument, it is passed to the function as the
zeroth local variable, rather than as any of the arguments.  This is not
really so confusing as it might seem, since a <code>&amp;rest</code> argument is not
an argument passed by the caller; rather it is a list of some of the
arguments, created by the function-entry microcode services.  In any case
the &quot;comment&quot; tells you what is going on.  In fact, one hardly ever
looks much at the address fields in disassembled code, since the
&quot;comment&quot; tells you the right thing anyway.  Here is a silly example of the
use of a <code>&amp;rest</code> argument:
</p>
<div class="lisp">
<pre class="lisp">(defun prod (&amp;rest values)
  (apply #'* values))
</pre></div>

<p>The disassembled code looks like this:
</p>
<div class="lisp">
<pre class="lisp">20 MOVE D-PDL FEF|6           ;#'*
21 MOVE D-PDL LOCAL|0         ;VALUES
22 (MISC) APPLY D-RETURN
</pre></div>

<p>As can be seen, <code>values</code> is referred to as <code>LOCAL|0</code>.
</p>
<p>Another thing the microcode does at function entry is to bind the
values of any arguments or <code>&amp;aux</code> variables that are special.
Thus, you won&rsquo;t see <code>BIND</code> instructions doing this, but it
is still being done.
</p>
<a name="Special-Class-IV-Instructions"></a>
<h3 class="section">28.5 Special Class IV Instructions</h3>

<p>We said earlier that most of the Class IV instructions are miscellaneous
hand-microcoded Lisp functions.  However, a few of them are not Lisp
functions at all.  There are two instructions that are printed as
<code>UNBIND 3 bindings</code> or <code>POP 7 values</code>; the number can be
anything up to 16 (these numbers are printed in decimal).  These
instructions just do what they say, unbinding the last <em>n</em> values that
were bound or popping the top <em>n</em> values off the stack.
</p>
<p>The array referencing functions&ndash;<code>aref</code>, <code>aset</code>, and <code>aloc</code>&ndash;take
a variable number of arguments, but they are handled differently
depending on how many there are.  For one-, two-, and three-dimensional
arrays, these functions are turned into internal functions with names
<code>ar-1</code>, <code>as-1</code>, and <code>ap-1</code> (with the number of dimensions
substituted for <code>1</code>).  Again, there is no point in using these
functions yourself; it would only make your code harder to understand
but not any faster at all.  When there are more than three dimensions,
the functions <code>aref</code>, <code>aset</code> and <code>aloc</code> are called in the ordinary
manner.
</p>
<p>When you call a function and expect to get more than one value back,
a slightly different kind of function calling is used.  Here is an example
that uses <code>multiple-value</code> to get two values back from a function call:
</p>
<div class="lisp">
<pre class="lisp">(defun foo (x)
  (let (y z)
    (multiple-value (y z)
      (bar 3))
    (+ x y z)))
</pre></div>

<p>The disassembled code looks like this:
</p>
<div class="lisp">
<pre class="lisp">22 MOVE D-PDL FEF|6           ;#'BAR
23 MOVE D-PDL '2
24 (MISC) %CALL-MULT-VALUE D-IGNORE
25 MOVE D-LAST FEF|7          ;'3
26 POP LOCAL|1                ;Z
27 POP LOCAL|0                ;Y
30 MOVE D-PDL ARG|0           ;X
31 + LOCAL|0                  ;Y
32 + LOCAL|1                  ;Z
33 MOVE D-RETURN PDL-POP
</pre></div>

<p>A <code>%CALL-MULT-VALUE</code> instruction is used instead of a <code>CALL</code>
instruction.  The destination field of <code>%CALL-MULT-VALUE</code> is unused and
will always be <code>D-IGNORE</code>.  <code>%CALL-MULT-VALUE</code> takes two &quot;arguments&quot;,
which it finds on the stack; it pops both of them.  The first one is the
function object to be applied; the second is the number of return values
that are expected.  The rest of the call proceeds as usual, but when the
call returns, the returned values are left on the stack.  The number of
objects left on the stack is always the same as the second &quot;argument&quot; to
<code>%CALL-MULT-VALUE</code>.  In our example, the two values returned are left
on the stack, and they are immediately popped off into <code>z</code> and <code>y</code>.
There is also a <code>%CALL0-MULT-VALUE</code> instruction, for the same
reason <code>CALL0</code> exists.
</p>
<p>The <code>multiple-value-bind</code> form works similarly; here is an
example:
</p>
<div class="lisp">
<pre class="lisp">(defun foo (x)
  (multiple-value-bind (y *foo* z)
      (bar 3)
    (+ x y z)))
</pre></div>

<p>The disassembled code looks like this:
</p>
<div class="lisp">
<pre class="lisp">24 MOVE D-PDL FEF|8           ;#'BAR
25 MOVE D-PDL FEF|7           ;'3
26 (MISC) %CALL-MULT-VALUE D-IGNORE
27 MOVE D-LAST FEF|7          ;'3
30 POP LOCAL|1                ;Z
31 BIND-POP FEF|6             ;*FOO*
32 POP LOCAL|0                ;Y
33 MOVE D-PDL ARG|0           ;X
34 + LOCAL|0                  ;Y
35 + LOCAL|1                  ;Z
36 MOVE D-RETURN PDL-POP
</pre></div>

<p>The <code>%CALL-MULT-VALUE</code> instruction is still used, leaving the results
on the stack; these results are used to bind the variables.
</p>
<p>Calls done with <code>multiple-value-list</code> work with the <code>%CALL-MULT-VALUE-LIST</code>
instruction.  It takes one &quot;argument&quot; on the stack: the function object
to apply.  When the function returns, the list of values is left on the
top of the stack.  Here is an example:
</p>
<div class="lisp">
<pre class="lisp">(defun foo (x y)
  (multiple-value-list (foo 3 y x)))
</pre></div>

<p>The disassembled code looks like this:
</p>
<div class="lisp">
<pre class="lisp">22 MOVE D-PDL FEF|6           ;#'FOO
23 (MISC) %CALL-MULT-VALUE-LIST D-IGNORE
24 MOVE D-PDL FEF|7           ;'3
25 MOVE D-PDL ARG|1           ;Y
26 MOVE D-LAST ARG|0          ;X
27 MOVE D-RETURN PDL-POP
</pre></div>

<p>Returning of more than one value from a function is handled
by special miscellaneous instructions.  <code>%RETURN-2</code> and <code>%RETURN-3</code> are
used to return two or three values; these instructions take two
and three arguments, respectively, on the stack and return from the
current function just as storing to <code>D-RETURN</code> would.  If there are more
than three return values, they are all pushed, then the number
that there were is pushed, and then the <code>%RETURN-N</code> instruction is
executed.  None of these instructions use their destination field.
Note: the <code>return-list</code> function is just an ordinary miscellaneous
instruction; it takes the list of values to return as an argument on the
stack and returns those values from the current function.
</p>
<p>The function <code>lexpr-funcall</code> is compiled using a special instruction
called <code>%SPREAD</code> to iterate over the elements of its last argument, which
should be a list.  <code>%SPREAD</code> takes one argument (on the stack), which is
a list of values to be passed as arguments (pushed on the stack).  If
the destination of <code>%SPREAD</code> is <code>D-PDL</code> (or <code>D-NEXT</code>), then the values
are just pushed; if it is <code>D-LAST</code>, then after the values are pushed,
the function is invoked.  <code>lexpr-funcall</code> will always compile using a
<code>%SPREAD</code> whose destination is <code>D-LAST</code>.  Here is an example:
</p>
<div class="lisp">
<pre class="lisp">(defun foo (a b &amp;rest c)
  (lexpr-funcall #'format t a c)
  b)
</pre></div>

<p>The disassembled code looks like this:
</p>
<div class="lisp">
<pre class="lisp">20 CALL D-IGNORE FEF|6        ;#'FORMAT
21 MOVE D-PDL 'T
22 MOVE D-PDL ARG|0           ;A
23 MOVE D-PDL LOCAL|0         ;C
24 (MISC) %SPREAD D-LAST
25 MOVE D-RETURN ARG|1        ;B
</pre></div>

<p>Note that in instruction 23, the address <code>LOCAL|0</code> is used to
access the <code>&amp;rest</code> argument.
</p>
<p>The <code>*catch</code> special form is also handled specially by the compiler.
Here is a simple example of <code>*catch</code>:
</p>
<div class="lisp">
<pre class="lisp">(defun a ()
  (*catch 'foo (bar)))
</pre></div>

<p>The disassembled code looks like this:
</p>
<div class="lisp">
<pre class="lisp">22 MOVE D-PDL FEF|6           ;'26
23 (MISC) %CATCH-OPEN D-PDL
24 MOVE D-PDL FEF|7           ;'FOO
25 CALL0 D-LAST FEF|8         ;#'BAR
26 MOVE D-RETURN PDL-POP
</pre></div>

<p>The <code>%CATCH-OPEN</code> instruction is like the <code>CALL</code> instruction; it
starts a call to the <code>*catch</code> function.  It takes one &quot;argument&quot; on
the stack, which is the location in the program that should be branched
to if this <code>*catch</code> is <code>*throw</code>n to.  In addition to saving that
program location, the instruction saves the state of the stack and
of special-variable binding so that they can be restored in the event
of a <code>*throw</code>.  So instructions 22 and 23
start a <code>*catch</code> block, and the rest of the function passes its two
arguments.  The <code>*catch</code> function itself simply returns its second
argument; but if a <code>*throw</code> happens during the evaluation of the
<code>(bar)</code> form, then the stack will be unwound and execution will resume
at instruction 26.  The destination field of <code>%CATCH-OPEN</code> is like
that of <code>CALL</code>; it is saved on the stack, and controls what will
be done with the result of the call to the <code>*catch</code>.  Note that
even though <code>*catch</code> is really a Lisp special form, it is compiled
more or less as if it were a function of two arguments.
</p>
<p>To allow compilation of <code>(multiple-value (...) (*catch ...))</code>, there
is a special instruction called <code>%CATCH-OPEN-MULT-VALUE</code>, which is a
cross between <code>%CATCH-OPEN</code> and <code>%CALL-MULT-VALUE</code>.
<code>multiple-value-list</code> with <code>*catch</code> works by asking for all four
values and passing them to the function <code>list</code>.
</p>
<a name="Estimating-Run-Time"></a>
<h3 class="section">28.6 Estimating Run Time</h3>

<p>You may sometimes want to estimate the speed at which a function will
execute by examination of the compiled code.  This section gives some
rough guidelines to the relative cost of various instructions; the
actual speed may vary from these estimates by as much as a factor of
two.  Some of these speeds vary with time; they speed up as work is
done to improve system efficiency and slow down sometimes when
sweeping changes are made (for instance, when garbage collection was
introduced it slowed down some operations even when garbage collection
is not turned on).  However these changes are usually much less than
a factor of two.
</p>
<p>It is also important to realize that in many programs the
execution time is determined by paging rather than by CPU run time.  The
cost of paging is unfortunately harder to estimate than run time,
because it depends on dynamic program behavior and locality of data
structure.
</p>
<p>On a conventional computer such as the PDP-10, rough estimates of the
run time of compiled code are fairly easy to make.  It is a reasonable
approximation to assume that all machine instructions take about the
same amount of time to execute.  When the compiler generates a call to
a runtime support routine, the user can estimate the speed of that
routine since it is implemented in the same instructions as the user&rsquo;s
compiled program.  Actual speeds can vary widely because of data
dependencies; for example, when using the <code>plus</code> function the operation
will be much slower if an argument is a bignum than if the arguments are
all fixnums.  However, in Maclisp most performance-critical functions use
declarations to remove such data dependencies, because generic, data-dependent
operations are so much slower than type-specific operations.
</p>
<p>Things are different in the Lisp Machine.  The instruction set we have just seen
is a high-level instruction set.  Rather than specifying each individual
machine operation, the compiler calls for higher-level Lisp operations such
as <code>cdr</code> or <code>memq</code>.  This means that some instructions take many times
longer to execute than others.  Furthermore, in the Lisp machine we do not
use data-type declarations.  Instead the machine is designed so that all
instructions can be <em>generic</em>; that is, they determine the types of their
operands at run time.  This means that there are data dependencies that can
have major effects on the speed of execution of an instruction.  For instance,
the <code>+</code> instruction is quite fast if both operands turn out to be fixnums,
but much slower if they are bignums.
</p>
<p>The Lisp machine also has a large amount of microcode, both to implement
certain Lisp functions and to assist with common operations such as
function calling.  It is not as easy for a user to read microcode and
estimate its speed as it is with compiled code, although the Lisp
machine has a much more readable microcode than most computers.
</p>
<p>In this section we give some estimates of the speed of various operations.
There are also facilities for measuring the actual achieved speed of a
program.  These will not be documented here as they are currently being changed.
</p>
<p>We will express all times in terms of the time to execute the simplest
instruction, <code>MOVE D-PDL ARG|0</code>.  This time is about two microseconds
and will be called a &quot;unit&quot;.
</p>
<p><code>MOVE</code> takes the same amount of time if the destination is
<code>D-IGNORE</code> or <code>D-NEXT</code>, or if the address is a <code>LOCAL</code> or
<code>PDL-POP</code> rather than an <code>ARG</code>.  A <code>MOVE</code> that references a
constant, via either the <code>FEF</code> base register or the <code>CONSTANT</code> base
register, takes about two units.  A <code>MOVE</code> that references a special
variable by means of the <code>FEF</code> base register and an invisible pointer
takes closer to three units.
</p>
<p>Use of a complex destination (<code>D-LAST</code>, <code>D-RETURN</code>, or <code>D-NEXT-LIST</code>)
takes extra time because of the extra work it has to do: calling a function,
returning from a function, or doing the bookkeeping associated with forming a list.
These costs will be discussed a bit later.
</p>
<p>The other Class I instructions take longer than <code>MOVE</code>.  Each memory
reference required by car/cdr operations costs about one unit.  Note
that <code>cdr</code> requires one memory cycle if the list is compactly
cdr-coded and two cycles if it is not.  The <code>CALL</code> instruction takes
three units.  The <code>CALL0</code> instruction takes more, of course,
since it actually calls the function.
</p>
<p>The Class II (no destination) instructions vary.  The <code>MOVEM</code> and <code>POP</code>
operations take about one unit.  (Of course they take more if <code>FEF</code> or
<code>CONSTANT</code> addressing is used.)  The arithmetic and logical operations and
the predicates take two units when applied to fixnums, except for multiplication and division
which take five.  The <code>SETE-1+</code> and <code>SETE-1-</code> instructions take
two units, the same time as a push followed by a pop; i.e <code>(setq x (1+ x))</code> takes
the same amount of time as <code>(setq x y)</code>.  The <code>SET-NIL</code> and <code>SET-ZERO</code>
instructions take one unit.  The special-variable binding instructions take
several units.
</p>
<p>A branch takes between one and two units.
</p>
<p>The cost of calling a function with no arguments and no local variables
that doesn&rsquo;t do anything but return <code>nil</code> is about 15 units (7 cdrs or
additions).  This is the cost of a <code>CALL FEF|<em>n</em></code> instruction,
a <code>MOVE</code> to <code>D-LAST</code>, the simplest
form of function-entry services, and a <code>MOVE</code> to <code>D-RETURN</code>.  If the
function takes arguments the cost of calling the function includes the cost
of the instructions in the caller that compute the arguments.  If the function
has local variables initialized to <code>nil</code> or optional arguments defaulted
to <code>nil</code> there is a negligible additional cost.  The cost of having a <code>&amp;rest</code>
argument is less than one additional unit.  But if the function binds special
variables there is an additional cost of 8 units per variable (this includes both
binding the variables on entry and unbinding them on return).
</p>
<p>If the function needs an ADL, typically because of complex
optional-argument initializations, the cost goes up substantially.  It&rsquo;s
hard to characterize just how much it goes up by, since this depends on
what you do.  Also calling for multiple values is more expensive than
simple calling.
</p>
<p>We consider the cost of calling functions to be somewhat higher than it should
be, and would like to improve it.  But this might require incompatible system
architecture changes and probably will not happen, at least not soon.
</p>
<p>Flonum and bignum arithmetic are naturally slower than fixnum arithmetic.
For instance, flonum addition takes 8 units more than fixnum addition, and
addition of 60-bit bignums takes 15 units more.  Note that these times include
some garbage-collection overhead for the intermediate results which have
to be created in memory.  Fixnums and small flonums do not take up any
memory and avoid this overhead.  Thus small-flonum addition takes only about
2 units more than fixnum addition.  This garbage-collection overhead is
of the &quot;extra-pdl-area&quot; sort rather than the full Baker garbage collector
sort; if you don&rsquo;t understand this don&rsquo;t worry about it for now.
</p>
<p>Floating-point subtraction, multiplication, and division take just about
the same time as floating-point addition.  Floating-point execution times
can be as many as 3 units longer depending on the arguments.
</p>
<p>The run time of a Class IV (or miscellaneous) instruction depends on the
instruction and its arguments.  The simplest instructions, predicates
such as <code>atom</code> and <code>numberp</code>, take 2 units.  This is basically the
overhead for doing a Class IV instruction.  The cost of a more complex
instruction can be estimated by looking at what it has to do.  You can
get a reasonable estimate by charging one unit per memory reference, car
operation, or cdr-coded cdr operation.  A non-cdr-coded cdr operation
takes two units.  For instance, <code>(memq 'nil '(a b c))</code> takes 13 units, of
which 4 are pushing the arguments on the stack, 2 are Class IV
instruction overhead, 6 are accounted for by cars and cdrs, and 1 is
&quot;left over&quot;.
</p>
<p>The cost of array accessing depends on the type of array and the number
of dimensions.  <code>aref</code> of a 1-dimensional non-indirect <code>art-q</code> array
takes 6 units and <code>aset</code> takes 5 units, not counting pushing the
arguments onto the stack.  (These are the costs of the <code>AR-1</code> and
<code>AS-1</code> instructions.)  A 2-dimensional array takes 6 units more.
<code>aref</code> of a numeric array takes the same amount of time as <code>aref</code> of
an <code>art-q</code> array.  <code>aset</code> takes 1 unit longer.  <code>aref</code> of an
<code>art-float</code> array takes 5 units longer than <code>aref</code> of an <code>art-q</code>
array.  <code>aset</code> takes 3 units longer.
</p>
<p>The functions <code>copy-array-contents</code> and <code>copy-array-portion</code>
optimize their array accessing to remove overhead from the inner loop.
<code>copy-array-contents</code> of an <code>art-q</code> array has a startup overhead of
8 units, not including pushing the arguments, then costs just over 2
units per array element.
</p>
<p>The <code>cons</code> function takes 7 units if garbage collection is turned off.
<code>(list a b c d)</code> takes 24 units, which includes 4 units for getting the
local variables <code>a</code>, <code>b</code>, <code>c</code>, and <code>d</code>.
</p>
<a name="g_t_0022Querying-the-User_0022"></a>
<h2 class="chapter">29 &quot;Querying the User&quot;</h2>
<a name="index-querying-the-user"></a>
<a name="index-yes_002dor_002dno"></a>
<a name="query_002dchapter"></a>
<p>The following functions provide a convenient and consistent interface for
asking questions of the user.  Questions are printed and the answers are
read on the stream <code>query-io</code>, which normally is synonymous with
<code>terminal-io</code> but can be rebound to another stream for special applications.
</p>
<p>We will first describe two simple functions for yes-or-no questions, then
the more general function on which all querying is built.
</p>
<a name="y_002dor_002dn_002dp_002dfun"></a><dl>
<dt><a name="index-y_002dor_002dn_002dp"></a>Function: <strong>y-or-n-p</strong> <em>&amp;optional message stream</em></dt>
<dd><p>This is used for asking the user a question whose answer is either &quot;yes&quot;
or &quot;no&quot;.  It types out <em>message</em> (if any), reads a one-character
answer, echoes it as &quot;<code>Yes</code>&quot; or &quot;<code>No</code>&quot;, and returns <code>t</code> if the
answer is &quot;yes&quot; or <code>nil</code> if the answer is &quot;no&quot;.  The characters which
mean &quot;yes&quot; are <code>Y</code>, <code>T</code>, <code>Space</code>, and <code>Hand-up</code>.  The characters
which mean &quot;no&quot; are <code>N</code>, <code>Rubout</code>, and <code>Hand-down</code>.  If any other
character is typed, the function will beep and demand a &quot;Y or N&quot; answer.
</p>
<p>If the <em>message</em> argument is supplied, it will be printed on a fresh line
(using the <code>:fresh-line</code> stream operation).
Otherwise the caller is assumed to have printed the message already.
You should include a question mark and a space at the end of the message.
<code>y-or-n-p</code> does type &quot;(Y or N)&quot; for you.
<em>stream</em> defaults to the value of <code>query-io</code>.
</p>
<p><code>y-or-n-p</code> should be used only for questions that the user knows are
coming.  If the user is not going to be anticipating the question (e.g
if the question is &quot;Do you really want to delete all of your files?&quot; out
of the blue) then <code>y-or-n-p</code> should not be used, because the user
might type ahead a <code>T</code>, <code>Y</code>, <code>N</code>, <code>Space</code>, or <code>Rubout</code>, and
therefore accidentally answer the question.  In such cases, use
<code>yes-or-no-p</code>.
</p></dd></dl>

<a name="yes_002dor_002dno_002dp_002dfun"></a><dl>
<dt><a name="index-yes_002dor_002dno_002dp"></a>Function: <strong>yes-or-no-p</strong> <em>&amp;optional message stream</em></dt>
<dd><p>This is used for asking the user a question whose answer is either
&quot;Yes&quot; or &quot;No&quot;.  It types out <em>message</em> (if any), beeps, and reads in a line
from the keyboard.  If the line is the string &quot;Yes&quot;, it returns <code>t</code>.
If the line is &quot;No&quot;, it returns <code>nil</code>.  (Case is ignored, as are
leading and trailing spaces and tabs.)  If the input line is anything else,
<code>yes-or-no-p</code> beeps and demands a &quot;yes&quot; or &quot;no&quot; answer.
</p>
<p>If the <em>message</em> argument is supplied, it will be printed on a fresh line
(using the <code>:fresh-line</code> stream operation).
Otherwise the caller is assumed to have printed the message already.
You should include a question mark and a space at the end of the message.
<code>yes-or-no-p</code> does type &quot;(Yes or No)&quot; for you.
<em>stream</em> defaults to the value of <code>query-io</code>.
</p>
<p>To allow the user to answer a yes-or-no question with a single
character, use <code>y-or-n-p</code>.  <code>yes-or-no-p</code> should be
used for unanticipated or momentous questions; this is why it beeps
and why it requires several keystrokes to answer it.
</p></dd></dl>

<a name="fquery_002dfun"></a><dl>
<dt><a name="index-fquery"></a>Function: <strong>fquery</strong> <em>options format-string &amp;rest format-args</em></dt>
<dd><p>Asks a question, printed by <code>(format query-io <em>format-string</em> <em>format-args</em>...)</code>,
and returns the answer.  <code>fquery</code> takes care of checking for valid answers,
reprinting the question when the user clears the screen, giving help, and so
forth.
</p>
<p><em>options</em> is a list of alternating keywords and values, used to select among a variety
of features.  Most callers pass a constant list as the <em>options</em>
(rather than consing up a list whose contents varies).
The keywords allowed are:
</p><dl compact="compact">
<dt><code>:type</code></dt>
<dd><p>What type of answer is expected.  The currently-defined types are
<code>:tyi</code> (a single character), <code>:readline</code> or
<code>:mini-buffer-or-readline</code> (a line terminated by a carriage return).
<code>:tyi</code> is the default.  <code>:mini-buffer-or-readline</code> is nearly
the same as <code>:readline</code>, the only difference being that the former
uses a minibuffer if used inside the editor. 
</p>
</dd>
<dt><code>:choices</code></dt>
<dd><p>Defines the allowed answers.  The allowed forms of choices are complicated and
explained below.  The default is the same set of choices as the <code>y-or-n-p</code>
function (see above).  Note that the <code>:type</code> and <code>:choices</code> options should
be consistent with each other.
</p>
</dd>
<dt><code>:list-choices</code></dt>
<dd><p>If <code>t</code>, the allowed choices are listed (in parentheses) after the question.
The default is <code>t</code>; supplying <code>nil</code> causes the choices not to be listed unless
the user tries to give an answer which is not one of the allowed choices.
</p>
</dd>
<dt><code>:help-function</code></dt>
<dd><p>Specifies a function to be called if the user hits the <code>HELP</code> key.
The default help-function simply lists the available choices.
Specifying <code>nil</code> disables special treatment of <code>HELP</code>.
Specifying a function of three arguments&ndash;the stream, the list of choices,
and the type-function&ndash;allows smarter help processing.  The type-function
is the internal form of the <code>:type</code> option and can usually be ignored.
</p>
</dd>
<dt><code>:condition</code></dt>
<dd><p>If non-<code>nil</code>, a signal name (see <a href="#signal_002dname">signal-name</a>) to be signalled
before asking the question.  A condition handler may handle the
condition, specifying an answer for <code>fquery</code> to return, in which case
the user is not asked.  The details are given below.  The default
signal name is <code>:fquery</code>, which signals condition name <code>:fquery</code>.
</p>
</dd>
<dt><code>:fresh-line</code></dt>
<dd><p>If <code>t</code>, <code>query-io</code> is advanced to a fresh line before asking the question.
If <code>nil</code>, the question is printed wherever the cursor was left by previous typeout.
The default is <code>t</code>.
</p>
</dd>
<dt><code>:beep</code></dt>
<dd><p>If <code>t</code>, <code>fquery</code> beeps to attract the user&rsquo;s attention to the question.
The default is <code>nil</code>, which means not to beep unless the user tries to
give an answer which is not one of the allowed choices.
</p>
</dd>
<dt><code>:stream</code></dt>
<dd><p>The value should be either an i/o stream or a symbol or expression
that will evaluate to one.  <code>fquery</code> uses the specified stream
instead of <code>query-io</code> for all its input and output.
</p>
</dd>
<dt><code>:clear-input</code></dt>
<dd><p>If <code>t</code>, <code>fquery</code> throws away type-ahead before reading the user&rsquo;s response
to the question.  Use this for unexpected questions.  The default is <code>nil</code>,
which means not to throw away typeahead unless the user tries to
give an answer which is not one of the allowed choices.  In that case, typeahead
is discarded since the user probably wasn&rsquo;t expecting the question.
</p>
</dd>
<dt><code>:select</code></dt>
<dd><p>If <code>t</code> and <code>query-io</code> is a visible window, that window is temporarily
selected while the question is being asked.  The default is <code>nil</code>.
</p>
</dd>
<dt><code>:make-complete</code></dt>
<dd><p>If <code>t</code> and <code>query-io</code> is a typeout-window, the window is &quot;made complete&quot;
after the question has been answered.  This tells the system that the contents
of the window are no longer useful.  Refer to the window system documentation
for further explanation.  The default is <code>t</code>.
</p></dd>
</dl>

<p>The argument to the <code>:choices</code> option is a list each of whose elements is
a <em>choice</em>.  The cdr of a choice is a list of the user inputs which correspond
to that choice.  These should be characters for <code>:type :tyi</code> or strings
for <code>:type :readline</code>.  The car of a choice is either a symbol which <code>fquery</code>
should return if the user answers with that choice, or a list whose first element
is such a symbol and whose second element is the string to be echoed when the
user selects the choice.  In the former case nothing is echoed.
In most cases <code>:type :readline</code> would use the first
format, since the user&rsquo;s input has already been echoed, and <code>:type :tyi</code> would
use the second format, since the input has not been echoed and furthermore is
a single character, which would not be mnemonic to see on the display.
</p>
<p>A choice can also be the symbol <code>:any</code>.  If used, it must be the
last choice.  It means that any input is allowed, and should simply be
returned as a string or character if it does not match any of the
other choices.
</p>
<p>Perhaps this can be clarified by example.  The <code>yes-or-no-p</code> function uses
this list of choices:
</p><div class="lisp">
<pre class="lisp">((t &quot;Yes&quot;) (nil &quot;No&quot;))
</pre></div>
<p>and the <code>y-or-n-p</code> function uses this list:
</p><div class="lisp">
<pre class="lisp">(((t &quot;Yes.&quot;) #/y #/t #\sp #\hand-up)
 ((nil &quot;No.&quot;) #/n #\rubout #\hand-down))
</pre></div>

<p>If a signal name is specified (or allowed to default to <code>:fquery</code>),
before asking the question <code>fquery</code> will signal it.  (See <a href="#condition">condition</a>
for information about conditions.)  <code>make-condition</code> will receive, in
addition to the signal name, all the arguments given to <code>fquery</code>,
including the list of options, the format string, and all the format
arguments.  <code>fquery</code> provides one proceed type, <code>:new-value</code>, and if
a condition handler proceeds, the argument it proceeds with is returned
by <code>fquery</code>.
</p>
<p>If you want to use the formatted output functions instead of <code>format</code> to produce the
promting message, write
</p><div class="lisp">
<pre class="lisp">(fquery <em>options</em> (format:outfmt <em>exp-or-string</em> <em>exp-or-string</em> ...))
</pre></div>
<p><code>format:outfmt</code> puts the output into a list of a string, which makes <code>format</code>
print it exactly as is.  There is no need to supply additional arguments to the
<code>fquery</code> unless it signals a condition.  In that case the arguments might be passed so
that the condition handler can see them.  The condition handler will receive a list
containing one string, the message, as its third argument instead of just a string.  If
this argument is passed along to <code>format</code>, all the right things happen.
</p></dd></dl>

<dl>
<dt><a name="index-_0028condition_0029-on-fquery"></a>Condition on fquery: <strong>(<code>condition</code>)</strong></dt>
<dd><p>This condition is signaled, by default, by <code>fquery</code>.
The condition instance supports these operations:
</p><dl compact="compact">
<dt><code>:options</code></dt>
<dd><p>Returns the list of options given to <code>fquery</code>.
</p></dd>
<dt><code>:format-string</code></dt>
<dd><p>Returns the format string given to <code>fquery</code>.
</p></dd>
<dt><code>:format-args</code></dt>
<dd><p>Returns the list of additional args for format, given to <code>fquery</code>.
</p></dd>
</dl>

<p>One proceed type is provided, <code>:new-value</code>.  It should be used with a
single argument, which will be returned by <code>fquery</code> in lieue of asking
the user.
</p></dd></dl>

<a name="Initializations"></a>
<h2 class="chapter">30 Initializations</h2>
<a name="index-initialization"></a>
<a name="initialization"></a>
<p>There are a number of programs and facilities in the Lisp Machine that require
that &quot;initialization routines&quot; be run either when the facility is first loaded, or when
the system is booted, or both.  These initialization routines may set up data structures,
start processes running, open network connections, and so on.
</p>
<p>An initialization that needs to be done once, when a file is loaded, can be done simply
by putting the Lisp forms to do it in that file; when the file is loaded the
forms will be evaluated.  However, some initializations need to be done each time
the system is booted, and some initializations depend on several files having been loaded
before they can work.
</p>
<p>The system provides a consistent scheme for managing these initializations.  Rather
than having a magic function that runs when the system is started and knows everything
that needs to be initialized, each thing that needs initialization contains its own
initialization routine.  The system keeps track of all the initializations through
a set of functions and conventions, and executes all the initialization routines when
necessary.  The system also avoids re-executing initializations if a program file
is loaded again after it has already been loaded and initialized.
</p>
<p>There is something called an <em>initialization list</em>.  This is a symbol
whose value is an ordered list of <em>initializations</em>.  Each
initialization has a name, a form to be evaluated, a flag saying whether
the form has yet been evaluated, and the source file of the
initialization, if any.  When the time comes, initializations are
evaluated in the order that they were added to the list.  The name is a
string and lies in the <code>car</code> of an initialization; thus <code>assoc</code> may
be used on initialization lists.  All initialization lists also have a
<code>si:initialization-list</code> property of <code>t</code>.  This is mainly for
internal use.
</p>
<a name="add_002dinitialization_002dfun"></a><dl>
<dt><a name="index-add_002dinitialization"></a>Function: <strong>add-initialization</strong> <em>name form &amp;optional list-of-keywords initialization-list-name</em></dt>
<dd><p>Adds an initialization called <em>name</em> with the form <em>form</em> to the initialization list
specified either by <em>initialization-list-name</em> or by keyword.  If the initialization
list already contains an initialization called <em>name</em>, change its form to <em>form</em>.
</p>
<p><em>initialization-list-name</em>, if specified, is a symbol that has as its
value the initialization list.  If it is unbound, it is initialized (!)
to <code>nil</code>, and is given a <code>si:initialization-list</code> property of <code>t</code>.
If a keyword specifies an initialization list,
<em>initialization-list-name</em> is ignored and should not be specified.
</p>
<p>The keywords allowed in <em>list-of-keywords</em> are of two kinds.  These specify
what initialization list to use:
</p><dl compact="compact">
<dt><code>:cold</code></dt>
<dd><a name="index-_003acold-add_002dinitialization"></a>
<p>Use the standard cold-boot list (see below).
</p></dd>
<dt><code>:warm</code></dt>
<dd><a name="index-_003awarm-add_002dinitialization"></a>
<p>Use the standard warm-boot list (see below).  This is the default.
</p></dd>
<dt><code>:before-cold</code></dt>
<dd><a name="index-_003abefore_002dcold-add_002dinitialization"></a>
<p>Use the standard before-disk-save list (see below).
</p></dd>
<dt><code>:once</code></dt>
<dd><a name="index-_003aonce-add_002dinitialization"></a>
<p>Use the once-only list (see below).
</p></dd>
<dt><code>:system</code></dt>
<dd><a name="index-_003asystem-add_002dinitialization"></a>
<p>Use the system list (see below).
</p></dd>
<dt><code>:login</code></dt>
<dd><a name="index-_003alogin-add_002dinitialization"></a>
<p>Use the login list (see below).
</p></dd>
<dt><code>:logout</code></dt>
<dd><a name="index-_003alogout-add_002dinitialization"></a>
<p>Use the logout list (see below).
</p></dd>
<dt><code>:site</code></dt>
<dd><p>Use the site list (see below).
</p></dd>
<dt><code>:site-option</code></dt>
<dd><p>Use the site-option list (see below).
</p></dd>
<dt><code>:full-gc</code></dt>
<dd><p>Use the full-gc list (see below).
</p></dd>
</dl>

<p>These specify when to evaluate <em>form</em>:
</p><dl compact="compact">
<dt><code>:normal</code></dt>
<dd><a name="index-_003anormal-add_002dinitialization"></a>
<p>Only place the form on the list.  Do not evaluate it until the time comes to do
this kind of initialization.  This is the default unless <code>:system</code> or <code>:once</code>
is specified.
</p></dd>
<dt><code>:now</code></dt>
<dd><a name="index-_003anow-add_002dinitialization"></a>
<p>Evaluate the form now as well as adding it to the list.
</p></dd>
<dt><code>:first</code></dt>
<dd><a name="index-_003afirst-add_002dinitialization"></a>
<p>Evaluate the form now if it is not flagged as having been evaluated before.
This is the default if <code>:system</code> or <code>:once</code> is specified.
</p></dd>
<dt><code>:redo</code></dt>
<dd><a name="index-_003aredo-add_002dinitialization"></a>
<p>Do not evaluate the form now, but set the flag to <code>nil</code> even if the initialization
is already in the list and flagged <code>t</code>.
</p></dd>
</dl>

<p>Actually, the keywords are compared with <code>string-equal</code> and may be in any
package.  If both kinds of keywords are used, the list keyword should come
<em>before</em> the when keyword in <em>list-of-keywords</em>; otherwise the list keyword
may override the when keyword.
</p>
<p>The <code>add-initialization</code> function keeps each list ordered so that
initializations added first are at the front of the list.  Therefore, by
controlling the order of execution of the additions, you can control
explicit dependencies on order of initialization.  Typically, the order
of additions is controlled by the loading order of files.  The system
list (see below) is the most critically ordered of the pre-defined
lists.
</p></dd></dl>

<p>The <code>add-initialization</code> keywords that specify an initialization list
are defined by a variable; you can add new keywords to it.
</p>
<a name="si_003ainitialization_002dkeywords_002dvar"></a><dl>
<dt><a name="index-si_003ainitialization_002dkeywords"></a>Variable: <strong>si:initialization-keywords</strong></dt>
<dd><p>Each element on this list defines the keyword for one initialization
list.  Each element is a list of two or three elements.  The first is
the keyword symbol that names the initialization list.  The second is a
special variable, whose value is the initialization list itself.  The
third, if present, is a symbol defining the default &quot;time&quot; at which
initializations added to this list should be evaluated; it should be
<code>si:normal</code>, <code>si:now</code>, <code>si:first</code>, or <code>si:redo</code>.  This third
element just acts as a default; if the list of keywords passed to
<code>add-initialization</code> contains one of the keywords <code>normal</code>, <code>now</code>,
<code>first</code>, or <code>redo</code>, it will override this default.  If the third
element is not present, it is as if the third element were
<code>si:normal</code>.
</p></dd></dl>

<a name="delete_002dinitialization_002dfun"></a><dl>
<dt><a name="index-delete_002dinitialization"></a>Function: <strong>delete-initialization</strong> <em>name &amp;optional keywords initialization-list-name</em></dt>
<dd><p>Removes the specified initialization from the specified initialization list.
Keywords may be any of the list options allowed by <code>add-initialization</code>.
</p></dd></dl>

<a name="initializations_002dfun"></a><dl>
<dt><a name="index-initializations"></a>Function: <strong>initializations</strong> <em>initialization-list-name &amp;optional redo-flag flag-value</em></dt>
<dd><p>Perform the initializations in the specified list.  <em>redo-flag</em> controls
whether initializations that have already been performed are re-performed;
<code>nil</code> means no, non-<code>nil</code> is yes, and the default is <code>nil</code>.  <em>flag-value</em> is the
value to be bashed into the flag slot of an entry.  If it is unspecified, it
defaults to <em>t</em>, meaning that the system should remember that the initialization
has been done.  The reason that there is no convenient way for you to
specify one of the specially-known-about lists is that you shouldn&rsquo;t
be calling <code>initializations</code> on them.
</p></dd></dl>

<a name="reset_002dinitializations_002dfun"></a><dl>
<dt><a name="index-reset_002dinitializations"></a>Function: <strong>reset-initializations</strong> <em>initialization-list-name</em></dt>
<dd><p>Bashes the flag of all entries in the specified list to <code>nil</code>, thereby causing
them to get rerun the next time the function <code>initializations</code> is called on
the initialization list.
</p></dd></dl>

<a name="System-Initialization-Lists"></a>
<h3 class="section">30.1 System Initialization Lists</h3>

<p>The special initialization lists that are known about by the above functions allow
you to have your subsystems initialized at various critical times without
modifying any system code to know about your particular subsystems.  This also allows
only a subset of all possible subsystems to be loaded without necessitating
either modifying system code (such as <code>lisp-reinitialize</code>) or such kludgy methods
as using <code>fboundp</code> to check whether or not something is loaded.
</p>
<p>The <code>:once</code> initialization list is used for initializations that
need to be done only once when the subsystem is loaded and must never be
done again.  For example, there are some databases that need to be
initialized the first time the subsystem is loaded, but should not be
reinitialized every time a new version of the software is loaded into a
currently running system.  This list is for that purpose.  The
<code>initializations</code> function is never run over it; its &quot;when&quot; keyword
defaults to <code>:first</code> and so the form is normally only evaluated at
load-time, and only if it has not been evaluated before.  The <code>:once</code>
initialization list serves a similar purpose to the <code>defvar</code> special
form (see <a href="#defvar_002dfun">defvar-fun</a>), which sets a variable only if it is unbound.
</p>
<p>The <code>:system</code> initialization list is for things that need to be done before
other initializations stand any chance of working.  Initializing the process and
window systems, the file system, and the ChaosNet NCP falls in this category.
The initializations on this list are run every time the machine is cold or warm
booted, as well as when the subsystem is loaded unless explicitly overridden by
a <code>:normal</code> option in the keywords list.  In general, the system list should not be
touched by user subsystems, though there may be cases when it is necessary to do
so.
</p>
<p>The <code>:cold</code> initialization list is used for things that must be run once at cold-boot
time.  The initializations on this list are run after the ones on <code>:system</code> but before the
ones on the <code>:warm</code> list.  They are run only once, but are reset by <code>disk-save</code>
thus giving the appearance of being run only at cold-boot time.
</p>
<p>The <code>:warm</code> initialization list is used for things which must be
run every time the machine is booted, including warm boots.  The
function that prints the greeting, for example, is on this list.  Unlike
the <code>:cold</code> list, the <code>:warm</code> list initializations are run
regardless of their flags.
</p>
<p>The <code>:before-cold</code> initialization list is a variant of the <code>:cold</code> list.  These
initializations are run before the world is saved out by <code>disk-save</code>.  Thus they
happen essentially at cold boot time, but only once when the world is saved, not each
time it is started up.
</p>
<p>The <code>:site</code> initialization list is run every time a new site
table and host table are loaded by <code>update-site-configuration-info</code>.
The keyword <code>:site</code> implies <code>:now</code> unless overridden.
</p>
<p>The <code>:site-option</code> initialization list is run every time the
site options may have changed; that is, when a new site tables are
loaded or after a cold boot (to see the per-machine options of the
machine being booted on).
</p>
<p>The <code>:full-gc</code> initialization list is run by the function
<code>si:full-gc</code> just before garbage collecting.  Initializations might be
put on this list to discard pointers to bulky objects, or to turn copy
lists into cdr-coded form so that they will remain permanently
localized.
<a name="login_002dinit_002dlist"></a></p>
<p>The <code>:login</code> and <code>:logout</code> lists are run by the <code>login</code> and
<code>logout</code> functions (see <a href="#login_002dfun">login-fun</a>) respectively.  Note that <code>disk-save</code>
calls <code>logout</code>.  Also note that often people don&rsquo;t call <code>logout</code>; they
often just cold-boot the machine.
</p>
<p>User programs are free to create their own initialization lists to be run
at their own times.  Some system programs, such as the editor, have their own
initialization list for their own purposes.
fo</p>
<a name="Dates-and-Times"></a>
<h2 class="chapter">31 Dates and Times</h2>
<a name="index-dates-and-times"></a>
<a name="index-times-and-dates"></a>
<a name="time"></a><a name="time_002dchapter"></a>
<p>The <code>time:</code> package contains a set of functions for manipulating dates and
times: finding the current time, reading and printing dates and times,
converting between formats, and other miscellany regarding peculiarities
of the calendar system.  It also includes functions for accessing the
Lisp Machine&rsquo;s microsecond timer.
</p>
<p>Times are represented in two different formats by the functions in the <code>time</code>
package.  One way is to represent a time by many numbers, indicating a year, a
month, a date, an hour, a minute, and a second (plus, sometimes, a day of the
week and timezone).   The year is relative to 1900 (that is, if it is 1983, the
<em>year</em> value would be <code>83</code>); however, the functions that take a year as an
argument will accept either form.  The month is 1 for January, 2 for February,
etc.  The date is 1 for the first day of a month.  The hour is a number from 0
to 23.  The minute and second are numbers from 0 to 59.  Days of the week are
fixnums, where 0 means Monday, 1 means Tuesday, and so on.  A timezone
is specified as the number of hours west of GMT; thus in Massachusetts the timezone
is 5.  Any adjustment for daylight savings time is separate from this.
</p>
<a name="index-universal-time"></a>
<a name="universal_002dtime"></a>
<p>This &quot;decoded&quot; format is convenient for printing out times into a readable
notation, but it is inconvenient for programs to make sense of these numbers
and pass them around as arguments (since there are so many of them).  So there
is a second representation, called Universal Time, which measures a time as the
number of seconds since January 1, 1900, at midnight GMT.  This &quot;encoded&quot; format
is easy to deal with inside programs, although it doesn&rsquo;t make much sense to
look at (it looks like a huge integer).  So both formats are provided; there are
functions to convert between the two formats; and many functions exist in two
forms, one for each format.
</p>
<p>The Lisp Machine hardware includes a timer that counts once every
microsecond.  It is controlled by a crystal and so is fairly accurate.
The absolute value of this timer doesn&rsquo;t mean anything useful, since it
is initialized randomly; what you do with the timer is to read it at the
beginning and end of an interval, and subtract the two values to get the
length of the interval in microseconds.  These relative times allow you to time
intervals of up to an hour (32 bits) with microsecond accuracy.
</p>
<p>The Lisp Machine keeps track of the time of day by maintaining a
&quot;timebase&quot;, using the microsecond clock to count off the seconds.
When the machine first comes up, the timebase is initialized by querying
hosts on the Chaosnet to find out the current time.
</p>
<p>There is a similar timer that counts in 60ths of a second rather than
microseconds; it is useful for measuring intervals of a few seconds or
minutes with less accuracy.  Periodic housekeeping functions of the system
are scheduled based on this timer.
</p>
<a name="Getting-and-Setting-the-Time"></a>
<h3 class="section">31.1 Getting and Setting the Time</h3>

<a name="time_003aget_002dtime_002dfun"></a><dl>
<dt><a name="index-time_003aget_002dtime"></a>Function: <strong>time:get-time</strong></dt>
<dd><p>Get the current time, in decoded form.  Return seconds, minutes, hours, date,
month, year, day-of-the-week, and daylight-savings-time-p, with the same
</p>
<p>meanings as <code>time:decode-universal-time</code> (see <a href="#time_003adecode_002duniversal_002dtime_002dfun">time:decode-universal-time-fun</a>).
</p></dd></dl>

<a name="time_003aget_002duniversal_002dtime_002dfun"></a><dl>
<dt><a name="index-time_003aget_002duniversal_002dtime"></a>Function: <strong>time:get-universal-time</strong></dt>
<dd><p>Returns the current time in Universal Time form.
</p></dd></dl>

<a name="time_003aset_002dlocal_002dtime_002dfun"></a><dl>
<dt><a name="index-time_003aset_002dlocal_002dtime"></a>Function: <strong>time:set-local-time</strong> <em>&amp;optional new-time</em></dt>
<dd><p>Set the local time to <em>new-time</em>.  If <em>new-time</em> is supplied, it must be
either a universal time or a suitable argument to <code>time:parse</code>
(see <a href="#time_003aparse_002dfun">time:parse-fun</a>).  If it is not supplied, or if there is an error
parsing the argument, you will be prompted for the new time.  Note that
you will not normally need to call this function; it is useful mainly when
the timebase gets screwed up for one reason or another.
</p></dd></dl>

<a name="Elapsed-Time-in-60ths-of-a-Second"></a>
<h4 class="subsection">31.1.1 Elapsed Time in 60ths of a Second</h4>
<a name="index-60ths-of-a-second"></a>

<p>The following functions deal with a different kind of time.  These are not
calendrical date/times, but simply elapsed time in 60ths of a second.  These
times are used for many internal purposes where the idea is to measure a small
interval accurately, not to depend on the time of day or day of month.
</p>
<a name="time_002dfun"></a><dl>
<dt><a name="index-time"></a>Function: <strong>time</strong></dt>
<dd><p>Returns a number that increases by 1 every 1/60 of a second.  The value
wraps around roughly once a day.  Use the <code>time-lessp</code> and
<code>time-difference</code> functions to avoid getting in trouble due to the
wrap-around.  <code>time</code> is completely incompatible with the Maclisp
function of the same name.
</p></dd></dl>

<a name="time_002dlessp_002dfun"></a><dl>
<dt><a name="index-time_002dlessp"></a>Function: <strong>time-lessp</strong> <em>time1 time2</em></dt>
<dd><p><code>t</code> if <em>time1</em> is earlier than <em>time2</em>, compensating for
wrap-around, otherwise <code>nil</code>.
</p></dd></dl>

<a name="time_002ddifference_002dfun"></a><dl>
<dt><a name="index-time_002ddifference"></a>Function: <strong>time-difference</strong> <em>time1 time2</em></dt>
<dd><p>Assuming <em>time1</em> is later than <em>time2</em>, returns the number of 60ths
of a second difference between them, compensating for wrap-around.
</p></dd></dl>

<a name="time_002dincrement_002dfun"></a><dl>
<dt><a name="index-time_002dincrement"></a>Function: <strong>time-increment</strong> <em>time interval</em></dt>
<dd><p>Increments <em>time</em> by <em>interval</em>, wrapping around if appropriate.
</p></dd></dl>

<a name="Elapsed-Time-in-Microseconds"></a>
<h4 class="subsection">31.1.2 Elapsed Time in Microseconds</h4>
<a name="index-microseconds"></a>

<a name="time_003amicrosecond_002dtime_002dfun"></a><dl>
<dt><a name="index-time_003amicrosecond_002dtime"></a>Function: <strong>time:microsecond-time</strong></dt>
<dd><p>Returns the value of the microsecond timer, as a bignum.  The values
returned by this function &quot;wrap around&quot; about once per hour.
</p></dd></dl>

<a name="time_003afixnum_002dmicrosecond_002dtime_002dfun"></a><dl>
<dt><a name="index-time_003afixnum_002dmicrosecond_002dtime"></a>Function: <strong>time:fixnum-microsecond-time</strong></dt>
<dd><p>Returns as a fixnum the value of the low 23 bits of the microsecond timer.
This is like <code>time:microsecond-time</code>, with the advantage that
it returns a value in the same format as the <code>time</code> function, except
in microseconds rather than 60ths of a second.  This means that you can
compare fixnum-microsecond-times with <code>time-lessp</code> and
<code>time-difference</code>.  <code>time:fixnum-microsecond-time</code> is also a bit
faster, but has the disadvantage that since you only see the low bits of
the clock, the value can &quot;wrap around&quot; more quickly (about every eight seconds).
Note that the Lisp Machine garbage collector is so designed that the
bignums produced by <code>time:microsecond-time</code> are garbage-collected
quickly and efficiently, so the overhead for creating the bignums is
really not high.
</p></dd></dl>

<a name="Printing-Dates-and-Times"></a>
<h3 class="section">31.2 Printing Dates and Times</h3>

<p>The functions in this section create printed representations of times and
dates in various formats and send the characters to a stream.  To any
of these functions, you may pass <code>nil</code> as the <em>stream</em> parameter
and the function will return a string containing the printed representation
of the time, instead of printing the characters to any stream.
</p>
<a name="time_003aprint_002dcurrent_002dtime_002dfun"></a><dl>
<dt><a name="index-time_003aprint_002dcurrent_002dtime"></a>Function: <strong>time:print-current-time</strong> <em>&amp;optional (stream <code>standard-output</code>)</em></dt>
<dd><p>Prints the current time, formatted as in <code>11/25/80 14:50:02</code>, to
the specified stream.
</p></dd></dl>

<a name="time_003aprint_002dtime_002dfun"></a><dl>
<dt><a name="index-time_003aprint_002dtime"></a>Function: <strong>time:print-time</strong> <em>seconds minutes hours date month year &amp;optional (stream <code>standard-output</code>)</em></dt>
<dd><p>Prints the specified time, formatted as in <code>11/25/80 14:50:02</code>, to
the specified stream.
</p></dd></dl>

<a name="time_003aprint_002duniversal_002dtime_002dfun"></a><dl>
<dt><a name="index-time_003aprint_002duniversal_002dtime"></a>Function: <strong>time:print-universal-time</strong> <em>universal-time &amp;optional (stream <code>standard-output</code>) (timezone <code>time:*timezone*</code>)</em></dt>
<dd><p>Prints the specified time, formatted as in <code>11/25/80 14:50:02</code>, to the specified stream.
</p></dd></dl>

<a name="time_003aprint_002dcurrent_002ddate_002dfun"></a><dl>
<dt><a name="index-time_003aprint_002dcurrent_002ddate"></a>Function: <strong>time:print-current-date</strong> <em>&amp;optional (stream <code>standard-output</code>)</em></dt>
<dd><p>Prints the current time, formatted as in <code>Tuesday the twenty-fifth of
November, 1980; 3:50:41 pm</code>, to the specified stream. 
</p></dd></dl>

<a name="time_003aprint_002ddate_002dfun"></a><dl>
<dt><a name="index-time_003aprint_002ddate"></a>Function: <strong>time:print-date</strong> <em>seconds minutes hours date month year day-of-the-week &amp;optional (stream <code>standard-output</code>)</em></dt>
<dd><p>Prints the specified time, formatted as in <code>Tuesday the twenty-fifth of
November, 1980; 3:50:41 pm</code>, to the specified stream.
</p></dd></dl>

<a name="time_003aprint_002duniversal_002ddate_002dfun"></a><dl>
<dt><a name="index-time_003aprint_002duniversal_002ddate"></a>Function: <strong>time:print-universal-date</strong> <em>universal-time &amp;optional (stream <code>standard-output</code>) (timezone <code>time:*timezone*</code>)</em></dt>
<dd><p>Prints the specified time, formatted as in <code>Tuesday the twenty-fifth of
November, 1980; 3:50:41 pm</code>, to the specified stream.
</p></dd></dl>

<a name="time_003aprint_002dbrief_002duniversal_002dtime_002dfun"></a><dl>
<dt><a name="index-time_003aprint_002dbrief_002duniversal_002dtime"></a>Function: <strong>time:print-brief-universal-time</strong> <em>universal-time &amp;optional (stream <code>standard-output</code>) reference-time</em></dt>
<dd><p>This is like <code>time:print-universal-time</code> except that it omits seconds and
only prints those parts of <em>universal-time</em> that differ from
<em>reference-time</em>, a universal time that defaults to the current time.
Thus the output will be in one of the following three forms:
</p><div class="lisp">
<pre class="lisp">02:59		;<span class="roman">the same day</span>
3/4 14:01	;<span class="roman">a different day in the same year</span>
8/17/74 15:30	;<span class="roman">a different year</span>
</pre></div>
</dd></dl>


<a name="Reading-Dates-and-Times"></a>
<h3 class="section">31.3 Reading Dates and Times</h3>

<p>These functions will accept most reasonable printed representations of date and time
and convert them to the standard internal forms.  The following are
representative formats that are accepted by the parser.
</p>
<div class="lisp">
<pre class="lisp">&quot;March 15, 1960&quot; &quot;15 March 1960&quot; &quot;3//15//60&quot;
&quot;15//3//60&quot; &quot;3//15//1960&quot; &quot;3-15-60&quot; &quot;15-3-1960&quot;
&quot;3-15&quot; &quot;15-March-60&quot; &quot;15-Mar-60&quot; &quot;March-15-60&quot;
&quot;1130.&quot; &quot;11:30&quot; &quot;11:30:17&quot; &quot;11:30 pm&quot;
&quot;11:30 AM&quot; &quot;1130&quot; &quot;113000&quot;
&quot;11.30&quot; &quot;11.30.00&quot; &quot;11.3&quot; &quot;11 pm&quot; &quot;12 noon&quot;
&quot;midnight&quot; &quot;m&quot; &quot;Friday, March 15, 1980&quot; &quot;6:00 gmt&quot; &quot;3:00 pdt&quot;
&quot;15 March 60&quot; &quot;15 march 60 seconds&quot;
&quot;Fifteen March 60&quot; &quot;The Fifteenth of March, 1960;&quot;
&quot;One minute after March 3, 1960&quot;
&quot;Two days after March 3, 1960&quot;
&quot;Three minutes after 23:59:59 Dec 31, 1959&quot;
&quot;Now&quot; &quot;Today&quot; &quot;Yesterday&quot; &quot;two days after tomorrow&quot;
&quot;one day before yesterday&quot; &quot;the day after tomorrow&quot;
&quot;five days ago&quot;
</pre></div>

<a name="time_003aparse_002dfun"></a><dl>
<dt><a name="index-time_003aparse"></a>Function: <strong>time:parse</strong> <em>string &amp;optional (start <code>0</code>) (end <code>nil</code>) (futurep <code>t</code>) base-time must-have-time date-must-have-year time-must-have-second (day-must-be-valid <code>t</code>)</em></dt>
<dd><p>Interpret <em>string</em> as a date and/or time, and return seconds, minutes,
hours, date, month, year, day-of-the-week, daylight-savings-time-p, and relative-p.
<em>start</em> and <em>end</em> delimit a substring
of the string; if <em>end</em> is <code>nil</code>, the end of the string is used.
<em>must-have-time</em> means that <em>string</em> must not be empty.
<em>date-must-have-year</em> means that a year must be explicitly specified.
<em>time-must-have-second</em> means that the second must be specified.
<em>day-must-be-valid</em> means that if a day of the week is given, then it
must actually be the day that corresponds to the date.  <em>base-time</em> provides
the defaults for unspecified components; if it is <code>nil</code>, the current time
is used.  <em>futurep</em> means that the time should be interpreted as being
in the future; for example, if the base time is 5:00 and the string refers
to the time 3:00, that means the next day if <em>futurep</em> is non-<code>nil</code>, but
it means two hours ago if <em>futurep</em> is <code>nil</code>.  The <em>relative-p</em>
returned value is <code>t</code> if the string included a relative part, such
as &quot;one minute after&quot; or &quot;two days before&quot; or &quot;tomorrow&quot; or &quot;now&quot;; otherwise,
it is <code>nil</code>.
</p></dd></dl>

<a name="time_003aparse_002duniversal_002dtime_002dfun"></a><dl>
<dt><a name="index-time_003aparse_002duniversal_002dtime"></a>Function: <strong>time:parse-universal-time</strong> <em>string &amp;optional (start <code>0</code>) (end <code>nil</code>) (futurep <code>t</code>) base-time must-have-time date-must-have-year time-must-have-second (day-must-be-valid <code>t</code>)</em></dt>
<dd><p>This is the same as <code>time:parse</code> except that it returns one integer,
representing the time in Universal Time, and the <em>relative-p</em> value.
</p></dd></dl>

<a name="Reading-and-Printing-Time-Intervals"></a>
<h3 class="section">31.4 Reading and Printing Time Intervals</h3>

<p>In addition to the functions for reading and printing instants of time,
there are other functions specifically for printing time intervals.  A
time interval is either a number (measured in seconds) or <code>nil</code>,
meaning &quot;never&quot;.  The printed representations used look like &quot;3 minutes
23 seconds&quot; for actual intervals, or &quot;Never&quot; for <code>nil</code> (some other
synonyms and abbreviations for &quot;never&quot; are accepted as input).
</p>
<a name="time_003aprint_002dinterval_002dor_002dnever_002dfun"></a><dl>
<dt><a name="index-time_003aprint_002dinterval_002dor_002dnever"></a>Function: <strong>time:print-interval-or-never</strong> <em>interval &amp;optional (stream <code>standard-output</code>)</em></dt>
<dd><p><em>interval</em> should be a non-negative fixnum or <code>nil</code>.
Its printed representation as a time interval is written onto
<em>stream</em>.
</p></dd></dl>

<a name="time_003aparse_002dinterval_002dor_002dnever_002dfun"></a><dl>
<dt><a name="index-time_003aparse_002dinterval_002dor_002dnever"></a>Function: <strong>time:parse-interval-or-never</strong> <em>string &amp;optional start end</em></dt>
<dd><p>Converts <em>string</em>, a printed representation for a time interval, into
a number of <em>nil</em>.  <em>start</em> and <em>end</em> may be used to specify a
portion of <em>string</em> to be used; the default is to use all of
<em>string</em>.  It is an error if the contents of string do not look like a
reasonable time interval.  Here are some examples of acceptable strings:
</p>
<div class="lisp">
<pre class="lisp">        &quot;4 seconds&quot; &quot;4 secs&quot; &quot;4 s&quot;
        &quot;5 mins 23 secs&quot; &quot;5 m 23 s&quot; &quot;23 SECONDS 5 M&quot;
        &quot;3 yrs 1 week 1 hr 2 mins 1 sec&quot;
        &quot;never&quot; &quot;not ever&quot; &quot;no&quot; &quot;&quot;
</pre></div>

<p>Note that several abbreviations are understood, the components may be in
any order, and case (upper versus lower) is ignored.  Also, &quot;months&quot; are
not recognized, since various months have different lengths and there is
no way to know which month is being spoken of.  This function will
always accept anything that was produced by <code>time:print-interval-or-never</code>;
furthermore, it will return exactly the same fixnum (or <code>nil</code>) that
was printed.
</p></dd></dl>

<a name="time_003aread_002dinterval_002dor_002dnever_002dfun"></a><dl>
<dt><a name="index-time_003aread_002dinterval_002dor_002dnever"></a>Function: <strong>time:read-interval-or-never</strong> <em>&amp;optional (stream <code>standard-input</code>)</em></dt>
<dd><p>This function reads a line of input from <em>stream</em> (using <code>readline</code>) and
then calls <code>time:parse-interval-or-never</code> on the resulting string.
</p></dd></dl>

<a name="Time-Conversions"></a>
<h3 class="section">31.5 Time Conversions</h3>

<a name="time_003adecode_002duniversal_002dtime_002dfun"></a><dl>
<dt><a name="index-time_003adecode_002duniversal_002dtime"></a>Function: <strong>time:decode-universal-time</strong> <em>universal-time &amp;optional (timezone <code>time:*timezone*</code>)</em></dt>
<dd><p>Converts <em>universal-time</em> into its decoded representation.  The
following values are returned: seconds, minutes, hours, date, month,
year, day-of-the-week, daylight-savings-time-p.
<em>daylight-savings-time-p</em> tells you whether or not
daylight savings time is in effect; if so, the value of <em>hour</em> has been
adjusted accordingly.  You can specify <em>timezone</em> explicitly if you
want to know the equivalent representation for this time in other parts
of the world.
</p></dd></dl>

<a name="time_003aencode_002duniversal_002dtime_002dfun"></a><dl>
<dt><a name="index-time_003aencode_002duniversal_002dtime"></a>Function: <strong>time:encode-universal-time</strong> <em>seconds minutes hours date month year &amp;optional timezone</em></dt>
<dd><p>Converts the decoded time into Universal Time format, and return the
Universal Time as an integer.  If you don&rsquo;t specify <em>timezone</em>, it
defaults to the current timezone adjusted for daylight savings time; if
you provide it explicitly, it is not adjusted for daylight savings time.
<em>year</em> may be absolute or relative to 1900 (that is, <code>81</code> and <code>1981</code>
both work).
</p></dd></dl>

<a name="time_003a_002atimezone_002a_002dvar"></a><dl>
<dt><a name="index-time_003a_002atimezone_002a"></a>Variable: <strong>time:*timezone*</strong></dt>
<dd><p>The value of <code>time:*timezone*</code> is the time zone in which this Lisp Machine
resides, expressed in terms of the number of hours west of GMT this time
zone is.  This value does not change to reflect daylight savings time; it
tells you about standard time in your part of the world.
</p></dd></dl>

<a name="Internal-Functions"></a>
<h3 class="section">31.6 Internal Functions</h3>

<p>These functions provide support for those listed above.  Some user programs
may need to call them directly, so they are documented here.
</p>
<a name="time_003ainitialize_002dtimebase_002dfun"></a><dl>
<dt><a name="index-time_003ainitialize_002dtimebase"></a>Function: <strong>time:initialize-timebase</strong></dt>
<dd><p>Initialize the timebase by querying Chaosnet hosts to find out the
current time.  This is called automatically during system initialization.
You may want to call it yourself to correct the time if it appears to be
inaccurate or downright wrong.  See also <code>time:set-local-time</code>,
<a href="#time_003aset_002dlocal_002dtime_002dfun">time:set-local-time-fun</a>.
</p></dd></dl>

<a name="time_003adaylight_002dsavings_002dtime_002dp_002dfun"></a><dl>
<dt><a name="index-time_003adaylight_002dsavings_002dtime_002dp"></a>Function: <strong>time:daylight-savings-time-p</strong> <em>hours date month year</em></dt>
<dd><p>Return <code>t</code> if daylight savings time is in effect for the specified
hour; otherwise, return <code>nil</code>. 
<em>year</em> may be absolute or relative to 1900 (that is, <code>83</code> and <code>1983</code>
both work).
</p></dd></dl>

<a name="time_003adaylight_002dsavings_002dp_002dfun"></a><dl>
<dt><a name="index-time_003adaylight_002dsavings_002dp"></a>Function: <strong>time:daylight-savings-p</strong></dt>
<dd><p>Return <code>t</code> if daylight savings time is currently in effect; otherwise,
return <code>nil</code>.
</p></dd></dl>

<a name="time_003amonth_002dlength_002dfun"></a><dl>
<dt><a name="index-time_003amonth_002dlength"></a>Function: <strong>time:month-length</strong> <em>month year</em></dt>
<dd><p>Return the number of days in the specified <em>month</em>; you must supply
a <em>year</em> in case the month is February (which has a different length
during leap years).
<em>year</em> may be absolute or relative to 1900 (that is, <code>83</code> and <code>1983</code>
both work).
</p></dd></dl>

<a name="time_003aleap_002dyear_002dp_002dfun"></a><dl>
<dt><a name="index-time_003aleap_002dyear_002dp"></a>Function: <strong>time:leap-year-p</strong> <em>year</em></dt>
<dd><p>Return <code>t</code> if <em>year</em> is a leap year; otherwise return <code>nil</code>.
<em>year</em> may be absolute or relative to 1900 (that is, <code>83</code> and <code>1983</code>
both work).
</p></dd></dl>

<a name="time_003averify_002ddate_002dfun"></a><dl>
<dt><a name="index-time_003averify_002ddate"></a>Function: <strong>time:verify-date</strong> <em>date month year day-of-the-week</em></dt>
<dd><p>If the day of the week of the date specified by <em>date</em>, <em>month</em>, and
<em>year</em> is the same as <em>day-of-the-week</em>, return <code>nil</code>; otherwise,
return a string that contains a suitable error message.  <em>year</em> may
be absolute or relative to 1900 (that is, <code>83</code> and <code>1983</code> both
work).
</p></dd></dl>

<a name="time_003aday_002dof_002dthe_002dweek_002dstring_002dfun"></a><dl>
<dt><a name="index-time_003aday_002dof_002dthe_002dweek_002dstring"></a>Function: <strong>time:day-of-the-week-string</strong> <em>day-of-the-week &amp;optional (mode <code>':long</code>)</em></dt>
<dd><p>Returns a string representing the day of the week.  As usual, <code>0</code> means
Monday, <code>1</code> means Tuesday, and so on.  Possible values of <em>mode</em>
are:
</p><dl compact="compact">
<dt><code>:long</code></dt>
<dd><p>Returns the full English name, such as <code>&quot;Monday&quot;</code>, <code>&quot;Tuesday&quot;</code>, etc.  This
is the default.
</p></dd>
<dt><code>:short</code></dt>
<dd><p>Returns a three-letter abbreviation, such as <code>&quot;Mon&quot;</code>, <code>&quot;Tue&quot;</code>, etc.
</p></dd>
<dt><code>:medium</code></dt>
<dd><p>Same as <code>:short</code>, but use <code>&quot;Tues&quot;</code> and <code>&quot;Thurs&quot;</code>.
</p></dd>
<dt><code>:french</code></dt>
<dd><p>Returns the French name, such as <code>&quot;Lundi&quot;</code>, <code>&quot;Mardi&quot;</code>, etc.
</p></dd>
<dt><code>:german</code></dt>
<dd><p>Returns the German name, such as <code>&quot;Montag&quot;</code>, <code>&quot;Dienstag&quot;</code>, etc.
</p></dd>
<dt><code>:italian</code></dt>
<dd><p>Returns the Italian name, such as <code>&quot;Lunedi&quot;</code>, <code>&quot;Martedi&quot;</code>, etc.
</p></dd>
</dl>
</dd></dl>

<a name="time_003amonth_002dstring_002dfun"></a><dl>
<dt><a name="index-time_003amonth_002dstring"></a>Function: <strong>time:month-string</strong> <em>month &amp;optional (mode <code>':long</code>)</em></dt>
<dd><p>Returns a string representing the month of the year.  As usual, <code>1</code> means January,
<code>2</code> means February, etc.  Possible values of <em>mode</em> are:
</p><dl compact="compact">
<dt><code>:long</code></dt>
<dd><p>Returns the full English name, such as <code>&quot;January&quot;</code>, <code>&quot;February&quot;</code>, etc.  This
is the default.
</p></dd>
<dt><code>:short</code></dt>
<dd><p>Returns a three-letter abbreviation, such as <code>&quot;Jan&quot;</code>, <code>&quot;Feb&quot;</code>, etc.
</p></dd>
<dt><code>:medium</code></dt>
<dd><p>Same as <code>:short</code>, but use <code>&quot;Sept&quot;</code>, <code>&quot;Novem&quot;</code>, and <code>&quot;Decem&quot;</code>.
</p></dd>
<dt><code>:roman</code></dt>
<dd><p>Returns the Roman numeral for <em>month</em> (this convention is used in Europe).
</p></dd>
<dt><code>:french</code></dt>
<dd><p>Returns the French name, such as <code>&quot;Janvier&quot;</code>, <code>&quot;Fevrier&quot;</code>, etc.
</p></dd>
<dt><code>:german</code></dt>
<dd><p>Returns the German name, such as <code>&quot;Januar&quot;</code>, <code>&quot;Februar&quot;</code>, etc.
</p></dd>
<dt><code>:italian</code></dt>
<dd><p>Returns the Italian name, such as <code>&quot;Gennaio&quot;</code>, <code>&quot;Febbraio&quot;</code>, etc.
</p></dd>
</dl>
</dd></dl>

<a name="time_003atimezone_002dstring_002dfun"></a><dl>
<dt><a name="index-time_003atimezone_002dstring"></a>Function: <strong>time:timezone-string</strong> <em>&amp;optional (timezone <code>time:*timezone*</code>) (daylight-savings-p <code>(time:daylight-savings-p)</code>)</em></dt>
<dd><p>Return the three-letter abbreviation for this time zone.  For example, if
<em>timezone</em> is <code>5</code>, then either <code>&quot;EST&quot;</code> (Eastern Standard Time) or <code>&quot;CDT&quot;</code>
(Central Daylight Time) will be used, depending on <em>daylight-savings-p</em>.
</p></dd></dl>

<a name="g_t_0022Miscellaneous-Useful-Functions_0022"></a>
<h2 class="chapter">32 &quot;Miscellaneous Useful Functions&quot;</h2>
<a name="misc_002dchapter"></a>
<p>This chapter describes a number of functions that don&rsquo;t logically fit in anywhere else.
Most of these functions are not normally used in programs, but are &quot;commands&quot;, i.e
things that you type directly at Lisp.
</p>
<a name="Hardcopy"></a>
<h3 class="section">32.1 Hardcopy</h3>

<p>The hardcopy functions allow you to specify the printer to use on each
call.  The default is set up by the site files for your site, but can be
overridden for a particular machine in the <code>LMLOCS</code> file or by a user
in his INIT file.  Any kind of printer can be used, no matter how it is
actually driven, if it is hooked into the software properly as described below.
</p>
<p>A <em>printer-type</em> is a keyword that has appropriate properties;
a <em>printer</em> is either a printer-type or a list starting with one.
The rest of the list can specify <em>which</em> printer of that type you want
to use (perhaps with a host name or filename).
</p>
<p>The printer types defined by the system are:
</p><dl compact="compact">
<dt><span class="roman">:dover printer-type</span></dt>
<dd><p>This printer type is used by itself as a printer, and refers to the
Dover at MIT.
</p>
</dd>
<dt><span class="roman">:xgp printer-type</span></dt>
<dd><p>This printer type indicates a printer that is accessed by writing spool
files in MIT XGP format.  A printer would be specified as a list,
<code>(:xgp <em>filename</em>)</code>, specifying where to write the spool file.
</p>
</dd>
<dt><span class="roman">:press-file printer-type</span></dt>
<dd><p>This printer type is used in a list together with a file name, as in
<code>(:press-file &quot;OZ:&lt;RMS&gt;FOO.PRESS&quot;)</code>.  Something is &quot;printed&quot; on such
a printer by being converted to a press file and written under that
name.
</p></dd>
</dl>

<a name="hardcopy_002dfile_002dfun"></a><dl>
<dt><a name="index-hardcopy_002dfile"></a>Function: <strong>hardcopy-file</strong> <em>filename &amp;rest options</em></dt>
<dd><p>Print the file <em>filename</em> in hard copy on the specified printer or the
default printer.  <em>options</em> is a list of keyword argument names and
values.  There are only two keywords that are always meaningful:
<code>:format</code> and <code>:printer</code>.  Everything else is up to the individual
printer to interpret.  The list here is only a standard/suggestion.
</p>
<dl compact="compact">
<dt><code>:printer</code></dt>
<dd><p>The value is the printer to use.  The default is the value of
<code>si:*default-printer*</code>.
</p>
</dd>
<dt><code>:format</code></dt>
<dd><p>The value is a keyword that specifies the format of file to be parsed.
The standard possibilities are <code>:text</code> (an ordinary file of text),
<code>:xgp</code> (a file of the sort once used by the XGP at MIT), <code>:press</code> (a
Xerox-style press file) and <code>:suds-plot</code> (a file produced by the
Stanford drawing program).  However, each kind of printer may define its
own format keywords.
</p>
</dd>
<dt><code>:font</code></dt>
<dt><code>:font-list hardcopy-file</code></dt>
<dd><p>The value of <em>font</em> is the name of a font to print the file in (a
string).  Alternatively, you can give <code>:font-list</code> and specify a list
of such font names, for use if the file contains font-change commands.
The interpretation of a font name is dependent on the printer being
used.  There is no necessary relation to Lisp machine display fonts.
However, printers are encouraged to use, by default, fonts that are
similar in appearance to the Lisp machine fonts listed in the file&rsquo;s
attribute list, if it is a text file.
</p>
</dd>
<dt><code>:heading-font</code></dt>
<dd><p>The value is the name of the font for use in page headers, if there are
any.
</p>
</dd>
<dt><code>:page-headings</code></dt>
<dd><p>If the value is non-<code>nil</code>, a heading is added to each page.
</p>
</dd>
<dt><code>:copies</code></dt>
<dd><p>The value is the number of copies to print.
</p>
</dd>
<dt><code>:spool</code></dt>
<dd><p>If the printer provides optional spooling, this argument says whether to
spool (default is <code>nil</code>).  Some printers may intrinsically always
spool; others may have no way to spool.
</p></dd>
</dl>
</dd></dl>

<a name="hardcopy_002dstream_002dfun"></a><dl>
<dt><a name="index-hardcopy_002dstream"></a>Function: <strong>hardcopy-stream</strong> <em>stream &amp;rest options</em></dt>
<dd><p>Like <code>hardcopy-file</code> but uses the text read from <em>stream</em> rather
than opening a file.  The <code>:format</code> option is not allowed (since
implementing it requires the ability to open the file with unusual
<code>open</code> options).
</p></dd></dl>

<a name="hardcopy_002dbit_002darray_002dfun"></a><dl>
<dt><a name="index-hardcopy_002dbit_002darray"></a>Function: <strong>hardcopy-bit-array</strong> <em>array left top right bottom &amp;rest options</em></dt>
<dd><p>Print all or part of the bit-array <em>array</em> on the specified or default
printer.  <em>options</em> is a list of keyword argument names and values;
the only standard option is <code>:printer</code>, which specifies the printer to
use.  The default printer is <code>si:*default-bit-array-printer*</code>, or, if
that is <code>nil</code>, <code>si:*default-printer</code>.
</p>
<p><em>left</em>, <em>top</em>, <em>right</em> and <em>bottom</em> specify the subrectangle of
the array to be printed.  All four numbers measure from the top left
corner (which is element 0, 0).
</p></dd></dl>

<a name="hardcopy_002dstatus_002dfun"></a><dl>
<dt><a name="index-hardcopy_002dstatus"></a>Function: <strong>hardcopy-status</strong> <em>&amp;optional printer (stream <code>standard-output</code>)</em></dt>
<dd><p>Prints the status of <em>printer</em>, or the default printer.
This should include if possible such things as whether the printer has
paper and what is in the queue.
</p></dd></dl>

<a name="si_003a_002adefault_002dprinter_002a_002dvar"></a><dl>
<dt><a name="index-si_003a_002adefault_002dprinter_002a"></a>Variable: <strong>si:*default-printer*</strong></dt>
<dd><p>This is the default printer.  It is set from the <code>:default-printer</code>
site option.
</p></dd></dl>

<a name="si_003a_002adefault_002dbit_002darray_002dprinter_002a_002dvar"></a><dl>
<dt><a name="index-si_003a_002adefault_002dbit_002darray_002dprinter_002a"></a>Variable: <strong>si:*default-bit-array-printer*</strong></dt>
<dd><p>If non-<code>nil</code>, this is the default printer for printing bit arrays,
overriding <code>si:*default-printer*</code>.  A separate default is provided for
bit arrays since some printers that can print files cannot print bit
arrays.  This variable is set initially from the
<code>:default-bit-array-printer</code> site option.
</p></dd></dl>

<p>Defining a printer type:
</p>
<p>A printer type is any keyword that has suitable functions on the
appropriate properties.
</p>
<p>To be used with the function <code>hardcopy-file</code>, the printer type must
have a <code>si:print-file</code> property.  To be used with <code>hardcopy-stream</code>,
the printer type must have a <code>si:print-stream</code> property.
<code>hardcopy-bit-array</code> uses the <code>si:print-bit-array</code> property.
<code>hardcopy-status</code> uses the <code>si:print-status</code> property.
(The hardcopy functions&rsquo; names themselves are not used simply to avoid
using a symbol in the global package as a property name of a symbol
that might be in the global package as well).
</p>
<p>Each property, to be used, should be a function whose first argument
will be the printer and whose remaining arguments will fit the same
pattern as those of the hardcopy function the user called.  (They will
not necessarily be the same arguments, as some additional keywords may be
added to the list of keyword arguments; but they will fit the same
description.)
</p>
<p>For example,
</p><div class="lisp">
<pre class="lisp">(hardcopy-file &quot;foo&quot; ':printer '(:press-file &quot;bar.press&quot;))
</pre></div>
<p>will result in the execution of
</p><div class="lisp">
<pre class="lisp">(funcall (get ':press-file 'si:print-file)
         '(:press-file &quot;bar.press&quot;)
	 &quot;foo&quot; ':printer '(:press-file &quot;bar.press&quot;))
</pre></div>

<p>A printer type need not support operations that make no sense on it.
For example, there is no <code>si:print-status</code> property on
<code>:press-file</code>.
</p>
<a name="Metering"></a>
<h3 class="section">32.2 Metering</h3>
<a name="meter_002dsection"></a>
<p>The metering system is a way of finding out what parts of your program
use up the most time.  When you run your program with metering, every
function call and return is recorded, together with the time at which it
took place.  Page faults are also recorded.  Afterward, the metering
system will analyze the records and tell you how much time was spent
executing withain each function.  Because the records are stored in the disk
partition called <code>METR</code>, there is room for a lot of data.
</p>
<p>Before you meter a program, you must enable metering in some or all
stack groups.  <code>meter:enable</code> is used for this.  Then you evaluate one
or more forms with metering, perhaps by using <code>meter:test</code> or
<code>meter:run</code>.  Finally, you use <code>meter:analyze</code> to summarize and
print the metering data.
</p>
<p>There are two parameters that control whether metering data are
recorded.  First of all, the variable <code>sys:%meter-microcode-enables</code>
contains bits that enable recording of various kinds of events.  Secondly,
each stack group has a flag that controls whether events are recorded
while running in that stack group.
</p>
<a name="sys_003a_0025meter_002dmicrocode_002denables_002dvar"></a><dl>
<dt><a name="index-sys_003a_0025meter_002dmicrocode_002denables"></a>Variable: <strong>sys:%meter-microcode-enables</strong></dt>
<dd><p>Enables recording of metering data.
Each bit controls recording of one kind of event.
</p><dl compact="compact">
<dt><code>1</code></dt>
<dd><p>This bit enables recording of page faults.
</p></dd>
<dt><code>2</code></dt>
<dd><p>This bit enables recording of consing.
</p></dd>
<dt><code>4</code></dt>
<dd><p>This bit enables recording of function entry and exit.
</p></dd>
<dt><code>10</code></dt>
<dd><p>This bit enables recording of stack group switching.
</p></dd>
</dl>

<p>The value is normally zero, which turns off all recording.
</p></dd></dl>

<p>These are the functions used to control which stack groups do metering:
</p>
<a name="meter_003aenable_002dfun"></a><dl>
<dt><a name="index-meter_003aenable"></a>Function: <strong>meter:enable</strong> <em>&amp;rest things</em></dt>
<dd><p>Enables metering in the stack groups specified by <em>things</em>.
Each thing in <em>things</em> may be a stack group, a process (which
specifies the process&rsquo;s stack group), or a window (which specifies the
window&rsquo;s process&rsquo;s stack group).  <code>t</code> is also allowed.  It enables
metering in all stack groups.
</p></dd></dl>

<a name="meter_003adisable_002dfun"></a><dl>
<dt><a name="index-meter_003adisable"></a>Function: <strong>meter:disable</strong> <em>&amp;rest things</em></dt>
<dd><p>Disables metering in the stack groups specified by <em>things</em>.
The arguments allowed are the same as for <code>meter:enable</code>.
<code>(meter:disable t)</code> turns off <code>(meter:enable t)</code>, but does not
disable stack groups enabled individually.  <code>(meter:disable)</code> disables
all stack groups no matter how you specified to enable them.
</p></dd></dl>

<a name="meter_003ametered_002dobjects_002dvar"></a><dl>
<dt><a name="index-meter_003ametered_002dobjects"></a>Variable: <strong>meter:metered-objects</strong></dt>
<dd><p>This is a list of all the <em>things</em> you have enabled with
<code>meter:enable</code> and not disabled.
</p></dd></dl>

<p>These are the functions to evaluate forms with metering:
</p>
<a name="meter_003arun_002dfun"></a><dl>
<dt><a name="index-meter_003arun"></a>Function: <strong>meter:run</strong> <em>forms</em></dt>
<dd><p>Clears out the metering data and evaluates the <em>forms</em> with
<code>sys:%meter-microcode-enables</code> bound to 14 octal (record function
entry and exit, and stack group switching).  Any of the evaluation that
takes place in enabled stack groups will record metering data.
</p></dd></dl>

<a name="meter_003atest_002dfun"></a><dl>
<dt><a name="index-meter_003atest"></a>Function: <strong>meter:test</strong> <em>form (enables <code>14</code>)</em></dt>
<dd><p>Clears out the metering data, enables metering for the current
stack group only, and evaluates <em>form</em> with
<code>sys:%meter-microcode-enables</code> bound to <em>enables</em>.
</p></dd></dl>

<p>This is how you print the results:
</p>
<a name="meter_003aanalyze_002dfun"></a><dl>
<dt><a name="index-meter_003aanalyze"></a>Function: <strong>meter:analyze</strong> <em>&amp;key &amp;optional analyzer stream file buffer return info</em></dt>
<dd><p>Analyzes the data recorded by metering.
<em>analyzer</em> is a keyword specifies a kind of analysis.  <code>:tree</code>
is the default.  Another useful alternative is <code>:list-events</code>.
Particular analyzers handle other keyword arguments in addition
to those listed above.
</p>
<p>The output is printed on <em>stream</em>, written to a file named
<em>file</em>, or put in an editor buffer named <em>buffer</em> (at most one of
these three arguments should be specified).  The default is to print on
<code>standard-output</code>.
</p>
<p>Analyzing the metering data involves creating a large intermediate data
base.  Normally this is created afresh each time <code>meter:analyze</code>is
called.  If you specify a non-<code>nil</code> value for <em>return</em>, the
intermediate data structure is returned by <code>meter:analyze</code>, and can be
passed in on another call as the <em>info</em> argument.  This can save time.
But you can only do this if you use the same <em>analyzer</em> each time,
as different analyzers use different termporary data structures.
</p></dd></dl>

<p>The default analyzer <code>:tree</code> prints out the amount of run time and
real time spent executing each function that was called.  The real time
includes time spend waiting and time spent writing metering data to disk;
for computational tasks, the latter makes the real time less useful
than the run time.
<code>:tree</code> handles these additional keyword arguments to <code>meter:analyze</code>:
</p><dl compact="compact">
<dt><code>:find-callers &quot;meter:analyze&quot;</code></dt>
<dd><p>The argument for this keyword is a function spec or a list of function specs.
A list of who called the specified functions,
and how often, is printed instead of the usual output.
</p>
</dd>
<dt><code>:stack-group &quot;meter:analyze&quot;</code></dt>
<dd><p>The argument is a stack group or a list of them;
only the activities in those stack groups are printed.
</p>
</dd>
<dt><code>:sort-function &quot;meter:analyze&quot;</code></dt>
<dd><p>The argument is the name of a suitable sorting function that is used to
sort the items for the various functions that were called.  Sorting
functions provided include <code>meter:max-page-faults</code>,
<code>meter:max-calls</code>, <code>meter:max-run-time</code> (the default),
<code>meter:max-real-time</code>, and <code>meter:max-run-time-per-call</code>.
</p>
</dd>
<dt><code>:summarize &quot;meter:analyze&quot;</code></dt>
<dd><p>The argument is a function spec or a list of function specs;
only those functions statistics are printed.
</p>
</dd>
<dt><code>:inclusive &quot;meter:analyze&quot;</code></dt>
<dd><p>If this is non-<code>nil</code>, the times for each function include
the time spent in executing subroutines called from the function.
</p>
<p>Note: if a function is called recursively, the time spent in the inner
call(s) will be counted twice (or more).
</p></dd>
</dl>

<p>The analyzer <code>:list-events</code> prints out one line about each event
recorded.  The line contains the run time and real time (in
microseconds), the running count of page faults, the stack group name,
the function that was running, the stack depth, the type of event, and a
piece of data.  For example:
</p>
<div class="lisp">
<pre class="lisp">   0   0    0 ZMACS-WINDOWS  METER:TEST   202 CALL SI:*EVAL
 115  43    0 ZMACS-WINDOWS  METER:TEST   202 RET  SI:*EVAL
 180  87    0 ZMACS-WINDOWS  METER:TEST   202 RET  *CATCH

real run   pf  stack-group    function  stack event data
time time                               level type
</pre></div>

<p><code>:list-events</code> is often useful with recording of page faults
(<code>sys:%meter-microcode-enables</code> set to 1).
</p>
<a name="meter_003areset_002dfun"></a><dl>
<dt><a name="index-meter_003areset"></a>Function: <strong>meter:reset</strong></dt>
<dd><p>Clears out all metering data.
</p></dd></dl>

<p>Because metering records pointers to Lisp objects in a disk partition
which is not part of the Lisp address space, garbage collection is
turned off (by arresting the gc process) when you turn on metering.
</p>
<a name="meter_003aresume_002dgc_002dprocess_002dfun"></a><dl>
<dt><a name="index-meter_003aresume_002dgc_002dprocess"></a>Function: <strong>meter:resume-gc-process</strong></dt>
<dd><p>Allows garbage collection to continue (if it is on) by unarresting it.
</p></dd></dl>

<a name="Poking-Around-in-the-Lisp-World"></a>
<h3 class="section">32.3 Poking Around in the Lisp World</h3>

<a name="who_002dcalls_002dfun"></a><dl>
<dt><a name="index-who_002dcalls"></a>Function: <strong>who-calls</strong> <em>x &amp;optional package</em></dt>
<dd><a name="who_002duses_002dfun"></a></dd><dt><a name="index-who_002duses"></a>Function: <strong>who-uses</strong> <em>x &amp;optional package</em></dt>
<dd><p><em>x</em> must be a symbol or a list of symbols.
<code>who-calls</code> tries
to find all of the functions in the Lisp world
that call <em>x</em> as a function, use <em>x</em> as a variable,
or use <em>x</em> as a constant.  (It won&rsquo;t find things
that use constants that contain <em>x</em>, such as a list one
of whose elements is <em>x</em>; it will only find it if <em>x</em>
itself is used as a constant.)  It tries to find all of the functions
by searching all of the function cells of
all of the symbols on <em>package</em> and <em>package</em>&rsquo;s descendants.
<em>package</em> defaults to the <code>global</code> package, and so normally
all packages are checked.
</p>
<p>If <code>who-calls</code> encounters an interpreted function definition, it
simply tells you if <em>x</em> appears anywhere in the interpreted code.
<code>who-calls</code> is smarter about compiled code, since it has been
nicely predigested by the compiler.  Macros expanded in the compilation
of the code can be found because they are recorded in the caller&rsquo;s
debugging info alist, even though they are not actually referred to
by the compiled code.
</p>
<p>If <em>x</em> is a list of symbols, <code>who-calls</code> does them all simultaneously,
which is faster than doing them one at a time.
</p>
<p><code>who-uses</code> is an obsolete name for <code>who-calls</code>.
</p>
<p>The editor has a command,<code> Meta-X List Callers</code>, which is similar to <code>who-calls</code>.
</p>
<p>The symbol <code>unbound-function</code> is treated specially by <code>who-calls</code>.
<code>(who-calls 'unbound-function)</code> will search the compiled
code for any calls through a symbol that is not currently
defined as a function.  This is useful for finding errors such
as functions you misspelled the names of or forgot to write.
</p>
<p><code>who-calls</code> prints one line of information for each caller it finds.  It also
returns a list of the names of all the callers.
</p></dd></dl>

<a name="what_002dfiles_002dcall_002dfun"></a><dl>
<dt><a name="index-what_002dfiles_002dcall"></a>Function: <strong>what-files-call</strong> <em>x &amp;optional package</em></dt>
<dd><p>Similar to <code>who-calls</code> but returns a list of the pathnames of all the files
that contain functions that <code>who-calls</code> would have printed out.  This is useful
if you need to recompile and/or edit all of those files.
</p></dd></dl>

<a name="apropos_002dfun"></a><dl>
<dt><a name="index-apropos"></a>Function: <strong>apropos</strong> <em>substring &amp;key &amp;optional package (inferiors <code>t</code>) superiors dont-print predicate</em></dt>
<dd><p><code>(apropos <em>substring</em>)</code> tries to find all symbols whose print-names
contain <em>substring</em> as a substring.  Whenever it finds a symbol, it
prints out the symbol&rsquo;s name; if the symbol is defined as a function
and/or bound to a value, it tells you so and prints the names of the
arguments (if any) to the function.
</p>
<p>If <em>predicate</em> is non-<code>nil</code>, it should be a function; only symbols
on which the function returns non-<code>nil</code> are counted.
</p>
<p><code>apropos</code> looks for symbols on <em>package</em>, and <em>package</em>&rsquo;s
decendants (unless <em>inferiors</em> is <code>nil</code>).  If <em>superiors</em> is
<code>t</code>, the superpackages of the specified package are searched as well.
<em>package</em> defaults to the <code>global</code> package, so normally all packages
are searched.
</p>
<p><code>apropos</code> returns a list of all the symbols it finds.
If <em>dont-print</em> is non-<code>nil</code>, that is all it does.
</p></dd></dl>

<a name="sub_002dapropos_002dfun"></a><dl>
<dt><a name="index-sub_002dapropos"></a>Function: <strong>sub-apropos</strong> <em>substring starting-list &amp;key &amp;optional predicate dont-print</em></dt>
<dd><p>Finds all symbols in <em>starting-list</em> whose names contain
<em>substring</em>, and that satisfy <em>predicate</em>.  If <em>predicate</em> is
<code>nil</code>, the substring is the only condition.  The symbols are printed
if <em>dont-print</em> is <code>nil</code>.  A list of the symbols found is returned,
in any case.
</p>
<p>This function is most useful when applied to the value of <code>*</code>, after
<code>apropos</code> has returned a long list.
</p></dd></dl>

<a name="where_002dis_002dfun"></a><dl>
<dt><a name="index-where_002dis"></a>Function: <strong>where-is</strong> <em>pname &amp;optional package</em></dt>
<dd><p>Prints the names of all packages that contain a symbol with the print-name
<em>pname</em>.  If <em>pname</em> is a string it gets upper-cased.  The package <em>package</em> and
all its sub-packages are searched; <em>package</em> defaults to the <code>global</code> package,
which causes all packages to be searched.
<code>where-is</code> returns a list of all the symbols it finds.
</p></dd></dl>

<a name="describe_002dfun"></a><dl>
<dt><a name="index-describe"></a>Function: <strong>describe</strong> <em>x</em></dt>
<dd><p><code>describe</code> tries to tell you all of the interesting information
about any object <em>x</em> (except for array contents).  <code>describe</code> knows
about arrays, symbols, flonums, packages, stack groups, closures, and FEFs, and prints
out the attributes of each in human-readable form.  Sometimes
it will describe something that it finds inside something else;
such recursive descriptions are indented appropriately.  For instance,
<code>describe</code> of a symbol will tell you about the symbol&rsquo;s value,
its definition, and each of its properties.  <code>describe</code> of a flonum
(regular or small) will show you its internal representation in a way
that is useful for tracking down roundoff errors and the like.
</p>
<p>If <em>x</em> is a named-structure, <code>describe</code> handles it specially.
To understand this, you should read the section on named structures
(see <a href="#named_002dstructure">named-structure</a>).
First it gets the named-structure symbol, and sees whether its function knows
about the <code>:describe</code> operation.  If the operation is known, it applies
the function to two arguments: the symbol <code>:describe</code>, and the named-structure
itself.  Otherwise, it looks on the named-structure symbol for information
that might have been left by <code>defstruct</code>; this information would
tell it what the symbolic names for the entries in the structure are,
and <code>describe</code> knows how to use the names to print out what each field&rsquo;s
name and contents is.
</p>
<p><code>describe</code> always returns its argument, in case you want to do something else to it.
</p></dd></dl>

<a name="inspect_002dfun"></a><dl>
<dt><a name="index-inspect"></a>Function: <strong>inspect</strong> <em>x</em></dt>
<dd><p>A window-oriented version of <code>describe</code>.  See the window system documentation
for details, or try it and type <code>Help</code>.
</p></dd></dl>

<a name="disassemble_002dfun"></a><dl>
<dt><a name="index-disassemble"></a>Function: <strong>disassemble</strong> <em>function</em></dt>
<dd><p><em>function</em> should be a FEF, or a symbol that is defined as a FEF.
This prints out a human-readable version of the macro-instructions
in <em>function</em>.  The macro-code instruction set is explained in <a href="#macro_002dcode">macro-code</a>.
</p></dd></dl>

<p>The <code>grindef</code> function (see <a href="#grindef_002dfun">grindef-fun</a>) may be used to display the definition
of a non-compiled function.
</p>
<a name="room_002dfun"></a><dl>
<dt><a name="index-room"></a>Function: <strong>room</strong> <em>&amp;rest areas</em></dt>
<dd><p><em>room</em> tells you the amount of physical memory on the machine, the
amount of available virtual memory not yet filled with data (that is,
the portion of the available virtual memory that has not yet been allocated
to any region of any area), and the amount
of &quot;wired&quot; physical memory (i.e memory not available for paging). 
Then it tells you how much room is left in some areas.  For each
area it tells you about, it prints out the name of the area, the number
of regions that currently make up the area, the current size of the area in kilowords,
and the amount of the area that has been allocated, also in kilowords.
If the area cannot grow, the percentage that is free is displayed.
</p>
<p><code>(room)</code> tells you about those areas that are in the list that is the value
of the variable <code>room</code>.  These are the most interesting ones.
</p>
<p><code>(room <em>area1</em> <em>area2</em>...)</code> tells you about those areas, which can
be either the names or the numbers.
</p>
<p><code>(room t)</code> tells you about all the areas.
</p>
<p><code>(room nil)</code> does not tell you about any areas; it only prints the header.
This is useful if you just want to know how much memory is on the machine
or how much virtual memory is available.
</p></dd></dl>

<a name="room_002dvar"></a><dl>
<dt><a name="index-room-1"></a>Variable: <strong>room</strong></dt>
<dd><p>The value of <code>room</code> is a list of area names and/or area numbers,
denoting the areas that the function <code>room</code> will describe if given
no arguments.  Its initial value is:
</p><div class="lisp">
<pre class="lisp">(working-storage-area macro-compiled-program)
</pre></div>
</dd></dl>


<a name="Utility-Programs"></a>
<h3 class="section">32.4 Utility Programs</h3>

<a name="ed_002dfun"></a><dl>
<dt><a name="index-ed"></a>Function: <strong>ed</strong> <em>&amp;optional x</em></dt>
<dd><p><code>ed</code> is the main function for getting into the editor, Zwei.  Zwei
is not yet documented in this manual, but the commands are very similar to Emacs.
</p>
<p><code>(ed)</code> or <code>(ed nil)</code> simply enters the editor, leaving you in the same
buffer as the last time you were in the editor.
</p>
<p><code>(ed t)</code> puts you in a fresh buffer with a generated name (like BUFFER-4).
</p>
<p><code>(ed <em>pathname</em>)</code> edits that file.  <em>pathname</em> may be an actual pathname
or a string.
</p>
<p><code>(ed 'foo)</code> tries hard to edit the definition of the <code>foo</code> function.
It will find a buffer or file containing the source code for <code>foo</code>
and position the cursor at the beginning of the code.  In general, <code>foo</code>
can be any function-spec (see <a href="#function_002dspec">function-spec</a>).
</p>
<p><code>(ed 'zwei:reload)</code> reinitializes the editor.  It will forget about all
existing buffers, so use this only as a last resort.
</p></dd></dl>

<a name="zwei_003asave_002dall_002dfiles_002dfun"></a><dl>
<dt><a name="index-zwei_003asave_002dall_002dfiles"></a>Function: <strong>zwei:save-all-files</strong></dt>
<dd><p>This function is useful in emergencies in which you have modified material
in Zmacs buffers that needs to be saved, but the editor is partially broken.
This function does what the editor&rsquo;s <code>Save All Files</code> command does, but
it stays away from redisplay and other advanced facilities so that
it might work if other things are broken.
</p></dd></dl>

<a name="dired_002dfun"></a><dl>
<dt><a name="index-dired"></a>Function: <strong>dired</strong> <em>&amp;optional pathname</em></dt>
<dd><p>Puts up a window and edits the directory named by <em>pathname</em>, which defaults to
the last file opened.  While editing a directory you may view, edit, compare, hardcopy,
and delete the files it contains.  While in the directory editor type the <code>HELP</code>
key for further information.
</p></dd></dl>

<a name="mail_002dfun"></a><dl>
<dt><a name="index-mail"></a>Function: <strong>mail</strong> <em>&amp;optional user text call-editor-anyway</em></dt>
<dd><p>Sends the string <em>text</em> as mail to <em>user</em>.  <em>user</em> should also be
a string, of the form <code>&quot;<em>username<code>@</code>hostname</em>&quot;</code>.  Multiple
recipients separated by commas are also allowed.
</p>
<p>If you do not provide two arguments, <code>mail</code> puts up an editor window
in which you may compose the mail.  Type the <code>End</code> key to send the
mail and return from the <code>mail</code> function.
</p>
<p>The window is also used if <em>call-editor-anyway</em> is non-<code>nil</code>.
</p></dd></dl>

<a name="bug_002dfun"></a><dl>
<dt><a name="index-bug"></a>Function: <strong>bug</strong> <em>&amp;optional topic text call-editor-anyway</em></dt>
<dd><p>Reports a bug.  <em>topic</em> is the name of the faulty program (a symbol or
a string).  It defaults to <code>lispm</code> (the Lisp Machine system itself).
<em>text</em> is a string which contains the information to report.  If you
do not provide two arguments, or if <em>call-editor-anyway</em> is
non-<code>nil</code>, a window will be put up for you to compose the mail.
</p>
<p><code>bug</code> is like <code>mail</code> but includes information about the system version
and what machine you are on in the text of the message.  This information is
important to the maintainers of the faulty program; it aids them in reproducing
the bug and in determining whether it is one that is already being worked on
or has already been fixed.
</p></dd></dl>

<a name="print_002dnotifications_002dfun"></a><dl>
<dt><a name="index-print_002dnotifications"></a>Function: <strong>print-notifications</strong></dt>
<dd><p>Reprints any notifications that have been received.  The difference
between notifications and sends is that sends come from other users,
while notifications are usually asynchronous messages from the Lisp
Machine system itself.  However, the default way for the system to
inform you about a send is to make a notification!  So
<code>print-notifications</code> will <em>normally</em> include all sends as well.
</p></dd></dl>

<a name="si_003aprint_002ddisk_002derror_002dlog_002dfun"></a><dl>
<dt><a name="index-si_003aprint_002ddisk_002derror_002dlog"></a>Function: <strong>si:print-disk-error-log</strong></dt>
<dd><p>Prints information about the half dozen most recent disk errors (since the last cold boot).
</p></dd></dl>

<a name="peek_002dfun"></a><dl>
<dt><a name="index-peek"></a>Function: <strong>peek</strong> <em>&amp;optional character</em></dt>
<dd><p><code>peek</code> is similar to the ITS program of the same name.
It displays various information about the system, periodically
updating it.  Like ITS PEEK, it has several modes, which are entered
by typing a single key which is the name of the mode.  The initial
mode is selected by the argument, <em>character</em>.  If no argument
is given, <code>peek</code> starts out by explaining what its modes are.
</p></dd></dl>

<a name="g_t_0022The-Lisp-Top-Level_0022"></a>
<h3 class="section">32.5 &quot;The Lisp Top Level&quot;</h3>

<p>These functions constitute the Lisp top level
and its associated functions.
</p>
<a name="index-lisp-top-level"></a>
<a name="index-read_002deval_002dprint-loop"></a>

<a name="si_003alisp_002dtop_002dlevel_002dfun"></a><dl>
<dt><a name="index-si_003alisp_002dtop_002dlevel"></a>Function: <strong>si:lisp-top-level</strong></dt>
<dd><p>This is the first function called in the initial Lisp environment.
It calls <code>lisp-reinitialize</code>, clears the screen, and calls <code>si:lisp-top-level1</code>.
</p></dd></dl>

<a name="lisp_002dreinitialize_002dfun"></a><dl>
<dt><a name="index-lisp_002dreinitialize"></a>Function: <strong>lisp-reinitialize</strong></dt>
<dd><p>This function does a wide variety of things, such as resetting the values
of various global constants and initializing the error system.
</p></dd></dl>

<a name="si_003alisp_002dtop_002dlevel1_002dfun"></a><dl>
<dt><a name="index-si_003alisp_002dtop_002dlevel1"></a>Function: <strong>si:lisp-top-level1</strong> <em>terminal-io</em></dt>
<dd><p>This is the actual top level loop.  It reads
a form from <code>standard-input</code>,
evaluates it, prints the result (with slashification) to
<code>standard-output</code>, and repeats indefinitely.  If several values are returned by the form
all of them will be printed.  Also the values of <code>*</code>, <code>+</code>, <code>-</code>, <code>//</code>,
<code>++</code>, <code>**</code>, <code>+++</code>, and <code>***</code>
are maintained (see below).
</p></dd></dl>

<a name="index-break-loop"></a>
<a name="index-breakpoint"></a>

<a name="break_002dfun"></a><dl>
<dt><a name="index-break"></a>Special Form: <strong>break</strong> <em>[tag] [conditional-form]</em></dt>
<dd><p><code>break</code> is used to enter a breakpoint loop, which is similar
to a Lisp top level loop.  <code>(break <em>tag</em>)</code> will always
enter the loop; <code>(break <em>tag</em> <em>conditional-form</em>)</code>
will evaluate <em>conditional-form</em> and only enter the break loop
if it returns non-<code>nil</code>.  If the break loop is entered, <code>break</code>
prints out
</p><div class="lisp">
<pre class="lisp">;Breakpoint <em>tag</em>; Resume to continue, Abort to quit.
</pre></div>
<p>and then enters a loop reading, evaluating, and printing forms.  A
difference between a break loop and the top level loop is that when
reading a form, <code>break</code> checks for the following special cases: If the
<code>Abort</code> key is typed, control is returned to the previous break or
error-handler, or to top-level if there is none.  If the <code>Resume</code> key is
typed, <code>break</code> returns <code>nil</code>.  If the symbol <code>diamondp</code> is typed,
<code>break</code> returns <code>nil</code>.  If the list <code>(return <em>form</em>)</code> is typed,
<code>break</code> evaluates <em>form</em> and returns the result.
</p>
<p>Inside the <code>break</code> loop, the streams <code>standard-output</code>,
<code>standard-input</code>, and <code>query-io</code> are bound to be synonymous
to <code>terminal-io</code>; <code>terminal-io</code> itself is not rebound.  Several
other internal system variables are bound, and you can add your
own symbols to be bound by pushing elements onto the
value of the variable <code>sys:*break-bindings*</code>
(see <a href="#sys_003a_002abreak_002dbindings_002a_002dvar">sys:*break-bindings*-var</a>).
</p>
<p>If <em>tag</em> is omitted, it defaults to <code>nil</code>.
</p></dd></dl>

<a name="prin1_002dvar"></a><dl>
<dt><a name="index-prin1-1"></a>Variable: <strong>prin1</strong></dt>
<dd><p>The value of this variable is normally <code>nil</code>.  If it is non-<code>nil</code>,
then the read-eval-print loop will use its value instead of the
definition of <code>prin1</code> to print the values returned by functions.
This hook lets you control how things are printed by all read-eval-print
loops&ndash;the Lisp top level, the <code>break</code> function, and any utility
programs that include a read-eval-print loop.  It does not affect output
from programs that call the <code>prin1</code> function or any of its relatives such
as <code>print</code> and <code>format</code>; if you want to do that, read about
customizing the printer, on <a href="#customizing_002dthe_002dprinter">customizing-the-printer</a>.  If you
set <code>prin1</code> to a new function, remember that the read-eval-print loop
expects the function to print the value but not to output a <code>return</code>
character or any other delimiters.
</p></dd></dl>

<a name="g_t_002d_002dvar"></a><dl>
<dt><a name="index-_002d-1"></a>Variable: <strong>-</strong></dt>
<dd><p>While a form is being evaluated by a read-eval-print loop,
<code>-</code> is bound to the form itself.
</p></dd></dl>

<a name="g_t_002b_002dvar"></a><dl>
<dt><a name="index-_002b-1"></a>Variable: <strong>+</strong></dt>
<dd><p>While a form is being evaluated by a read-eval-print loop,
<code>+</code> is bound to the previous form that was read by the loop.
</p></dd></dl>

<a name="g_t_002a_002dvar"></a><dl>
<dt><a name="index-_002a-1"></a>Variable: <strong>*</strong></dt>
<dd><p>While a form is being evaluated by a read-eval-print loop,
<code>*</code> is bound to the result printed the last time through
the loop.  If there were several values printed (because
of a multiple-value return), <code>*</code> is bound to the first
value.
</p></dd></dl>

<a name="g_t_002f_002f_002dvar"></a><dl>
<dt><a name="index-_002f_002f-1"></a>Variable: <strong>//</strong></dt>
<dd><p>While a form is being evaluated by a read-eval-print loop,
<code>//</code> is bound to a list of the results printed the last
time through the loop.
</p></dd></dl>

<a name="g_t_002b_002b_002dvar"></a><dl>
<dt><a name="index-_002b_002b"></a>Variable: <strong>++</strong></dt>
<dd><p><code>++</code> holds the previous value of <code>+</code>, that is, the form evaluated
two interactions ago.
</p></dd></dl>

<a name="g_t_002b_002b_002b_002dvar"></a><dl>
<dt><a name="index-_002b_002b_002b"></a>Variable: <strong>+++</strong></dt>
<dd><p><code>+++</code> holds the previous value of <code>++</code>.
</p></dd></dl>

<a name="g_t_002a_002a_002dvar"></a><dl>
<dt><a name="index-_002a_002a"></a>Variable: <strong>**</strong></dt>
<dd><p><code>**</code> holds the previous value of <code>*</code>, that is, the result of the
form evaluated two interactions ago.
</p></dd></dl>

<a name="g_t_002a_002a_002a_002dvar"></a><dl>
<dt><a name="index-_002a_002a_002a"></a>Variable: <strong>***</strong></dt>
<dd><p><code>***</code> holds the previous value of <code>**</code>.
</p></dd></dl>

<a name="sys_003a_002abreak_002dbindings_002a_002dvar"></a><dl>
<dt><a name="index-sys_003a_002abreak_002dbindings_002a"></a>Variable: <strong>sys:*break-bindings*</strong></dt>
<dd><p>When <code>break</code> is called, it binds some special variables under control of
the list which is the value of <code>sys:*break-bindings*</code>.  Each element of the
list is a list of two elements: a variable and a form that is evaluated to
produce the value to bind it to.  The bindings happen sequentially.  Users may
<code>push</code> things on this list (adding to the front of it), but should not replace
the list wholesale since several of the variable bindings on this list are
essential to the operation of <code>break</code>.
</p></dd></dl>

<a name="lisp_002dcrash_002dlist_002dvar"></a><dl>
<dt><a name="index-lisp_002dcrash_002dlist"></a>Variable: <strong>lisp-crash-list</strong></dt>
<dd><p>The value of <code>lisp-crash-list</code> is a list of forms.
<code>lisp-reinitialize</code> sequentially evaluates these
forms, and then sets <code>lisp-crash-list</code> to <code>nil</code>.
</p>
<p>In most cases, the <em>initialization</em> facility should be used rather than
<code>lisp-crash-list</code>.  Refer to <a href="#initialization">initialization</a>.
</p></dd></dl>


<a name="The-Garbage-Collector"></a>
<h3 class="section">32.6 The Garbage Collector</h3>
<a name="index-garbage-collector"></a>
<a name="garbage_002dcollector"></a>
<a name="gc_002don_002dfun"></a><dl>
<dt><a name="index-gc_002don"></a>Function: <strong>gc-on</strong></dt>
<dd><p>Turns automatic garbage collection on.  Garbage collection will happen when
and as needed.  Automatic garbage collection is off by default.
</p>
<p>Since garbage collection works by copying, you will be asked for
confirmation if there may not be enough space to complete a garbage
collection even if it is started immediately.
</p></dd></dl>

<a name="gc_002doff_002dfun"></a><dl>
<dt><a name="index-gc_002doff"></a>Function: <strong>gc-off</strong></dt>
<dd><p>Turns automatic garbage collection off.
</p></dd></dl>

<p>Normally, automatic garbage collection happens in incremental mode; that
is, scavenging happens in parallel with computation.  Each consing
operation scavenges or copies four words per word consed.  In addition,
scavenging goes on whenever the machine appears idle.
</p>
<p>If you are running a noninteractive crunching program, the incremental
nature of garbage collection may be of no value.  Then you can make
garbage collection more efficient by making it a batch process.
</p>
<a name="si_003agc_002dreclaim_002dimmediately_002dvar"></a><dl>
<dt><a name="index-si_003agc_002dreclaim_002dimmediately"></a>Variable: <strong>si:gc-reclaim-immediately</strong></dt>
<dd><p>If this variable is non-<code>nil</code>,
automatic garbage collection is done as a batch operation:
when the garbage collection process decides that the time has come,
it copies all the useful data and discards the old address space,
running full blast.  (It is still possible to use the machine while this is
going on, but it is slow.)  More specifically, the
garbage collection process scavenges and reclaims oldspace immediately
right after a flip happens, using all of the machine&rsquo;s
physical memory.  This variable is only relevant if you have turned on
automatic garbage collection with <code>(si:gc-on)</code>.
</p>
<p>A batch garbage collection requires less free space than an incremental
one.  If there is not enough space to complete an incremental garbage
collection, you may be able to win by selecting batch garbage collection
instead.
</p></dd></dl>

<a name="si_003agc_002dflip_002dratio_002dvar"></a><dl>
<dt><a name="index-si_003agc_002dflip_002dratio"></a>Variable: <strong>si:gc-flip-ratio</strong></dt>
<dd><p>This variable tells the garbage collector what fraction of the data it
should expect to have to copy, after each flip.  It should be a positive
number no larger than one.  By default, it is one.  But if your program
is consing considerable amounts of garbage, a value less than one may be
safe.  The garbage collector uses this variable to figure how much space
it will need to copy all the living data, and therefore indirectly how often
garbage collection must be done.
</p></dd></dl>

<p>Garbage collection is turned off if it appears to be about to run out of
memory.  You get a notification if this happens.  You should also get a
notification when you are nearly at the point of not having enough space
to guarantee garbage collecting successfully.
</p>
<p>In addition to turning on automatic garbage collection, you can also
manually request one immediate complete collection with the function
<code>si:full-gc</code>.  The usual reason for doing this is to make a band smaller
before saving it.  <code>si:full-gc</code> also resets all temporary areas (see
<code>si:reset-temporary-area</code>, <a href="#si_003areset_002dtemporary_002darea_002dfun">si:reset-temporary-area-fun</a>).
</p>
<a name="si_003afull_002dgc_002dfun"></a><dl>
<dt><a name="index-si_003afull_002dgc"></a>Function: <strong>si:full-gc</strong></dt>
<dd><p>Performs a complete garbage collection immediately.
This does not turn automatic garbage collection on or off;
it performs the garbage collection in the process you call it in.
A full gc of the standard system takes about 7 minutes, currently.
</p></dd></dl>

<a name="si_003aclean_002dup_002dstatic_002darea_002dfun"></a><dl>
<dt><a name="index-si_003aclean_002dup_002dstatic_002darea"></a>Function: <strong>si:clean-up-static-area</strong> <em>area-number</em></dt>
<dd><p>This is a more selective way of causing static areas to be garbage
collected once.  The argument is the area number of a static area; that
particular area will be garbage collected the next time a garbage
collection is done (more precisely, it will be scavenged after the next
flip).  If you then call <code>si:full-gc</code>, it will happen then.
</p></dd></dl>

<a name="gc_002dstatus_002dfun"></a><dl>
<dt><a name="index-gc_002dstatus"></a>Function: <strong>gc-status</strong></dt>
<dd><p>The function <code>gc-status</code> prints information related to garbage
collection.  When scavenging is in progress, it tells you how the task is
progressing.  While scavenging is not in progress and
oldspace does not exist, it prints information about how soon a new flip
will be required.
</p></dd></dl>

<p>While a garbage collection is not in progress, the output from
<code>gc-status</code> looks like this:
</p><div class="lisp">
<pre class="lisp">Garbage collector process state: Await Flip
Dynamic (new+copy) space 3614383, Old space 0, Static 1785534,
Free space 9322496, committed 8308770, plus fudge 262144,
 times ratio (1.0) gives 8570914, leaving 751582 before flip.
Scavenging during cons: On, Idle scavenging: On
GC Flip Ratio: 1, GC Reclaim Immediately: Off
</pre></div>

<p>The &quot;dynamic space&quot; figure is the amount of garbage collectable space
and the &quot;static&quot; figure is the amount of static space used.
There is no old space since an old space only exists during garbage collection.
</p>
<p>The &quot;committed guess&quot; plus the &quot;fudge&quot; is the estimate (on the high
side) for the amount of free space that would be needed to complete a
garbage collection.  The difference between the free space and that
amount is how much consing you can do before a garbage collection will
begin (if automatic garbage collection is on).
</p>
<p>The amount needed for a garbage collection will depend on the value of
<code>si:*gc-reclaim-immediately*</code>; more if it is <code>nil</code>.
</p>
<p>While a garbage collection is in progress, the output looks like this:
</p><div class="lisp">
<pre class="lisp">Garbage collector process state: Await Scavenge
Dynamic space 66647, Old space 2802957, Static 2600029,
Max scavenging remaining 5372456, minimum 2635630,
Free space 8060928  2736826 might be needed for copying)
Ratio scavenging work/free space = 1.00908s0.
Scavenging during cons: On, Idle scavenging: On
GC Flip Ratio: 1, GC Reclaim Immediately: Off
</pre></div>

<p>Notice that most of the dynamic space has become old space and new
space is small.  Not much has been copied since the flip took place.
The maximum and minimum estimates for the amount of scavenging are based
on different limits for how much of old space may need to be copied; as
scavenging progresses, the maximum will decrease steadily, but the
minimum may increase.
</p>
<a name="si_003aset_002dscavenger_002dws_002dfun"></a><dl>
<dt><a name="index-si_003aset_002dscavenger_002dws"></a>Function: <strong>si:set-scavenger-ws</strong> <em>number-of-pages</em></dt>
<dd><p>Incremental scavenging is restricted to a fixed
amount of physical memory to reduce its interference with your other
activities.
</p>
<p>This function specifies the number of pages of memory that incremental garbage
collection can use.  400 (256.) is a good value for a 256k machine.  If
the garbage collector gets very poor paging performance, use of this
function may fix it.
</p></dd></dl>

<a name="g_t_0022Logging-In_0022"></a>
<h3 class="section">32.7 &quot;Logging In&quot;</h3>
<a name="lispm_002dinit_002dfile"></a>
<p>Logging in tells the Lisp Machine who you are, so that
other users can see who is logged in, you can receive messages,
and your INIT file can be run.  An INIT file is a Lisp program
which gets loaded when you log in; it can be used to set up
a personalized environment.
</p>
<p>When you log out, it should be possible to undo any
personalizations you have made so that they do not affect the next user
of the machine.  Therefore, anything done by an INIT file should be
undoable.  In order to do this, for every form in the INIT file, a Lisp
form to undo its effects should be added to the list that is the value
of <code>logout-list</code>.  The functions <code>login-setq</code> and <code>login-eval</code>
help make this easy; see below.
</p>
<a name="user_002did_002dvar"></a><dl>
<dt><a name="index-user_002did"></a>Variable: <strong>user-id</strong></dt>
<dd><p>The value of <code>user-id</code> is either the name of the logged in user, as a string,
or else an empty string if there is no user logged in.
It appears in the who-line.
</p></dd></dl>

<a name="logout_002dlist_002dvar"></a><dl>
<dt><a name="index-logout_002dlist"></a>Variable: <strong>logout-list</strong></dt>
<dd><p>The value of <code>logout-list</code> is a list of forms to be evaluated
when the user logs out.
</p></dd></dl>

<a name="login_002dfun"></a><dl>
<dt><a name="index-login"></a>Function: <strong>login</strong> <em>name &amp;optional host inhibit-init-file</em></dt>
<dd><p>Sets your name (the variable <code>user-id</code>) to <em>name</em> and logs in a file
server on <em>host</em>.  <em>host</em> also becomes your
default file host.  If <em>host</em> requires passwords for logging in you
will be asked for a password.  When logging in to a TOPS-20 host, typing
an asterisk before your password will enable any special capabilities
you may be authorized to use.  The default value of <em>host</em> depends
on which Lisp Machine you use using; it is called the associated machine
(see <a href="#si_003aassociated_002dmachine_002dvar">si:associated-machine-var</a>).  <code>login</code> also runs the
<code>:login</code> initialization list (see <a href="#login_002dinit_002dlist">login-init-list</a>).
</p>
<p>Unless <em>inhibit-init-file</em> is specified as non-<code>nil</code>, <code>login</code> will load
your init file if it exists.  On ITS, your init file is <em>name</em> <code>LISPM</code>
on your home directory.  On TOPS-20 your init file is <code>LISPM.INIT</code> on your
directory.
</p>
<p>If anyone is logged into the machine already, <code>login</code> logs him out
before logging in <em>name</em>.  (See <code>logout</code>.)  Init files should be
written using the <code>login-setq</code> and <code>login-eval</code> functions below so
that <code>logout</code> can undo them.  Usually, however, you cold-boot the
machine before logging in, to remove any traces of the previous user.
<code>login</code> returns <code>t</code>.
</p></dd></dl>

<a name="log1_002dfun"></a><dl>
<dt><a name="index-log1"></a>Function: <strong>log1</strong> <em>&amp;rest options</em></dt>
<dd><p>Like <code>login</code> but the arguments are specified differently.
<em>options</em> is a list of keywords and values; the keywords
<code>:host</code> and <code>:init</code> specify the host to log in on and whether
to load the init file if any.  Any other keywords are also allowed.
<code>log1</code> itself will ignore them, but the init file can act on them.
The purpose of <code>log1</code>, as opposed to <code>login</code>, is to enable you
to specify other keywords for your init file&rsquo;s sake.
</p></dd></dl>

<a name="si_003auser_002dinit_002doptions_002dvar"></a><dl>
<dt><a name="index-si_003auser_002dinit_002doptions"></a>Variable: <strong>si:user-init-options</strong></dt>
<dd><p>During the execution of the user&rsquo;s init file, inside <code>log1</code>,
this variable contains the arguments given to <code>log1</code>.
Options not meaningful to <code>log1</code> itself can be specified, so that
the init file can find them here and act on them.
</p></dd></dl>

<a name="logout_002dfun"></a><dl>
<dt><a name="index-logout"></a>Function: <strong>logout</strong></dt>
<dd><p>First, <code>logout</code> evaluates the forms on <code>logout-list</code>.
Then it sets <code>user-id</code> to an empty string and <code>logout-list</code>
to <code>nil</code>.  Then it runs the <code>:logout</code> initialization list
(see <a href="#login_002dinit_002dlist">login-init-list</a>), and returns <code>t</code>.
</p></dd></dl>

<a name="login_002dsetq_002dfun"></a><dl>
<dt><a name="index-login_002dsetq"></a>Special Form: <strong>login-setq</strong> <em>variable value...</em></dt>
<dd><p><code>login-setq</code> is like <code>setq</code> except that it puts
a <code>setq</code> form on <code>logout-list</code> to set the variables
to their previous values.
</p></dd></dl>

<a name="login_002deval_002dfun"></a><dl>
<dt><a name="index-login_002deval"></a>Function: <strong>login-eval</strong> <em>x</em></dt>
<dd><p><code>login-eval</code> is used for functions that are &quot;meant to be called&quot;
from INIT files, such as <code>zwei:set-comtab-return-undo</code>, which conveniently
return a form to undo what they did.  <code>login-eval</code> adds
the result of the form <em>x</em> to the <code>logout-list</code>.
</p></dd></dl>


<a name="Dribble-Files"></a>
<h3 class="section">32.8 Dribble Files</h3>

<a name="dribble_002dstart_002dfun"></a><dl>
<dt><a name="index-dribble_002dstart"></a>Function: <strong>dribble-start</strong> <em>filename &amp;optional editor-p</em></dt>
<dd><p><code>dribble-start</code> opens <em>filename</em> as a &quot;dribble file&quot; (also
known as a &quot;wallpaper file&quot;).  It rebinds <code>standard-input</code>
and <code>standard-output</code> so that all of the terminal interaction
is directed to the file as well as the terminal.  If <em>editor-p</em>
is non-<code>nil</code>, then instead of opening <em>filename</em> on the file
computer, <code>dribble-start</code> dribbles into a Zmacs buffer whose
name is <em>filename</em>, creating it if it doesn&rsquo;t exist.
</p></dd></dl>

<a name="dribble_002dall_002dfun"></a><dl>
<dt><a name="index-dribble_002dall"></a>Function: <strong>dribble-all</strong> <em>filename &amp;optional editor-p</em></dt>
<dd><p><code>dribble-all</code> is like <code>dribble-start</code> except that all input and
output goes to the dribble file, including break loops, queries,
warnings and sessions in the debugger.  This works by binding
<code>terminal-io</code> instead of <code>standard-output</code> and <code>standard-input</code>.
</p></dd></dl>

<a name="dribble_002dend_002dfun"></a><dl>
<dt><a name="index-dribble_002dend"></a>Function: <strong>dribble-end</strong></dt>
<dd><p>This closes the file opened by <code>dribble-start</code> and resets
the I/O streams.
</p></dd></dl>

<a name="Status-and-SStatus"></a>
<h3 class="section">32.9 Status and SStatus</h3>

<p>The <code>status</code> and <code>sstatus</code> special forms exist for compatibility
with Maclisp.  Programs that wish to run in both Maclisp and Zetalisp
can use <code>status</code> to determine which of these they are running in.  Also,
<code>(sstatus feature ...)</code> can be used as it is in Maclisp.
</p>
<a name="status_002dfun"></a><dl>
<dt><a name="index-status"></a>Special Form: <strong>status</strong></dt>
<dd><p><code>(status features)</code> returns a list of symbols indicating features
of the Lisp environment.  The complete list of all symbols that may
appear on this list, and their meanings, is given in the Maclisp
manual.  The default list for the Lisp Machine is:
</p><div class="lisp">
<pre class="lisp">(loop defstruct lispm cadr mit chaos sort fasload string
 newio roman trace grindef grind)
</pre></div>
<p>The value of this list will be kept up to date as features are added or
removed from the Lisp Machine system.  Most important is the symbol
<code>lispm</code>; this indicates that the program is executing on the Lisp
Machine.  <code>cadr</code> indicates the type of hardware, <code>mit</code> which version
of the Lisp machine operating system, and <code>chaos</code> that the chaosnet
protocol is used.  The order of this list should not be depended on, and
may be different from that shown above.
</p>
<p>This features list is used by the <code>#+</code> read-time conditionalization
syntax.  See <a href="#sharp_002dplus">sharp-plus</a>.
</p>
<p><code>(status feature <em>symbol</em>)</code> returns <code>t</code> if <em>symbol</em>
is on the <code>(status features)</code> list, otherwise <code>nil</code>.
</p>
<p><code>(status nofeature <em>symbol</em>)</code> returns <code>t</code> if <em>symbol</em>
is not on the <code>(status features)</code> list, otherwise <code>nil</code>.
</p>
<p><code>(status userid)</code> returns the name of the logged-in user.
</p>
<p><code>(status tabsize)</code> returns the number of spaces per tab stop (always
8).  Note that this can actually be changed on a per-window basis, however
the <code>status</code> function always returns the default value of 8.
</p>
<p><code>(status opsys)</code> returns the name of the operating system, always
the symbol <code>:lispm</code>.
</p>
<p><code>(status site)</code> returns the name of the local machine, e.g <code>&quot;MIT-LISPM-6&quot;</code>.
Note that this is not the <em>site</em> as described above, under <code>(status features)</code>.
</p>
<p><code>(status status)</code> returns a list of all <code>status</code> operations.
</p>
<p><code>(status sstatus)</code> returns a list of all <code>sstatus</code> operations.
</p></dd></dl>

<a name="sstatus_002dfun"></a><dl>
<dt><a name="index-sstatus"></a>Special Form: <strong>sstatus</strong></dt>
<dd><p><code>(sstatus feature <em>symbol</em>)</code> adds <em>symbol</em> to the list
of features.
</p>
<p><code>(sstatus nofeature <em>symbol</em>)</code> removes <em>symbol</em> from
the list of features.
</p></dd></dl>

<a name="Booting-and-Disk-Partitions"></a>
<h3 class="section">32.10 Booting and Disk Partitions</h3>
<a name="disk_002dpartition"></a><a name="index-band"></a>
<a name="index-partition"></a>
<a name="index-saving-the-Lisp-world"></a>
<a name="index-booting"></a>

<p>A Lisp Machine disk is divided into several named <em>partitions</em> (also
called &quot;bands&quot; sometimes).  Partitions can be used for many things.
Every disk has a partition named <code>PAGE</code>, which is used to implement the
virtual memory of the Lisp Machine.  When you run Lisp, this is where
the Lisp world actually resides.  There are also partitions that hold
saved images of the Lisp Machine microcode, conventionally named
<code>MCR<em>n</em></code> (where <em>n</em> is a digit), and partitions that hold saved
images of Lisp worlds, conventionally named <code>LOD<em>n</em></code>.  A saved
image of a Lisp world is also called a &quot;virtual memory load&quot; or &quot;system load&quot;.
</p>
<p>The directory of partitions is in a special block on the disk called the
label.  When you &quot;cold-boot&quot; a Lisp Machine by typing
<code>Control-Meta-Control-Meta-Rubout</code>, the machine checks the label to
see which two partitions are flagged as being the current microcode and
the current system load.  These are kept separate so that the microcode
can be easily changed without going through the time-consuming process
of generating a new system load.  When you &quot;cold-boot&quot;, the contents of
the current microcode band are loaded into the microcode memory, and
then the contents of the current saved image of the Lisp world is copied
into the <code>PAGE</code> partition.  Then Lisp starts running.  When you
&quot;warm-boot&quot;, the contents of the current microcode band are loaded, but
Lisp starts running using the data already in the <code>PAGE</code> partition.
</p>
<p>For each partition, the directory of partitions contains a brief textual
description of the contents of the partition.  For microcode partitions,
a typical description might be <code>&quot;UCADR 204&quot;</code>; this means that version
<code>204</code> of the microcode is in the partition.  For saved Lisp images, it
is a little more complicated.  Ideally, the description would say which
versions of which systems are loaded into the band.  Unfortunately,
there isn&rsquo;t enough room for that in most cases.  A typical description
is <code>&quot;92.20 Daed 1.4&quot;</code>, meaning that this band contains version
<code>92.20</code> of <code>System</code> and version <code>1.4</code> of <code>Daedalus</code>.  The description
is created when a Lisp world is saved away by <code>disk-save</code> (see below).
</p>
<a name="Manipulating-the-Label"></a>
<h4 class="subsection">32.10.1 Manipulating the Label</h4>

<a name="print_002ddisk_002dlabel_002dfun"></a><dl>
<dt><a name="index-print_002ddisk_002dlabel"></a>Function: <strong>print-disk-label</strong> <em>&amp;optional (unit <code>0</code>) (stream <code>standard-output</code>)</em></dt>
<dd><p>Print a description of the label of the disk specified by <em>unit</em> onto
<em>stream</em>.  The description starts with the name of the disk pack,
various information about the disk that is generally uninteresting, and
the names of the two current load partitions (microcode and saved Lisp
image).  This is followed by one line of description for each
partition.  Each one has a name, disk address, size, and textual
description.  The two partitions that are the current load partitions,
used when you cold-boot,
are preceeded by asterisks.
</p>
<p><em>unit</em> may be the unit number of the disk (most Lisp machines just
have one unit, numbered <code>0</code>), or the &quot;host name&quot; of another Lisp
Machine on the Chaosnet, as a string (in which case the label of unit <code>0</code> on that
machine will be printed, and the user of that machine will be notified
that you are looking at his label), or the string <code>&quot;CC&quot;</code> (which
will print the label of unit <code>0</code> of the machine connected to this
machine&rsquo;s debugging hardware).
</p>
<p>Use of <code>&quot;CC&quot;</code> as the <em>unit</em> is the way to examine or fix up
the label of a machine which cannot work because of problems with the
label.
</p></dd></dl>

<a name="set_002dcurrent_002dband_002dfun"></a><dl>
<dt><a name="index-set_002dcurrent_002dband"></a>Function: <strong>set-current-band</strong> <em>partition-name &amp;optional (unit <code>0</code>)</em></dt>
<dd><p>Set the current saved Lisp image partition to be <em>partition-name</em>.
If <em>partition-name</em> is a number, the name <code>LOD<em>n</em></code> will be used.
</p>
<p><em>unit</em> can be a disk drive number, the host name of another Lisp
machine, or the string <code>&quot;CC&quot;</code>.  See the comments under
<code>print-disk-label</code>, above.
</p>
<p>If the partition you specify goes with a version of microcode different
from the one that is current, this function will offer to select the
an appropriate microcode partition as well.  Normally you should
answer <code>Y</code>.
</p></dd></dl>

<a name="set_002dcurrent_002dmicroload_002dfun"></a><dl>
<dt><a name="index-set_002dcurrent_002dmicroload"></a>Function: <strong>set-current-microload</strong> <em>partition-name &amp;optional (unit <code>0</code>)</em></dt>
<dd><p>Set the current microcode partition to be <em>partition-name</em>.
If <em>partition-name</em> is a number, the name <code>MCR<em>n</em></code> will be used.
</p>
<p><em>unit</em> can be a disk drive number, the host name of another Lisp
machine, or the string <code>&quot;CC&quot;</code>.  See the comments under
<code>print-disk-label</code>, above.
</p></dd></dl>

<a name="si_003acurrent_002dband_002dfun"></a><dl>
<dt><a name="index-si_003acurrent_002dband"></a>Function: <strong>si:current-band</strong> <em>&amp;optional (unit <code>0</code>)</em></dt>
<dd><a name="si_003acurrent_002dmicroload_002dfun"></a></dd><dt><a name="index-si_003acurrent_002dmicroload"></a>Function: <strong>si:current-microload</strong> <em>&amp;optional (unit <code>0</code>)</em></dt>
<dd><p>Returns the name of the current band (current microload) on the
specified unit.
</p></dd></dl>

<p>When using the functions to set the current load partitions, be extra
sure that you are specifying the correct partition.  Having done it,
cold-booting the machine will reload from those partitions.  Some
versions of the microcode will not work with some versions of the Lisp
system, and if you set the two current partitions incompatibly,
cold-booting the machine will fail; this will need to be fixed using
another machine&rsquo;s debugging hardware, giving <code>&quot;CC&quot;</code> as the <em>unit</em>
argument to the functions above.
</p>
<a name="si_003aedit_002ddisk_002dlabel_002dfun"></a><dl>
<dt><a name="index-si_003aedit_002ddisk_002dlabel"></a>Function: <strong>si:edit-disk-label</strong> <em>unit &amp;optional init-p</em></dt>
<dd><p>This runs an interactive label editor on the specified unit.
This editor allows you to change any field in the label.  The
<code>Help</code> key documents the commands.  You have to be an expert
to need this and to understand what it does, so the commands
are not documented here.  Ask someone if you need help.
</p></dd></dl>

<a name="print_002dherald_002dfun"></a><dl>
<dt><a name="index-print_002dherald"></a>Function: <strong>print-herald</strong> <em>&amp;optional format-dest</em></dt>
<dd><p>Tells you what system versions you are currently running.  This includes
where it came from on the disk and what version of each system is
present in your Lisp environment.  <em>format-dest</em> defaults to <code>t</code>; if
it is <code>nil</code> the answer will be returned as a string rather than
printed out.
</p></dd></dl>

<a name="disk_002drestore_002dfun"></a><dl>
<dt><a name="index-disk_002drestore"></a>Function: <strong>disk-restore</strong> <em>&amp;optional partition</em></dt>
<dd><p>Allows booting from a band other than the current one.  <em>partition</em>
may be the name or the number of a disk partition containing a
virtual-memory load, or <code>nil</code> or omitted, meaning to use the current
partition.  The specified partition is copied into the paging area of
the disk and then started.
</p>
<p>Although you can use this to boot a different Lisp image than the installed
one, this does not provide a way to boot a different microcode image.
<code>disk-restore</code> brings up the new band with the currently running microcode.
</p>
<p><code>disk-restore</code> asks the user for confirmation before doing it.
</p></dd></dl>

<a name="describe_002dpartition_002dfun"></a><dl>
<dt><a name="index-describe_002dpartition"></a>Function: <strong>describe-partition</strong> <em>partition &amp;optional unit</em></dt>
<dd><p>Tells you various useful things about a partition.
</p>
<p>To begin with, it tells you where on disk the partition begins, and
how long it is.
</p>
<p>If you specify a saved Lisp system partition, such as <code>LOD3</code>, it also
tells you important information about the contents of the partition: the
microcode version which the partition goes with, the size of the data in
the partition and the hightes virtual address used.  The size of the partition
tells how large a partition you need to make a copy of this one, and the
highest virtual address used (which is measured in units of disk
blocks) tells you how large a <code>PAGE</code> partition you need in order to run
this partition.
</p></dd></dl>

<a name="Updating-Software"></a>
<h4 class="subsection">32.10.2 Updating Software</h4>

<p>Of all the procedures described in this section, the most common one
is to take a partition containing a Lisp image, update it to have
all the latest patches, and save it away into a partition.  The
function <code>load-and-save-patches</code> does it all conveniently for you.
</p>
<a name="load_002dand_002dsave_002dpatches_002dfun"></a><dl>
<dt><a name="index-load_002dand_002dsave_002dpatches"></a>Function: <strong>load-and-save-patches</strong></dt>
<dd><p>Load patches and saves a band, with a simple user interface.  Run this
function immediately after cold booting, without logging in first; it
will log in as <code>LISPM</code> (or whatever is specified in the site files).
After loading all patches without queries, it prints the disk label and
asks what band to save in.  Then it saves.
</p></dd></dl>

<p>If you wish to do something other than loading all and only the latest
patches, you must do the steps by hand.  Start by cold-booting the
machine, to get a fresh, empty system.  Next, you must log in as
something whose INIT file does not affect the Lisp world noticably (so
that when you save away the Lisp image, the side-effects of the INIT
file won&rsquo;t get saved too); on MIT-OZ, you can log in as <code>LISPM</code> with
password <code>LISPM</code>.  Now you can load in any new software you want;
usually you should also do <code>(load-patches)</code> for good measure.  You
may also want to call <code>si:set-system-status</code> to change the release
status of the system.
</p>
<p>When you&rsquo;re done loading everything, do <code>(print-disk-label)</code> to find
a band in which to save your new Lisp world.  It is best not to reuse
the current band, since if something goes wrong during the saving of
the partition, while you have written, say, half of the band that is
current, it may be impossible to cold-boot the machine.  Once you have
found the partition, you use the <code>disk-save</code> function to save
everything into that partition.
</p>
<a name="disk_002dsave_002dfun"></a><dl>
<dt><a name="index-disk_002dsave"></a>Function: <strong>disk-save</strong> <em>partition-name</em></dt>
<dd><p>Save the current Lisp world in the designated partition.
<em>partition-name</em> may be a partition name (a string), or it may be a
number in which case the name <code>LOD<em>n</em></code> is used.
</p>
<p>It first asks you for yes-or-no confirmation that you really want to
reuse the named partition.  Then it tries to figure out what to put into
the textual description of the label.  It starts with the brief version
of <code>si:system-version-info</code> (see <a href="#si_003asystem_002dversion_002dinfo_002dfun">si:system-version-info-fun</a>).  Then
it asks you for an &quot;additional comment&quot; to append to this; usually you
just type a <code>return</code> here, but you can also add a comment that will be
returned by <code>si:system-version-info</code> (and thus printed when the system
is booted) from then on.  If this doesn&rsquo;t fit into the fixed size
available for the textual description, it asks you to retype the whole
thing (the version info as well as your comment) in a compressed
form that will fit.  The compressed version will appear in the textual
description in <code>print-disk-label</code>.
</p>
<p>The Lisp environment is then saved away into the designated partition,
and then the equivalent of a cold-boot from that partition is done.
</p></dd></dl>

<p>Once the patched system has been successfully saved and the system
comes back up, you can make it current with <code>set-current-band</code>.
</p>
<p>Please don&rsquo;t save patched systems after running the editor or the
compiler.  This works, but it makes the saved system a lot bigger.  In
order to produce a clean saved environment, you should try to do as
little as possible between the time you cold-boot and the time you save
the partition.
</p>
<a name="si_003alogin_002dhistory_002dvar"></a><dl>
<dt><a name="index-si_003alogin_002dhistory"></a>Variable: <strong>si:login-history</strong></dt>
<dd><p>The value of <code>si:login-history</code> is a list of entries, one for each person who
has logged into this world since it was created.  This makes it possible to
tell who <code>disk-saved</code> a band with something broken in it.  Each entry is
a list of the user ID, the host logged into, the Lisp machine on which the
world was being executed, and the date and time.
</p></dd></dl>

<a name="Garbage-Collecting-to-Compress-Bands"></a>
<h4 class="subsection">32.10.3 Garbage Collecting to Compress Bands</h4>

<p>When you do a <code>disk-save</code>, it may tell you that the band you wish to save
in is not big enough to hold all the data in your current world.  It may be
possible for you to reduce the size of the data so that it will fit in that
band, by garbage collecting.  Simply do <code>(si:full-gc)</code>.
</p>
<p>When you garbage collect to reduce the size of a band, it is best to do
two garbage collections.  If you process any static areas (for example,
if you use <code>si:clean-up-static-area</code>), you should process the same set
of static areas both times.  This is to keep the data compacted toward
the bottom of the virtual address space, which makes it possible to run
the saved band in small <code>PAGE</code> partitions.  Here is why it works:
</p>
<p>The saved system band occupies a nearly contiguous range of virtual
memory, at the bottom of the address space.  Doing one garbage
collection copies all the useful data.  Since the lowest addresses were
already in use before, the copy has to occupy higher addresses.  The low
addresses become a hole.  The highest used address is now much higher
than before.
</p>
<p>The second garbage collection copies everything again.  Assuming that
the first garbage collection actually freed some data, the copy will fit
into the hole left by the first garbage collection.  The high addresses
used after the first collection are now free, and the highest used
address is back down to its original value.
</p>
<p>If you do only one garbage collection and then load in more data,
another garbage collection later will not have a neat hole to copy
into.  Fragmentation may develop.  As long as two garbage collections
are done in a row, there should be no problem.  In any case, problems
will only occur with <code>PAGE</code> partitions smaller than 36000 blocks.
</p>
<a name="Installing-New-Software"></a>
<h4 class="subsection">32.10.4 Installing New Software</h4>

<p>The version numbers of the current microcode and system are announced to
the INFO-LISPM mailing list.  When a new system becomes available, mail
is sent to the list explaining where to find the new system and what is
new about it.  Sometimes a microcode and a system go together, and the new
system will not work with the old microcode and vice versa.  When this
happens extra care is required to avoid getting incompatible loads
current at the same time so that the machine will not be able to boot
itself.
</p>
<p>All of the extant microcode versions can be found on the <code>SYS: UBIN;</code>
directory.  Microcode version <em>nnn</em> is in <code>SYS: UBIN; UCADR MCR <em>nnn</em></code>.
To copy a new microcode version into one of the microcode
load partitions, first do a <code>(print-disk-label)</code> to ensure that the
partition you intend to bash is not the current one; if it was, and something
went wrong in the middle of loading the new microcode, it would
be impossible to cold-boot, and this is hard to fix.
</p>
<p>Then, install the microcode (on the non-current partition)
by using <code>si:load-mcr-file</code>.
</p>
<a name="si_003aload_002dmcr_002dfile_002dfun"></a><dl>
<dt><a name="index-si_003aload_002dmcr_002dfile"></a>Function: <strong>si:load-mcr-file</strong> <em>microcode-file partition</em></dt>
<dd><p>Load the contents of the file <em>microcode-file</em> into the designated
partition.  <em>microcode-file</em> is either the version number of the
system microcode to be loaded, or the pathname of a file containing
microcode (in &quot;MCR&quot; format), normally <code>SYS: UBIN; UCADR MCR</code>.
<em>partition</em> is either the number of a <code>MCR</code> partition, or the
name of one, such as <code>&quot;MCR1&quot;</code>.
This takes about 30 seconds.
</p></dd></dl>

<p>The system load, unlike the microcode load, is much too large to fit in
a file.  Therefore, the only way to install an updated system on a
machine is to copy it from another machine that already has it.  So the
first step is to find a machine that is not in use and has the desired
system.  We will call this the source machine.  The machine where the
new system will be installed is the target machine.  You can see who
is logged into which machines, see which ones are free, and use
<code>print-disk-label</code> with an argument to examine the label of that
machine&rsquo;s disk and see if it has the system you want.
</p>
<p>The function for actually copying a system load partition off of
another machine is called as follows.  Before doing this, double-check
the partition names by printing the labels of both machines, and make
sure no one is using the source machine.
</p>
<a name="si_003areceive_002dband_002dfun"></a><dl>
<dt><a name="index-si_003areceive_002dband"></a>Function: <strong>si:receive-band</strong> <em>source-host source-band target-band &amp;optional subset-start subset-size</em></dt>
<dd><p>Copy the partition on <em>source-host</em>&rsquo;s partition named <em>source-band</em>
onto the local machine&rsquo;s partition named <em>target-band</em>.  (&quot;Band&quot;
means &quot;partition&quot;.)  This takes about ten minutes.  It types out the
size of the partition in pages, and types a number
every 100 pages telling how far it has gotten.  It puts up a notification
on the remote machine saying what&rsquo;s going on.
</p>
<p>The <em>subset-start</em> and <em>subset-size</em> arguments can be used to
transfer only part of a partition.  They are measured in blocks.
The default for the first is zero, and the default for the second is
up till the end of the data in the band.  These are most often useful for
restarting a transfer that was aborted due to network problems or a crash,
based on the count of hundreds of blocks that is printed out during the transfer.
</p></dd></dl>

<p>To go the other direction, use <code>si:transmit-band</code>.
</p>
<a name="si_003atransmit_002dband_002dfun"></a><dl>
<dt><a name="index-si_003atransmit_002dband"></a>Function: <strong>si:transmit-band</strong> <em>source-band target-host target-band &amp;optional subset-start subset-size</em></dt>
<dd><p>This is just like <code>si:receive-band</code>, except you use it on
the source machine instead of the target machine.  It copies
the local machine&rsquo;s partition named <em>source-band</em> onto
<em>target-machine</em>&rsquo;s partition named <em>target-band</em>.
</p>
<p>It is preferable to use <code>si:receive-partition</code> so that you are present
at the machine being written on. 
</p></dd></dl>

<p>After transferring the band, it is good practice to make sure that it really
was copied successfully by comparing the original and the copy.  All of the
known reasons for errors during band transfer have (of course) been corrected,
but peace of mind is valuable.  If the copy was not perfectly faithful, you
might not find out about it until a long time later, when you use whatever part
of the system that had not been copied properly.
</p>
<a name="si_003acompare_002dband_002dfun"></a><dl>
<dt><a name="index-si_003acompare_002dband"></a>Function: <strong>si:compare-band</strong> <em>source-host source-band target-band &amp;optional subset-start subset-size</em></dt>
<dd><p>This is like <code>si:receive-band</code>, except that it does not change anything.
It compares the two bands and complains about any differences.
</p></dd></dl>

<p>Having gotten the current microcode load and system load copied into
partitions on your machine, you can make them current using
<code>set-current-microload</code> and <code>set-current-band</code>.  Double-check
everything with <code>print-disk-label</code>.  Then cold-boot the machine, and
the new system should come up in a half-minute or so.
</p>
<p>If the microcode you installed is not the same version as was installed
on the source machine from which you got the system load, you will need to
follow the procedure given below under &quot;installing new microcode&quot;.
This can happen if someone hasn&rsquo;t installed the current microcode yet
on that other machine.
</p>
<a name="Installing-New-Microcode"></a>
<h4 class="subsection">32.10.5 Installing New Microcode</h4>

<p>When an existing system is to be used with a new microcode, certain changes
need to be made to the system, and it should then be dumped back out with
the changes.  The error handler has a table
of errors that are detected by microcode.  The hardware/microcode debugger
(CC) has a microcode symbol table.  These symbols are used when debugging
other machines, and are also used by certain metering programs.  These tables
should be updated when a new microcode is installed.
</p>
<p>The error-handler will automatically update its table (from a file on the
<code>SYS: UBIN;</code> directory) when the machine is booted with the new
microcode.  The CC symbol table is updated automatically when you do a
<code>disk-save</code>; you can also do so by hand as follows:
</p><div class="lisp">
<pre class="lisp">(login 'lispm)
(pkg-goto 'cadr)
(cc-load-ucode-symbols &quot;SYS: UBIN; UCADR SYM <em>nnn</em>&quot;)
(pkg-goto)
</pre></div>
<p>where <em>nnn</em> is the microcode version number.  This operation will take
a minute or two; after it has read in most of the file the machine will
stop for a long time while it sorts the symbols.  It will look like it
has crashed, but it hasn&rsquo;t, really, and will eventually come back.
</p>
<p>After booting the system with the new microcode and following the above
procedure, the updated system should be saved with <code>disk-save</code> as explained
above.  Note that this operation does not change the system version number.
Once the new band is verified to work, the old band can be removed from the
label with <code>si:edit-disk-label</code> if desired.
</p>
<a name="Site-Options-and-Host-Table"></a>
<h3 class="section">32.11 Site Options and Host Table</h3>
<a name="site_002dfiles"></a><a name="index-site-options"></a>
<a name="index-site-configuration"></a>

<p>The Lisp machine system has options that are set at each site.  These
include the network addresses of other hosts, which hosts have file
servers, which host to find the system source files and patch files on,
where to send bug reports, what timezone the site is located in, and many
other things.
</p>
<p>The per-site information is defined by three files: <code>SYS: SITE; SITE LISP</code>,
<code>SYS: SITE; LMLOCS LISP</code>, and <code>SYS: CHAOS; HOSTS TXT</code>.
<a name="host_002dtable"></a><a name="index-host-table"></a>
</p>
<p><code>SYS: CHAOS; HOSTS TXT</code> is the network host table.  It gives the names
and addresses of all hosts that are to be known to the Lisp machine for any
purposes.  It also says what type of machine the host is, and what operating
system runs on it.
</p>
<p><code>SYS: SITE; LMLOCS LISP</code> specifies various information about the Lisp
machines at your site, including its name, where it is physically located,
and what the default machine for logging in should be.
</p>
<p><code>SYS: SITE; SITE LISP</code> specifies all other site-specific information.
Primarily, this is contained in a call to the special form <code>defsite</code>.
</p>
<a name="defsite_002dfun"></a><dl>
<dt><a name="index-defsite"></a>Special Form: <strong>defsite</strong> <em>site-name (site-option value)...</em></dt>
<dd><p>This special form defines the values of site-specific options, and also
gives the name of the site.  Each <em>site-option</em> is a symbol, normally in
the keyword package, which is the name of some site option.  <em>value</em> is
the value for that option; it is evaluated.  Here is a list of
standardly defined site options:
</p>
<dl compact="compact">
<dt><code>:sys-host</code></dt>
<dd><p>The value is a string, the name of the host on which the system source
files are stored.  This is the host into which the logical host <code>SYS</code>
will translate.
</p>
</dd>
<dt><code>:sys-host-translation-alist</code></dt>
<dd><p>The value is an alist mapping host names into translation-list variables.
Each translation list variable&rsquo;s value should be an alist suitable for being
the third argument to <code>fs:add-logical-pathname-host</code> (see
<a href="#fs_003aadd_002dlogical_002dpathname_002dhost_002dfun">fs:add-logical-pathname-host-fun</a>).  The car of an element may be <code>nil</code>
instead of a host name; then this element applies to all hosts not
mentioned.
</p>
<p>The normal place to find the system sources is on the host specified by the
<code>:sys-host</code> keyword, in the directories specified by the translation list
variable found by looking that host up in the value of the
<code>:sys-host-translation-alist</code> keyword.  If you specify a different host
as the system host with <code>si:set-sys-host</code>, that host will also be looked
up in this alist to find out what directories to use there.
</p>
<p>Here is what is used at MIT:
</p>
<div class="lisp">
<pre class="lisp">(defsite :mit
  ...
  (:sys-host-translation-alist
    '((&quot;AI&quot; . its-sys-pathname-translations)
      (&quot;OZ&quot; . oz-sys-pathname-translations)
      (&quot;FS&quot; . its-sys-pathname-translations)
      (&quot;LM&quot; . its-sys-pathname-translations)
      (nil . its-sys-pathname-translations)))
  ...)
</pre></div>
<div class="lisp">
<pre class="lisp">(defconst oz-sys-pathname-translations
  '((&quot;CC&quot; &quot;SRC:&lt;L.CC&gt;&quot;)
    (&quot;CHAOS&quot; &quot;SRC:&lt;L.CHAOS&gt;&quot;)
    (&quot;DEMO&quot; &quot;SRC:&lt;L.DEMO&gt;&quot;)
    ...
    (&quot;SITE&quot; &quot;SRC:&lt;L.SITE&gt;&quot;)
    (&quot;SYS&quot; &quot;SRC:&lt;L.SYS&gt;&quot;)
    (&quot;SYS2&quot; &quot;SRC:&lt;L.SYS2&gt;&quot;)
    ...
    (&quot;ZMAIL&quot; &quot;SRC:&lt;L.ZMAIL&gt;&quot;)
    (&quot;ZWEI&quot; &quot;SRC:&lt;L.ZWEI&gt;&quot;)
    ))
</pre></div>

</dd>
<dt><code>:sys-login-name</code></dt>
<dt><code>:sys-login-password defsite</code></dt>
<dd><p>These specify the username and password to use to log in automatically to read system
patch files, microcode symbol tables and error tables.
The values should be strings.
</p>
</dd>
<dt><code>:chaos</code></dt>
<dd><p>This should be <code>t</code> if there is a chaosnet, <code>nil</code> if not.
</p>
</dd>
<dt><code>:ether</code></dt>
<dd><p>This should be <code>t</code> if the Lisp machine is on an ethernet, <code>nil</code> if not.
</p>
</dd>
<dt><code>:chaos-file-server-hosts</code></dt>
<dd><p>This should be a list of names of hosts that have file servers.
</p>
</dd>
<dt><code>:chaos-time-server-hosts</code></dt>
<dd><p>This should be a list of names of hosts that support TIME servers.
These are hosts that the Lisp machine can ask the time of day from
when you boot.
</p>
</dd>
<dt><code>:chaos-host-table-server-hosts</code></dt>
<dd><p>This should be a list of names of hosts that support host-table servers,
which can be used to inquire about hosts on networks that the Lisp machine
does not know about in its own host table.
</p>
</dd>
<dt><code>:chaos-mail-server-hosts</code></dt>
<dd><p>This should be a list of names of hosts that support mail servers which are
capable of forwarding mail to any known host.
</p>
</dd>
<dt><code>:timezone</code></dt>
<dd><p>This should be a number, the number of hours earlier than GMT of the
timezone where this site is located.
</p>
</dd>
<dt><code>:host-for-bug-reports</code></dt>
<dd><p>This should be a string, the name of the host at which bug-report mailboxes
are located.
</p>
</dd>
<dt><code>:local-mail-hosts</code></dt>
<dd><p>This should be a list of names of hosts that ZMAIL should consider &quot;local&quot;
and omit from its summary display.
</p>
</dd>
<dt><code>:spell-server-hosts</code></dt>
<dd><p>This should be a list of hosts that have spelling corrector servers.
</p>
</dd>
<dt><code>:comsat</code></dt>
<dd><p>This should be <code>t</code> if mail can be sent through the COMSAT mail demon.
This is true only at MIT.
</p>
</dd>
<dt><code>:default-mail-mode</code></dt>
<dd><p>This should be the default mode for use in sending mail.
The options are <code>:file</code> (use COMSAT), <code>:chaos</code> (use one of the
<code>:chaos-mail-server-hosts</code>), or <code>:chaos-direct</code> (like <code>:chaos</code>, but
go direct to the host that the mail is addressed to whenever possible).
</p>
</dd>
<dt><code>:gmsgs</code></dt>
<dd><p>This should be <code>t</code> if GMSGS servers are available.
</p>
</dd>
<dt><code>:arpa-gateways</code></dt>
<dd><p>This should be a list of names of hosts that can be used as gateways to the
Arpanet.  These hosts must provide a suitable chaosnet server which will
make Arpanet connections.  It should be <code>nil</code> if your site does not have
an Arpanet connection.
</p>
</dd>
<dt><code>:arpa-contact-name</code></dt>
<dd><p>If you have Arpanet gateways, this is the chaosnet contact name to use.
Nowadays, it should be <code>&quot;TCP&quot;</code>.
</p>
</dd>
<dt><code>:dover</code></dt>
<dd><p>This should be <code>t</code> if your site has a Dover printer.
</p>
</dd>
<dt><code>:default-printer</code></dt>
<dd><p>This should be a keyword which describes
the default printer for hardcopy
commands and functions to use.  Possible values include <code>:dover</code> and
<code>nil</code>.
</p>
</dd>
<dt><code>:default-bit-array-printer</code></dt>
<dd><p>Like <code>:default-printer</code>, but this is the default for only <code>hardcopy-bit-array</code> to use.
</p>
</dd>
<dt><code>:esc-f-arg-alist</code></dt>
<dd><p>This says what various numeric arguments to the <code>Terminal F</code> command
mean.  It is a list of elements, one for each possible argument.
The car of an element is either a number or <code>nil</code> (which applies to
<code>Terminal F</code> with no argument).  The cdr is either <code>:login</code>
(finger the login host), <code>:lisp-machines</code> (finger all Lisp machines at
this site), <code>:read</code> (read some hosts from the keyboard), or a list of
host names.
</p>
</dd>
<dt><code>:machines-with-local-file-systems</code></dt>
<dd><p>This should be a list of names of lisp machines that normally have
Local-File systems.
</p>
<p>Other site options are allowed, and your own software can look for them.
</p></dd>
</dl>
</dd></dl>

<a name="Updating-Site-Information"></a>
<h4 class="subsection">32.11.1 Updating Site Information</h4>

<p>To update the site files, you must first recompile the sources.
Do this by
</p><div class="lisp">
<pre class="lisp">(make-system 'site 'compile)
</pre></div>
<p>This also loads the site files.
</p>
<p>To just load the site files, assuming they are compiled, do
</p><div class="lisp">
<pre class="lisp">(make-system 'site)
</pre></div>

<p>You should never load any site file directly.  All the files must be loaded
in the proper fashion and sequence, or the machine may stop working.
</p>
<a name="Accessing-Site-Options"></a>
<h4 class="subsection">32.11.2 Accessing Site Options</h4>

<p>Programs examine the site options using these variables and functions:
</p>
<a name="site_002dname_002dvar"></a><dl>
<dt><a name="index-site_002dname"></a>Variable: <strong>site-name</strong></dt>
<dd><p>The value of this variable is the name of the site you are running at, as
defined in the <code>defsite</code> in the <code>SITE</code> file.  You can use this in run-time
conditionals for various sites.
</p></dd></dl>

<a name="get_002dsite_002doption_002dfun"></a><dl>
<dt><a name="index-get_002dsite_002doption"></a>Function: <strong>get-site-option</strong> <em>keyword</em></dt>
<dd><p>Returns the value of the site option <em>keyword</em>.
The value is <code>nil</code> if <em>keyword</em> is not mentioned in the <code>SITE</code> file.
</p></dd></dl>

<a name="define_002dsite_002dvariable_002dfun"></a><dl>
<dt><a name="index-define_002dsite_002dvariable"></a>Special Form: <strong>define-site-variable</strong> <em>variable keyword [documentation]</em></dt>
<dd><p>Defines a variable named <em>variable</em> whose value is always the same as
that of the site option <em>keyword</em>.  When new site files are loaded,
the variable&rsquo;s value is updated.  <em>documentation</em> is the variable&rsquo;s
documentation string, as in <code>defvar</code>.
</p></dd></dl>

<a name="define_002dsite_002dhost_002dlist_002dfun"></a><dl>
<dt><a name="index-define_002dsite_002dhost_002dlist"></a>Special Form: <strong>define-site-host-list</strong> <em>variable keyword [documentation]</em></dt>
<dd><p>Defines a variable named <em>variable</em> whose value is a list of host objects
specified by the site option <em>keyword</em>.  The value actually specified in
the <code>SITE</code> file should be a list of host names.  When new site files are
loaded, the variable&rsquo;s value is updated.  <em>documentation</em> is the
variable&rsquo;s documentation string, as in <code>defvar</code>.
</p></dd></dl>

<a name="The-LMLOCS-File"></a>
<h4 class="subsection">32.11.3 The LMLOCS File</h4>

<p>The <code>LMLOCS</code> file contains an entry for each Lisp machine at your
site, and tells the system whatever it needs to know about the
particular machine it is running on.  It contains one form, a
<code>defconst</code> for the variable <code>machine-location-alist</code>.  The value
should have an element for each Lisp machine, of this form:
</p>
<div class="lisp">
<pre class="lisp">(&quot;MIT-LISPM-1&quot;  &quot;Lisp Machine One&quot;
 &quot;907 [Son of CONS] CADR1's Room x6765&quot;
 (MIT-NE43 9) &quot;OZ&quot; ((:default-printer ':dover)))

</pre><pre class="lisp">The general pattern is
</pre><pre class="lisp">

(<em>host-full-name</em> <em>pretty-name</em>
 <em>location-string</em>
 (<em>building</em> <em>floor</em>) <em>associated-machine</em> <em>site-options</em>) 
</pre></div>

<p>The <em>host-full-name</em> is the same as in the host table.
</p>
<p>The <em>pretty-name</em> is simply for printing out for users on certain occasions.
</p>
<p>The <em>location-string</em> should say where to find the machine&rsquo;s console,
preferably with a telephone number.  This is for the <code>FINGER</code> server
to provide to other hosts.
</p>
<p>The <em>building</em> and <em>floor</em> are a somewhat machine-understandable
version of the location.
</p>
<p>The <em>associated-machine</em> is the default file server host name for
login on this Lisp machine.
</p>
<p><em>site-options</em> is a list of site options, just like what goes in the
<code>defsite</code>.  These site options apply only to the particular machine,
overriding what is present in the <code>SITE</code> file.  In our example, the
site option <code>:default-printer</code> is specified as being <code>:dover</code>, on
this machine only.
</p>
<a name="si_003aassociated_002dmachine_002dvar"></a><dl>
<dt><a name="index-si_003aassociated_002dmachine"></a>Variable: <strong>si:associated-machine</strong></dt>
<dd><p>The host object for the associated machine of this Lisp machine.
</p></dd></dl>

<a name="Initializing-a-Band-at-a-New-Site"></a>
<h4 class="subsection">32.11.4 Initializing a Band at a New Site</h4>

<p>To initialize the Lisp machine system after moving to a new site, it is
best to bring the system on a disk with a local file system.  Copy a set
of site files to a directory on the local file system before you leave
the old site.  Although the system band will not know about any of the
hosts at the new site, the local file system will run properly.
</p>
<p>Log in on host <code>LM</code> and edit the site files there so that they are
correct for the new site.  Then use <code>si:set-sys-host</code> to make <code>LM</code>
the <code>SYS</code> host, specifying the directory on which the edited site
files reside.  Then <code>(make-system 'site 'compile)</code> will compile and
load the new site files.  At this point, the new site&rsquo;s hosts will be
accessible, and the <code>SYS</code> host will be set according to the site
files.
</p>
<p>Alternatively, you can use <code>si:set-sys-host</code> to specify some other
host at the new site, even though it is not known in the host table.  To
do this, specify the chaosnet address of the host as the
<em>host-address</em> argument.  Then the system will not mind that it does
not know any host by the specified name.  You must also specify the
<em>operating-system-type</em> argument, a keyword such as <code>:tops20</code>,
<code>:vms</code> or <code>:unix</code>.  This is because the system cannot determine the
type of filename syntax to use for the host from the host table, as it
usually does.  <em>site-file-directory</em> must also be specified.
</p>
<p>Now you can refer to the site files on that host using pathnames such as
<code>SYS: SITE; SITE LISP</code>.  Update the files, do <code>make-system</code> as
above, and you are done.
</p>
<a name="si_003aset_002dsys_002dhost_002dfun"></a><dl>
<dt><a name="index-si_003aset_002dsys_002dhost"></a>Function: <strong>si:set-sys-host</strong> <em>host-name &amp;optional operating-system-type host-address site-file-directory default-device</em></dt>
<dd><p>Specify the host for the <code>SYS</code> logical host to translate into; this is the
host on which system source files, site files, patch files, error tables
and microcode symbols will be found.
</p>
<p>Normally it is enough to specify just the host name.  Specifying more than
one argument is useful mainly when you are operating at a new site and do
not have correct host tables loaded.  The additional arguments allow you to
specify the information that would normally be obtained by looking for the
host name in the host table.  This gets you far enough to load site files
from that host, which will set things up properly.
</p></dd></dl>


<hr>



</body>
</html>
